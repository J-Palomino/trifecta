<!doctypehtml><html lang=zh-cht dir=ltr xmlns=http://www.w3.org/1999/xhtml><meta http-equiv=X-UA-Compatible content="IE=edge"><meta http-equiv=Content-Type content="text/html;charset=utf-8"><meta name=viewport content="user-scalable=1,initial-scale=1,minimum-scale=1,maximum-scale=1"><meta name=apple-mobile-web-app-capable content=yes><meta name=format-detection content="telephone=no"><meta name=robots content=noindex,nofollow><link rel=manifest href={{{domainurl}}}manifest.json><link type=image/x-icon href={{{domainurl}}}favicon.ico rel="shortcut icon"><link keeplink=1 type=text/css href=styles/style-bootstrap.css media=screen rel=stylesheet title=CSS><link type=text/css href=styles/ol.css media=screen rel=stylesheet title=CSS><link type=text/css href=styles/ol3-contextmenu.min.css media=screen rel=stylesheet title=CSS><link type=text/css href=styles/xterm.css media=screen rel=stylesheet title=CSS><link type=text/css href=styles/flatpickr.min.css media=screen rel=stylesheet title=CSS><link id=theme-stylesheet href=styles/bootstrap{{{min}}}.css rel=stylesheet title=CSS><link href=styles/sweetalert2.min.css rel=stylesheet title=CSS><link href=styles/select2.min.css rel=stylesheet title=CSS><link href=styles/select2-bootstrap-5-theme.min.css rel=stylesheet title=CSS><link rel=apple-touch-icon href=/favicon-303x303.png><script src=scripts/common-0.0.1{{{min}}}.js></script><script src=scripts/meshcentral{{{min}}}.js></script><script src=scripts/amt-0.2.0{{{min}}}.js></script><script src=scripts/amt-wsman-0.2.0{{{min}}}.js></script><script src=scripts/amt-desktop-0.0.2{{{min}}}.js></script><script src=scripts/amt-terminal-0.0.2{{{min}}}.js></script><script src=scripts/zlib{{{min}}}.js></script><script src=scripts/zlib-inflate{{{min}}}.js></script><script src=scripts/zlib-adler32{{{min}}}.js></script><script src=scripts/zlib-crc32{{{min}}}.js></script><script src=scripts/amt-redir-ws-0.1.0{{{min}}}.js></script><script src=scripts/amt-wsman-ws-0.2.0{{{min}}}.js></script><script src=scripts/agent-redir-ws-0.1.1{{{min}}}.js></script><script src=scripts/agent-redir-rtc-0.1.0{{{min}}}.js></script><script src=scripts/agent-desktop-0.0.2{{{min}}}.js></script><script src=scripts/agent-rdp-0.0.1{{{min}}}.js></script><script src=scripts/qrcode.min.js></script><script src=scripts/xterm{{{min}}}.js></script><script src=scripts/xterm-addon-fit{{{min}}}.js></script><script src=scripts/flatpickr.js></script><script src=mstsc/mstsc.js></script><script src=mstsc/keyboard.js></script><script src=mstsc/rle.js></script><script src=mstsc/client.js></script><script src=mstsc/canvas.js></script><script src=scripts/jquery{{{min}}}.js></script><script src=scripts/bootstrap{{{min}}}.js></script><script src=scripts/fontawesome/all.min.js></script><script src=scripts/sweetalert2.all.min.js></script><script src=scripts/select2.full.min.js></script><script src=scripts/themes/theme-switcher.js></script><script keeplink=1 src=scripts/u2f-api{{{min}}}.js></script><script keeplink=1 src=scripts/charts{{{min}}}.js></script><script keeplink=1 src=scripts/moment{{min}}.js></script><script keeplink=1 src=scripts/chartjs-adapter-moment{{{min}}}.js></script><script keeplink=1 src=scripts/filesaver.min.js></script><script keeplink=1 src=scripts/ol{{{min}}}.js></script><script keeplink=1 src=scripts/ol3-contextmenu{{{min}}}.js></script><script keeplink=1 src=scripts/purify{{{min}}}.js></script><script keeplink=1 src=scripts/marked{{{min}}}.js></script><title>{{{title}}}</title><body id=body oncontextmenu=handleContextMenu(event) style=display:none;min-width:495px onload='"undefined"!=typeof startup&&startup()'><div id=contextMenu class="contextMenu noselect"style=display:none><div id=cxinfo class=cmtext onclick=cmaction(1,event)><b>訊息</b></div><div id=cxdesktop class=cmtext onclick=cmaction(3,event)>桌面</div><div id=cxterminal class=cmtext onclick=cmaction(2,event)>終端機</div><div id=cxfiles class=cmtext onclick=cmaction(4,event)>檔案</div><div id=cxevents class=cmtext onclick=cmaction(5,event)>事件</div><div id=cxdetails class=cmtext onclick=cmaction(6,event)>細節</div><div id=cxconsole class=cmtext onclick=cmaction(7,event)>控制台</div><div id=cxwebrdp class=cmtext onclick=cmaction(11,event)>網絡RDP</div><div id=cxwebvnc class=cmtext onclick=cmaction(12,event)>網絡-VNC</div><div id=cxwebssh class=cmtext onclick=cmaction(13,event)>網絡SSH</div><div id=cxrdp class=cmtext onclick=cmaction(14,event)>RDP</div><div id=cxplugins class=cmtext onclick=cmaction(8,event) style=display:none>外掛程式</div><hr id=cxmgroupsplit><div id=cxstar class=cmtext onclick=cmaction(10,event) style=display:none>切換星</div><div id=cxmdesktop class=cmtext onclick=cmaction(9,event) style=display:none>多桌面</div></div><div id=meshContextMenu class="contextMenu noselect"style=display:none;min-width:0><div id=cxselectall class=cmtext onclick=cmmeshaction(1,event)>全選</div><div id=cxselectnone class=cmtext onclick=cmmeshaction(2,event)>選擇無</div></div><div id=altPortContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmaltportaction(1,event)>備用端口</div></div><div id=sshPortContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmsshportaction(1,event)>備用端口</div></div><div id=rfbPortContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmrfbportaction(1,event)>備用端口</div></div><div id=httpPortContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmhttpportaction(1,event)>備用端口</div></div><div id=httpsPortContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmhttpsportaction(1,event)>備用端口</div></div><div id=filesContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmfilesaction(1,event)>改名</div><div class=cmtext onclick=cmfilesaction(2,event)>編輯</div><div class=cmtext onclick=cmfilesaction(3,event)>刪除</div></div><div id=expandAllContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmexpandaction(1,event)>展開全部</div><div class=cmtext onclick=cmexpandaction(2,event)>全部收縮</div></div><div id=deskPlayerContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmdeskplayeraction(1,event)>打開播放器...</div></div><div id=deskKeyShortcutContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmdeskshortcutaction(1,event)>定制...</div></div><div id=deskPreConfigShortcutContextMenu class="contextMenu noselect"style="display:none;min-width:0;max-height:calc(80% - 50px);overflow-y:auto"><span id=deskPreConfigShortcutContextMenu1></span> <span id=deskPreConfigShortcutContextMenu2></span><div class=cmtext onclick=cmdeskpreconfigtypeaction(-1,event)>定制...</div></div><div id=deskPreConfigScriptContextMenu class="contextMenu noselect"style="display:none;min-width:0;max-height:calc(80% - 50px);overflow-y:auto"><span id=deskPreConfigScriptContextMenu1></span> <span id=deskPreConfigScriptContextMenu2></span></div><div id=container><div id=notifiyBox class=notifiyBox style=display:none></div><div id=masthead class=noselect><div style=float:left>{{{titlehtml}}}</div><div class=title onclick=go(1,event)>{{{title1}}}</div><div class=title2>{{{title2}}}</div><div style=float:right><div id=notificationCount onclick=clickNotificationIcon() class=unselectable style=display:none title=點擊查看當前通知>0</div></div><p id=logoutControl><span id=logoutControlSpan class=logoncontrolspan></span><span id=idleTimeoutNotify style=color:#ff0></span></p><img id=topMenuIcon class=noselect style=position:absolute;right:0;top:10px;color:#c8c8c8;font-size:44px;margin-right:8px;cursor:pointer;display:none onclick=topMenu() src=/images/3bars-30.png width=30 height=30><div class=textnewui id=textnewui onmouseup=toggleBootstrapUIMode() onkeypress='"Enter"==event.key&&toggleBootstrapUIMode()'><b>Try the new MeshCentral UI</b></div></div><div class="sidebar flex-column"id=page_leftbar><div style=height:24px></div><nav class="nav flex-column"><a class="nav-link active text-center text-white lbbuttonsel"id=LeftMenuMyDevices href=# data-target=general onmouseup=go(1,event) onkeypress='"Enter"==event.key&&go(1)'><i class="fa-solid fa-computer me-2"></i></a> <a class="nav-link text-center text-white"id=LeftMenuMyAccount href=# data-target=account onmouseup=go(2,event) onkeypress='"Enter"==event.key&&go(2)'><i class="fa-solid fa-user-gear me-2"></i></a> <a class="nav-link text-center text-white"id=LeftMenuMyEvents href=# data-target=events onmouseup=go(3,event) onkeypress='"Enter"==event.key&&go(3)'><i class="fa-solid fa-calendar-alt me-2"></i></a> <a class="nav-link text-center text-white"id=LeftMenuMyFiles href=# data-target=files onmouseup=go(5,event) onkeypress='"Enter"==event.key&&go(5)'><i class="fa-solid fa-folder-open me-2"></i></a> <a class="nav-link text-center text-white"id=LeftMenuMyUsers href=# data-target=users onmouseup=go(4,event) onkeypress='"Enter"==event.key&&go(4)'><i class="fa-solid fa-users me-2"></i></a> <a class="nav-link text-center text-white"id=LeftMenuMyServer href=# data-target=server onmouseup=go(6,event) onkeypress='"Enter"==event.key&&go(6)'><i class="fa-solid fa-server me-2"></i></a></nav></div><div id=topbar class=noselect><div><div style=position:relative><span id=logoutControlSpan2></span><div tabindex=0 id=uiMenuButton title=用戶界面選擇 onclick=showUserInterfaceSelectMenu() onkeypress='"Enter"==event.key&&showUserInterfaceSelectMenu()'>♦<div id=uiMenu style=display:none><table><tr><td><div tabindex=0 id=uiViewButton1 class=uiSelector onclick=userInterfaceSelectMenu(1) title=左欄界面 onkeypress='"Enter"==event.key&&userInterfaceSelectMenu(1)'><div class=uiSelector1></div></div><div tabindex=0 id=uiViewButton2 class=uiSelector onclick=userInterfaceSelectMenu(2) title=頂欄界面 onkeypress='"Enter"==event.key&&userInterfaceSelectMenu(2)'><div class=uiSelector2></div></div><div tabindex=0 id=uiViewButton3 class=uiSelector onclick=userInterfaceSelectMenu(3) title=固定寬度接口 onkeypress='"Enter"==event.key&&userInterfaceSelectMenu(3)'><div class=uiSelector3></div></div><div tabindex=0 id=uiViewButton7 class=uiSelector onclick=toggleBootstrapUIMode() title="Toggle Modern UI"onkeypress='"Enter"==event.key&&toggleBootstrapUIMode()'><div class=uiSelector7></div></div><td><div tabindex=0 id=uiViewButton6 class=uiSelector onclick=showNotes(!1) title=個人筆記 onkeypress='"Enter"==event.key&&showNotes(!1)'><div class=uiSelector6></div></div><div tabindex=0 id=uiViewButton4 class=uiSelector onclick=toggleNightMode() title=切換夜間模式 onkeypress='"Enter"==event.key&&toggleNightMode()'><div class=uiSelector4></div></div><div tabindex=0 id=uiViewButton5 class=uiSelector onclick=toggleFooterBarMode() title=切換頁腳欄 onkeypress='"Enter"==event.key&&toggleFooterBarMode()'><div class=uiSelector5></div></div><div class=uiSelector_end>&nbsp;</div></table></div></div><table id=MainMenuSpan cellpadding=0 cellspacing=0 class=style1><tr><td tabindex=0 id=MainMenuMyDevices class="topbar_td style3x"onmouseup=go(1,event) onkeypress='"Enter"==event.key&&go(1)'>我的裝置<td tabindex=0 id=MainMenuMyAccount class="topbar_td style3x"onmouseup=go(2,event) onkeypress='"Enter"==event.key&&go(2)'>我的帳戶<td tabindex=0 id=MainMenuMyEvents class="topbar_td style3x"onmouseup=go(3,event) onkeypress='"Enter"==event.key&&go(3)'>我的事件<td tabindex=0 id=MainMenuMyFiles class="topbar_td style3x"onmouseup=go(5,event) onkeypress='"Enter"==event.key&&go(5)'>我的檔案<td tabindex=0 id=MainMenuMyUsers class="topbar_td style3x"onmouseup=go(4,event) onkeypress='"Enter"==event.key&&go(4)'>我的用戶<td tabindex=0 id=MainMenuMyServer class="topbar_td style3x"onmouseup=go(6,event) onkeypress='"Enter"==event.key&&go(6)'>我的伺服器<td class="topbar_td_end style3">&nbsp;</table><div id=MainSubMenuSpan style=display:none><table id=MainSubMenu cellpadding=0 cellspacing=0 class=style1><tr><td tabindex=0 id=MainDev class="topbar_td style3x"onmouseup=go(10,event) onkeypress='"Enter"==event.key&&go(10)'>一般<td tabindex=0 id=MainDevDesktop class="topbar_td style3x"onmouseup=go(11,event) onkeypress='"Enter"==event.key&&go(11)'>桌面<td tabindex=0 id=MainDevTerminal class="topbar_td style3x"onmouseup=go(12,event) onkeypress='"Enter"==event.key&&go(12)'>終端機<td tabindex=0 id=MainDevFiles class="topbar_td style3x"onmouseup=go(13,event) onkeypress='"Enter"==event.key&&go(13)'>檔案<td tabindex=0 id=MainDevEvents class="topbar_td style3x"onmouseup=go(16,event) onkeypress='"Enter"==event.key&&go(16)'>事件<td tabindex=0 id=MainDevInfo class="topbar_td style3x"onmouseup=go(17,event) onkeypress='"Enter"==event.key&&go(17)'>細節<td tabindex=0 id=MainDevAmt class="topbar_td style3x"onmouseup=go(14,event) onkeypress='"Enter"==event.key&&go(14)'>Intel®AMT<td tabindex=0 id=MainDevConsole class="topbar_td style3x"onmouseup=go(15,event) onkeypress='"Enter"==event.key&&go(15)'>控制台<td tabindex=0 id=MainDevPlugins class="topbar_td style3x"onmouseup=go(19,event) onkeypress='"Enter"==event.key&&go(19)'>外掛程式<td class="topbar_td_end style3">&nbsp;</table></div><div id=MeshSubMenuSpan style=display:none><table id=MeshSubMenu cellpadding=0 cellspacing=0 class=style1><tr><td tabindex=0 id=MeshGeneral class="topbar_td style3x"onmouseup=go(20,event) onkeypress='"Enter"==event.key&&go(20)'>一般<td tabindex=0 id=MeshSummary class="topbar_td style3x"onmouseup=go(21,event) onkeypress='"Enter"==event.key&&go(21)'>摘要<td class="topbar_td_end style3">&nbsp;</table></div><div id=EventsSubMenuSpan style=display:none><div id=EventsSubMenu class=style1><div class="row d-flex"><div class="col flex-grow-0 flex-shrink-0"><div tabindex=0 id=EventsLive class="topbar_td style3x"onmouseup=go(3,event) onkeypress='"Enter"==event.key&&go(3)'>事件</div></div><div class="col flex-grow-0 flex-shrink-0"><div tabindex=0 id=EventsReport class="topbar_td style3x"onmouseup=go(60,event) onkeypress='"Enter"==event.key&&go(60)'>報告</div></div><div class="col flex-grow-0 flex-shrink-0"><div class=style3>&nbsp;</div></div></div></div></div><div id=UserSubMenuSpan style=display:none><table id=UserSubMenu cellpadding=0 cellspacing=0 class=style1><tr><td tabindex=0 id=UserGeneral class="topbar_td style3x"onmouseup=go(30,event) onkeypress='"Enter"==event.key&&go(30)'>一般<td tabindex=0 id=UserEvents class="topbar_td style3x"onmouseup=go(31,event) onkeypress='"Enter"==event.key&&go(31)'>事件<td class="topbar_td_end style3">&nbsp;</table></div><div id=UsersSubMenuSpan style=display:none><table id=UsersSubMenu cellpadding=0 cellspacing=0 class=style1><tr><td tabindex=0 id=UsersGeneral class="topbar_td style3x"onmouseup=go(4,event) onkeypress='"Enter"==event.key&&go(4)'>用戶<td tabindex=0 id=UsersGroups class="topbar_td style3x"onmouseup=go(50,event) onkeypress='"Enter"==event.key&&go(50)'>群組<td tabindex=0 id=UsersRecordings class="topbar_td style3x"onmouseup=go(52,event) onkeypress='"Enter"==event.key&&go(52)'>錄音<td class="topbar_td_end style3">&nbsp;</table></div><div id=ServerSubMenuSpan style=display:none><table id=ServerSubMenu cellpadding=0 cellspacing=0 class=style1><tr><td tabindex=0 id=ServerGeneral class="topbar_td style3x"onmouseup=go(6,event) onkeypress='"Enter"==event.key&&go(6)'>一般<td tabindex=0 id=ServerStats class="topbar_td style3x"onmouseup=go(40,event) onkeypress='"Enter"==event.key&&go(40)'>統計<td tabindex=0 id=ServerConsole class="topbar_td style3x"onmouseup=go(115,event) onkeypress='"Enter"==event.key&&go(115)'>控制台<td tabindex=0 id=ServerTrace class="topbar_td style3x"onmouseup=go(41,event) onkeypress='"Enter"==event.key&&go(41)'>追踪<td tabindex=0 id=ServerPlugins class="topbar_td style3x"onmouseup=go(42,event) onkeypress='"Enter"==event.key&&go(42)'>外掛程式<td class="topbar_td_end style3">&nbsp;</table></div><div id=UserDummyMenuSpan><table id=UserDummyMenu cellpadding=0 cellspacing=0 class=style1><tr><td class=style3>&nbsp;</table></div></div></div></div><div id=column_l class=pt-3><div id=p0 style=display:none><div id=p0message><span id=p0span>伺服器已斷開連接</span>,<href onclick=reload() style=cursor:pointer><u>點擊重新連接</u></href>.</div></div><div id=p1 style=display:none><div id=p1title class="d-flex justify-content-between align-items-center"><div><h1>我的裝置</h1></div><div style=display:none id=devListToolbarViewIcons><div id=devViewPageState style=float:left;line-height:32px;height:32px;font-size:16px;display:none></div><div tabindex=0 id=devViewPageButton1 class=viewSelector onclick=onDeviceViewPageChange(1) onkeypress='"Enter"==event.key&&onDeviceViewPageChange(1)'title="Go to first page"style=display:none><div class=viewSelector9></div></div><div tabindex=0 id=devViewPageButton2 class=viewSelector onclick=onDeviceViewPageChange(2) onkeypress='"Enter"==event.key&&onDeviceViewPageChange(2)'title="Go to previous page"style=display:none><div class=viewSelector10></div></div><div tabindex=0 id=devViewPageButton3 class=viewSelector onclick=onDeviceViewPageChange(3) onkeypress='"Enter"==event.key&&onDeviceViewPageChange(3)'title="Go to next page"style=display:none><div class=viewSelector11></div></div><div tabindex=0 id=devViewPageButton4 class=viewSelector onclick=onDeviceViewPageChange(4) onkeypress='"Enter"==event.key&&onDeviceViewPageChange(4)'title="Go to last page"style=display:none;margin-right:12px><div class=viewSelector8></div></div><span role=button tabindex=0 id=devViewButton1 class="fa-layers fa-fw fa-xl"onclick=onDeviceViewChange(1) onkeypress='"Enter"==event.key&&onDeviceViewChange(1)'title=列><i class="fa-solid fa-bars"data-fa-transform="shrink-8 right-4 up-2"></i> <i class="fa-solid fa-bars"data-fa-transform="shrink-8 left-4 up-2"></i> <i class="fa-solid fa-bars"data-fa-transform="shrink-8 right-4 down-3"></i> <i class="fa-solid fa-bars"data-fa-transform="shrink-8 left-4 down-3"></i> </span><span role=button tabindex=0 id=devViewButton2 class="fa-layers fa-fw fa-xl"onclick=onDeviceViewChange(2) onkeypress='"Enter"==event.key&&onDeviceViewChange(2)'title=清單><i class="fa-solid fa-bars"></i> </span><span role=button tabindex=0 id=devViewButton3 class="fa-layers fa-fw fa-xl"onclick=onDeviceViewChange(3) onkeypress='"Enter"==event.key&&onDeviceViewChange(3)'title=台式電腦><i class="fa-solid fa-square"data-fa-transform="shrink-9 up-4 left-4"></i> <i class="fa-solid fa-square"data-fa-transform="shrink-9 up-4 right-4"></i> <i class="fa-solid fa-square"data-fa-transform="shrink-9 down-4 left-4"></i> <i class="fa-solid fa-square"data-fa-transform="shrink-9 down-4 right-4"></i> </span><span role=button tabindex=0 id=devViewButton5 class="fa-layers fa-fw fa-xl"onclick=onDeviceViewChange(5) onkeypress='"Enter"==event.key&&onDeviceViewChange(5)'title=台式電腦><i class="fa-solid fa-square"data-fa-transform="shrink-10 up-4 left-6"></i> <i class="fa-solid fa-square"data-fa-transform="shrink-10 up-4 right-1"></i> <i class="fa-solid fa-square"data-fa-transform="shrink-10 up-4 right-5"></i> <i class="fa-solid fa-square"data-fa-transform="shrink-10 down-4 left-1"></i> <i class="fa-solid fa-square"data-fa-transform="shrink-10 down-4 left-5"></i> <i class="fa-solid fa-square"data-fa-transform="shrink-10 down-4 right-6"></i> </span><span role=button tabindex=0 id=devViewButton4 class="fa-layers fa-fw fa-xl"onclick=onDeviceViewChange(4) onkeypress='"Enter"==event.key&&onDeviceViewChange(4)'title=地圖 style=display:none><i class="fa-solid fa-map-location-dot"></i></span></div></div><div id=devListToolbarSpan class="noselect d-flex align-items-center p-1"><div id=devListToolbar class="d-flex align-items-center visually-hidden"><span class="fa-layers fa-fw me-1"role=button style=display:none title=全部收縮 id=CollapseAllButton onclick=cmexpandaction(2)><i class="fa-solid fa-chevron-up"data-fa-transform=down-6></i> <i class="fa-solid fa-chevron-down"data-fa-transform=up-6></i> </span><span class="fa-layers fa-fw me-1"role=button style=display:none title=展開全部 id=ExpandAllButton onclick=cmexpandaction(1)><i class="fa-solid fa-chevron-up"data-fa-transform=up-6></i> <i class="fa-solid fa-chevron-down"data-fa-transform=down-6></i> </span><input type=button class="btn btn-primary me-1 btn-sm"id=SelectAllButton onclick=selectallButtonFunction() value=全選> <input type=button class="btn btn-primary me-1 btn-sm"id=GroupActionButton disabled value=集體指令 onclick=groupActionFunction()> <input type=button class="btn btn-primary me-1 btn-sm"id=ScrollToTopButton onclick=onDevicesScroll(!0) value="Scroll To Top"> <input id=SearchInput class="form-control-sm me-1 btn-sm"placeholder=過濾 onchange=onDeviceSearchChanged(event) onclick=onDeviceSearchChanged(event) onkeyup=onDeviceSearchChanged(event) onfocus=onSearchFocus(1) onblur=onSearchFocus(0) title="過濾器：user:xxx or u:xxx ip:xxx group:xxx or g:xxx tag:xxx or t:xxx atag:xxx or a:xxx os:xxx amt:xxx desc:xxx wsc:ok wsc:noav wsc: noupdate wsc:nofirewall wsc:any"> <span id=SearchInputClearButton style=display:none;position:relative><span class="fa-layers fa-fw"role=button onclick=clearDeviceSearch() style=position:absolute;left:-25px;top:-15px><i class="fa-solid fa-circle"style=color:var(--bs-secondary-bg)></i> <i class="fa-solid fa-xmark"style=color:var(--bs-body-color)></i> </span></span><select class="form-select-sm me-1"id=DevFilterSelect onchange=onOnlineCheckBox(event) title=設備過濾器><option value=0 selected>所有<option value=1>線上<option value=5>離線<option value=2>節<option value=3>已加星標<option value=4>Intel® AMT<option value=6>救命<option value=7>已標記<option value=8>未標記</select><div class=form-check title=顯示裝置操作系統名稱><input class="form-check-input me-1"type=checkbox id=RealNameCheckBox onclick=onRealNameCheckBox()><label class=form-check-label for=RealNameCheckBox>操作系統名稱</label></div><label style=display:none><input type=checkbox id=OnlineCheckBox class="form-check-input me-2"onclick=onOnlineCheckBox(event)><span title=只顯示在線裝置>線上</span></label> <span id=devsCustomUIBar></span></div><div id=kvmListToolbar class="d-flex align-items-center style14 visually-hidden"><span class="fa-layers fa-fw me-1"role=button style=display:none title=全部收縮 id=CollapseAllButton2 onclick=cmexpandaction(2)><i class="fa-solid fa-chevron-up"data-fa-transform=down-6></i> <i class="fa-solid fa-chevron-down"data-fa-transform=up-6></i> </span><span class="fa-layers fa-fw me-1"role=button style=display:none title=展開全部 id=ExpandAllButton2 onclick=cmexpandaction(1)><i class="fa-solid fa-chevron-up"data-fa-transform=up-6></i> <i class="fa-solid fa-chevron-down"data-fa-transform=down-6></i> </span><input type=button class="btn btn-primary me-1 btn-sm"onclick=connectAllKvmFunction() value=全部連接> <input type=button class="btn btn-primary me-1 btn-sm"onclick=disconnectAllKvmFunction() value=全部斷線> <input type=button class="btn btn-primary me-1 btn-sm"onclick=onDevicesScroll(!0) value="Scroll To Top"><div class="form-check me-1"title=自動連接><input class="form-check-input me-1"type=checkbox id=autoConnectDesktopCheckbox onclick=autoConnectDesktops(event)><label class=form-check-label for=autoConnectDesktopCheckbox>自動</label></div><input type=button class="btn btn-primary me-1 btn-sm"onclick=showMultiDesktopSettings() value=設定> <input id=KvmSearchInput class="form-control-sm me-1"placeholder=過濾 onchange=onDeviceSearchChanged(event) onclick=onDeviceSearchChanged(event) onkeyup=onDeviceSearchChanged(event) onfocus=onSearchFocus(1) onblur=onSearchFocus(0) title="過濾器：user:xxx or u:xxx ip:xxx group:xxx or g:xxx tag:xxx or t:xxx atag:xxx or a:xxx os:xxx amt:xxx desc:xxx wsc:ok wsc:noav wsc: noupdate wsc:nofirewall wsc:any"> <span id=KvmSearchInputClearButton style=display:none;position:relative><span class="fa-layers fa-fw"role=button onclick=clearDeviceSearch() style=position:absolute;left:-25px;top:-15px><i class="fa-solid fa-circle"style=color:var(--bs-secondary-bg)></i> <i class="fa-solid fa-xmark"style=color:var(--bs-body-color)></i></span></span></div><div id=devMapToolbar class="d-flex align-items-center style14 visually-hidden"><input class="form-control-sm me-1"type=search id=mapSearchLocation placeholder=搜尋位置 onfocus=onMapSearchFocus(1) onblur=onMapSearchFocus(0)> <input class="btn btn-primary me-1 btn-sm"type=button value=搜尋 title=尋找位置 onclick=getSearchLocation()> <input class="btn btn-primary me-1 btn-sm"type=button id=refreshmap title=重置地圖視圖 value=重設 onclick=refreshMap(!1,!0)></div><div class="d-flex align-items-center ms-auto"><div style=display:none id=devListToolbarView>檢視 <select id=viewselect onchange=onDeviceViewChange()><option value=1>列<option value=2>清單<option value=3>桌面固定寬度<option id=viewselectmapoption value=4 style=display:none>地圖<option value=5>台式電腦</select></div><div style=display:none id=devListToolbarSize>尺寸 <select id=sizeselect class="form-select-sm me-2"onchange=onDeviceViewChange()><option value=0>小<option value=1>中<option value=2>大</select> &nbsp;</div><div style=display:none id=devListToolbarSort>排序 <select id=sortselect class="form-select-sm me-2"onchange=mainUpdate(6)><option>群<option>電源<option>裝置<option>標籤<option>組標籤<option>最後一次露面</select> &nbsp;</div><i class="fa-solid fa-gear"role=button id=devListToolbarSettings onclick=onDeviceViewSettings()></i></div></div><div id=NoMeshesPanel style=display:none><table><tr><td valign=top style=width:50px><img src=images/info.png loading=lazy width=47 height=48><td><div id=getStarted1>開始， <a href=# onclick="return account_createMesh()"><strong>單擊此處創建裝置群</strong></a>.</div><div id=getStarted2>沒有裝置群。</div></table></div><div id=xdevices class=noselect style=display:none onscroll=onDevicesScroll(!1)></div><div id=xdevicesmap style=display:none><div id=xmapSearchResultsDlg style=display:none><div id=xmapSearchResultsBck><div id=xmapSearchClose onclick=mapCloseSearchWindow()><b>X</b></div><div style=padding:5px>位置結果</div><div style=width:100%;margin:6px></div></div><div id=xmapSearchResults style=margin:6px></div></div></div><div id=xmap-info-window></div></div><div id=p2 style=display:none><div id=p2title><h1>我的帳戶</h1></div><div id=p2info style=overflow-y:auto><div id=p2AccountImageFrame><img id=p2AccountImage alt=""loading=lazy width=128 height=128 onclick=account_manageImage(0) src=images/user-256.png><div><a href=# onclick=account_manageImage(0)>更改圖像</a></div></div><div id=p2AccountSecurity style=display:none><p><strong>帳戶安全</strong><div style=margin-left:25px><div id=managePhoneNumber1><div class=p2AccountActions><span id=authPhoneNumberCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_managePhone()">管理電話號碼</a><br></span></div><div id=manageEmail2FA><div class=p2AccountActions><span id=authEmailSetupCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_manageAuthEmail()">管理電郵身份驗證</a><br></span></div><div id=manageAuthApp><div class=p2AccountActions><span id=authAppSetupCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_manageAuthApp()">管理身份驗證器軟體</a><br></span></div><div id=manageDuoApp><div class=p2AccountActions><span id=authDuoSetupCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_manageAuthDuo()">Manage Duo authentication</a><br></span></div><div id=manageHardwareOtp><div class=p2AccountActions><span id=authKeySetupCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_manageHardwareOtp(0)">管理安全密鑰</a><br></span></div><div id=managePushAuthDev><div class=p2AccountActions><span id=authPushAuthDevCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_managePushAuthDev()">管理推送身份驗證</a><br></span></div><div id=manageMessaging1><div class=p2AccountActions><span id=authMessagingCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_manageMessaging()">Manage messaging</a><br></span></div><div id=manageOtp><div class=p2AccountActions><span id=authCodesSetupCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_manageOtp(0)">管理備用碼</a><br></span></div><div class=p2AccountActions></div><span><a href=# onclick="return account_viewPreviousLogins()">查看以前的登錄</a><br></span></div></div><div id=p2AccountActions><p><strong>帳戶動作</strong><p class=mL><span id=managePhoneNumber2 style=display:none><a href=# onclick="return account_managePhone()">管理電話號碼</a><br></span><span id=manageMessaging2 style=display:none><a href=# onclick="return account_manageMessaging()">Manage messaging</a><br></span><span id=verifyEmailId style=display:none><a href=# onclick="return account_showVerifyEmail()">驗證電郵</a><br></span><span id=accountEnableNotificationsSpan style=display:none><a href=# onclick="return account_enableNotifications()">啟用網絡通知</a><br></span><a href=# onclick="return account_showLocalizationSettings()">本地化設置</a><br><a href=# onclick="return account_showAccountNotifySettings()">通知設定</a><br><span id=p2AccountPassActions><span id=accountChangeEmailAddressSpan style=display:none><a href=# onclick="return account_showChangeEmail()">更改電郵地址</a><br></span><a href=# onclick="return account_showChangePassword()">更改密碼</a><span id=p2nextPasswordUpdateTime></span><br><a href=# onclick="return account_showDeleteAccount()">刪除帳戶</a><br></span><span id=accountCreateLoginTokenSpan style=display:none><a href=# onclick="return account_createLoginToken()">創建登錄令牌</a><br></span><a href=# onclick="return account_showThemesSwitcher()">Switch theme</a><br></p><br style=clear:both></div><div id=p2logintokens></div><strong>裝置群</strong> <span id=p2createMeshLink1>- <button class="btn btn-primary btn-sm"onclick="return account_createMesh()"><i class="fa-fw fa-solid fa-circle-plus"></i> 新</button></span><br><br><div id=p2meshes></div><div id=p2noMeshFound style=display:none>沒有裝置群。<span id=p2createMeshLink2> <a href=# onclick="return account_createMesh()"><strong>從這裡開始！</strong></a></span></div><br style=clear:both></div></div><div id=p3 style=display:none><div id=p3title><h1>我的事件</h1></div><table class=pTable><tr><td class="auto-style1 d-flex justify-content-end p-1"><div class="d-flex align-items-center"><label for=p3filterevents class=me-1>過濾</label> <select id=p3filterevents class="form-select-sm me-2"onchange=refreshEvents()><option notransval=1 value="">All Logs<option notransval=1 value=agentlog>Agent Logs<option notransval=1 value=relaylog>Relay Logs<option notransval=1 value=manual>Manual Logs<option notransval=1 value=runcommands>Run Command Logs<option notransval=1 value=batchupload>Batch Upload Logs<option notransval=1 value=changenode>Change Node Logs<option notransval=1 value=removenode>Remove Node Logs</select> <label for=p3limitdropdown class=me-1>顯示</label> <select id=p3limitdropdown class="form-select-sm me-2"onchange=refreshEvents()><option notransval=1 value=60>最後60<option notransval=1 value=120>最後120<option notransval=1 value=250>最後250<option notransval=1 value=500>最後500<option notransval=1 value=1000>最後1000<option notransval=1 value="">沒有限制</select> <a href=# onclick=p3showDownloadEventsDialog(2)><i class="fa-solid fa-download"title=下載事件></i></a></div></table><div id=p3events></div></div><div id=p4 style=display:none><div id=p4title><h1>我的用戶</h1></div><table class=pTable><tr><td class="style14 d-flex align-items-center flex-wrap p-1"><div class="d-flex align-items-center"><input type=button id=UsersSelectAllButton class="btn btn-primary btn-sm me-1"onclick=p3usersSelectallButtonFunction() value=全選> <input type=button id=UsersGroupActionButton class="btn btn-primary btn-sm me-1"disabled value=集體指令 onclick=p3usersGroupActionFunction()> <input id=UserNewAccountButton class="btn btn-primary btn-sm me-1"type=button onclick=showCreateNewAccountDialog() value=新賬戶...><div class="d-inline-flex align-items-center"><input id=UserSearchInput type=search class="form-control-sm me-1"placeholder=過濾 onchange=onUserSearchInputChanged() onkeyup=onUserSearchInputChanged() autocomplete=off onfocus=onUserSearchFocus(1) onblur=onUserSearchFocus(0)></div></div><div class="d-flex align-items-center ms-auto"><input type=button class="btn btn-primary btn-sm me-2"onclick=showUserBroadcastDialog() style=margin-right:6px value=廣播> <a href=# onclick=p4downloadUserInfo()><i role=button class="fa-solid fa-download me-2"title=下載用戶訊息></i></a> <a href=# onclick=p4batchAccountCreate()><i role=button id=p4UserBatchCreate style=display:none title=批量創建多個用戶帳戶 class="fa-solid fa-upload me-1"></i></a> <i style=cursor:pointer;margin-top:3px;margin-left:6px id=usersListToolbarSettings class="fa-solid fa-cog"title=設定 onclick=onUsersViewSettings()></i></div></table><div id=p3users></div></div><div id=p5 style=display:none><div id=p5title><h1>我的檔案</h1></div><table id=p5toolbar class=table cellpadding=0 cellspacing=0><tr><td id=p5filehead valign=bottom class="d-flex align-items-center"><div id=p5rightOfButtons class="d-flex align-items-center"></div><div class="m-1 d-flex align-items-center"><input type=button id=p5FolderUp class="btn btn-primary btn-sm me-1"disabled onclick="return p5folderup()"value=上> <input type=button id=p5SelectAllButton class="btn btn-primary btn-sm me-1"disabled onclick=p5selectallfile() value=全選> <input type=button id=p5RenameFileButton class="btn btn-primary btn-sm me-1"disabled value=改名 onclick=p5renamefile()> <input type=button id=p5DeleteFileButton class="btn btn-primary btn-sm me-1"disabled value=刪除 onclick=p5deletefile()> <input type=button id=p5ViewFileButton class="btn btn-primary btn-sm me-1"disabled value=編輯 onclick=p5viewfile()> <input type=button id=p5NewFolderButton class="btn btn-primary btn-sm me-1"disabled value=新建檔案夾 onclick=p5createfolder()> <input type=button id=p5UploadButton class="btn btn-primary btn-sm me-1"disabled value=上載 onclick=p5uploadFile()> <input type=button id=p5DownloadButton class="btn btn-primary btn-sm me-1"disabled value=下載 onclick=p5downloadButton()> <input type=button id=p5CutButton class="btn btn-primary btn-sm me-1"disabled value=切 onclick=p5copyFile(1)> <input type=button id=p5CopyButton class="btn btn-primary btn-sm me-1"disabled value=複製 onclick=p5copyFile(0)> <input type=button id=p5PasteButton class="btn btn-primary btn-sm me-1"disabled value=糊 onclick=p5pasteFile()></div><tr><td id=p5filesubhead class="d-flex align-items-center"><div class="d-flex align-items-center">&nbsp;&nbsp;<span id=p5currentpath></span></div><div style=float:right class="d-flex align-items-center ms-auto"><select id=p5sortdropdown class="form-select-sm me-1"onchange=updateFiles()><option value=1 selected>按名稱排序<option value=2>按大小排序<option value=3>按日期排序<option value=4>按名稱降序<option value=5>按大小降序<option value=6>按日期降序</select></div></table><div id=p5filetable><div id=p5PublicShare><div>這些檔案是公開共享的，請單擊“鏈結”以獲取公用URL。</div></div><div id=bigok style=display:none><b>✓</b></div><div id=bigfail style=display:none><b>✗</b></div><span id=p5files></span></div><table id=p5toolbarBottom class="table table-hover"style=width:100% cellpadding=0 cellspacing=0><tr><td class=style6>&nbsp;<span id=p5bottomstatus></span></table></div><div id=p6 style=display:none><div id=p6info style=overflow-y:auto><div id=p6title><img id=MainMeshImage src=serverpic.ashx><h1>我的伺服器</h1></div><div id=p2ServerActions><p><strong>伺服器指令</strong><div style=margin-left:25px><div id=p2ServerActionsBackup><div class=p2AccountActions><span style=display:none><strong>✓</strong></span></div><a id=p6backuplink href={{{domainurl}}}backup.zip rel="noreferrer noopener"target=_blank>下載伺服器備份</a></div><div id=p2ServerActionsRestore><div class=p2AccountActions><span style=display:none><strong>✓</strong></span></div><a href=# onclick="return server_showRestoreDlg()">通過備份還原伺服器</a></div><div id=p2ServerActionsGoogleBackup style=display:none><div class=p2AccountActions><span id=p2ServerActionsGoogleBackupCheck style=display:none><strong>✓</strong></span></div><span><a href=# onclick="return server_setupGoogleDriveBackup()">Google雲端硬盤備份</a><br></span></div><div id=p2ServerActionsVersion><div class=p2AccountActions><span style=display:none><strong>✓</strong></span></div><a href=# onclick="return server_showVersionDlg()">檢查伺服器版本</a></div><div id=p2ServerActionsErrors><div class=p2AccountActions><span style=display:none><strong>✓</strong></span></div><a href=# onclick="return server_showErrorsDlg()">顯示伺服器錯誤日誌</a></div><div id=p2ServerActionsConfig><div class=p2AccountActions><span style=display:none><strong>✓</strong></span></div><a href=# onclick="return server_showConfigDlg()">Show server configuration</a></div></div><br></div><strong>伺服器統計</strong><br><br><div id=serverStats><div id=serverCpuChartView style=display:none><div class=chartViewCanvas style=height:40px;text-align:center><canvas id=serverCpuChart style=display:inline-block></canvas></div><div class=chartViewText id=serverCpuChartText></div></div><div id=serverMemoryChartView style=display:none><div class=chartViewCanvas style=height:40px;text-align:center><canvas id=serverMemoryChart style=display:inline-block></canvas></div><div class=chartViewText id=serverMemoryChartText></div></div><br><br><div id=serverStatsTable></div></div><div id=serverWarningsDiv style=display:none><br><strong>伺服器警告</strong><br><br><div id=serverCertWarnings></div><div id=serverWarnings></div></div></div></div><div id=p10 style=display:none><div id=p10title class="d-flex align-items-center"><div id=p10BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold">一般 - <span id=p10deviceName></span></div></div><div id=p10info style=overflow-y:auto class=pt-3><table style=width:100% cellpadding=0 cellspacing=0><tr><td style=width:auto valign=top><div id=p10html></div><td style=width:100px;display:none id=notesPanel valign=top><table><thead><tr><th>筆記<tbody><tr><td><div id=notesPanelArea style=width:300px;height:200px;resize:none;overflow-y:scroll></div></table><td style=width:20px><td style=width:200px;vertical-align:top;position:relative valign=top><div class=deviceNotifyLargeDot><div id=p10deviceMsg onclick=showDeviceMessages(null,null,event) class=deviceNotifyDotSub></div><i title=已加星標 role=button class="fa-solid fa-star"id=p10deviceStar onclick=showDeviceSessions(null,null,event) data-fa-transform=shrink-5 data-fa-mask="fa-solid fa-circle"></i> <i title=此計算機上活動的遠程會話列表。 role=button class="fa-solid fa-arrow-right-arrow-left"id=p10deviceNotify onclick=showDeviceSessions(null,null,event) data-fa-transform=shrink-5 data-fa-mask="fa-solid fa-circle"></i> <i title=請求幫助 role=button class="fa-solid fa-question"id=p10deviceHelp onclick=showDeviceHelpRequests(null,null,event) data-fa-transform=shrink-5 data-fa-mask="fa-solid fa-circle"></i></div><div id=p10deviceBattery class="deviceBatteryLarge deviceBatteryLarge1"></div><a href=# onclick=p10showiconselector()><img id=MainComputerImage></a><div id=MainComputerState></div></table><br><div id=p10html2></div><div id=p10html3></div><div id=p10html4></div><div id=p10html5></div></div></div><div id=p11 class=noselect style=display:none><div id=p11title class="d-flex align-items-center"><div id=p11BackButton class=pe-2><i class="fa-solid fa-2xl fa-square-caret-left"role=button tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold">桌面 - <span id=p11deviceName></span></div><div id=devListToolbarViewIcons class=ms-auto><i class="fa-solid fa-xl fa-maximize fa-border"role=button onclick=deskToggleFull(event) title=全屏。按住Shift鍵更改為全屏瀏覽器。></i></div></div><div id=p11warning onclick=showFeaturesDlg()><div class=icon2></div><div class=warningbox>重定向端口或 KVM 功能已禁用<span id=p11warninga>，請點擊此處啟用它。</span></div></div><div id=p11warning2 onclick=showPowerActionDlg()><div class=icon2></div><div class=warningbox>遠程電腦未打開電源，請單擊此處以發出電源命令。</div></div><div style=position:absolute;right:16px;margin-top:-14px;font-size:x-small;color:#000><div id=p11capslock style=display:inline-block;margin-left:1px;border-radius:5px;background-color:#a3ffb8;padding:2px>大寫字母</div><div id=p11scrolllock style=display:inline-block;margin-left:1px;border-radius:5px;background-color:#a3ffb8;padding:2px>滾動</div><div id=p11numlock style=display:inline-block;margin-left:1px;border-radius:5px;background-color:#a3ffb8;padding:2px>NUM</div></div><div id=deskarea0 cellpadding=0 cellspacing=0><div id=deskarea1 class="areaHead d-flex flex-wrap"><div class="d-flex align-items-center"><input type=button class="btn btn-primary btn-sm me-1"id=autoconnectbutton1 value=自動連接 onclick=autoConnectDesktop(event) onkeypress=return!1 onkeydown=return!1 style=display:none;margin-right:4px><div class="btn-group dropdown-center me-1"id=connectbutton1span><button type=button class="btn btn btn-primary btn-sm"id=connectbutton1 title="使用 MeshAgent 遠程桌面連接"onclick=connectDesktop(event,3) onkeypress=return!1 onkeydown=return!1 disabled>連接</button> <button type=button class="btn btn-primary btn-sm dropdown-toggle dropdown-toggle-split"id=connectbutton1d data-bs-toggle=dropdown aria-expanded=false><span class=visually-hidden>Toggle Dropdown</span></button><ul class=dropdown-menu><li><a class=dropdown-item onclick=cmdeskaction(1,event)>詢問同意+工具欄</a><li><a class=dropdown-item onclick=cmdeskaction(2,event)>詢問同意</a><li><a class=dropdown-item onclick=cmdeskaction(3,event)>隱私欄</a></ul></div><div class="btn-group dropdown-center me-1"id=connectbutton1rspan><button type=button class="btn btn btn-primary btn-sm"id=connectbutton1r title="使用 RDP 連接"onclick=askRdpCredentials() onkeypress=return!1 onkeydown=return!1 disabled>RDP 連接</button> <button type=button class="btn btn-primary btn-sm dropdown-toggle dropdown-toggle-split"id=connectbutton1rd data-bs-toggle=dropdown aria-expanded=false><span class=visually-hidden>Toggle Dropdown</span></button><ul class=dropdown-menu><li><a class=dropdown-item onclick=cmaltportaction(1,event)>備用端口</a></ul></div><span id=connectbutton1hspan><button class="btn btn-primary btn-sm me-1"type=button id=connectbutton1h title="使用硬件 KVM 連接"onclick=connectDesktop(event,2) onkeypress=return!1 onkeydown=return!1 disabled>硬件連接</button></span><div class="btn-group dropdown-center me-1"id=disconnectbutton1span><button type=button class="btn btn btn-primary btn-sm"id=disconnectbutton1 title="使用 MeshAgent 遠程桌面連接"onclick=connectDesktop(event,0) onkeypress=return!1 onkeydown=return!1>斷線</button> <button type=button class="btn btn-primary btn-sm dropdown-toggle dropdown-toggle-split"id=diconnectbutton1d data-bs-toggle=dropdown aria-expanded=false><span class=visually-hidden>Toggle Dropdown</span></button><ul class=dropdown-menu><li><a class=dropdown-item onclick=cmdeskaction(10,event)>斷開連接並鎖定</a><li><a class=dropdown-item onclick=cmdeskaction(11,event)>斷線</a></ul></div><span id=deskstatus style=line-height:22px>已斷線</span><span id=deskmetadata></span></div><div class="d-flex align-items-center ms-auto"><div id=desktopCustomUiButtons style=float:left></div><div id=desktopCustomUpperRight style=float:left;margin-right:6px></div><input type=button class="btn btn-primary btn-sm"title=更改遠程機器的電源狀態 onkeypress=return!1 onkeydown=return!1 value=電源指令... onclick=showPowerActionDlg() style=display:none> <input id=deskActionsBtn type=button class="btn btn-primary btn-sm me-1"title=在裝置上執行電源操作 onkeypress=return!1 onkeydown=return!1 value=動作 onclick=deviceActionFunction()> <input id=deskActionsSettings type=button class="btn btn-primary btn-sm me-1"value=設定 title=編輯遠程桌面設置 onkeypress=return!1 onkeydown=return!1 onclick=showDesktopSettings()> <input id=deskFocusBtn type=button title=切換焦點模式，現用中僅更新鼠標周圍的區域 onkeypress=return!1 onkeydown=return!1 value=全部關注 onclick=deskToggleFocus() style=margin-right:3px;display:none><div id=deskRecordIcon class=deskareaicon title=伺服器正在記錄此節 style=display:none;background-color:red;width:12px;height:12px;border-radius:6px;margin-top:5px></div><div class=deskareaicon title=向右旋轉 onclick=drotate(1)><i class="fa-solid fa-rotate-right"></i></div><div class=deskareaicon title=向左旋轉 onclick=drotate(-1)><i class="fa-solid fa-rotate-left"></i></div><div class=deskareaicon title=切換查看模式 onclick=toggleAspectRatio(1)>⇲</div><div id=idx_deskFullBtn2 onclick=deskToggleFull(event) style=float:right>&nbsp;✖</div></div></div><div id=deskarea3x><div id=p11bigok style=display:none><b>✓</b></div><div id=p11bigfail style=display:none><b>✗</b></div><div id=DeskFocus oncontextmenu=return!1 onmousedown=dmousedown(event) onmouseup=dmouseup(event) onmousemove=dmousemove(event)></div><div id=DeskParent><canvas id=Desk width=640 height=480 oncontextmenu=return!1 onmousedown=dmousedown(event) onmouseup=dmouseup(event) onmousemove=dmousemove(event) onmousewheel=dmousewheel(event)></canvas></div><div id=DeskTools><div id=deskToolsAreaTop><a id=DeskToolsRefreshButton class=link-underline-primary style=right:2px onclick=refreshDeskTools()>刷新</a><div id=deskToolsTopTabProcess class=deskToolsTopTab onclick=changeDeskToolTab(0) style=left:0;bottom:0>進程</div><div id=deskToolsTopTabService class=deskToolsTopTab onclick=changeDeskToolTab(1) style=display:none;left:90px;color:gray>服務</div></div><div id=deskToolsArea><div id=DeskToolsProcessTab><div id=deskToolsHeader><a class=colmn1 title=按進程ID排序 onclick=sortProcess(0)>PID</a> <a class=colmn2 title=按名稱排序 onclick=sortProcess(1)>名稱</a></div><div id=DeskToolsProcesses></div></div><div id=DeskToolsServiceTab style=display:none><div id=deskToolsServiceHeader><a class=colmn1 style=width:70px title=按狀態排序 onclick=sortService(0)>狀態</a> <a class=colmn2 title=按名稱排序 onclick=sortService(1)>名稱</a></div><div id=DeskToolsServices></div></div></div></div><div id=p11DeskConsoleMsg style=display:none;text-align:left;cursor:pointer;position:absolute;left:30px;top:17px;color:#ff0;background-color:rgba(0,0,0,.6);padding:10px;border-radius:5px;text-align:left onclick=p11clearConsoleMsg()></div><div id=p11DeskSessionSelector style=display:none;position:absolute;left:30px;top:17px;right:30px;bottom:17px;overflow-y:auto></div></div><div id=deskarea4 class="areaFoot d-flex flex-wrap"><div class="d-flex align-items-center"><select id=deskkeys class="form-select-sm me-1"cmenu=deskKeyShortcutContextMenu></select> <input id=DeskWD type=button class="btn btn-primary btn-sm me-1"value=發送 onkeypress=return!1 onkeydown=return!1 onclick=deskSendKeys()> <input id=DeskESC style=display:none type=button class="btn btn-primary btn-sm me-1"value=ESC onkeypress=return!1 onkeydown=return!1 onclick=sendDeskEsc()> <input id=DeskClip type=button class="btn btn-primary btn-sm me-1"value=剪貼板 onkeypress=return!1 onkeydown=return!1 onclick=showDeskClip()> <input id=DeskType class="btn btn-primary btn-sm me-1"cmenu=deskPreConfigShortcutContextMenu type=button value=類型 onkeypress=return!1 onkeydown=return!1 onclick=showDeskType()><div id=DeskControlSpan title=切換鼠標和鍵盤輸入 class=form-check><input id=DeskControl type=checkbox class=form-check-input onkeypress=return!1 onkeydown=return!1 onclick=toggleKvmControl()><label class=form-check-label for=DeskControl>輸入</label></div>&nbsp;</div><div class="d-flex ms-auto align-items-center"><span id=DeskMonitorSelectionSpan></span> <span id=DeskLatency style=width:70px class=text-center title=桌面會話延遲></span> <span id=DeskTimer style=width:70px class=text-center title=上課時間></span> <input id=DeskToolsButton type=button class="btn btn-primary btn-sm mx-1"value=工具 title=切換工具視圖 onkeypress=return!1 onkeydown=return!1 onclick=toggleDeskTools()> <span id=DeskGuestShareButton title=與訪客共享設備 role=button><i class="fa-solid fa-fw fa-share-nodes"id=DeskInputUnLockedButtonImage onclick=showShareDevice()></i> </span><span id=DeskInputUnLockedButton title=遠程輸入已解鎖 role=button><i class="fa-solid fa-fw fa-keyboard"onclick=deskInputLockFunction(1)></i> </span><span id=DeskInputLockedButton title=遠程輸入被鎖定 role=button><i class="fa-solid fa-fw fa-keyboard"style=color:red onclick=deskInputLockFunction(0)></i> </span><span id=DeskRefreshButton title=刷新桌面 role=button><i class="fa-solid fa-fw fa-rotate"onclick=deskRefreshFunction()></i> </span><span id=DeskClipboardOutButton title=將本地剪貼板上傳到遠程裝置 role=button><i class="fa-solid fa-fw fa-up-long"data-fa-transform="shrink-9 down-4"data-fa-mask="fa-solid fa-clipboard"onclick=deskClipboardOutFunction()></i> </span><span id=DeskClipboardInButton title=將遠程剪貼板下載到本地剪貼板 style=display:none role=button><i class="fa-solid fa-fw fa-down-long"data-fa-transform="shrink-9 down-4"data-fa-mask="fa-solid fa-clipboard"onclick=deskClipboardInFunction()></i> </span><span id=DeskRecordButton cmenu=deskPlayerContextMenu title=將遠程桌面會話記錄到檔案 style=display:none role=button><i class="fa-solid fa-fw fa-video"onclick=deskRecordSession() id=DeskRecordButtonImage></i> </span><span id=DeskSaveImageButton title=保存遠程桌面的屏幕截圖 role=button><i class="fa-solid fa-fw fa-camera"onclick=deskSaveImage()></i> </span><span id=DeskBackgroundButton title=切換遠程桌面背景 role=button><i class="fa-solid fa-fw fa-image"onclick=deviceToggleBackground(event) id=DeskBackgroundButtonImage></i> </span><span id=DeskOpenWebButton title=在遠程電腦上打開一個網址 role=button><i class="fa-solid fa-fw fa-globe"onclick=deviceUrlFunction()></i> </span><span id=DeskLockButton title=鎖定遠程計算機 role=button><i class="fa-solid fa-fw fa-lock"onclick=deviceLockFunction()></i> </span><span id=DeskNotifyButton title=在遠程電腦上顯示通知 role=button><i class="fa-solid fa-fw fa-bell"onclick=deviceToastFunction()></i> </span><span id=DeskChatButton class=deskarea title=打開此電腦的聊天窗口 role=button><i class="fa-solid fa-fw fa-message"onclick=deviceChat(event)></i> </span><span id=DeskRunButton cmenu=deskPreConfigScriptContextMenu class=deskarea title="Run a script on this computer"role=button><i class="fa-solid fa-fw fa-play"onclick=runDeviceCmd()></i></span></div></div></div></div><div id=p12 style=display:none><div id=p12title class="d-flex align-items-center"><div id=p12BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold">終端機 - <span id=p12deviceName></span></div><div id=devListToolbarViewIcons2 class=ms-auto><i class="fa-solid fa-xl fa-maximize fa-border"role=button onclick=deskToggleFull(event) title=全屏。按住Shift鍵更改為全屏瀏覽器。></i></div></div><div id=p12warning onclick=showFeaturesDlg()><div class=icon2></div><div class=warningbox>重定向端口或 KVM 功能已禁用<span id=p12warninga>，請點擊此處啟用它。</span></div></div><div id=p12warning2 onclick=showPowerActionDlg()><div class=icon2></div><div class=warningbox>遠程電腦未打開電源，請單擊此處以發出電源命令。</div></div><div id=termTable style=position:relative><table style=width:100% cellpadding=0 cellspacing=0><tr><td class="areaHead d-flex flex-wrap"><div class="d-flex align-items-center"><button type=button id=autoconnectbutton2 class="btn btn-primary btn-sm me-1"onclick=autoConnectTerminal(event) onkeypress=return!1 onkeydown=return!1 style=display:none><i class="fa-solid fa-play"></i> 自動連接</button><div class="btn-group dropdown-center me-1"id=connectbutton2span><button type=button class="btn btn btn-primary btn-sm"id=connectbutton2 title="使用 MeshAgent 遠程桌面連接"onclick=connectTerminal(event,1) onkeypress=return!1 onkeydown=return!1 disabled>連接</button> <button type=button class="btn btn-primary btn-sm dropdown-toggle dropdown-toggle-split"id=connectbutton2d data-bs-toggle=dropdown aria-expanded=false onclick=newContextMenu(event,1)><span class=visually-hidden>Toggle Dropdown</span></button><ul class=dropdown-menu><li><a class=dropdown-item onclick=cmtermaction(1,0,event)><b>管理控制台</b></a><li><a class=dropdown-item onclick=cmtermaction(6,0,event)>管理員PowerShell</a><li><a class=dropdown-item onclick=cmtermaction(8,0,event)>用戶Shell</a><li><a class=dropdown-item onclick=cmtermaction(9,0,event)>用戶PowerShell</a><li><a class=dropdown-item onclick=cmtermaction(1,16,event)>詢問管理員外殼</a><li><a class=dropdown-item onclick=cmtermaction(6,16,event)>詢問管理員 PowerShell</a><li><a class=dropdown-item onclick=cmtermaction(8,16,event)>詢問用戶外殼</a><li><a class=dropdown-item onclick=cmtermaction(9,16,event)>詢問用戶 PowerShell</a><li class=ass><a class=dropdown-item onclick=cmtermaction(8,0,event)><b>用戶Shell</b></a><li class=ass><a class=dropdown-item onclick=cmtermaction(9,0,event)>用戶PowerShell</a><li class=lin><a class=dropdown-item onclick=cmtermaction(1,0,event)><b>Root Shell</b></a><li class=lin><a class=dropdown-item onclick=cmtermaction(8,0,event)>用戶Shell</a><li class=lin><a class=dropdown-item onclick=cmtermaction(100,0,event)>登入控制台</a></ul></div><div class="btn-group dropdown-center me-1"id=connectbutton2sspan><button type=button class="btn btn btn-primary btn-sm"id=connectbutton2s title="使用 MeshAgent 遠程桌面連接"onclick=connectTerminal(event,3) onkeypress=return!1 onkeydown=return!1 disabled>SSH 連接</button> <button type=button class="btn btn-primary btn-sm dropdown-toggle dropdown-toggle-split"id=connectbutton2sd data-bs-toggle=dropdown aria-expanded=false><span class=visually-hidden>Toggle Dropdown</span></button><ul class=dropdown-menu><li><a class=dropdown-item onclick=cmsshportaction(1,event)>備用端口</a></ul></div><span id=connectbutton2hspan><button type=button class="btn btn-primary btn-sm me-1"id=connectbutton2h title=使用英特爾®AMT硬件KVM連接 onclick=connectTerminal(event,2) onkeypress=return!1 onkeydown=return!1 disabled>硬件連接</button></span> <span id=disconnectbutton2span><button type=button class="btn btn-primary btn-sm me-1"id=disconnectbutton2 onclick=connectTerminal(event,0) onkeypress=return!1 onkeydown=return!1>斷線</button></span> <span id=termstatus style=line-height:22px>已斷線</span><span id=termtitle></span></div><div class="d-flex align-items-center ms-auto"><div id=idx_termFullBtn2 onclick=deskToggleFull(event) style=float:right>&nbsp;✖</div><div id=termRecordIcon class=deskareaicon title=伺服器正在記錄此節 style=display:none;background-color:red;width:12px;height:12px;border-radius:6px;margin-top:5px;margin-left:5px></div><input id=termActionsBtn type=button title=在裝置上執行電源操作 onkeypress=return!1 onkeydown=return!1 value=動作 class="btn btn-primary me-1 btn-sm"onclick=deviceActionFunction()><div id=terminalCustomUpperRight style=float:left;margin-right:6px></div><div id=terminalCustomUiButtons style=float:left></div></div><tr><td id=termarea3x><div id=termarea3xdiv style=width:100%;height:100%;text-align:left></div><pre id=Term></pre><tr><td class="areaFoot d-flex flex-wrap"><div class="d-flex align-items-center"><input type=button onkeypress=return!1 onkeydown=return!1 class="btn btn-primary btn-sm me-1"id=ctrlcbutton value=Ctl-C onclick='termSendKey(3,"ctrlcbutton")'> <input type=button onkeypress=return!1 onkeydown=return!1 class="btn btn-primary btn-sm me-1"id=ctrlxbutton value=Ctl-X onclick='termSendKey(24,"ctrlxbutton")'> <input type=button onkeypress=return!1 onkeydown=return!1 class="btn btn-primary me-1 btn-sm"id=escbutton value=ESC onclick='termSendKey(27,"escbutton")'> <input type=button onkeypress=return!1 onkeydown=return!1 class="btn btn-primary me-1 btn-sm"id=bsbutton value=退格鍵 onclick='termSendKey(8,"bsbutton")'style=display:none> <input type=button onkeypress=return!1 onkeydown=return!1 class="btn btn-primary me-1 btn-sm"id=pastebutton value=糊 title=將文本黏貼到終端中 onclick=showTermPasteDialog() style=display:none></div><div class="d-flex align-items-center ms-auto"><span id=TermTimer title=上課時間></span>&nbsp; <span id=terminalSettingsButtons style=display:none><input id=id_tcrbutton type=button onkeypress=return!1 onkeydown=return!1 class="btn btn-primary me-1 btn-sm"value=CR+LF title=切換返回鍵將發送的內容 onclick=termToggleCr()> <input id=id_tfxkeysbutton type=button onkeypress=return!1 onkeydown=return!1 class="btn btn-primary me-1 btn-sm"value="Intel（F10 = ESC + [OM）"title=切換F1至F10鍵仿真類型 onclick=termToggleFx()> <input id=id_ttypebutton type=button onkeypress=return!1 onkeydown=return!1 class="btn btn-primary me-1 btn-sm"value=擴充式ASCII title=切換終端仿真類型 onclick=termToggleType()> </span><span id=terminalSizeDropDown style=display:none><select id=termSizeList onkeypress=return!1 class="form-select-sm me-1"><option value=1>80x25<option value=2>100x30</select> </span><select id=specialkeylist class="form-select-sm me-1"onkeypress=return!1></select> <input id=specialkeylistinput type=button onkeypress=return!1 class="btn btn-primary btn-sm me-1"value=發送 title=發送選擇的特殊鍵 onclick=sendSpecialKey()></div></table><div id=p12TermConsoleMsg style=display:none;text-align:left;cursor:pointer;position:absolute;left:30px;top:45px;color:#ff0;background-color:rgba(0,0,0,.6);padding:10px;border-radius:5px onclick=p12clearConsoleMsg()></div></div></div><div id=p13 style=display:none><div id=p13title class="d-flex align-items-center"><div id=p13BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold">檔案- <span id=p13deviceName></span></div></div><table id=p13toolbar cellpadding=0 cellspacing=0><tr><td class="areaHead d-flex flex-wrap"><div class="d-flex align-items-center"><button id=p13AutoConnect onclick=autoConnectFiles(event) class="btn btn-primary btn-sm me-1"type=button style=display:none><i class="fa-solid fa-play"></i> 自動連接</button><div class="btn-group dropdown-center me-1"id=p13Connectspan><button type=button class="btn btn btn-primary btn-sm"id=p13Connect title="使用 MeshAgent 遠程桌面連接"onclick=connectFiles(event,1) onkeypress=return!1 onkeydown=return!1 disabled>連接</button> <button type=button class="btn btn-primary btn-sm dropdown-toggle dropdown-toggle-split"id=p13Connectdrop data-bs-toggle=dropdown aria-expanded=false><span class=visually-hidden>Toggle Dropdown</span></button><ul class=dropdown-menu><li><a class=dropdown-item onclick=cmconnectfilesaction()>詢問同意</a></ul></div><button id=p13Disconnect class="btn btn-primary btn-sm me-1"onclick=connectFiles(event) type=button>斷線</button><div class="btn-group dropdown-center me-1"id=p13Connectsspan><button type=button class="btn btn btn-primary btn-sm"id=p13Connects title="使用 MeshAgent 遠程桌面連接"onclick=connectFiles(event,2) onkeypress=return!1 onkeydown=return!1 disabled>SFTP 連接</button> <button type=button class="btn btn-primary btn-sm dropdown-toggle dropdown-toggle-split"id=p13Connectsdrop data-bs-toggle=dropdown aria-expanded=false><span class=visually-hidden>Toggle Dropdown</span></button><ul class=dropdown-menu><li><a class=dropdown-item onclick=cmsshportaction(1,event)>備用端口</a></ul></div><span id=p13Status>已斷線</span></div><div class="d-flex align-items-center ms-auto"><input id=filesActionsBtn class="btn btn-primary me-1 btn-sm"type=button title=在裝置上執行電源操作 value=動作 onclick=deviceActionFunction()><div id=filesRecordIcon class=deskareaicon title=伺服器正在記錄此節 style=display:none;background-color:red;width:12px;height:12px;border-radius:6px;margin-top:5px;margin-left:5px></div><div id=filesCustomUpperRight style=float:left;margin-right:6px></div><div id=filesCustomUiButtons style=float:left></div></div><tr><td class="areaHead2 d-flex align-items-center flex-wrap"valign=bottom><div id=p13rightOfButtons class="toright2 d-flex align-items-center"></div><div class="d-flex align-items-center"><input type=button disabled id=p13FolderUp class="btn btn-primary me-1 btn-sm"value=上 onclick=p13folderup()> <input type=button disabled id=p13SelectAllButton class="btn btn-primary me-1 btn-sm"value=全選 onclick=p13selectallfile()> <input type=button disabled id=p13RenameFileButton class="btn btn-primary me-1 btn-sm"value=改名 onclick=p13renamefile()> <input type=button disabled id=p13DeleteFileButton class="btn btn-primary me-1 btn-sm"value=刪除 onclick=p13deletefile()> <input type=button disabled id=p13ViewFileButton class="btn btn-primary me-1 btn-sm"value=編輯 onclick=p13viewfile()> <input type=button disabled id=p13NewFolderButton class="btn btn-primary me-1 btn-sm"value=新建檔案夾 onclick=p13createfolder()> <input type=button disabled id=p13UploadButton class="btn btn-primary me-1 btn-sm"value=上載 onclick=p13uploadFile()> <input type=button disabled id=p13DownloadButton class="btn btn-primary me-1 btn-sm"value=下載 onclick=p13downloadButton()> <input type=button disabled id=p13CutButton class="btn btn-primary me-1 btn-sm"value=切 onclick=p13copyFile(1)> <input type=button disabled id=p13CopyButton class="btn btn-primary me-1 btn-sm"value=複製 onclick=p13copyFile(0)> <input type=button disabled id=p13PasteButton class="btn btn-primary me-1 btn-sm"value=糊 onclick=p13pasteFile()> <input type=button disabled id=p13ZipButton class="btn btn-primary me-1 btn-sm"value=Zip onclick=p13zipFiles()> <input type=button disabled id=p13UnzipButton class="btn btn-primary me-1 btn-sm"value=Unzip onclick=p13unzipFile()> <input type=button disabled id=p13RefreshButton class="btn btn-primary me-1 btn-sm"value=刷新 onclick=p13folderup(9999)> <input type=button disabled id=p13FindButton class="btn btn-primary me-1 btn-sm"value=找 onclick=p13findfile()> <input type=button disabled id=p13GoToFolderButton class="btn btn-primary me-1 btn-sm"value=GoTo onclick=p13gotofolder()> <input type=button disabled id=p13OpenButton class="btn btn-primary me-1 btn-sm"value=Open onclick=p13openfilefolder()></div><tr><td class=areaHead3><div class=toright2><select id=p13sizedropdown class="form-select-sm me-2"onchange=p13updateFiles()><option value=0 selected>Human Readable<option value=1 title=Bytes>Bytes<option value=10 title=KB>Kilobytes<option value=20 title=MB>Megabyte<option value=30 title=GB>Gigabyte</select> <select id=p13sortdropdown class="form-select-sm me-2"onchange=p13updateFiles()><option value=1 selected>按名稱排序<option value=2>按大小排序<option value=3>按日期排序<option value=4>按名稱降序<option value=5>按大小降序<option value=6>按日期降序</select></div><div>&nbsp;&nbsp;<span id=p13currentpath></span></div></table><div id=p13FilesConsoleMsg style=display:none;text-align:left;cursor:pointer;position:absolute;left:30px;top:165px;color:#ff0;background-color:rgba(0,0,0,.6);padding:10px;border-radius:5px onclick=p13clearConsoleMsg()></div><div id=p13filetable><div id=p13bigok style=display:none><b>✓</b></div><div id=p13bigfail style=display:none><b>✗</b></div><span id=p13files></span></div><table id=p13toolbarBottom cellpadding=0 cellspacing=0><tr><td class=style6>&nbsp;<span id=p13bottomstatus></span></table></div><div id=p14 style=display:none><div id=p14title class="d-flex align-items-center"><div id=p14BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold"><span id=p14deviceNamePrefix>Intel® AMT</span> - <span id=p14deviceName></span></div><div id=devListToolbarViewIcons class=ms-auto><i class="fa-solid fa-xl fa-maximize fa-border"role=button onclick=deskToggleFull(event) title=全屏。按住Shift鍵更改為全屏瀏覽器。></i></div></div><iframe id=p14iframe src={{{domainurl}}}commander.ashx></iframe></div><div id=p15 style=display:none><div id=p15title class="d-flex align-items-center"><div id=p15BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold"><span id=p15deviceName></span></div></div><table id=consoleTable cellpadding=0 cellspacing=0><tr><td class="areaHead d-flex flex-wrap"><div id=p15statetext class="d-flex align-items-center"></div><div class="d-flex align-items-center ms-auto"><div id=p15coreName class=me-1 title=有關在此代理上運行的當前核心的訊息></div><input type=button id=p15uploadCore class="btn btn-primary me-1 btn-sm"value=代理指令 onclick=p15uploadCore(event) title=更改代理的Java腳本代碼模塊> <i onclick=p15downloadConsoleText() title=下載控制台文字 class="fa-solid fa-download me-1"></i></div><tr><td><div class=areaProgress><div id=consoleprogressbar></div></div><tr><td id=p15agentConsole><pre id=p15agentConsoleText></pre><tr><td class=areaFoot><table style=width:100%><tr><td style=width:99%><input id=p15consoleText class=form-control onkeyup=p15consoleSend(event) onfocus=onConsoleFocus(1) onblur=onConsoleFocus(0)><td>&nbsp;<td id=p15outputselecttd><select id=p15outputselect onchange=setupConsole()><option id=p15outputselect1 value=1>代理<option id=p15outputselect3 value=3>推<option id=p15outputselect2 value=2>MQTT</select><td style=width:1%><input id=id_p15consoleClear type=button class="btn btn-primary bottombutton"value=清除 onclick=p15consoleClear()></table></table></div><div id=p16 style=display:none><div id=p16title class="d-flex align-items-center"><div id=p16BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold">事件- <span id=p16deviceName></span></div></div><table class=pTable><tr><td class="auto-style1 d-flex justify-content-end p-1"><div class="d-flex align-items-center"><label class=me-1 for=p16filterevents>過濾</label> <select id=p16filterevents class="form-control-sm me-2"onchange=refreshDeviceEvents()><option notransval=1 value="">All Logs<option notransval=1 value=agentlog>Agent Logs<option notransval=1 value=relaylog>Relay Logs<option notransval=1 value=manual>Manual Logs<option notransval=1 value=runcommands>Run Command Logs<option notransval=1 value=batchupload>Batch Upload Logs<option notransval=1 value=changenode>Change Node Logs<option notransval=1 value=removenode>Remove Node Logs</select> <label class=me-1 for=p16limitdropdown>顯示</label> <select id=p16limitdropdown class="form-control-sm me-2"onchange=refreshDeviceEvents()><option notransval=1 value=60>最後60<option notransval=1 value=120>最後120<option notransval=1 value=250>最後250<option notransval=1 value=500>最後500<option notransval=1 value=1000>最後1000</select> <i onclick=p3showDownloadEventsDialog(1) class="fa-solid fa-download"title=下載事件 style=cursor:pointer></i></div></table><div id=p16events></div></div><div id=p17 style=display:none><div id=p17title class="d-flex align-items-center"><div id=p17BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold">細節 - <span id=p17deviceName></span></div><div id=devListToolbarViewIcons3 class=ms-auto><i class="fa-solid fa-chart-line fa-xl fa-border"role=button onclick=deskToggleCpuGraph(event) title=顯示設備的CPU和內存使用情況。></i></div></div><div id=p17info class="ps-0 pb-5 overflow-y-auto container-fluid"><div id=p17graph style=width:100%><table style=width:100%><tr><td style=width:64px;vertical-align:top><img src=images/details/graph64.png border=0 width=64><td><div class=DevSt style=margin-bottom:3px;margin-left:16px><b>實時圖表</b></div><div style="margin-bottom:10px;margin-left:16px;height:240px;width:calc(100% - 16px);position:relative"><canvas id=deviceDetailsStats style=position:absolute;top:0;left:0;right:0;bottom:0></canvas></div><div id=extraGraphValues style=display:none;margin-left:30px;margin-bottom:15px></div></table></div><div id=p17info2></div></div></div><div id=p19 style=display:none><div id=p19title><div id=p19BackButton style=float:left><div class=backButton tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'><div class=backButtonEx></div></div></div><h1>外掛- <span id=p19deviceName></span></h1></div><div id=p19headers></div><div id=p19pages></div></div><div id=p20 style=display:none><div id=p20main style=overflow-y:auto><div id=p20title class="d-flex align-items-center"><div id=p20BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold">一般 - <span id=p20meshName></span></div></div><picture id=MainMeshImage style=border-width:0;height:200px;width:200px;float:right><source type=image/webp width=200 height=200 srcset=images/webp/mesh-256.webp><img alt=""width=200 height=200 src=images/mesh-256.png></picture><p id=p20info><p id=p20info2></div></div><div id=p21 style=display:none><div id=p21title class="d-flex align-items-center"><div id=p21BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold">摘要- <span id=p21meshName></span></div></div><div id=p21main style=overflow-y:auto><div style=width:100%><div style=display:table;width:93%><div id=meshPowerChartDiv style=width:23%;display:inline-block;text-align:center;max-width:250px><div style=margin:10px;font-size:16px>電源狀態</div><canvas id=meshPowerChart style=width:250px;height:250px></canvas></div><div id=meshOsChartDiv style=width:23%;display:inline-block;text-align:center;max-width:250px><div style=margin:10px;font-size:16px>代理類型</div><canvas id=meshOsChart style=width:250px;height:250px></canvas></div><div id=meshConnChartDiv style=width:23%;display:inline-block;text-align:center;max-width:250px><div style=margin:10px;font-size:16px>連接性</div><canvas id=meshConnChart style=width:250px;height:250px></canvas></div><div id=meshSecurityChartDiv style=width:23%;display:inline-block;text-align:center;max-width:250px><div style=margin:10px;font-size:16px>安全</div><canvas id=meshSecurityChart style=width:250px;height:250px></canvas></div></div></div><p id=p21info style=overflow-y:auto></div></div><div id=p30 style=display:none><div id=p30title class="d-flex align-items-center"><div id=p30BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold">一般 - <span id=p30userName></span></div></div><div id=p30info style=overflow-y:auto><div class=row><div class=col><div id=p30html></div></div><div class=col-auto style=width:20px></div><div class=col-auto style=width:200px;position:relative><img id=p30userAuthServiceLogo loading=lazy style=display:none class=userAuthStrategyLogo width=64 height=64><picture id=MainUserImage style=display:none;border-width:0;height:200px;width:200px;float:right onclick=account_manageImage(1)><source type=image/webp width=200 height=200 srcset=images/webp/user-256.webp><img alt=""width=200 height=200 src=images/user-256.png></picture><img id=MainUserImageEx alt=""width=200 height=200 src=images/user-256.png onclick=account_manageImage(1)><div style=width:100%;text-align:center><strong><span id=MainUserState></span></strong></div></div></div><br><div id=p30html2></div><div id=p30html3></div></div></div><div id=p31 style=display:none><div id=p31title class="d-flex align-items-center"><div id=p31BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold">事件- <span id=p31userName></span></div></div>{{!-- --}} {{!-- --}}<table class=pTable><tr><td class=h1><td class="auto-style1 d-flex justify-content-end p-1"><div class="d-flex align-items-center"><label for=p31filterevents class=me-1>過濾</label> <select id=p31filterevents class="form-select-sm me-2"onchange=refreshUsersEvents()><option notransval=1 value="">All Logs<option notransval=1 value=agentlog>Agent Logs<option notransval=1 value=relaylog>Relay Logs<option notransval=1 value=manual>Manual Logs<option notransval=1 value=runcommands>Run Command Logs<option notransval=1 value=batchupload>Batch Upload Logs<option notransval=1 value=changenode>Change Node Logs<option notransval=1 value=removenode>Remove Node Logs</select> <label for=p31limitdropdown class=me-1>顯示</label> <select id=p31limitdropdown class="form-select-sm me-2"onchange=refreshUsersEvents()><option notransval=1 value=60>最後60<option notransval=1 value=120>最後120<option notransval=1 value=250>最後250<option notransval=1 value=500>最後500<option notransval=1 value=1000>最後1000<option notransval=1 value="">沒有限制</select> <a href=# onclick=p3showDownloadEventsDialog(3)><i class="fa-solid fa-download"role=button title=下載事件></i></a></div><td class=h2></table><div id=p31events></div></div><div id=p40 style=display:none><div id=p40title><h1>我的伺服器統計</h1></div><div class="areaHead d-flex align-items-center flex-wrap p-1"><div class="d-flex align-items-center"><input value=刷新 type=button class="btn btn-primary btn-sm me-2"onclick=refreshServerTimelineStats()><div class=form-check><input class="form-check-input me-1"type=checkbox id=p40log onclick=updateServerTimelineHours()><label class=form-check-label for=p40log>Log-X</label></div></div><div class="toright2 d-flex align-items-center ms-auto"><select id=p40server style=display:none onchange=updateServerTimelineStats()></select> <select id=p40type class="form-select-sm me-1"onchange=updateServerTimelineStats()><option value=0>連接<option value=1>記憶體<option value=5>CPU<option value=3>入站流量<option value=4>出站流量</select> <select id=p40time class="form-select-sm me-1"onchange=updateServerTimelineHours()><option value=3>過去3小時<option value=8>過去8小時<option value=24>最後一天<option value=168>上個星期<option value=720>過去30天</select> <i class="fa-solid fa-download"title=下載數據點（.csv） style=cursor:pointer onclick=p40downloadEvents()></i></div></div><canvas id=serverMainStats></canvas></div><div id=p41 style=display:none><div id=p41title><h1>我的伺服器追蹤</h1></div><div class="areaHead d-flex align-items-center flex-wrap p-1"><div class="d-flex align-items-center"><input value=追踪中 type=button class="btn btn-primary btn-sm me-1"onclick=setServerTracing()> <span id=p41traceStatus>沒有</span></div><div class="toright2 d-flex align-items-center ms-auto"><label for=p41limitdropdown class=me-1>顯示</label> <select id=p41limitdropdown class="form-select-sm me-1"onchange=displayServerTrace()><option value=100>最後100<option value=250>最後250<option value=500>最後500<option value=1000>最後1000</select> <input value=清除 type=button class="btn btn-primary btn-sm me-1"onclick=clearServerTracing()> <i class="fa-solid fa-download"title=下載追蹤（.csv） style=cursor:pointer onclick=p41downloadServerTrace()></i></div></div><div id=p41events></div></div><div id=p42 style=display:none><h1>我的伺服器外掛</h1><div class=areaHead><div class=toright2></div><div><input value=下載外掛 type=button onclick="return pluginHandler.addPluginDlg()"></div></div><div id=pluginRestartNotice class=areaHead style=background-color:gold;display:none><div class=toright2><input value=刷新代理核心 type=button onclick="return distributeCore(),!1"></div><div style=padding:2px><div style=padding:2px><b>注意：</b> 外掛已更改，這可能需要更新代理核心。</div></div></div><table id=p42tbl><tr class=DevSt><th style=width:26px><th style=width:10px><th class=chName>名稱<th class=chDescription>描述<th class=chSite style=text-align:center>鏈結<th class=chVersion style=text-align:center>版<th class=chUpgradeAvail style=text-align:center>最新<th class=chStatus style=text-align:center>狀態<th class=chAction style=text-align:center>指令<th style=width:10px></table><div id=pluginNoneNotice style=width:100%;text-align:center;padding-top:10px;display:none><i>伺服器上沒有外掛。</i></div></div><div id=p43 style=display:none><div id=p43BackButton><div class=backButton tabindex=0 onmouseup=go(42) title=返回 onkeypress='"Enter"==event.key&&go(42)'><div class=backButtonEx></div></div></div><h1>我的伺服器外掛- <span id=p43title></span></h1><iframe id=p43iframe frameborder=0 style="width:100%;height:calc(100vh - 245px);max-height:calc(100vh - 245px)"></iframe></div><div id=p50 style=display:none><div id=p50title><h1>我的用戶群</h1></div><table class=pTable><tr><td class="style14 d-flex align-items-center flex-wrap p-1"><div id=p50userGroupOps class="d-flex align-items-center"><input type=button id=UsersGroupsSelectAllButton class="btn btn-primary btn-sm me-1"onclick=p50usersSelectallButtonFunction() value=全選> <input type=button id=UsersGroupsGroupActionButton class="btn btn-primary btn-sm me-1"disabled value=集體指令 onclick=p50usersGroupActionFunction()> <input id=NewUserGroupButton type=button class="btn btn-primary btn-sm me-1"onclick=showCreateUserGroupDialog(1) value=新群...> <input id=DuplicateUserGroupButton type=button class="btn btn-primary btn-sm me-1"style=display:none onclick=showCreateUserGroupDialog(2) value=複製群組...></div></table><div id=p50groups></div></div><div id=p51 style=display:none><div id=p51title class="d-flex align-items-center"><div id=p51BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold">用戶群- <span id=p51groupName></span></div></div><div id=p51info style=overflow-y:auto><div class=row><div class=col><div id=p51group></div></div><div class=col-auto style=width:20px></div><div class=col-auto style=width:200px><picture id=MainUserImage style=border-width:0;height:200px;width:200px;float:right><source type=image/webp width=200 height=200 srcset=images/webp/group-256.webp><img alt=""width=200 height=200 src=images/group-256.png></picture><div style=width:100%;text-align:center><strong><span id=MainUserState></span></strong></div></div></div><div id=p51group2></div><br></div></div><div id=p52 style=display:none><div id=p52title><h1>我的用戶記錄</h1></div><table class=pTable><tr><td class="style14 d-flex align-items-center flex-wrap p-1"><div class="d-flex align-items-center"><input type=button class="btn btn-primary btn-sm"onclick=refreshRecodings() value=刷新></div><div class="d-flex align-items-center ms-auto"><input type=button class="btn btn-primary btn-sm"onclick=openRecodringPlayer() value=打開播放器...></div></table><div id=p52recordings style=overflow-y:auto></div></div><div id=p60 style=display:none><div id=p60title><h1>我的報告</h1></div>{{!-- --}} {{!-- --}}<table class=pTable><tr><td class=h1><td class=style14><div style=float:right;line-height:22px><a id=p60downloadReportDiv style=display:none href=# onclick=p60downloadReport()><i class="fa-solid fa-download"title=下載報告></i></a>&nbsp;</div><div><button class="btn btn-primary btn-sm me-2 m-1"onclick=generateReportDialog()><i class="fa-regular fa-file-alt"></i> 生成報告...</button></div><td class=h2></table><div id=p60report style=overflow-y:auto></div></div><br id=column_l_bottomgap></div><div id=footer><div class=footer1>{{{footer}}}</div><div class=footer2 style=display:none><div class=row><div class="col-md-6 d-flex gap-2"></div><div class=col-md-6><a id=verifyEmailId2 style=display:none href=# onclick=account_showVerifyEmail()>驗證電郵</a> &nbsp;<a id=termsLinkFooter href=terms>條款和隱私</a></div></div></div></div><div class="modal fade"id=xxAddAgentModal tabindex=-1 aria-hidden=true><div class="modal-dialog modal-dialog-centered"id=xxAddAgentModalConf><div class=modal-content><div class=modal-header id=dialogHeader><h5 class="modal-title text-white"id=xxAddAgentTitle></h5><button type=button class=btn-close data-bs-dismiss=modal aria-label=Close></button></div><div class=modal-body id=xxAddAgentBody><div id=dialog1><div id=id_dialogMessage></div></div><div id=dialog2><div id=id_dialogOptions></div></div><div id=dialog3><div id=d3upload><div>檔案選擇</div><select id=d3uploadMode onchange=d3modechange()><option value=1>本地檔案上傳<option value=2>伺服器檔案選擇</select></div><div id=d3localmode style=display:none><div>上載檔案</div><form id=d3localmodeform method=post enctype=multipart/form-data action=uploadfile.ashx target=fileUploadFrame><input id=d3auth name=auth style=display:none> <input id=d3filter name=filter style=display:none> <input id=d3attrib name=attrib style=display:none> <input type=file id=d3localFile name=files onchange=d3setActions()> <input type=submit id=d3submit style=display:none></form></div><div id=d3servermode><div id=d3serveraction valign=bottom><input type=button id=p3FolderUp disabled onclick=d3folderup() value=上>&nbsp;<span id=p3CurrentFolder></span></div><div id=d3serverfiles></div></div></div><div id=dialog4><input id=d4WrapButton class="btn btn-primary me-1 mb-1"type=button value=換行 onclick=d4ToggleWrap()> <input id=d4SizeButton class="btn btn-primary me-1 mb-1"type=button value=小 onclick=d4ToggleSize()> <input id=d4EncodingButton class="btn btn-primary me-1 mb-1"type=button value=生的 onclick=d4ToggleEncoding()> <input id=d4LineBreakButton class="btn btn-primary me-1 mb-1"type=button value=視窗 onclick=d4ToggleLineBreak()> <textarea id=d4editorarea autocomplete=off style="height:calc(100vh - 286px);width:100%;overflow:scroll;resize:none;white-space:pre"></textarea></div><div id=dialog7><div class=dtab><button id=td7meshkvm class=tablinks onclick='changeDesktopSettingsTab(event,"d7meshkvm")'>代理</button> <button id=td7rdpkvm class=tablinks onclick='changeDesktopSettingsTab(event,"d7rdpkvm")'>RDP</button> <button id=td7amtkvm class=tablinks onclick='changeDesktopSettingsTab(event,"d7amtkvm")'>Intel® AMT</button></div><div id=d7meshkvm class=tabcontent><div style=margin-top:8px><div>品質</div><select id=d7bitmapquality dir=rtl></select></div><div><div>縮放比例</div><select id=d7bitmapscaling dir=rtl><option selected value=1024>100％<option value=896>87.5％<option value=768>75％<option value=640>62.5％<option value=512>50％<option value=384>37.5％<option value=256>25％<option value=128>12.5％</select></div><div><div>框速率</div><select id=d7framelimiter dir=rtl><option selected value=50>快速<option value=100>中<option value=400>慢<option value=1000>非常慢</select></div><div><div>編碼</div><select id=d7encoding dir=rtl><option value=1>JPEG<option value=2>PNG<option value=3>TIFF<option selected value=4>WEBP</select></div><div id=d7desktopOtherSettings><div>其他設定</div><div id=d7otherset2 style=display:block><label style=display:block><input type=checkbox id=d7deskSwapMouse>交換鼠標按鈕</label> <label style=display:block><input type=checkbox id=d7deskrmw>反向鼠標滾輪</label> <label style=display:block><input type=checkbox id=d7deskRemoteKeyMap>使用遠程鍵盤映射</label> <label style=display:block id=d7deskAutoClipboardLabel><input type=checkbox id=d7deskAutoClipboard>自動剪貼板</label> <label style=display:block id=d7deskAutoLockLabel><input type=checkbox id=d7deskAutoLock>斷開連接鎖定</label></div></div></div><div id=d7amtkvm class=tabcontent><div style=margin-top:8px><div>影像編碼</div><select id=d7desktopmode><option value=1>RLE8，最快<option value=2>RLE16，推薦<option value=3>RAW8，慢<option value=4>RAW16，非常慢</select></div><div><div>其他設定</div><div id=d7otherset style=display:block><label style=display:block><input type=checkbox id=d7showfocus>顯示焦點工具</label> <label style=display:block><input type=checkbox id=d7showcursor>顯示本地鼠標光標</label> <label style=display:block><input type=checkbox id=d7localKeyMap>本地鍵盤圖</label> <label style=display:block><input type=checkbox id=d7kvmrmw>反向鼠標滾輪</label></div></div></div><div id=d7rdpkvm class=tabcontent><div style=margin-top:8px><div>顯示屏尺寸</div><select id=d7rdpsize><option notransval=1 value=canvas>畫布的尺寸<option notransval=1 value=browser>瀏覽器大小<option notransval=1 value=screen>屏幕尺寸<option notransval=1 value=640x480>640x480<option notransval=1 value=1024x768>1024x768<option notransval=1 value=1280x800>1280x800<option notransval=1 value=1440x900>1440x900<option notransval=1 value=1600x900>1600x900<option notransval=1 value=1680x1050>1680x1050<option notransval=1 value=1920x1080>1920x1080</select></div><div><div>選項</div><div id=d7rdpflags style=display:block><label style=display:block><input type=checkbox id=d7rdp1>禁用壁紙</label> <label style=display:block><input type=checkbox id=d7rdp2>禁用全窗口拖動</label> <label style=display:block><input type=checkbox id=d7rdp3>禁用菜單動畫</label> <label style=display:block><input type=checkbox id=d7rdp4>禁用主題</label> <label style=display:block><input type=checkbox id=d7rdp6>禁用光標陰影</label> <label style=display:block><input type=checkbox id=d7rdp7>禁用光標設置</label> <label style=display:block><input type=checkbox id=d7rdp8>啟用字體 Smoothing</label> <label style=display:block><input type=checkbox id=d7rdp9>啟用桌面組合</label> <label style=display:block><input type=checkbox id=d7rdpclip>自動剪貼板</label> <label style=display:block><input type=checkbox id=d7rdpsmb>交換鼠標按鈕</label> <label style=display:block><input type=checkbox id=d7rdprmw>反向鼠標滾輪</label></div></div></div></div></div><div class=modal-footer><button type=button class="btn btn-primary"data-bs-dismiss=modal id=idx_dlgCancelButton>取消</button> <button type=button class="btn btn-outline-success"id=idx_dlgOkButton>OK</button> <button type=button class="btn btn-outline-danger"id=idx_dlgDeleteButton style=display:none>刪除</button></div></div></div></div><iframe name=fileUploadFrame style=display:none></iframe><form style=display:none method=post action=uploadfile.ashx enctype=multipart/form-data target=fileUploadFrame><input id=p5fileDragName name=name><input id=p5fileDragAuthCookie name=auth><input id=p5fileDragSize name=size><input id=p5fileDragType name=type><input id=p5fileDragData name=data><input id=p5fileDragLink name=link class="btn btn-outline-success"><input type=submit id=p5loginSubmit2 style=display:none class="btn btn-outline-success"></form><form style=display:none method=post action=uploadnodefile.ashx enctype=multipart/form-data target=fileUploadFrame><input id=p13fileDragName name=name class="btn btn-outline-success"><input id=p13fileDragSize name=size class="btn btn-outline-success"><input id=p13fileDragType name=type class="btn btn-outline-success"><input id=p13fileDragData name=data class="btn btn-outline-success"><input id=p13fileDragLink name=link class="btn btn-outline-success"><input type=submit id=p13loginSubmit2 style=display:none class="btn btn-outline-success"></form><div id=topMenu style="z-index:1000;background-color:#fff;box-shadow:0 0 15px #666;font-family:Arial,Helvetica,sans-serif;border-radius:0 0 5px 5px;position:fixed;top:50px;right:5px;width:170px;display:none"><div style="padding:12px;border-top:1px solid gray;color:#000;cursor:pointer"onclick=topMenu(1)>我的裝置</div><div style="padding:12px;border-top:1px solid gray;color:#000;cursor:pointer"onclick=topMenu(2)>我的帳戶</div><div style="padding:12px;border-top:1px solid gray;color:#000;cursor:pointer"onclick=topMenu(3)>我的事件</div><div style="padding:12px;border-top:1px solid gray;color:#000;cursor:pointer"onclick=topMenu(5)>我的檔案</div><div style="padding:12px;border-top:1px solid gray;color:#000;cursor:pointer"onclick=topMenu(4)>我的用戶</div><div style="padding:12px;border-top:1px solid gray;color:#000;cursor:pointer"onclick=topMenu(6)>我的伺服器</div><div id=logoutMenuOption><a id=logoutMenuOptionRef href=/logout><div style="padding:12px;border-top:1px solid gray;color:#000;cursor:pointer">登出</div></a></div></div><audio id=chimes><source src=sounds/chimes.mp3 type=audio/mp3></audio><iframe style=display:none name=fileDownloadFrame></iframe></div><script>var i,args,urlargs,random="{{{randomlength}}}",webState="{{{webstate}}}";for(i in webState=null!=(webState=""!=webState?JSON.parse(decodeURIComponent(webState)):webState)&&"object"==typeof webState?webState:{})if("desktopsettings"!=i)try{localStorage.setItem(i,webState[i])}catch(e){}if(!webState.loctag)try{localStorage.removeItem("loctag")}catch(e){}var desktop,terminal,files,autoReconnect=!0,powerStatetable=["","有電源","休眠","休眠","休眠","冬眠","關機","存在"],StatusStrs=["已斷線","正在連線...","設定...","已連接","Intel&reg; AMT已連接"],agentsStr=["未知","Windows 32位控制台","Windows 64位控制台","Windows 32位服務","Windows 64位服務","Linux 32位","Linux 64位","MIPS","XENx86","Android","Linux ARM","macOS x86-32位","安卓x86","PogoPlug ARM","Android","Linux Poky x86-32位","macOS x86-64位","ChromeOS","Linux Poky x86-64位","Linux NoKVM x86-32位","Linux NoKVM x86-64位","Windows MinCore控制台","Windows MinCore服務","NodeJS","ARM-Linaro","ARMv6l / ARMv7l","ARMv8 64位","ARMv6l / ARMv7l / NoKVM","MIPS24KC（OpenWRT）","蘋果矽","FreeBSD x86-64","未知","Linux ARM 64 bit (glibc/2.24 NOKVM)","Alpine Linux x86 64 Bit (MUSL)","助理（Windows）","Armada370 - ARM32/HF (libc/2.26)","OpenWRT x86-64","OpenBSD x86-64","未知","未知","MIPSEL24KC (OpenWRT)","ARMADA/CORTEX-A53/MUSL (OpenWRT)","Windows ARM 64bit console","Windows ARM 64bit service"],agentsStrNoAgent=["","","","","視窗","","Linux","","","","","","","","","","","","","","","","","","","","","","","蘋果"],sort=0,searchFocus=0,mapSearchFocus=0,userSearchFocus=0,consoleFocus=0,showRealNames=!1,meshserver=null,meshes={},loginTokens={},meshcount=0,nodes=null,usergroups=null,filetree={},userinfo=null,serverinfo=null,events=[],users=null,wssessions=null,stars={},nodeShortIdent=0,desktopsettings={encoding:2,showfocus:!1,showmouse:!0,showcad:!0,quality:40,scaling:1024,framerate:50,localkeymap:!1,swapmouse:!1,remotekeymap:!1,autoclipboard:!1,autolock:!1,agentencoding:4},multidesktopsettings={quality:20,scaling:128,framerate:1e3,agentencoding:4},debugLevel=parseInt("{{{debuglevel}}}"),features=parseInt("{{{features}}}"),features2=parseInt("{{{features2}}}"),sessionTime=parseInt("{{{sessiontime}}}"),webRelayPort=parseInt("{{{webRelayPort}}}"),webRelayDns="{{{webRelayDns}}}",hidePowerTimeline="{{{hidePowerTimeline}}}",showNotesPanel="{{{showNotesPanel}}}",sessionRefreshTimer=null,domain="{{{domain}}}",domainUrl="{{{domainurl}}}",authCookie="{{{authCookie}}}",authRelayCookie="{{{authRelayCookie}}}",logoutControls=JSON.parse(decodeURIComponent("{{{logoutControls}}}")),authCookieRenewTimer=null,multiDesktop={},serverPublicNamePort="{{{serverDnsName}}}:{{{serverPublicPort}}}",amtScanResults=null,debugmode=0,windowsBrowser=detectWindowsBrowser(),attemptWebRTC=0!=(128&features),webrtcconfiguration="{{{webrtcconfig}}}";if(""==webrtcconfiguration)webrtcconfiguration=null;else try{webrtcconfiguration=JSON.parse(decodeURIComponent(webrtcconfiguration))}catch(e){console.log('Invalid WebRTC config: "'+webrtcconfiguration+'".'),webrtcconfiguration=null}var passRequirements="{{{passRequirements}}}";""!=passRequirements&&(passRequirements=JSON.parse(decodeURIComponent(passRequirements)));var customui=""!=(customui="{{{customui}}}")?JSON.parse(decodeURIComponent(customui)):null,deskAspectRatio=0;try{deskAspectRatio=parseInt(getstore("deskAspectRatio","0"))}catch(e){}var uiMode=parseInt(getstore("uiMode",1)),webPageStackMenu=!1,webPageFullScreen=!0,nightMode=setNightMode(),footerBar="1"==getstore("footerBar","1"),sessionActivity=Date.now(),updateSessionTimer=null,pluginHandlerBuilder={{{pluginHandler}}},pluginHandler=null,installedPluginList=(null!=pluginHandlerBuilder&&(pluginHandler=new pluginHandlerBuilder),null),goBackStack=[],CollapsedGroups={};try{CollapsedGroups=JSON.parse(getstore("_collapse","{}"))}catch(e){}var deviceViewSettings={};try{deviceViewSettings=JSON.parse(getstore("_deviceViewSettings","{}"))}catch(e){}var userViewSettings={};try{userViewSettings=JSON.parse(getstore("_usersViewSettings","{}"))}catch(e){}var xterm=null,xtermfit=null,xtermResizeTimer=null,miscState={},checkedNodeids={},deskKeyboardShortcuts=[],deskKeyboardStrings=[],deskLastClipboardSent=null,requestedLastConnects=!1,devicePagingState=null,p11DeskConsoleMsgTimer=null,p12TermConsoleMsgTimer=null,p13FilesConsoleMsgTimer=null,webpSupport=!1;function startup(){if(0==(32&features)){var e=null;try{e=top.location.toString().toLowerCase()}catch(e){}if(top!=self&&(null==e||0==top.active))return void(top.location=self.location)}null!=(urlargs=parseUriArgs()).key&&(urlargs.key=""+urlargs.key),urlargs.key&&0==isAlphaNumeric(urlargs.key)&&delete urlargs.key,urlargs.locale&&0==isAlphaNumeric(urlargs.locale)&&delete urlargs.locale,delete urlargs.user,delete urlargs.pass,delete urlargs.viewmode,delete urlargs.gotonode,delete urlargs.gotodevicename,delete urlargs.gotodeviceip,delete urlargs.gotomesh,delete urlargs.gotouser,delete urlargs.gotougrp,urlargs.key&&(Q("termsLinkFooter").href+="?key="+urlargs.key),(args=parseUriArgs()).key&&0==isAlphaNumeric(args.key)&&delete args.key,args.locale&&0==isAlphaNumeric(args.locale)&&delete args.locale,args.locale||null!=(o=getstore("loctag",0))&&"*"!=o&&(args.locale=o),debugmode=args.debug,null!=args.webrtc&&(attemptWebRTC=1==args.webrtc),QV("p13AutoConnect",debugmode),QV("autoconnectbutton2",debugmode),QV("autoconnectbutton1",debugmode),nightMode&&(document.documentElement.setAttribute("data-bs-theme","dark"),QC("body").add("night"),QS("body")["background-color"]="#000"),toggleFullScreen();try{stars=JSON.parse(getstore("stars","{}"))}catch(e){}var e=0,t=parseInt("{{{hide}}}"),t=((t||args.hide)&&(args.hide&&(e=parseInt(args.hide)),t)&&(e|=t),args.hide=e,QV("uiViewButton5",!(4&args.hide)),adjustPanels(),"");logoutControls&&(null!=logoutControls.name&&(t='<span onmouseup=go(2) CLASS="LogoffLinkColor" style="cursor:pointer">'+format("歡迎{0}。",logoutControls.name)+"</span>"),null!=logoutControls.logoutUrl)&&(t+=format(' <a href="'+logoutControls.logoutUrl+'" CLASS="LogoffLinkColor">登出</a>')),1&args.hide?QH("logoutControlSpan2",t):QH("logoutControlSpan",t),document.onclick=function(e){hideContextMenu()},document.onkeypress=ondockeypress,document.onkeydown=ondockeydown,document.onkeyup=ondockeyup,window.addEventListener("blur",ondocblur,!1),window.onresize=function(){hideContextMenu(),mainUpdate(512),browserfullscreen=isBrowserFullscreen(),QV("DeskESC",browserfullscreen),null!=xtermfit&&12==xxcurrentView&&xtermfit.fit()},setTimeout(function(){urlargs.filter&&(Q("SearchInput").value=urlargs.filter,Q("KvmSearchInput").value=urlargs.filter),mainUpdate(512)},200),DOMPurify&&DOMPurify.addHook("afterSanitizeAttributes",function(e){"target"in e&&(e.setAttribute("target","_blank"),e.setAttribute("rel","noopener noreferrer")),e.hasAttribute("target")||!e.hasAttribute("xlink:href")&&!e.hasAttribute("href")||e.setAttribute("xlink:show","new")}),QV("textnewui",0!=(1073741824&features2)),(meshserver=MeshServerCreateControl(domainUrl)).onStateChanged=onStateChanged,meshserver.onMessage=onMessage,meshserver.trace=args.trace,meshserver.Start(),Q("sortselect").selectedIndex=sort=getstore("sort",0),Q("sizeselect").selectedIndex=getstore("viewsize",1),Q("KvmSearchInput").value=Q("SearchInput").value=getstore("_search",""),showRealNames=1==getstore("showRealNames",0),Q("RealNameCheckBox").checked=showRealNames,Q("DevFilterSelect").value=getstore("devFilterSelect",0),Q("viewselect").value=getstore("deviceView",1),Q("DeskControl").checked=1==getstore("DeskControl",1),QV("accountChangeEmailAddressSpan",0==(2097152&features)),mainUpdate(3);for(var n=1;n<5;n++)Q("devViewButton"+n).classList.remove("viewSelectorSel");Q("devViewButton"+Q("viewselect").value).classList.add("viewSelectorSel"),Q("p5filetable").addEventListener("drop",p5fileDragDrop,!1),Q("p5filetable").addEventListener("dragover",p5fileDragOver,!1),Q("p5filetable").addEventListener("dragleave",p5fileDragLeave,!1),Q("deskarea0").addEventListener("drop",p11fileDragDrop,!1),Q("deskarea0").addEventListener("dragover",p11fileDragOver,!1),Q("deskarea0").addEventListener("dragleave",p11fileDragLeave,!1),Q("p13filetable").addEventListener("drop",p13fileDragDrop,!1),Q("p13filetable").addEventListener("dragover",p13fileDragOver,!1),Q("p13filetable").addEventListener("dragleave",p13fileDragLeave,!1),setInterval(updateDeviceTimeline,12e4);e=null;try{e=localStorage.getItem("desktopsettings")}catch(e){}null!=e&&(desktopsettings=JSON.parse(e)),e=null;try{e=localStorage.getItem("multidesktopsettings")}catch(e){}null!=e&&(multidesktopsettings=JSON.parse(e)),applyDesktopSettings();for(var o="",i=1;i<27;i++)o+="<option value='"+i+"'>Ctrl-"+String.fromCharCode(64+i)+" ("+i+")</option>";QH("specialkeylist",o),setupGeneralServerStats(),setupServerTimelineStats(),userInterfaceSelectMenu(),setupMeshSummaryStats(),QV("p4UserBatchCreate",0==(524288&features)),d4EditWrapVal=Number(getstore("editorWrap",0)),d4EditSizeVal=Number(getstore("editorSize",0)),d4EditEncodingVal=Number(getstore("editorEncoding",0)),d4EditLineBreakVal=Number(getstore("editorLineBreak",0)),d4ToggleWrap(!0),d4ToggleSize(!0),d4ToggleEncoding(!0),d4ToggleLineBreak(!0),null!=pluginHandler&&pluginHandler.callHook("onWebUIStartupEnd"),-1==["en","ko","ja","zh-chs","zh-cht"].indexOf("{{{lang}}}")&&""!="{{{lang}}}".toLowerCase()&&QC("body").add("nonenglish");var s=document.getElementsByClassName("topbar_td");for(l in s)s[l].innerHTML&&(s[l].innerHTML=s[l].innerHTML.split(" ").join("&nbsp;"));if(null!=customui){if(customui.devicesbarbuttons){o="";for(l in customui.devicesbarbuttons){var a="one"==customui.devicesbarbuttons[l].selection||"many"==customui.devicesbarbuttons[l].selection?"disabled":"";o+='<input id="cui:'+l+'" type="button" value="'+customui.devicesbarbuttons[l].name+'" '+a+' onclick=customUIAction(event,"devicesbarbuttons") />'}QH("devsCustomUIBar",o)}if(customui.desktopbuttons){o="";for(l in customui.desktopbuttons)o+='<input id="cui:'+l+'" type="button" value="'+customui.desktopbuttons[l].name+'" style="float:left" onclick=customUIAction(event,"desktopbuttons") />';QH("desktopCustomUiButtons",o)}if(customui.terminalbuttons){o="";for(l in customui.terminalbuttons)o+='<input id="cui:'+l+'" type="button" value="'+customui.terminalbuttons[l].name+'" style="float:left" onclick=customUIAction(event,"terminalbuttons") />';QH("terminalCustomUiButtons",o)}if(customui.filesbuttons){o="";for(l in customui.filesbuttons)o+='<input id="cui:'+l+'" type="button" value="'+customui.filesbuttons[l].name+'" style="float:left" onclick=customUIAction(event,"filesbuttons") />';QH("filesCustomUiButtons",o)}}10<=sessionTime&&(sessionRefreshTimer=setTimeout(refreshCookieSession,Math.round(6e4*sessionTime*.8))),deskKeyboardShortcuts=[];var l,r=getstore("deskKeyShortcuts","0x0A002E,0x100000,0x100028,0x100026,0x10004C,0x10004D,0x11004D,0x100052,0x020073,0x080057,0x020009,0x100025,0x100027").split(",");for(l in r)""!=r[l]&&deskKeyboardShortcuts.push(parseInt(r[l]));updateDeskShortcutKeys();try{deskKeyboardStrings=JSON.parse(getstore("deskStrings","[]"))}catch(e){}updateDesktopStrings(),updateCollapseAllButton(),dialogBoxDrag(),urlargs.key&&(Q("p6backuplink").href+="?key="+urlargs.key),QV("uiViewButton4",0==(3145728&features2)),Q("DeskType").value=multiTranslate("[KeyboardTyping]|類型"),QV("ScrollToTopButton",0!=(134217728&features2))}function refreshCookieSession(){var e=null;try{e=new XDomainRequest}catch(e){}(e=e||new XMLHttpRequest).open("GET",window.location.origin+domainUrl+"refresh.ashx"),e.timeout=15e3,e.onload=function(){sessionRefreshTimer=setTimeout(refreshCookieSession,Math.round(6e4*sessionTime*.8))},e.onerror=e.ontimeout=function(){sessionRefreshTimer=null},e.send()}function customUIAction(e,t){e=e.srcElement.id;if(0!=e.startsWith("cui:")){var n=customui[t][e.substring(4)];if(null!=n){if("devicesbarbuttons"==t){for(var o=document.getElementsByClassName("DeviceCheckbox"),i=[],s=0;s<o.length;s++)!0===o[s].checked&&i.push(o[s].defaultValue.substring(6));if("string"==typeof n.action&&("event"==n.action&&meshserver.send({action:"uicustomevent",section:t,element:e.substring(4),selectedDevices:i,logmsg:n.logmsg}),n.action.startsWith("dialog:")&&showCustomUiDialog(n.action.substring(7),{section:t,element:e.substring(4),selectedDevices:i}),n.deselectdevices)){for(s=0;s<o.length;s++)o[s].checked=!1;checkedNodeids={},p1updateInfo()}}"devicebuttons"!=t&&"desktopbuttons"!=t&&"terminalbuttons"!=t&&"filesbuttons"!=t||(i=[currentNode._id],"string"==typeof n.action&&("event"==n.action&&meshserver.send({action:"uicustomevent",section:t,element:e.substring(4),selectedDevices:i,logmsg:n.logmsg}),n.action.startsWith("dialog:"))&&showCustomUiDialog(n.action.substring(7),{section:t,element:e.substring(4),selectedDevices:i}))}}}function showCustomUiDialog(e,t){if(null!=customui&&null!=customui.dialogs&&"object"==typeof customui.dialogs[e]){var n="",o=customui.dialogs[e];if("string"==typeof o.text&&(n+="<div style=margin-bottom:8px>"+o.text+"</div>"),"number"==typeof o.buttons&&o.buttons,"object"==typeof o.elements)for(var i in o.elements){var s=o.elements[i];if("text"==s.type&&(n+=addHtmlFormFloating(s.name,"<input id=cui:"+i+" class=form-control autocomplete=off />")),"textarea"==s.type&&(null==s.name?n+="<textarea id=cui:"+i+" style=width:356px;resize:none;height:100px autocomplete=off></textarea>":n+=addHtmlFormFloating(s.name,"<textarea id=cui:"+i+" style=width:230px;resize:none;height:100px autocomplete=off></textarea>")),"droplist"==s.type){var a,l="";for(a in s.options)l+='<option value="'+a+'">'+EscapeHtml(s.options[a])+"</option>";n+=addHtmlFormFloating(s.name,'<select id="cui:'+i+'" class=form-select autocomplete=off />'+l+"</select>")}}setModalContent("xxAddAgent",o.title,n),showModal("xxAddAgentModal","idx_dlgOkButton",{action:"uicustomevent",section:"dialogs",element:e,src:t,values:{},logmsg:o.logmsg})}}function showCustomUiDialogEx(e,t){if(1==e){var n=customui.dialogs[t.element];if("object"==typeof n.elements)for(var o in n.elements){var i=n.elements[o];"droplist"!=i.type&&"textarea"!=i.type&&"text"!=i.type||(t.values[o]=Q("cui:"+o).value)}if(meshserver.send(t),n.deselectdevices){for(var s=document.getElementsByClassName("DeviceCheckbox"),o=0;o<s.length;o++)s[o].checked=!1;checkedNodeids={},p1updateInfo()}}}function adjustPanels(){var e=args.hide,e=(0==footerBar&&(e|=4),QV("masthead",!(1&e)),QV("topbar",!(2&e)),QV("footer",!(4&e)),QV("p1title",!(8&e)),QV("p2title",!(8&e)),QV("p3title",!(8&e)),QV("p4title",!(8&e)),QV("p5title",!(8&e)),QV("p6title",!(8&e)),QV("p10title",!(8&e)),QV("p11title",!(8&e)),QV("p12title",!(8&e)),QV("p13title",!(8&e)),QV("p14title",!(8&e)),QV("p15title",!(8&e)),QV("p16title",!(8&e)),QV("p17title",!(8&e)),QV("p20title",!(8&e)),QV("p21title",!(8&e)),QV("p30title",!(8&e)),QV("p31title",!(8&e)),QV("p40title",!(8&e)),QV("p41title",!(8&e)),QV("p50title",!(8&e)),QV("p51title",!(8&e)),footerBar?QC("body").remove("nofooter"):QC("body").add("nofooter"),0!=args.hide&&(2==uiMode?(QS("container")["grid-template-rows"]=(1&e?"0":"66")+"px fit-content(48px) auto "+(4&e?"0":"45")+"px",QS("container")["-ms-grid-rows"]=(1&e?"0":"66")+"px fit-content(48px) auto "+(4&e?"0":"45")+"px"):(QS("container")["grid-template-rows"]=(1&e?"0":"66")+"px "+(2&e?"0":"24")+"px auto "+(4&e?"0":"45")+"px",QS("container")["-ms-grid-rows"]=(1&e?"0":"66")+"px "+(2&e?"0":"24")+"px auto "+(4&e?"0":"45")+"px")),(1&e?0:66)+(2&e?0:24)+(4&e?0:45)+(8&e?0:60)),t=1<uiMode?24:0,n=(QS("p2info").height="calc(100vh - "+(20+e+t)+"px)",QS("p2info")["max-height"]="calc(100vh - "+(20+e+t)+"px)",QS("p3users")["max-height"]="calc(100vh - "+(50+e)+"px)",QS("p50groups")["max-height"]="calc(100vh - "+(50+e)+"px)",QS("p3events").height="calc(100vh - "+(50+e)+"px)",QS("p5filetable").height="calc(100vh - "+(99+e)+"px)",QS("p13filetable").height="calc(100vh - "+(127+e+t)+"px)",QS("serverMainStats").height="calc(100vh - "+(50+e+t)+"px)",QS("serverMainStats")["max-height"]="calc(100vh - "+(50+e+t)+"px)",QS("xdevices")["max-height"]="calc(100vh - "+(46+e)+"px)",QS("xdevicesmap")["max-height"]="calc(100vh - "+(46+e)+"px)",QS("p15agentConsole").height="calc(100vh - "+(84+e+t)+"px)",QS("p15agentConsole")["max-height"]="calc(100vh - "+(84+e+t)+"px)",QS("p15agentConsoleText").height="calc(100vh - "+(81+e+t)+"px)",QS("p15agentConsoleText")["max-height"]="calc(100vh - "+(81+e+t)+"px)",!(0===args.xterm||null!=terminal&&null==xterm));fullscreen?(QS("deskarea3x").height=null,QS("deskarea3x")["max-height"]=null,QS("p14iframe").height=null,QS("p14iframe")["max-height"]=null,n&&(QS("termarea3x").height="calc(100vh - 55px)",QS("termarea3xdiv").height="calc(100vh - 55px)",QS("termarea3x")["max-width"]="calc(1px)")):(QS("deskarea3x").height="calc(100vh - "+(74+e+t)+"px)",QS("deskarea3x")["max-height"]="calc(100vh - "+(74+e+t)+"px)",QS("p14iframe").height="calc(100vh - "+(23+e+t)+"px)",QS("p14iframe")["max-height"]="calc(100vh - "+(23+e+t)+"px)",n&&(QS("termarea3x").height="calc(100vh - "+(74+e+t)+"px)",QS("termarea3xdiv").height="calc(100vh - "+(74+e+t)+"px)",QS("termarea3x")["max-width"]="calc(1px)")),QS("p43iframe").height="calc(100vh - "+(84+e)+"px)",QS("p43iframe")["max-height"]="calc(100vh - "+(84+e)+"px)",QS("p6info").height="calc(100vh - "+(e-50+t)+"px)",QS("p6info")["max-height"]="calc(100vh - "+(e-50+t)+"px)",QS("p10info").height="calc(100vh - "+(20+e+t)+"px)",QS("p10info")["max-height"]="calc(100vh - "+(20+e+t)+"px)",QS("p17info").height="calc(100vh - "+(20+e+t)+"px)",QS("p17info")["max-height"]="calc(100vh - "+(20+e+t)+"px)",QS("p20main").height="calc(100vh - "+(e-50+t)+"px)",QS("p20main")["max-height"]="calc(100vh - "+(e-50+t)+"px)",QS("p21main").height="calc(100vh - "+(20+e+t)+"px)",QS("p21main")["max-height"]="calc(100vh - "+(20+e+t)+"px)",QS("p30info").height="calc(100vh - "+(20+e+t)+"px)",QS("p30info")["max-height"]="calc(100vh - "+(20+e+t)+"px)",QS("p51info").height="calc(100vh - "+(20+e+t)+"px)",QS("p51info")["max-height"]="calc(100vh - "+(20+e+t)+"px)",QS("p16events").height="calc(100vh - "+(50+e+t)+"px)",QS("p16events")["max-height"]="calc(100vh - "+(50+e+t)+"px)",QS("p31events").height="calc(100vh - "+(50+e+t)+"px)",QS("p31events")["max-height"]="calc(100vh - "+(50+e+t)+"px)",QS("p41events").height="calc(100vh - "+(48+e+t)+"px)",QS("p41events")["max-height"]="calc(100vh - "+(48+e+t)+"px)",QS("p52recordings").height="calc(100vh - "+(48+e+t)+"px)",QS("p52recordings")["max-height"]="calc(100vh - "+(48+e+t)+"px)",QS("p60report").height="calc(100vh - "+(48+e+t)+"px)",QS("p60report")["max-height"]="calc(100vh - "+(48+e+t)+"px)",(32&args.hide||""!="{{currentNode}}".toLowerCase())&&(QV("p10BackButton",!1),QV("p11BackButton",!1),QV("p12BackButton",!1),QV("p13BackButton",!1),QV("p14BackButton",!1),QV("p15BackButton",!1),QV("p16BackButton",!1),QV("p17BackButton",!1)),p1updateInfo()}function toggleAspectRatio(e){1===e&&putstore("deskAspectRatio",deskAspectRatio=(deskAspectRatio+1)%3),deskAdjust()}function toggleStackMenu(e){1==webPageFullScreen&&(1===e&&putstore("webPageStackMenu",webPageStackMenu=!webPageStackMenu),0==webPageStackMenu?QC("body").remove("menu_stack"):(QC("body").add("menu_stack"),10<=xxcurrentView&&QC("column_l").remove("room4submenu")),deskAdjust())}function showUserInterfaceSelectMenu(){if(!xxdialogMode){Q("uiViewButton1").classList.remove("uiSelectorSel"),Q("uiViewButton2").classList.remove("uiSelectorSel"),Q("uiViewButton3").classList.remove("uiSelectorSel"),Q("uiViewButton4").classList.remove("uiSelectorSel"),Q("uiViewButton5").classList.remove("uiSelectorSel");try{Q("uiViewButton"+uiMode).classList.add("uiSelectorSel")}catch(e){}QV("uiMenu","none"==QS("uiMenu").display),nightMode&&Q("uiViewButton4").classList.add("uiSelectorSel"),footerBar&&Q("uiViewButton5").classList.add("uiSelectorSel")}}function userInterfaceSelectMenu(e){e&&putstore("uiMode",uiMode=e),webPageFullScreen=uiMode<3,webPageStackMenu=1<uiMode,toggleFullScreen(0),toggleStackMenu(0),webPageStackMenu&&10<=xxcurrentView?QC("column_l").add("room4submenu"):QC("column_l").remove("room4submenu"),adjustPanels()}function toggleNightMode(){var e;xxdialogMode||(e=getstore("nightMode","0"),xxdialogButtons=3,setModalContent("xxAddAgent","夜間模式","<input type=radio id=night0 name=nightmoderadio value=0 "+(0==e?"checked":"")+"><label for=night0>瀏覽器默認</label><br>"+("<input type=radio id=night2 name=nightmoderadio value=2 "+(2==e?"checked":"")+"><label for=night2>燈光模式</label><br>")+("<input type=radio id=night1 name=nightmoderadio value=1 "+(1==e?"checked":"")+"><label for=night1>黑暗模式</label><br>")),showModal("xxAddAgentModal","idx_dlgOkButton",toggleNightModeEx),QV("uiMenu",!1))}function toggleNightModeEx(){var e="0";Q("night1").checked&&(e="1"),putstore("nightMode",e=Q("night2").checked?"2":e),setNightMode()}function setNightMode(){var e=getstore("nightMode","0");return nightMode=!1,0!=(1048576&features2)&&(e="1"),"1"==(e=0!=(2097152&features2)?"2":e)?nightMode=!0:"0"==e&&window.matchMedia&&(nightMode=window.matchMedia("(prefers-color-scheme: dark)").matches),nightMode?(document.documentElement.setAttribute("data-bs-theme","dark"),QC("body").add("night"),QS("body")["background-color"]="#000"):(document.documentElement.setAttribute("data-bs-theme","light"),QC("body").remove("night"),QS("body")["background-color"]="#d3d9d6"),nightMode}function toggleFooterBarMode(){putstore("footerBar",(footerBar=!footerBar)?"1":"0"),QS("container")["grid-template-rows"]=null,QS("container")["-ms-grid-rows"]=null,adjustPanels()}function toggleFullScreen(e){var t=document.getElementById("page_leftbar");1===e&&putstore("webPageFullScreen",webPageFullScreen=!webPageFullScreen),0==webPageFullScreen?(QC("body").remove("menu_stack"),QC("body").remove("fullscreen"),QC("body").remove("arg_hide"),10<=xxcurrentView&&QC("column_l").add("room4submenu"),QV("UserDummyMenuSpan",!1),t.classList.add("d-none")):(QC("body").add("fullscreen"),16&args.hide&&QC("body").add("arg_hide"),QV("page_leftbar",!(16&args.hide)),QV("MainMenuSpan",!(16&args.hide)),10<=xxcurrentView&&QC("column_l").remove("room4submenu"),QV("UserDummyMenuSpan",xxcurrentView<10&&webPageFullScreen),t.classList.remove("d-none")),mainUpdate(512),QV("body",!0)}function saveUserInterfaceMode(){var e=3;Q("ui0").checked&&(e=2),getstore("uiViewMode",3)!=e&&(putstore("uiViewMode",e),(e=new URL(window.location.href)).searchParams.has("sitestyle")&&(e.searchParams.delete("sitestyle"),window.history.replaceState({},document.title,e.toString())),reload())}function toggleBootstrapUIMode(){var e,t;xxdialogMode||(t="<div class=form-check><input type=radio class=form-check-input id=ui0 name=uiradio value=2 "+(2==(e=getstore("uiViewMode",3))?"checked":"")+"><label class=form-check-label for=ui0>Classic</label></div>",setModalContent("xxAddAgent","User Interface",t+="<div class=form-check><input type=radio class=form-check-input id=ui1 name=uiradio value=3 "+(3==e?"checked":"")+"><label class=form-check-label for=ui1>Modern</label></div>"),showModal("xxAddAgentModal","idx_dlgOkButton",saveUserInterfaceMode),QV("uiMenu",!1))}function getNodeFromId(e){if(null!=nodes)for(var t in nodes)if(nodes[t]._id==e)return nodes[t];return null}function reload(){var e=window.location.href;(e=e.endsWith("/#")?e.substring(0,e.length-2):e).endsWith("#")&&(e=e.substring(0,e.length-1)),window.location.href=e}function onStateChanged(e,t,n,o){0==t?(setDialogMode(0),go(0),deviceShares=powerTimelineUpdate=powerTimelineNode=powerTimelineReq=powerTimeline=null,deleteAllNotifications(),hideContextMenu(),QV("verifyEmailId2",!1),QV("logoutControl",!1),"noauth"==o?QH("p0span","無法執行身份驗證"):"invalidorigin"==o?QH("p0span","Invalid origin in HTTP request"):(2==n?autoReconnect&&setTimeout(serverPoll,5e3):QH("p0span","無法連接網絡插座"),null!=authCookieRenewTimer&&(clearInterval(authCookieRenewTimer),authCookieRenewTimer=null))):2==t&&(meshserver.send({action:"usergroups"}),meshserver.send({action:"meshes"}),meshserver.send({action:"nodes",id:"{{currentNode}}",skip:null==devicePagingState?0:devicePagingState.skip}),meshserver.send({action:"loginTokens"}),null!=pluginHandler&&meshserver.send({action:"plugins"}),""=="{{currentNode}}".toLowerCase()&&meshserver.send({action:"files"}),""=="{{viewmode}}".toLowerCase()&&go(1),authCookieRenewTimer=setInterval(function(){meshserver.send({action:"authcookie"})},18e5),40==xxcurrentView)&&refreshServerTimelineStats()}function serverPoll(){var e=null;try{e=new XDomainRequest}catch(e){}(e=e||new XMLHttpRequest).open("HEAD",window.location.href),e.timeout=15e3,e.onload=function(){e.status<500?reload():setTimeout(serverPoll,1e4)},e.onerror=e.ontimeout=function(){setTimeout(serverPoll,1e4)},e.send()}function detectWindowsBrowser(){var e=window.navigator.userAgent.toUpperCase();return 0<=e.indexOf("WINDOWS")||0<=e.indexOf("WIN32")||0<=e.indexOf("WIN64")}function updateSiteAdmin(){var e=parseInt("{{{serverfeatures}}}"),t=userinfo.siteadmin,n=4294967295!=t&&0!=(1024&t)||0!=(256&features2);QV("p2AccountSecurity",0==(4&features)&&0==serverinfo.domainauth&&0!=(4096&features)&&0==n),QV("p2AccountActions",!n),QV("managePhoneNumber1",33554432&features&&67108864&features&&1!=serverinfo.lock2factor),QV("managePhoneNumber2",33554432&features&&!(67108864&features)&&1!=serverinfo.lock2factor),QV("manageMessaging1",33554432&features2&&67108864&features2&&1!=serverinfo.lock2factor),QV("manageMessaging2",33554432&features2&&!(67108864&features2)&&1!=serverinfo.lock2factor),QV("manageEmail2FA",8388608&features&&1!=serverinfo.lock2factor),QV("p2AccountPassActions",0==(4&features)&&0==serverinfo.domainauth&&null!=userinfo&&0==userinfo._id.split("/")[2].startsWith("~")),QV("accountCreateLoginTokenSpan",128&features2),QV("p2AccountImageFrame",!n),QV("p2ServerActions",21&t&&0!=(143&e)),QV("LeftMenuMyServer",21&t&&0!=(64&e)),QV("MainMenuMyServer",21&t),QV("p2ServerActionsBackup",1&t&&0!=(1&e)),QV("p2ServerActionsRestore",4&t&&0!=(2&e)),QV("p2ServerActionsVersion",16&t&&0!=(4&e)),QV("p2ServerActionsErrors",16&t&&0!=(8&e)),QV("p2ServerActionsConfig",16&t&&0!=(128&e)),QV("MainMenuMyFiles",8&t),QV("LeftMenuMyFiles",8&t),0==(8&t)&&5==xxcurrentView&&(setDialogMode(0),go(1)),null!=currentNode&&gotoDevice(currentNode._id,xxcurrentView,!0),null!=userinfo.flags&&1&userinfo.flags?(null==userinfo.accountImageRnd&&(userinfo.accountImageRnd=Math.floor(9999999999*Math.random())),Q("p2AccountImage").src="userimage.ashx?rnd="+userinfo.accountImageRnd):Q("p2AccountImage").src="images/user-256.png",0!=(2&userinfo.siteadmin)?(null==users&&meshserver.send({action:"users"}),null==wssessions&&meshserver.send({action:"wssessioncount"}),mainUpdate(24576)):(wssessions=users=null,mainUpdate(16384),(4==xxcurrentView||30<=xxcurrentView&&xxcurrentView<40)&&(setDialogMode(0),go(1),currentUser=null)),meshserver.send({action:"events",limit:parseInt(p3limitdropdown.value)}),QV("ServerConsole",4294967295===userinfo.siteadmin&&0!=(16&e)),QV("ServerTrace",4294967295===userinfo.siteadmin&&0!=(32&e)),115==xxcurrentView&&4294967295!=userinfo.siteadmin&&go(6),6==xxcurrentView&&0==(21&userinfo.siteadmin)&&go(1),0!=(21&t)&&meshserver.send({action:"serverstats",interval:1e4})}check_webp_feature("lossy",function(e,t){(webpSupport=t)||(d7encoding.options[1].disabled=!0,d7encoding.value=1)}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",setNightMode);var updateNaggleTimer=null,updateNaggleFlags=0;function mainUpdate(e){updateNaggleFlags|=e,null==updateNaggleTimer&&(updateNaggleTimer=setTimeout(function(){512&updateNaggleFlags&&center(),1&updateNaggleFlags&&onSearchInputChanged(),2&updateNaggleFlags&&onSortSelectChange(!1),128&updateNaggleFlags&&updateMeshes(),4&updateNaggleFlags&&(updateDevices(),updateDeviceDetails(),21==xxcurrentView)&&p21updateMesh(),8&updateNaggleFlags&&drawNotifications(),16&updateNaggleFlags&&32768&features&&updateMapMarkers(),32&updateNaggleFlags&&eventsUpdate(),64&updateNaggleFlags&&32768&features&&refreshMap(!1,!0),256&updateNaggleFlags&&drawDeviceTimeline(),1024&updateNaggleFlags&&deviceEventsUpdate(),2048&updateNaggleFlags&&userEventsUpdate(),4096&updateNaggleFlags&&p20updateMesh(),8192&updateNaggleFlags&&updateUserGroups(),16384&updateNaggleFlags&&updateUsers(),32768&updateNaggleFlags&&updateRecordings(),65536&updateNaggleFlags&&updateLoginTokens(),updateNaggleTimer=null,updateNaggleFlags=0,gotoStartViewPage()},150))}function count2factoraAuths(){var e;return null==userinfo?-1:(e=0,1==userinfo.otpsecret&&e++,0<userinfo.otphkeys&&(e+=userinfo.otphkeys),8388608&features&&1==userinfo.otpekey&&e++,33554432&features&&67108864&features&&null!=userinfo.phone&&e++,33554432&features2&&67108864&features2&&null!=userinfo.msghandle&&e++,0<e&&0<userinfo.otpkeys&&0==(262144&features2)&&e++,e)}var backupCodesWarningDone=!1;function updateSelf(){var e,t=count2factoraAuths(),n=4294967295!=userinfo.siteadmin&&0!=(1024&userinfo.siteadmin),n=(QV("verifyEmailId",!0!==userinfo.emailVerified&&null!=userinfo.email&&1==serverinfo.emailcheck),QV("verifyEmailId2",!0!==userinfo.emailVerified&&null!=userinfo.email&&1==serverinfo.emailcheck&&0==n),QV("manageOtp",1!=serverinfo.lock2factor&&0<t&&0==(262144&features2)),QV("authPhoneNumberCheck",null!=userinfo.phone),QV("authMessagingCheck",null!=userinfo.msghandle),QV("authEmailSetupCheck",1==userinfo.otpekey&&null!=userinfo.email&&1==userinfo.emailVerified),QV("authDuoSetupCheck",1==userinfo.otpduo&&0!=(536870912&features2)),QV("authAppSetupCheck",1==userinfo.otpsecret),QV("manageAuthApp",1!=serverinfo.lock2factor&&(1==userinfo.otpsecret||0==(131072&features2))),QV("manageDuoApp",1!=serverinfo.lock2factor&&0!=(536870912&features2)),QV("authKeySetupCheck",0<userinfo.otphkeys),QV("authPushAuthDevCheck",0<userinfo.otpdev&&0!=(64&features2)),QV("authCodesSetupCheck",0<userinfo.otpkeys),QV("managePushAuthDev",1!=serverinfo.lock2factor&&64&features2&&0<t),QV("manageHardwareOtp",1!=serverinfo.lock2factor),mainUpdate(4228),0==backupCodesWarningDone&&1==t&&0==(524288&features2)&&(addNotification({text:"請新增二因子鑑別的備用鑑別碼。如果丟失了當前因子，則無法恢復該帳戶。",title:"二因子身份驗證",tag:"backupcodes"}),backupCodesWarningDone=!0),4294967295==userinfo.siteadmin||0==(64&userinfo.siteadmin));QV("p2createMeshLink1",n),QV("p2createMeshLink2",n),QV("getStarted1",n),QV("getStarted2",!n),"number"==typeof userinfo.passchange&&(-1==userinfo.passchange?QH("p2nextPasswordUpdateTime"," -下次登入時重置。"):null!=passRequirements&&"number"==typeof passRequirements.reset&&((t=userinfo.passchange+86400*passRequirements.reset-Math.floor(Date.now()/1e3))<0?QH("p2nextPasswordUpdateTime"," -下次登入時重置。"):t<3600?(n=Math.floor(t/60),QH("p2nextPasswordUpdateTime",format(1==n?" - 1分鐘後重設。":" - 在{0}分鐘內重置。",n))):t<86400?(e=Math.floor(t/3600),QH("p2nextPasswordUpdateTime",format(1==e?" - 1小時後重設。":" - 在{0}小時內重置。",e))):(n=Math.floor(t/86400),QH("p2nextPasswordUpdateTime",format(1==e?" - 1天后重設。":" - 在{0}天內重置。",n))))),QV("MainMenuMyUsers",null!=users&&0==(4&features)||0!=(512&userinfo.siteadmin)&&0!=(134217728&features)),QV("LeftMenuMyUsers",null!=users&&0==(4&features)||0!=(512&userinfo.siteadmin)&&0!=(134217728&features)),QV("UsersGeneral",null!=users&&0==(4&features)),QV("UsersGroups",null!=users&&0==(4&features)),QV("UsersRecordings",0!=(512&userinfo.siteadmin)&&0!=(134217728&features))}function setSessionActivity(){sessionActivity=Date.now(),QH("idleTimeoutNotify","")}function checkIdleSessionTimeout(){var e=Date.now()-sessionActivity;e>serverinfo.timeout?(null!=desktop&&(desktop.Stop(),webRtcDesktopReset(),(desktopNode=desktop=null)!=pluginHandler)&&pluginHandler.callHook("onDesktopDisconnect"),null!=terminal&&(terminal.Stop(),terminal=null),null!=files&&(files.Stop(),files=null),serverinfo.logoutOnIdleSessionTimeout&&(window.location.href="logout")):(e=Math.round((serverinfo.timeout-e)/1e3))<=60?QH("idleTimeoutNotify","<br />"+format(1==e?"1秒之後離線":"{0}秒後斷開連接",e)):(e=Math.round(e/60))<=5&&QH("idleTimeoutNotify","<br />"+format(1==e?"1分鐘之後離線":"{0}分鐘直到斷開連接",e))}function onMessage(H,n){switch(n.action){case"trace":serverTrace.unshift(n),displayServerTrace();break;case"intersession":"removeNotify"==n.subaction&&notificationDelete(n.id);break;case"traceinfo":"object"==typeof n.traceSources&&(null!=n.traceSources&&0<n.traceSources.length?(serverTraceSources=n.traceSources,QH("p41traceStatus",EscapeHtml(n.traceSources.join(", ")))):(serverTraceSources=[],QH("p41traceStatus","沒有")));break;case"serverstats":updateGeneralServerStats(n);break;case"serverwarnings":if(null!=n.warnings&&0<n.warnings.length){var F={1:"",2:"缺少 WebDAV 參數。",3:'無法識別的配置選項 "{0}"。',4:"WebSocket 壓縮被禁用，此功能在 NodeJS v11.11 到 v12.15 和 v13.2 中被破壞",5:"無法為默認域加載 Intel AMT TLS 根證書。",6:"無法為域 {0} 加載 Intel AMT TLS 根證書。",7:"當服務器處於僅 LAN 或僅 WAN 模式時，CIRA 本地 FQDN 將被忽略。",8:"不能有超過 4 個 CIRA 本地 FQDN。忽略價值。",9:"正在跳過代理哈希檢查，這是不安全的。",10:"缺少讓我們加密電子郵件地址。",11:"無效的 Let's Encrypt 主機名。",12:"無效的 Let's Encrypt 名稱，不能包含 *。",13:"無法設置 Let's Encrypt 模塊。",14:"Let's Encrypt 名稱無效，無法解析：{0}",15:"Let's Encrypt 電子郵件地址無效，無法解決：{0}",16:"無法加載 CloudFlare 可信代理 IPv6 地址列表。",17:"SendGrid 服務器在 LAN 模式下的使用受到限制。",18:"SMTP 服務器在 LAN 模式下的使用受到限制。",19:"SMS 網關在 LAN 模式下的使用有限。",20:"config.json 中的“LoginCookieEncryptionKey”無效。",21:"備份路徑不能在 meshcentral-data 文件夾中設置，備份設置被忽略。",22:"未能簽署代理 {0}：{1}",23:"Unable to load agent icon file: {0}.",24:"Unable to load agent logo file: {0}.",25:"This NodeJS version does not support OpenID.",26:"This NodeJS version does not support Discord.js.",27:"Firebase now requires a service account JSON file, Firebase disabled."},e="";for(l in n.warnings)"string"==typeof(t=n.warnings[l])?e+="<div style=color:red;padding-bottom:6px><b>警告： "+t+"</b></div>":(null==(i=F[t.id])?i=t.msg:null!=t.args&&(i=format(i,...t.args)),e+="<div style=color:red;padding-bottom:6px><b>警告： "+i+"</b></div>");QH("serverWarnings",e),QV("serverWarningsDiv",!0)}break;case"servertimelinestats":setServerTimelineStats(n.events);break;case"authcookie":authCookie=n.cookie,authRelayCookie=n.rcookie;break;case"serverinfo":if((serverinfo=n.serverinfo).timeout&&(setInterval(checkIdleSessionTimeout,1e4),checkIdleSessionTimeout()),1==debugmode&&console.log("Server time: ",printDateTime(new Date(serverinfo.serverTime))),setupServiceWorker(),null!=serverinfo.certExpire&&0<=(c=Math.floor((serverinfo.certExpire-Date.now())/864e5))&&c<20&&(QH("serverCertWarnings","<div style=color:red;padding-bottom:6px><b>警告： "+format("證書將在 {0} 天后到期",c)+"</b></div>"),QV("serverWarningsDiv",!0),addNotification({text:format("證書將在 {0} 天后到期",c)})),serverinfo.preConfiguredRemoteInput){e="";for(l in serverinfo.preConfiguredRemoteInput)e+='<div class="cmtext" onclick="cmdeskpreconfigtypeaction('+l+',event)">'+EscapeHtml(serverinfo.preConfiguredRemoteInput[l].name)+"</div>";""!=e&&(e+="<hr />"),QH("deskPreConfigShortcutContextMenu1",e)}if(serverinfo.preConfiguredScripts){var e="",t="";for(l in serverinfo.preConfiguredScripts){var o=serverinfo.preConfiguredScripts[l],i='<div class="cmtext" onclick="cmdeskpreconfigscriptaction('+l+',event)">'+EscapeHtml(serverinfo.preConfiguredScripts[l].name)+"</div>";3!=o.type&&(e+=i),3<=o.type&&(t+=i)}QH("deskPreConfigScriptContextMenu1",e),QH("deskPreConfigScriptContextMenu2",t)}break;case"userinfo":userinfo=n.userinfo,updateSiteAdmin(),updateSelf();break;case"users":for(var s in users={},n.users)users[n.users[s]._id]=n.users[s];null!=currentUser&&(currentUser=users[currentUser._id]),mainUpdate(16384),updateSelf();break;case"wssessioncount":wssessions=n.wssessions,mainUpdate(16384);break;case"meshes":for(var s in meshes={},n.meshes)meshes[n.meshes[s]._id]=n.meshes[s];null!=currentMesh&&(currentMesh=meshes[currentMesh._id]),mainUpdate(132);break;case"usergroups":var a=0;if(Array.isArray(n.ugroups))for(var l in usergroups={},n.ugroups)a++,usergroups[n.ugroups[l]._id]=n.ugroups[l];else for(var l in usergroups=n.ugroups,n.ugroups)a++,n.ugroups[l]._id=l;0==a&&(usergroups=null),mainUpdate(8192);break;case"files":filetree=setupBackPointers(n.filetree),updateFiles(),d3updatefiles();break;case"nodes":for(var s in nodes=[],n.nodes)for(var r in n.nodes[s])null==n.nodes[s][r]._id?console.log("Invalid node ("+r+"): "+JSON.stringify(n.nodes)):(null==n.nodes[s][r].name&&(n.nodes[s][r].name="???"),n.nodes[s][r].namel=n.nodes[s][r].name.toLowerCase(),n.nodes[s][r].rname?n.nodes[s][r].rnamel=n.nodes[s][r].rname.toLowerCase():n.nodes[s][r].rnamel=n.nodes[s][r].namel,n.nodes[s][r].meshnamel=meshes[s]?meshes[s].name.toLowerCase():"*",n.nodes[s][r].meshid=s,n.nodes[s][r].state=n.nodes[s][r].state||0,n.nodes[s][r].icon||(n.nodes[s][r].icon=1),n.nodes[s][r].ident=++nodeShortIdent,nodes.push(n.nodes[s][r]));for(var l in stars)null==getNodeFromId(l)&&delete stars[l];null!=currentNode&&0==IsNodeViewable(currentNode)&&(currentNode=null,go(1)),null!=currentNode&&(null!=(currentNode=getNodeFromId(currentNode._id))?gotoDevice(currentNode._id,xxcurrentView,!0):go(1)),devicePagingState=null==n.totalcount?null:{total:n.totalcount,skip:n.skip,limit:n.limit},updateDevicePageState(),mainUpdate(71);break;case"powertimeline":if(n.nodeid==powerTimelineReq){for(var l in powerTimelineNode=n.nodeid,powerTimeline=n.timeline,powerTimelineUpdate=Date.now()+3e5,powerTimeline)l%2==1&&(powerTimeline[l]=1e3*powerTimeline[l]);currentNode._id==n.nodeid&&mainUpdate(256)}break;case"deviceShares":n.nodeid==deviceSharesReq&&(deviceSharesNode=n.nodeid,deviceShares=n.deviceShares,null!=currentNode&&currentNode._id==n.nodeid)&&gotoDevice(currentNode._id,xxcurrentView,!0);break;case"deviceMeshShares":n.meshid==deviceSharesReq&&(deviceSharesNode=n.meshid,deviceShares=n.deviceShares,null!=currentMesh&&currentMesh._id==n.meshid)&&p20updateMesh();break;case"getsysinfo":n.nodeid==powerTimelineReq&&(!0===n.noinfo?updateDeviceDetails(getNodeFromId(n.nodeid)):updateDeviceDetails(getNodeFromId(n.nodeid),n.hardware));break;case"lastconnect":null!=(T=getNodeFromId(n.nodeid))&&(T.lastconnect=n.time,T.lastaddr=n.addr,currentNode._id==T._id)&&""==Q("MainComputerState").innerHTML&&null!=T.lastconnect&&QH("MainComputerState","<span>最後一次發現：<br />"+printDateTime(new Date(T.lastconnect))+"</span>");break;case"lastconnects":var B=Object.keys(n.lastconnects);for(l in B){var O=B[l];null!=(T=getNodeFromId(O))&&(T.lastconnect=n.lastconnects[O])}mainUpdate(4);case"msg":if(null!=n.nodeid){var d=-1;if(null!=nodes)for(var l in nodes)if(nodes[l]._id==n.nodeid){d=l;break}if(-1!=d)if("cpuinfo"===n.type&&null!=currentNode&&currentNode._id==n.nodeid){var c=Date.now()/1e3,u=0,p=0;"number"==typeof n.cpu.total&&(u=n.cpu.total),"number"==typeof n.memory.percentConsumed&&(p=n.memory.percentConsumed),deviceDetailsStatsData.push([c,u,p]),deviceDetailsStatsDraw(n)}else if("console"===n.type)p15consoleReceive(nodes[d],n.value,n.source);else if("notify"===n.type){if(0==(8&(r=getstore("notifications",0)))&&null!=n.amtMessage)break;r={text:n.value,title:n.title,icon:n.icon,titleid:n.titleid,msgid:n.msgid,args:n.args};null!=n.id&&(r.id=n.id),null!=n.nodeid&&(r.nodeid=n.nodeid),null!=n.tag&&(r.tag=n.tag),null!=n.url&&(r.url=n.url),null!=n.username&&(r.username=n.username),"number"==typeof n.maxtime&&(r.maxtime=n.maxtime),addNotification(r)}else if("ps"===n.type)showDeskToolsProcesses(n);else if("services"===n.type)showDeskToolsServices(n);else if("service"===n.type)showServiceDetailsDialog(n);else if("getclip"===n.type&&null!=currentNode&&currentNode._id==n.nodeid)1==n.tag&&"clipboard"===xxdialogTag?Q("d2clipText").value=n.data:2===n.tag&&null!=navigator.clipboard&&navigator.clipboard.writeText(n.data).then(function(){}).catch(function(e){console.log(e)});else if("setclip"===n.type&&"clipboard"===xxdialogTag&&null!=currentNode&&currentNode._id==n.nodeid)QH("dlgClipStatus",n.success?"<span style=color:green>成功</span>":"<span style=color:red>失敗</span>"),setTimeout(function(){try{QH("dlgClipStatus","")}catch(e){}},2e3);else if("userSessions"===n.type&&null!=currentNode&&currentNode._id===n.nodeid&&null==desktop){var m=[];if(null!=n.data)for(var l in n.data)"Active"!=n.data[l].State&&"Connected"!=n.data[l].State&&"Console"!=n.data[l].StationName&&3!=debugmode||m.push(n.data[l]);if(0===m.length)connectDesktop(null,1,null,n.tag);else if(1===m.length)connectDesktop(null,1,m[0].SessionId,n.tag);else{var e="",g="{{{userSessionsSort}}}";for(l in m.sort(function(e,t){return e[g]?t[g]?e[g]<t[g]?-1:t[g]<e[g]?1:0:1:-1}),m)e+='<div style="text-align:left;cursor:pointer;background-color:gray;margin:5px;padding:5px;border-radius:5px" onclick=connectDesktop(event,1,'+m[l].SessionId+","+n.tag+")>"+m[l].State+(m[l].StationName?", "+m[l].StationName:""),m[l].Username&&(m[l].Domain?e+=" - "+m[l].Domain+"/"+m[l].Username:e+=" - "+m[l].Username),e+="</div>";QH("p11DeskSessionSelector",e),QV("p11DeskSessionSelector",!0)}}else"psinfo"===n.type?xxdialogTag==="ps|"+n.nodeid+"|"+n.pid&&(e="<div style=max-height:200px;overflow-y:auto>","object"==typeof n.value&&0<Object.keys(n.value).length?(n.value=jsonToCamel(n.value),!n.value.cmd&&n.value.path&&(n.value.cmd=n.value.path),!n.value.processUser&&n.value.userName&&(n.value.processUser=n.value.userName.split("\\")[1]),!n.value.processDomain&&n.value.userName&&(n.value.processDomain=n.value.userName.split("\\")[0]),n.value.processName&&(e+="<div style=padding:4px><div style=padding-bottom:4px>進程名稱</div><div style=word-wrap:break-word;padding-left:6px><b>"+n.value.processName+"</b></div></div>"),n.value.machineName&&(e+=addHtmlValue5("機器名稱",n.value.machineName)),n.value.cmd&&(e+="<div style=padding:4px><div style=padding-bottom:4px>命令行</div><div style=word-wrap:break-word;padding-left:6px><b>"+n.value.cmd+"</b></div></div>"),n.value.mainWindowTitle&&(e+="<div style=padding:4px><div style=padding-bottom:4px>窗口標題</div><div style=word-wrap:break-word;padding-left:6px><b>"+n.value.mainWindowTitle+"</b></div></div>"),n.value.processUser&&(e+=addHtmlValue5("用戶",n.value.processUser)),n.value.processDomain&&(e+=addHtmlValue5("域",n.value.processDomain)),n.value.startTime&&(e+=addHtmlValue5("開始時間",n.value.startTime)),e+="<hr />",n.value.PriorityBoostEnabled&&(e+=addHtmlValue5("優先提升",n.value.PriorityBoostEnabled?"已啟用":"已禁用")),n.value.sessionId&&(e+=addHtmlValue5("會話 ID",n.value.sessionId)),n.value.handleCount&&(e+=addHtmlValue5("處理計數",n.value.handleCount)),n.value.privilegedProcessorTime&&(e+=addHtmlValue5("特權處理器時間",format("{0} 秒",n.value.privilegedProcessorTime))),n.value.totalProcessorTime&&(e+=addHtmlValue5("總處理器時間",format("{0} 秒",n.value.totalProcessorTime))),n.value.userProcessorTime&&(e+=addHtmlValue5("用戶處理器時間",format("{0} 秒",n.value.userProcessorTime))),n.value.nonpagedSystemMemorySize&&(e+=addHtmlValue5("非分頁內存",getNiceSize2(n.value.nonpagedSystemMemorySize))),n.value.pagedMemorySize&&(e+=addHtmlValue5("分頁內存",getNiceSize2(n.value.pagedMemorySize))),n.value.privateMemorySize&&(e+=addHtmlValue5("私人內存",getNiceSize2(n.value.privateMemorySize))),n.value.virtualMemorySize&&(e+=addHtmlValue5("虛擬內存",getNiceSize2(n.value.virtualMemorySize))),n.value.workingSet&&(e+=addHtmlValue5("工作集",getNiceSize2(n.value.workingSet))),n.value.peakWorkingSet&&(e+=addHtmlValue5("峰值工作集",getNiceSize2(n.value.peakWorkingSet))),n.value.peakPagedMemorySize&&(e+=addHtmlValue5("峰值分頁內存",getNiceSize2(n.value.peakPagedMemorySize))),n.value.peakVirtualMemorySize&&(e+=addHtmlValue5("峰值虛擬內存",getNiceSize2(n.value.peakVirtualMemorySize)))):e+="未提供信息",e+="</div>",QH("id_dialogOptions",e)):"deskBackground"===n.type&&(""!=n.data?Q("DeskBackgroundButtonImage").style.color="":Q("DeskBackgroundButtonImage").style.color="red")}else"notify"===n.type&&(r={text:n.value,title:n.title,icon:n.icon,titleid:n.titleid,msgid:n.msgid,args:n.args},null!=n.id&&(r.id=n.id),null!=n.tag&&(r.tag=n.tag),null!=n.url&&(r.url=n.url),null!=n.username&&(r.username=n.username),"number"==typeof n.maxtime&&(r.maxtime=n.maxtime),addNotification(r));break;case"getnetworkinfo":if(currentNode._id!=n.nodeid)return;if(updateDeviceDetails(getNodeFromId(n.nodeid),null,n),2==xxdialogMode&&xxdialogTag=="if"+n.nodeid){var e="<div class=dialogText>";if(currentNode.lastconnect&&(e+=addHtmlValue2("上次代理連接",printDateTime(new Date(currentNode.lastconnect)))),currentNode.lastaddr&&(2<(c=currentNode.lastaddr.split(":")).length?e+=addHtmlValue2("上次代理地址",currentNode.lastaddr+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="將地址複製到剪貼板" onclick=copyTextToClip2("'+encodeURIComponentEx(currentNode.lastaddr)+'")></i>'):isPrivateIP(currentNode.lastaddr)?e+=addHtmlValue2("上次代理地址",c[0]+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="將地址複製到剪貼板" onclick=copyTextToClip2("'+encodeURIComponentEx(c[0])+'")></i>'):e+=addHtmlValue2("上次代理地址",'<a href="https://iplocation.com/?ip='+c[0]+'" rel="noreferrer noopener" target="MeshIPLoopup">'+c[0]+'</a> <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="將地址複製到剪貼板" onclick=copyTextToClip2("'+encodeURIComponentEx(c[0])+'")></i>')),null!=n.updateTime&&(e+=addHtmlValue2("最後介面更新",printDateTime(new Date(n.updateTime)))),null!=n.netif)for(var l in n.netif)e+="<hr />",(h=n.netif[l]).name&&(e+=addHtmlValue2("名稱","<b>"+EscapeHtml(h.name)+"</b>")),h.desc&&(e+=addHtmlValue2("描述",EscapeHtml(h.desc).replace("(R)","&reg;").replace("(r)","&reg;"))),h.dnssuffix&&(e+=addHtmlValue2("DNS suffix",EscapeHtml(h.dnssuffix)+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="將名稱複製到剪貼板" onclick=copyTextToClip2("'+encodeURIComponentEx(h.dnssuffix)+'")></i>')),h.mac&&(e+=addHtmlValue2("MAC地址",'<a href="https://maclookup.app/search/result?mac='+h.mac.substring(0,6)+'" rel="noreferrer noopener" target="MeshMACLoopup">'+EscapeHtml(h.mac.toLowerCase())+'</a> <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="將MAC地址複製到剪貼板" onclick=copyTextToClip2("'+encodeURIComponentEx(h.mac.toLowerCase())+'")></i>')),h.v4addr&&(e+=addHtmlValue2("IPv4地址",EscapeHtml(h.v4addr)+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="將地址複製到剪貼板" onclick=copyTextToClip2("'+encodeURIComponentEx(h.v4addr)+'")></i>')),h.v4mask&&(e+=addHtmlValue2("IPv4遮罩",EscapeHtml(h.v4mask)+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="將地址複製到剪貼板" onclick=copyTextToClip2("'+encodeURIComponentEx(h.v4mask)+'")></i>')),h.v4gateway&&(e+=addHtmlValue2("IPv4閘道",EscapeHtml(h.v4gateway)+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="將地址複製到剪貼板" onclick=copyTextToClip2("'+encodeURIComponentEx(h.v4gateway)+'")></i>')),h.gatewaymac&&(e+=addHtmlValue2("閘道MAC",'<a href="https://maclookup.app/search/result?mac='+h.gatewaymac.substring(0,6)+'" rel="noreferrer noopener" target="MeshMACLoopup">'+EscapeHtml(h.gatewaymac.toLowerCase())+'</a> <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="將MAC地址複製到剪貼板" onclick=copyTextToClip2("'+encodeURIComponentEx(h.gatewaymac.toLowerCase())+'")></i>'));else if(null!=n.netif2)for(var l in n.netif2){var h=n.netif2[l];if(!(0==Array.isArray(h)||h.length<1||null==h[0]||"string"==typeof h[0].mac&&h[0].mac.startsWith("00:00:00:00"))){e=(e+="<hr />")+addHtmlValue2("名稱","<b>"+EscapeHtml(l)+"</b>"),"string"==typeof h[0].mac&&(e+=addHtmlValue2("MAC地址",'<a href="https://maclookup.app/search/result?mac='+h[0].mac.split(":").join("").substring(0,6)+'" rel="noreferrer noopener" target="MeshMACLoopup">'+EscapeHtml(h[0].mac.toLowerCase())+'</a> <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="將MAC地址複製到剪貼板" onclick=copyTextToClip2("'+encodeURIComponentEx(h[0].mac.toLowerCase())+'")></i>')),h[0].fqdn&&(e+=addHtmlValue2("完整網域名稱",h[0].fqdn));for(var v=0;v<h.length;v++){var f=h[v];"IPv6"==f.family?(f.address&&(e+=addHtmlValue2("IPv6地址",EscapeHtml(f.address)+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="將地址複製到剪貼板" onclick=copyTextToClip2("'+encodeURIComponentEx(f.address)+'")></i>')),f.netmask&&(e+=addHtmlValue2("IPv6遮罩",EscapeHtml(f.netmask)+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="將地址複製到剪貼板" onclick=copyTextToClip2("'+encodeURIComponentEx(f.netmask)+'")></i>')),f.gateway&&(e+=addHtmlValue2("IPv6閘道",EscapeHtml(f.gateway)+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="將地址複製到剪貼板" onclick=copyTextToClip2("'+encodeURIComponentEx(f.gateway)+'")></i>'))):"IPv4"==f.family&&(f.address&&(e+=addHtmlValue2("IPv4地址",EscapeHtml(f.address)+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="將地址複製到剪貼板" onclick=copyTextToClip2("'+encodeURIComponentEx(f.address)+'")></i>')),f.netmask&&(e+=addHtmlValue2("IPv4遮罩",EscapeHtml(f.netmask)+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="將地址複製到剪貼板" onclick=copyTextToClip2("'+encodeURIComponentEx(f.netmask)+'")></i>')),f.gateway)&&(e+=addHtmlValue2("IPv4閘道",EscapeHtml(f.gateway)+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="將地址複製到剪貼板" onclick=copyTextToClip2("'+encodeURIComponentEx(f.gateway)+'")></i>'))}}}else e+="<hr />沒有適用於此裝置的網絡介面訊息。";e+="</div>",QH("d2netinfo",e)}break;case"serverversion":2==xxdialogMode&&"MeshCentralServerUpdate"==xxdialogTag&&(e="<div class=dialogText>",n.tags.current||(n.tags.current="未知"),n.tags.stable||(n.tags.stable="未知"),n.tags.latest||(n.tags.latest="未知"),e=(e=(e=e+addHtmlValue2("當前版本","<b>"+EscapeHtml(n.tags.current)+"</b>")+"<hr />")+addHtmlValue2('<label><input id=d2updateCheck1 type=checkbox class="form-check-input me-2" onclick=server_showVersionDlgUpdate()'+("未知"==n.tags.stable||n.tags.current==n.tags.stable||0==(2048&features)?" disabled":"")+" /> 穩定版</label>","<b>"+EscapeHtml(n.tags.stable)+"</b>"))+addHtmlValue2('<label><input id=d2updateCheck2 type=checkbox class="form-check-input me-2" onclick=server_showVersionDlgUpdate()'+("未知"==n.tags.latest||n.tags.current==n.tags.latest||0==(2048&features)?" disabled":"")+" /> 最新版本</label>","<b>"+EscapeHtml(n.tags.latest)+"</b>")+"</div>",n.tags.current==n.tags.latest&&n.tags.current==n.tags.stable||0==(2048&features)?(setModalContent("xxAddAgent","MeshCentral版本",e),showModal("xxAddAgentModal","idx_dlgOkButton")):(xxdialogTag=n.tags,setModalContent("xxAddAgent","MeshCentral版本",e+="<hr />檢查並單擊確定以開始伺服器自我更新。"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){server_showVersionDlgEx(2,n.tags)}),server_showVersionDlgUpdate()));break;case"servererrors":2==xxdialogMode&&"MeshCentralServerErrors"==xxdialogTag&&(null==n.data?(setModalContent("xxAddAgent","Server Errors","伺服器沒有錯誤日誌。"),showModal("xxAddAgentModal","idx_dlgOkButton")):(setModalContent("xxAddAgent","MeshCentral伺服器錯誤",e=(e='<div class="dialogText dialogTextLog"><pre id=d2ServerErrorsLogPre>'+EscapeHtml(n.data)+"</pre></div>")+'<br /><div style=float:right><i role=button class="fa-fw fa-solid fa-download fa-sm" title="下載錯誤日誌" onclick=d2CopyServerErrorsToClip()></i></div>'+'<div><label><input id=d2clearErrorsCheck type=checkbox class="form-check-input me-2" onclick=server_showErrorsDlgUpdate() /> 檢查並單擊確定以清除錯誤日誌。</label></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",server_showErrorsDlgEx),server_showErrorsDlgUpdate()));break;case"serverconfig":2==xxdialogMode&&"MeshCentralServerConfig"==xxdialogTag&&(null==n.data?setModalContent("xxAddAgent","Server Configuration","Server has no config file.","extra-large"):(setModalContent("xxAddAgent","Server Configuration",4,"extra-large"),QV("d4EncodingButton",!1),QV("d4LineBreakButton",!1),Q("d4editorarea").value=n.data,Q("d4editorarea").setAttribute("readonly","readonly")),showModal("xxAddAgentModal","idx_dlgOkButton"));break;case"serverconsole":p15consoleReceive("serverconsole",n.value);break;case"events":null!=n.nodeid&&null!=currentNode&&n.nodeid==currentNode._id?(currentDeviceEvents=n.events,mainUpdate(1024)):null!=n.userid&&null!=currentUser&&n.userid==currentUser._id?(currentUserEvents=n.events,mainUpdate(2048)):(events=n.events,mainUpdate(32));break;case"recordings":p52recordings=n.events,null!=n.error&&(p52recordings=n.error),updateRecordings();break;case"getcookie":"MCRouter"==n.tag?(-1!=(I=serverinfo.name).indexOf(".")&&0==(2&features)||(I=window.location.hostname),domainUrl.substring(0,domainUrl.length-1),V="mcrouter://"+I+(443==serverinfo.port?"":":"+serverinfo.port)+domainUrl+"control.ashx?c="+authCookie+"&t="+serverinfo.tlshash+"&l={{{lang}}}"+(urlargs.key?"&key="+urlargs.key:""),null!=n.nodeid&&(V+="&nodeid="+n.nodeid),null!=n.tcpport&&(V+="&protocol=1&remoteport="+n.tcpport),n.localRelay&&(V+="&local=1"),n.localport&&(V+="&localport="+n.localport),null!=n.name&&(V+="&name="+encodeURIComponentEx(n.name)),null!=n.ip&&(V+="&remoteip="+n.ip),downloadFile(V+="&appid="+n.protocol+"&autoexit=1","")):"novnc"==n.tag?(u=window.location.origin+domainUrl+"novnc/vnc.html?ws=wss%3A%2F%2F"+window.location.host+encodeURIComponentEx(domainUrl)+(n.localRelay?"local":"mesh")+"relay.ashx%3Fauth%3D"+n.cookie+"&show_dot=1"+(urlargs.key?"&key="+urlargs.key:"")+"&l={{{lang}}}",null!=(T=getNodeFromId(n.nodeid))&&(u+="&name="+encodeURIComponentEx(T.name)),safeNewWindow(u,"mcnovnc/"+n.nodeid)):"mstsc"==n.tag?(p=window.location.origin+domainUrl+"mstsc.html?ws="+n.cookie+(urlargs.key?"&key="+urlargs.key:""),null!=(T=getNodeFromId(n.nodeid))&&(p+="&name="+encodeURIComponentEx(T.name)),n.localRelay&&(p+="&local=1"),safeNewWindow(p,"mcmstsc/"+n.nodeid)):"ssh"==n.tag&&(c=window.location.origin+domainUrl+"ssh.html?ws="+n.cookie+(urlargs.key?"&key="+urlargs.key:""),null!=(T=getNodeFromId(n.nodeid))&&(c+="&name="+encodeURIComponentEx(T.name)),n.localRelay&&(c+="&local=1"),safeNewWindow(c,"mcssh/"+n.nodeid));break;case"getNotes":(r=Q("d2devNotes"))&&n.id==decodeURIComponent(r.attributes.noteid.value)?(n.notes?QH("d2devNotes",decodeURIComponent(n.notes)):QH("d2devNotes",""),0==("true"==r.attributes.ro.value)&&(r.removeAttribute("readonly"),QE("idx_dlgOkButton",!0),QV("idx_dlgOkButton",!0),focusTextBox("d2devNotes"))):(Q("notesPanelArea").innerHTML=n.notes&&marked&&DOMPurify?DOMPurify.sanitize(marked.parse(decodeURIComponent(n.notes),{breaks:!0}),{USE_PROFILES:{html:!0}}):"","true"===showNotesPanel&&n.notes?QV("notesPanel",!0):QV("notesPanel",!1));break;case"otpauth-request":2==xxdialogMode&&"otpauth-request"==xxdialogTag&&(null!=n.err?(u=["","2FA被鎖定","備用代碼已鎖定","正在使用的登錄令牌","不允許 OTP 2FA","帳戶已被鎖定","無法加載 OTPLIB"],0<n.err&&n.err<u.length?QH("d2optinfo",u[n.err]):QH("d2optinfo",format("錯誤 #{0}",n.err))):(52==(p=n.secret).length?p=p.split(/(.............)/).filter(Boolean).join(" "):32==p.length&&(p=(p=p.split(/(....)/).filter(Boolean).join(" ")).substring(0,20)+"<br/>"+p.substring(20)),QH("d2optinfo","<table style=width:380px><tr><td style=vertical-align:top>"+format('安裝 <a href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2" rel="noreferrer noopener" target=_blank>Google Authenticator</a> 或兼容的應用軟體並掃描條碼，使用<a href="{0}" rel="noreferrer noopener" target=_blank>此鏈結</a>或輸入密碼。然後，在下面輸入當前的6位數保安編碼以啟動兩步登入。',n.url)+'<br /><br />Secret <img src=images/link4.png height=10 width=10 title="Copy Secret to clipboard" style=cursor:pointer onclick=d2CopySecretToClip()><br /><tt id=d2optsecret secret="'+n.secret+'" style=font-size:12px>'+p+'</tt><br /><br /></td><td style=width:1px;vertical-align:top><a href="'+n.url+'" rel="noreferrer noopener" target=_blank><div id="qrcode"></div></a></td><tr><td colspan=2 style="text-align:center;border-top:1px solid black"><br />在此處輸入保安編碼以進行兩步登入： <input type=text autocomplete="one-time-code" inputmode="numeric" pattern="[0-9]*" onkeypress="return (event.keyCode == 8) || (event.charCode >= 48 && event.charCode <= 57)" onkeyup=account_addOtpCheck(event) onkeydown=account_addOtpCheck() maxlength=6 id=d2otpauthinput type=text></td></table>'),new QRCode(Q("qrcode"),{text:n.url,width:128,height:128,colorDark:"#000000",colorLight:"#EEE",correctLevel:QRCode.CorrectLevel.H}),QV("idx_dlgOkButton",!0),QE("idx_dlgOkButton",!1),Q("d2otpauthinput").focus()));break;case"otpauth-setup":if(xxdialogMode)return;setModalContent("xxAddAgent","認證軟體",n.success?"<b style=color:green>認證軟體啟動成功。</b> 你現在需要一個有效的保安編碼才能再次登入。":"<b style=color:red>兩步登入啟用失敗。</b> 從應用程序中清除秘密，然後重試。你只有幾分鐘的時間來輸入正確的代碼。"),showModal("xxAddAgentModal","idx_dlgOkButton");break;case"otpauth-clear":if(xxdialogMode)return;setModalContent("xxAddAgent","認證軟體",n.success?"<b>認證軟體已刪除。</b> 你可以隨時重新啟動此功能。":"<b style=color:red>兩步登入啟用刪除失敗。</b> 再試一次。"),showModal("xxAddAgentModal","idx_dlgOkButton");break;case"otpauth-getpasswords":if(xxdialogMode)return;e="一次性保安編碼可以用作輔助身份驗證。生成一群，打印並保存在安全的地方。";if(e+='<div style="border-radius:6px;border: 2px dashed #888;width:100%;margin-top:8px"><div style="padding:8px;font-family:Arial, Helvetica, sans-serif;font-size:20px;font-weight:bold"><table class=selecttext style=width:100%;text-align:center>',n.passwords){var v=0,x="";for(l in n.passwords){++v%2&&(e+="<tr>");for(var k=""+n.passwords[l].p;k.length<8;)k="0"+k;!0===n.passwords[l].u?(e+="<td>"+k.substring(0,4)+"&nbsp;"+k.substring(4),""!=x&&(x+=" "),x+=k):e+="<td><strike style=color:#BBB>"+k.substring(0,4)+"&nbsp;"+k.substring(4)}}else e+="<tr><td>沒有有效保安編碼";e=(e+="</table></div></div><br />")+"<div>"+'<input type=button value="產生新保安編碼" onclick="account_manageOtp(1);"></input>',null!=n.passwords&&(e=(e+='<input type=button value="清除保安編碼" onclick="account_manageOtp(2);"></input>')+'&nbsp;<img src=images/link4.png height=10 width=10 title="將有效代碼複製到剪貼板" style=cursor:pointer onclick=copyTextToClip2("'+encodeURIComponentEx(x)+'")>'),setModalContent("xxAddAgent","管理備用碼",e+="</div><br />"),showModal("xxAddAgentModal","idx_dlgOkButton");break;case"otp-hkey-get":if(xxdialogMode&&"otpauth-hardware-manage"!=xxdialogTag)return;var P='<div style="border-radius:6px;border:2px solid #CCC;background-color:#BBB;width:100%;box-sizing:border-box;margin-bottom:6px"><div style="margin:3px;font-family:Arial, Helvetica, sans-serif;font-size:16px;font-weight:bold"><table style=width:100%;text-align:left>',L="</table></div></div>",e='<a href="https://www.yubico.com/" rel="noreferrer noopener" target="_blank">硬件密鑰</a> 用作輔助登入身份驗證。';if(e+='<div style="max-height:150px;overflow-y:auto;overflow-x:hidden;margin-top:6px;margin-bottom:6px">',n.keys&&0<n.keys.length)for(var l in n.keys){var z=n.keys[l];e+=P+'<tr style=margin:5px><td style=width:30px><img width=24 height=18 src="images/hardware-key-'+(U=2==z.type?"OTP":"WebAuthn")+'-24.png" style=margin-top:4px><td style=width:250px>'+z.name+'<td><input type=button value="删除" onclick=account_removehkey('+z.i+")></input>"+L}else e+=P+"<tr style=text-align:center><td>未配置任何鍵"+L;e=e+"</div>"+"<div>";c="number"==typeof userinfo.otphkeys?userinfo.otphkeys:0;"number"!=typeof serverinfo.maxfidokeys||serverinfo.maxfidokeys>c?(0!=(131072&features)&&(e+='<input id=d2addkey3 type=button value="新增密鑰" onclick="account_addhkey(3);"></input>'),0!=(16384&features)&&(e+='<input id=d2addkey2 type=button value="新增YubiKey&reg;OTP" onclick="account_addhkey(2);"></input>')):e+="已達到最大鍵數。",setModalContent("xxAddAgent","管理安全密鑰",e+="</div><br />"),showModal("xxAddAgentModal","idx_dlgOkButton"),0==u2fSupported()&&QE("d2addkey1",!1);break;case"otp-hkey-yubikey-add":n.result?meshserver.send({action:"otp-hkey-get"}):(setModalContent("xxAddAgent","新增安全密鑰","<br />錯誤，無法新增密鑰。<br /><br />"),showModal("xxAddAgentModal","idx_dlgOkButton"));break;case"otp-hkey-setup-response":if(xxdialogMode&&"otpauth-hardware-manage"!=xxdialogTag)return;1==n.result?meshserver.send({action:"otp-hkey-get"}):(setModalContent("xxAddAgent","新增安全密鑰","<br />錯誤，無法新增密鑰。<br /><br />"),showModal("xxAddAgentModal","idx_dlgOkButton"));break;case"webauthn-startregister":if(xxdialogMode&&"otpauth-hardware-manage"!=xxdialogTag)return;setModalContent("xxAddAgent","新增安全密鑰",e='現在按下按鍵。<br /><br /><div style=width:100%;text-align:center><img width=120 height=117 src="images/hardware-keypress-120.png" /></div><input id=dp1keyname style=display:none value='+n.name+" />");u=n.request;n.request.challenge=Uint8Array.from(atob(n.request.challenge),function(e){return e.charCodeAt(0)}),n.request.user.id=Uint8Array.from(atob(n.request.user.id),function(e){return e.charCodeAt(0)}),navigator.credentials.create({publicKey:u}).then(function(e){meshserver.send({action:"webauthn-endregister",response:{rawId:btoa(String.fromCharCode.apply(null,new Uint8Array(e.rawId))),response:{attestationObject:btoa(String.fromCharCode.apply(null,new Uint8Array(e.response.attestationObject))),clientDataJSON:btoa(String.fromCharCode.apply(null,new Uint8Array(e.response.clientDataJSON)))},type:e.type}}),setDialogMode(0)},function(e){console.log("錯誤："+e),setModalContent("xxAddAgent","新增安全密鑰","錯誤："+e)}),showModal("xxAddAgentModal","idx_dlgOkButton");break;case"verifyPhone":if(xxdialogMode&&"verifyPhone"!=xxdialogTag)return;setModalContent("xxAddAgent","電話通知",e=(e='<table><tr><td><img src="images/phone80.png" style=padding:8px>')+"<td>檢查你的電話並輸入驗證碼。"+'<br /><br /><div style=width:100%;text-align:center>驗證碼： <input type=tel pattern="[0-9]" inputmode="number" maxlength=6 id=d2phoneCodeInput onKeyUp=account_managePhoneCodeValidate() onkeypress="if (event.key==\'Enter\') account_managePhoneCodeValidate(1)"></div></table>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>account_managePhoneConfirm(3,n.cookie)),Q("d2phoneCodeInput").focus(),account_managePhoneCodeValidate();break;case"verifyMessaging":if(xxdialogMode&&"verifyMessaging"!=xxdialogTag)return;setModalContent("xxAddAgent","Messaging Notifications",e=(e='<table><tr><td><img src="images/messaging40.png" style=padding:8px>')+"<td>Check your messaging application and enter the verification code."+'<br /><br /><div style=width:100%;text-align:center>驗證碼： <input type=tel pattern="[0-9]" inputmode="number" maxlength=6 id=d2phoneCodeInput onKeyUp=account_managePhoneCodeValidate() onkeypress="if (event.key==\'Enter\') account_managePhoneCodeValidate(1)"></div></table>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>account_manageMessagingConfirm(3,n.cookie)),Q("d2phoneCodeInput").focus(),account_managePhoneCodeValidate();break;case"fileoperation":setModalContent("xxAddAgent",EscapeHtml(n.file),4,"extra-large"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>{var e,t;e=n,t=Q("d4editorarea").value,t=0===d4EditLineBreakVal?t.replace(/\r?\n|\r/g,"\r\n"):2===d4EditLineBreakVal?t.replace(/\r\n|\n/g,"\r"):t.replace(/\r\n|\r/g,"\n"),t=1==d4EditEncodingVal?encode_utf8(t):t,meshserver.send({action:"fileoperation",fileop:"set",path:e.path,file:e.file,data:btoa(t)})}),QV("d4EncodingButton",!0),QV("d4LineBreakButton",!0),Q("d4editorarea").value=1==d4EditEncodingVal?decode_utf8(atob(n.data)):atob(n.data);break;case"event":if(!n.event.nolog){if(currentNode&&n.event.nodeid==currentNode._id&&null!=currentDeviceEvents&&(n.event.action==p16filterevents.value||""==p16filterevents.value)){if(null!=currentDeviceEvents){currentDeviceEvents.unshift(n.event);for(var y=parseInt(p16limitdropdown.value);currentDeviceEvents.length>y;)currentDeviceEvents.pop()}mainUpdate(1024)}if(currentUser&&n.event.userid==currentUser._id&&(n.event.action==p31filterevents.value||""==p31filterevents.value)){if(null!=currentUserEvents){currentUserEvents.unshift(n.event);for(y=parseInt(p31limitdropdown.value);currentUserEvents.length>y;)currentUserEvents.pop()}mainUpdate(2048)}if(n.event.action==p3filterevents.value||""==p3filterevents.value){if(null!=events){events.unshift(n.event);for(y=parseInt(p3limitdropdown.value);events.length>y;)events.pop()}mainUpdate(32)}}if(!n.event.noact)switch(n.event.action){case"serverinfochange":null!=n.event.lock2factor&&(serverinfo.lock2factor=n.event.lock2factor,updateSelf(),updateSiteAdmin());break;case"deviceShareUpdate":n.event.nodeid==deviceSharesReq&&(deviceSharesNode=n.event.nodeid,deviceShares=n.event.deviceShares,currentNode._id==deviceSharesNode)&&gotoDevice(currentNode._id,xxcurrentView,!0);break;case"agentlog":98==n.event.msgid&&0<GetNodeRights(n.event.nodeid)&&(r=getNodeFromId(n.event.nodeid),addNotification({text:format("從{0}請求的幫助：{1}",n.event.msgArgs[0],n.event.msgArgs[1]),title:r.name,icon:r.icon,nodeid:n.event.nodeid}));break;case"recording":null!=p52recordings&&"object"==typeof p52recordings&&(p52recordings.unshift(n.event),n.event.present=1,updateRecordings());break;case"userWebState":try{if(null!=localStorage){var b=localStorage.getItem("showRealNames"),w=localStorage.getItem("uiMode"),G=localStorage.getItem("sort"),M=localStorage.getItem("loctag"),W=localStorage.getItem("nightMode"),K=localStorage.getItem("footerBar"),C=JSON.parse(n.event.state);for(l in C)localStorage.setItem(l,C[l]);if(null!=C.showRealNames&&C.showRealNames!=b&&(showRealNames=Q("RealNameCheckBox").checked="1"==C.showRealNames,mainUpdate(6)),null!=C.uiMode&&C.uiMode!=w&&userInterfaceSelectMenu(parseInt(C.uiMode)),null!=C.sort&&C.sort!=G&&(document.getElementById("sortselect").selectedIndex=sort=parseInt(C.sort),mainUpdate(6)),null!=C.loctag&&C.loctag!=M&&(null!=C.loctag?args.locale=C.loctag:delete args.locale,mainUpdate(4294967295)),null!=C.nightMode&&C.nightMode!=W&&(putstore("nightMode",C.nightMode),setNightMode()),null!=C.footerBar&&C.footerBar!=K&&(footerBar="1"==C.footerBar,QS("container")["grid-template-rows"]=null,QS("container")["-ms-grid-rows"]=null,adjustPanels()),null!=C.stars&&C.stars!=JSON.stringify(stars)&&(stars=JSON.parse(C.stars),3==Q("DevFilterSelect").value?mainUpdate(5):mainUpdate(4),currentNode)&&refreshDevice(currentNode._id),null!=C.deskKeyShortcuts){deskKeyboardShortcuts=[];var j=C.deskKeyShortcuts.split(",");for(l in j)""!=j[l]&&deskKeyboardShortcuts.push(parseInt(j[l]));updateDeskShortcutKeys()}if(null!=C.deskStrings){o=null;try{o=JSON.parse(C.deskStrings)}catch(e){}Array.isArray(o)&&(deskKeyboardStrings=o,updateDesktopStrings())}}}catch(e){}break;case"servertimelinestats":addServerTimelineStats(n.event.data);break;case"accountcreate":case"accountchange":if("object"!=typeof n.event.account||null==n.event.account)return void console.log(n.event);userinfo._id==n.event.account._id&&(b=n.event.account.siteadmin||0,w=userinfo.siteadmin||0,G=n.event.account.removeRights||0,M=userinfo.removeRights||0,(n.event.account.quota!=userinfo.quota||0==(8&userinfo.siteadmin)&&0!=(8&n.event.account.siteadmin))&&meshserver.send({action:"files"}),W=userinfo.groups,userinfo=n.event.account,w==b&&M==G&&1!=n.event.accountImageChange||(1==n.event.accountImageChange&&(userinfo.accountImageRnd=Math.floor(9999999999*Math.random())),updateSiteAdmin()),updateSelf(),0!=(2&userinfo.siteadmin)&&(K=userinfo.groups||[],(W||[]).join(",")!=K.join(","))&&(users=wssessions=null,meshserver.send({action:"users"}),meshserver.send({action:"wssessioncount"})),n.event.nodeListChange==userinfo._id)&&meshserver.send({action:"nodes",skip:null==devicePagingState?0:devicePagingState.skip}),currentNode&&refreshDevice(currentNode._id),null!=users&&(null==userinfo.groups||0==userinfo.groups.length||1==findOne(n.event.account.groups,userinfo.groups)?users[n.event.account._id]=n.event.account:delete users[n.event.account._id],mainUpdate(16388));break;case"accountremove":null!=users&&(delete users[n.event.userid],mainUpdate(16384));break;case"createusergroup":case"usergroupchange":w=(usergroups=null==usergroups?{}:usergroups)[n.event.ugrpid];null==w?usergroups[n.event.ugrpid]={_id:n.event.ugrpid,name:n.event.name,desc:n.event.desc,domain:n.event.domain,links:n.event.links}:(w.name=n.event.name,n.event.desc?w.desc=n.event.desc:delete w.desc,n.event.links?w.links=n.event.links:delete w.links,n.event.flags?w.flags=n.event.flags:delete w.flags,"number"==typeof n.event.consent&&(w.consent=n.event.consent)),mainUpdate(28672),meshserver.send({action:"meshes"}),meshserver.send({action:"nodes",skip:null==devicePagingState?0:devicePagingState.skip});break;case"deleteusergroup":if(null!=usergroups&&null!=usergroups[n.event.ugrpid]){delete usergroups[n.event.ugrpid];var S=0;for(l in usergroups)S++;0==S&&(usergroups=null),mainUpdate(24576)}break;case"createmesh":null!=meshes[n.event.meshid]||!serverinfo.manageAllDeviceGroups&&null==n.event.mesh.links[userinfo._id]||(meshes[n.event.meshid]=n.event.mesh,mainUpdate(24708),meshserver.send({action:"files"}));break;case"meshchange":if(null==meshes[n.event.meshid]){var A=!1;for(l in null!=n.event.links[userinfo._id]&&(A=!0),null!=userinfo.links[n.event.meshid]&&(A=!0),userinfo.links)l.startsWith("ugrp/")&&null!=n.event.links[l]&&(A=!0);A&&(meshes[n.event.meshid]={_id:n.event.meshid,name:n.event.name,mtype:n.event.mtype,desc:n.event.desc,links:n.event.links,amt:n.event.amt,invite:n.event.invite,expireDevs:n.event.expireDevs,relayid:n.event.relayid},meshserver.send({action:"nodes",skip:null==devicePagingState?0:devicePagingState.skip}))}else{if(null!=n.event.name)for(var l in meshes[n.event.meshid].name=n.event.name,nodes)nodes[l].meshid==n.event.meshid&&(nodes[l].meshnamel=n.event.name.toLowerCase());if(null!=n.event.desc&&(meshes[n.event.meshid].desc=n.event.desc),null!=n.event.flags&&(meshes[n.event.meshid].flags=n.event.flags),null!=n.event.consent&&(meshes[n.event.meshid].consent=n.event.consent),n.event.links&&(meshes[n.event.meshid].links=n.event.links),n.event.amt&&(meshes[n.event.meshid].amt=n.event.amt),null!=n.event.invite?meshes[n.event.meshid].invite=n.event.invite:delete meshes[n.event.meshid].invite,null!=n.event.expireDevs&&(0<n.event.expireDevs?meshes[n.event.meshid].expireDevs=n.event.expireDevs:delete meshes[n.event.meshid].expireDevs),null!=n.event.relayid&&(meshes[n.event.meshid].relayid=n.event.relayid),0==IsMeshViewable(n.event.meshid)){20==xxcurrentView&&currentMesh==meshes[n.event.meshid]&&go(2),delete meshes[n.event.meshid];var D=[];for(l in nodes)(nodes[l].meshid!=n.event.meshid||null!=userinfo.links&&null!=userinfo.links[nodes[l]._id])&&D.push(nodes[l]);nodes=D,10<=xxcurrentView&&xxcurrentView<20&&currentNode&&!IsNodeViewable(currentNode)&&(setDialogMode(0),go(1))}}mainUpdate(24708),currentNode&&!IsNodeViewable(currentNode)&&(currentNode=null,10<=xxcurrentView)&&xxcurrentView<20&&go(1),20==xxcurrentView&&currentMesh._id==n.event.meshid&&mainUpdate(4096);break;case"deletemesh":meshes[n.event.meshid]&&(delete meshes[n.event.meshid],mainUpdate(128),meshserver.send({action:"files"}));D=[];if(null!=nodes)for(var l in nodes)nodes[l].meshid!=n.event.meshid&&D.push(nodes[l]);nodes=D,mainUpdate(24580),20<=xxcurrentView&&xxcurrentView<30&&currentMesh._id==n.event.meshid&&(setDialogMode(0),go(2)),10<=xxcurrentView&&xxcurrentView<20&&currentNode&&!IsNodeViewable(currentNode)&&(setDialogMode(0),go(1));break;case"addnode":var T=n.event.node;meshes[T.meshid]&&null==getNodeFromId(T._id)&&(T.namel=T.name.toLowerCase(),T.rname?T.rnamel=T.rname.toLowerCase():T.rnamel=T.namel,T.meshnamel=meshes[T.meshid]?meshes[T.meshid].name.toLowerCase():"*",T.state=0,T.icon||(T.icon=1),T.ident=++nodeShortIdent,nodes.push(T),mainUpdate(23),20==xxcurrentView)&&null!=currentMesh&&currentMesh._id==T.meshid&&mainUpdate(4096);break;case"removenode":d=-1;for(l in nodes)if(nodes[l]._id==n.event.nodeid){d=l;break}-1!=d&&(T=nodes[d],currentNode==T&&(10<=xxcurrentView&&xxcurrentView<20&&(setDialogMode(0),go(1)),currentNode=null),nodes.splice(d,1),mainUpdate(20),20==xxcurrentView)&&null!=currentMesh&&currentMesh._id==T.meshid&&mainUpdate(4096);break;case"changenode":d=-1;for(l in nodes)if(nodes[l]._id==n.event.nodeid){d=l;break}if(-1!=d){if((T=nodes[d]).name=n.event.node.name,T.rname=n.event.node.rname,T.lusers=n.event.node.lusers,T.users=n.event.node.users,T.host=n.event.node.host,T.desc=n.event.node.desc,T.ip=n.event.node.ip,T.osdesc=n.event.node.osdesc,T.publicip=n.event.node.publicip,T.iploc=n.event.node.iploc,T.wifiloc=n.event.node.wifiloc,T.gpsloc=n.event.node.gpsloc,T.tags=n.event.node.tags,T.ssh=n.event.node.ssh,T.rdp=n.event.node.rdp,T.userloc=n.event.node.userloc,T.rdpport=n.event.node.rdpport,T.rfbport=n.event.node.rfbport,T.sshport=n.event.node.sshport,T.httpport=n.event.node.httpport,T.httpsport=n.event.node.httpsport,T.consent=n.event.node.consent,T.pmt=n.event.node.pmt,null!=n.event.node.links?T.links=n.event.node.links:delete T.links,null!=n.event.node.agent&&(null==T.agent&&(T.agent={}),null!=n.event.node.agent.ver&&(T.agent.ver=n.event.node.agent.ver),null!=n.event.node.agent.id&&(T.agent.id=n.event.node.agent.id),null!=n.event.node.agent.caps&&(T.agent.caps=n.event.node.agent.caps),null!=n.event.node.agent.root&&(T.agent.root=n.event.node.agent.root),null!=n.event.node.agent.core?T.agent.core=n.event.node.agent.core:T.agent.core&&delete T.agent.core,T.agent.tag=n.event.node.agent.tag),null!=n.event.node.intelamt&&(null==T.intelamt&&(T.intelamt={}),null!=n.event.node.intelamt.state&&(T.intelamt.state=n.event.node.intelamt.state),null!=n.event.node.intelamt.host&&(T.intelamt.user=n.event.node.intelamt.host),null!=n.event.node.intelamt.user?T.intelamt.user=n.event.node.intelamt.user:delete T.intelamt.user,null!=n.event.node.intelamt.tls&&(T.intelamt.tls=n.event.node.intelamt.tls),null!=n.event.node.intelamt.ver&&(T.intelamt.ver=n.event.node.intelamt.ver),null!=n.event.node.intelamt.tag&&(T.intelamt.tag=n.event.node.intelamt.tag),null!=n.event.node.intelamt.uuid&&(T.intelamt.uuid=n.event.node.intelamt.uuid),null!=n.event.node.intelamt.realm&&(T.intelamt.realm=n.event.node.intelamt.realm),null!=n.event.node.intelamt.flags&&(T.intelamt.flags=n.event.node.intelamt.flags),null!=n.event.node.intelamt.warn?T.intelamt.warn=n.event.node.intelamt.warn:delete T.intelamt.warn),null!=n.event.node.av&&(T.av=n.event.node.av),null!=n.event.node.wsc&&(T.wsc=n.event.node.wsc),null!=n.event.node.volumes&&(T.volumes=n.event.node.volumes),T.namel=T.name.toLowerCase(),T.rname?T.rnamel=T.rname.toLowerCase():T.rnamel=T.namel,n.event.node.icon&&(T.icon=n.event.node.icon),n.event.node.meshid!=T.meshid)if(null!=meshes[n.event.node.meshid]||null!=userinfo.links&&null!=userinfo.links[T._id])T.meshid=n.event.node.meshid,T.meshnamel=meshes[n.event.node.meshid]?meshes[n.event.node.meshid].name.toLowerCase():"*",mainUpdate(7);else{null!=currentNode&&currentNode._id==T._id&&10<=xxcurrentView&&xxcurrentView<20&&!IsNodeViewable(currentNode)&&(currentNode=null,setDialogMode(0),go(1));d=-1;for(l in nodes)if(nodes[l]._id==n.event.nodeid){d=l;break}nodes.splice(d,1),mainUpdate(20)}updateDeviceViewDevice(T),mainUpdate(26),refreshDevice(T._id),20==xxcurrentView&&null!=currentMesh&&currentMesh._id==T.meshid&&mainUpdate(4096),currentNode==T&&null!=xxdialogMode&&"@xxmap"==xxdialogTag&&p10showNodeLocationDialog()}break;case"nodemeshchange":d=-1;for(l in nodes)if(nodes[l]._id==n.event.nodeid){d=l;break}if(-1!=d){T=nodes[d];null!=meshes[n.event.newMeshId]||null!=userinfo.links&&null!=userinfo.links[T._id]?(T.meshid=n.event.newMeshId,T.meshnamel=meshes[n.event.newMeshId]?meshes[n.event.newMeshId].name.toLowerCase():"*",mainUpdate(7)):(null!=currentNode&&currentNode._id==T._id&&10<=xxcurrentView&&xxcurrentView<20&&!IsNodeViewable(currentNode)&&(currentNode=null,setDialogMode(0),go(1)),nodes.splice(d,1),mainUpdate(20)),refreshDevice(n.event.nodeid)}else{T=n.event.node;if(!meshes[T.meshid])break;T.namel=T.name.toLowerCase(),T.rname?T.rnamel=T.rname.toLowerCase():T.rnamel=T.namel,T.meshnamel=meshes[T.meshid]?meshes[T.meshid].name.toLowerCase():"*",T.state=0,T.icon||(T.icon=1),T.ident=++nodeShortIdent,nodes.push(T),mainUpdate(23)}break;case"nodeconnect":var E,d=-1;for(l in nodes)if(nodes[l]._id==n.event.nodeid){d=l;break}-1!=d&&(T=nodes[d],r=getstore("notifications",0),n.event.meshid&&userinfo.links&&userinfo.links[n.event.meshid]&&userinfo.links[n.event.meshid].notify&&(r|=userinfo.links[n.event.meshid].notify),null!=userinfo.notify&&(null!=userinfo.notify[n.event.meshid]&&(r|=userinfo.notify[n.event.meshid]),null!=userinfo.notify[n.event.nodeid])&&(r|=userinfo.notify[n.event.nodeid]),2&r&&(b="代理已連接",null!=T.agent&&!1===T.agent.root&&(b="與有限特權相關的代理"),E={title:T.name,icon:T.icon,nodeid:T._id,id:n.event.id},0==(1&T.conn)&&0!=(1&n.event.conn)&&(E.text=b,addNotification(E)),0==(2&T.conn)&&0!=(2&n.event.conn)&&(E.text="檢測到英特爾 AMT",addNotification(E)),0==(4&T.conn)&&0!=(4&n.event.conn)&&(E.text="英特爾 AMT CIRA 已連接",addNotification(E)),0==(16&T.conn))&&0!=(16&n.event.conn)&&(E.text="MQTT已連接",addNotification(E)),4&r&&(E={title:T.name,icon:T.icon,nodeid:T._id,id:n.event.id},0!=(1&T.conn)&&0==(1&n.event.conn)&&(E.text="代理已斷開連接",addNotification(E)),0!=(2&T.conn)&&0==(2&n.event.conn)&&(E.text="未檢測到英特爾 AMT",addNotification(E)),0!=(4&T.conn)&&0==(4&n.event.conn)&&(E.text="英特爾 AMT CIRA 斷開連接",addNotification(E)),0!=(16&T.conn))&&0==(16&n.event.conn)&&(E.text="MQTT已斷開連接",addNotification(E)),T.conn=n.event.conn,T.pwr=n.event.pwr,T.lastconnect=Date.now(),0==(1&T.conn)&&delete T.sessions,1==(M=Q("DevFilterSelect").value)||5==M?mainUpdate(21):(updateDeviceViewDevice(T),mainUpdate(17)),refreshDevice(T._id),20==xxcurrentView)&&null!=currentMesh&&currentMesh._id==T.meshid&&mainUpdate(4096);break;case"wssessioncount":null!=wssessions&&(0==n.event.count&&wssessions[n.event.userid]?delete wssessions[n.event.userid]:wssessions[n.event.userid]=n.event.count,mainUpdate(16384));break;case"login":null!=users&&users[n.event.userid]&&(users[n.event.userid].login=Math.floor(new Date(n.event.time).getTime()/1e3));break;case"scanamtdevice":if(null==xxdialogMode||!Q("dp1range")||xxdialogTag!="AMTSCAN:"+n.event.range)return;e="";if(null==n.event.results)e="<div style=width:100%;text-align:center;margin-top:12px>無法掃描該地址範圍。</div><div style=width:100%;text-align:center;margin-top:12px;color:gray;line-height:1.5>IP範圍值樣本<br />192.168.0.100<br />192.168.1.0/24<br />192.167.0.1-192.168.0.100</div>";else{for(var l in amtScanResults=n.event.results,n.event.results){var _=n.event.results[l],N=_.hostname,N=(20<(N="host"==_.hosttype?capitalizeFirstLetter(N.split(".")[0]):N).length&&(N=N.substring(0,20)+"..."),'<b title="'+EscapeHtml(_.hostname)+'">'+EscapeHtml(N)+"</b> - v"+_.ver);2==_.state?1==_.tls?N+=" TLS。":N+=" 沒有TLS。":N+=" not activated.",e+='<div style=width:100%;margin-bottom:2px;background-color:lightgray><div style=padding:4px><div style=display:inline-block;margin-right:5px><input class="DevScanCheckbox form-check-input me-2" name=dp1checkbox tag="'+EscapeHtml(l)+'" type=checkbox onclick=addAmtScanToMeshCheckbox() /></div><div class=j1 style=display:inline-block></div><div style=display:inline-block;margin-left:5px;overflow-x:auto;white-space:nowrap>'+N+"</div></div></div>"}""==e&&(e="<div style=width:100%;text-align:center;margin-top:12px>掃描未有任何結果。</div><div style=width:100%;text-align:center;margin-top:12px;color:gray;line-height:1.5>IP範圍值樣本<br />192.168.0.100<br />192.168.1.0/24<br />192.167.0.1-192.168.0.100</div>")}QH("dp1results",e),QE("dp1range",!0),QE("dp1rangebutton",!0),QE("d2scanSelectButton",!0);break;case"notify":r={text:n.event.value,title:n.event.title,icon:n.event.icon,titleid:n.titleid,msgid:n.msgid,args:n.args};null!=n.id&&(r.id=n.id),null!=n.event.tag&&(r.tag=n.event.tag),"number"==typeof n.maxtime&&(r.maxtime=n.maxtime),addNotification(r);break;case"traceinfo":"object"==typeof n.event.traceSources&&(null!=n.event.traceSources&&0<n.event.traceSources.length?(serverTraceSources=n.event.traceSources,QH("p41traceStatus",EscapeHtml(n.event.traceSources.join(", ")))):(serverTraceSources=[],QH("p41traceStatus","沒有")));break;case"sysinfohash":null!=currentNode&&n.event.nodeid==powerTimelineReq&&meshserver.send({action:"getsysinfo",nodeid:n.event.nodeid});break;case"ifchange":null!=currentNode&&currentNode._id==n.event.nodeid&&meshserver.send({action:"getnetworkinfo",nodeid:currentNode._id});break;case"devicesessions":if(null!=(T=getNodeFromId(n.event.nodeid))){if(T.sessions=n.event.sessions,null!=T.sessions){for(var l in T.sessions)0==Object.keys(T.sessions[l]).length&&delete T.sessions[l];0==Object.keys(T.sessions).length&&delete T.sessions}updateDeviceViewDevice(T),null!=currentNode&&currentNode._id==n.event.nodeid&&gotoDevice(currentNode._id,xxcurrentView,!0),xxdialogTag=="SESSIONS-"+n.event.nodeid&&showDeviceSessions(n.event.nodeid,!0),xxdialogTag=="MESSAGES-"+n.event.nodeid&&showDeviceMessages(n.event.nodeid,!0),xxdialogTag=="HELPREQ-"+n.event.nodeid&&showDeviceHelpRequests(n.event.nodeid,!0),2!=Q("DevFilterSelect").value&&6!=Q("DevFilterSelect").value||mainUpdate(1)}break;case"loginTokenChanged":if(n.event.userid!=userinfo._id)return;loginTokens=n.event.loginTokens,mainUpdate(65536);break;case"loginTokenAdded":if(n.event.userid!=userinfo._id)return;(loginTokens=null==loginTokens?[]:loginTokens).push(n.event.newToken),mainUpdate(65536);break;case"stopped":break;case"updatePluginList":installedPluginList=n.event.list,updatePluginList();break;case"pluginStateChange":null!=pluginHandler&&pluginHandler.refreshPluginHandler();break;case"plugin":if(null!=pluginHandler)try{pluginHandler[n.event.plugin][n.event.pluginaction](n)}catch(e){console.log("PluginHandler無法事件消息：",e)}}break;case"createInviteLink":var I,V;xxdialogTag==n.meshid&&(-1!=(I=serverinfo.name).indexOf(".")&&0==(2&features)||(I=window.location.hostname),domainUrl.substring(0,domainUrl.length-1),V=1==serverinfo.https?"https://"+I+(443==serverinfo.port?"":":"+serverinfo.port)+domainUrl+"agentinvite?c="+n.cookie+(urlargs.key?"&key="+urlargs.key:""):"http://"+I+(80==serverinfo.port?"":":"+serverinfo.port)+domainUrl+"agentinvite?c="+n.cookie+(urlargs.key?"&key="+urlargs.key:""),Q("agentInvitationLink").href=V,p=format(1==n.expire?"1小時":"{0}小時",n.expire),24==n.expire&&(p="1天"),168==n.expire&&(p="1週"),5040==n.expire&&(p="1個月"),0==n.expire&&(p="無限"),QH("agentInvitationLink",format("邀請鏈結（{0}）",p)),QV("agentInvitationLinkDiv",!0));break;case"createDeviceShareLink":var U;xxdialogTag||(e="",null!=(T=getNodeFromId(n.nodeid))&&(e=(e=(e+=addHtmlValue("裝置",T.name))+addHtmlValue("來賓姓名",n.guestname))+addHtmlValue("用戶輸入",n.viewOnly?"不允許，只能查看":"允許"),n.start&&n.expire&&(n.recurring?(e+=addHtmlValue("開始時間",printDateTime(new Date(n.start))),n.expire,e+=addHtmlValue("持續時間",format("{0} 分鐘",n.expire))):e=(e+=addHtmlValue("開始時間",printDateTime(new Date(n.start))))+addHtmlValue("到期時間",printDateTime(new Date(n.expire)))),1==n.recurring&&(e+=addHtmlValue("再次發生的","日常的")),2==n.recurring&&(e+=addHtmlValue("再次發生的","每週")),t=[],7&n.consent&&t.push("通知"),56&n.consent&&t.push("提示"),64&n.consent&&t.push("隱私欄"),0==t.length&&t.push("沒有"),e+=addHtmlValue("用戶同意",t.join(", ")),U="",n.p<=7?U=["","遠程終端鏈接","遠程桌面鏈結","遠程桌面+終端鏈接","遠程文件鏈接","遠程終端+文件鏈接","遠程桌面 + 文件鏈接","遠程桌面 + 終端 + 文件鏈接"][n.p]:8==n.p?U=format("HTTP/{0} link",n.port):16==n.p&&(U=format("HTTPS/{0}",n.port)),setModalContent("xxAddAgent","共享裝置",e+='<div id=agentInvitationLinkDiv style="text-align:center;font-size:large;margin:16px"><a href="'+n.url+'" id=agentInvitationLink rel="noreferrer noopener" target="_blank" style=cursor:pointer>'+U+'</a> <i class="fa-regular fa-copy" title="複製連結到剪貼板" style=cursor:pointer onclick=d2CopyInviteToClip()></i></div></div>'),showModal("xxAddAgentModal","idx_dlgOkButton")));break;case"getmqttlogin":if(null==currentNode||currentNode._id!=n.nodeid||null!=xxdialogMode)return;e="這些設置可用於連接該裝置的MQTT。<br /><br />";delete n.action,delete n.nodeid,setModalContent("xxAddAgent","MQTT憑證",e+="<textarea readonly=readonly style=width:100%;resize:none;height:100px;overflow:auto;font-size:12px readonly>"+JSON.stringify(n)+"</textarea>"),showModal("xxAddAgentModal","idx_dlgOkButton");break;case"stopped":autoReconnect=!1,QH("p0span",n.msg);break;case"updatePluginList":installedPluginList=n.list,updatePluginList();break;case"pluginVersionsAvailable":null!=pluginHandler&&updatePluginList(n.list);break;case"downgradePluginVersions":var q='<select id="lastPluginVersion">';n.info.versionList.forEach(function(e){q+='<option value="'+e.zipball_url+'">'+e.name+"</option>"}),q+="</select>",setModalContent("xxAddAgent","外掛指令",format("Select the version to downgrade the plugin: {0}",n.info.name)+"<hr />"+q+"<hr />請注意，不建議降級。請僅在最近的升級後發生問題時才這樣做。NaN"+n.info.id+'" />'),showModal("xxAddAgentModal","idx_dlgOkButton",pluginActionEx);break;case"serverBackup":"googleDrive"==n.service&&(QV("p2ServerActionsGoogleBackup",0<n.state),QV("p2ServerActionsGoogleBackupCheck",2<n.state),miscState.googleDrive={state:n.state},2==n.state)&&(e='<img style=float:right src="images/googledrive-48.png" /><div>導航到下面的URL，授予訪問權限並將令牌代碼複製回去。</div><br />',setModalContent("xxAddAgent","Google雲端硬盤備份",e=(e+=addHtmlValue("啟動",'<a href="'+n.url+'" rel="noreferrer noopener" target="_blank">Browse to this URL</a>'))+addHtmlFormFloating("碼","<input id=gdcode onkeyup=server_setupGoogleDriveBackupCheck3() class=form-control></input>")),showModal("xxAddAgentModal","idx_dlgOkButton",()=>server_setupGoogleDriveBackupEx(3,"gd2")),Q("gdcode").focus(),QE("idx_dlgOkButton",!1));break;case"pluginError":setModalContent("xxAddAgent","外掛錯誤",n.msg),showModal("xxAddAgentModal","idx_dlgOkButton");break;case"plugin":if(null!=pluginHandler&&"string"==typeof n.plugin)try{pluginHandler[n.plugin][n.method](H,n)}catch(e){console.log("Error loading plugin handler ("+e+")")}break;case"amtsetupbin":saveAs(new Blob([Uint8Array.from(atob(n.file),function(e){return e.charCodeAt(0)})],{type:"application/octet-stream"}),"setup.bin");break;case"previousLogins":null!=n.userid&&n.userid;var e="",S="BBB",R="";if(0==n.events.length)e+="No previous login.";else{for(var l in e+="<div style=max-height:260px;overflow-y:scroll;overflow-x:hidden><table>",n.events)107==(s=n.events[l].m)?(s="有效登錄",S="BBD1BB",R="",null!=n.events[l].tn&&(s=format("令牌：{0}",n.events[l].tn),S="88D188")):108==s?(s="無效的 2FA",S="DD9DC3",R="x"):109==s?(s="被鎖定賬戶",S="E1BBBB",R="x"):110==s&&(s="無效的密碼",S="E1BBBB",R="x"),e+="<tr><td><img src=images/user-32"+R+'.png height=32 width=32 style=float:left srcset="images/user-64'+R+'.png 2x"><td><div style=width:300px;background-color:#'+S+";border-radius:6px;margin-bottom:4px;padding:4px><div>"+printDateTime(new Date(n.events[l].t))+", <b>"+EscapeHtml(s)+"</b></div><div style=font-size:x-small>"+EscapeHtml(n.events[l].a.join(", "))+"</div></div></tr>";e+="</table></div>"}setModalContent("xxAddAgent","以前的登錄",e),showModal("xxAddAgentModal","idx_dlgOkButton");break;case"getDeviceDetails":saveAs(new Blob([n.data],{type:"application/octet-stream"}),"設備列表."+n.type);break;case"createLoginToken":if(xxdialogMode)return;e="記下這個用戶名和密碼，密碼不能再顯示。<br /><br />";e+=addHtmlValue("名稱",EscapeHtml(n.name)),0!=n.expire&&(e+=addHtmlValue("到期",EscapeHtml(printDateTime(new Date(n.expire))))),setModalContent("xxAddAgent","創建登錄令牌",e=(e+=addHtmlValue("用戶名",'<i class="fa-regular fa-copy" title="複製連結到剪貼板" style="margin:9px;cursor:pointer;float:right" onclick=copyTextToClip2("'+encodeURIComponentEx(n.tokenUser)+'")></i><div class=selecttext style=width:230px;padding:5px;background-color:orange;border-radius:5px;font-size:15px>'+EscapeHtml(n.tokenUser)+"</div>"))+addHtmlValue("密碼",'<i class="fa-regular fa-copy" title="複製連結到剪貼板" style="margin:9px;cursor:pointer;float:right" onclick=copyTextToClip2("'+encodeURIComponentEx(n.tokenPass)+'")></i><div class=selecttext style=width:230px;padding:5px;background-color:orange;border-radius:5px;font-size:15px>'+EscapeHtml(n.tokenPass)+"</div>")),showModal("xxAddAgentModal","idx_dlgOkButton");break;case"loginTokens":loginTokens=n.loginTokens,mainUpdate(65536);break;case"report":renderReport(n.data)}}function gotoStartViewPage(){var e=parseInt("{{viewmode}}");if(-1==xxcurrentView){if(""!="{{currentNode}}".toLowerCase()){if(null==getNodeFromId("{{currentNode}}"))return;gotoDevice("{{currentNode}}",e)}else if(null!=args.gotonode){if(96==args.gotonode.length&&(args.gotonode=btoa(hex2rstr(args.gotonode)).split("+").join("@").split("/").join("$")),null==getNodeFromId("node/"+domain+"/"+args.gotonode))return;gotoDevice("node/"+domain+"/"+args.gotonode,e),goBackStack.push(1)}else if(null!=args.gotodevicename){var t=null;if(null!=nodes)for(var n in nodes)nodes[n].name==args.gotodevicename&&(t=nodes[n]._id);t&&(gotoDevice(t,e),goBackStack.push(1))}else if(null!=args.gotodeviceip){t=null;if(null!=nodes)for(var n in nodes)nodes[n].ip==args.gotodeviceip&&(t=nodes[n]._id);t&&(gotoDevice(t,e),goBackStack.push(1))}else if(null!=args.gotomesh){if(null==meshes["mesh/"+domain+"/"+args.gotomesh])return;gotoMesh("mesh/"+domain+"/"+args.gotomesh),go(e),goBackStack.push(2)}else if(null!=args.gotouser){var o=args.gotouser;if(args.gotouser.indexOf("/")<0&&(o="user/"+domain+"/"+args.gotouser),null==users||null==users[o])return;gotoUser(encodeURIComponentEx(o)),go(e),goBackStack.push(4)}else if(null!=args.gotougrp){o=args.gotougrp;if(args.gotougrp.indexOf("/")<0&&(o="ugrp/"+domain+"/"+args.gotougrp),null==usergroups||null==usergroups[o])return;gotoUserGroup(o),go(e),goBackStack.push(50)}else isNaN(e)?(setDialogMode(0),go(1)):go(e);delete args.gotonode,delete args.gotomesh,delete args.gotouser,delete args.gotougrp}}function topMenu(e){null!=xxdialogMode&&0!=xxdialogMode&&999!=xxdialogMode||(void 0===e?1==("none"==QS("topMenu").display)?0!=xxdialogMode&&null!=xxdialogMode||(QV("topMenu",!0),xxdialogMode=999):(QV("topMenu",!1),xxdialogMode=0):(QV("topMenu",!1),xxdialogMode=0,1==e&&goForward("devices"),2==e&&goForward("account"),3==e&&goForward("events"),4==e&&goForward("users"),5==e&&goForward("files"),6==e&&goForward("server")))}function onRealNameCheckBox(){putstore("showRealNames",(showRealNames=Q("RealNameCheckBox").checked)?1:0),mainUpdate(7)}function onOnlineCheckBox(e){putstore("devFilterSelect",Q("DevFilterSelect").value),onDeviceSearchChanged(e)}function updateDevicePageState(){var e,t;null==devicePagingState||devicePagingState.total<=devicePagingState.limit?(QV("devViewPageState",!1),QV("devViewPageButton1",!1),QV("devViewPageButton2",!1),QV("devViewPageButton3",!1),QV("devViewPageButton4",!1)):(e=Math.floor((devicePagingState.skip+devicePagingState.limit)/devicePagingState.limit),t=Math.ceil(devicePagingState.total/devicePagingState.limit),QV("devViewPageState",!0),QV("devViewPageButton1",!0),QV("devViewPageButton2",!0),QV("devViewPageButton3",!0),QV("devViewPageButton4",!0),QH("devViewPageState",e+"/"+t))}function onDeviceViewPageChange(e){if(null!=devicePagingState){var t=Math.floor((devicePagingState.skip+devicePagingState.limit)/devicePagingState.limit),n=Math.ceil(devicePagingState.total/devicePagingState.limit);switch(e){case 1:1<t&&meshserver.send({action:"nodes",skip:0});break;case 2:1<t&&meshserver.send({action:"nodes",skip:(t-2)*devicePagingState.limit});break;case 3:t<n&&meshserver.send({action:"nodes",skip:t*devicePagingState.limit});break;case 4:t<n&&meshserver.send({action:"nodes",skip:(n-1)*devicePagingState.limit})}}}function onDeviceViewChange(e){null!=e&&(Q("viewselect").value=e);for(var t=1;t<6;t++)Q("devViewButton"+t).classList.remove("viewSelectorSel");Q("devViewButton"+Q("viewselect").value).classList.add("viewSelectorSel"),putstore("deviceView",Q("viewselect").value),putstore("viewsize",Q("sizeselect").value),mainUpdate(4),setTimeout(function(){mainUpdate(512)},200)}function onDeviceViewSettings(){var e;xxdialogMode||(null==deviceViewSettings&&(deviceViewSettings={}),Array.isArray(deviceViewSettings.devsCols)||(deviceViewSettings.devsCols=["user","ip","conn"]),e="",setModalContent("xxAddAgent","設備視圖列",e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e+='<label><input id=d2c8 type=checkbox class="form-check-input me-2"'+(0<=deviceViewSettings.devsCols.indexOf("agtype")?" checked":"")+">代理類型</label><br />")+('<label><input id=d2c9 type=checkbox class="form-check-input me-2"'+(0<=deviceViewSettings.devsCols.indexOf("agver")?" checked":"")+">代理版本</label><br />"))+('<label><input id=d2c6 type=checkbox class="form-check-input me-2"'+(0<=deviceViewSettings.devsCols.indexOf("desc")?" checked":"")+">設備描述</label><br />"))+('<label><input id=d2c5 type=checkbox class="form-check-input me-2"'+(0<=deviceViewSettings.devsCols.indexOf("os")?" checked":"")+">操作系統</label><br />"))+('<label><input id=d2c10 type=checkbox class="form-check-input me-2"'+(0<=deviceViewSettings.devsCols.indexOf("tags")?" checked":"")+">標籤</label><br />"))+('<label><input id=d2c11 type=checkbox class="form-check-input me-2"'+(0<=deviceViewSettings.devsCols.indexOf("windowsav")?" checked":"")+">Windows AV</label><br />"))+('<label><input id=d2c12 type=checkbox class="form-check-input me-2"'+(0<=deviceViewSettings.devsCols.indexOf("windowsupdate")?" checked":"")+">Windows Update</label><br />"))+('<label><input id=d2c13 type=checkbox class="form-check-input me-2"'+(0<=deviceViewSettings.devsCols.indexOf("windowsfirewall")?" checked":"")+">Windows Firewall</label><br />"))+('<label><input id=d2c14 type=checkbox class="form-check-input me-2"'+(0<=deviceViewSettings.devsCols.indexOf("lastbootuptime")?" checked":"")+">Last Boot Up Time</label><br />"))+('<label><input id=d2c1 type=checkbox class="form-check-input me-2"'+(0<=deviceViewSettings.devsCols.indexOf("links")?" checked":"")+">MeshCentral 路由器鏈接</label><br />"))+('<label><input id=d2c2 type=checkbox class="form-check-input me-2"'+(0<=deviceViewSettings.devsCols.indexOf("user")?" checked":"")+">登錄用戶</label><br />"))+('<label><input id=d2c3 type=checkbox class="form-check-input me-2"'+(0<=deviceViewSettings.devsCols.indexOf("ip")?" checked":"")+">代理 IP 地址</label><br />"))+('<label><input id=d2c4 type=checkbox class="form-check-input me-2"'+(0<=deviceViewSettings.devsCols.indexOf("conn")?" checked":"")+">服務器連接</label><br />"))+('<label><input id=d2c7 type=checkbox class="form-check-input me-2"'+(0<=deviceViewSettings.devsCols.indexOf("lastseen")?" checked":"")+">最後一次露面</label><br />"))+('<label><input id=d2c15 type=checkbox class="form-check-input me-2"'+(0<=deviceViewSettings.devsCols.indexOf("amthost")?" checked":"")+">Intel&reg; AMT hostname</label><br />"))+('<label><input id=d2c17 type=checkbox class="form-check-input me-2"'+(0<=deviceViewSettings.devsCols.indexOf("amtstate")?" checked":"")+">Intel&reg; AMT state</label><br />")),showModal("xxAddAgentModal","idx_dlgOkButton",()=>onDeviceViewSettingsEx()))}function onDeviceViewSettingsEx(){var e=[];Q("d2c1").checked&&e.push("links"),Q("d2c2").checked&&e.push("user"),Q("d2c3").checked&&e.push("ip"),Q("d2c4").checked&&e.push("conn"),Q("d2c5").checked&&e.push("os"),Q("d2c6").checked&&e.push("desc"),Q("d2c7").checked&&e.push("lastseen"),Q("d2c8").checked&&e.push("agtype"),Q("d2c9").checked&&e.push("agver"),Q("d2c10").checked&&e.push("tags"),Q("d2c11").checked&&e.push("windowsav"),Q("d2c12").checked&&e.push("windowsupdate"),Q("d2c13").checked&&e.push("windowsfirewall"),Q("d2c14").checked&&e.push("lastbootuptime"),Q("d2c15").checked&&e.push("amthost"),Q("d2c17").checked&&e.push("amtstate"),deviceViewSettings.devsCols=e,putstore("_deviceViewSettings",JSON.stringify(deviceViewSettings)),mainUpdate(4)}function ondockeypress(e){if(!document.querySelector(".modal.show")){if(setSessionActivity(),!xxdialogMode&&11==xxcurrentView&&desktop&&Q("DeskControl").checked){if(null!=currentNode){var t=GetNodeRights(currentNode);if(0==(0==(8192&features2)&&(4294967295==t||0!=(8&t)&&0==(256&t))))return!1;t=4294967295!=t&&0!=(8&t)&&0==(256&t)&&0!=(4096&t);if(1==t&&(1==e.altKey||1==e.ctrlKey||e.keyCode<32&&8!=e.keyCode&&13!=e.keyCode||90<e.keyCode))return!1}return desktop.m.handleKeys(e)}if(!xxdialogMode&&12==xxcurrentView&&terminal&&3==terminal.State&&null==xterm)return terminal.m.TermHandleKeys(e);if(!xxdialogMode&&(15==xxcurrentView||115==xxcurrentView))return agentConsoleHandleKeys(e);if(!xxdialogMode&&4==xxcurrentView){if(1==e.ctrlKey||1==e.altKey||1==e.metaKey)return;var n=0;if(e.key?(1===e.key.length&&0==userSearchFocus&&(Q("UserSearchInput").value=Q("UserSearchInput").value+e.key,n=1),8==e.keyCode&&0==userSearchFocus&&(o=Q("UserSearchInput").value,Q("UserSearchInput").value=o.substring(0,o.length-1),n=1),27==e.keyCode&&(Q("UserSearchInput").value="",n=1)):0!=e.charCode&&0==userSearchFocus&&(Q("UserSearchInput").value=Q("UserSearchInput").value+String.fromCharCode(e.charCode),n=1),0<n)return 1==n&&onUserSearchInputChanged(),haltEvent(e)}if(!xxdialogMode&&1==xxcurrentView)if(1==e.ctrlKey&&96==e.charCode)showRealNames=!showRealNames,putstore("showRealNames",(Q("RealNameCheckBox").value=showRealNames)?1:0),mainUpdate(6);else if(1!=e.ctrlKey&&1!=e.altKey&&1!=e.metaKey){if(Q("viewselect").value<4){var o,n=0;if(e.key?(1===e.key.length&&0==searchFocus&&(Q("KvmSearchInput").value=Q("SearchInput").value=Q("SearchInput").value+e.key,n=1),8==e.keyCode&&0==searchFocus&&(o=Q("SearchInput").value,Q("KvmSearchInput").value=Q("SearchInput").value=o.substring(0,o.length-1),n=1),27==e.keyCode&&(Q("KvmSearchInput").value=Q("SearchInput").value="",n=1)):0!=e.charCode&&0==searchFocus&&(Q("KvmSearchInput").value=Q("SearchInput").value=Q("SearchInput").value+String.fromCharCode(e.charCode),n=1),0<n)return 1==n&&mainUpdate(5),haltEvent(e)}4==Q("viewselect").value&&(e.key?(1===e.key.length&&0==mapSearchFocus&&(Q("mapSearchLocation").value=Q("mapSearchLocation").value+e.key,n=1),27==e.keyCode&&(Q("mapSearchLocation").value="",mapCloseSearchWindow(),n=1),13==e.keyCode&&getSearchLocation()):0!=e.charCode&&0==mapSearchFocus&&(Q("mapSearchLocation").value=Q("mapSearchLocation").value+String.fromCharCode(e.charCode)))}}}function ondockeydown(e){if(setSessionActivity(),!xxdialogMode&&11==xxcurrentView&&desktop&&Q("DeskControl").checked){if(null!=currentNode){var t=GetNodeRights(currentNode);if(0==(0==(8192&features2)&&(4294967295==t||0!=(8&t)&&0==(256&t))))return!1;t=4294967295!=t&&0!=(8&t)&&0==(256&t)&&0!=(4096&t);if(1==t&&(1==e.altKey||1==e.ctrlKey||e.keyCode<32&&8!=e.keyCode&&13!=e.keyCode||90<e.keyCode))return!1}return desktop.m.handleKeyDown(e)}if(!xxdialogMode&&12==xxcurrentView&&terminal&&3==terminal.State&&null==xterm&&(terminal.m.TermHandleKeyDown(e),37<=e.keyCode)&&e.keyCode<=40&&haltEvent(e),!xxdialogMode&&13==xxcurrentView&&116==e.keyCode&&null!=p13filetree)return haltEvent(e),!1;if(!xxdialogMode&&(15==xxcurrentView||115==xxcurrentView))return agentConsoleHandleKeys(e);if(!xxdialogMode&&4==xxcurrentView&&(8===e.keyCode&&0==userSearchFocus&&(n=Q("UserSearchInput").value,Q("UserSearchInput").value=n.substring(0,n.length-1),o=1),27===e.keyCode&&(Q("UserSearchInput").value="",o=1),0<o))return 1==o&&mainUpdate(5),haltEvent(e);if(!xxdialogMode&&1==xxcurrentView&&1!=e.ctrlKey&&1!=e.altKey&&1!=e.metaKey){var n,o=0;if(Q("viewselect").value<4)if(8===e.keyCode&&0==searchFocus&&(n=Q("SearchInput").value,Q("KvmSearchInput").value=Q("SearchInput").value=n.substring(0,n.length-1),o=1),27===e.keyCode&&(Q("KvmSearchInput").value=Q("SearchInput").value="",o=1),0<o)return 1==o&&mainUpdate(5),haltEvent(e);4==Q("viewselect").value&&(8===e.keyCode&&0==mapSearchFocus&&(n=Q("mapSearchLocation").value,Q("mapSearchLocation").value=n.substring(0,n.length-1),o=1),27===e.keyCode)&&(Q("mapSearchLocation").value="",mapCloseSearchWindow())}}function ondockeyup(e){if(setSessionActivity(),!xxdialogMode&&11==xxcurrentView&&desktop&&Q("DeskControl").checked){if(null!=currentNode){var t=GetNodeRights(currentNode);if(0==(0==(8192&features2)&&(4294967295==t||0!=(8&t)&&0==(256&t))))return!1;t=4294967295!=t&&0!=(8&t)&&0==(256&t)&&0!=(4096&t);if(1==t&&(1==e.altKey||1==e.ctrlKey||e.keyCode<32&&8!=e.keyCode&&13!=e.keyCode||90<e.keyCode))return!1}return desktop.m.handleKeyUp(e)}return!xxdialogMode&&12==xxcurrentView&&terminal&&3==terminal.State&&null==xterm?terminal.m.TermHandleKeyUp(e):xxdialogMode||13!=xxcurrentView||116!=e.keyCode||null==p13filetree?xxdialogMode||4!=xxcurrentView||(8!==e.keyCode||0!=searchFocus)&&27!==e.keyCode?(xxdialogMode&&27==e.keyCode&&dialogclose(0),1!=e.shiftKey||27!=e.keyCode?!xxdialogMode&&0==xxcurrentView&&1!=e.ctrlKey&&1!=e.altKey&&1!=e.metaKey&&(Q("viewselect").value<4&&(8===e.keyCode&&0==searchFocus||27===e.keyCode)||4==Q("viewselect").value&&(8===e.keyCode&&0==mapSearchFocus||27===e.keyCode))?haltEvent(e):void 0:(dialogclose(0),Q("KvmSearchInput").value=Q("SearchInput").value="",mainUpdate(5),null!=desktop&&connectDesktop(),null!=terminal&&connectTerminal(),null!=files&&connectFiles(),void go(1))):haltEvent(e):(p13folderup(9999),haltEvent(e),!1)}function ondocblur(){if(!xxdialogMode&&11==xxcurrentView&&desktop&&Q("DeskControl").checked&&desktop.m.handleReleaseKeys)return desktop.m.handleReleaseKeys()}function devGrpMouseHover(e,t){setSessionActivity();Q("viewselect").value;e=e.children[1].children[1];e.children[0].classList.remove("g1s"),e.children[1].classList.remove("e2s"),e.children[2].classList.remove("g2s"),1==t&&(e.children[0].classList.add("g1s"),e.children[1].classList.add("e2s"),e.children[2].classList.add("g2s"))}function devMouseHover(e,t){setSessionActivity();var n,o=Q("viewselect").value;1==o?((n=e.children[0].children[0].children[1].children[0].children[0].children[0]).children[1].classList.remove("g1s"),n.children[2].classList.remove("e2s"),n.children[3].classList.remove("g2s"),1==t&&(n.children[1].classList.add("g1s"),n.children[2].classList.add("e2s"),n.children[3].classList.add("g2s"))):2==o&&((n=e).children[2].classList.remove("g1s"),n.children[4].classList.remove("e2s"),n.children[3].classList.remove("g2s"),1==t)&&(n.children[2].classList.add("g1s"),n.children[4].classList.add("e2s"),n.children[3].classList.add("g2s"))}var deviceHeaderCount,deviceHeaderId=0,deviceHeaderTotal=0,deviceHeadersTitles={},deviceHeaders={},oldviewmode=0;function updateDevices(){if(null!=nodes&&1==xxcurrentView){var e="",t=0,n=null,o={},i=Q("viewselect").value,s={},a={};if(QV("xdevices",4!=i),QV("xdevicesmap",4==i),QVH("devListToolbar",i<3),QVH("kvmListToolbar",3==i||5==i),QVH("devMapToolbar",4==i),QV("devListToolbarSize",3==i||5==i),QV("devListToolbarSettings",2==i),QV("NoMeshesPanel",0==nodes.length&&0==meshcount),QV("devListToolbarViewIcons",0<nodes.length),QV("devListToolbarSort",0<nodes.length&&4!=i),0==nodes.length&&(i=1,sort=0),4==i)setTimeout(function(){null!=xxmap.map&&xxmap.map.updateSize()},200);else{deviceHeaderCount={},deviceHeaders={},deviceHeadersTitles={};var l=[],r=((deviceHeaderTotal=deviceHeaderId=0)==sort?nodes.sort(meshSort):1==sort?nodes.sort(powerSort):2==sort?1==showRealNames?nodes.sort(deviceHostSort):nodes.sort(deviceSort):5==sort&&(deviceViewSettings&&deviceViewSettings.devsCols&&0<=deviceViewSettings.devsCols.indexOf("lastseen")||(0==requestedLastConnects&&(requestedLastConnects=!0,meshserver.send({action:"lastconnects"})),null==deviceViewSettings&&(deviceViewSettings={}),Array.isArray(deviceViewSettings.devsCols)?deviceViewSettings.devsCols.push("lastseen"):deviceViewSettings.devsCols=["user","ip","conn","lastseen"]),nodes.sort(lastConnectSort)),Q("column_l").clientWidth-60),d=Math.floor(r/301),d=301+Math.floor((r-301*d)/d),c=4;for(w in deviceViewSettings&&deviceViewSettings.devsCols&&(c=deviceViewSettings.devsCols.length+1,0<=deviceViewSettings.devsCols.indexOf("desc"))&&c--,nodes){var u=nodes[w];if(0!=u.v){var p,m,g=meshes[u.meshid],h=GetNodeRights(u);if(0==sort?(meshes[u.meshid]?u.meshid:"*")!=n&&(1!=i&&3!=i&&5!=i||null==n||(e+="</div>"),deviceHeaderSet(),p="",2==i&&(e+="<tr><td colspan="+c+">"),meshes[u.meshid]&&1==meshes[u.meshid].mtype&&(p="<span class=devHeaderx>，只適用於Intel&reg; AMT</span>"),meshes[u.meshid]&&3==meshes[u.meshid].mtype&&(p=meshes[u.meshid].relayid?"<span class=devHeaderx>, 中繼設備</span>":"<span class=devHeaderx>, 本地設備</span>"),1==i&&null!=n&&(2==t&&(e+="<td><div style=width:301px></div></td>"),""!=e)&&(e+="</tr></table>"),2==i&&(e+="<div>"),e=(e+="<div class=DevSt style=width:100%;padding-top:4px><span style=float:right>")+"<span id=DevxHeader"+deviceHeaderId+" class=devHeaderx></span>"+p+"</span>",1!=i&&2!=i&&3!=i&&5!=i||(x=CollapsedGroups[u.meshid],e+='<i role="button" cmenu=expandAllContextMenu onclick=toggleCollapseGroup("'+deviceHeaderId+'","'+u.meshid+'",'+i+') class="fa-fw fa-solid '+(!0===x?"fa-chevron-right":"fa-chevron-down")+'" id="DevxColImg'+deviceHeaderId+'"></i>'),n=meshes[u.meshid]?(e+='<span id=MxMESH cmenu=meshContextMenu tabindex=0 style=cursor:pointer onclick=gotoMesh("'+u.meshid+"\") onkeypress=\"if (event.key=='Enter') gotoMesh('"+u.meshid+"')\">"+EscapeHtml(meshes[u.meshid].name)+"</span>"+getMeshActions(g,h)+"</div>",u.meshid):(e+="<span id=MxMESH><i>個別裝置</i></span></div>","*"),2==i&&(e+="</div>"),t=0,(o[n]=1)!=i&&3!=i&&5!=i||(e+="<div id=DevxCol"+deviceHeaderId+(!0===x?" style=display:none":"")+">")):1==sort?(p=u.pwr||0)!==n&&(1!=i&&3!=i&&5!=i||null==n||(e+="</div>"),deviceHeaderSet(),1==i&&null!==n&&(2==t&&(e+="<td><div style=width:301px></div></td>"),""!=e)&&(e+="</tr></table>"),2==i&&(e+="<tr><td colspan="+c+">"),e+="<div class=DevSt style=width:100%;padding-top:4px><span id=DevxHeader"+deviceHeaderId+" class=devHeaderx style=float:right></span>",1!=i&&2!=i&&3!=i&&5!=i||(x=CollapsedGroups["pwr:"+p],e+='<i role="button" cmenu=expandAllContextMenu onclick=toggleCollapseGroup("'+deviceHeaderId+'","pwr:'+p+'",'+i+') class="fa-fw fa-solid '+(!0===x?"fa-chevron-right":"fa-chevron-down")+'" id="DevxColImg'+deviceHeaderId+'"></i>'),e+="<span>"+PowerStateStr2(u.pwr)+"</span></div>",n=p,t=0,1!=i&&3!=i&&5!=i||(e+="<div id=DevxCol"+deviceHeaderId+(!0===x?" style=display:none":"")+">")):2!=sort&&5!=sort||null==n&&(n="1"),1==i?e+="<div name=xxdevice1 id=xv1"+u._id+" style=display:inline-block;position:relative;width:"+d+"px;height:50px;padding-top:1px;padding-bottom:1px></div>":2==i?(m=u.meshid,1==sort?m="pwr:"+(u.pwr||0):3!=sort&&4!=sort||(m="tag:**xx**xx*TaG*xx**xx**"),e+="<tr name=xxdevice2 colname=DevxCol"+m+" style=height:20px"+((x=3!=sort&4!=sort&CollapsedGroups[m])?";display:none":"")+" id=xv2"+u._id+"></tr>"):(3==i||5==i)&&1&u.conn&&0!=(8&h||256&h)&&u.agent&&0!=(1&u.agent.caps)&&(0!=Object.keys(checkedNodeids).length&&!checkedNodeids[u._id]||(e+=updateDeviceViewHtml(i,null,u),l.push(u._id))),(3==sort||4==sort)&&""!=e){if(u.tags)for(var v in u.tags){var f=u.tags[v],x=(4==sort&&(f=g?g.name+" - "+u.tags[v]:"**INDV*~*DEVS** - "+u.tags[v]),CollapsedGroups["tag:"+encodeURIComponentEx(f)]),k=e.replace("**xx**xx*TaG*xx**xx**",encodeURIComponentEx(f)+(x?" style=display:none":""));if(null==s[f]?(s[f]=k,a[f]=1):(s[f]+=k,a[f]+=1),3==i||5==i)break}else 4!=sort||null==g||null!=u.tags&&0!=u.tags.length||(f=g.name,x=CollapsedGroups["tag:"+encodeURIComponentEx(f)],k=e.replace("**xx**xx*TaG*xx**xx**",encodeURIComponentEx(f)+(x?" style=display:none":"")),null==s[f]?(s[f]=k,a[f]=1):(s[f]+=k,a[f]+=1));e=""}deviceHeaderTotal++,void 0===deviceHeaderCount[u.state]?deviceHeaderCount[u.state]=1:deviceHeaderCount[u.state]++}}if(1==i&&null!=n&&(e+="</div>"),32<=l.length&&(Q("autoConnectDesktopCheckbox").checked=!1),QE("autoConnectDesktopCheckbox",l.length<32),3==sort||4==sort){var y=[],b=0;for(w in s)y.push(w);for(v in y.sort(function(e,t){return sortCollator.compare(e.toLowerCase(),t.toLowerCase())}),y){var w=y[v];e=2==i?(e+="<tr><td colspan="+c+"><div class=DevSt style=width:100%;padding-top:4px>",x=CollapsedGroups["tag:"+encodeURIComponentEx(w)],(e+='<i role="button" cmenu=expandAllContextMenu onclick=toggleCollapseGroup("'+b+'","tag:'+encodeURIComponentEx(w)+'",2) class="fa-fw fa-solid '+(!0===x?"fa-chevron-right":"fa-chevron-down")+'" id="DevxColImg'+b+'"></i>')+"<span class=devHeaderx style=float:right>"+a[w]+" node"+(1<a[w]?"s":"")+"</span><span>"+EscapeHtml(w).split("|").join(" &rarr; ").split("**INDV*~*DEVS**").join("<i>個別裝置</i>")+"</span></div>"+s[w]):(e+="<div class=DevSt style=width:100%;padding-top:4px><span class=devHeaderx style=float:right>"+format(1<a[w]?"{0} nodes":"{0} node",a[w])+"</span>",x=CollapsedGroups["tag:"+encodeURIComponentEx(w)],(e=(e+='<i role="button" cmenu=expandAllContextMenu onclick=toggleCollapseGroup("'+b+'","tag:'+encodeURIComponentEx(w)+'") class="fa-fw fa-solid '+(!0===x?"fa-chevron-right":"fa-chevron-down")+'" id="DevxColImg'+b+'"></i>')+"<span>"+EscapeHtml(w).split("|").join(" &rarr; ").split("**INDV*~*DEVS**").join("<i>個別裝置</i>")+"</span></div>")+"<div id=DevxCol"+b+(!0===x?" style=display:none":"")+">"+s[w]+"</div>"),b++}}var M=!1;if(""==e&&0<nodes.length&&(""!=Q("SearchInput").value||0!=Q("DevFilterSelect").value)&&(M=!0,e=3==sort?'<div style="margin:30px">沒有一個裝置被加入任何一群，請單擊一個裝置的“群”以新增到一個群中。</div>':'<div style="margin:30px">沒有與此搜索匹配的裝置。 <a onclick=clearDeviceSearch()>清除搜索過濾器</a></div>'),1==i&&2==t&&(e+="<td><div style=width:301px></div></td>"),0==sort&&""==Q("SearchInput").value&&0==Q("DevFilterSelect").value&&i<3){var C=deviceHeaderId,S=[];for(w in meshes)S.push(meshes[w]);for(w in S.sort(nameSort),S){var A=S[w],h=GetMeshRights(A);null==o[A._id]&&(""!=n&&""!=e&&(e+="</tr></table>"),e+="<table style=width:100%;padding-top:4px cellpadding=0 cellspacing=0><tr><td colspan=3 class=DevSt>",C++,x=CollapsedGroups[A._id],e=(e=(e+='<i role="button" cmenu=expandAllContextMenu onclick=toggleCollapseGroup("'+C+'","'+A._id+'") class="fa-fw fa-solid '+(!0===x?"fa-chevron-right":"fa-chevron-down")+'" id="DevxColImg'+C+'"></i>')+'<span id=MxMESH style=cursor:pointer onclick=gotoMesh("'+A._id+'")>'+EscapeHtml(A.name)+"</span><span>")+getMeshActions(A,h)+"</span></td></tr><tr>",1==A.mtype?(e+="<td><div style=padding:10px><i>此設備組中沒有英特爾&reg; AMT 設備",0==(4&h)||4294967295!=userinfo.siteadmin&&0!=(4096&userinfo.siteadmin)||(e+=", <a href=# style=cursor:pointer onclick='return addDeviceToMesh(\""+A._id+"\")'>加一</a>")):2==A.mtype?(e=e+"<td><div id=DevxCol"+C+(!0===x?" style=display:none":"")+"><div style=padding:10px><i>此設備組中沒有設備",0==(4&h)||4294967295!=userinfo.siteadmin&&0!=(4096&userinfo.siteadmin)||(e+=", <a href=# style=cursor:pointer onclick='return addAgentToMesh(\""+A._id+"\")'>加一</a>")):3==A.mtype?(e=e+"<td><div id=DevxCol"+C+(!0===x?" style=display:none":"")+"><div style=padding:10px><i>此設備組中沒有本地設備",0==(4&h)||4294967295!=userinfo.siteadmin&&0!=(4096&userinfo.siteadmin)||(e+=", <a href=# style=cursor:pointer onclick='return addLocalDeviceToMesh(\""+A._id+"\")'>加一</a>")):4==A.mtype&&(e=e+"<td><div id=DevxCol"+C+(!0===x?" style=display:none":"")+"><div style=padding:10px><i>此設備組中沒有設備"),e+=".</i></div></td></div>",n=A._id,0)}}for(w in""!=e&&0==M?(e+="</table>",2==i&&(M="",null==deviceViewSettings&&(deviceViewSettings={}),Array.isArray(deviceViewSettings.devsCols)||(deviceViewSettings.devsCols=["user","ip","conn"]),0<=deviceViewSettings.devsCols.indexOf("agtype")&&(M+="<th style=width:100px>代理類型"),0<=deviceViewSettings.devsCols.indexOf("agver")&&(M+="<th style=width:100px>代理版本"),0<=deviceViewSettings.devsCols.indexOf("os")&&(M+="<th style=width:160px>操作系統"),0<=deviceViewSettings.devsCols.indexOf("tags")&&(M+="<th style=width:120px>標籤"),0<=deviceViewSettings.devsCols.indexOf("windowsav")&&(M+="<th style=width:100px>Windows AV"),0<=deviceViewSettings.devsCols.indexOf("windowsupdate")&&(M+="<th style=width:120px>Windows Update"),0<=deviceViewSettings.devsCols.indexOf("windowsfirewall")&&(M+="<th style=width:120px>Windows Firewall"),0<=deviceViewSettings.devsCols.indexOf("lastbootuptime")&&(M+="<th style=width:120px>Last Boot Up Time"),0<=deviceViewSettings.devsCols.indexOf("links")&&(M+="<th style=width:120px>鏈接"),0<=deviceViewSettings.devsCols.indexOf("user")&&(M+="<th style=width:120px>用戶"),0<=deviceViewSettings.devsCols.indexOf("ip")&&(M+="<th style=width:120px>地址"),0<=deviceViewSettings.devsCols.indexOf("conn")&&(M+="<th style=width:100px>連接性"),0<=deviceViewSettings.devsCols.indexOf("amthost")&&(M+="<th style=width:100px>AMT Host"),0<=deviceViewSettings.devsCols.indexOf("amtstate")&&(M+="<th style=width:100px>AMT State"),0<=deviceViewSettings.devsCols.indexOf("lastseen")&&(M+="<th style=width:120px>最後一次露面",0==requestedLastConnects)&&(requestedLastConnects=!0,meshserver.send({action:"lastconnects"})),e="<table style=width:100%;margin-top:4px cellpadding=0 cellspacing=0><th>"+M+e+"</tr></table><div style=height:1px></div>")):(e+="</table>",3==sort&&(e='<div style="margin:10px"><i>找不到帶有標籤的裝置。</i></div>')),e+="<div style=border-top-style:solid;border-top-width:1px;border-top-color:#DDDDDD;cursor:pointer;font-size:small;margin-top:4px>",i<3&&0==sort&&0<Object.keys(meshes).length&&(4294967295==userinfo.siteadmin||0==(64&userinfo.siteadmin))&&(e+='<a href=# onclick="return account_createMesh()" title="創建一個新的裝置群。" style=cursor:pointer>新增裝置群</a>&nbsp'),4294967295!=userinfo.siteadmin&&0!=(128&userinfo.siteadmin)||(e+="<a href=# onclick='return p10showMeshCmdDialog(0)' style=cursor:pointer title=\"下載MeshCmd，這是一個多功能的指令執行工具。\">MeshCmd</a>&nbsp","win32"!=navigator.platform.toLowerCase()&&"macintel"!=navigator.platform.toLowerCase())||(e+="<a href=# onclick='return p10showMeshRouterDialog()' style=cursor:pointer title=\"下載MeshCentral Router，一個TCP端口映射工具。\">路由器</a>&nbsp"),e+="</div><div style=height:60px></div>",QH("xdevices",e),deviceHeaderSet(),deviceHeaders)QH(w,deviceHeaders[w]);for(w in deviceHeadersTitles)Q(w).title=deviceHeadersTitles[w];if(p1updateInfo(),3!=i&&5!=i||1!=xxcurrentView)disconnectAllKvmFunction(),Q("autoConnectDesktopCheckbox").checked=!1;else{var D,T=[{x:180,y:101},{x:302,y:169},{x:454,y:255}][Q("sizeselect").selectedIndex];for(w in 3==i&&(M=T.x+2,r=r-5,D=Math.floor(r/M),D=M+Math.floor((r-D*M)/D),T.y=T.y*(D/T.x),T.x=D),multiDesktop)multiDesktop[w].xxdelete=!0;for(w in l){var E=l[w],_=E.split("/")[2],N=multiDesktop[E];if(null!=N){var I=5==i?N.m.width*T.y/N.m.height:T.x;N.m.CanvasId.setAttribute("style","background-color:black;width:"+I+"px;height:"+T.y+"px"),Q("xkvmid_"+_).appendChild(N.m.CanvasId),delete N.xxdelete,QH("skvmid_"+_,["已斷線","正在連線...","設定...","",""][null==N.m.State?N.m.state:N.m.State])}else{u=getNodeFromId(E);if(desktopNode==u&&null!=desktop){var t=desktop.m.CanvasId,I=5==i?desktop.m.width*T.y/desktop.m.height:T.x;t.setAttribute("id","kvmid_"+_),t.setAttribute("style","background-color:black;width:"+I+"px;height:"+T.y+"px"),t.setAttribute("onclick","toggleKvmDevice('"+E+"')"),t.removeAttribute("onmousedown"),t.removeAttribute("onmouseup"),t.removeAttribute("onmousemove"),Q("xkvmid_"+_).appendChild(t),QH("skvmid_"+_,["已斷線","正在連線...","設定...","",""][null==desktop.m.State?desktop.m.state:desktop.m.State]),desktop.m.SendCompressionLevel&&desktop.m.SendCompressionLevel(multidesktopsettings.agentencoding,multidesktopsettings.quality,multidesktopsettings.scaling,multidesktopsettings.framerate),desktop.shortid=_,desktop.onStateChanged=onMultiDesktopStateChange,desktop.m.onRemoteInputLockChanged=null,desktop.m.onKeyboardStateChanged=null,multiDesktop[E]=desktop,desktop=desktopNode=currentNode=null,QH("DeskParent",'<canvas id="Desk" oncontextmenu="return false" onmousedown=dmousedown(event) onmouseup=dmouseup(event) onmousemove=dmousemove(event)></canvas>')}else{(t=document.createElement("canvas")).setAttribute("id","kvmid_"+_),t.setAttribute("width",640),t.setAttribute("height",480),t.setAttribute("oncontextmenu","return false"),t.setAttribute("style","background-color:black;width:"+T.x+"px;height:"+T.y+"px"),t.setAttribute("onclick","toggleKvmDevice('"+E+"')");try{Q("xkvmid_"+_).appendChild(t)}catch(e){}1==Q("autoConnectDesktopCheckbox").checked&&setTimeout(function(){connectMultiDesktop(u,1)},100)}}}for(w in multiDesktop)1==multiDesktop[w].xxdelete?(multiDesktop[w].Stop(),delete multiDesktop[w]):debugmode&&multiDesktop[w].m&&multiDesktop[w].m.onScreenSizeChange&&mdeskAdjust(multiDesktop[w].m,multiDesktop[w].m.ScreenWidth,multiDesktop[w].m.ScreenHeight,multiDesktop[w].m.CanvasId);deskAdjust()}}oldviewmode=i,onDevicesScrollEx()}}var xxModal,onDevicesTouchActive=!1,onDevicesScrollnagleTimer=null;function onDevicesScroll(e){(e=void 0===e?!1:e)&&(Q("xdevices").scrollTop=0),null!=onDevicesScrollnagleTimer||onDevicesTouchActive||(onDevicesScrollnagleTimer=setTimeout(onDevicesScrollEx,250))}function onDeviceTouch(e){onDevicesTouchActive!=e&&0==(onDevicesTouchActive=e)&&onDevicesScrollEx()}function onDevicesScrollEx(){null!=onDevicesScrollnagleTimer&&(clearTimeout(onDevicesScrollnagleTimer),onDevicesScrollnagleTimer=null);for(var e,t=Q("xdevices").scrollTop-200,n=Q("xdevices").scrollTop+Q("xdevices").clientHeight+200,o=Q("viewselect").value,i=document.getElementsByName("xxdevice"+o),s=0;s<i.length;s++)i[s].offsetTop>=t&&i[s].offsetTop<n&&null!=(e=getNodeFromId(i[s].id.substring(3)))?updateDeviceViewHtml(o,i[s],e):i[s].innerHTML=""}function updateDeviceViewDevice(e){var t,n=Q("viewselect").value;1!=n&&2!=n?mainUpdate(4):null!=(e="string"==typeof e?getNodeFromId(e):e)&&null!=(t=Q("xv"+n+e._id))&&""!=t.innerHTML&&updateDeviceViewHtml(n,t,e)}function updateDeviceViewHtml(e,t,n){var o=EscapeHtml(n.name),i=(0==o.length&&(o="<i>沒有</i>"),null!=n.rname&&0<n.rname.length&&(o+=" / "+EscapeHtml(n.rname)),EscapeHtml(n.name));if(0==(i=1==showRealNames&&null!=n.rname?EscapeHtml(n.rname):i).length&&(i="<i>沒有</i>"),1==e&&"none"==t.parentNode.style.display||2==e&&"none"==t.style.display)t.innerHTML="";else{var s="",a="",l=(1==stars[n._id]&&(a+=2==e?"<img class=deviceNotifySmallDotSub src=images/icon-star-notify-10.png width=10 height=10>":"<img class=deviceNotifyDotSub src=images/icon-star-notify-16.png width=16 height=16>"),null!=n.sessions&&(null!=n.sessions.msg&&(a+=2==e?"<div onclick=showDeviceMessages('"+n._id+'\',null,event) style="width:10;height:10" class=deviceNotifySmallDotSub></div>':"<div onclick=showDeviceMessages('"+n._id+'\',null,event) style="width:16;height:16" class=deviceNotifyDotSub>'+Object.keys(n.sessions.msg).length+"</div>"),null==n.sessions.kvm&&null==n.sessions.terminal&&null==n.sessions.files&&null==n.sessions.tcp&&null==n.sessions.udp||(a+=2==e?"<img onclick=showDeviceSessions('"+n._id+"',null,event) class=deviceNotifySmallDotSub src=images/icon-relay-notify10.png width=10 height=10>":"<img onclick=showDeviceSessions('"+n._id+"',null,event) class=deviceNotifyDotSub src=images/icon-relay-notify.png width=16 height=16>"),null!=n.sessions.help&&(a+=2==e?"<img onclick=showDeviceHelpRequests('"+n._id+"',null,event) class=deviceNotifySmallDotSub src=images/icon-help-notify-10.png width=10 height=10>":"<img onclick=showDeviceHelpRequests('"+n._id+"',null,event) class=deviceNotifyDotSub src=images/icon-help-notify-16.png width=16 height=16>"),null!=n.sessions.battery)&&1==e&&(r="","ac"==(l=n.sessions.battery).state&&(r="裝置已插入"),"dc"==l.state&&(r="裝置由電池供電"),c="",d=-1,"number"==typeof l.level&&0<=l.level&&l.level<=100&&(c=l.level+"%",5<(d=Math.floor((l.level+10)/25)+1)&&(lvl=5),"ac"==l.state)&&(100==l.level?d=11:d+=5),0<d)&&(s+='<div class="deviceBatterySmall deviceBatterySmall'+d+'" title="'+(null!=r?r+", "+c:c)+'"></div>'),""!=a&&(s+=2==e?"<div class=deviceNotifySmallDot>"+a+"</div>":"<div class=deviceNotifyDot>"+a+"</div>"),n.icon);if(n.conn&&0!=n.conn||3==n.mtype||(l+=" gray"),1==e)t.innerHTML='<table id=devs cmenu=devsContentMenu onmouseover=devMouseHover(this,1) onmouseout=devMouseHover(this,0) style=width:100%;height:100%><tr><td style=width:22px><input class="'+n.meshid+' DeviceCheckbox form-check-input me-2" onchange=p1devcheck(event) value=devid_'+n._id+" type=checkbox "+(checkedNodeids[n._id]?" checked":"")+"></td><td><table onmouseup=gotoDevice('"+n._id+"',null,null,event) border=0 cellspacing=0 style=width:100%;height:100%;cursor:pointer><tr><td style=width:50px tabindex=0 onkeypress=\"if (event.key=='Enter') gotoDevice('"+n._id+'\',null,null,event)"><div class="i'+l+'" style=width:50px></div></td><td class=g1t></td><td class=e2t><div class=e1t style=width:'+(t.clientWidth-120)+'px title="'+o+'">'+i+"</div><div>"+NodeStateStr(n)+"</div></td><td class=g2t></td></tr></table></td></tr></table>"+s;else if(2==e){var r,d=[],c=(n.conn&&(0!=(1&n.conn)&&(4==n.mtype?"PDU"==n.porttype?d.push('<span title="交換機端口已準備好使用。">轉變</span>'):d.push('<span title="IP-KVM 端口已連接並可使用。">IP-KVM</span>'):d.push('<span title="已連接Mesh Agent並準備使用。">代理</span>')),0!=(2&n.conn)?d.push('<span title="Intel&reg; AMT CIRA已連接並可以使用。">CIRA</span>'):0!=(4&n.conn)&&d.push('<span title="Intel&reg; AMT是可路由的。">AMT</span>'),0!=(8&n.conn)&&d.push('<span title="Mesh Agent可以經過其他代理作為中繼訪問得到。">中繼</span>'),0!=(16&n.conn))&&d.push('<span title="與裝置的MQTT連接已啟動。">MQTT</span>'),3==n.mtype&&((r=meshes[n.meshid])&&r.relayid?d.push('<span title="通過中繼代理的本地網絡連接。">中繼</span>'):d.push('<span title="本地網絡連接。">本地</span>')),n.desc&&0<=deviceViewSettings.devsCols.indexOf("desc")&&(i='<div class="flex-grow-1">'+i+"</div><div style=float:right"+(1==stars[n._id]?";padding-right:15px":"")+">"+EscapeHtml(n.desc)+"</div>"),n.meshid),u=(1==sort?c="pwr:"+(n.pwr||0):3!=sort&&4!=sort||(c="tag:**xx**xx*TaG*xx**xx**"),CollapsedGroups[c],"<td style=position:relative><div id=devs cmenu=devsContentMenu class=bar18 tabindex=0 onmouseover=devMouseHover(this,1) onmouseout=devMouseHover(this,0) style=height:18px;width:100%;font-size:medium onkeypress=\"if (event.key=='Enter') gotoDevice('"+n._id+"',null,null,event)\">");if(u=(u=(u+='<div class=deviceBarCheckbox><input class="'+n.meshid+' DeviceCheckbox form-check-input me-2" value=devid_'+n._id+" type=checkbox onchange=p1devcheck(event) "+(checkedNodeids[n._id]?" checked":"")+"></div>")+("<div class=deviceBarIcon onmouseup=gotoDevice('"+n._id+"',null,null,event)><div class=\"j"+l+'" style=width:16px;margin-top:1px;margin-left:2px;height:16px></div></div>'))+"<div class=g1 style=height:18px;float:left></div><div class=g2 style=height:18px;float:right></div>"+('<div class="style10 d-flex align-items-center" style=cursor:pointer;font-size:14px;max-height:18px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap title="'+o+"\" onmouseup=gotoDevice('"+n._id+"',null,null,event)>"+i+"</div></div>"+s+"</td>"),null==deviceViewSettings&&(deviceViewSettings={}),Array.isArray(deviceViewSettings.devsCols)||(deviceViewSettings.devsCols=["user","ip","conn"]),0<=deviceViewSettings.devsCols.indexOf("agtype")&&(u+='<td style=text-align:center;font-size:x-small;padding-left:4px;padding-right:4px title="'+EscapeHtml(3!=n.mtype&&n.agent&&n.agent.id&&n.agent.id<=agentsStr.length?agentsStr[n.agent.id]:"")+'">'+EscapeHtml(3!=n.mtype&&n.agent&&n.agent.id&&n.agent.id<=agentsStr.length?agentsStr[n.agent.id]:"").replace(",","<br />")),0<=deviceViewSettings.devsCols.indexOf("agver")&&(u+='<td style=text-align:center;font-size:x-small;padding-left:4px;padding-right:4px title="'+EscapeHtml(n.agent&&n.agent.core?n.agent.core:"")+'">'+EscapeHtml(n.agent&&n.agent.core?n.agent.core:"").replace(",","<br />")),0<=deviceViewSettings.devsCols.indexOf("os")&&(3==n.mtype?(a="",4==n.agent.id&&(a="Windows"),6==n.agent.id&&(a="Linux"),29==n.agent.id&&(a="MacOS"),u+='<td style=text-align:center;font-size:x-small title="'+EscapeHtml(a)+'">'+EscapeHtml(a)):u+='<td style=text-align:center;font-size:x-small title="'+EscapeHtml(n.osdesc||"")+'">'+EscapeHtml(n.osdesc||"")),0<=deviceViewSettings.devsCols.indexOf("tags")){u+="<td style=text-align:center;font-size:x-small>";var p="";if(null!=n.tags)for(var m in n.tags)p+="<span class=tagSpan>"+EscapeHtml(n.tags[m])+"</span> ";u+="<span style=line-height:20px>"+p+"</span>"}0<=deviceViewSettings.devsCols.indexOf("windowsav")&&(u+="<td style=text-align:center>"+(n.wsc&&null!=n.wsc.antiVirus?"OK"==n.wsc.antiVirus?"<span style=color:green>OK</span>":"<span style=color:red>壞的</span>":"")),0<=deviceViewSettings.devsCols.indexOf("windowsupdate")&&(u+="<td style=text-align:center>"+(n.wsc&&null!=n.wsc.autoUpdate?"OK"==n.wsc.autoUpdate?"<span style=color:green>OK</span>":"<span style=color:red>壞的</span>":"")),0<=deviceViewSettings.devsCols.indexOf("windowsfirewall")&&(u+="<td style=text-align:center>"+(n.wsc&&null!=n.wsc.firewall?"OK"==n.wsc.firewall?"<span style=color:green>OK</span>":"<span style=color:red>壞的</span>":"")),0<=deviceViewSettings.devsCols.indexOf("lastbootuptime")&&(u+="<td style=text-align:center;font-size:x-small>"+(null!=n.lastbootuptime?printDateTime(new Date(n.lastbootuptime)):"")),0<=deviceViewSettings.devsCols.indexOf("links")&&(u+="<td style=text-align:center;font-size:x-small>"+getShortRouterLinks(n)),0<=deviceViewSettings.devsCols.indexOf("user")&&(u+="<td style=text-align:center>"+getUserShortStr(n)),0<=deviceViewSettings.devsCols.indexOf("ip")&&(r="",3==n.mtype?r=n.host:n.ip&&(r=n.ip),u+="<td style=text-align:center>"+r),0<=deviceViewSettings.devsCols.indexOf("conn")&&(u+="<td style=text-align:center>"+d.join("&nbsp;+&nbsp;")),0<=deviceViewSettings.devsCols.indexOf("lastseen")&&(u+="<td style=text-align:center;font-size:x-small>",0<n.conn?u+="已連接":null!=n.lastconnect&&(u+=printDateTime(new Date(n.lastconnect)))),0<=deviceViewSettings.devsCols.indexOf("amthost")&&(u+="<td style=text-align:center>"+(null==n.intelamt||null==n.intelamt.host?"":EscapeHtml(n.intelamt.host))),0<=deviceViewSettings.devsCols.indexOf("amtstate")&&(c="",n.intelamt&&(0==n.intelamt.state&&(c=' <span title="Intel&reg; AMT is not activated">Pre</span>'),1==n.intelamt.state&&(c=' <span title="Intel&reg; AMT is in activation mode">In</span>'),2==n.intelamt.state)&&n.intelamt.flags&&(2&n.intelamt.flags?c=' <span title="Intel&reg; AMT在客户端控制模式下被启动">CCM</span>':4&n.intelamt.flags&&(c+=' <span title="在管理控制模式下啟動了Intel&reg; AMT">ACM</span>')),u+="<td style=text-align:center>"+c),t.innerHTML=u}else if(3==e||5==e)return u="<div id=devs cmenu=devsContentMenu style=display:inline-block;position:relative;margin:1px;background-color:lightgray;border-radius:5px;position:relative><div tabindex=0 style=padding:3px;cursor:pointer onmouseup=gotoDevice('"+n._id+"',11,null,event) onkeypress=\"if (event.key=='Enter') gotoDevice('"+n._id+"',11,null,event)\">"+s,(u+='<div class="j'+l+'" style=width:16px;float:left></div>&nbsp;'+i+"</div>")+"<span onmouseup=gotoDevice('"+n._id+"',null,null,event)></span><div id=xkvmid_"+n._id.split("/")[2]+"><div id=skvmid_"+n._id.split("/")[2]+' tabindex=0 style="position:absolute;color:white;left:5px;top:27px;text-shadow:0px 0px 5px #000;z-index:10;cursor:default" onclick=toggleKvmDevice(\''+n._id+"') onkeypress=\"if (event.key=='Enter') toggleKvmDevice('"+n._id+"')\">已斷線</div></div></div>"}}function getShortRouterLinks(e){var t="",n=GetNodeRights(e);if((0!=(1&e.conn)||3==e.mtype)&&e.agent&&0!=(8&n)&&14!=e.agent.id&&(0!=webRelayPort&&(t=(t+='<a href=# onclick=p10WebRouter("'+e._id+'",1,'+(e.httpport||80)+")>HTTP"+(e.httpport&&80!=e.httpport?"/"+e.httpport:"")+"</a>&nbsp;")+'<a href=# onclick=p10WebRouter("'+e._id+'",2,'+(e.httpsport||443)+")>HTTPS"+(e.httspport&&443!=e.httpsport?"/"+e.httpsport:"")+"</a>&nbsp;"),0<e.agent.id&&e.agent.id<5&&("win32"!=navigator.platform.toLowerCase()||null!=serverinfo.devicemeshrouterlinks&&0==serverinfo.devicemeshrouterlinks.rdp||(t+='<a href=# cmenu=altPortContextMenu id=rdpMCRouterLink onclick=p10MCRouter("'+e._id+'",3)>RDP</a>&nbsp;')),4<e.agent.id&&("win32"!=navigator.platform.toLowerCase()&&"macintel"!=navigator.platform.toLowerCase()||null!=serverinfo.devicemeshrouterlinks&&0==serverinfo.devicemeshrouterlinks.ssh||(t+='<a href=# onclick=p10MCRouter("'+e._id+'",4,'+(e.sshport||22)+")>SSH</a>&nbsp;"),"win32"!=navigator.platform.toLowerCase()||null!=serverinfo.devicemeshrouterlinks&&0==serverinfo.devicemeshrouterlinks.scp||(t+='<a href=# onclick=p10MCRouter("'+e._id+'",5,'+(e.sshport||22)+")>SCP</a>&nbsp;")),"win32"==navigator.platform.toLowerCase()||"macintel"==navigator.platform.toLowerCase())&&null!=serverinfo.devicemeshrouterlinks&&Array.isArray(serverinfo.devicemeshrouterlinks.extralinks))for(var o in serverinfo.devicemeshrouterlinks.extralinks){var o=serverinfo.devicemeshrouterlinks.extralinks[o],i='"'+o.protocol+'"';doesDeviceMatchFilterTags(e,o.filter)&&(3!=e.mtype||"mcrdesktop"!=o.protocol&&"mcrfiles"!=o.protocol)&&("number"==typeof o.protocol?i=o.protocol:"http"==o.protocol?i=1:"https"==o.protocol?i=2:"rdp"==o.protocol?i=3:"ssh"==o.protocol?i=4:"scp"==o.protocol?i=5:"mcrdesktop"==o.protocol?i=6:"mcrfiles"==o.protocol&&(i=7),t+='<a href=# onclick=p10MCRouter("'+e._id+'",'+i+","+o.port+(o.ip?',"'+o.ip+'"':",null")+","+(o.localport||0)+")>"+o.name+"</a>&nbsp;")}return t}function doesDeviceMatchFilterTags(e,t){if(null==t)return!0;if(Array.isArray(t)){if(0<=t.indexOf(e.meshid))return!0;if(0<=t.indexOf(e._id))return!0;if(Array.isArray(e.tags))for(var n in e.tags)if(0<=t.indexOf("tag:"+e.tags[n]))return!0}return!1}function showDeviceHelpRequests(e,t,n){if(n&&haltEvent(n),!xxdialogMode||t){var o=null,i="";if(null==(o=null==e?currentNode:getNodeFromId(e))||null==o.sessions)setDialogMode(0);else{if(null!=o.sessions.help)for(var s in o.sessions.help)i+='<div style="background-color:#CCC;padding:6px;border-radius:6px"><a style="float:right" onclick=closeDeviceHelpRequest("'+encodeURIComponentEx(s)+'","'+encodeURIComponentEx(o._id)+'")>解僱</a><div style=margin-bottom:6px><b>'+EscapeHtml(s)+"</b></div><div style=margin-bottom:6px>"+EscapeHtml(o.sessions.help[s])+"</div></div>";""!=i&&(xxdialogTag="HELPREQ-"+o._id,setModalContent("xxAddAgent","幫助請求 - "+EscapeHtml(o.name),i),showModal("xxAddAgentModal","idx_dlgOkButton"))}}return!1}function closeDeviceHelpRequest(e,t){setDialogMode(0),meshserver.send({action:"msg",type:"localapp",nodeid:decodeURIComponent(t),appid:decodeURIComponent(e),value:{cmd:"cancelhelp"}})}function showDeviceSessions(e,t,n){if(n&&haltEvent(n),!xxdialogMode||t){var o=null,i="";if(null==(o=null==e?currentNode:getNodeFromId(e))||null==o.sessions)setDialogMode(0);else{for(var s in o.sessions)if("kvm"==s&&null==o.sessions.multidesk)for(var a in i+="<u>遠程桌面</u>",o.sessions.kvm)a.startsWith("user/")?(l="",a!=userinfo._id&&4294967295!=GetNodeRights(o)||(l=' <i role=button onclick=\'return endDeviceSession("kvm", "'+encodeURIComponentEx(o._id)+'", "'+encodeURIComponentEx(a)+'")\' title="斷開此會話" class="fa-fw fa-solid fa-trash text-danger" ></i>'),i+=addHtmlValue2(getUserName(a),(1==o.sessions.kvm[a]?"1節":nobreak(format("{0}節",o.sessions.kvm[a])))+l)):"busy"==a&&(i+=addHtmlValue2("設備忙",1==o.sessions.kvm[a]?"1節":nobreak(format("{0}節",o.sessions.kvm[a]))));else if("multidesk"==s)for(var a in i+="<u>遠程桌面</u>",o.sessions.multidesk){var l="";a!=userinfo._id&&4294967295!=GetNodeRights(o)||(l=' <i role=button onclick=\'return endDeviceSession("multidesk", "'+encodeURIComponentEx(o._id)+'", "'+encodeURIComponentEx(a)+'")\' title="斷開此會話" class="fa-fw fa-solid fa-trash text-danger"></i>'),i+=addHtmlValue2(getUserName(a),(1==o.sessions.multidesk[a]?"1節":nobreak(format("{0}節",o.sessions.multidesk[a])))+l)}else if("terminal"==s)for(var a in i+="<u>終端機</u>",o.sessions.terminal){l="";a!=userinfo._id&&4294967295!=GetNodeRights(o)||(l=' <i role=button onclick=\'return endDeviceSession("terminal", "'+encodeURIComponentEx(o._id)+'", "'+encodeURIComponentEx(a)+'")\' title="斷開此會話" class="fa-fw fa-solid fa-trash text-danger"></i>'),i+=addHtmlValue2(getUserName(a),(1==o.sessions.terminal[a]?"1節":nobreak(format("{0}節",o.sessions.terminal[a])))+l)}else if("files"==s)for(var a in i+="<u>檔案</u>",o.sessions.files){l="";a!=userinfo._id&&4294967295!=GetNodeRights(o)||(l=' <i role=button onclick=\'return endDeviceSession("files", "'+encodeURIComponentEx(o._id)+'", "'+encodeURIComponentEx(a)+'")\' title="斷開此會話" class="fa-fw fa-solid fa-trash text-danger"></i>'),i+=addHtmlValue2(getUserName(a),(1==o.sessions.files[a]?"1節":nobreak(format("{0}節",o.sessions.files[a])))+l)}else if("tcp"==s)for(var a in i+="<u>TCP路由</u>",o.sessions.tcp){l="";a!=userinfo._id&&4294967295!=GetNodeRights(o)||(l=' <i role=button onclick=\'return endDeviceSession("tcp", "'+encodeURIComponentEx(o._id)+'", "'+encodeURIComponentEx(a)+'")\' title="斷開此會話" class="fa-fw fa-solid fa-trash text-danger"></i>'),i+=addHtmlValue2(getUserName(a),(1==o.sessions.tcp[a]?"1節":nobreak(format("{0}節",o.sessions.tcp[a])))+l)}else if("udp"==s)for(var a in i+="<u>UDP路由</u>",o.sessions.udp){l="";a!=userinfo._id&&4294967295!=GetNodeRights(o)||(l=' <i role=button onclick=\'return endDeviceSession("udp", "'+encodeURIComponentEx(o._id)+'", "'+encodeURIComponentEx(a)+'")\' title="斷開此會話" class="fa-fw fa-solid fa-trash text-danger"></i>'),i+=addHtmlValue2(getUserName(a),(1==o.sessions.udp[a]?"1節":nobreak(format("{0}節",o.sessions.udp[a])))+l)}""!=i?(xxdialogTag="SESSIONS-"+o._id,setModalContent("xxAddAgent","節 - "+EscapeHtml(o.name),i),showModal("xxAddAgentModal","idx_dlgOkButton")):setDialogMode(0)}}return!1}function endDeviceSession(e,t,n){var n=decodeURIComponent(n).split("/"),o=n[0]+"/"+n[1]+"/"+n[2],i=null;4==n.length&&n[3].startsWith("guest:")&&(i=atob(n[3].substring(6))),"multidesk"==e?meshserver.send({action:"endDesktopMultiplex",nodeid:decodeURIComponent(t),xuserid:o,guestname:i,guestname:i}):meshserver.send({action:"msg",type:"endtunnel",nodeid:decodeURIComponent(t),xuserid:o,guestname:i,guestname:i,protocol:e})}function showDeviceMessages(e,t,n){if(n&&haltEvent(n),!xxdialogMode||t){var o=null,i="<div style=max-height:200px;overflow-y:auto>",s=0;if(null==(o=null==e?currentNode:getNodeFromId(e))||null==o.sessions||null==o.sessions.msg)setDialogMode(0);else{for(var a in o.sessions.msg){var l=a,r=5;"string"==typeof o.sessions.msg[a].msg&&(l=o.sessions.msg[a].msg),"number"==typeof o.sessions.msg[a].msgid&&null!=eventsMessageId[o.sessions.msg[a].msgid]&&(l=eventsMessageId[o.sessions.msg[a].msgid]),i+="<table style=width:96%><td style=width:24px><div class=NotifyIconSmall"+(r=(r="number"==typeof o.sessions.msg[a].icon?o.sessions.msg[a].icon:r)<1||9<r?5:r)+'></div><td><div style="border-radius:5px;background-color:#BBB;width:100%;padding:8px">'+EscapeHtml(l)+"</div></table>",s++}i+="</div>",0<s&&(xxdialogTag="MESSAGES-"+o._id,setModalContent("xxAddAgent","代理訊息 - "+EscapeHtml(o.name),i),showModal("xxAddAgentModal","idx_dlgOkButton"))}}return!1}function toggleCollapseGroup(e,t,n){if(2==n){var o=document.getElementsByName("xxdevice2");if(0==o.length)return;for(var i,s=[],a=0;a<o.length;a++)o[a].attributes.colname.value.substring(7)==t&&s.push(o[a]);(i="none"==s[0].style.display)?delete CollapsedGroups[t]:CollapsedGroups[t]=!0;for(a=0;a<s.length;a++)s[a].style.display=i?"":"none"}else(i="none"==QS("DevxCol"+e).display)?delete CollapsedGroups[t]:CollapsedGroups[t]=!0,QV("DevxCol"+e,i);i?(QC("DevxColImg"+e).remove("fa-chevron-right"),QC("DevxColImg"+e).add("fa-chevron-down")):(QC("DevxColImg"+e).remove("fa-chevron-down"),QC("DevxColImg"+e).add("fa-chevron-right")),putstore("_collapse",JSON.stringify(CollapsedGroups)),updateCollapseAllButton(),onDevicesScrollEx(),onDevicesScrollEx()}function toggleKvmDevice(e){var t=GetNodeRights(e="string"==typeof e?getNodeFromId(e):e);(8&t||256&t)&&1&e.conn&&connectMultiDesktop(e,1)}function getUserShortStr(e){var t,n;return null!=e&&null!=e.users&&Array.isArray(e.users)&&0!=e.users.length?1<e.users.length?'<span title="'+EscapeHtml(e.users.join(", "))+'">'+nobreak(format("{0}個用戶",e.users.length))+"</span>":(0<(n=(t=e=e.users[0]).indexOf("\\"))&&(t=e.substring(n+1)),15<(t=EscapeHtml(t)).length&&(t=t.substring(0,14)+"&#8230;"),'<span title="'+EscapeHtml(e)+'">'+t+"</span>"):""}function autoConnectDesktops(){1==Q("autoConnectDesktopCheckbox").checked&&connectAllKvmFunction()}function connectAllKvmFunction(e){if(xxdialogMode)return!1;if(!0!==e){var n,t=0;for(s in nodes){var o=nodes[s],i=nodes[s]._id;null!=multiDesktop[i]||0!=Object.keys(checkedNodeids).length&&!checkedNodeids[i]||(8&(i=GetNodeRights(o))||256&i)&&1&o.conn&&1==o.v&&t++}if(8<t)return setModalContent("xxAddAgent","全部連接",format("你確定要連接到{0}裝置嗎？",t)),n=function(e,t){document.getElementById("xxAddAgentModal").removeEventListener("hide.bs.modal",n),Q("autoConnectDesktopCheckbox").checked=!1},document.getElementById("xxAddAgentModal").addEventListener("hide.bs.modal",n),void showModal("xxAddAgentModal","idx_dlgOkButton",()=>{document.getElementById("xxAddAgentModal").removeEventListener("hide.bs.modal",n),connectAllKvmFunction(!0)})}for(var s in nodes)1!=nodes[s].v||null!=multiDesktop[nodes[s]._id]||0!=Object.keys(checkedNodeids).length&&!checkedNodeids[nodes[s]._id]||toggleKvmDevice(nodes[s]._id)}function disconnectAllKvmFunction(){if(xxdialogMode)return!1;for(var e in multiDesktop)multiDesktop[e].Stop();multiDesktop={}}function onMultiDesktopStateChange(e,t){try{QH("skvmid_"+e.shortid,["已斷線","正在連線...","設定...","",""][t])}catch(e){}}function onDeviceSearchChanged(e){var t=new URL(window.location.href);if(null==e||"SearchInput"!=e.target.id&&"KvmSearchInput"!=e.target.id?null!=e&&"DevFilterSelect"==e.target.id||(t.searchParams.delete("filter"),urlargs.filter&&delete urlargs.filter):("SearchInput"==e.target.id?Q("KvmSearchInput").value=Q("SearchInput").value:Q("SearchInput").value=Q("KvmSearchInput").value,""!=e.target.value?(t.searchParams.set("filter",e.target.value),urlargs.filter&&(urlargs.filter=e.target.value)):(t.searchParams.delete("filter"),urlargs.filter&&delete urlargs.filter)),0==(268435456&features)&&0<xxcurrentView)try{window.history.replaceState({},document.title,decodeURIComponent(t.toString()))}catch(e){}mainUpdate(5)}function showMultiDesktopSettings(){QV("td7amtkvm",!1),QV("td7meshkvm",!0),QV("td7rdpkvm",!1),QV("d7desktopOtherSettings",!1),d7bitmapquality.value=multidesktopsettings.quality,d7bitmapscaling.value=multidesktopsettings.scaling,d7encoding.value=multidesktopsettings.agentencoding,multidesktopsettings.framerate?d7framelimiter.value=multidesktopsettings.framerate:d7framelimiter.value=100,setModalContent("xxAddAgent","遠程桌面設置",x),showModal("xxAddAgentModal","idx_dlgOkButton",()=>showMultiDesktopSettingsChanged())}function showMultiDesktopSettingsChanged(){for(var e in multidesktopsettings.quality=d7bitmapquality.value,multidesktopsettings.scaling=d7bitmapscaling.value,multidesktopsettings.framerate=d7framelimiter.value,multidesktopsettings.agentencoding=d7encoding.value,localStorage.setItem("multidesktopsettings",JSON.stringify(multidesktopsettings)),multiDesktop)multiDesktop[e].m.SendCompressionLevel(multidesktopsettings.agentencoding,multidesktopsettings.quality,multidesktopsettings.scaling,multidesktopsettings.framerate)}function connectMultiDesktop(e,t){var n=e._id,o=n.split("/")[2],i=multiDesktop[n];null==i?null!=Q("kvmid_"+o)&&(2==t?null!=e.intelamt.user&&""!=e.intelamt.user&&((i=CreateAmtRedirect(CreateAmtRemoteDesktop("kvmid_"+o),authCookie)).shortid=o,i.onStateChanged=onMultiDesktopStateChange,i.m.bpp=1,i.m.useZRLE=!0,i.m.showmouse=!0,i.m.onKvmData=function(e){console.log("KVM Data received in multi-desktop mode, this is not supported.")},i.m.onScreenSizeChange=mdeskAdjust,i.Start(n,16994,"*","*",0),i.contype=2,multiDesktop[n]=i):1==t&&((i=CreateAgentRedirect(meshserver,CreateAgentRemoteDesktop("kvmid_"+o),serverPublicNamePort,authCookie,authRelayCookie,domainUrl)).m.UseExtendedKeyFlag=e.agent.id<5,i.m.mouseCursorActive(11==xxcurrentView),i.shortid=o,i.attemptWebRTC=attemptWebRTC,i.webrtcconfig=webrtcconfiguration,i.onStateChanged=onMultiDesktopStateChange,i.m.ImageType=multidesktopsettings.agentencoding,i.m.CompressionLevel=multidesktopsettings.quality,i.m.ScalingLevel=multidesktopsettings.scaling,multidesktopsettings.framerate&&(i.m.FrameRateTimer=multidesktopsettings.framerate),multidesktopsettings.swapmouse&&(i.m.SwapMouse=multidesktopsettings.swapmouse),multidesktopsettings.rmw&&(i.m.ReverseMouseWheel=multidesktopsettings.rmw),1==multidesktopsettings.remotekeymap&&(i.m.remoteKeyMap=multidesktopsettings.remotekeymap),i.m.onScreenSizeChange=mdeskAdjust,i.Start(n),i.contype=1,multiDesktop[n]=i)):(i.Stop(),delete multiDesktop[n])}function getMeshActions(e,t){return 0==(4&t)?"":(t="",1==e.mtype&&(0==(1&features)&&(t=(t+=' <a href=# role="button" title="新增位於本地網絡上的新Intel&reg; AMT電腦。" onclick=\'return addDeviceToMesh("'+e._id+"\")'>新增本地</a>")+' <a href=# role="button" title="通過掃描本地網絡新增新的Intel&reg; AMT電腦。" onclick=\'return addAmtScanToMesh("'+e._id+"\")'>掃描網絡</a>"),e.amt)&&0<e.amt.type&&(t+=' <a href=# role="button" title="執行英特爾&reg;AMT激活和配置。" onclick=\'return showAmtSetup("'+e._id+"\")'>設定</a>"),2!=e.mtype||4294967295!=userinfo.siteadmin&&0!=(4096&userinfo.siteadmin)||(t+=' <a href=# role="button" title="通過安裝Mesh Agent將新電腦新增到該裝置群。" onclick=\'return addAgentToMesh("'+e._id+"\")'>新增代理</a>",0==(2&features)&&(t+=' <a href=# role="button" title="邀請某人在該裝置群上安裝mesh agent。" onclick=\'return inviteAgentToMesh("'+e._id+"\")'>邀請</a>")),3==e.mtype&&(t+=' <a href=# role="button" title="添加位於本地網絡上的設備。" onclick=\'return addLocalDeviceToMesh("'+e._id+"\")'>新增裝置</a>"),t)}function addLocalDeviceToMesh(e){if(xxdialogMode)return!1;var t=meshes[e],t=format('將本地設備添加到設備組 "{0}"。',EscapeHtml(t.name))+"<br /><br />";setModalContent("xxAddAgent","添加本地設備",(t+=addHtmlFormFloating("裝置名稱","<input id=dp1devicename class=form-control maxlength=32 autocomplete=off onchange=validateLocalDeviceToMesh() onkeyup=validateLocalDeviceToMesh() />"))+addHtmlFormFloating("主機名",'<input id=dp1hostname class=form-control maxlength=32 autocomplete=off placeholder="與裝置名稱相同" onchange=validateLocalDeviceToMesh() onkeyup=validateLocalDeviceToMesh() />')+addHtmlFormFloating("類型","<select id=dp1type class=form-select><option value=4>視窗 (RDP)</option><option value=6>Linux (SSH/SCP/VNC)</option><option value=29>macOS (SSH/SCP/VNC)</option></select>")),showModal("xxAddAgentModal","idx_dlgOkButton",()=>addLocalDeviceToMeshEx(3,e)),validateLocalDeviceToMesh(),Q("dp1devicename").focus()}function validateLocalDeviceToMesh(){QE("idx_dlgOkButton",0<Q("dp1devicename").value.length)}function addLocalDeviceToMeshEx(e,t){var n=Q("dp1hostname").value;""==n&&(n=Q("dp1devicename").value),meshserver.send({action:"addlocaldevice",meshid:t,devicename:Q("dp1devicename").value,hostname:n,type:parseInt(Q("dp1type").value)})}function addDeviceToMesh(e){var t;return xxdialogMode||(t=meshes[e],t=format("將新的Intel&reg; AMT裝置新增到裝置群“{0}”。",EscapeHtml(t.name))+"<br /><br />",setModalContent("xxAddAgent","新增Intel&reg; AMT裝置",t=(t=(t=(t=(t+=addHtmlFormFloating("裝置名稱",'<input id=dp1devicename class="form-control" maxlength=32 autocomplete=off onchange=validateDeviceToMesh() onkeyup=validateDeviceToMesh() />'))+addHtmlFormFloating("主機名",'<input id=dp1hostname class="form-control" maxlength=32 autocomplete=off placeholder="與裝置名稱相同" onchange=validateDeviceToMesh() onkeyup=validateDeviceToMesh() />'))+addHtmlFormFloating("用戶名",'<input id=dp1username class="form-control" maxlength=32 autocomplete=off placeholder="管理員" onchange=validateDeviceToMesh() onkeyup=validateDeviceToMesh() />'))+addHtmlFormFloating("密碼",'<input id=dp1password type=password class="form-control" autocomplete=off maxlength=32 onchange=validateDeviceToMesh() onkeyup=validateDeviceToMesh() />'))+addHtmlFormFloating("安全",'<select id=dp1tls class="form-select"><option value=0>沒有TLS加密</option><option value=1>需要TLS加密</option></select>')),showModal("xxAddAgentModal","idx_dlgOkButton",()=>addDeviceToMeshEx(3,e)),validateDeviceToMesh(),Q("dp1devicename").focus()),!1}function showAmtImport(e){xxdialogMode||(setModalContent("xxAddAgent","Intel&reg; AMT Device Import",'Create many Intel&reg; AMT device at once by importing a JSON file with the following format:<br /><pre>[\r\n  {\r\n    "fqdn":"mycomputer.com",\r\n    "uuid":"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",\r\n    "version":"12.0.1",\r\n    "username":"admin",\r\n    "password":"password",\r\n    "tls":true\r\n  }\r\n]</pre><input type=file id=d4importFile class="form-control" accept=".json" onchange=showAmtImportValidate() />'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>showAmtImportEx(3,e)),QE("idx_dlgOkButton",!1))}function showAmtImportValidate(){QE("idx_dlgOkButton",null!=Q("d4importFile").value)}function showAmtImportEx(e,n){var t=new FileReader;t.onload=function(e){var t=null;try{t=JSON.parse(e.target.result)}catch(e){return setModalContent("xxAddAgent","Intel&reg; AMT Device Import",format("無效的JSON檔案：{0}。",e)),void showModal("xxAddAgentModal","idx_dlgOkButton")}null!=t?meshserver.send({action:"importamtdevices",meshid:n,amtdevices:t}):(setModalContent("xxAddAgent","Intel&reg; AMT Device Import","無效的JSON檔案格式。"),showModal("xxAddAgentModal","idx_dlgOkButton"))},t.readAsText(Q("d4importFile").files[0])}function showAmtSetup(e){var t,n;return xxdialogMode||(t=serverinfo.name,n=meshes[e],-1!=t.indexOf(".")&&0==(2&features)||(t=window.location.hostname),domainUrl.substring(0,domainUrl.length-1),t=1==serverinfo.https?"wss://"+t+(443==serverinfo.port?"":":"+serverinfo.port)+domainUrl:"ws://"+t+(80==serverinfo.port?"":":"+serverinfo.port)+domainUrl,n=format("通過定期在遠程設備上以管理員身份運行MeshCmd，添加，激活和配置Intel&reg; AMT以將“{0}”分組。",EscapeHtml(n.name))+"<br /><br />",n+="<textarea readonly=readonly style=width:100%;resize:none;height:100px;overflow:auto;font-size:12px readonly>meshcmd amtconfig --url "+t+"apf.ashx --id '"+e.split("/")[2]+"' --serverhttpshash "+serverinfo.tlshash+"</textarea>",null!=serverinfo.amtAcmFqdn&&(n+="<div style=margin-top:8px>對於ACM激活，需要將英特爾&reg;AMT設置為以下受信任的FQDN： <b>"+serverinfo.amtAcmFqdn.join(", ")+"</b></div>"),setModalContent("xxAddAgent","英特爾&reg;AMT設置",n),showModal("xxAddAgentModal","idx_dlgOkButton"),Q("idx_dlgOkButton").focus()),!1}function showAmtAcmSetup(){if(xxdialogMode)return!1;var e="<table><tr><td><img src=images/usbkey70.png height=70 width=31 style=margin-left:4px;margin-right:8px><td><div>使用FAT格式的USB密鑰在管理控制模式（ACM）中激活英特爾&reg;AMT。將setup.bin放在其上，然後使用此鍵引導一台或多台計算機。</div><div style=margin-top:6px>首先輸入新舊MBEx密碼。</div></table>",e=(e=(e+=addHtmlFormFloating("舊密碼",'<input id=dp1password0 type=password class="form-control" autocomplete=off maxlength=32 onchange=validateAmtAcmSetupEx() onkeyup=validateAmtAcmSetupEx() />'))+addHtmlFormFloating("新密碼*",'<input id=dp1password1 type=password class="form-control" autocomplete=off maxlength=32 onchange=validateAmtAcmSetupEx() onkeyup=validateAmtAcmSetupEx() />'))+addHtmlFormFloating("新密碼*",'<input id=dp1password2 type=password class="form-control" autocomplete=off maxlength=32 onchange=validateAmtAcmSetupEx() onkeyup=validateAmtAcmSetupEx() />');32&features2&&1==currentMesh.mtype&&serverinfo.amtProvServerMeshId==currentMesh._id&&(e+='<label><input id=dp1lanprov type=checkbox class="form-check-input me-2" /> 用於裸機 LAN 激活。</label>'),setModalContent("xxAddAgent","英特爾&reg;AMT ACM",e+='<div><span id=dp10passNotify style="font-size:10px"> * 8-16個字符，1個大寫，1個小寫，1個數字，1個非字母數字。</span></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",showAmtAcmSetupEx),Q("dp1password0").focus(),validateAmtAcmSetupEx()}function validateAmtAcmSetupEx(){var e=Q("dp1password0").value,t=Q("dp1password1").value,n=Q("dp1password2").value,o=!0;"admin"!=e&&0==checkPasswordRequirements(e,{min:8,max:16,numeric:1,lower:1,upper:1,nonalpha:1})&&(o=!1),t==n&&0!=checkPasswordRequirements(t,{min:8,max:16,numeric:1,lower:1,upper:1,nonalpha:1})||(o=!1),QE("idx_dlgOkButton",o)}function showAmtAcmSetupEx(){meshserver.send({action:"amtsetupbin",oldmebxpass:Q("dp1password0").value,newmebxpass:Q("dp1password1").value,baremetal:32&features2&&Q("dp1lanprov").checked})}function addAmtScanToMesh(e){return xxdialogMode||(setModalContent("xxAddAgent","掃描Intel&reg; AMT裝置","輸入IP地址範圍以掃描Intel&reg; AMT裝置。<br /><br />"+addHtmlValue("IP範圍",'<table style=width:250px><tr><td style=width:99%><input id=dp1range style=width:100% list=iprangelist value="192.168.1.0/24" onkeyup=addAmtScanToMeshKeyUp(event) /><td style=width:1%><input id=dp1rangebutton type=button value="掃瞄" onclick=addAmtScanToMeshButton()></input></tr></table>')+'<div id=dp1results style="width:100%;height:200px;background-color:white;border:1px gray solid;overflow-y:scroll"></div>'+('<input type=hidden id=amtScanMeshId value="'+(xxdialogTag=e)+'" />')+'<div style="padding:10px;margin-bottom:5px"><input id="idx_dlgCancelButton2" type="button" value="取消" style="" onclick="dialogclose(0)" /><input id="idx_dlgOkButton2" type="button" value="OK" style="" onclick="dialogclose(1)" /><div><input id="d2scanSelectButton" type="button" value="全選" onclick="scanSelectAll()" /></div></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",addAmtScanToMeshEx),QE("idx_dlgOkButton2",!1),QE("d2scanSelectButton",!1),QH("dp1results","<div style=width:100%;text-align:center;margin-top:12px;color:gray;line-height:1.5>IP範圍值樣本<br />192.168.0.100<br />192.168.1.0/24<br />192.167.0.1-192.168.0.100</div>"),focusTextBox("dp1range"),addAmtScanToMeshKeyUp()),!1}function scanSelectAll(){for(var e=document.getElementsByClassName("DevScanCheckbox"),t=0;t<e.length;t++)e[t].checked=!0;addAmtScanToMeshCheckbox()}function addAmtScanToMeshKeyUp(e){QE("dp1rangebutton",3<Q("dp1range").value.split(".").length),e&&13==e.keyCode&&(haltEvent(e),addAmtScanToMeshButton())}function addAmtScanToMeshEx(e){for(var t,n,o=document.getElementsByClassName("DevScanCheckbox"),i=0;i<o.length;i++)o[i].checked&&(t=o[i].getAttribute("tag"),n=(t=amtScanResults[t]).hostname,"host"==t.hosttype&&(n=capitalizeFirstLetter(n.split(".")[0])),meshserver.send({action:"addamtdevice",meshid:Q("amtScanMeshId").value,devicename:n,hostname:t.hostname,amtusername:"",amtpassword:"",amttls:t.tls}))}function addAmtScanToMeshButton(){var e=Q("dp1range").value.trim(),t=e.split(" ");""!=(e=(e=1<t.length?t[t.length-1]:e).trim())&&(QE("dp1range",!1),QE("dp1rangebutton",!1),QH("dp1results","<div style=width:100%;text-align:center;margin-top:20px>掃描...</div><div style=width:100%;text-align:center;margin-top:6px;color:#666>"+e+"</div>"),xxdialogTag="AMTSCAN:"+e,meshserver.send({action:"scanamtdevice",range:e}))}function addAmtScanToMeshCheckbox(){for(var e=document.getElementsByClassName("DevScanCheckbox"),t=0,n=0;n<e.length;n++)e[n].checked&&t++;QE("idx_dlgOkButton2",0<t)}function checkEmail(e){var e=e.split("@"),t=2==e.length&&0<e[0].length&&1<e[1].split(".").length&&2<e[1].length;if(1==t){var n,o=e[1].split(".");for(n in o)0==o[n].length&&(t=!1)}return t}function inviteAgentToMesh(e){var t,n;return xxdialogMode||(t="",n=meshes[e],64&features&&(t=(t=(t=(t=(t=(t=(t=(t+=addHtmlFormFloating("邀請類型","<select id=d2InviteType onchange=d2ChangedInviteType() class=form-select><option value=0>鏈結邀請</option><option value=1>電郵邀請</option></select>")+"<hr />")+"<div id=emailInviteDiv style=display:none>"+format("邀請某人安裝mesh agent。將發送一封電郵，其中包含指向“ {0} ”裝置群的mesh agent安裝的鏈結。",EscapeHtml(n.name))+"<br /><br />")+addHtmlFormFloating("名稱（可選）",'<input id=agentInviteName value="" placeholder="Name (optional)" class="form-control" maxlength=64 />'))+addHtmlFormFloating("電郵",'<input id=agentInviteEmail placeholder="example@email.com" class="form-control" onkeyup=validateAgentInvite() />'))+addHtmlFormFloating("操作系統","<select id=agentInviteNameOs onchange=d2ChangedInviteType() class=form-select><option value=4>發送安裝鏈結</option><option value=0 selected>任何可支持的</option><option value=1>僅Windows</option><option value=3>僅限Apple macOS</option><option value=2>只限Linux</option><option value=5>MeshCentral 助手</option></select>")+"<div id=d2agentexpirediv>")+addHtmlFormFloating("鏈結過期","<select id=agentInviteExpire class=form-select><option value=1>1小時</option><option value=8>8小時</option><option value=24>1天</option><option value=168>1週</option><option value=5040>1個月</option><option value=0>無限</option></select>")+"</div><div id=d2agentInstallTypeDiv2>")+addHtmlFormFloating("安裝方式","<select id=agentInviteType class=form-select><option value=0>背景與互動</option><option value=2>僅背景</option><option value=1>僅限互動</option></select>")+"</div>")+addHtmlFormFloating("訊息 （可選的）",'<textarea id="agentInviteMessage" class="form-control" style="height:100px;resize:none;" maxlength="1024"></textarea>')+"</div>"),t=(t=(t=(t+="<div id=urlInviteDiv>"+format("通過共享邀請鏈結來邀請某人安裝mesh agent。該鏈結將用戶指向“ {0} ”裝置群的安裝說明。該鏈結是公用的，不需要這伺服器的帳戶。",EscapeHtml(n.name))+"<br /><br />")+addHtmlFormFloating("鏈結過期","<select id=d2inviteExpire class=form-select onchange=d2RequestInvitationLink()><option value=1>1小時</option><option value=8>8小時</option><option value=24>1天</option><option value=168>1週</option><option value=5040>1個月</option><option value=0>無限</option></select>"))+addHtmlFormFloating("代理","<select id=d2agentType class=form-select onchange=d2ChangedInviteType()><option value=0>所有可用的代理</option><option value=1>Windows MeshAgent</option><option value=2>Linux MeshAgent</option><option value=4>MacOS MeshAgent</option><option value=8>MeshCentral 助手</option><option value=16>Android MeshAgent</option></select>")+"<div id=d2agentInstallTypeDiv>")+addHtmlFormFloating("安裝方式","<select id=d2agentInviteType class=form-select onchange=d2RequestInvitationLink()><option value=0>背景與互動</option><option value=2>僅背景</option><option value=1>僅限互動</option></select>"),xxdialogTag=e,setModalContent("xxAddAgent","邀請",t=t+"</div>"+'<div id=agentInvitationLinkDiv style="text-align:center;font-size:large;margin:16px;display:none"><a href=# id=agentInvitationLink rel="noreferrer noopener" target="_blank" style=cursor:pointer></a> <img src=images/link4.png height=10 width=10 title="複製連結到剪貼板" style=cursor:pointer onclick=d2CopyInviteToClip()></div></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){performAgentInvite(3,e)}),(64&features?(Q("d2InviteType").focus(),d2ChangedInviteType):(Q("d2inviteExpire").focus(),validateAgentInvite))(),d2RequestInvitationLink()),!1}function d2RequestInvitationLink(){meshserver.send({action:"createInviteLink",meshid:xxdialogTag,expire:parseInt(Q("d2inviteExpire").value),flags:parseInt(Q("d2agentInviteType").value),agents:parseInt(Q("d2agentType").value)})}function d2ChangedInviteType(){64&features&&(QV("urlInviteDiv",0==Q("d2InviteType").value),QV("d2agentexpirediv",4==Q("agentInviteNameOs").value),QV("d2agentInstallTypeDiv2",Q("agentInviteNameOs").value<2),QV("emailInviteDiv",1==Q("d2InviteType").value)),QV("d2agentInstallTypeDiv",parseInt(Q("d2agentType").value)<2),validateAgentInvite(),d2RequestInvitationLink()}function d2CopyInviteToClip(){copyTextToClip(Q("agentInvitationLink").href)}function d2CopySecretToClip(){copyTextToClip(Q("d2optsecret").getAttribute("secret"))}function validateAgentInvite(){64&features&&1==Q("d2InviteType").value?(QE("idx_dlgOkButton",checkEmail(Q("agentInviteEmail").value)),QV("idx_dlgCancelButton",!0)):(QE("idx_dlgOkButton",!0),QV("idx_dlgCancelButton",!1))}function performAgentInvite(e,t){64&features&&1==Q("d2InviteType").value&&meshserver.send({action:"inviteAgent",meshid:t,email:Q("agentInviteEmail").value,name:Q("agentInviteName").value,os:Q("agentInviteNameOs").value,flags:Q("agentInviteType").value,msg:Q("agentInviteMessage").value,expire:parseInt(Q("agentInviteExpire").value)})}function addAgentToMesh(e){if(!xxdialogMode){var t,n=meshes[e],o="",i="",s="<select id=aginsSelect onchange=addAgentToMeshClick() class=form-select><option value=0>視窗</option><option value=1>Linux / BSD</option><option value=5>Linux / BSD / macOS二進制安裝軟體</option><option value=2>蘋果macOS</option>",s=(0==(2&features)&&(s+="<option value=6>移動設備</option>"),o+=addHtmlFormFloating("操作系統",s=s+"<option value=7>MeshCentral 助手</option>"+"<option value=3>Windows（卸載）</option><option value=4>Linux / BSD（解除安裝）</option><option value=8>Apple macOS (UnInstall)</option></select>"),serverinfo.name),a=(-1!=s.indexOf(".")&&0==(2&features)||(s=window.location.hostname),domainUrl.substring(0,domainUrl.length-1)),l="",l=1==serverinfo.https?443==serverinfo.port?"":":"+serverinfo.port:80==serverinfo.port?"":":"+serverinfo.port,r=[6,5,10005,25,26,28,30,32,36,37,40,41,16,29],d={6:"Linux x86-64",5:"Linux x86-32",10005:"Apple OSX Universal",25:"Linux ARM-HF, Rasberry Pi",26:"Linux ARM64-HF",28:"Linux MIPS24KC (OpenWRT)",30:"FreeBSD x86-64",32:"Linux ARM 64 bit (glibc/2.24 NOKVM)",36:"OpenWRT x86-64",37:"OpenBSD x86-64",40:"Linux MIPSEL24KC (OpenWRT)",41:"ARMADA/CORTEX-A53/MUSL (OpenWRT)",16:"Apple macOS x86-64",29:"Apple macOS ARM-64"};for(t in r)i+='<option value="'+r[t]+'">'+d[r[t]]+"</option>";o=(o=(o=(o=(o+='<div id="aginsSysTypeDiv">')+addHtmlFormFloating("系統類型",'<select id="aginsSysType" onchange="addAgentToMeshClick()"  class="form-select">'+i+"</select>"))+"</div>"+'<div id="aginsTypeDiv">')+addHtmlFormFloating("安裝方式",'<select id="aginsType" onchange="addAgentToMeshClick()" class="form-select"><option value="0">背景與互動</option><option value="2">僅背景</option><option value="1">僅限互動</option></select>')+'</div><div id="asinsTypeDiv">')+addHtmlFormFloating("安裝方式",'<select id="asinsType" onchange="addAgentToMeshClick()" class="form-select"><option value="2">應用程序，根據用戶請求連接</option><option value="3">應用程序，始終連接</option><option value="0">系統托盤，根據用戶請求連接</option><option value="1">系統托盤，始終連接</option><option value="4">系統托盤，僅顯示器</option></select>')+"</div><hr>",n.name.split("\\").join("").split("/").join("").split(":").join("").split("*").join("").split("?").join("").split('"').join("").split("<").join("").split(">").join("").split("|").join("").split(" ").join("").split("'").join("");o=(o=(o=(o+="<div id=agins_windows>"+format("要將新電腦新增到裝置群“ {0} ”，請下載mesh agent並安裝該電腦以進行管理。這agent中已嵌入了伺服器和裝置群訊息。",EscapeHtml(n.name))+"<br /><br />")+addHtmlValue("Mesh Agent",'<a class=text-decoration-underline id=aginsw32lnk name="meshagents?id=3&meshid='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'" title="x86 32bit version of the MeshAgent">Windows x86-32 (.exe)</a> <i class="fa-regular fa-clipboard" title="Copy Windows x86 32bit agent URL to clipboard" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=3&meshid='+e.split("/")[2]+'&installflags=",1)></i>',["col-md-4","col-md-8"]))+addHtmlValue("Mesh Agent",'<a class=text-decoration-underline id=aginsw64lnk name="meshagents?id=4&meshid='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'" title="x86 64bit version of the MeshAgent">Windows x86-64 (.exe)</a> <i class="fa-regular fa-clipboard" title="Copy Windows x86 64bit agent URL to clipboard" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=4&meshid='+e.split("/")[2]+'&installflags=",1)></i>',["col-md-4","col-md-8"]))+addHtmlValue("Mesh Agent",'<a class=text-decoration-underline id=aginswa64lnk name="meshagents?id=43&meshid='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'" title="ARM 64bit version of the MeshAgent">Windows ARM-64 (.exe)</a> <i class="fa-regular fa-clipboard" title="Copy Windows ARM 64bit agent URL to clipboard" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=43&meshid='+e.split("/")[2]+'&installflags=",1)></i>',["col-md-4","col-md-8"]),0<debugmode&&(o+=addHtmlValue("設定檔案",'<a id=aginswmshlnk name="meshsettings?id='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'">'+format("{0}设置（.msh）",EscapeHtml(n.name))+"</a>")),setModalContent("xxAddAgent","新增 Mesh Agent",o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o+="</div>")+("<div id=agins_linux style=display:none>"+format('要將電腦新增到"{0}"，請運行以下命令。命令需要root憑據。',EscapeHtml(n.name))+"<br />"))+"<textarea id=agins_linux_area rows=2 cols=20 readonly=readonly style=border-radius:4px;padding:6px;margin-top:4px;margin-bottom:4px;border:0;width:100%;resize:none;height:160px;overflow:auto;font-size:12px class=form-control></textarea>"+'<div style=font-size:x-small;float:right>*對於BSD，首先運行“ pkg install wget sudo bash ”。</div><a style=text-decoration:none title="複製到剪貼板" onclick=copyAgentIdValue("agins_linux_area")>複製 <i class="fa-regular fa-clipboard" style=cursor:pointer></i></a></div>')+("<div id=agins_osx style=display:none>"+format("要將新電腦新增到裝置群“ {0} ”，請下載mesh agent並安裝該電腦以進行管理。該代理安裝程序中已嵌入了伺服器和裝置群訊息。",EscapeHtml(n.name))+"<br /><br />"))+addHtmlValue("Mesh Agent",'<a class=text-decoration-underline onclick=downloadFile("meshosxagent?id=16&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'") title="x86-64bit version of macOS Mesh Agent">macOS x86-64位</a> <i class="fa-regular fa-clipboard" title="將macOS代理URL複製到剪貼板" style=cursor:pointer onclick=copyAgentUrl("meshosxagent?id=16&meshid='+e.split("/")[2]+'",0)></i>',["col-md-4","col-md-8"]))+addHtmlValue("Mesh Agent",'<a class=text-decoration-underline onclick=downloadFile("meshosxagent?id=29&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'") title="ARM 64bit version of macOS Mesh Agent">macOS ARM (64位)</a> <i class="fa-regular fa-clipboard" title="將macOS代理URL複製到剪貼板" style=cursor:pointer onclick=copyAgentUrl("meshosxagent?id=29&meshid='+e.split("/")[2]+'",0)></i>',["col-md-4","col-md-8"]))+addHtmlValue("Mesh Agent",'<a class=text-decoration-underline onclick=downloadFile("meshosxagent?id=10005&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'") title="Universal version of macOS Mesh Agent">macOS (Universal)</a> <i class="fa-regular fa-clipboard" title="將macOS代理URL複製到剪貼板" style=cursor:pointer onclick=copyAgentUrl("meshosxagent?id=10005&meshid='+e.split("/")[2]+'",0)></i>',["col-md-4","col-md-8"])+"</div>")+('<div id=agins_qrcode style=display:none;min-height:180px><a id=agins_qrimage_a rel="noreferrer noopener" target=_blank><div id=agins_qrimage style=float:right;margin-left:10px;width:180px;height:180px;cursor:pointer></div></a><div>'+format('要將移動設備添加到組 "{0}"，請下載 MeshAgent 應用程序並掃描此 QR 碼。',EscapeHtml(n.name))+"</div>"))+"<table style=width:180px>"+'<tr><td style=text-align:center><a title="谷歌遊戲商店"rel="noreferrer noopener" target=_blank href="https://play.google.com/store/apps/details?id=com.meshcentral.agent2"><img style=cursor:pointer src="images/google-play-140.png" width=140 srcset="images/google-play-280.png 2x" /></a></td></tr>')+'<tr><td style=text-align:center><a title="Amazon App Store" rel="noreferrer noopener" target=_blank href="https://www.amazon.co.uk/gp/product/B097Z4Q7SK/"><img style=cursor:pointer src="images/amazon-appstore-140.png"  width=140 srcset="images/amazon-appstore-280.png 2x" /></a></td></tr>'+"</table>")+addHtmlValue("Android APK",'<a class=text-decoration-underline onclick=downloadFile("meshagents?id=14'+(urlargs.key?"&key="+urlargs.key:"")+'",null,true) title="APK version of the MeshAgent">APK</a> <i class="fa-regular fa-clipboard" title="將 URL 複製到剪貼板" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=14&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'")></i>')+"</div>")+("<div id=agins_assistant style=display:none><table><tr><td style=vertical-align:top><div>"+format('MeshCentral Assistant 是一個 Windows 工具，用戶可以使用它來尋求幫助。使用下面的鏈接下載將連接到設備組 "{0}" 的版本。',EscapeHtml(n.name))+"</div><div></div><br />"))+('<a class=text-decoration-underline id=asinslnk name="meshagents?id=10006&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'" title="適用於 Windows 的 MeshCentral 助手">Windows 助手 (.exe)</a> <i class="fa-regular fa-clipboard" title="將 URL 複製到剪貼板" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=10006&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'")></i>'))+'</td><td><img id=agass_img1 src=images/assistant-100.png width=74 height=100 srcset="images/assistant-200.png 2x"><img id=agass_img2 src=images/assistant2-100.png width=74 height=100 srcset="images/assistant2-200.png 2x"></td></tr></table></div>'+"<div id=agins_assistant2 style=display:none><table><tr><td style=vertical-align:top><div>MeshCentral Assistant 是一個 Windows 工具，用戶可以使用它來尋求幫助。使用下面的鏈接下載將監控後台代理的版本。</div><div></div><br />")+('<a class=text-decoration-underline id=asinslnk2 name="meshagents?id=10006&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'" title="適用於 Windows 的 MeshCentral 助手">Windows 助手 (.exe)</a> <i class="fa-regular fa-clipboard" title="將 URL 複製到剪貼板" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=10006&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'")></i>'))+'</td><td><img src=images/assistant-100.png width=74 height=100 srcset="images/assistant-200.png 2x"></td></tr></table></div>'+"<div id=agins_windows_un style=display:none>要刪除mash agent，請下載以下檔案，運行該檔案，然後單擊“卸載”。<br /><br />")+addHtmlValue("Mesh Agent",'<a class=text-decoration-underline id=aginsw32unlnk name="meshagents?id=3&meshid='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'" title="x86 32bit version of the MeshAgent">Windows x86-32 (.exe)</a> <i class="fa-regular fa-clipboard" title="Copy Windows x86 32bit agent URL to clipboard" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=3&meshid='+e.split("/")[2]+'&installflags=",1)></i>',["col-md-4","col-md-8"]))+addHtmlValue("Mesh Agent",'<a class=text-decoration-underline id=aginsw64unlnk name="meshagents?id=4&meshid='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'" title="x86 64bit version of the MeshAgent">Windows x86-64 (.exe)</a> <i class="fa-regular fa-clipboard" title="Copy Windows x86 64bit agent URL to clipboard" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=4&meshid='+e.split("/")[2]+'&installflags=",1)></i>',["col-md-4","col-md-8"]))+addHtmlValue("Mesh Agent",'<a class=text-decoration-underline id=aginswa64unlnk name="meshagents?id=43&meshid='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'" title="ARM 64bit version of the MeshAgent">Windows ARM-64 (.exe)</a> <i class="fa-regular fa-clipboard" title="Copy Windows ARM 64bit agent URL to clipboard" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=43&meshid='+e.split("/")[2]+'&installflags=",1)></i>',["col-md-4","col-md-8"])+"</div>")+"<div id=agins_linux_un style=display:none>要刪除網格代理，請運行以下命令。需要root憑據。<br />"+"<textarea id=agins_linux_area_un rows=2 cols=20 readonly=readonly style=border-radius:4px;padding:6px;margin-top:4px;margin-bottom:4px;border:0;width:100%;resize:none;height:160px;overflow:auto;font-size:12px  class=form-control></textarea>")+'<a style=text-decoration:none title="複製到剪貼板" onclick=copyAgentIdValue("agins_linux_area_un")>Copy <i class="fa-regular fa-clipboard" style=cursor:pointer></i></a></div>'+'<div id=agins_osx_un style=display:none>To remove a mesh agent, download the file below, right click on the ".mpkg" file and click "Show Package Contents", then right click on "Uninstall.command" and click "Open"<br /><br />')+addHtmlValue("Mesh Agent",'<a class=text-decoration-underline onclick=downloadFile("meshosxagent?id=10005&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'") title="Universal version of macOS Mesh Agent">macOS Agent (Universal)</a> <i class="fa-regular fa-clipboard" title="將macOS代理URL複製到剪貼板" style=cursor:pointer onclick=copyAgentUrl("meshosxagent?id=10005&meshid='+e.split("/")[2]+'",0)></i>',["col-md-4","col-md-8"]))+"</div>"+"<div id=agins_linux_inst style=display:none>This is a executable on OS's with graphical user interfaces<br /><br />Apple macOS executables will need to be removed from quarantine to run 'xattr -r -d com.apple.quarantine meshagent'<br /><br />You need to 'chmod +x meshagent' and run this file<br /><br />")+addHtmlValue("Mesh Agent",'<a class=text-decoration-underline id=aginsbinlnk name="meshagents?id='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'">MeshAgent</a> <i class="fa-regular fa-clipboard" title="將代理URL複製到剪貼板" style=cursor:pointer onclick=copyAgentUrl("meshagents?id='+e.split("/")[2]+'&installflags=",1)></i>',["col-md-4","col-md-8"]))+addHtmlValue('命令&nbsp;<i class="fa-regular fa-clipboard" title="將代理URL複製到剪貼板" style=cursor:pointer onclick=copyAgentIdValue("aginsbincmd")></i>','<input id=aginsbincmd type=text class="form-control" readonly value=\'wget -O meshagent'+(0!=(2147483648&features)?" --no-check-certificate":"")+' "https://'+s+l+domainUrl+"meshagents?id="+e.split("/")[2].split("$").join("%24").split("@").join("%40")+"' />",["col-md-4 d-flex align-items-center","col-md-8"])+"</div>"),showModal("xxAddAgentModal","idx_dlgOkButton"),new QRCode(Q("agins_qrimage"),{text:serverinfo.magenturl+","+serverinfo.agentCertHash+","+e.split("/")[2],width:180,height:180,colorDark:"#000000",colorLight:"#EEE",correctLevel:QRCode.CorrectLevel.M}),Q("agins_qrimage_a").setAttribute("href",serverinfo.magenturl+","+serverinfo.agentCertHash+","+e.split("/")[2]),0==(8192&features)?(Q("agins_linux_area").value='(wget "https://'+s+l+domainUrl+"meshagents?script=1"+(urlargs.key?"&key="+urlargs.key:"")+'"'+(0!=(2147483648&features)?" --no-check-certificate":"")+' -O ./meshinstall.sh || wget "https://'+s+l+domainUrl+'meshagents?script=1" --no-proxy'+(0!=(2147483648&features)?" --no-check-certificate":"")+" -O ./meshinstall.sh) && chmod 755 ./meshinstall.sh && sudo -E ./meshinstall.sh https://"+s+l+a+" '"+e.split("/")[2]+"' || ./meshinstall.sh https://"+s+l+a+" '"+e.split("/")[2]+"'\r\n",Q("agins_linux_area_un").value='(wget "https://'+s+l+domainUrl+"meshagents?script=1"+(urlargs.key?"&key="+urlargs.key:"")+'"'+(0!=(2147483648&features)?" --no-check-certificate":"")+' -O ./meshinstall.sh || wget "https://'+s+l+domainUrl+'meshagents?script=1" --no-proxy'+(0!=(2147483648&features)?" --no-check-certificate":"")+" -O ./meshinstall.sh) && chmod 755 ./meshinstall.sh && sudo -E ./meshinstall.sh uninstall https://"+s+l+a+" '"+e.split("/")[2]+"' || ./meshinstall.sh uninstall https://"+s+l+a+" '"+e.split("/")[2]+"'\r\n"):(Q("agins_linux_area").value='wget "https://'+s+l+domainUrl+"meshagents?script=1"+(urlargs.key?"&key="+urlargs.key:"")+'" --no-proxy'+(0!=(2147483648&features)?" --no-check-certificate":"")+" -O ./meshinstall.sh && chmod 755 ./meshinstall.sh && sudo -E ./meshinstall.sh https://"+s+l+a+" '"+e.split("/")[2]+"' || ./meshinstall.sh https://"+s+l+a+" '"+e.split("/")[2]+"'\r\n",Q("agins_linux_area_un").value='wget "https://'+s+l+domainUrl+"meshagents?script=1"+(urlargs.key?"&key="+urlargs.key:"")+'" --no-proxy'+(0!=(2147483648&features)?" --no-check-certificate":"")+" -O ./meshinstall.sh && chmod 755 ./meshinstall.sh && sudo -E ./meshinstall.sh uninstall https://"+s+l+a+" '"+e.split("/")[2]+"' || ./meshinstall.sh uninstall https://"+s+l+a+" '"+e.split("/")[2]+"'\r\n"),Q("aginsSelect").focus(),addAgentToMeshClick()}return!1}function setModalContent(e,t,n,o=null){var i=document.getElementById("xxAddAgentModalConf"),s=document.getElementById(e+"Title");if(i&&s){if(s.innerHTML=t,"number"==typeof n){for(var a=1;a<24;a++)QV("dialog"+a,a==n);xxdialogMode=a}else if("string"==typeof n){Q("dialog2").innerHTML=n;for(a=1;a<24;a++)QV("dialog"+a,2==a);xxdialogMode=2}if(o)switch(i.classList.remove("modal-sm","modal-lg","modal-xl"),o){case"small":i.classList.add("modal-sm");break;case"large":i.classList.add("modal-lg");break;case"extra-large":i.classList.add("modal-xl")}else i.classList.remove("modal-sm","modal-lg","modal-xl")}else console.error("Modal elements not found:",e+"Title",e+"Body")}function showModal(t,e,n,o=null,i=null){var s;null==xxModal&&(["idx_dlgOkButton","idx_dlgCancelButton"].forEach(function(e){Q(e).onclick=null,QE(e,!0),QV(e,!0)}),xxModal=new bootstrap.Modal(document.getElementById(t)),s=function(e){xxModal&&(xxModal.dispose(),xxModal=null),0!=xxdialogMode&&(xxdialogMode=0),document.getElementById(t).removeEventListener("hidden.bs.modal",s)},document.getElementById(t).addEventListener("hidden.bs.modal",s)),xxModal.show(),document.getElementById(e).onclick=function(){"function"==typeof n&&n?(xxdialogMode=0,!1!==n(o,i)&&xxModal.hide()):xxModal&&xxModal.hide()}}function copyAgentIdValue(e){copyTextToClip(Q(e).value)}function showNotification(e,t,n,o,i,s,a,l){Swal.fire({position:e,title:t,text:n,icon:o,confirmButtonText:i,timer:s,width:a,showConfirmButton:null!==i})}function copyAgentUrl(e,t){var n=serverinfo.name,n=(-1!=n.indexOf(".")&&0==(2&features)||(n=window.location.hostname),domainUrl.substring(0,domainUrl.length-1),"https://"+n+(443==serverinfo.port?"":":"+serverinfo.port)+domainUrl+e);1==t&&(n+=Q("aginsType").value),n+=urlargs.key?"&key="+urlargs.key:"",5==Q("aginsSelect").value&&(n+="&meshinstall="+Q("aginsSysType").value),7==Q("aginsSelect").value&&(n+="&ac="+Q("asinsType").value),copyTextToClip(n)}function addAgentToMeshClick(){var e=Q("aginsSelect").value;QV("agins_windows",0==e),QV("agins_linux",1==e),QV("agins_osx",2==e),QV("agins_windows_un",3==e),QV("agins_linux_un",4==e),QV("agins_linux_inst",5==e),QV("aginsSysTypeDiv",5==e),QV("agins_qrcode",6==e),QV("agins_assistant",7==e&&4!=Q("asinsType").value),QV("agins_assistant2",7==e&&4==Q("asinsType").value),QV("agins_osx_un",8==e),Q("aginsbinlnk").onclick=function(){downloadFile(Q("aginsbinlnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:"")+"&meshinstall="+Q("aginsSysType").value)},Q("aginsbincmd").value=Q("aginsbincmd").value.split("&installflags=")[0]+"&installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:"")+"&meshinstall="+Q("aginsSysType").value+'"',QV("aginsTypeDiv",0==e||5==e),QV("asinsTypeDiv",7==e),Q("aginsw32lnk").onclick=function(){downloadFile(Q("aginsw32lnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:""),null,!0)},Q("aginsw64lnk").onclick=function(){downloadFile(Q("aginsw64lnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:""),null,!0)},Q("aginswa64lnk").onclick=function(){downloadFile(Q("aginswa64lnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:""),null,!0)},Q("aginsw32unlnk").onclick=function(){downloadFile(Q("aginsw32lnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:""),null,!0)},Q("aginsw64unlnk").onclick=function(){downloadFile(Q("aginsw64lnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:""),null,!0)},Q("aginswa64unlnk").onclick=function(){downloadFile(Q("aginswa64lnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:""),null,!0)},0<debugmode&&(Q("aginswmshlnk").onclick=function(){downloadFile(Q("aginswmshlnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:""),null,!0)}),Q("asinslnk").onclick=function(){downloadFile(Q("asinslnk").name+"&ac="+Q("asinsType").value,null,!0)},Q("asinslnk2").onclick=function(){downloadFile(Q("asinslnk").name+"&ac="+Q("asinsType").value,null,!0)},7==e&&(QV("agass_img1",Q("asinsType").value<2),QV("agass_img2",2<=Q("asinsType").value))}function validateDeviceToMesh(){QE("idx_dlgOkButton",0<Q("dp1devicename").value.length&&passwordcheck(Q("dp1password").value))}function addDeviceToMeshEx(e,t){var n=Q("dp1username").value,o=(""==n&&(n="admin"),Q("dp1hostname").value);""==o&&(o=Q("dp1devicename").value),meshserver.send({action:"addamtdevice",meshid:t,devicename:Q("dp1devicename").value,hostname:o,amtusername:n,amtpassword:Q("dp1password").value,amttls:Q("dp1tls").value})}function deviceHeaderSet(){0==deviceHeaderId?deviceHeaderId=1:(deviceHeaders["DevxHeader"+deviceHeaderId]=1==deviceHeaderTotal?"1個節點":format("{0}個節點",deviceHeaderTotal),deviceHeaderId++,deviceHeaderCount={},deviceHeaderTotal=0)}var powerStateStrings=["",'<span title="裝置已連接電源。">有電源</span>','<span title="裝置處於睡眠狀態（S1）。">休眠中</span>','<span title="裝置處於睡眠狀態（S2）。">休眠中</span>','<span title="裝置處於深度睡眠狀態（S3）。">沉睡</span>','<span title="裝置處於休眠狀態（S4）。">冬眠</span>','<span title="裝置處於關機狀態（S5）。">軟關機</span>','<span title="檢測到裝置，但無法獲得電源狀態。">存在</span>','<span title="設備已斷電。">離開</span>'],powerStateStrings2=["","裝置已連接電源","裝置處於睡眠狀態（S1）","裝置處於睡眠狀態（S2）","裝置處於深度睡眠狀態（S3）","裝置正在休眠（S4）","裝置處於軟關機狀態（S5）","裝置存在，但無法確定電源狀態","設備已關機"],powerColorTable=["pwsTransparent","pwsBlack","pwsBlue","pwsBlue2","pwsLightblue","pwsBlueviolet","pwsDarkgreen","pwsLightseagreen","pwsLightseagreen2"];function NodeStateStr(e){var t=[];return 0<e.state&&e.state<powerStatetable.length&&state.push(powerStatetable[e.state]),e.conn&&(0!=(1&e.conn)&&(4==e.mtype?"PDU"==e.porttype?t.push('<span title="電源開關即可使用。">轉變</span>'):t.push('<span title="IP-KVM 端口已啟動並可以使用。">IP-KVM</span>'):t.push('<span title="已連接Mesh Agent並準備使用。">代理</span>')),0!=(2&e.conn)?t.push('<span title="Intel&reg; AMT CIRA已連接並可以使用。">CIRA</span>'):0!=(4&e.conn)&&t.push('<span title="Intel&reg; AMT是可路由的。">AMT</span>'),0!=(8&e.conn)&&t.push('<span title="Mesh Agent可以經過其他代理作為中繼訪問得到。">中繼</span>'),0!=(16&e.conn))&&t.push('<span title="與裝置的MQTT連接已啟動。">MQTT</span>'),null!=e.pwr&&0!=e.pwr&&t.push(powerStateStrings[e.pwr]),0==t.length?"&nbsp;":t.join(", ")}function PowerStateStr(e){return e<powerStatetable.length?powerStatetable[e]:""}function PowerStateStr2(e){return 0!=e&&e<powerStatetable.length?powerStatetable[e]:"未知"}function updateCollapseAllButton(){var e=0<Object.keys(CollapsedGroups).length;QV("CollapseAllButton",!e),QV("ExpandAllButton",e),QV("CollapseAllButton2",!e),QV("ExpandAllButton2",e)}function selectallButtonFunction(){for(var e=document.getElementsByClassName("DeviceCheckbox"),t=Object.keys(checkedNodeids).length,n=0;n<e.length;n++)e[n].checked=0==t;if(checkedNodeids={},0==t){checkedNodeids={};for(var o=document.getElementsByName("xxdevice"+Q("viewselect").value),n=0;n<o.length;n++)(null==o[n].parentElement.attributes.style||o[n].parentElement.attributes.style.value.indexOf("display")<0)&&(checkedNodeids[o[n].id.substring(3)]=1)}p1updateInfo()}function p1devcheck(e){e.srcElement.checked?checkedNodeids[e.srcElement.value.substring(6)]=1:delete checkedNodeids[e.srcElement.value.substring(6)],p1updateInfo()}function p1updateInfo(){var e=Object.keys(checkedNodeids).length;if(0<e?(QE("GroupActionButton",!0),Q("SelectAllButton").value="選擇無",QV("cxmdesktop",!0)):(QE("GroupActionButton",!1),Q("SelectAllButton").value="全選",QV("cxmdesktop",!1)),null!=customui&&customui.devicesbarbuttons)for(var t in customui.devicesbarbuttons)"one"==customui.devicesbarbuttons[t].selection&&QE("cui:"+t,1==e),"many"==customui.devicesbarbuttons[t].selection&&QE("cui:"+t,1<=e)}function groupActionFunction(){var e=[],t=getCheckedDevices(),n=0;if(262144&features&&0==count2factoraAuths())setModalContent("xxAddAgent","帳號安全","在啟用兩因素身份驗證之前，無法訪問此功能。這是額外的安全性所必需的。轉到“我的帳戶”標籤，然後查看“帳戶安全性”部分。"),showModal("xxAddAgentModal","idx_dlgOkButton");else{if(4194304&features)for(var o in t)if(0!=(16&getNodeFromId(t[o]).conn)){e.push({v:103,name:"發送MQTT消息"});break}for(var o in e.push({v:105,name:"輸出裝置訊息",s:!0}),t){var i=getNodeFromId(t[o]),s=GetNodeRights(i);1&s&&0==(2&n)&&(n|=2,e.push({v:102,name:"移至裝置群"})),0!=(1&i.conn)&&0!=(32768&s)&&0==(1&n)&&(n|=1,e.push({v:104,name:"卸載代理"})),64&s&&0==(8&n)&&(n|=8,e.push({v:100,name:"喚醒裝置"})),262144&s&&0==(4&n)&&(n|=4,e.push({v:4,name:"把裝置休眠"}),e.push({v:3,name:"重置裝置"}),e.push({v:2,name:"關閉裝置"})),131072&s&&0==(16&n)&&(n|=16,e.push({v:106,name:"運行命令"})),16384&s&&0==(32&n)&&(n|=32,e.push({v:108,name:"設備通知"})),4&s&&0==(64&n)&&(n|=64,e.push({v:107,name:"編輯標籤"})),8&s&&0==(256&n)&&(n|=256,e.push({v:109,name:"上傳文件"})),32768&s&&0==(128&n)&&(n|=128,e.push({v:101,name:"刪除裝置"})),null!=i.agent&&16&features2&&4294967295==s&&0==(512&n)&&(n|=512,e.push({v:110,name:"強制代理更新"}),e.push({v:111,name:"清除代理核心"}),e.push({v:112,name:"上載默認伺服器核心"}))}var a="";for(o in e.sort(nameSort),e)a+="<option value="+e[o].v+(e[o].s?" selected":"")+">"+e[o].name+"</option>";var l="選擇要在所有選定裝置上執行的操作。僅在擁有適當權限的情況下才能執行操作。<br /><br />";setModalContent("xxAddAgent","集體指令",l+=addHtmlFormFloating("操作",'<select id=d2groupop class="form-select">'+a+"</select>")),showModal("xxAddAgentModal","idx_dlgOkButton",groupActionFunctionEx)}}function getCheckedDevices(){return Object.keys(checkedNodeids)}function uncheckAllDevices(){for(var e=document.getElementsByClassName("DeviceCheckbox"),t=0;t<e.length;t++)e[t].checked=!1;checkedNodeids={}}function groupActionFunctionEx(){var e=Q("d2groupop").value;if(100==e)return meshserver.send({action:"wakedevices",nodeids:getCheckedDevices()}),uncheckAllDevices(),!0;if(101==e){var t="";if(0==(r=getCheckedDevices()).length)return;if(1==r.length)t+="確認刪除所選設備？<br /><br />";else{t+=format("確認刪除 {0} 個選定的設備？<br />",r.length);var n=0,o=0;for(l in r)null!=(d=getNodeFromId(r[l])).conn&&0<d.conn?n++:o++;var i="";1==n?i+=format("1 個選定的設備在線。<br />",n):1<n&&(i+=format("{0} 個選定的設備在線。<br />",n)),1==o?i+=format("1 個選定的設備處於離線狀態。<br />",o):1<o&&(i+=format("{0} 個選定的設備處於離線狀態。<br />",o)),t+=""!=i?"<div style=padding:8px>"+i+"</div>":"<br />"}setModalContent("xxAddAgent","刪除設備",t+='<label><input id=d2check type=checkbox class="form-check-input me-2" onchange=d2groupActionFunctionDelCheck() />確認</label>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>d2groupActionFunctionDelExec()),QE("idx_dlgOkButton",!1)}else if(102==e)p10showChangeGroupDialog(getCheckedDevices());else if(103==e)p10showSendMqttMsgDialog(getCheckedDevices());else if(104==e)p10showSendUninstallAgentDialog(getCheckedDevices());else if(105==e)p2downloadDeviceInfo();else if(106==e)d2runCommandDialog({nodeids:getCheckedDevices(),title:"在所選裝置上運行命令。",func:uncheckAllDevices});else if(107==e){var t="執行批次裝置標籤操作<br /><br />",s=(t=(t+=addHtmlFormFloating("操作",'<select id=d2deviceop class="form-select-sm me-2"><option value=1>新增標籤</option><option value=2>設置標籤</option><option value=3>删除標籤</option></select>'))+addHtmlFormFloating("標籤",'<input id=dp10devicevalue class="form-control" maxlength=4096 placeholder="標籤1，標籤2，標籤3" />'),[]),i="";for(l in nodes)if(nodes[l].tags)for(var a in nodes[l].tags)-1==s.indexOf(nodes[l].tags[a])&&s.push(nodes[l].tags[a]);if(0<s.length){for(var l in s.sort(),s)i+='<span style=padding:4px;background-color:#BBB;border-radius:3px;cursor:pointer onclick=showEditNodeValueDialogAddTag("'+encodeURIComponentEx(s[l])+'")>'+EscapeHtml(s[l])+"</span> ";t+="<div style=margin-top:8px;width:370px;line-height:26px;max-height:160px;overflow-y:auto>"+i+"</div>"}setModalContent("xxAddAgent","編輯裝置標籤",t),showModal("xxAddAgentModal","idx_dlgOkButton",()=>d2groupActionFunctionTagsExec())}else if(108==e){var t="<div style=margin-bottom:4px>執行批量設備通知</div>";setModalContent("xxAddAgent","裝置通知",t=(t=(t=(t=(t=(t+='<select id=d2deviceop class="form-select-sm me-2" style=width:100%;margin-bottom:4px><option value=2>吐司通知</option><option value=1>留言框</option><option value=3>Alert Box</option></select>')+'<input id=dp2notifyTitle maxlength=256 placeholder="標題" style=width:100%;box-sizing:border-box;margin-bottom:4px />'+"<textarea id=d2notifyMsg style=width:100%;height:140px;resize:none;overflow-y:scroll;box-sizing:border-box;margin-bottom:4px></textarea>")+"<select style=width:100% id=d2notifyTimeout>"+'<option disabled value="">Only Applicable to Message Box Notifications</option>')+"<option value=2 selected>Show for 2 Minutes (Default)</option>"+"<option value=10>Show for 10 minutes</option>")+"<option value=30>Show for 30 minutes</option>"+"<option value=60>Show for 60 minutes</option>")+"<option value=0>顯示消息，直到被用戶拒絕</option>"+"</select>"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>d2groupActionFunctionNotifyExec()),Q("d2notifyMsg").focus()}else if(109==e){var r,d,c=!1,u=!1;for(l in r=getCheckedDevices())(d=getNodeFromId(r[l])).agent&&(0<d.agent.id&&d.agent.id<5||34==d.agent.id?c=!0:u=!0);var t="將所選文件上傳到所有所選設備<br /><br />";t=(t+="<form method=post enctype=multipart/form-data action=uploadfilebatch.ashx target=fileUploadFrame>")+("<input type=hidden name=authCookie value="+authCookie+" /><input type=hidden name=nodeIds value="+r.join(",")+" /><input type=submit id=d2batchUploadSubmit style=display:none />")+'<input type=file name=files id=d2uploadinput class="form-control" multiple=multiple onchange="d2batchUploadValidate()" /><br /><br />',c&&(t+=addHtmlFormFloating("Windows路徑",'<input type=text class="form-control" onchange="d2batchUploadValidate()" onkeyup="d2batchUploadValidate()" name=winpath id=d2winuploadpath placeholder="C:\\temp" value="" />')),u&&(t+=addHtmlFormFloating("Linux路徑",'<input type=text class="form-control" onchange="d2batchUploadValidate()" onkeyup="d2batchUploadValidate()" name=linuxpath id=d2linuxuploadpath placeholder="/tmp" value="" />')),setModalContent("xxAddAgent","批處理文件上傳",t=t+'<br /><label><input type=checkbox class="form-check-input me-2" name=createFolder />創建文件夾（如果不存在）？</label><br />'+'<label><input type=checkbox class="form-check-input me-2" name=overwriteFiles />是否覆蓋文件存在？</label></form>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>d2batchUploadValidateOk()),d2batchUploadValidate()}else if(110==e)setModalContent("xxAddAgent","強制代理更新",t="在選定的設備上強制更新代理？<br /><br />"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>d2groupActionFunctionAgentUpdateExec());else if(111==e)setModalContent("xxAddAgent","清除代理核心",t="清除所選設備上的代理核心？<br /><br />"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>d2groupActionFunctionAgentClearCoreExec());else{if(112!=e)return meshserver.send({action:"poweraction",nodeids:getCheckedDevices(),actiontype:parseInt(e)}),uncheckAllDevices(),!0;setModalContent("xxAddAgent","上載默認伺服器核心",t="在選定設備上上傳默認服務器核心？<br /><br />"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>d2groupActionFunctionAgentDefaultCodeExec())}return!1}function d2batchUploadValidate(){QE("idx_dlgOkButton",!(0==Q("d2uploadinput").files.length||null!=Q("d2winuploadpath")&&""==Q("d2winuploadpath").value||null!=Q("d2linuxuploadpath")&&""==Q("d2linuxuploadpath").value))}function d2batchUploadValidateOk(){Q("d2batchUploadSubmit").click()}function d2groupActionFunctionAgentUpdateExec(){meshserver.send({action:"updateAgents",nodeids:getCheckedDevices()})}function d2groupActionFunctionAgentClearCoreExec(){meshserver.send({action:"uploadagentcore",nodeids:getCheckedDevices(),type:"clear"})}function d2groupActionFunctionAgentDefaultCodeExec(){meshserver.send({action:"uploadagentcore",nodeids:getCheckedDevices(),type:"default"})}function d2groupActionFunctionNotifyExec(){var e=Q("d2deviceop").value,t=Q("dp2notifyTitle").value,n=Q("d2notifyMsg").value,o=getCheckedDevices(),i=parseFloat(Q("d2notifyTimeout").value);if(0!=n.length)if(""==(t=""==t?decodeURIComponent("{{{extitle}}}"):t)&&(t="網格中心"),isNaN(i)&&(i=2),1==e)for(var s=0;s<o.length;s++)meshserver.send({action:"msg",type:"messagebox",nodeid:o[s],title:t,msg:n,timeout:6e4*i});else if(2==e)meshserver.send({action:"toast",nodeids:o,title:t,msg:n});else if(3==e)for(s=0;s<o.length;s++)meshserver.send({action:"msg",type:"alertbox",nodeid:o[s],title:t,msg:n})}function d2groupActionFunctionTagsExec(){var e=getCheckedDevices(),t=Q("d2deviceop").value,n=Q("dp10devicevalue").value;if(2==t)for(var o in e)meshserver.send({action:"changedevice",nodeid:e[o],tags:n});else{var i=[];for(o in n=n.split(",")){var s=n[o].trim();0<s.length&&s.length<64&&-1==i.indexOf(s)&&i.push(s)}for(o in e){var a=null,l=!1,r=getNodeFromId(e[o]);null==(a=null!=r.tags?Clone(r.tags):a)&&(a=[]);for(var d,c=0;c<n.length;c++)1==t&&-1==a.indexOf(n[c])&&(a.push(n[c]),l=!0),3==t&&0<=(d=a.indexOf(n[c]))&&(a.splice(d,1),l=!0);l&&meshserver.send({action:"changedevice",nodeid:e[o],tags:a.join(",")})}}}function p2downloadDeviceInfo(){if(!xxdialogMode){var e,t=getCheckedDevices(),n=!1;for(e in t)null!=getNodeFromId(t[e]).intelamt&&(n=!0);var o="使用以下一種檔案格式下載裝置列表。<br /><br />",o=(o+=addHtmlValue("CSV格式","<a href=# style=cursor:pointer onclick='return p2downloadDeviceInfoCSV()'>devicelist.csv</a>"))+addHtmlValue("JSON格式","<a href=# style=cursor:pointer onclick='return p2downloadDeviceInfoJSON()'>devicelist.json</a>");n&&(o+=addHtmlValue("英特爾&reg; AMT JSON","<a href=# style=cursor:pointer onclick='return p2downloadAmtInfoJSON()'>計算機列表.json</a>")),setModalContent("xxAddAgent","裝置訊息輸出",o+='<div style=margin-top:8px><label><input type=checkbox class="form-check-input me-2" id=d2DevInfoDetailsCheck />包括設備詳細信息</label></div>'),showModal("xxAddAgentModal","idx_dlgOkButton")}}function csvClean(e){return null==e?"":e.split(",").join("")}function p2downloadDeviceInfoCSV(){var e=getCheckedDevices();if(Q("d2DevInfoDetailsCheck").checked){var t=null;try{t=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(e){}meshserver.send({action:"getDeviceDetails",nodeids:e,tz:t,tf:(new Date).getTimezoneOffset(),l:getLang(),type:"csv"})}else{var n,o="id、名稱、rname、主機、圖標、ip、osdesc、狀態、組名、conn、pwr、av、更新、防火牆、bitlocker,avdetails,tags,lastbootuptime\r\n";for(n in e){var i=getNodeFromId(e[n]);if(o+='"'+i._id.split(",").join("")+'","'+i.name.split(",").join("")+'","'+(i.rname?i.rname.split(",").join(""):"")+'","'+(i.host?i.host.split(",").join(""):"")+'","'+i.icon+'","'+(i.ip||"")+'","'+(i.osdesc?i.osdesc.split(",").join(""):"")+'","'+i.state+'","'+meshes[i.meshid].name.split(",").join("")+'","'+(i.conn||"")+'","'+(i.pwr||"")+'"',"object"==typeof i.wsc?o+=',"'+csvClean(i.wsc.antiVirus)+'","'+csvClean(i.wsc.autoUpdate)+'","'+csvClean(i.wsc.firewall)+'"':o+=",,,","object"==typeof i.volumes){var s="",a=!0;for(d in i.volumes)void 0!==i.volumes[d].protectionStatus&&(a?a=!1:s+="|",s+=d+"/"+i.volumes[d].volumeStatus);o+=',"'+csvClean(s)+'"'}else o+=",";if("object"==typeof i.av){var l="",r=!0;for(d in i.av)"string"==typeof i.av[d].product&&(r?r=!1:l+="|",l+=i.av[d].product+"/"+(i.av[d].enabled?"enabled":"disabled")+"/"+(i.av[d].updated?"updated":"notupdated"));o+=',"'+csvClean(l)+'"'}else o+=",";if("object"==typeof i.tags){var d,c="",u=!0;for(d in i.tags)u?u=!1:c+="|",c+=i.tags[d];o+=',"'+csvClean(c)+'"'}else o+=",";"number"==typeof i.lastbootuptime&&(o+=',"'+i.lastbootuptime+'"'),o+="\r\n"}saveAs(stringToUtf8Blob(o),"devicelist.csv")}return!1}function p2downloadAmtInfoJSON(){var e,t=getCheckedDevices(),n={webappversion:"0.9.0",computers:[]};for(e in t){var o,i=getNodeFromId(t[e]);null!=i.intelamt&&(o={name:i.name,host:i.host,user:i.intelamt.user,pass:"",tls:1==i.intelamt.tls?1:0,ver:i.intelamt.ver,pstate:i.intelamt.state},2==i.intelamt.state&&(o.pmode=1),i.intelamt.realm&&(o.digestrealm=i.intelamt.realm),i.intelamt.hash&&(o.tlscerthash=i.intelamt.hash),n.computers.push(o))}saveAs(new Blob([JSON.stringify(n,null,2)],{type:"application/octet-stream"}),"計算機列表.json")}function p2downloadDeviceInfoJSON(){var e=getCheckedDevices();if(Q("d2DevInfoDetailsCheck").checked){var t=null;try{t=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(e){}meshserver.send({action:"getDeviceDetails",nodeids:e,tz:t,tf:(new Date).getTimezoneOffset(),l:getLang(),type:"json"})}else{var n,o=[];for(n in e)o.push(getNodeFromId(e[n]));saveAs(new Blob([JSON.stringify(o,null,2)],{type:"application/octet-stream"}),"devicelist.json")}return!1}function d2groupActionFunctionDelCheck(){QE("idx_dlgOkButton",Q("d2check").checked)}function d2groupActionFunctionDelExec(){meshserver.send({action:"removedevices",nodeids:getCheckedDevices()}),uncheckAllDevices()}function d2runCommandDialog(e){var t,n=!1,o=!1,i=!1;for(t in e.nodeids){var s=getNodeFromId(e.nodeids[t]);s.agent&&(24==(24&GetNodeRights(s))&&(i=!0),0<s.agent.id&&s.agent.id<5?n=!0:o=!0)}if(1==n||1==o||1==i){var a={type:1,runAs:0,source:1,cmd:""};try{a=JSON.parse(getstore("runopt",a))}catch(e){}e.selectedFile&&(l=e.selectedFile.name.toLowerCase(),console.log("filename",l),l.endsWith(".bat")&&(a.type=1),l.endsWith(".ps1")&&(a.type=2),l.endsWith(".sh")&&(a.type=3),l.endsWith(".agentconsole"))&&(a.type=4);var l="";e.title&&(l+=e.title+"<br />"),l+="<select id=d2cmdtype onclick=d2runCommandValidate() style=width:100%;margin-bottom:4px;margin-top:4px class=form-select>",1==n&&(l+="<option value=1"+(1==a.type?" selected":"")+">Windows命令提示</option><option value=2"+(2==a.type?" selected":"")+">Windows PowerShell</option>"),1==o&&(l+="<option value=3"+(3==a.type?" selected":"")+">Linux / BSD / macOS命令外殼</option>"),1==i&&(l+="<option value=4"+(4==a.type?" selected":"")+">代理控制台</option>"),l=l+"</select>"+("<select id=d2cmduser style=width:100%;margin-bottom:4px class=form-select><option value=0"+(0==a.runAs?" selected":"")+">以代理身份運行</option><option value=1"+(1==a.runAs?" selected":"")+">以用戶身份運行，如果沒有用戶，則運行代理</option><option value=2"+(2==a.runAs?" selected":"")+">必須以用戶身份運行</option></select>"),null==e.selectedFile&&(l+="<select id=d2cmdsource onclick=d2runCommandValidate() style=width:100%;margin-bottom:4px class=form-select><option value=0"+(0==a.source?" selected":"")+">Commands from text box</option><option value=1"+(1==a.source?" selected":"")+">Commands from file</option>",8&userinfo.siteadmin&&(l+="<option value=2"+(2==a.source?" selected":"")+">Commands from file on server</option>"),l=l+("</select><textarea id=d2runcmd onkeyup=d2runCommandValidate() style=background-color:#fcf3cf;width:100%;height:200px;resize:none;overflow-y:scroll class=form-control>"+(a.cmd?EscapeHtml(decodeURIComponent(a.cmd)):""))+'</textarea><div id=d2runfile style=display:none><input id=d2runfileex class="form-control" type=file onchange=d2runCommandValidate() id=d2localFile name=files onchange=d2runCommandValidate() /></div>',8&userinfo.siteadmin)&&(l+='<div id=d2runsfile style=display:none><div id=d2serveraction valign=bottom><input type=button id=p2FolderUp disabled="disabled" onclick=d3folderup() value="Up" />&nbsp;<span id=p2CurrentFolder></span></div><div id=d2serverfiles></div></div>'),setModalContent("xxAddAgent","運行命令",l),showModal("xxAddAgentModal","idx_dlgOkButton",function(){d2groupActionFunctionRunCommands(3,e)}),null==e.selectedFile&&(Q("d2runcmd").focus(),8&userinfo.siteadmin)&&(d3fileoptions={dialog:2,files:"d2serverfiles",folderup:"p2FolderUp",currentFolder:"p2CurrentFolder",func:null},d3updatefiles()),d2runCommandValidate()}}function d2runCommandValidate(){var e;QV("d2cmduser",Q("d2cmdtype").value<4),null==xxdialogTag.selectedFile?(QV("d2runcmd",0==Q("d2cmdsource").value),QV("d2runfile",1==Q("d2cmdsource").value),QV("d2runsfile",2==Q("d2cmdsource").value),e=!1,0==Q("d2cmdsource").value&&0<Q("d2runcmd").value.length&&(e=!0),1==Q("d2cmdsource").value&&1==Q("d2runfileex").files.length&&(e=!0),2==Q("d2cmdsource").value&&(e=!1),QE("idx_dlgOkButton",e)):QE("idx_dlgOkButton",!0)}function d2groupActionFunctionRunCommands(e,t){var n=3;try{n=parseInt(Q("d2cmdtype").value)}catch(e){}null==t.selectedFile&&putstore("runopt",JSON.stringify({type:n,runAs:parseInt(Q("d2cmduser").value),source:parseInt(Q("d2cmdsource").value),cmd:encodeURIComponent(Q("d2runcmd").value)}));var o,i={action:"runcommands",nodeids:t.nodeids,type:n,runAsUser:parseInt(Q("d2cmduser").value)};t.selectedFile?((o=new FileReader).onload=function(e){i.cmds=e.target.result,meshserver.send(i),t.func&&t.func()},o.readAsText(t.selectedFile)):0==Q("d2cmdsource").value?(i.cmds=Q("d2runcmd").value,meshserver.send(i),t.func&&t.func()):1==Q("d2cmdsource").value?((o=new FileReader).onload=function(e){i.cmds=e.target.result,meshserver.send(i),t.func&&t.func()},o.readAsText(Q("d2runfileex").files[0])):2==Q("d2cmdsource").value&&1==(n=d3getFileSel()).length&&(i.cmdpath=d3filetreelocation.join("/")+"/"+n[0],meshserver.send(i),t.func)&&t.func()}function onSortSelectChange(e){sort=document.getElementById("sortselect").selectedIndex,e||putstore("sort",sort)}var sortCollator=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});function nameSort(e,t){e=e.name.toLowerCase(),t=t.name.toLowerCase();return sortCollator.compare(e,t)}function meshSort(e,t){var n=sortCollator.compare(e.meshnamel,t.meshnamel);return 0!=n||0!=(n=sortCollator.compare(e.meshid,t.meshid))?n:1==showRealNames?sortCollator.compare(e.rnamel,t.rnamel):sortCollator.compare(e.namel,t.namel)}function powerSort(e,t){var n=e.pwr||0,o=t.pwr||0;return o<n?-1:n<o?1:n==o?1==showRealNames?sortCollator.compare(e.rnamel,t.rnamel):sortCollator.compare(e.namel,t.namel):void 0}function deviceSort(e,t){return sortCollator.compare(e.namel,t.namel)}function deviceHostSort(e,t){return sortCollator.compare(e.rnamel,t.rnamel)}function lastConnectSort(e,t){var n=e.lastconnect,o=t.lastconnect;return null==n&&(n=99999999999999),null==o&&(o=99999999999999),(n=0<e.conn?99999999999998:n)==(o=0<t.conn?99999999999998:o)?nameSort(e,t):n-o}function onSearchFocus(e){searchFocus=e}function clearDeviceSearch(){Q("KvmSearchInput").value=Q("SearchInput").value="",onOnlineCheckBox(),mainUpdate(1)}function onMapSearchFocus(e){mapSearchFocus=e}function onUserSearchFocus(e){userSearchFocus=e}function onConsoleFocus(e){consoleFocus=e}function parseSearchAndInput(e){var t,n=e.split(" 和 "),o=null;for(t in n){var i=getDevicesThatMatchFilter(n[t]);if(null==o)o=i;else{var s,a=[];for(s in i)0<=o.indexOf(i[s])&&a.push(i[s]);o=a}}return o}function parseSearchOrInput(e){var t,n=e.split(" 或者 "),o=null;for(t in n){var i=parseSearchAndInput(n[t]);if(null==o)o=i;else for(var s in i)o.indexOf(0<=i[s])&&o.push(i[s])}return o}function getDevicesThatMatchFilter(e){var t=[],n=null,o=null,i=null,s=null,a=null,l=null,r=null,d=null,c=null;if(e.startsWith("用戶：".toLowerCase())?n=e.substring("用戶：".length):e.startsWith("u:".toLowerCase())?n=e.substring("u:".length):e.startsWith("ip:".toLowerCase())?o=e.substring("ip:".length):e.startsWith("群：".toLowerCase())?i=e.substring("群：".length):e.startsWith("G：".toLowerCase())?i=e.substring("G：".length):e.startsWith("標籤：".toLowerCase())?s=e.substring("標籤：".length):e.startsWith("t：".toLowerCase())?s=e.substring("t：".length):e.startsWith("atag：".toLowerCase())?a=e.substring("atag：".length):e.startsWith("a:".toLowerCase())?a=e.substring("a:".length):e.startsWith("操作系統：".toLowerCase())?r=e.substring("操作系統：".length):e.startsWith("上午：".toLowerCase())?d=e.substring("上午：".length):e.startsWith("描述：".toLowerCase())?c=e.substring("描述：".length):"wsc:ok"==e?l=1:"wsc:noav"==e?l=2:"wsc:noupdate"==e?l=3:"wsc:nofirewall"==e?l=4:"wsc:any"==e&&(l=5),""==e)for(var u in nodes)t.push(u);else if(null!=o)for(var u in nodes)null!=nodes[u].ip&&0<=nodes[u].ip.toLowerCase().indexOf(o)&&t.push(u);else if(null!=i)for(var u in nodes)0<=meshes[nodes[u].meshid].name.toLowerCase().indexOf(i)&&t.push(u);else if(null!=s){for(var u in nodes)if(null==nodes[u].tags&&""==s)t.push(u);else if(null!=nodes[u].tags)for(var p in nodes[u].tags)if(0<=nodes[u].tags[p].toLowerCase().indexOf(s)){t.push(u);break}}else if(null!=a)for(var u in nodes)(null!=nodes[u].agent&&null==nodes[u].agent.tag&&""==a||null!=nodes[u].agent&&null!=nodes[u].agent.tag&&0<=nodes[u].agent.tag.toLowerCase().indexOf(a))&&t.push(u);else if(null!=n){for(var u in nodes)if(nodes[u].users&&0<nodes[u].users.length)for(var m in nodes[u].users)0<=nodes[u].users[m].toLowerCase().indexOf(n)&&t.push(u)}else if(null!=r)for(var u in nodes)null!=nodes[u].osdesc&&0<=nodes[u].osdesc.toLowerCase().indexOf(r)&&t.push(u);else if(null!=d)for(var u in nodes)null==nodes[u].intelamt||""!=d&&nodes[u].intelamt.state!=d||t.push(u);else if(null!=c)for(var u in nodes)null!=nodes[u].desc&&""!=nodes[u].desc&&(""==c||0<=nodes[u].desc.toLowerCase().indexOf(c))&&t.push(u);else if(null!=l)for(var u in nodes)!nodes[u].wsc||(1==l&&"OK"==nodes[u].wsc.antiVirus&&"OK"==nodes[u].wsc.autoUpdate&&"OK"==nodes[u].wsc.firewall||(2==l||5==l)&&"OK"!=nodes[u].wsc.antiVirus||(3==l||5==l)&&"OK"!=nodes[u].wsc.autoUpdate||(4==l||5==l)&&"OK"!=nodes[u].wsc.firewall)&&t.push(u);else if("*"==e)for(var u in nodes)1==stars[nodes[u]._id]&&t.push(u);else try{var g=e.split(/\s+/).join("|"),h=new RegExp(g);for(u in nodes)32768&features2?268435456&features2?(h.test(nodes[u].name.toLowerCase())||h.test(meshes[nodes[u].meshid].name.toLowerCase())||null!=nodes[u].rnamel&&h.test(nodes[u].rnamel.toLowerCase()))&&t.push(u):(h.test(nodes[u].name.toLowerCase())||null!=nodes[u].rnamel&&h.test(nodes[u].rnamel.toLowerCase()))&&t.push(u):268435456&features2?showRealNames?(null!=nodes[u].rnamel&&h.test(nodes[u].rnamel.toLowerCase())||h.test(meshes[nodes[u].meshid].name.toLowerCase()))&&t.push(u):(h.test(nodes[u].name.toLowerCase())||h.test(meshes[nodes[u].meshid].name.toLowerCase()))&&t.push(u):showRealNames?null!=nodes[u].rnamel&&h.test(nodes[u].rnamel.toLowerCase())&&t.push(u):h.test(nodes[u].name.toLowerCase())&&t.push(u)}catch(e){for(var u in nodes)t.push(u)}return t}function onSearchInputChanged(){var e=Q("SearchInput").value.toLowerCase().trim(),t=(putstore("_search",Q("SearchInput").value),""==e?QC("SearchInput").remove("search"):QC("SearchInput").add("search"),QV("SearchInputClearButton",""!=e),QV("KvmSearchInputClearButton",""!=e),parseSearchOrInput(e));for(o in nodes)nodes[o].v=0<=t.indexOf(o);var n,e=Q("DevFilterSelect").value;if(1==e)for(var o in nodes)null!=nodes[o].conn&&0!=nodes[o].conn||3==nodes[o].mtype||(nodes[o].v=!1);if(2==e)for(var o in nodes)(null==(n=nodes[o]).sessions||null==n.sessions.kvm&&null==n.sessions.terminal&&null==n.sessions.files&&null==n.sessions.tcp&&null==n.sessions.udp)&&(n.v=!1);if(3==e)for(var o in nodes)1!=stars[nodes[o]._id]&&(nodes[o].v=!1);if(4==e)for(var o in nodes)null==nodes[o].intelamt&&(nodes[o].v=!1);if(5==e)for(var o in nodes)null!=nodes[o].conn&&0!=nodes[o].conn&&(nodes[o].v=!1);if(6==e)for(var o in nodes)null!=(n=nodes[o]).sessions&&null!=n.sessions.help||(n.v=!1);if(7==e)for(var o in nodes)null!=(n=nodes[o]).tags&&0!=n.tags.length||(n.v=!1);if(8==e)for(var o in nodes)null!=(n=nodes[o]).tags&&0<n.tags.length&&(n.v=!1)}function newContextMenu(e,t){if(1===t){if(null==currentNode||null==currentNode.agent||3==currentNode.mtype)return!0;if(!(serverinfo.linuxshell&&4<currentNode.agent.id)){t=e.target.nextElementSibling;if(t)for(var n=t.children,o=4<currentNode.agent.id&&!isWindowsNode(currentNode)?"lin":34==currentNode.agent.id?"add":null,i=0;i<n.length;i++)n[i].style.display=o?n[i].classList.contains(o)?"block":"none":n[i].classList.contains("lin")||n[i].classList.contains("ass")?"none":"block"}}}var contextelement=null;function handleContextMenu(e){if(hideContextMenu(),!xxdialogMode){for(var t=null!==window.pageXOffset?window.pageXOffset:(document.documentElement||document.body.parentNode||document.body).scrollLeft,n=null!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop,o=document.elementFromPoint(e.pageX-t,e.pageY-n);o&&null!=o&&null==o.attributes.cmenu;)o=o.parentElement;if(null==o)return!0;t=o.attributes.cmenu.value;if("devsContentMenu"===t){contextelement=o;var i=document.getElementById("contextMenu"),n=(showContextMenuDiv(i,e.pageX,e.pageY),getNodeFromId((n=(1==Q("viewselect").value?contextelement.children[0].children[0].children[1].children[0]:contextelement.children[1]).attributes.onmouseup.value).substring(12,n.length-18))),s=GetNodeRights(n),a=0!=(16&s),l=4294967295==s||0==(512&s),r=4294967295==s||0==(1024&s);QV("cxdesktop",0!=(1&n.conn)&&4!=n.mtype&&(1==n.mtype||null==n.agent||null==n.agent.caps||0!=(1&n.agent.caps)||n.intelamt&&2==n.intelamt.state)&&(8&s||256&s)&&(4294967295==s||0==(65536&s))),QV("cxterminal",0!=(1&n.conn)&&4!=n.mtype&&(1==n.mtype||null==n.agent||null==n.agent.caps||0!=(2&n.agent.caps)||n.intelamt&&2==n.intelamt.state)&&8&s&&l),QV("cxfiles",4!=n.mtype&&2==n.mtype&&(null==n.agent||null==n.agent.caps||0!=(4&n.agent.caps))&&8&s&&r),QV("cxevents",null!=n.intelamt&&(2==n.intelamt.state||2&n.conn)&&8&s),QV("cxdetails",n.mtype<3),QV("cxwebvnc",(0!=(1&n.conn)||3==n.mtype)&&n.agent&&0!=(8&s)&&0==(536870912&features)),QV("cxwebrdp",(0!=(1&n.conn)||3==n.mtype)&&n.agent&&0!=(8&s)&&0==(1073741824&features)),QV("cxwebssh",512&features2&&(0!=(1&n.conn)||3==n.mtype)&&n.agent&&0!=(8&s)),QV("cxconsole",a&&2==n.mtype&&(null==n.agent||null==n.agent.caps||0!=(8&n.agent.caps))&&8&s),QV("cxrdp",!1),0==(1&n.conn)&&3!=n.mtype||!n.agent||0==(8&s)||0<n.agent.id&&n.agent.id<5&&("win32"!=navigator.platform.toLowerCase()||null!=serverinfo.devicemeshrouterlinks&&0==serverinfo.devicemeshrouterlinks.rdp||QV("cxrdp",!0)),QV("cxmgroupsplit",!0),QV("cxstar",!0)}else{if(null==(i=document.getElementById(t)))return!0;contextelement=o,showContextMenuDiv(i,e.pageX,e.pageY)}return haltEvent(e)}}function showContextMenuDiv(e,t,n){var o=document.documentElement.getBoundingClientRect(),i=o.height,o=o.width;e.style.left=e.style.right=e.style.top=e.style.bottom=null,o/2<t?e.style.right=o-event.pageX+"px":e.style.left=event.pageX+"px",i/2<n?e.style.bottom=i-event.pageY+"px":e.style.top=event.pageY+"px",e.style.display="block"}function cmaction(e,t){var n,o=(1==Q("viewselect").value?contextelement.children[0].children[0].children[1].children[0]:contextelement.children[1]).attributes.onmouseup.value;if(o=o.substring(12,o.length-18),9==e&&(Q("viewselect").value=3,Q("viewselect").onchange(),Q("autoConnectDesktopCheckbox").checked=!0,Q("autoConnectDesktopCheckbox").onclick()),0<e&&e<9&&(n=[0,10,12,11,13,16,17,15,19][e],t&&1==t.shiftKey?safeNewWindow(window.location.origin+"?node="+o.split("/")[2]+"&viewmode="+n+"&hide=16"+(urlargs.key?"&key="+urlargs.key:""),"meshcentral:"+o):(gotoDevice(o,n),t=meshes[currentNode.meshid],1&currentNode.conn&&2==t.mtype&&(11==n&&null==desktop&&1&currentNode.agent.caps&&connectDesktop(null,3),12==n&&null==terminal&&2&currentNode.agent.caps&&connectTerminal(null,1),13==n)&&null==files&&connectFiles(null))),10==e){for(var i=document.getElementsByClassName("DeviceCheckbox"),s=[],a=0;a<i.length;a++)!0===i[a].checked&&s.push(i[a].defaultValue.substring(6));for(a in 0==s.length&&s.push(o),s)null!=stars[s[a]]&&(delete stars[s[a]],delete s[a]);var l=Object.keys(stars).length;for(a in s)l<200&&null==stars[s[a]]&&(stars[s[a]]=1,l++);putstore("stars",JSON.stringify(stars)),updateDeviceViewDevice(o),3==Q("DevFilterSelect").value&&mainUpdate(1)}else 11==e?p10mstsc(o):12==e?p10rfb(o):13==e?p10ssh(o):14==e&&p10MCRouter(o,3)}function cmmeshaction(e){var t=contextelement.attributes.onclick.value.substring(10,contextelement.attributes.onclick.value.length-2),n=document.getElementsByClassName("DeviceCheckbox");if(1==e||2==e){for(var o=0;o<n.length;o++)n[o].attributes&&n[o].attributes.class.value.split(" ")[0]==t&&(n[o].checked=1==e);if(1==e)for(var o in nodes)nodes[o].meshid==t&&1==nodes[o].v&&(checkedNodeids[nodes[o]._id]=1);else if(2==e)for(var o in checkedNodeids){var i=getNodeFromId(o);null!=i&&i.meshid==t&&1==i.v&&delete checkedNodeids[o]}}p1updateInfo()}function cmconnectfilesaction(){connectFiles(null,1,32)}function cmtermaction(e,t){e<100?connectTerminal(null,1,{protocol:e,consent:t}):100==e&&connectTerminal(null,1,{protocol:1,requireLogin:!0,consent:t})}function cmdeskaction(e){1==e&&connectDesktop(null,3,null,72),2==e&&connectDesktop(null,3,null,8),3==e&&connectDesktop(null,3,null,64),10==e&&null!=desktop&&(desktop.sendCtrlMsg('{"ctrlChannel":"102938","type":"autolock","value":true}'),connectDesktop()),11==e&&null!=desktop&&(desktop.sendCtrlMsg('{"ctrlChannel":"102938","type":"autolock","value":false}'),connectDesktop())}function cmaltportaction(e){xxdialogMode||(setModalContent("xxAddAgent","RDP連接",'RDP遠程連接介面：<br /><br /><input type=text placeholder="3389" inputmode="numeric" pattern="[0-9]*" onkeypress="return (event.keyCode == 8) || (event.charCode >= 48 && event.charCode <= 57)" maxlength=5 id=d10rdpport type=text>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){var e=0<Q("d10rdpport").value.length?parseInt(Q("d10rdpport").value):3389;meshserver.send({action:"changedevice",nodeid:currentNode._id,rdpport:e})}),Q("d10rdpport").focus(),null!=currentNode.rdpport&&(Q("d10rdpport").value=currentNode.rdpport))}function cmsshportaction(e){xxdialogMode||(setModalContent("xxAddAgent","SSH 連接",'SSH遠程連接端口：<br /><br /><input type=text placeholder="22" inputmode="numeric" pattern="[0-9]*" onkeypress="return (event.keyCode == 8) || (event.charCode >= 48 && event.charCode <= 57)" maxlength=5 id=d10sshport type=text>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){var e=0<Q("d10sshport").value.length?parseInt(Q("d10sshport").value):22;meshserver.send({action:"changedevice",nodeid:currentNode._id,sshport:e})}),Q("d10sshport").focus(),null!=currentNode.sshport&&(Q("d10sshport").value=currentNode.sshport))}function cmrfbportaction(e){xxdialogMode||(setModalContent("xxAddAgent","VNC 連接",'VNC遠程連接端口：<br /><br /><input type=text placeholder="5900" inputmode="numeric" pattern="[0-9]*" onkeypress="return (event.keyCode == 8) || (event.charCode >= 48 && event.charCode <= 57)" maxlength=5 id=d10rfbport type=text>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){var e=0<Q("d10rfbport").value.length?parseInt(Q("d10rfbport").value):3389;meshserver.send({action:"changedevice",nodeid:currentNode._id,rfbport:e})}),Q("d10rfbport").focus(),null!=currentNode.rfbport&&(Q("d10rfbport").value=currentNode.rfbport))}function cmhttpportaction(e){xxdialogMode||(setModalContent("xxAddAgent","HTTP 連接",'HTTP遠程連接端口：<br /><br /><input type=text placeholder="80" inputmode="numeric" pattern="[0-9]*" onkeypress="return (event.keyCode == 8) || (event.charCode >= 48 && event.charCode <= 57)" maxlength=5 id=d10httpport type=text>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){var e=0<Q("d10httpport").value.length?parseInt(Q("d10httpport").value):80;meshserver.send({action:"changedevice",nodeid:currentNode._id,httpport:e})}),Q("d10httpport").focus(),null!=currentNode.httpport&&(Q("d10httpport").value=currentNode.httpport))}function cmhttpsportaction(e){xxdialogMode||(setModalContent("xxAddAgent","HTTPS 連接",'HTTPS遠程連接端口：<br /><br /><input type=text placeholder="443" inputmode="numeric" pattern="[0-9]*" onkeypress="return (event.keyCode == 8) || (event.charCode >= 48 && event.charCode <= 57)" maxlength=5 id=d10httpsport type=text>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){var e=0<Q("d10httpsport").value.length?parseInt(Q("d10httpsport").value):443;meshserver.send({action:"changedevice",nodeid:currentNode._id,httpsport:e})}),Q("d10httpsport").focus(),null!=currentNode.httpsport&&(Q("d10httpsport").value=currentNode.httpsport))}function cmfilesaction(e){var t;xxdialogMode||(t=p13sort_files(p13filetree.dir)[parseInt(contextelement.attributes.fileindex.nodeValue)],1==e?(setModalContent("xxAddAgent","改名",'<input type=text id=p13renameinput maxlength=64 onkeyup=p13fileNameCheck(event) style=width:100% value="'+t.n+'" />'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13renamefileEx(3,{action:"rename",path:p13filetreelocation.join("/"),oldname:t.n})),focusTextBox("p13renameinput"),p13fileNameCheck()):2==e?t.s<=204800?p13downloadfile(encodeURIComponentEx(p13filetreelocation.join("/")+"/"+t.n),encodeURIComponentEx(t.n),t.s,"viewer"):messagebox("檔案編輯器","只能編輯小於200k的檔案。"):3==e&&(setModalContent("xxAddAgent","刪除","刪除項目？"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13deletefileCm(3,t))))}function cmexpandaction(e){if(1==e)CollapsedGroups={};else{if(0==sort){for(var t in CollapsedGroups={},meshes)CollapsedGroups[t]=!0;for(var t in nodes)null==meshes[nodes[t].meshid]&&(CollapsedGroups[nodes[t].meshid]=!0)}if(1==sort){CollapsedGroups={};for(t=0;t<10;t++)CollapsedGroups["pwr:"+t]=!0}if(3==sort)for(var t in CollapsedGroups={},nodes)if((o=nodes[t]).tags)for(var n in o.tags)CollapsedGroups["tag:"+encodeURIComponentEx(o.tags[n])]=!0;if(4==sort)for(var t in CollapsedGroups={},nodes){var o=nodes[t],i=meshes[o.meshid];if(i){if(CollapsedGroups["tag:"+encodeURIComponentEx(i.name)]=!0,o.tags)for(var n in o.tags)CollapsedGroups["tag:"+encodeURIComponentEx(i.name+" - "+o.tags[n])]=!0}else if(o.tags)for(var n in o.tags)CollapsedGroups["tag:"+encodeURIComponentEx("**INDV*~*DEVS** - "+o.tags[n])]=!0}}putstore("_collapse",JSON.stringify(CollapsedGroups)),updateCollapseAllButton(),mainUpdate(4)}function cmdeskplayeraction(e){xxdialogMode||safeNewWindow(window.location.origin+"{{{domainurl}}}player.htm"+(urlargs.key?"?key="+urlargs.key:""),"meshcentral-deskplayer")}function cmdeskshortcutaction(e){xxdialogMode||deskCustomizeKeys()}function cmdeskpreconfigtypeaction(e){xxdialogMode||(-1==e?deskCustomizeStrings():showDeskTypeEx(e<1e3?serverinfo.preConfiguredRemoteInput[e].value:deskKeyboardStrings[e-1e3].v))}function cmdeskpreconfigscriptaction(e){meshserver.send({action:"runcommands",nodeids:[currentNode._id],presetcmd:e})}function p13deletefileCm(e,t){files.sendText({action:"rm",reqid:1,path:p13filetreelocation.join("/"),delfiles:[t.n],rec:!1}),p13folderup(999)}function hideContextMenu(){QV("contextMenu",!1),QV("meshContextMenu",!1),QV("altPortContextMenu",!1),QV("rfbPortContextMenu",!1),QV("sshPortContextMenu",!1),QV("httpPortContextMenu",!1),QV("httpsPortContextMenu",!1),QV("filesContextMenu",!1),QV("deskPlayerContextMenu",!1),QV("deskKeyShortcutContextMenu",!1),QV("deskPreConfigShortcutContextMenu",!1),QV("deskPreConfigScriptContextMenu",!1),QV("expandAllContextMenu",!1),contextelement=null}var map_cm_popup,map_cm_editMarker,map_cm_clearMarker,map_cm_saveMarker,map_cm_nodemenu_items,contextmenu_items,currentNode,xxmap={map:null,contextmenu:null,activeInteractions:[],showindex:0,markersSource:null,markersLayer:null,mapLayer:null,mapView:null};function updateMapMarkers(e){if(0!=(32768&features)){if(null!=xxmap&&null==xxmap.map)try{loadmap()}catch(e){console.error("loadmap() exception",e)}if(null!=xxmap){var t,n=null;for(t in nodes)try{var o,i,s=map_parseNodeLoc(nodes[t]),a=xxmap.markersSource.getFeatureById(nodes[t]._id);null==s||nodes[t].meshid!=e&&null!=e?a&&xxmap.markersSource.removeFeature(a):(o=s[0],i=s[1],s[2],null==n?n=[o,i,o,i,0]:(o<n[0]&&(n[0]=o),i<n[1]&&(n[1]=i),o>n[2]&&(n[2]=o),i>n[3]&&(n[3]=i)),null==a?(addFeature(nodes[t]),n[4]=1):(updateFeature(nodes[t],a),a.setStyle(markerStyle(nodes[t],s[2]))))}catch(e){console.error("updateMapMarkers() exception",e,JSON.stringify(nodes[t]))}return n}}}function stringToIntHash(e){for(var t=0,n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return t}function map_parseNodeLoc(e){var t=null,n=0;return e.iploc&&(t=e.iploc,n=1),e.wifiloc&&(t=e.wifiloc,n=2),e.gpsloc&&(t=e.gpsloc,n=3),e.userloc&&(t=e.userloc,n=4),null==t||"string"!=typeof t?null:(t=t.split(","),1==n?[parseFloat(t[0])+stringToIntHash(e._id.substring(0,20))/1e11,parseFloat(t[1])+stringToIntHash(e._id.substring(20))/1e11,n]:[parseFloat(t[0]),parseFloat(t[1]),n])}function loadmap(){if(0!=(32768&features)&&null!=xxmap)if(0==(32768&features))xxmap=null;else{QV("viewselectmapoption",!0),QV("devViewButton4",!0);try{xxmap.markersSource=new ol.source.Vector,xxmap.markersLayer=new ol.layer.Vector({source:xxmap.markersSource}),xxmap.mapLayer=new ol.layer.Tile({source:new ol.source.OSM}),xxmap.mapView=new ol.View({center:ol.proj.transform([0,0],"EPSG:4326","EPSG:3857"),zoom:2,minZoom:2,maxZoom:20,extent:ol.proj.transformExtent([-1e5,-69.55,1e5,69.55],"EPSG:4326","EPSG:3857")}),xxmap.map=new ol.Map({target:"xdevicesmap",layers:[xxmap.mapLayer,xxmap.markersLayer],view:xxmap.mapView}),xxmap.map.addOverlay(map_cm_popup),xxmap.map.on("click",function(e){var t,e=xxmap.map.forEachFeatureAtPixel(e.pixel,function(e,t){return e});e&&gotoDevice(null!=(t=e.getId())?t:getCorrespondingFeature(e).getId(),10)}),xxmap.map.on("pointermove",function(e){var t,e=xxmap.map.forEachFeatureAtPixel(e.pixel,function(e,t){return e});e?(xxmap.map.getTargetElement().style.cursor="pointer",t=e.getGeometry().getCoordinates(),map_cm_popup.setPosition(t),e.getId()?QH("xmap-info-window",e.get("name")):(t=getCorrespondingFeature(e),QH("xmap-info-window",t.get("name")))):(xxmap.map.getTargetElement().style.cursor="",QH("xmap-info-window",""))});var e=new ContextMenu({width:160,defaultItems:!1,items:contextmenu_items});e.on("open",function(e){var e=xxmap.map.forEachFeatureAtPixel(e.pixel,function(e,t){return e});xxmap.contextmenu.clear(),e?e.getId()?addContextMenuItems(e):(e=getCorrespondingFeature(e))?addContextMenuItems(e):xxmap.contextmenu.extend(contextmenu_items):xxmap.contextmenu.extend(contextmenu_items)}),null==xxmap.contextmenu&&(xxmap.contextmenu=e),xxmap.map.addControl(xxmap.contextmenu)}catch(e){console.log(e),QV("viewselectmapoption",!1),QV("devViewButton4",!1),xxmap=null}}}function addFeature(e,t,n){var o=getModifiedFeature(e._id);o?xxmap.markersSource.addFeature(o):(t||n||(t=(o=map_parseNodeLoc(e))[0],n=o[1]),180<n&&meshserver.send({action:"changedevice",nodeid:e._id,userloc:[t,n=180-n]}),t<90&&-90<t&&n<180&&-180<n&&((o=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform([n,t],"EPSG:4326","EPSG:3857")),name:e.name,status:e.conn,lat:t,lon:n})).setId(e._id),o.setStyle(markerStyle(e)),xxmap.markersSource.addFeature(o)))}function removeFeature(e){e=xxmap.markersSource.getFeatureById(e._id);e&&xxmap.markersSource.removeFeature(e)}function updateFeature(e,t){e.conn!=t.get("status")&&(t.set("status",e.conn),t.setStyle(markerStyle(e)));var n,o=map_parseNodeLoc(e);null!=o&&(n=o[0],o=o[1],n==t.get("lat")&&o==t.get("lon")||(t.set("lat",n),t.set("lon",o),o=ol.proj.transform([parseFloat(o),parseFloat(n)],"EPSG:4326","EPSG:3857"),t.getGeometry().setCoordinates(o))),e.name!=t.get("name")&&t.set("name",e.name)}function modifyMarkerloc(e){var t,n=e.getId();n&&(e.setStyle(markerStyle(getNodeFromId(e.a),4)),getActiveInteractions(e)||(t=new ol.interaction.Modify({features:new ol.Collection([e]),pixelTolerance:10}),xxmap.activeInteractions.push({featureid:n,feature:e,interaction:t}),xxmap.map.addInteraction(t)))}function saveMarkerloc(e){var t,n=e.getId();n&&(t=getActiveInteractions(e))&&(xxmap.map.removeInteraction(t),removeInteraction(n),t=e.getGeometry().getCoordinates(),180<(e=ol.proj.transform(t,"EPSG:3857","EPSG:4326"))[0]&&(e[0]=180-e[0]),meshserver.send({action:"changedevice",nodeid:n,userloc:[e[1],e[0]]}))}function markerStyle(e,t){null==t&&(t=0,e.iploc&&(t=1),e.wifiloc&&(t=2),e.gpsloc&&(t=3),e.userloc)&&(t=4);e=connStateColor(e);return[new ol.style.Style({image:new ol.style.Icon({color:e,anchor:[.5,1],src:"images/mapmarker"+["","-ip","-wifi","-gps","-user"][t]+".png"})})]}function connStateColor(e){return 1==e.conn||3==e.conn||5==e.conn?"#00ffdd":"#C70039"}function addContextMenuItems(t){getActiveInteractions(t)?(map_cm_saveMarker.data=t,xxmap.contextmenu.push(map_cm_saveMarker)):(map_cm_editMarker.data=t,xxmap.contextmenu.push(map_cm_editMarker),getNodeFromId(t.a).userloc&&(map_cm_clearMarker.data=t,xxmap.contextmenu.push(map_cm_clearMarker))),map_cm_nodemenu_items.forEach(function(e){"放大到一定程度"==e.text||"縮小到一定程度"==e.text?e.data=t:"-"!=e&&(e.data=t.getId())}),xxmap.contextmenu.extend(map_cm_nodemenu_items)}function getActiveInteractions(e){for(var t=e.getId(),n=0;n<xxmap.activeInteractions.length;n++)if(xxmap.activeInteractions[n].featureid==t)return xxmap.activeInteractions[n].interaction;return!1}function getModifiedFeature(e){if(e)for(var t=0;t<xxmap.activeInteractions.length;t++)if(xxmap.activeInteractions[t].featureid==e)return xxmap.activeInteractions[t].feature;return null}function removeInteraction(e){for(var t=-1,n=0;n<xxmap.activeInteractions.length;n++)if(xxmap.activeInteractions[n].featureid===e){t=n;break}0<=t&&xxmap.activeInteractions.splice(t,1)}function getCorrespondingFeature(e){for(var t=e.getGeometry().getCoordinates(),n=0;n<xxmap.activeInteractions.length;n++){var o=xxmap.activeInteractions[n].feature,i=o.getGeometry().getCoordinates();if(i[0].toFixed(5)==t[0].toFixed(5)&&i[1].toFixed(5)==t[1].toFixed(5))return o}return null}function refreshMap(e,t){e&&(xxmap.map.setTarget(null),xxmap.map=null,xxmap.markersSource=null,xxmap.mapView=null,xxmap.mapLayer=null,xxmap.activeInteractions=[]);e=updateMapMarkers();if(null!=e&&(t||1==e[4])){for(var t=(e[0]+e[2])/2,n=(e[1]+e[3])/2,o=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),e=xxmap.map.getView(),i=(e.setCenter(ol.proj.transform([n,t],"EPSG:4326","EPSG:3857")),360),s=-2;o<i;)s++,i/=2;e.setZoom(s)}}function placeNode(e){if(!xxdialogMode){var t,n='<div style=margin-bottom:6px><label for=selectnode-search>搜尋</label>&nbsp&nbsp<input type=text placeholder="裝置名稱" id="selectnode-search" onchange=onPlaceNodeInputChange() onkeyup=onPlaceNodeInputChange() autocomplete=off style=width:120px></div><div id=placenode style="height:254px;overflow-y:auto;width:100%;margin:12px 1px 4px 1px;"><div id=noNodesMapPlace style=text-align:center;width:100%;display:none>找不到裝置。</div>';for(t in nodes)n=(n+="<div class=noselect id="+nodes[t]._id+"-rowid onclick=selectNodeToPlace(event,'"+nodes[t]._id+"') style=background-color:lightgray;margin-bottom:4px;border-radius:2px><input name=PlaceMapDeviceCheckbox id="+nodes[t]._id+'-checkid type=checkbox class="form-check-input me-2" style=width:16px;display:inline />')+"<div class=j"+nodes[t].icon+" style=width:16px;height:16px;margin-top:2px;margin-right:4px;display:inline-block></div><div style=width:16px;display:inline>"+nodes[t].name+"</div></div>";setModalContent("xxAddAgent","選擇要放置的節點",n+"</div>"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>placeNodeEx(3,e)),onPlaceNodeInputChange()}}function placeNodeEx(e,t){var n,o,i,s,a=document.getElementsByName("PlaceMapDeviceCheckbox");for(n in a)a[n].checked&&(o=getNodeFromId(a[n].id.substring(0,a[n].id.length-8)))&&(i=xxmap.markersSource.getFeatureById(n),s=[(s=ol.proj.transform(t,"EPSG:3857","EPSG:4326"))[1],s[0]],i&&(i.getGeometry().setCoordinates(t),getActiveInteractions(i))?saveMarkerloc(i):meshserver.send({action:"changedevice",nodeid:o._id,userloc:s}))}function onPlaceNodeInputChange(){updatePlaceNodeTable(Q("selectnode-search").value.trim().toLowerCase())}function updatePlaceNodeTable(e){document.getElementsByName("PlaceMapDeviceCheckbox");var t,n=0;for(t in nodes){var o=0<=nodes[t].namel.indexOf(e)||""==e||null!=nodes[t].rnamel&&0<=nodes[t].rnamel.indexOf(e);o&&n++,QV(nodes[t]._id+"-rowid",o)}QV("noNodesMapPlace",0==n)}function selectNodeToPlace(e,t){"PlaceMapDeviceCheckbox"!=e.target.name&&((e=Q(t+"-checkid")).checked=!e.checked);var n,o=document.getElementsByName("PlaceMapDeviceCheckbox"),i=0;for(n in o)o[n].checked&&i++;QE("idx_dlgOkButton",0<i)}function addMeshOptions(e,t){}function meshOptionRmvMod(e,t){}function meshExists(){for(var e in meshes)if(meshes[e])return!0;return!1}function setMeshView(e){var t=Q("select-mesh");t[t.selectedIndex].value==e&&(t[0].selected=!0,onSelectMeshChange())}function clearMeshOptions(){}function getSearchLocation(){try{var e,t=Q("mapSearchLocation").value.trim();0<t.length&&((e=new XMLHttpRequest).onreadystatechange=function(){4==e.readyState&&200==e.status&&formatSearchData(e.responseText)},e.open("GET","https://nominatim.openstreetmap.org/search?q="+t+"&format=json",!0),e.send())}catch(e){}}function formatSearchData(e){try{QH("xmapSearchResults","");for(var t=JSON.parse(e),n=0,o='<div class="xmapItem">',i=0;i<t.length;i++)t[i].display_name&&t[i].boundingbox[0]&&t[i].boundingbox[1]&&t[i].boundingbox[2]&&t[i].boundingbox[3]&&(n++,o+='<div class="xmapItemSel1" onclick=mapGotoSelectedLocation(this)><div>'+t[i].display_name+"</div><div style=display:none>"+t[i].boundingbox[0]+"!#!"+t[i].boundingbox[1]+"!#!"+t[i].boundingbox[2]+"!#!"+t[i].boundingbox[3]+"</div></div>");o+="</div>",1==n?zoomToExtent([parseFloat(t[0].boundingbox[2]),parseFloat(t[0].boundingbox[0]),parseFloat(t[0].boundingbox[3]),parseFloat(t[0].boundingbox[1])]):(0==n&&(o="<div style=width:200px>找不到位置。<div>"),QV("xmapSearchResultsDlg",!0)),QH("xmapSearchResults",o)}catch(e){}}function mapGotoSelectedLocation(e){e=e.children[1].innerHTML.split("!#!");zoomToExtent([parseFloat(e[2]),parseFloat(e[0]),parseFloat(e[3]),parseFloat(e[1])]),mapCloseSearchWindow()}function mapCloseSearchWindow(){QH("xmapSearchResults",""),QV("xmapSearchResultsDlg",!1)}function zoomToLocation(e,t){var n=xxmap.map.getView();n.setCenter(e),n.setZoom(t)}function zoomToFitExtent(){var e;0<xxmap.markersSource.getFeatures().length&&(e=xxmap.markersSource.getExtent(),xxmap.map.getView().fit(e,xxmap.map.getSize()))}function zoomToExtent(e){e=ol.proj.transformExtent(e,ol.proj.get("EPSG:4326"),ol.proj.get("EPSG:3857"));xxmap.map.getView().fit(e,xxmap.map.getSize())}function refreshDevice(e){currentNode&&currentNode._id==e&&gotoDevice(e,xxcurrentView,!0)}32768&features&&(map_cm_popup=new ol.Overlay({element:Q("xmap-info-window"),positioning:"bottom-center",stopEvent:!1}),map_cm_editMarker={text:"修改節點位置",callback:function(e){modifyMarkerloc(e.data)}},map_cm_clearMarker={text:"刪除節點位置",callback:function(e){meshserver.send({action:"changedevice",nodeid:e.data.a,userloc:[]})}},map_cm_saveMarker={text:"保存節點位置",callback:function(e){saveMarkerloc(e.data)}},map_cm_nodemenu_items=[{text:"一般訊息",callback:function(e){null!=e.data&&gotoDevice(e.data,10)}},{text:"桌面",callback:function(e){null!=e.data&&gotoDevice(e.data,11)}},{text:"終端機",callback:function(e){null!=e.data&&gotoDevice(e.data,12)}},{text:"Intel&reg; AMT",callback:function(e){null!=e.data&&gotoDevice(e.data,14)}},"-",{text:"放大到一定程度",callback:function(e){zoomToLocation(e.data.getGeometry().getCoordinates(),19)}},{text:"縮小到一定程度",callback:function(e){zoomToLocation(e.data.getGeometry().getCoordinates(),2)}}],contextmenu_items=[{text:"刷新",callback:function(){refreshMap(!0,!0)}},{text:"縮放至適合範圍",callback:function(){zoomToFitExtent()}},{text:"在這裡為中心顯示地圖",callback:function(e){xxmap.mapView.animate({center:e.coordinate})}},{text:"將節點放在這裡",callback:function(e){placeNode(e.coordinate)}}]);var powerTimelineNode=null,powerTimelineReq=null,powerTimelineUpdate=null,powerTimeline=null,deviceSharesNode=null,deviceSharesReq=null,deviceShares=null;function getCurrentNode(){return currentNode}function gotoDevice(e,t,n,o){if(!o||3!=o.which&&2!=o.button)if(!0!==userinfo.emailVerified&&1==serverinfo.emailcheck&&4294967295!=userinfo.siteadmin)setModalContent("xxAddAgent","帳號安全","在驗證電子郵件地址之前，無法訪問此功能。這是密碼恢復所必需的。轉到“我的帳戶”標籤以更改和驗證電子郵件地址。"),showModal("xxAddAgentModal","idx_dlgOkButton");else if(262144&features&&0==count2factoraAuths())setModalContent("xxAddAgent","帳號安全","在啟用兩因素身份驗證之前，無法訪問此功能。這是額外的安全性所必需的。轉到“我的帳戶”標籤，然後查看“帳戶安全性”部分。"),showModal("xxAddAgentModal","idx_dlgOkButton");else if(!o||1!=o.shiftKey&&2!=o.which&&1!=o.button){var i=getNodeFromId(e);if(null!=i){null!=currentNode&&currentNode._id==i._id&&0!=(1&i.conn)||deviceDetailsStatsClear();var s=meshes[i.meshid],a=GetNodeRights(i),H=null==currentNode||currentNode._id!=e;if(!currentNode||currentNode._id!=i._id||1==n){currentNode=i,QV("deskPreConfigScriptContextMenu1",2==currentNode.mtype&&isWindowsNode(currentNode)),QV("deskPreConfigScriptContextMenu2",2==currentNode.mtype&&!isWindowsNode(currentNode)),QV("p10deviceNotify",null!=currentNode.sessions&&(null!=currentNode.sessions.kvm||null!=currentNode.sessions.terminal||null!=currentNode.sessions.files||null!=currentNode.sessions.tcp||null!=currentNode.sessions.udp)),QV("p10deviceStar",1==stars[currentNode._id]),QV("p10deviceHelp",null!=currentNode.sessions&&null!=currentNode.sessions.help),null!=currentNode.sessions&&null!=currentNode.sessions.msg?(QV("p10deviceMsg",!0),QH("p10deviceMsg",Object.keys(currentNode.sessions.msg).length)):QV("p10deviceMsg",!1),QV("p10deviceBattery",!1),null!=currentNode.sessions&&null!=currentNode.sessions.battery?(f="","ac"==(l=currentNode.sessions.battery).state&&(f="裝置已插入"),"dc"==l.state&&(f="裝置由電池供電"),d="",w=-1,"number"==typeof l.level&&0<=l.level&&l.level<=100&&(d=l.level+"%",5<(w=Math.floor((l.level+10)/25)+1)&&(lvl=5),"ac"==l.state)&&(100==l.level?w=11:w+=5),0<w&&(Q("p10deviceBattery").title=null!=f?f+", "+d:d,QV("p10deviceBattery",!0),Q("p10deviceBattery").className="deviceBatteryLarge deviceBatteryLarge"+w)):QV("p10deviceBattery",!1);var l=EscapeHtml(i.name),r=(0==l.length&&(l="<i>沒有</i>"),f=l=0==(4&a)||s.flags&&0!=(2&s.flags)?l:'<span tabindex=0 title="單擊此處編輯伺服器端裝置名稱" onclick=showEditNodeValueDialog(0) onkeyup="if (event.key == \'Enter\') showEditNodeValueDialog(0)" role="button">'+l+' <i class="fa-solid fa-pencil fa-2xs"/></i></span>',s&&(l+="<span style=color:#AAA;font-size:small> - "+EscapeHtml(s.name)+"</span>"),QH("p10deviceName",l),QH("p11deviceName",l),QH("p12deviceName",l),QH("p13deviceName",l),QH("p14deviceName",l),QH("p15deviceName","控制台 -"+l),QH("p16deviceName",l),QH("p17deviceName",l),QH("p19deviceName",l),"<table style=width:100%>"),d=(0!=(8&args.hide)&&(r+="<br />"+addDeviceAttribute("名稱",f)),s&&(r+=addDeviceAttribute('<span title="此電腦所屬的裝置群的名稱。">群</span>','<a href=# title="此電腦所屬的裝置群的名稱" onclick=gotoMesh("'+i.meshid+'") style=cursor:pointer>'+EscapeHtml(meshes[i.meshid].name)+"</a>")),null!=i.rname&&i.name!=i.rname&&(r+=addDeviceAttribute('<span title="此電腦在操作系統中已設置的的名稱">操作系統名稱</span>','<span title="此電腦在操作系統中已設置的的名稱">'+EscapeHtml(i.rname)+"</span>")),(0==(1&features)&&4!=i.mtype||3==i.mtype)&&(r+=addDeviceAttribute("主機名",addLinkConditional(i.host?EscapeHtml(i.host):"<i>沒有</i>","showEditNodeValueDialog(1)",4&a))),i.desc?EscapeHtml(i.desc):"<i>沒有</i>");if(r+=addDeviceAttribute("描述",0!=(4&a)?"<span onclick=showEditNodeValueDialog(2) style=cursor:pointer>"+d+' <i class="fa-solid fa-pencil fa-xs" role="button"></i></span>':d),4==i.mtype&&(null!=i.portnum&&(r+=addDeviceAttribute("端口號",i.portnum)),null!=i.porttype)&&(r+=addDeviceAttribute("端口類型",i.porttype)),null!=i.agent&&null!=i.agent.id&&3==i.mtype?(4==i.agent.id&&(r+=addDeviceAttribute("設備類型","視窗")),6==i.agent.id&&(r+=addDeviceAttribute("設備類型","Linux")),29==i.agent.id&&(r+=addDeviceAttribute("設備類型","macOS"))):null!=i.agent&&null!=i.agent.id&&null!=i.agent.ver&&(x="",x=i.agent.id<=agentsStr.length?agentsStr[i.agent.id]:agentsStr[0],0!=i.agent.ver&&(x+=" v"+i.agent.ver),14==i.agent.id&&(x=i.agent.core),!1===i.agent.root&&0!=(1&i.conn)&&(x+=", 受限制的"),r+=addDeviceAttribute("Mesh Agent",x)),null!=i.intelamt&&(x="",w={0:nobreak("未啟動（預）"),1:nobreak("未啟動（輸入）"),2:nobreak("已啟動")},null!=i.intelamt.ver&&null==i.intelamt.state?x+="<i>未知狀態</i>, v"+EscapeHtml(i.intelamt.ver):null==i.intelamt.ver&&2==i.intelamt.state?x+="<i>已啟動</i>":null==i.intelamt.ver||null==i.intelamt.state?x+="<i>未知版本和狀態</i>":(x+=w[i.intelamt.state],2==i.intelamt.state&&i.intelamt.flags&&(2&i.intelamt.flags?x+=' <span title="Intel&reg; AMT在客户端控制模式下被启动">CCM</span>':4&i.intelamt.flags&&(x+=' <span title="在管理控制模式下啟動了Intel&reg; AMT">ACM</span>')),x+=", v"+EscapeHtml(i.intelamt.ver)),2==i.intelamt.state&&(1==i.intelamt.tls&&(x+=', <span title="Intel&reg; AMT已設置TLS網絡安全性">TLS</span>'),l=!1,null==i.intelamt.user||""==i.intelamt.user?0!=(4&a)?(x+=', <i style=color:#FF0000;cursor:pointer title="編輯Intel&reg; AMT憑證" onclick=editDeviceAmtSettings("'+i._id+'")>沒有憑證</i>',l=!0):x+=", <i style=color:#FF0000>沒有憑證</i>":0!=(1&features2)&&null!=i.intelamt.warn&&(f=null,0!=(1&i.intelamt.warn)&&(f="無效證件"),null!=(f=0!=(8&i.intelamt.warn)?"嘗試憑證":f))&&(0!=(4&a)?(x+=', <i style=color:#FF0000;cursor:pointer title="編輯Intel&reg; AMT憑證" onclick=editDeviceAmtSettings("'+i._id+'")>'+f+"</i>",l=!0):x+=", <i style=color:#FF0000>"+f+"</i>"),x+=" ",l=0!=(4&a)&&0==(1&features2)||l)&&(x+='<img src=images/link4.png height=10 width=10 title="編輯Intel&reg; AMT憑證" style=cursor:pointer onclick=editDeviceAmtSettings("'+i._id+'")>'),d='<span title="Intel&reg; Management Engine">Intel&reg; ME<span>',"number"==typeof i.intelamt.sku&&(0!=(8&i.intelamt.sku)?d='<span title="Intel&reg; Active Management Technology">Intel&reg; AMT<span>':0!=(16&i.intelamt.sku)&&(d='<span title="Intel&reg; Standard Manageability">Intel&reg; M<span>')),r+=addDeviceAttribute(d,x)),null!=i.agent&&null!=i.agent.tag?r+=addDeviceAttribute("代理標籤",p=(p=EscapeHtml(i.agent.tag)).startsWith("mailto:")?'<a href="'+EscapeHtml(p)+'">'+EscapeHtml(p.substring(7))+"</a>":p):null!=i.intelamt&&null!=i.intelamt.tag&&(r+=addDeviceAttribute("Intel&reg; AMT標籤",p=(p=EscapeHtml(i.intelamt.tag)).startsWith("mailto:")?'<a href="'+EscapeHtml(p)+'">'+EscapeHtml(p.substring(7))+"</a>":p)),i.osdesc&&(r+=addDeviceAttribute("操作系統",i.osdesc)),i.wsc&&(u=[],null!=i.wsc.antiVirus&&("OK"==i.wsc.antiVirus?u.push("視聽 - <span style=color:green>OK</span>"):u.push("視聽 - <span style=color:red>壞的</span>")),null!=i.wsc.autoUpdate&&("OK"==i.wsc.autoUpdate?u.push("更新資料 - <span style=color:green>OK</span>"):u.push("更新資料 - <span style=color:red>壞的</span>")),null!=i.wsc.firewall&&("OK"==i.wsc.firewall?u.push("防火牆 - <span style=color:green>OK</span>"):u.push("防火牆 - <span style=color:red>壞的</span>")),r+=addDeviceAttribute("Windows 安全",u.join(", "))),i.defender&&(u=[],null!=i.defender.RealTimeProtection&&(1==i.defender.RealTimeProtection?u.push("RealTimeProtection - <span style=color:green>On</span>"):u.push("RealTimeProtection - <span style=color:red>離開</span>")),null!=i.defender.TamperProtected&&(1==i.defender.TamperProtected?u.push("TamperProtection - <span style=color:green>On</span>"):u.push("TamperProtection - <span style=color:red>離開</span>")),0<u.length)&&(r+=addDeviceAttribute("Windows Defender",u.join(", "))),i.av&&0<i.av.length){var c,u=[];for(g in i.av)i.av[g].product&&(c=EscapeHtml(i.av[g].product),!0!==i.av[g].enabled&&(c+=" - <span style=color:red>已禁用</span>"),!0!==i.av[g].updated&&(c+=" - <span style=color:red>過時的</span>"),1==i.av[g].enabled&&1==i.av[g].updated&&(c+=" - <span style=color:green>OK</span>"),u.push(c));r+=addDeviceAttribute("防毒軟體",u.join("<br />"))}i.users&&0<i.users.length&&(w=i.users.map(function(e){return addKeyLinkConditional(EscapeHtml(e),"已鎖定",i.lusers&&0<=i.lusers.indexOf(e))}).join(", "),r+=addDeviceAttribute((i.users.length,"活躍用戶"),w)),null!=i.agent&&14!=i.agent.id&&3!=i.mtype&&(f=[],l=0,i.consent&&(l=i.consent),serverinfo.consent&&(l|=serverinfo.consent),64&l&&8&l?f.push("桌面提示+工具欄"):64&l?f.push("桌面工具欄"):8&l?f.push("桌面提示"):1&l&&f.push("桌面通知"),16&l?f.push("終端機提示"):2&l&&f.push("終端機通知"),32&l?f.push("檔案提示"):4&l&&f.push("檔案通知"),7==l&&(f=["一直通知"]),r+=addDeviceAttribute("用戶同意",addLinkConditional(f=""==(f=(f=56==(56&l)?["一直提示"]:f).join(", "))?"<i>沒有</i>":f,"p20editmeshconsent(3)",1&a)));var d=[],p=(null!=userinfo.notify&&null!=userinfo.notify[i._id]&&(2&(x=userinfo.notify[i._id])&&d.push("連接"),4&x&&d.push("斷線"),null!=i.intelamt&&8&x&&d.push("Intel&reg; AMT"),16384&features2&&userinfo.emailVerified&&(k=0,16&x&&k++,32&x&&k++,64&x&&k++,0<k)&&d.push(format("Email ({0})",k)),null!=userinfo.msghandle)&&0!=(33554432&features2)&&(k=0,128&x&&k++,256&x&&k++,512&x&&k++,0<k)&&d.push(format("Messaging ({0})",k)),r+=addDeviceAttribute("通知",addLink(d=""==(d=d.join(", "))?"<i>沒有</i>":d,"p20editDeviceNotify()")),i.conn),m=(p&&1<p&&(w=[],0!=(1&i.conn)&&w.push('<span title="已連接Mesh Agent並準備使用。">Mesh Agent</span>'),0!=(2&i.conn)?w.push('<span title="Intel&reg; AMT CIRA已連接並可以使用。">Intel&reg; AMT CIRA</span>'):0!=(4&i.conn)&&w.push('<span title="Intel&reg; AMT可路由並可以使用。">Intel&reg; AMT</span>'),0!=(8&i.conn)&&w.push('<span title="Mesh Agent可以經過其他代理作為中繼訪問得到。">Mesh Relay</span>'),0!=(16&i.conn)&&w.push('<span title="與裝置的MQTT連接已啟動。">MQTT</span>'),r+=addDeviceAttribute("連接性",w.join(", "))),"<i>沒有</i>");if(null!=i.tags)for(var g in m="",i.tags)m+="<span class=tagSpan>"+EscapeHtml(i.tags[g])+"</span> ";r+=addDeviceAttribute("標籤",0!=(4&a)?"<span onclick=showEditNodeValueDialog(3) style=line-height:26px;cursor:pointer>"+m+' <i class="fa-solid fa-pencil fa-xs" role="button"></i></span>':"<span style=line-height:26px>"+m+"</span>"),null==i.ssh&&null==i.rdp||(u=[],0!=(4&a)?(null!=i.ssh&&u.push("<span onclick=showClearSshDialog(3) style=cursor:pointer>"+(1==i.ssh?"SSH-用戶+密碼":2==i.ssh?"SSH-用戶+密鑰+密碼":"SSH-用戶+密鑰")+' <i class="fa-solid fa-pencil fa-xs" role="button"></i></span>'),null!=i.rdp&&u.push('<span onclick=showClearRdpDialog(3) style=cursor:pointer>RDP <i class="fa-solid fa-pencil fa-xs" role="button"></i></span>')):(null!=i.ssh&&u.push(1==i.ssh?"SSH-用戶+密碼":2==i.ssh?"SSH-用戶+密鑰+密碼":"SSH-用戶+密鑰"),null!=i.rdp&&u.push("RDP")),r+=addDeviceAttribute("證書",u.join(", ")));var h=[];for(g in meshes)meshes[g].relayid==i._id&&h.push('<a href=# onclick=gotoMesh("'+meshes[g]._id+'") style=cursor:pointer>'+EscapeHtml(meshes[g].name)+"</a>");if(0<h.length&&(r+=addDeviceAttribute('<span title="設備組此設備是中繼">繼電器</span>',h.join("，"))),r+="</table><br />",0!=(262220&a)&&i.mtype<3&&(null==i.agent||34!=i.agent.id)&&(r+='<input type=button class="btn btn-primary btn-sm me-2" value="動作" title="在裝置上執行電源操作" onclick=deviceActionFunction() />'),r=(r+='<input type=button class="btn btn-primary btn-sm me-2" value="筆記" title="查看有關此裝置的註釋" onclick=showNotes('+(0==(128&a))+',"'+encodeURIComponentEx(i._id)+'") />')+('<input type=button class="btn btn-primary btn-sm me-2" value="記錄事件" title="為此裝置寫一個事件" onclick=writeDeviceEvent("'+encodeURIComponentEx(i._id)+'") />'),2==i.mtype&&1&p&&0!=(131072&a)&&(r+='<input type=button class="btn btn-primary btn-sm me-2" cmenu=deskPreConfigScriptContextMenu value="Run" title="在此裝置上運行命令。" onclick=runDeviceCmd("'+encodeURIComponentEx(i._id)+'") />'),4!=i.mtype){if((8&a&&1&p&&0!=(16384&a)||1==i.pmt&&0!=(2&features2))&&(r+='<input type=button class="btn btn-primary btn-sm me-2" value="訊息" title="在遠程裝置上顯示短信" onclick=deviceMessageFunction() />'),(8&a&&1&p&&0!=(16384&a)||1==i.pmt&&0!=(2&features2))&&(r+='<input type=button class="btn btn-primary btn-sm me-2" value="聊天" title="打開此電腦的聊天窗口" onclick=deviceChat(event) />'),null!=serverinfo&&null!=serverinfo.altmessenging&&8&a&&1&p)for(var g in serverinfo.altmessenging){var v=serverinfo.altmessenging[g];null!=v.type&&"device"!=v.type||(r+='<input type=button class="btn btn-primary btn-sm me-2" value="'+EscapeHtml(serverinfo.altmessenging[g].name)+'" onclick=altDeviceChat(event,'+g+") />")}!1!==serverinfo.guestdevicesharing&&null!=i.agent&&3&i.agent.caps&&1&p&&524296==(524296&a)&&(4294967295==a||0==(4096&a))?(r+='<input type=button class="btn btn-primary btn-sm me-2" value="共享" title="創建鏈結以與訪客共享此裝置" onclick=showShareDevice() />',QV("DeskGuestShareButton",!0)):QV("DeskGuestShareButton",!1)}if(4==i.mtype&&1&p&&("PDU"==i.porttype?1==i.pwr?262144&a&&(r+='<input type=button class="btn btn-primary btn-sm me-2" value="關掉" title="關掉" onclick=setIpPduState(0) />'):8==i.pwr&&64&a&&(r+='<input type=button class="btn btn-primary btn-sm me-2" value="打開" title="打開" onclick=setIpPduState(1) />'):8&a&&(r+='<input type=button class="btn btn-primary btn-sm me-2" value="遙控" title="遙控" onclick=openIpKvmRemoteControl("'+encodeURIComponentEx(i._id)+'") />')),null!=customui&&null!=customui.devicebuttons)for(var g in customui.devicebuttons)(null==customui.devicebuttons[g].showif||null!=s&&customui.devicebuttons[g].showif==s._id||customui.devicebuttons[g].showif==currentNode._id)&&(r+='<input id="cui:'+g+'" type="button" class="btn btn-primary btn-sm me-2" value="'+customui.devicebuttons[g].name+'" onclick=customUIAction(event,"devicebuttons") />');QH("p10html",r),mainUpdate(256);var l=4294967295==a||0==(65536&a),f=4294967295==a||0==(512&a),x=4294967295==a||0==(1024&a),k=4294967295==a||0==(2048&a),r='<div class="p10html3right">';if(0!=(1&a)&&4!=i.mtype&&(r+='&nbsp;<a href=# onclick=p10showChangeGroupDialog(["'+i._id+'"]) title="將此裝置移至其他裝置群">更改群</a>'),0!=(32768&a)&&(r+='&nbsp;<a href=# onclick=p10showDeleteNodeDialog("'+i._id+'") title="刪除此裝置">刪除裝置</a>'),r+='</div><div class="p10html3left">',i.agent&&3!=i.mtype&&0!=(1048576&a)&&(r+='<a href=# onclick=p10showNodeNetInfoDialog("'+i._id+'") title="顯示裝置網絡介面訊息">介面</a>&nbsp;'),32768&features&&null!=xxmap&&(r+='<a href=# onclick=p10showNodeLocationDialog("'+i._id+'") title="顯示裝置位置訊息">位置</a>&nbsp;'),null==i.agent||14!=i.agent.id&&34!=i.agent.id){if(4294967295!=userinfo.siteadmin&&0!=(128&userinfo.siteadmin)||f&&0!=(8&a)&&null!=i.agent&&14!=i.agent.id&&(r+='<a href=# onclick=p10showMeshCmdDialog(1,"'+i._id+'") title="用於通過此伺服器連接到裝置的流量路由器.">MeshCmd</a>&nbsp;'),0!==args.xterm||!i.agent||0==(2&i.agent.caps)||0==(8&a)||4294967295!=a&&0!=(512&a)||(r+='<a href=# onclick=p10openxterm(event,"'+i._id+'") title="打開XTerm終端">XTerm</a>&nbsp;'),(0!=(1&p)||3==i.mtype)&&i.agent&&0!=(8&a)&&(0!=webRelayPort&&(r=(r+='<a href=# cmenu=httpPortContextMenu onclick=p10WebRouter("'+i._id+'",1,'+(i.httpport||80)+")>HTTP"+(i.httpport&&80!=i.httpport?"/"+i.httpport:"")+"</a>&nbsp;")+'<a href=# cmenu=httpsPortContextMenu onclick=p10WebRouter("'+i._id+'",2,'+(i.httpsport||443)+")>HTTPS"+(i.httpsport&&443!=i.httpsport?"/"+i.httpsport:"")+"</a>&nbsp;"),0<i.agent.id&&i.agent.id<5&&("win32"!=navigator.platform.toLowerCase()||null!=serverinfo.devicemeshrouterlinks&&0==serverinfo.devicemeshrouterlinks.rdp||(r+='<a href=# cmenu=altPortContextMenu id=rdpMCRouterLink onclick=p10MCRouter("'+i._id+'",3) title="需要安裝MeshCentral路由器.">RDP'+(i.rdpport&&3389!=i.rdpport?"/"+i.rdpport:"")+"</a>&nbsp;")),4<i.agent.id&&("win32"!=navigator.platform.toLowerCase()&&"macintel"!=navigator.platform.toLowerCase()||null!=serverinfo.devicemeshrouterlinks&&0==serverinfo.devicemeshrouterlinks.ssh||(r+='<a href=# cmenu=sshPortContextMenu onclick=p10MCRouter("'+i._id+'",4,'+(i.sshport||22)+') title="需要安裝MeshCentral Router。">SSH'+(i.sshport&&22!=i.sshport?"/"+i.sshport:"")+"</a>&nbsp;"),"win32"!=navigator.platform.toLowerCase()||null!=serverinfo.devicemeshrouterlinks&&0==serverinfo.devicemeshrouterlinks.scp||(r+='<a href=# cmenu=sshPortContextMenu onclick=p10MCRouter("'+i._id+'",5,'+(i.sshport||22)+') title="需要安裝MeshCentral Router。">SCP'+(i.sshport&&22!=i.sshport?"/"+i.sshport:"")+"</a>&nbsp;")),"win32"==navigator.platform.toLowerCase()||"macintel"==navigator.platform.toLowerCase())&&null!=serverinfo.devicemeshrouterlinks&&Array.isArray(serverinfo.devicemeshrouterlinks.extralinks))for(var g in serverinfo.devicemeshrouterlinks.extralinks){var y=serverinfo.devicemeshrouterlinks.extralinks[g],b='"'+y.protocol+'"';doesDeviceMatchFilterTags(i,y.filter)&&("number"==typeof y.protocol?b=y.protocol:"http"==y.protocol?b=1:"https"==y.protocol?b=2:"rdp"==y.protocol?b=3:"ssh"==y.protocol?b=4:"scp"==y.protocol?b=5:"mcrdesktop"==y.protocol?b=6:"mcrfiles"==y.protocol&&(b=7),6!=b&&7!=b||2==i.mtype)&&(r+='<a href=# onclick=p10MCRouter("'+i._id+'",'+b+","+y.port+(y.ip?',"'+y.ip+'"':",null")+","+(y.localport||0)+') title="需要安裝MeshCentral Router。">'+y.name+"</a>&nbsp;")}0==(1&p)&&3!=i.mtype||!i.agent||0==(8&a)||0!=(536870912&features)||(r+='<a href=# cmenu=rfbPortContextMenu id=rfbLink onclick=p10rfb("'+i._id+'") title="向此設備啟動基於 Web 的 VNC 會話.">網絡-VNC</a>&nbsp;'),0==(1&p)&&3!=i.mtype||!i.agent||0==(8&a)||0!=(1073741824&features)||(r+='<a href=# cmenu=altPortContextMenu id=mstscLink onclick=p10mstsc("'+i._id+'") title="啟動基於Web的RDP連接到此裝置.">網絡RDP</a>&nbsp;'),512&features2&&(0!=(1&p)||3==i.mtype)&&i.agent&&0!=(8&a)&&(r+='<a href=# cmenu=sshPortContextMenu id=sshLink onclick=p10ssh("'+i._id+'") title="啟動到此設備的基於 Web 的 SSH 會話.">網絡SSH</a>&nbsp;'),4294967295==a&&4194304&features&&(r+='<a href=# onclick=p10showMqttLoginDialog("'+i._id+'") title="獲取此裝置的MQTT登入憑證。">MQTT登入</a>&nbsp;')}r+="</div><br>",3==i.mtype?(QH("p10html3",""),QH("p10html5",r)):(QH("p10html3",r),QH("p10html5",""));var d=PowerStateStr(i.state),w="",w=(null!=i.agent&&!1===i.agent.root&&(w=', <span title="代理在特權降低的遠程設備上運行。">受限制的</span>'),0!=(1&p)&&(0<d.length&&(d+="<br/>"),4==i.mtype?"PDU"==i.porttype?d+='<span style=font-size:12px title="交換機端口已連接">交換機端口已連接</span>'+w:d+='<span style=font-size:12px title="已連接 IP-KVM 端口">已連接 IP-KVM 端口</span>'+w:d+='<span style=font-size:12px title="代理已連接">代理已連接</span>'+w),0!=(2&p)?(0<d.length&&(d+="<br/>"),d+='<span style=font-size:12px title="Intel &reg;AMT已連接">Intel &reg;AMT已連接</span>'):0!=(4&p)&&(0<d.length&&(d+="<br/>"),d+='<span style=font-size:12px title="檢測到Intel&reg; AMT">檢測到Intel&reg; AMT</span>'),0!=(16&p)&&(0<d.length&&(d+="<br/>"),d+='<span style=font-size:12px title="MQTT已連接">MQTT通道已連接</span>'),""==d&&i.lastconnect?d="<span style=font-size:12px>最後一次發現：<br />"+printDateTime(new Date(i.lastconnect))+"</span>":("PDU"==i.porttype||1<i.pwr&&7!=i.pwr)&&(d+="<br/>"+powerStateStrings[i.pwr]),QH("MainComputerState",d),Q("MainComputerImage").setAttribute("src","images/icons256-"+i.icon+"-1.png"),Q("MainComputerImage").className=i.conn&&0!=i.conn||3==i.mtype?"":"gray",3==i.mtype&&null!=i.agent&&4<i.agent.id&&512&features2&&(i.agent.caps=6),f&&setupTerminal(),x&&setupFiles(),0!=(16&a)),p=(w?setupConsole():15==t&&(t=10),QV("MainDevDesktop",l&&(null==i.agent&&null!=i.intelamt&&("number"!=typeof i.intelamt.sku||0!=(8&i.intelamt.sku))||null!=i.agent&&(null==i.agent.caps||0!=(1&i.agent.caps)||i.intelamt&&2==i.intelamt.state)||3==i.mtype&&(3==i.agent.id||4==i.agent.id))&&(8&a||256&a)),QV("MainDevTerminal",(null==i.agent&&null!=i.intelamt||i.agent&&null==i.agent.caps||i.agent&&0!=(2&i.agent.caps)||i.intelamt&&2==i.intelamt.state)&&8&a&&f),QV("MainDevFiles",null!=i.agent&&null!=i.agent.caps&&0!=(4&i.agent.caps)&&8&a&&x),QV("MainDevInfo",i.mtype<3&&0!=(1048576&a)),QV("MainDevAmt",null!=i.intelamt&&(2==i.intelamt.state||2&i.conn)&&8&a&&k),QV("MainDevConsole",w&&null!=i.agent&&null!=i.agent.caps&&0!=(8&i.agent.caps)&&8&a),QV("MainDevPlugins",!1),QV("p15uploadCore",null!=i.agent&&null!=i.agent.caps&&0!=(16&i.agent.caps)),QH("p15coreName",null!=i.agent&&null!=i.agent.core?i.agent.core:""),null!=i.intelamt&&"number"==typeof i.intelamt.sku&&0!=(16&i.intelamt.sku)?(QH("MainDevAmt","英特爾&reg; SM"),QH("p14deviceNamePrefix","Intel&reg; M")):(QH("MainDevAmt","英特爾&reg;AMT"),QH("p14deviceNamePrefix","Intel&reg; AMT")),Q("p14iframe").contentWindow.getCurrentMeshNode()),d=(null!=p&&p._id!=currentNode._id&&Q("p14iframe").contentWindow.disconnect(),0!=(6&i.conn));if(Q("p14iframe").contentWindow.setConnectionState(d),Q("p14iframe").contentWindow.setFrameHeight("650px"),Q("p14iframe").contentWindow.setAuthCallback(updateAmtCredentials),powerTimelineNode!=currentNode._id&&powerTimelineReq!=currentNode._id&&(QH("p10html2",""),powerTimelineReq=currentNode._id,meshserver.send({action:"powertimeline",nodeid:currentNode._id}),meshserver.send({action:"lastconnect",nodeid:currentNode._id}),meshserver.send({action:"getsysinfo",nodeid:currentNode._id}),meshserver.send({action:"getnetworkinfo",nodeid:currentNode._id}),meshserver.send({action:"getNotes",id:currentNode._id}),QH("p17info2","")),deviceSharesNode!=currentNode._id&&deviceSharesReq!=currentNode._id&&(deviceSharesReq=currentNode._id,meshserver.send({action:"deviceShares",nodeid:currentNode._id})),QV("DeskTools",!1),showDeskToolsProcesses(),refreshDeviceEvents(),document.title=currentNode&&10<=xxcurrentView&&xxcurrentView<20?currentNode.name+(s?" - "+s.name:"")+" - "+decodeURIComponent("{{{extitle}}}"):decodeURIComponent("{{{extitle}}}"),H&&(p11clearConsoleMsg(),p12clearConsoleMsg(),p13clearConsoleMsg()),null!=pluginHandler&&(QH("p19headers",""),QH("p19pages",""),pluginHandler.callHook("onDeviceRefreshEnd",e,t,n,o),null!=(l=getstore("_curPluginPage",null)))&&null!=Q("p19ph-"+l)&&pluginHandler.callPluginPage(l,Q("p19ph-"+l)),r="",7&a&&(r+='<button class="btn btn-primary btn-sm me-2" onclick="return p20showAddMeshUserDialog(5)" style=cursor:pointer;margin-right:10px><i class="fa-solid fa-circle-plus"></i> 新增用戶</button>',null!=usergroups)){var M=0,C=!1;for(g in usergroups)null==usergroups[g].membershipType&&usergroups[g]._id.split("/")[1]==e.split("/")[1]&&(M++,null==currentNode.links||null==currentNode.links[g])&&(C=!0);0<M&&C&&(r+='<a href=# onclick="return p20showAddMeshUserDialog(6)" style=cursor:pointer;margin-right:10px><i class="fa-solid fa-circle-plus"></i> 新增用戶群</a>')}r+='<table class="table table-hover" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col style=text-align:left;width:430px>用戶授權</th><th scope=col style=text-align:left></th></tr>';var S=1;if(null!=currentNode.links){var A=[];for(g in currentNode.links)(g.startsWith("user/")||g.startsWith("ugrp/"))&&A.push(g);for(g in A.sort(),A){var D="",T="",E=A[g],_=currentNode.links[E].rights,N=EscapeHtml(E.split("/")[2]),T=makeUserDeviceRightsString(_),_=!1;null!=currentNode.links[E].name&&(N=EscapeHtml(currentNode.links[E].name)),E==userinfo._id&&(N=EscapeHtml(userinfo.name)),null!=users&&null!=users[E]&&(N=EscapeHtml(users[E].name)),null!=usergroups&&null!=usergroups[E]&&(N=EscapeHtml(usergroups[E].name),_=!0),0!=(2&a)&&(T=_?(D="<a href=# onclick='return p30removeUserFromNode(event,\""+encodeURIComponentEx(E)+'")\' title="刪除此裝置群的用戶群權限" style=cursor:pointer><i class="fa-solid fa-trash text-danger hoverButton"></i></a>','<span style=cursor:pointer onclick=p20showAddMeshUserDialog(6,"'+encodeURIComponentEx(E)+'")>'+T+" <img class=hoverButton style=cursor:pointer src=images/link5.png></span>"):(D="<a href=# onclick='return p30removeUserFromNode(event,\""+encodeURIComponentEx(E)+'")\' title="刪除此裝置群的用戶權限" style=cursor:pointer><i class="fa-solid fa-trash text-danger hoverButton"></i></a>','<span style=cursor:pointer onclick=p20showAddMeshUserDialog(5,"'+encodeURIComponentEx(E)+'")>'+T+" <img class=hoverButton style=cursor:pointer src=images/link5.png></span>")),r+="<tr "+(++S%2==0?"style=background-color:#DDD":"")+'><td style=width:30%><div title="'+(_?"用戶群":"用戶")+'" class=m'+(_?4:2)+"></div><div>&nbsp;"+(N=null!=users?_?"<a href=# onclick='gotoUserGroup(\""+encodeURIComponentEx(E)+"\");haltEvent(event);'>"+N+"</a>":"<a href=# onclick='gotoUser(\""+encodeURIComponentEx(E)+"\");haltEvent(event);'>"+N+"</a>":N)+"<div></div></div></td><td style=width:70%><div style=float:right>"+D+"</div><div>"+T+"</div></td></tr>"}}if(1==S&&(r+="<tr><td><div style=padding:6px>&nbsp;<i>沒有擁有特殊裝置權限的用戶</i><div></div></div></td><td></td></tr>"),r+="</tbody></table>",null!=deviceShares&&deviceSharesNode==currentNode._id&&0<deviceShares.length){r+='<br /><table class="table table-hover" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col style=text-align:left;width:430px>主動設備共享</th><th scope=col style=text-align:left></th></tr>';for(S=1,g=0;g<deviceShares.length;g++){var I=deviceShares[g],D="",V=(null!=I.url&&(D+='<a href="'+I.url+'" rel="noreferrer noopener" target=_blank title="設備共享鏈接" style=cursor:pointer><img src=images/link2.png border=0 height=10 width=10></a> '),D+="<i role=button onclick='return p30removeDeviceSharing(event,\""+encodeURIComponentEx(currentNode._id)+'","'+encodeURIComponentEx(I.publicid)+'","'+encodeURIComponentEx(I.guestName)+'")\' title="刪除設備共享" class="fa-fw fa-solid fa-trash text-danger"></i>',""),U=(I.p<=7?V=["","終端機","桌面","桌面+終端","檔案","終端 + 文件","桌面 + 文件","桌面+終端+文件"][I.p]:8==I.p?V="HTTP/"+I.port:16==I.p&&(V="HTTPS/"+I.port),V),V=(null!=I.startTime&&null!=I.expireTime&&(U=format("{0}，{1}至{2}",V,printFlexDateTime(new Date(I.startTime)),printFlexDateTime(new Date(I.expireTime)))),null!=I.startTime&&null!=I.duration&&(U=(I.duration,format("{0}、{1} {2} 分鐘",V,printFlexDateTime(new Date(I.startTime)),I.duration))),1==I.recurring&&(U+=", 每天重複"),2==I.recurring&&(U+=", 每週重複一次"),0!=(2&I.p)&&!0===I.viewOnly&&(U+=", 僅查看桌面"),null!=I.consent&&(0==I.consent?U+=", 不同意":(0!=(56&I.consent)&&(U+="，提示同意"),0!=(64&I.consent)&&(U+=", 工具欄"))),EscapeHtml(I.guestName));r+="<tr "+(++S%2==0?"style=background-color:#DDD":"")+"><td style=width:30%><div class=m2></div><div>&nbsp;"+(V=I.publicid.startsWith("AS:node/")?"<i>代理自行共享</i>":V)+"<div></div></div></td><td style=width:70%><div style=float:right>"+D+"</div><div>"+U+"</div></td></tr>"}r+="</tbody></table>"}QH("p10html4",r);var R="";if(0==(268435456&features)&&10<=xxcurrentView&&xxcurrentView<=19&&null!=currentNode){for(var g in R="?viewmode="+xxcurrentView+"&gotonode="+currentNode._id.split("/")[2],urlargs)R+="&"+g+"="+urlargs[g];try{window.history.replaceState({},document.title,window.location.pathname+R)}catch(e){}}QV("p11DeskSessionSelector",!1),QH("p11DeskSessionSelector","")}setupDesktop(),go(t=t||10)}}else safeNewWindow(window.location.origin+"?node="+e.split("/")[2]+"&viewmode=10&hide=16"+(urlargs.key?"&key="+urlargs.key:""),"meshcentral:"+e)}function setIpPduState(e){0==e?(setModalContent("xxAddAgent","電源操作","Perform power off?"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:2})})):(setModalContent("xxAddAgent","電源操作","Perform power on?"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){meshserver.send({action:"wakedevices",nodeids:[currentNode._id]})}))}function p20editDeviceNotify(){var e,t,n;return xxdialogMode||(e=0,t=16384&features2&&userinfo.emailVerified?1:0,userinfo.notify&&userinfo.notify[currentNode._id]&&(e=userinfo.notify[currentNode._id]),n='<div style="border-bottom: 1px solid #888;margin-bottom:3px">網頁通知</div><div><label><input id=p20notifyIntelDeviceConnect type=checkbox class="form-check-input me-2" />裝置連接。</label></div><div><label><input id=p20notifyIntelDeviceDisconnect type=checkbox class="form-check-input me-2" />裝置斷開連接。</label></div>',null!=currentNode.intelamt&&(t+=2,n+='<div><label><input id=p20notifyIntelAmtKvmActions type=checkbox class="form-check-input me-2" />Intel&reg; AMT桌面和串行事件</label></div>'),1&t&&(n+='<br /><div style="border-bottom: 1px solid #888;margin-bottom:3px">電子郵件通知</div><div><label><input id=p20enotifyIntelDeviceConnect type=checkbox class="form-check-input me-2" />裝置連接。</label></div><div><label><input id=p20enotifyIntelDeviceDisconnect type=checkbox class="form-check-input me-2" />裝置斷開連接。</label></div><div><label><input id=p20enotifyIntelDeviceHelp type=checkbox class="form-check-input me-2" />Help requests</label></div>'),null!=userinfo.msghandle&&0!=(33554432&features2)&&(n+='<br /><div style="border-bottom: 1px solid #888;margin-bottom:3px">Messaging Notifications</div><div><label><input id=p20emsgDeviceConnect type=checkbox class="form-check-input me-2" />裝置連接。</label></div><div><label><input id=p20emsgDeviceDisconnect type=checkbox class="form-check-input me-2" />裝置斷開連接。</label></div><div><label><input id=p20emsgDeviceHelp type=checkbox class="form-check-input me-2" />Help requests</label></div>'),setModalContent("xxAddAgent","通知設定",n),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p20editDeviceNotifyEx(3,t)),Q("p20notifyIntelDeviceConnect").checked=2&e,Q("p20notifyIntelDeviceDisconnect").checked=4&e,2&t&&(Q("p20notifyIntelAmtKvmActions").checked=8&e),1&t&&(Q("p20enotifyIntelDeviceConnect").checked=16&e,Q("p20enotifyIntelDeviceDisconnect").checked=32&e,Q("p20enotifyIntelDeviceHelp").checked=64&e),null!=userinfo.msghandle&&0!=(33554432&features2)&&(Q("p20emsgDeviceConnect").checked=128&e,Q("p20emsgDeviceDisconnect").checked=256&e,Q("p20emsgDeviceHelp").checked=512&e)),!1}function p20editDeviceNotifyEx(e,t){var n=0,n=(n+=Q("p20notifyIntelDeviceConnect").checked?2:0)+(Q("p20notifyIntelDeviceDisconnect").checked?4:0);2&t&&(n+=Q("p20notifyIntelAmtKvmActions").checked?8:0),1&t&&(n=(n=(n+=Q("p20enotifyIntelDeviceConnect").checked?16:0)+(Q("p20enotifyIntelDeviceDisconnect").checked?32:0))+(Q("p20enotifyIntelDeviceHelp").checked?64:0)),null!=userinfo.msghandle&&0!=(33554432&features2)&&(n=(n=(n+=Q("p20emsgDeviceConnect").checked?128:0)+(Q("p20emsgDeviceDisconnect").checked?256:0))+(Q("p20emsgDeviceHelp").checked?512:0)),meshserver.send({action:"changeusernotify",nodeid:currentNode._id,notify:n})}function makeUserDeviceRightsString(e){var t,n;return 57592==e?"完整裝置權限":(t=[],8&e&&(n=[],256&e&&n.push("無輸入"),512&e&&n.push("沒有終端"),1024&e&&n.push("沒有檔案"),2048&e&&n.push("沒有AMT"),4096&e&&n.push("有限輸入"),65536&e&&n.push("沒有桌面"),524288&e&&!1!==serverinfo.guestdevicesharing&&n.push("嘉賓分享"),t.push(0<n.length?"Control ("+n.join(", ")+")":"控制")),16&e&&t.push("控制台"),32&e&&t.push("伺服器檔案"),64&e&&t.push("喚醒"),128&e&&t.push("筆記"),8192&e&&t.push("限制事件"),16384&e&&t.push("聊天"),32768&e&&t.push("卸載"),131072&e&&t.push("指令"),262144&e&&t.push("重置/關閉"),524288&e&&t.push("分享"),1048576&e&&t.push("細節"),2097152&e&&t.push("中繼"),0==t.length?"沒有權利":t.join(", "))}function makeDeviceGroupRightsString(e){var t,n;return 4294967295==e?"全部權限":(t=[],1&e&&t.push("編輯群組"),2&e&&t.push("管理用戶"),4&e&&t.push("管理裝置"),8&e&&(n=[],256&e&&n.push("無輸入"),512&e&&n.push("沒有終端"),1024&e&&n.push("沒有檔案"),2048&e&&n.push("沒有AMT"),4096&e&&n.push("有限輸入"),65536&e&&n.push("沒有桌面"),524288&e&&!1!==serverinfo.guestdevicesharing&&n.push("嘉賓分享"),t.push(0<n.length?"Control ("+n.join(", ")+")":"控制")),16&e&&t.push("控制台"),32&e&&t.push("伺服器檔案"),64&e&&t.push("喚醒"),128&e&&t.push("筆記"),8192&e&&t.push("限制事件"),16384&e&&t.push("聊天"),32768&e&&t.push("卸載"),131072&e&&t.push("指令"),262144&e&&t.push("重置/關閉"),524288&e&&t.push("分享"),1048576&e&&t.push("細節"),2097152&e&&t.push("中繼"),0==t.length?"沒有權利":t.join(", "))}function runDeviceCmd(e){xxdialogMode||d2runCommandDialog({nodeids:[e?decodeURIComponent(e):currentNode._id]})}function writeDeviceEvent(e){xxdialogMode||(setModalContent("xxAddAgent","新增裝置日誌","<textarea id=d2devEvent style=width:100%;height:200px;resize:none;overflow-y:scroll></textarea><span style=font-size:10px>這會在此裝置的事件日誌中增加一個記錄。<span>"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){writeDeviceEventEx(3,e)}),Q("d2devEvent").focus())}function writeDeviceEventEx(e,t){meshserver.send({action:"setDeviceEvent",nodeid:decodeURIComponent(t),msg:encodeURIComponentEx(Q("d2devEvent").value)})}function showNotes(e,t){xxdialogMode||(e="<textarea id=d2devNotes ro="+e+" noteid="+(t=null==t?encodeURIComponentEx("p"+userinfo._id):t)+' readonly class="form-control" style=width:100%;height:200px;resize:none;overflow-y:scroll></textarea>',t.startsWith("node%2F%2F")&&(e+="<span style=font-size:10px>其他裝置群管理員可以查看和更改裝置群註釋。<span>"),"true"===showNotesPanel&&(e+=" <span style=font-size:10px><a target=_blank href='https://www.markdownguide.org/cheat-sheet/'>Markdown syntax supported</a></span>"),setModalContent("xxAddAgent","筆記",e),showModal("xxAddAgentModal","idx_dlgOkButton",function(){showNotesEx(2,t)}),meshserver.send({action:"getNotes",id:decodeURIComponent(t)}))}function showNotesEx(e,t){Q("notesPanelArea").innerHTML=marked&&DOMPurify?DOMPurify.sanitize(marked.parse(Q("d2devNotes").value,{breaks:!0}),{USE_PROFILES:{html:!0}}):Q("d2devNotes").value,meshserver.send({action:"setNotes",id:decodeURIComponent(t),notes:encodeURIComponentEx(Q("d2devNotes").value)}),"true"===showNotesPanel&&""!=Q("d2devNotes").value?QV("notesPanel",!0):QV("notesPanel",!1)}function openIpKvmRemoteControl(e){xxdialogMode||safeNewWindow("/ipkvm.ashx/"+(e=decodeURIComponent(e).split("/")[2])+"/","ipkvm:"+e)}function deviceChat(e){var t;xxdialogMode||(t="/messenger?id=meshmessenger/"+encodeURIComponentEx(currentNode._id)+"/"+encodeURIComponentEx(userinfo._id)+"&title="+currentNode.name,""!=serverinfo.domainsuffix&&(t="/"+serverinfo.domainsuffix+t),null!=authCookie&&""!=authCookie&&(t+="&auth="+authCookie),1==currentNode.pmt&&0!=(2&features2)&&(t+="&pmt=1"),e&&1==e.shiftKey?safeNewWindow(t,"meshmessenger:"+currentNode._id):safeNewWindow(t,"meshmessenger:"+currentNode._id,"directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=400,height=560"),meshserver.send({action:"meshmessenger",nodeid:decodeURIComponent(currentNode._id)}))}function altDeviceChat(e,t){var n,o,i,s,a,l;xxdialogMode||(n=serverinfo.altmessenging[t].url.split("{0}").join(currentNode._id.split("/")[2]).split("{1}").join(currentNode._id.split("/")[2]).split("{2}").join(currentNode._id.split("/")[2]).split("{3}").join(currentNode._id.split("/")[2]),s=o=encodeURIComponentEx(userinfo._id.split("/")[2]),a=i=encodeURIComponentEx(userinfo._id.split("/").join("-")),null!=userinfo.realname&&(s=encodeURIComponentEx(userinfo.realname.split(" ").join("")),a=encodeURIComponentEx(userinfo.realname.split(" ").join("-"))),l=n=n.split("{4}").join(o).split("{5}").join(i).split("{6}").join(s).split("{7}").join(a),"string"==typeof serverinfo.altmessenging[t].localurl&&(l=(l=serverinfo.altmessenging[t].localurl.split("{0}").join(currentNode._id.split("/")[2]).split("{1}").join(currentNode._id.split("/")[2]).split("{2}").join(currentNode._id.split("/")[2]).split("{3}").join(currentNode._id.split("/")[2])).split("{4}").join(o).split("{5}").join(i).split("{6}").join(s).split("{7}").join(a)),""!=n&&meshserver.send({action:"msg",type:"openUrl",nodeid:currentNode._id,url:n}),""!=l&&safeNewWindow(l,"altmessenger:"+currentNode._id,"directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=400,height=560"))}function deviceToggleBackground(){xxdialogMode||meshserver.send({action:"msg",type:"deskBackground",nodeid:currentNode._id,op:1})}function deviceUrlFunction(){xxdialogMode||(xxdialogButtons=3,setModalContent("xxAddAgent","在裝置上打開頁面",'<input id=d2devurl placeholder="http://server.com" style=width:100%;overflow-y:scroll onkeyup=deviceUrlFunctionValidate() onchange=deviceUrlFunctionValidate()></input>'),showModal("xxAddAgentModal","idx_dlgOkButton",deviceUrlFunctionEx),Q("d2devurl").focus(),deviceUrlFunctionValidate())}function deviceUrlFunctionValidate(){var e=Q("d2devurl").value.toLowerCase();QE("idx_dlgOkButton",e.startsWith("http://")&&7<e.length||e.startsWith("https://")&&8<e.length)}function deviceUrlFunctionEx(){meshserver.send({action:"msg",type:"openUrl",nodeid:currentNode._id,url:Q("d2devurl").value})}function deviceMessageFunction(){xxdialogMode||(xxdialogButtons=3,setModalContent("xxAddAgent","裝置訊息","<div style=margin-bottom:4px>在遠程裝置上顯示一個訊息框。</div><textarea id=d2devMessage style=width:100%;height:80px;resize:none;overflow-y:scroll;box-sizing:border-box;margin-bottom:4px></textarea><select style=width:100% id=d2devTimeout><option value=2 selected>Show for 2 Minutes (Default)</option><option value=10>Show for 10 minutes</option><option value=30>Show for 30 minutes</option><option value=60>Show for 60 minutes</option><option value=0>顯示消息，直到被用戶拒絕</option></select>"),showModal("xxAddAgentModal","idx_dlgOkButton",deviceMessageFunctionEx),Q("d2devMessage").focus())}function deviceMessageFunctionEx(){var e=decodeURIComponent("{{{extitle}}}"),t=parseFloat(Q("d2devTimeout").value);""==e&&(e="網格中心"),isNaN(t)&&(t=2),1==currentNode.pmt?meshserver.send({action:"pushmessage",nodeid:currentNode._id,title:e,msg:Q("d2devMessage").value}):meshserver.send({action:"msg",type:"messagebox",nodeid:currentNode._id,title:e,msg:Q("d2devMessage").value,timeout:6e4*t})}function deskClipboardInFunction(){var e;null!=desktop&&3==desktop.State&&(desktop.m.getClipboard?null!=(e=desktop.m.getClipboard())&&null!=navigator.clipboard&&navigator.clipboard.writeText(e).then(function(){}).catch(function(e){console.log(e)}):meshserver.send({action:"msg",type:"getclip",nodeid:currentNode._id,tag:2}))}function deskInputLockFunction(e){xxdialogMode||null==desktop||3!=desktop.State||(setModalContent("xxAddAgent","遠程輸入鎖定",1==e?"鎖定遠程用戶的鼠標和鍵盤？":"解鎖遠程用戶的鼠標和鍵盤？"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){try{desktop.m.SendRemoteInputLock(e)}catch(e){}}))}function deskClipboardOutFunction(){if(null!=navigator.clipboard&&null!=navigator.clipboard.readText)try{navigator.clipboard.readText().then(function(e){desktop.m.setClipboard?desktop.m.setClipboard(e):meshserver.send({action:"msg",type:"setclip",nodeid:currentNode._id,data:e})}).catch(function(e){console.log(e)})}catch(e){console.log(e)}return!0}function deskRefreshFunction(){null!=desktop&&3==desktop.State&&desktop.m.SendRefresh()}function deviceToastFunction(){xxdialogMode||(xxdialogButtons=3,setModalContent("xxAddAgent","裝置通知",'<select id=d2deviceop style=width:100%;margin-bottom:4px class=form-select><option value=2>吐司通知</option><option value=1>留言框</option><option value=3>Alert Box</option></select><input id=dp2notifyTitle maxlength=256 placeholder="標題" style=width:100%;box-sizing:border-box;margin-bottom:4px class=form-control/><textarea id=d2notifyMsg style=background-color:#fcf3cf;width:100%;height:140px;resize:none;overflow-y:scroll;box-sizing:border-box;margin-bottom:4px class=form-control></textarea><select style=width:100% id=d2notifyTimeout class=form-select><option disabled value="">Only Applicable to Message Box Notifications</option><option value=2 selected>Show for 2 Minutes (Default)</option><option value=10>Show for 10 minutes</option><option value=30>Show for 30 minutes</option><option value=60>Show for 60 minutes</option><option value=0>顯示消息，直到被用戶拒絕</option></select>'),showModal("xxAddAgentModal","idx_dlgOkButton",deviceToastFunctionEx),Q("d2notifyMsg").focus())}function deviceToastFunctionEx(){var e=Q("d2deviceop").value,t=Q("dp2notifyTitle").value,n=Q("d2notifyMsg").value,o=parseFloat(Q("d2notifyTimeout").value);0!=n.length&&(""==(t=""==t?decodeURIComponent("{{{extitle}}}"):t)&&(t="網格中心"),isNaN(o)&&(o=2),1==e?meshserver.send({action:"msg",type:"messagebox",nodeid:currentNode._id,title:t,msg:n,timeout:6e4*o}):2==e?meshserver.send({action:"toast",nodeids:[currentNode._id],title:t,msg:n}):3==e&&meshserver.send({action:"msg",type:"alertbox",nodeid:currentNode._id,title:t,msg:n}))}function deviceLockFunction(){null==xxdialogMode&&null!=desktop&&1==desktop.contype&&(setModalContent("xxAddAgent","鎖定桌面","鎖定用戶桌面？"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){null!=desktop&&1==desktop.contype&&desktop.sendCtrlMsg('{"ctrlChannel":"102938","type":"lock"}')}))}function showShareDevice(){if(!xxdialogMode){var e,t=GetNodeRights(currentNode),n="",o="創建一個鏈接，該鏈接允許沒有帳戶的訪客在有限的時間內遠程控制此設備。<br /><br />",i=(o+=addHtmlFormFloating("來賓姓名",'<input id=d2inviteName class="form-control" maxlength=128 type=text onkeyup=showShareDeviceValidate() />'),"<option value=2>桌面</option>"),s=(4294967295!=t&&0!=(256&t)&&(i=""),"<option value=1>終端機</option>"),a=(4294967295!=t&&0!=(512&t)&&(s=""),"<option value=4>檔案</option>"),l=(4294967295!=t&&0!=(1024&t)&&(a=""),"<option value=5>桌面 + 文件</option>"),r=(4294967295!=t&&0!=(1280&t)&&(l=""),"<option value=6>終端 + 文件</option>"),d=(4294967295!=t&&0!=(1536&t)&&(r=""),"<option value=7>桌面+終端+文件</option>"),c=(4294967295!=t&&0!=(1792&t)&&(d=""),""),n=(0!=webRelayPort&&(c="<option value=8>HTTP</option><option value=9>HTTPS</option>",4294967295!=t)&&0!=(8&t)&&(c=""),""),u="",p=(1==(1&currentNode.agent.caps)&&(n+=i+"<option value=3>桌面，僅查看</option>"),2==(2&currentNode.agent.caps)&&(n+=s),4==(4&currentNode.agent.caps)&&(n+=a),5==(5&currentNode.agent.caps)&&(n+=l),6==(6&currentNode.agent.caps)&&(n+=r),7==(7&currentNode.agent.caps)&&(n+=d),o+=addHtmlFormFloating("類型",'<select id=d2shareType class="form-select" onchange=showShareDeviceValidate()>'+(n+=c)+"</select>"),{1:"1分鐘",5:"5分鐘",10:"10分鐘",15:"15分鐘",30:"30分鐘",45:"45分鐘",60:"60分鐘",120:"2小時",240:"4個小時",480:"8小時",720:"12小時",960:"16小時",1440:"24小時",2880:"2天",5760:"4天",0:"無限"});for(e in n="",p)(null==serverinfo.guestdevicesharingmaxtime||0<e&&e<=serverinfo.guestdevicesharingmaxtime)&&(n+="<option value="+e+">"+p[e]+"</option>"),0<e&&e<=720&&(null==serverinfo.guestdevicesharingmaxtime||0<e&&e<=serverinfo.guestdevicesharingmaxtime)&&(u+="<option value="+e+">"+p[e]+"</option>");o=(o=(o=(o=(o=o+addHtmlFormFloating("有效期",'<select id=d2timeRange class="form-select" onchange=showShareDeviceValidate()><option value=0>現在開始</option><option value=1>時間範圍</option><option value=2>每天重複</option><option value=3>每週重複</option></select>')+"<div id=d2modenow>")+addHtmlFormFloating("到期時間",'<select id=d2inviteExpire class="form-select">'+n+"</select>")+"</div><div id=d2moderange style=display:none>")+addHtmlFormFloating("時間範圍",'<input id=d2timeRangeSelector class="flatpickr form-select" type="text" placeholder="選擇日期和時間..." data-id="altinput">')+"</div><div id=d2moderecurring style=display:none>")+addHtmlFormFloating("開始時間",'<input id=d2timeStartSelector class="flatpickr form-select" type="text" placeholder="選擇日期和時間..." data-id="altinput">'))+addHtmlFormFloating("持續時間",'<select id=d2inviteDuration class="form-select">'+u+"</select>")+"</div>",1&currentNode.agent.caps&&(o+="<div id=d2userConsentSelector>"+addHtmlFormFloating("用戶同意",'<select id=d2userConsent class="form-select"><option value=0>只通知<option value=1>用戶同意提示</option><option value=2>No Consent</option></select>')+"</div>"),o=(o+="<div id=d2httpPortSelector>"+addHtmlFormFloating("Port",'<input id=d2httpPort class="form-control" value=80 onkeyup=showShareDeviceValidate()></input>')+"</div>")+("<div id=d2httpsPortSelector>"+addHtmlFormFloating("Port",'<input id=d2httpsPort class="form-control" value=443 onkeyup=showShareDeviceValidate()></input>')+"</div>"),xxdialogButtons=3,setModalContent("xxAddAgent","共享裝置",o),showModal("xxAddAgentModal","idx_dlgOkButton",showShareDeviceEx),showShareDeviceValidate();t=new Date,i=(t.setDate(t.getDate()+1),flatpickr("#d2timeRangeSelector",{mode:"range",enableTime:!0,minDate:new Date,defaultDate:[new Date,t],minuteIncrement:1})),s=flatpickr("#d2timeStartSelector",{enableTime:!0,minDate:new Date,defaultDate:new Date,minuteIncrement:1});xxdialogTag={range:i,start:s}}}function showShareDeviceValidate(){1&currentNode.agent.caps&&QV("d2userConsentSelector",Q("d2shareType").value<8),QV("d2httpPortSelector",8==Q("d2shareType").value),QV("d2httpsPortSelector",9==Q("d2shareType").value),QV("d2modenow",0==Q("d2timeRange").value),QV("d2moderange",1==Q("d2timeRange").value),QV("d2moderecurring",2<=Q("d2timeRange").value);var e,t=!0;8==Q("d2shareType").value&&(e=parseInt(Q("d2httpPort").value),Q("d2httpPort").value!=e||e<1||65535<e)&&(t=!1),9==Q("d2shareType").value&&(e=parseInt(Q("d2httpsPort").value),Q("d2httpsPort").value!=e||e<1||65535<e)&&(t=!1),0==Q("d2inviteName").value.trim().length&&(t=!1),QE("idx_dlgOkButton",t)}function showShareDeviceEx(e,t){var n=0,o=parseInt(Q("d2shareType").value),i=!1;8==o?meshserver.send({action:"createDeviceShareLink",nodeid:currentNode._id,guestname:Q("d2inviteName").value.trim(),p:8,expire:parseInt(Q("d2inviteExpire").value),port:parseInt(Q("d2httpPort").value),consent:0}):9==o?meshserver.send({action:"createDeviceShareLink",nodeid:currentNode._id,guestname:Q("d2inviteName").value.trim(),p:16,expire:parseInt(Q("d2inviteExpire").value),port:parseInt(Q("d2httpsPort").value),consent:0}):(3==o&&(i=!0),1&(o=[0,1,2,2,4,6,5,7][o])&&(n|=2,1&currentNode.agent.caps&&1==Q("d2userConsent").value&&(n|=16),1&currentNode.agent.caps)&&2==Q("d2userConsent").value&&(n=0),2&o&&(n|=65,1&currentNode.agent.caps&&1==Q("d2userConsent").value&&(n|=8),1&currentNode.agent.caps)&&2==Q("d2userConsent").value&&(n=0),4&o&&(n|=4,1&currentNode.agent.caps&&1==Q("d2userConsent").value&&(n|=32),1&currentNode.agent.caps)&&2==Q("d2userConsent").value&&(n=0),0==Q("d2timeRange").value?meshserver.send({action:"createDeviceShareLink",nodeid:currentNode._id,guestname:Q("d2inviteName").value.trim(),p:o,expire:parseInt(Q("d2inviteExpire").value),consent:n,viewOnly:i}):1==Q("d2timeRange").value?meshserver.send({action:"createDeviceShareLink",nodeid:currentNode._id,guestname:Q("d2inviteName").value.trim(),p:o,start:Math.floor(t.range.selectedDates[0].getTime()/1e3),end:Math.floor(t.range.selectedDates[1].getTime()/1e3),consent:n,viewOnly:i}):meshserver.send({action:"createDeviceShareLink",nodeid:currentNode._id,guestname:Q("d2inviteName").value.trim(),p:o,start:Math.floor(t.start.selectedDates[0].getTime()/1e3),expire:parseInt(Q("d2inviteDuration").value),recurring:Q("d2timeRange").value-1,consent:n,viewOnly:i}))}function deviceActionFunction(){var e,t,n,o,i;xxdialogMode||(e=GetNodeRights(currentNode),t=0,n="選擇要在此裝置上執行的操作。<br /><br />",o="<select id=d2deviceop onchange=deviceActionFunctionValidate() class=form-select>",i="",null!=currentNode.agent&&14==currentNode.agent.id?0!=(1&currentNode.conn)&&0!=(8&e)&&(t++,o+="<option value=400>閃光</option><option value=401>顫動</option>",i+="<div id=d2devicetimediv>"+addHtmlFormFloating("時間","<select id=d2devicetime class=form-select><option value=1000>1秒</option><option value=5000>5秒</option><option value=10000>10 秒</option></select>")+"</div>"):(0!=(64&e)&&(t++,o+="<option value=100>喚醒</option>"),0!=(1&currentNode.conn)&&0!=(131072&e)&&(t++,o+="<option value=106>運行命令</option>"),0!=currentNode.conn&&0!=(262144&e)&&(t++,o+="<option value=4>休眠</option><option value=3>重設</option><option value=2>關機</option>"),0!=(16&currentNode.conn)&&(t++,o+="<option value=103>發送MQTT消息</option>"),null!=currentNode.intelamt&&2==currentNode.intelamt.state&&0!=(6&currentNode.conn)&&0!=(262144&e)&&(t++,o+="<option value=310>英特爾&reg; AMT 重置</option><option value=308>英特爾&reg; AMT 關機</option>",11!=xxcurrentView&&12!=xxcurrentView||(o+="<option value=312>Intel&reg; AMT Reset to BIOS</option><option value=311>Intel&reg; AMT Power on to BIOS</option><option value=315>Intel&reg; AMT Power on to PXE</option><option value=316>Intel&reg; AMT Reset to PXE</option>")),null!=currentNode.intelamt&&2==currentNode.intelamt.state&&0!=(6&currentNode.conn)&&0!=(64&e)&&(t++,o+="<option value=302>英特爾&reg; AMT 開機</option>"),(11==xxcurrentView||12==xxcurrentView)&&15<=getNodeAmtVersion(currentNode)&&2==currentNode.intelamt.state&&0!=(6&currentNode.conn)&&4294967295==e&&0==(1024&features)&&(t++,o+="<option value=107>英特爾&reg; AMT 一鍵恢復</option>"),0!=(1&currentNode.conn)&&0!=(32768&e)&&(t++,o+="<option value=104>卸載代理</option>")),n+=addHtmlFormFloating("操作",o+="</select>"),xxdialogButtons=0==t?2:3,xxdialogTag=(n=0==t?"該設備當前無可用操作。":n)+i,setModalContent("xxAddAgent","裝置指令",n),showModal("xxAddAgentModal","idx_dlgOkButton",deviceActionFunctionEx),0<t&&deviceActionFunctionValidate())}function deviceActionFunctionValidate(){var e=Q("d2deviceop").value;try{QV("d2devicetimediv",400==e||401==e)}catch(e){}}function deviceActionFunctionEx(){var e=Q("d2deviceop").value;if(100==e)return meshserver.send({action:"wakedevices",nodeids:[currentNode._id]}),!0;if(103==e)p10showSendMqttMsgDialog([currentNode._id]);else if(104==e)p10showSendUninstallAgentDialog([currentNode._id]);else if(106==e){var t,n=!1,o=!1;currentNode.agent&&(0<currentNode.agent.id&&currentNode.agent.id<5?n=!0:o=!0),1!=n&&1!=o||(t="在所選裝置上運行命令。<br />",1==n&&(t+="<select id=d2cmdtype style=width:100%;margin-bottom:4px;margin-top:4px><option value=1>Windows命令提示</option><option value=2>Windows PowerShell</option>",1==o&&(t+="<option value=3>Linux / BSD / macOS命令外殼</option>"),t+="</select>"),setModalContent("xxAddAgent","運行命令",t=t+"<select id=d2cmduser style=width:100%;margin-bottom:4px><option value=0>以代理身份運行</option><option value=1>以用戶身份運行，如果沒有用戶，則運行代理</option><option value=2>必須以用戶身份運行</option></select>"+"<textarea id=d2runcmd style=width:100%;height:200px;resize:none;overflow-y:scroll></textarea>"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>deviceRunCmdsFunctionEx()),Q("d2runcmd").focus())}else if(107==e)Q("d3localmodeform").action="oneclickrecovery.ashx",Q("d3auth").value=authCookie,Q("d3filter").value=".efi",Q("d3attrib").value=currentNode._id,setModalContent("xxAddAgent","英特爾&reg; AMT 一鍵恢復",t),showModal("xxAddAgentModal","idx_dlgOkButton",()=>deviceActionOneClickRecovery()),d3init();else if(302==e)setModalContent("xxAddAgent","英特爾&reg; AMT 電源操作","執行英特爾&reg; AMT 開機？"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:parseInt(e)})});else if(308==e)setModalContent("xxAddAgent","英特爾&reg; AMT 電源操作","Perform Intel&reg; AMT power off?<br><br><b>NOTE: If there is an active AMT session, then power off command will be rejected, so you must disconnect from the AMT session first!</b>"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:parseInt(e)})});else if(310==e)setModalContent("xxAddAgent","英特爾&reg; AMT 電源操作","執行英特爾&reg; AMT 重置？"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:parseInt(e)})});else{if(311==e)setModalContent("xxAddAgent","英特爾&reg; AMT 電源操作","Perform Intel&reg; AMT power on to BIOS?");else{if(312!=e)return 400==e||401==e?meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:parseInt(e),time:parseInt(Q("d2devicetime").value)}):meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:parseInt(e)}),!0;setModalContent("xxAddAgent","英特爾&reg; AMT 電源操作","Perform Intel&reg; AMT reset to BIOS?")}showModal("xxAddAgentModal","idx_dlgOkButton",function(){meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:parseInt(e)+(12==xxcurrentView?2:0)})})}return!1}function deviceActionOneClickRecovery(){var e;1==Q("d3uploadMode").value?Q("d3submit").click():1==(e=d3getFileSel()).length&&meshserver.send({action:"oneclickrecovery",nodeids:[Q("d3attrib").value],type:"diskimage",path:d3filetreelocation.join("/")+"/"+e[0]})}function deviceRunCmdsFunctionEx(){var e=3;try{e=parseInt(Q("d2cmdtype").value)}catch(e){}meshserver.send({action:"runcommands",nodeids:[currentNode._id],type:e,cmds:Q("d2runcmd").value,runAsUser:parseInt(Q("d2cmduser").value)})}function updateAmtCredentials(e){var t=getNodeFromId(currentNode._id);1==e||null==t.intelamt.user||""==t.intelamt.user?editDeviceAmtSettings(currentNode._id,updateAmtCredentialsEx):Q("p14iframe").contentWindow.connectButtonfunctionEx()}function updateAmtCredentialsEx(e,t){Q("p14iframe").contentWindow.connectButtonfunctionEx()}function updateDeviceTimeline(){2==meshserver.State&&null!=powerTimelineNode&&null!=powerTimelineUpdate&&null!=currentNode&&3!=currentNode.mtype&&powerTimelineNode==powerTimelineReq&&currentNode._id==powerTimelineNode&&powerTimelineUpdate<Date.now()&&(powerTimelineUpdate=null,meshserver.send({action:"powertimeline",nodeid:currentNode._id}),meshserver.send({action:"lastconnect",nodeid:currentNode._id}))}function drawDeviceTimeline(){if(!(null==currentNode||xxcurrentView<10||19<xxcurrentView||3==currentNode.mtype||"true"===hidePowerTimeline)){var e=null,t=Date.now(),n=(currentNode._id==powerTimelineNode&&(e=powerTimeline),new Date),o=(n.setHours(0,0,0,0),(n=new Date(n.getTime()-5184e5)).getTime(),[]);if(null!=e&&1<e.length){o.push([0,e[1],e[0]]);for(var i=e[1],s=2;s<e.length;s+=2){var a=e[s],l=t;e.length>s+1&&(l=e[s+1]),o.push([i,i+l,a]),i+=l}}var r="",d=1,c=new Date,u=Q("column_l").offsetWidth-192;c.setHours(0,0,0,0);for(s=0;s<7;s++){var p,m="",g=c.getTime(),h=g+864e5;for(p in o){var v,f,x,k=o[p];1==isTimeBlockInside(g,h,k[0],k[1])&&(x=Math.max(g,k[0]),v=Math.min(Math.min(h,k[1]),t),0<(f=Math.round((v-x)*u/864e5)))&&(x=format("{0} 從 {1} 到 {2}。",powerStateStrings2[k[2]],printTime(new Date(x)),printTime(new Date(v))),m+='<div class="pwState '+powerColor(k[2])+'" title="'+x+'" style="width:'+f+'px;"></div>')}r+="<tr class="+(d%2==0?"altBack":"")+"><td><div>&nbsp;"+printDate(c)+"<div></div></div></td><td><div>"+m+"</div></td></tr>",++d,c=new Date(c.getFullYear(),c.getMonth(),c.getDate()-1)}n="";try{n="&tz="+encodeURIComponentEx(Intl.DateTimeFormat().resolvedOptions().timeZone)}catch(e){}QH("p10html2",'<table class="table table-striped align-middle text-center" cellpadding=2 cellspacing=0><thead><tr><th scope=col style=width:150px>天</th><th scope=col>7天電源狀態<div class="float-end pe-1"><i role="button" onclick=downloadFile("devicepowerevents.ashx?id='+currentNode._id+"&tf="+(new Date).getTimezoneOffset()+"&l="+encodeURIComponentEx(getLang())+n+(urlargs.key?"&key="+urlargs.key:"")+'",null,true) title="下載電源事件" class="fa-solid fa-download"></i></div></th></tr></thead><tbody>'+r+"</tbody></table>")}}function powerColor(e){return e<powerColorTable.length?powerColorTable[e]:"pwsYellow"}function isTimeBlockInside(e,t,n,o){return n<e&&t<o||e<n&&n<t||e<o&&o<t}function addDeviceAttribute(e,t,n=[]){return`<div class="row mb-1"><div class="${n[0]||"col col-md-2 col-lg-2"}"><b> ${e} </b></div><div class="${n[1]||"col col-md-10 col-lg-10"}"> ${t} </div></div>`}function editDeviceAmtSettings(e,t,n){var o,i,s;xxdialogMode||(o="",i=getNodeFromId(e),s=3,0!=(4&GetNodeRights(i))&&(o=(o+=addHtmlFormFloating("用戶名",'<input id=dp10username class="form-control" maxlength=32 autocomplete=nope placeholder="admin" onchange=validateDeviceAmtSettings() onkeyup=validateDeviceAmtSettings() />'))+addHtmlFormFloating("密碼",'<input id=dp10password type=password class="form-control" autocomplete=nope maxlength=32 onchange=validateDeviceAmtSettings() onkeyup=validateDeviceAmtSettings() />'),0==(1&features2)&&(o+=addHtmlFormFloating("安全",'<select id=dp10tls class="form-select"><option value=0>沒有TLS加密</option><option value=1>需要TLS加密</option></select>')),null!=i.intelamt.user&&""!=i.intelamt.user&&(s=7),setModalContent("xxAddAgent","編輯Intel&reg; AMT憑證",o),showModal("xxAddAgentModal","idx_dlgOkButton",()=>editDeviceAmtSettingsEx(s,{node:i,func:t,arg:n})),null!=i.intelamt.user&&""!=i.intelamt.user?Q("dp10username").value=i.intelamt.user:Q("dp10username").value="admin",0==(1&features2)&&(Q("dp10tls").value=i.intelamt.tls),validateDeviceAmtSettings()))}function validateDeviceAmtSettings(){QE("idx_dlgOkButton",passwordcheck(Q("dp10password").value))}function editDeviceAmtSettingsEx(e,t){var n;2==e?meshserver.send({action:"changedevice",nodeid:t.node._id,intelamt:{user:"",pass:""}}):(""==(e=Q("dp10username").value)&&(e="admin"),n=Q("dp10password").value,e={action:"changedevice",nodeid:t.node._id,intelamt:{user:e=""==n?"":e,pass:n}},0==(1&features2)&&(e.intelamt.tls=parseInt(Q("dp10tls").value)),meshserver.send(e),t.func&&setTimeout(function(){t.func(null,t.arg)},1e3))}function p10showSendMqttMsgDialog(e){var t;return xxdialogMode||(t=addHtmlFormFloating("主題",'<input id=dp2topic class="form-control" maxlength=64 onchange=p10validateSendMqttMsgDialog() onkeyup=p10validateSendMqttMsgDialog(event,1) />'),setModalContent("xxAddAgent","發送MQTT消息",t+=addHtmlFormFloating("訊息",'<textarea id=dp2msg class="form-control" maxlength=4096 style=width:100%;height:150px;resize:none onchange=p10validateSendMqttMsgDialog() onkeyup=p10validateSendMqttMsgDialog(event,1)></textarea>')),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p10showSendMqttMsgDialogEx(3,e)),p10validateSendMqttMsgDialog(),Q("dp2topic").focus()),!1}function p10validateSendMqttMsgDialog(){QE("idx_dlgOkButton",0<Q("dp2topic").value.length&&0<Q("dp2msg").value.length)}function p10showSendMqttMsgDialogEx(e,t){meshserver.send({action:"sendmqttmsg",nodeids:t,topic:Q("dp2topic").value,msg:Q("dp2msg").value}),uncheckAllDevices()}function p10showSendUninstallAgentDialog(e){var t;return xxdialogMode||(t="",t=1<e.length?format("你確定要卸載所選的{0}代理嗎？",e.length):"你確定要卸載所選代理嗎？",setModalContent("xxAddAgent","卸載代理",t=(t+="<br /><br />")+"這不會從伺服器上刪除該裝置，但是該裝置將不再能夠連接到伺服器。該裝置的所有遠程訪問都將丟失。該設備必須連線，此命令才能起作用。"+'<br /><br /><label style=color:red><input id=p10check type=checkbox class="form-check-input me-2" onchange=p10validateDeleteNodeDialog() />確認</label>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p10showSendUninstallAgentDialogEx(3,e)),p10validateSendUninstallAgentDialog()),!1}function p10validateSendUninstallAgentDialog(){QE("idx_dlgOkButton",Q("p10check").checked)}function p10showSendUninstallAgentDialogEx(e,t){meshserver.send({action:"uninstallagent",nodeids:t}),uncheckAllDevices()}function p10showChangeGroupDialog(e){if(!xxdialogMode){var t=null;if(1==e.length)try{t=meshes[getNodeFromId(e[0]).meshid]._id}catch(e){}var n,o,i='<select id=p10newGroup class="form-select">',s=0,a=[];for(n in meshes){var l=GetMeshRights(n);meshes[n]._id!=t&&4&l&&a.push(meshes[n])}for(n in a.sort(nameSort),a)s++,i+="<option value='"+a[n]._id+"'>"+a[n].name+"</option>";i+="</select>",0<s?(o=1==e.length?"選擇此裝置的新群<br /><br />":"為所選裝置選擇一個新群<br /><br />",setModalContent("xxAddAgent","更改群",o+=addHtmlFormFloating("新裝置群",i)),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p10showChangeGroupDialogEx(3,e))):(setModalContent("xxAddAgent","更改群","No other device group of same type exists."),showModal("xxAddAgentModal","idx_dlgOkButton"))}return!1}function p10showChangeGroupDialogEx(e,t){meshserver.send({action:"changeDeviceMesh",nodeids:t,meshid:Q("p10newGroup").value}),uncheckAllDevices()}function p10showDeleteNodeDialog(e){var t;return xxdialogMode||(t=format("你確定要刪除節點{0}嗎？",EscapeHtml(currentNode.name))+'<br /><br /><label><input id=p10check type=checkbox class="form-check-input me-2" onchange=p10validateDeleteNodeDialog() />確認</label>',xxdialogButtons=3,xxdialogTag=e,setModalContent("xxAddAgent","刪除節點",t),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p10showDeleteNodeDialogEx(0,e)),p10validateDeleteNodeDialog()),!1}function p10validateDeleteNodeDialog(){QE("idx_dlgOkButton",Q("p10check").checked)}function p10showDeleteNodeDialogEx(e,t){meshserver.send({action:"removedevices",nodeids:[t]})}function p10WebRouter(e,t,n,o){var i=null,s=getNodeFromId(e),a=(3==s.mtype&&(a=meshes[s.meshid])&&a.relayid&&(i=a.relayid,o=s.host),serverinfo.name),s=(-1!=a.indexOf(".")&&0==(2&features)||(a=window.location.hostname),"https://"+(a=""!=webRelayDns?webRelayDns:a)+":"+webRelayPort+"/control-redirect.ashx?n="+e+"&p="+n+"&appid="+t+"&c="+authRelayCookie);return null!=o&&(s+="&addr="+o),null!=i&&(s+="&relayid="+i),safeNewWindow(s,"WebRelay"),!1}function p10MCRouter(e,t,n,o,i){var s=getNodeFromId(e),a=meshes[s.meshid];return 3==t&&null==n&&(n=null!=s.rdpport?s.rdpport:3389),3==s.mtype&&a&&a.relayid&&(e=a.relayid,o=s.host),meshserver.send({action:"getcookie",nodeid:e,tcpport:n,ip:o,tag:"MCRouter",protocol:t,localport:i,name:a?a.name:null}),!1}function p10rfb(e,t){var n=getNodeFromId(e),o=null,i=meshes[n.meshid];null==t&&(t=null!=n.rfbport?n.rfbport:5900),3==n.mtype&&i&&i.relayid&&(e=i.relayid,o=n.host),meshserver.send({action:"getcookie",nodeid:e,tcpport:t,tcpaddr:o,tag:"novnc",name:i?i.name:null})}function p10mstsc(e,t){var n=getNodeFromId(e),o=meshes[n.meshid];null==t&&(t=null!=n.rdpport?n.rdpport:3389),meshserver.send({action:"getcookie",nodeid:e,tcpport:t,tag:"mstsc",name:o?o.name:null})}function p10ssh(e,t){var n=getNodeFromId(e),o=meshes[n.meshid];null==t&&(t=null!=n.sshport?n.sshport:22),meshserver.send({action:"getcookie",nodeid:e,tcpport:t,tag:"ssh",name:o?o.name:null})}var d2map=null;function p10showNodeLocationDialog(){if(null!=xxdialogMode&&"@xxmap"==xxdialogTag)setDialogMode(0);else if(xxdialogMode)return!1;function g(e){var t,n,o,i,s=[],a=["iploc","wifiloc","gpsloc","userloc"],l=null;for(t in a)null!=currentNode[a[t]]&&(o=currentNode[a[t]].split(","),n=parseFloat(o[0]),o=parseFloat(o[1]),n<90)&&-90<n&&o<180&&-180<o&&((i=new ol.Feature({geometry:new ol.geom.Point(ol.proj.fromLonLat([o,n]))})).setStyle(markerStyle(currentNode,parseInt(t)+1)),s.push(i),null==l?l=[n,o,n,o,0]:(n<l[0]&&(l[0]=n),o<l[1]&&(l[1]=o),n>l[2]&&(l[2]=n),o>l[3]&&(l[3]=o)));var r=new ol.source.Vector({features:s}),r=new ol.layer.Vector({source:r}),d=0,c=0,u=8;if(null!=l)for(var c=(l[0]+l[2])/2,d=(l[1]+l[3])/2,p=Math.max(Math.abs(l[0]-l[2]),Math.abs(l[1]-l[3])),m=360,u=-2;p<m;)u++,m/=2;1==s.length&&(u=8),d2map=new ol.Map({target:"d2map",interactions:ol.interaction.defaults({dragPan:!1,mouseWheelZoom:!1}),layers:[new ol.layer.Tile({source:new ol.source.OSM}),r],view:new ol.View({center:ol.proj.fromLonLat([d,c]),zoom:u})}),document.getElementById("xxAddAgentModal").removeEventListener("shown.bs.modal",g)}document.getElementById("xxAddAgentModal").addEventListener("shown.bs.modal",g);return xxdialogTag="@xxmap",setModalContent("xxAddAgent","裝置位置","<div id=d2map style=width:100%;height:300px></div>"),showModal("xxAddAgentModal","idx_dlgOkButton"),!1}function p10showNodeNetInfoDialog(){return xxdialogMode||(xxdialogButtons=1,xxdialogTag="if"+currentNode._id,setModalContent("xxAddAgent","網絡介面","<div id=d2netinfo>載入中...</div>"),showModal("xxAddAgentModal","idx_dlgOkButton"),meshserver.send({action:"getnetworkinfo",nodeid:currentNode._id})),!1}function p10showMeshRouterDialog(){var e,t;xxdialogMode||(e="<div>MeshCentral Router是Windows工具，用於TCP介面映射。例如，你可以通過該伺服器將RDP放入遠程裝置。</div><br />",e=(e+='<div class="row mb-1"><div class="col-md-4"><b>Win32 Executable</b></div><div class="col-md-8"><a style="cursor:pointer" onclick="downloadFile(\'meshagents?meshaction=winrouter'+(urlargs.key?"&key="+urlargs.key:"")+'\',null,true)" class="link-primary">MeshCentralRouter.exe</a></div></div>')+'<div class="row mb-1"><div class="col-md-4"><b>MacOS Installer</b></div><div class="col-md-8"><a style="cursor:pointer" onclick="downloadFile(\'meshagents?meshaction=macrouter'+(urlargs.key?"&key="+urlargs.key:"")+'\',null,true)" class="link-primary">MeshCentralRouter.dmg</a></div></div>',-1!=(t=serverinfo.name).indexOf(".")&&0==(2&features)||(t=window.location.hostname),domainUrl.substring(0,domainUrl.length-1),setModalContent("xxAddAgent","MeshCentral Router",e=(e+='<br /><div class="alert alert-info">運行MeshCentral Router，然後單擊“安裝”以使其可從瀏覽器啟動。</div>')+('<br /><a style=cursor:pointer target="mcrouterframe" rel="noreferrer noopener" href="'+("mcrouter://"+t+(443==serverinfo.port?"":":"+serverinfo.port)+domainUrl+"control.ashx?c="+authCookie+"&t="+serverinfo.tlshash+"&l={{{lang}}}"+(urlargs.key?"&key="+urlargs.key:""))+'"><input type=button style=width:100%;cursor:pointer value="啟動MeshCentral路由器" class="btn btn-primary btn-block" /></a>')+'<iframe class="d-none" name="mcrouterframe"></iframe>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20showAddMeshUserDialogEx(1,"fileDownload")}))}function p10showMqttLoginDialog(e){meshserver.send({action:"getmqttlogin",nodeid:e})}function p10openxterm(e,t){haltEvent(e);var e="/xterm?nodeid="+encodeURIComponentEx(t)+"&auto=1",n=getNodeFromId(t);if(null!=n)return 0<=[1,2,3,4,21,22].indexOf(n.agent.id)?e+="&os=win":e+="&os=linux",urlargs.key&&(e+="&key="+urlargs.key),safeNewWindow(e,"xterm:"+t),!1}function p10showMeshCmdDialog(e,t){var n;xxdialogMode||(n="",0==e&&(n+="<div>MeshCmd是一個可以執行許多不同操作的命令行工具。可以選擇下載和編輯操作檔案以提供伺服器訊息和憑據。<br /><br />"),1==e&&(n+="<div>下載帶有指令檔案的“ meshcmd”，以通過此服務器將網絡讯息發送到該裝置。緊記編輯meshaction.txt並新增你的帳戶密碼或進行任何必要的更改。<br /><br />"),n=(n+=addHtmlFormFloating("操作系統","<select id=aginsSelect onclick=meshCmdOsClick() class=form-select><option value=4>Windows x86 (64bit)</option><option value=3>Windows x86 (32bit)</option><option value=43>Windows ARM (64bit)</option><option value=6>Linux x86（64位）</option><option value=5>Linux x86（32位）</option><option value=16>macOS x86 (64位)</option><option value=29>macOS ARM (64位)</option><option value=25>Linux ARM，Raspberry Pi（32位）</option><option value=26>Linux ARM, Raspberry Pi (64位)</option></select>"))+addHtmlValue("MeshCmd",'<a id=meshcmddownloadid onclick=downloadFile("meshagents?meshcmd=3'+(urlargs.key?"&key="+urlargs.key:"")+'") class=link-primary></a>'),0==e&&(n+=addHtmlValue("動作檔案",'<a onclick=downloadFile("meshagents?meshaction=generic'+(urlargs.key?"&key="+urlargs.key:"")+'") class=link-primary>MeshAction（.txt）</a>')),1==e&&(n+=addHtmlValue("動作檔案",'<a onclick=downloadFile("meshagents?meshaction=route&nodeid='+t+(urlargs.key?"&key="+urlargs.key:"")+'") class=link-primary>MeshAction（.txt）</a>')),xxdialogButtons=9,xxdialogMode="fileDownload",setModalContent("xxAddAgent","下載MeshCmd",n+="</div>"),showModal("xxAddAgentModal","idx_dlgOkButton"),meshCmdOsClick())}function meshCmdOsClick(){var e=Q("aginsSelect").value,t="";3==e&&(t="MeshCmd (Win x86-32 executable)"),4==e&&(t="MeshCmd (Win x86-64 executable)"),43==e&&(t="MeshCmd (Win ARM-64 executable)"),5==e&&(t="MeshCmd（Linux x86，32bit）"),6==e&&(t="MeshCmd（Linux x86，64位）"),16==e&&(t="MeshCmd（macOS，x86-ARM-64位）"),29==e&&(t="MeshCmd（macOS，ARM-64位）"),25==e&&(t="MeshCmd（Linux ARM，32位）"),26==e&&(t="MeshCmd（Linux ARM，64位）"),QH("meshcmddownloadid",t),Q("meshcmddownloadid").onclick=function(){downloadFile("meshagents?meshcmd="+e+(urlargs.key?"&key="+urlargs.key:""))}}function p10showiconselector(){xxdialogMode||0!=(4&GetNodeRights(currentNode))&&(setModalContent("xxAddAgent","圖符選擇",'<div style=text-align:center><br /><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i1 onclick=p10setIcon(1) onkeypress="if (event.key==\'Enter\') p10setIcon(1)"></div><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i2 onclick=p10setIcon(2) onkeypress="if (event.key==\'Enter\') p10setIcon(2)"></div><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i3 onclick=p10setIcon(3) onkeypress="if (event.key==\'Enter\') p10setIcon(3)"></div><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i4 onclick=p10setIcon(4) onkeypress="if (event.key==\'Enter\') p10setIcon(4)"></div><br /><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i5 onclick=p10setIcon(5) onkeypress="if (event.key==\'Enter\') p10setIcon(5)"></div><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i6 onclick=p10setIcon(6) onkeypress="if (event.key==\'Enter\') p10setIcon(6)"></div><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i7 onclick=p10setIcon(7) onkeypress="if (event.key==\'Enter\') p10setIcon(7)"></div><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i8 onclick=p10setIcon(8) onkeypress="if (event.key==\'Enter\') p10setIcon(8)"></div><br /><br /></div>'),showModal("xxAddAgentModal","idx_dlgOkButton"),QV("id_dialogclose",!0))}function p10setIcon(e){setDialogMode(0),meshserver.send({action:"changedevice",nodeid:currentNode._id,icon:e})}function showClearSshDialog(){setModalContent("xxAddAgent","編輯裝置","Clear SSH credentials?"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>showClearSshDialogEx(3))}function showClearSshDialogEx(e,t){meshserver.send({action:"changedevice",nodeid:currentNode._id,ssh:0})}function showClearRdpDialog(){setModalContent("xxAddAgent","編輯裝置","Clear RDP credentials?"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>showClearRdpDialogEx(3))}function showClearRdpDialogEx(e,t){meshserver.send({action:"changedevice",nodeid:currentNode._id,rdp:0})}var desktopNode,showEditNodeValueDialog_modes=["裝置名稱","主機名","描述","標籤"],showEditNodeValueDialog_modes2=["name","host","desc","tags"],showEditNodeValueDialog_modes3=["","","","標籤1，標籤2，標籤3"],showEditNodeValueDialog_modes4=[64,64,64,4096];function showEditNodeValueDialog(e){if(!xxdialogMode){var t="",n="",o=currentNode[showEditNodeValueDialog_modes2[e]];if(null==o&&(o=""),3==e){var t='<select id=dp10devicevalue multiple class="form-control" maxlength='+showEditNodeValueDialog_modes4[e]+" class=form-control>",i=[];for(a in nodes)if(nodes[a].tags)for(var s in nodes[a].tags)-1==i.indexOf(nodes[a].tags[s])&&i.push(nodes[a].tags[s]);if(0<i.length)for(var a in i.sort(),i){EscapeHtml(i[a]);n+=Array.isArray(o)&&-1!==o.indexOf(i[a])?"<option selected=selected>"+EscapeHtml(i[a])+"</option>":"<option>"+EscapeHtml(i[a])+"</option>"}setModalContent("xxAddAgent","Edit Tags",t+=n+"</select>"),$("#dp10devicevalue").select2({theme:"bootstrap-5",width:$(this).data("width")?$(this).data("width"):$(this).hasClass("w-100")?"100%":"style",placeholder:showEditNodeValueDialog_modes3[e],closeOnSelect:!1,allowClear:!0,tokenSeparators:[","],tags:!0})}else setModalContent("xxAddAgent","編輯裝置",t=addHtmlFormFloating(showEditNodeValueDialog_modes[e],'<input id=dp10devicevalue class="form-control" maxlength='+showEditNodeValueDialog_modes4[e]+' placeholder="'+showEditNodeValueDialog_modes3[e]+'" onchange=p10editdevicevalueValidate('+e+",event) onkeyup=p10editdevicevalueValidate("+e+",event) class=form-control/>")),Array.isArray(o)&&(o=o.join(", ")),Q("dp10devicevalue").value=o,showModal("xxAddAgentModal","idx_dlgOkButton",function(){showEditNodeValueDialogEx(3,e)});p10editdevicevalueValidate(),showModal("xxAddAgentModal","idx_dlgOkButton",function(){showEditNodeValueDialogEx(3,e)}),Q("dp10devicevalue").focus()}}function showEditNodeValueDialogAddTag(e){var t,n=Q("dp10devicevalue").value.split(","),o=[];for(t in n)o.push(n[t].trim());0<=o.indexOf(e)||(Q("dp10devicevalue").value+=(0==Q("dp10devicevalue").value.length?"":", ")+decodeURIComponent(e),setTimeout(function(){Q("dp10devicevalue").selectionStart=Q("dp10devicevalue").selectionEnd=9e4},0),p10editdevicevalueValidate())}function showEditNodeValueDialogEx(e,t){var n="",o={action:"changedevice",nodeid:currentNode._id};if(3==t){var i,s=$("#dp10devicevalue").select2("data");for(i in s)n+=s[i].text.trim()+", ";o[showEditNodeValueDialog_modes2[t]]=decodeURIComponent(n.slice(0,-2))}else o[showEditNodeValueDialog_modes2[t]]=Q("dp10devicevalue").value;meshserver.send(o)}function p10editdevicevalueValidate(e,t){e=1<e||0<Q("dp10devicevalue").value.length;QE("idx_dlgOkButton",e),null!=t&&1==e&&13==t.keyCode&&dialogclose(1)}function setupDesktop(){var e,t;desktopNode!=currentNode&&null!=desktop&&desktopNode._id!=currentNode._id&&(desktop.Stop(),desktop=desktopNode=null),desktopNode==currentNode&&null!=desktop||(null!=(e=multiDesktop[currentNode._id])?(QH("DeskParent",""),(t=e.m.CanvasId).setAttribute("id","Desk"),t.setAttribute("onmousedown","dmousedown(event)"),t.setAttribute("onmouseup","dmouseup(event)"),t.setAttribute("onmousemove","dmousemove(event)"),t.removeAttribute("onclick"),Q("DeskParent").appendChild(t),(desktop=e).m.SendCompressionLevel&&desktop.m.SendCompressionLevel(desktopsettings.agentencoding,desktopsettings.quality,desktopsettings.scaling,desktopsettings.framerate),desktop.onStateChanged=onDesktopStateChange,desktop.onMetadataChange=function(e){updateMetadata(desktop,"deskmetadata")},0!=(8192&features2)&&(desktop.m.stopInput=!0),desktop&&desktop.m.mouseCursorActive&&desktop.m.mouseCursorActive(!0),QV("DeskInputLockedButton",1==desktop.m.RemoteInputLock),QV("DeskInputUnLockedButton",0==desktop.m.RemoteInputLock),desktop.m.onRemoteInputLockChanged=function(e,t){QV("DeskInputLockedButton",t),QV("DeskInputUnLockedButton",!t)},desktop.m.onKeyboardStateChanged=function(e,t){QS("p11numlock").display=1&t?"inline-block":"none",QS("p11scrolllock").display=2&t?"inline-block":"none",QS("p11capslock").display=4&t?"inline-block":"none"},desktopNode=currentNode,onDesktopStateChange(desktop,desktop.State),delete multiDesktop[currentNode._id]):(null==desktop&&QH("DeskParent",'<canvas id=Desk oncontextmenu="return false" onmousedown=dmousedown(event) onmouseup=dmouseup(event) onmousemove=dmousemove(event)></canvas>'),desktopNode=currentNode),Q("Desk").addEventListener("DOMMouseScroll",function(e){return dmousewheel(e)}),Q("Desk").addEventListener("mousewheel",function(e){return dmousewheel(e)})),desktopNode=currentNode,desktop&&(desktop.m.onDisplayinfo=deskDisplayInfo)(desktop.m,desktop.m.displays,desktop.m.selectedDisplay),updateDesktopButtons(),deskAdjust(),updateMetadata(desktop,"deskmetadata")}function updateDesktopButtons(){var e=0,t=(null!=desktop&&(e=desktop.State),GetNodeRights(currentNode)),n=1==currentNode.agent?1:2,n=(QV("disconnectbutton1span",0!=e),QV("connectbutton1span",0==e&&(8&t||256&t)&&null!=currentNode.agent&&1&currentNode.agent.caps),QV("connectbutton1rspan",0==(1073741824&features)&&0==e&&8&t&&null!=currentNode.agent&&(3==currentNode.agent.id||4==currentNode.agent.id)),1==n?QV("connectbutton1hspan",0==e&&8&t&&null!=currentNode.intelamt&&2==currentNode.intelamt.state):QV("connectbutton1hspan",0==e&&8&t&&null!=currentNode.intelamt&&2==currentNode.intelamt.state&&null!=currentNode.intelamt.ver&&(null==currentNode.intelamt.sku||"number"==typeof currentNode.intelamt.sku&&0!=(8&currentNode.intelamt.sku))),QV("td7amtkvm",!(null==currentNode.intelamt||"number"==typeof currentNode.intelamt.sku&&0!=(16&currentNode.intelamt.sku)||null==currentNode.intelamt.ver&&null!=currentNode.agent||0!=e&&2!=desktop.contype)),QV("td7meshkvm",webRtcDesktop||null!=currentNode.agent&&1&currentNode.agent.caps&&(0==e||1==desktop.contype)),QV("td7rdpkvm",!(null==currentNode.agent||3!=currentNode.agent.id&&4!=currentNode.agent.id||0!=e&&4!=desktop.contype)),0==(8192&features2)&&(null==currentNode.agent||14!=currentNode.agent.id)&&(4294967295==t||0!=(8&t)&&0==(256&t)&&0==(4096&t))),o=0!=(1&currentNode.conn),i=(QE("connectbutton1",o),QE("connectbutton1d",o),QE("connectbutton1r",o||3==currentNode.mtype),QE("connectbutton1rd",o||3==currentNode.mtype),currentNode.rdpport&&3389!=currentNode.rdpport?QH("desktopCustomUpperRight",'<a style="cursor:pointer;line-height:22px" onclick="cmaltportaction(1,event)">'+format("RDP Port {0}",currentNode.rdpport||3389)+"</a>"):QH("desktopCustomUpperRight",""),0!=(6&currentNode.conn)),i=(QE("connectbutton1h",i),QV("deskFocusBtn",null!=desktop&&2==desktop.contype&&0!=e&&desktopsettings.showfocus),QE("DeskClip",3==e),QV("DeskClip",n&&currentNode.agent&&6144!=(6144&features2)&&11!=currentNode.agent.id&&16!=currentNode.agent.id&&(null==desktop||2!=desktop.contype)&&(1!=desktopsettings.autoclipboard||null==navigator.clipboard||null==navigator.clipboard.readText)),QE("DeskESC",3==e&&4!=desktop.contype),QV("DeskESC",browserfullscreen&&n),QE("DeskType",3==e),QV("DeskType",n),QE("DeskWD",3==e),QV("DeskWD",n),QV("deskkeys",n),QE("deskkeys",null!=desktop),QV("DeskTimer",3==e),QV("DeskLatency",3==e),QS("DeskLatency").display=3==e?"inline-block":"none",desktop&&4==desktop.contype?desktopsettings.rdpautoclipboard:desktopsettings.autoclipboard);QV("DeskClipboardOutButton",o&&n&&null!=desktop&&0==(4096&features2)&&null!=navigator.clipboard&&null!=navigator.clipboard.readText&&(1!=i||null==navigator.clipboard||null==navigator.clipboard.readText)),QV("d7deskAutoClipboardLabel",null!=navigator.clipboard.readText&&0==(4096&features2)),QV("DeskClipboardInButton",o&&n&&null!=desktop&&0==(2048&features2)&&null!=navigator.clipboard&&null!=navigator.clipboard.writeText&&(1!=i||null==navigator.clipboard||null==navigator.clipboard.readText)),3!=e&&(QV("DeskInputLockedButton",!1),QV("DeskInputUnLockedButton",!1),QV("p11numlock",!1),QV("p11scrolllock",!1),QV("p11capslock",!1)),QV("DeskRunButton",0!=(131072&t)&&o),QV("DeskSaveImageButton",3==e&&null!=Q("Desk").toBlob&&0==(1024&features2)),QV("DeskRecordButton",3==e&&null!=Q("Desk").toBlob&&null!=desktop.m.StartRecording&&0==(1024&features2)),QV("DeskChatButton",0!=(16384&t)&&0==browserfullscreen&&currentNode.agent&&o),QV("DeskNotifyButton",0!=(16384&t)&&0==browserfullscreen&&currentNode.agent&&o),QV("DeskLockButton",0!=(16384&t)&&0==browserfullscreen&&currentNode.agent&&currentNode.agent.id<5&&n&&3==e),QV("DeskToolsButton",currentNode.agent&&o),QE("DeskToolsButton",n),QV("DeskOpenWebButton",0==browserfullscreen&&n&&currentNode.agent&&o),QV("DeskBackgroundButton",n&&3==e&&1==desktop.contype&&currentNode.agent&&11!=currentNode.agent.id&&16!=currentNode.agent.id&&o),QV("DeskControlSpan",n),QV("DeskRefreshButton",3==e&&1==desktop.contype),Q("DeskControl").checked=!!(8&t)&&1==getstore("DeskControl",1),QS("DeskControlSpan").color=Q("DeskControl").checked?null:"red",0==o&&QV("DeskTools",!1)}var autoConnectDesktopTimer=null;function autoConnectDesktop(e){autoConnectDesktopTimer=null==autoConnectDesktopTimer?setInterval(function(){connectDesktop(null,1)},1e3):(clearInterval(autoConnectDesktopTimer),null)}var agentConsoleMessages=["","正在等待用戶授予訪問權限...","被拒絕","無法啟動遠程終端接合{0}（{1}）","超時","收到無效的網絡數據","無法捕獲顯示","協議協商失敗 ({0})","不支持 NLA","服務器需要 SSL","服務器不允許 SSL","SSL 證書不在服務器上","不一致的標誌","服務器所需的混合","服務器需要具有用戶身份驗證的 SSL"];function formatAgentConsoleMessage(e,t,n){for(null==n&&(n=[]);n.length<3;)n.push("");return(t&&t<agentConsoleMessages.length?EscapeHtml(format(agentConsoleMessages[t],n[0],n[1],n[2])):EscapeHtml(e)).split("\n").join("<br />")+"<br /><br />"}function connectDesktop(e,t,n,o){xxdialogMode||(null!=e&&0!=e.shiftKey&&3==t&&(t=1),QV("p11DeskSessionSelector",!1),p11clearConsoleMsg(),null==desktop?(desktopNode=currentNode,2==t?null==desktopNode.intelamt.user||""==desktopNode.intelamt.user?editDeviceAmtSettings(desktopNode._id,connectDesktop,2):((desktop=CreateAmtRedirect(CreateAmtRemoteDesktop("Desk"),authCookie)).debugmode=debugmode,desktop.onStateChanged=onDesktopStateChange,desktop.m.bpp=1==desktopsettings.encoding||3==desktopsettings.encoding?1:2,desktop.m.useZRLE=desktopsettings.encoding<3,desktop.m.localKeyMap=desktopsettings.localkeymap,desktop.m.ReverseMouseWheel=desktopsettings.kvmrmw,desktop.m.showmouse=desktopsettings.showmouse,desktop.m.onScreenSizeChange=deskAdjust,desktop.m.onKvmData=function(e){if(0==e.length)desktop.m._sentPresence||(desktop.m._sentPresence=!0,desktop.m.sendKvmData(JSON.stringify({action:"present",ver:1})));else{var t=null;try{t=JSON.parse(e)}catch(e){}null!=t&&null!=t.action&&("restart"==t.action?(webRtcDesktopReset(),desktop.m.sendKvmData(JSON.stringify({action:"present",ver:1}))):"present"==t.action&&null==webRtcDesktop?(webRtcDesktop={platform:t.platform},"undefined"!=typeof RTCPeerConnection?webRtcDesktop.webrtc=new RTCPeerConnection(null):"undefined"!=typeof webkitRTCPeerConnection&&(webRtcDesktop.webrtc=new webkitRTCPeerConnection(null)),webRtcDesktop.webchannel=webRtcDesktop.webrtc.createDataChannel("數據通道",{}),webRtcDesktop.webchannel.onopen=function(){console.log("WebRTC Data Channel Open"),Q("deskstatus").textContent=StatusStrs[desktop.State]+"，軟體KVM",desktop.m.hold(!0),webRtcDesktop.webRtcActive=!0,webRtcDesktop.softdesktop=CreateKvmDataChannel(webRtcDesktop.webchannel,CreateAgentRemoteDesktop("Desk",Q("id_mainarea")),desktop.m),webRtcDesktop.softdesktop.m.setRotation(desktop.m.rotation),webRtcDesktop.softdesktop.m.onScreenSizeChange=deskAdjust,webRtcDesktop.softdesktop.m.ImageType=webpSupport?4:1,desktopsettings.quality&&(webRtcDesktop.softdesktop.m.CompressionLevel=desktopsettings.quality),desktopsettings.scaling&&(webRtcDesktop.softdesktop.m.ScalingLevel=desktopsettings.scaling),webRtcDesktop.softdesktop.Start()},webRtcDesktop.webchannel.onclose=function(e){console.log("WebRTC Data Channel Closed"),webRtcDesktopReset()},webRtcDesktop.webrtc.onicecandidate=function(e){null==e.candidate?desktop.m.sendKvmData(JSON.stringify({action:"offer",ver:1,sdp:webRtcDesktop.webrtcoffer.sdp})):webRtcDesktop.webrtcoffer.sdp+="a="+e.candidate.candidate+"\r\n"},webRtcDesktop.webrtc.oniceconnectionstatechange=function(){null==webRtcDesktop||null==webRtcDesktop.webrtc||"disconnected"!=webRtcDesktop.webrtc.iceConnectionState&&"failed"!=webRtcDesktop.webrtc.iceConnectionState||webRtcDesktopReset()},webRtcDesktop.webrtc.createOffer(function(e){webRtcDesktop.webrtcoffer=e,webRtcDesktop.webrtc.setLocalDescription(e,function(){},webRtcDesktopReset)},webRtcDesktopReset,{mandatory:{OfferToReceiveAudio:!1,OfferToReceiveVideo:!1}})):"answer"==t.action&&null!=webRtcDesktop&&webRtcDesktop.webrtc.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:t.sdp}),function(){},webRtcDesktopReset))}},4==desktopNode.conn&&null!=desktopNode.intelamt&&1==desktopNode.intelamt.tls?desktop.Start(desktopNode._id,16995,"*","*",1):desktop.Start(desktopNode._id,16994,"*","*",0),desktop.contype=2):null==t||1==t||3==t&&4<currentNode.agent.id&&null==debugmode?((desktop=CreateAgentRedirect(meshserver,CreateAgentRemoteDesktop("Desk"),serverPublicNamePort,authCookie,authRelayCookie,domainUrl)).m.UseExtendedKeyFlag=desktopNode.agent.id<5,desktop.m.mouseCursorActive(11==xxcurrentView),desktop.debugmode=debugmode,desktop.m.debugmode=debugmode,desktop.attemptWebRTC=attemptWebRTC,desktop.webrtcconfig=webrtcconfiguration,desktop.options={},null!=n&&(desktop.options.tsid=n),null!=o&&(desktop.options.consent=o),1==desktopsettings.autolock&&(desktop.options.autolock=!0),desktop.onStateChanged=onDesktopStateChange,0!=(8192&features2)&&(desktop.m.stopInput=!0),desktop.m.onRemoteInputLockChanged=function(e,t){QV("DeskInputLockedButton",t),QV("DeskInputUnLockedButton",!t)},desktop.m.onKeyboardStateChanged=function(e,t){QS("p11numlock").display=1&t?"inline-block":"none",QS("p11scrolllock").display=2&t?"inline-block":"none",QS("p11capslock").display=4&t?"inline-block":"none"},desktop.onConsoleMessageChange=function(){desktop.consoleMessage?(Q("p11DeskConsoleMsg").innerHTML+=formatAgentConsoleMessage(desktop.consoleMessage,desktop.consoleMessageId,desktop.consoleMessageArgs),QV("p11DeskConsoleMsg",!0),null!=p11DeskConsoleMsgTimer&&clearTimeout(p11DeskConsoleMsgTimer),desktop.consoleMessageTimeout&&(p11DeskConsoleMsgTimer=setTimeout(p11clearConsoleMsg,1e3*desktop.consoleMessageTimeout))):p11clearConsoleMsg()},desktop.onMetadataChange=function(e){updateMetadata(desktop,"deskmetadata")},desktop.m.ImageType=desktopsettings.agentencoding,desktop.m.CompressionLevel=desktopsettings.quality,desktop.m.ScalingLevel=desktopsettings.scaling,desktopsettings.framerate&&(desktop.m.FrameRateTimer=desktopsettings.framerate),desktopsettings.swapmouse&&(desktop.m.SwapMouse=desktopsettings.swapmouse),desktopsettings.rmw&&(desktop.m.ReverseMouseWheel=desktopsettings.rmw),1==desktopsettings.remotekeymap&&(desktop.m.remoteKeyMap=desktopsettings.remotekeymap),desktop.m.onScreenSizeChange=deskAdjust,desktop.Start(desktopNode._id),desktop.latency.callback=function(e){updateSessionTime()},desktop.contype=1):3==t?meshserver.send({action:"msg",type:"userSessions",nodeid:currentNode._id,tag:o}):4==t&&((desktop=CreateRDPDesktop("Desk",domainUrl)).onStateChanged=onDesktopStateChange,desktop.m.onScreenSizeChange=mdeskAdjust,desktop.m.onClipboardChanged=function(e){null!=e&&desktopsettings.rdpautoclipboard&&null!=navigator.clipboard&&navigator.clipboard.writeText(e).then(function(){}).catch(function(e){console.log(e)})},desktopsettings.rdpsmb&&(desktop.m.SwapMouse=desktopsettings.rdpsmb),desktopsettings.rdprmw&&(desktop.m.ReverseMouseWheel=desktopsettings.rdprmw),desktop.Start(desktopNode._id,currentNode.rdpport||3389,n),desktop.contype=4,desktop.onConsoleMessageChange=function(){desktop.consoleMessage?(Q("p11DeskConsoleMsg").innerHTML+=formatAgentConsoleMessage(desktop.consoleMessage,desktop.consoleMessageId,desktop.consoleMessageArgs),QV("p11DeskConsoleMsg",!0),null!=p11DeskConsoleMsgTimer&&clearTimeout(p11DeskConsoleMsgTimer),desktop.consoleMessageTimeout&&(p11DeskConsoleMsgTimer=setTimeout(p11clearConsoleMsg,1e3*desktop.consoleMessageTimeout))):p11clearConsoleMsg()})):(desktop.Stop(),webRtcDesktopReset(),(desktopNode=desktop=null)!=pluginHandler&&pluginHandler.callHook("onDesktopDisconnect")))}function askRdpCredentials(){var e;xxdialogMode||(e="<div>",1==currentNode.rdp?e=e+addHtmlFormFloating("證書",'<select id=d2mode class="form-select" onchange=askRdpCredentialsValidate()><option value=1>使用服務器憑據</option><option value=2>使用新憑據</option></select>')+"<div id=d2cred style=display:none>":e+="<div id=d2cred>",e=(e=(e+=addHtmlFormFloating("域",'<input type=text id=d2domain class="form-control" maxlength=128 />'))+addHtmlFormFloating("用戶名",'<input type=text id=d2user class="form-control" onKeyUp=askRdpCredentialsValidate() maxlength=128 />'))+addHtmlFormFloating("密碼",'<input type=password id=d2pass class="form-control" maxlength=128 autocomplete=off />'),0==(4194304&features2)&&(e+=addHtmlValue("",'<label><input type="checkbox" class="form-check-input me-2" id=d2savecred>記住憑據</label>')),setModalContent("xxAddAgent","RDP 憑證",e=(e=(e=(e=(e+="</div>")+MoreStart())+addHtmlFormFloating("替代Shell",'<input type=text id=d2altshell class="form-control" maxlength=2048 />'))+addHtmlFormFloating("工作目錄",'<input type=text id=d2workdir class="form-control" maxlength=2048 />'))+MoreEnd()),showModal("xxAddAgentModal","idx_dlgOkButton",()=>askRdpCredentialsEx()))}function askRdpCredentialsValidate(){1==currentNode.rdp&&(QV("d2cred",2==Q("d2mode").value),1==Q("d2mode").value)?QE("idx_dlgOkButton",!0):QE("idx_dlgOkButton",""!=Q("d2user").value)}function askRdpCredentialsEx(){var e,t=null,n=null;desktopsettings.rdpsize?"browser"==desktopsettings.rdpsize?(t=window.innerWidth,n=window.innerHeight):"screen"==desktopsettings.rdpsize?(t=window.screen.width,n=window.screen.height):"canvas"==desktopsettings.rdpsize?(t=Q("DeskParent").offsetWidth,n=Q("DeskParent").offsetHeight):1<=(e=desktopsettings.rdpsize.indexOf("x"))&&(t=parseInt(desktopsettings.rdpsize.substring(0,e)),n=parseInt(desktopsettings.rdpsize.substring(e+1))):(t=Q("DeskParent").offsetWidth,n=Q("DeskParent").offsetHeight),1==currentNode.rdp&&1==Q("d2mode").value?connectDesktop(null,4,{servercred:!0,width:t,height:n,flags:null!=desktopsettings.rdpflags?desktopsettings.rdpflags:47,altshell:Q("d2altshell").value,workdir:Q("d2workdir").value}):(e=!1,0==(4194304&features2)&&(e=Q("d2savecred").checked),connectDesktop(null,4,{domain:Q("d2domain").value,username:Q("d2user").value,password:Q("d2pass").value,savecred:e,width:t,height:n,flags:null!=desktopsettings.rdpflags?desktopsettings.rdpflags:47,altshell:Q("d2altshell").value,workdir:Q("d2workdir").value}))}function updateMetadata(e,t){var n="",o=0;if(e&&3==e.State){if(e.metadata&&e.metadata.users)for(var i in e.metadata.users)o+=e.metadata.users[i];1<o&&(n="<span onclick=showSessionMetadata(1) style=cursor:pointer>"+format("，{0}觀看",o)+"</span>")}QH("deskmetadata",n),e==desktop&&"sessionMetadata1"==xxdialogTag&&showSessionMetadata(1)}function showSessionMetadata(e){if(!xxdialogMode||xxdialogTag=="sessionMetadata"+e){xxdialogMode&&setDialogMode(0);var t=1==e?desktop:null;if(t&&t.metadata){var n="";if(t.metadata.startTime&&(n+=addHtmlValue4("開始時間",printDateTime(new Date(t.metadata.startTime)))),t.metadata.users)for(var o in t.metadata.users){var i=1==t.metadata.users[o]?"1位聯絡文":format("{0}個連接",t.metadata.users[o]);n+=addHtmlValue2(getUserName(o),i)}xxdialogTag="sessionMetadata"+e,setModalContent("xxAddAgent","會議訊息",n),showModal("xxAddAgentModal","idx_dlgOkButton")}}}function p11clearConsoleMsg(){QH("p11DeskConsoleMsg",""),QV("p11DeskConsoleMsg",!1),p11DeskConsoleMsgTimer&&(clearTimeout(p11DeskConsoleMsgTimer),p11DeskConsoleMsgTimer=null)}function p12clearConsoleMsg(){QH("p12TermConsoleMsg",""),QV("p12TermConsoleMsg",!1),p12TermConsoleMsgTimer&&(clearTimeout(p12TermConsoleMsgTimer),p12TermConsoleMsgTimer=null)}function p13clearConsoleMsg(){QH("p13FilesConsoleMsg",""),QV("p13FilesConsoleMsg",!1),p13FilesConsoleMsgTimer&&(clearTimeout(p13FilesConsoleMsgTimer),p13FilesConsoleMsgTimer=null)}function p12setConsoleMsg(e,t){e?(Q("p12TermConsoleMsg").innerHTML+=e,QV("p12TermConsoleMsg",!0),null!=p12TermConsoleMsgTimer&&clearTimeout(p12TermConsoleMsgTimer),t&&(p12TermConsoleMsgTimer=setTimeout(p12clearConsoleMsg,t))):p12clearConsoleMsg()}function p13setConsoleMsg(e,t){e?(Q("p13FilesConsoleMsg").innerHTML+=e,QV("p13FilesConsoleMsg",!0),null!=p13FilesConsoleMsgTimer&&clearTimeout(p13FilesConsoleMsgTimer),t&&(p13FilesConsoleMsgTimer=setTimeout(p13clearConsoleMsg,t))):p13clearConsoleMsg()}var webRtcDesktop=null;function webRtcDesktopReset(){if(null!=webRtcDesktop){if(null!=webRtcDesktop.softdesktop&&(webRtcDesktop.softdesktop.Stop(),webRtcDesktop.softdesktop=null),null!=webRtcDesktop.webchannel){try{webRtcDesktop.webchannel.close()}catch(e){}webRtcDesktop.webchannel=null}if(null!=webRtcDesktop.webrtc){try{webRtcDesktop.webrtc.close()}catch(e){}webRtcDesktop.webrtc=null}webRtcDesktop=null,desktop&&desktop.m&&(desktop.m.hold(!1),Q("deskstatus").textContent=StatusStrs[desktop.State])}}function onDesktopStateChange(e,t){var n=t,e=(3==n&&2==e.contype&&n++,StatusStrs[n]);switch(null!=desktop&&1==desktop.webRtcActive&&(e+="，WebRTC"),null!=desktop&&3==n&&4==desktop.contype&&(e+=", RDP"),QH("deskstatus",e),t){case 0:null!=desktop&&(null!=desktop.m.recordedData&&deskRecordSession(),desktop.Stop()),desktopNode=desktop=null,QV("DeskFocus",!1),QV("DeskMonitorSelectionSpan",!1),QV("deskRecordIcon",!1),QV("DeskInputLockedButton",!1),QV("DeskInputUnLockedButton",!1),deskFocusBtn.value="全部聚焦",1==fullscreen&&deskToggleFull(),webRtcDesktopReset(),deskPreferedStickyDisplay=0;break;case 2:break;case 3:desktop&&1==desktop.serverIsRecording&&QV("deskRecordIcon",!0),desktop.startTime=new Date,(deskLastClipboardSent=null)==updateSessionTimer&&(updateSessionTimer=setInterval(updateSessionTime,1e3))}updateDesktopButtons(),deskAdjust(),setTimeout(deskAdjust,50),updateMetadata(desktop,"deskmetadata")}function updateSessionTime(){var e="",t=0;if(desktop&&desktop.startTime){if(desktop.latency&&0<=desktop.latency.current&&(e=format("{0} ms",desktop.latency.current)),t=Math.floor((new Date-desktop.startTime)/1e3),QH("DeskTimer",zeroPad(Math.floor(t/3600),2)+":"+zeroPad(Math.floor(t/60)%60,2)+":"+zeroPad(t%60,2)),QH("DeskLatency",e),(4!=desktop.contype&&!0===desktopsettings.autoclipboard||4==desktop.contype&&!0===desktopsettings.rdpautoclipboard)&&null!=navigator.clipboard&&null!=navigator.clipboard.readText){if("firefox"==Mstsc.browser())return;try{navigator.clipboard.readText().then(function(e){null!=desktop&&null!=e&&deskLastClipboardSent!=e&&(desktop.m.setClipboard?desktop.m.setClipboard(e):(console.log("s3"),meshserver.send({action:"msg",type:"setclip",nodeid:currentNode._id,data:e})),deskLastClipboardSent=e)}).catch(function(e){})}catch(e){console.log(e)}}}else QH("DeskTimer",""),QH("DeskLatency","");t=0,terminal&&terminal.startTime?(terminal.latency&&0<=terminal.latency.current&&(e=format("{0} ms, ",terminal.latency.current)),t=Math.floor((new Date-terminal.startTime)/1e3),QH("TermTimer",e+zeroPad(Math.floor(t/3600),2)+":"+zeroPad(Math.floor(t/60)%60,2)+":"+zeroPad(t%60,2))):QH("TermTimer",""),null==desktop&&null==terminal&&(clearInterval(updateSessionTimer),updateSessionTimer=null)}function showDesktopSettings(){var e;xxdialogMode||(applyDesktopSettings(),updateDesktopButtons(),e=!1,0==(e="none"!=QS("td7meshkvm").display&&0<Q("td7meshkvm").className.indexOf("active")||"none"!=QS("td7rdpkvm").display&&0<Q("td7rdpkvm").className.indexOf("active")||"none"!=QS("td7amtkvm").display&&0<Q("td7amtkvm").className.indexOf("active")?!0:e)&&("none"!=QS("td7meshkvm").display?changeDesktopSettingsTab(null,"d7meshkvm"):"none"!=QS("td7rdpkvm").display?changeDesktopSettingsTab(null,"d7rdpkvm"):"none"!=QS("td7amtkvm").display&&changeDesktopSettingsTab(null,"d7amtkvm")),xxdialogButtons=3,setModalContent("xxAddAgent","遠程桌面設置",7),showModal("xxAddAgentModal","idx_dlgOkButton",showDesktopSettingsChanged))}function changeDesktopSettingsTab(e,t){for(var n,o=document.getElementsByClassName("tabcontent"),i=0;i<o.length;i++)o[i].style.display="none";for(n=document.getElementsByClassName("tablinks"),i=0;i<n.length;i++)n[i].className=n[i].className.replace(" active","");document.getElementById(t).style.display="block",null!=e?e.currentTarget.className+=" active":document.getElementById("t"+t).className+=" active"}function showDesktopSettingsChanged(){desktopsettings.encoding=d7desktopmode.value,desktopsettings.showfocus=d7showfocus.checked,desktopsettings.showmouse=d7showcursor.checked,desktopsettings.quality=d7bitmapquality.value,desktopsettings.scaling=d7bitmapscaling.value,desktopsettings.framerate=d7framelimiter.value,desktopsettings.agentencoding=d7encoding.value,desktopsettings.swapmouse=d7deskSwapMouse.checked,desktopsettings.rmw=d7deskrmw.checked,desktopsettings.remotekeymap=d7deskRemoteKeyMap.checked,desktopsettings.autoclipboard=d7deskAutoClipboard.checked,desktopsettings.autolock=d7deskAutoLock.checked,desktopsettings.localkeymap=d7localKeyMap.checked,desktopsettings.kvmrmw=d7kvmrmw.checked,desktopsettings.rdpsize=d7rdpsize.value,desktopsettings.rdpsmb=d7rdpsmb.checked,desktopsettings.rdprmw=d7rdprmw.checked,desktopsettings.rdpautoclipboard=d7rdpclip.checked;for(var e=0,t=1;t<10;t++)5!=t&&Q("d7rdp"+t).checked&&(e|=1<<t-1);desktopsettings.rdpflags=e,localStorage.setItem("desktopsettings",JSON.stringify(desktopsettings)),applyDesktopSettings(),updateDesktopButtons(),desktop&&(1==desktop.contype&&(desktop.m.SwapMouse=desktopsettings.swapmouse,desktop.m.ReverseMouseWheel=desktopsettings.rmw,desktop.m.remoteKeyMap=desktopsettings.remotekeymap,0!=desktop.State)&&(desktop.m.SendCompressionLevel(desktopsettings.agentencoding,desktopsettings.quality,desktopsettings.scaling,desktopsettings.framerate),desktop.sendCtrlMsg('{"ctrlChannel":"102938","type":"autolock","value":'+desktopsettings.autolock+"}"),desktop.m.SendRefresh()),2==desktop.contype&&(desktop.m.ReverseMouseWheel=desktopsettings.kvmrmw,0==desktopsettings.showfocus&&(desktop.m.focusmode=0,deskFocusBtn.value="全部聚焦"),0!=desktop.State)&&(desktop.Stop(),setTimeout(function(){connectDesktop(null,2)},50)),4==desktop.contype)&&(desktop.m.SwapMouse=desktopsettings.rdpsmb,desktop.m.ReverseMouseWheel=desktopsettings.rdprmw)}function applyDesktopSettings(){var e="",t=512&features?[100,90,80,70,60,50,40,30,20,10,5,1]:[60,50,40,30,20,10,5,1];for(n in t)e+="<option value="+t[n]+">"+t[n]+"%</option>";QH("d7bitmapquality",e),d7desktopmode.value=desktopsettings.encoding,d7showfocus.checked=desktopsettings.showfocus,d7showcursor.checked=desktopsettings.showmouse,desktopsettings.agentencoding?d7encoding.value=desktopsettings.agentencoding:desktopsettings.agentencoding=4,d7bitmapquality.value=40,0<=t.indexOf(parseInt(desktopsettings.quality))&&(d7bitmapquality.value=desktopsettings.quality),d7bitmapscaling.value=desktopsettings.scaling,desktopsettings.framerate?d7framelimiter.value=desktopsettings.framerate:d7framelimiter.value=100,null!=desktopsettings.swapmouse&&(d7deskSwapMouse.checked=desktopsettings.swapmouse),null!=desktopsettings.rmw&&(d7deskrmw.checked=desktopsettings.rmw),null!=desktopsettings.remotekeymap&&(d7deskRemoteKeyMap.checked=desktopsettings.remotekeymap),null!=desktopsettings.autoclipboard&&(d7deskAutoClipboard.checked=desktopsettings.autoclipboard),null!=desktopsettings.autolock&&(d7deskAutoLock.checked=desktopsettings.autolock),desktopsettings.localkeymap&&(d7localKeyMap.checked=desktopsettings.localkeymap),desktopsettings.kvmrmw&&(d7kvmrmw.checked=desktopsettings.kvmrmw),QV("deskFocusBtn",null!=desktop&&2==desktop.contype&&0!=desktop.state&&desktopsettings.showfocus),null!=desktopsettings.rdpsize&&(d7rdpsize.value=desktopsettings.rdpsize),null==desktopsettings.rdpflags&&(desktopsettings.rdpflags=47),null!=desktopsettings.rdpsmb&&(d7rdpsmb.checked=desktopsettings.rdpsmb),null!=desktopsettings.rdprmw&&(d7rdprmw.checked=desktopsettings.rdprmw),null!=desktopsettings.rdpautoclipboard&&(d7rdpclip.checked=desktopsettings.rdpautoclipboard);for(var n=1;n<10;n++)5!=n&&(Q("d7rdp"+n).checked=0!=(desktopsettings.rdpflags&1<<n-1))}function enterBrowserFullscreen(e){navigator.keyboard&&navigator.keyboard.lock&&navigator.keyboard.lock(),e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}function exitBrowserFullscreen(){document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),navigator.keyboard&&navigator.keyboard.unlock&&navigator.keyboard.unlock()}function isBrowserFullscreen(){return!!(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement)}var fullscreen=!1,browserfullscreen=!1;function deskToggleFull(e){var t=!(0===args.xterm||null!=terminal&&null==xterm);(fullscreen=!fullscreen)?(QC("body").add("fulldesk"),QS("deskarea3x").height="100%",QS("deskarea3x")["max-height"]="100%",t?(QS("termTable").position="absolute",QS("termTable").top=QS("termTable").bottom=QS("termTable").left=QS("termTable").right="0"):(QS("termTable").height="100%",QS("termTable")["max-height"]="100%"),1==e.shiftKey&&(enterBrowserFullscreen(Q("container")),browserfullscreen=!0)):(QC("body").remove("fulldesk"),e=args.hide,0==footerBar&&(e|=4),e=(1&e?0:66)+(2&e?0:24)+(4&e?0:45)+(8&e?0:60),QS("deskarea3x").height="calc(100vh - "+(75+e)+"px)",QS("deskarea3x")["max-height"]="calc(100vh - "+(75+e)+"px)",t?(QS("termTable").position=null,QS("termTable").top=QS("termTable").bottom=QS("termTable").left=QS("termTable").right=null):(QS("termTable").height="calc(100vh - "+(75+e)+"px)",QS("termTable")["max-height"]="calc(100vh - "+(75+e)+"px)"),1==browserfullscreen&&(exitBrowserFullscreen(),browserfullscreen=!1)),deskAdjust(),updateDesktopButtons(),adjustPanels(),null!=xterm&&12==xxcurrentView&&(xtermfit.fit(),xterm.focus())}function deskToggleFocus(){desktop.m.focusmode=(desktop.m.focusmode+64)%192,Q("deskFocusBtn").value=["全部聚焦","小焦點","大焦點"][desktop.m.focusmode/64]}function deskAdjust(){var e=Q("DeskParent").clientHeight,t=Q("DeskParent").clientWidth,n=Q("Desk").height,o=Q("Desk").width;2==deskAspectRatio?(QS("Desk")["margin-top"]=null,QS("Desk").height="100%",QS("Desk").width="100%",QS("DeskParent").overflow="hidden"):1==deskAspectRatio?(QS("Desk")["margin-top"]="0px",QS("Desk").height=n+"px",QS("Desk").width=o+"px",QS("DeskParent").overflow="scroll"):(n/o<e/t?(t=n*t/o+"px",QS("Desk").height=t,QS("Desk").width="100%"):(t=o*e/n+"px",QS("Desk").height=webPageFullScreen||fullscreen?null:"100%",QS("Desk").width=t),QS("Desk")["margin-top"]=null,QS("DeskParent").overflow="hidden")}function mdeskAdjust(e,t,n,o){var i;e&&t&&n&&o&&(3!=(i=Q("viewselect").value)&&5!=i||("Desk"==o.id?deskAdjust():(5==i&&(i=[{x:180,y:101},{x:302,y:169},{x:454,y:255}][Q("sizeselect").selectedIndex],QS(o.id).width=(0!=e.State?t*i.y/n:i.x)+"px"),QS(o.id)["margin-top"]=null,QS(o.id)["margin-bottom"]=null)))}function sendDeskEsc(){null!=desktop&&3==desktop.State&&(2==desktop.contype?desktop.m.sendkey([[65307,1],[65307,0]]):desktop.m.SendKeyMsgKC([[desktop.m.KeyAction.EXDOWN,27],[desktop.m.KeyAction.EXUP,27]]))}function p11fileDragDrop(e){var t;haltEvent(e),QV("p11bigfail",!1),QV("p11bigok",!1),null==xxdialogMode&&null!=desktop&&3==desktop.State&&null!=e.dataTransfer&&0!=e.dataTransfer.files.length&&((t=(e=e.dataTransfer.files[0]).name.toLowerCase()).endsWith(".bat")||t.endsWith(".ps1")||t.endsWith(".sh")||t.endsWith(".agentconsole")?d2runCommandDialog({nodeids:[currentNode._id],selectedFile:e}):t.endsWith(".txt")&&((t=new FileReader).onload=function(e){showDeskType(e.target.result)},t.readAsText(e)))}var p11dragtimer=null;function p11fileDragOver(e){haltEvent(e),null!=p11dragtimer&&(clearTimeout(p11dragtimer),p11dragtimer=null);e=null==xxdialogMode&&null!=desktop&&3==desktop.State;QV("p11bigok",e),QV("p11bigfail",!e)}function p11fileDragLeave(e){haltEvent(e),"Desk"!=e.target.id?(QV("p11bigfail",!1),QV("p11bigok",!1)):p11dragtimer=setTimeout(function(){QV("p11bigfail",!1),QV("p11bigok",!1),p11dragtimer=null},10)}function updateDeskShortcutKeys(){var e,t="",n=parseInt(Q("deskkeys").value);for(e in""==n&&0<deskKeyboardShortcuts.length&&(n=deskKeyboardShortcuts[0]),deskKeyboardShortcuts)t+="<option value="+deskKeyboardShortcuts[e]+(n==deskKeyboardShortcuts[e]?" selected":"")+">"+keyShortcutTotext(deskKeyboardShortcuts[e])+"</option>";QH("deskkeys",t)}var keyStrings={8:"退格",9:"Tab",13:"輸入",27:"逃脫",32:"Space",44:"打印屏幕",45:"插入",46:"Del",36:"家",35:"結尾",33:"向上翻頁",34:"向下翻頁",37:"左",38:"上",39:"右",40:"下",0:"沒有"};function keyShortcutTotext(e){var t=[];return 65536&e&&t.push("Shift"),131072&e&&t.push("Alt"),524288&e&&t.push("Ctrl"),1048576&e&&t.push("Win"),112<=(e&=65535)&&e<=123?t.push("F"+(e-111)):0!=e&&keyStrings[e]?t.push(keyStrings[e]):0!=e&&t.push(String.fromCharCode(e)),t.join(" + ")}function deskCustomizeKeys(){if(!xxdialogMode){var e=(e='<div id=d2shortcuts style="width:100%;height:180px;padding:4px;overflow-y:auto;border:1px solid gray"></div><div style=width:100%;padding:5px>')+'<label><input id=d1kshift type=checkbox class="form-check-input me-2" /> Shift</label><label> <input id=d1kalt type=checkbox class="form-check-input me-2" /> Alt</label><label> <input id=d1kctrl type=checkbox class="form-check-input me-2" /> Ctrl</label> <input id=d1kwin type=checkbox class="form-check-input me-2" /> Win</label>'+" <select id=d2keySelect>";for(t in keyStrings)e+="<option value="+t+">"+keyStrings[t]+"</option>";for(var t=1;t<=12;t++)e+="<option value="+(t+111)+">F"+t+"</option>";for(t=0;t<10;t++)e+="<option value="+(t+48)+">"+t+"</option>";for(t=0;t<26;t++)e+="<option value="+(t+65)+">"+String.fromCharCode(t+65)+"</option>";setModalContent("xxAddAgent","鍵盤快捷鍵自定義",e=e+"</select> <input type=button value=添加 onclick=addDeskCustomizeKey() /></div>"+'<div style=width:100%;padding:2px;text-align:center><input type=button value="Restore Default Keyboard Shortcuts" onclick=restoreDeskCustomizeKey() /></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>deskCustomizeKeysEx()),deskUpdateShortcutList()}}function deskCustomizeKeysEx(){putstore("deskKeyShortcuts",deskKeyboardShortcuts.join(",")),updateDeskShortcutKeys()}function deskUpdateShortcutList(){var e,t="";for(e in deskKeyboardShortcuts){var n=keyShortcutTotext(deskKeyboardShortcuts[e]),o="";e!=deskKeyboardShortcuts.length-1&&(o+='<img width=8 height=8 style=float:right;cursor:pointer;padding:3px src="images/c2.png" onclick=deskCustomizeKeyDown('+deskKeyboardShortcuts[e]+")>"),0!=e&&(o+='<img width=8 height=8 style=float:right;cursor:pointer;padding:3px src="images/c3.png" onclick=deskCustomizeKeyUp('+deskKeyboardShortcuts[e]+")>"),t+='<div style="width:100%;background-color:#AAA;border-radius:4px;margin-bottom:4px;padding:4px;text-align:left;box-sizing:border-box" value='+deskKeyboardShortcuts[e]+">"+n+'<img width=10 height=10 style=float:right;cursor:pointer;padding:2px;margin-left:8px src="images/trash.png" onclick=removeDeskCustomizeKey('+deskKeyboardShortcuts[e]+")>"+o+"</div>"}""==t&&(t="<i>未定義鍵盤快捷鍵</i>"),QH("d2shortcuts",t)}function deskCustomizeKeyDown(e){var e=deskKeyboardShortcuts.indexOf(e),t=deskKeyboardShortcuts[e+1];deskKeyboardShortcuts[e+1]=deskKeyboardShortcuts[e],deskKeyboardShortcuts[e]=t,deskUpdateShortcutList()}function deskCustomizeKeyUp(e){var e=deskKeyboardShortcuts.indexOf(e),t=deskKeyboardShortcuts[e];deskKeyboardShortcuts[e]=deskKeyboardShortcuts[e-1],deskKeyboardShortcuts[e-1]=t,deskUpdateShortcutList()}function removeDeskCustomizeKey(e){var t,n=[];for(t in deskKeyboardShortcuts)deskKeyboardShortcuts[t]!=e&&n.push(deskKeyboardShortcuts[t]);deskKeyboardShortcuts=n,deskUpdateShortcutList()}function restoreDeskCustomizeKey(){deskKeyboardShortcuts=[],putstore("deskKeyShortcuts",null);var e,t=getstore("deskKeyShortcuts","0x0A002E,0x100000,0x100028,0x100026,0x10004C,0x10004D,0x11004D,0x100052,0x020073,0x080057,0x020009,0x100025,0x100027").split(",");for(e in t)""!=t[e]&&deskKeyboardShortcuts.push(parseInt(t[e]));updateDeskShortcutKeys(),deskUpdateShortcutList()}function addDeskCustomizeKey(){var e=parseInt(Q("d2keySelect").value);Q("d1kshift").checked&&(e|=65536),Q("d1kalt").checked&&(e|=131072),Q("d1kctrl").checked&&(e|=524288),Q("d1kwin").checked&&(e|=1048576),0<e&&-1==deskKeyboardShortcuts.indexOf(e)&&(deskKeyboardShortcuts.push(e),deskUpdateShortcutList())}function deskCustomizeStrings(){var e;xxdialogMode||(e='<div id=d2strings style="width:100%;height:180px;padding:4px;overflow-y:auto;border:1px solid gray"></div><div style=width:100%;padding:5px>',setModalContent("xxAddAgent","鍵盤字符串自定義",e=(e=(e+=addHtmlFormFloating("名稱",'<input type=text id=d2shortcutname class="form-control" maxlength=32 autocomplete=off onkeyup=deskCustomizeStringsUpdate(event) />'))+addHtmlFormFloating("價值",'<input type=text id=d2shortcutvalue class="form-control" maxlength=256 autocomplete=off onkeyup=deskCustomizeStringsUpdate(event) />'))+addHtmlFormFloating("",'<input id=d2addbutton type=button value=添加 onclick=addDeskCustomizeString() class="form-control" />')),showModal("xxAddAgentModal","idx_dlgOkButton",()=>deskCustomizeStringsEx()),deskUpdateStringsList(),deskCustomizeStringsUpdate())}function deskCustomizeStringsUpdate(){QE("d2addbutton",""!=Q("d2shortcutname").value&&""!=Q("d2shortcutvalue").value)}function deskCustomizeStringsEx(){putstore("deskStrings",JSON.stringify(deskKeyboardStrings)),updateDesktopStrings()}function deskUpdateStringsList(){var e,t="";for(e in deskKeyboardStrings){var n="";e!=deskKeyboardStrings.length-1&&(n+='<img width=8 height=8 style=float:right;cursor:pointer;padding:3px src="images/c2.png" onclick=deskCustomizeStringDown('+e+")>"),0!=e&&(n+='<img width=8 height=8 style=float:right;cursor:pointer;padding:3px src="images/c3.png" onclick=deskCustomizeStringUp('+e+")>"),t=(t+='<div style="width:100%;background-color:#AAA;border-radius:4px;margin-bottom:4px;padding:4px;text-align:left;box-sizing:border-box" value='+(e+1e3)+"><div><b>"+EscapeHtml(deskKeyboardStrings[e].n)+'</b><img width=10 height=10 style=float:right;cursor:pointer;padding:2px;margin-left:8px src="images/trash.png" onclick=removeDeskCustomizeString('+e+")>"+n+"</div>")+("<div stlye=font-size:x-small>"+EscapeHtml(deskKeyboardStrings[e].v)+"</div>")+"</div>"}""==t&&(t="<i>未定義鍵盤字符串</i>"),QH("d2strings",t)}function deskCustomizeStringDown(e){var t=deskKeyboardStrings[e+1];deskKeyboardStrings[e+1]=deskKeyboardStrings[e],deskKeyboardStrings[e]=t,deskUpdateStringsList()}function deskCustomizeStringUp(e){var t=deskKeyboardStrings[e];deskKeyboardStrings[e]=deskKeyboardStrings[e-1],deskKeyboardStrings[e-1]=t,deskUpdateStringsList()}function removeDeskCustomizeString(e){deskKeyboardStrings.splice(e,1),deskUpdateStringsList()}function addDeskCustomizeString(){Array.isArray(deskKeyboardStrings)||(deskKeyboardStrings=[]);var e=Q("d2shortcutname").value,t=Q("d2shortcutvalue").value;""!=e&&""!=t&&(deskKeyboardStrings.push({n:e,v:t}),deskUpdateStringsList())}function updateDesktopStrings(){var e,t="";for(e in deskKeyboardStrings)t+='<div class="cmtext" onclick="cmdeskpreconfigtypeaction('+(parseInt(e)+1e3)+',event)">'+EscapeHtml(deskKeyboardStrings[e].n)+"</div>";""!=t&&(t+="<hr />"),QH("deskPreConfigShortcutContextMenu2",t)}function deskSendKeys(){if(Q("DeskWD").blur(),!xxdialogMode&&null!=desktop&&3==desktop.State){var e=parseInt(Q("deskkeys").value);if(655406==e)desktop.m.sendcad();else{var t=(16711680&e)>>16,e=65535&e,n=[],o=[],i={8:65288,9:65289,13:65293,27:65307,45:65379,46:65535,36:65360,35:65367,33:65365,34:65366,37:65361,38:65362,39:65363,40:65364,112:65470,113:65471,114:65472,115:65473,116:65474,117:65475,118:65476,119:65477,120:65478,121:65479,122:65480,123:65481};if(2==desktop.contype){1&t&&(n.push([65505,1]),o.push([65505,0])),2&t&&(n.push([65513,1]),o.push([65513,0])),8&t&&(n.push([65507,1]),o.push([65507,0])),16&t&&(n.push([65511,1]),o.push([65511,0])),65<=(e=i[e]?i[e]:e)&&e<=90&&(e+=32),0!=e&&(n.push([e,1]),o.push([e,0])),o.reverse();for(var s=0;s<o.length;s++)n.push(o[s]);desktop.m.sendkey(n)}else{1&t&&(n.push([desktop.m.KeyAction.DOWN,16]),o.push([desktop.m.KeyAction.UP,16])),2&t&&(n.push([desktop.m.KeyAction.EXDOWN,18]),o.push([desktop.m.KeyAction.EXUP,18])),8&t&&(n.push([desktop.m.KeyAction.EXDOWN,17]),o.push([desktop.m.KeyAction.EXUP,17])),16&t&&(n.push([desktop.m.KeyAction.EXDOWN,91]),o.push([desktop.m.KeyAction.EXUP,91])),0!=e&&(n.push([desktop.m.KeyAction.DOWN,e]),o.push([desktop.m.KeyAction.UP,e])),o.reverse();for(s=0;s<o.length;s++)n.push(o[s]);desktop.m.SendKeyMsgKC(n)}}}}function showDeskType(e){var t;xxdialogMode||null==desktop||3!=desktop.State||(Q("DeskType").blur(),t="<div>輸入文本，然後單擊確定以遠程鍵入它。在繼續操作之前，請確保將遠程光標放置在正確的位置。<div>",setModalContent("xxAddAgent","遠程鍵盤輸入",t+='<textarea id=d2typeText style="margin-top:5px;width:100%;height:184px;resize:none" maxlength=2000>'+(e?EscapeHtml(e):"")+"</textarea>"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>showDeskTypeEx()),Q("d2typeText").focus())}var AmtDeskTypeTimer=null,AmtDeskTypeContent=null,DeskTypeTranslate={39:222,42:106,43:107,44:188,45:189,46:190,47:191,59:186,61:187,91:219,92:220,93:221,96:192,191:111},DeskTypeShiftTranslate={33:49,34:222,35:51,36:52,37:53,38:55,40:57,41:48,58:186,60:188,62:190,63:191,64:50,94:54,95:189,106:56,107:187,123:219,124:220,125:221,126:192};function showDeskTypeEx(e){var t,n=[],o=!1,i=("string"==typeof e?t=e:(t=Q("d2typeText").value,Q("d2typeText").value)).toUpperCase();if(2==desktop.contype){for(var s in t){var a=t.charCodeAt(s);n.push([a,1],[a,0])}AmtDeskTypeContent=n,AmtDeskTypeTimer=setInterval(function(){var e=AmtDeskTypeContent.shift();desktop&&desktop.m.sendkey(e[0],e[1]),null!=desktop&&0!=AmtDeskTypeContent.length||(clearInterval(AmtDeskTypeTimer),AmtDeskTypeContent=null)},10)}else if(4==desktop.contype)desktop.m.SendStringUnicode(t);else if(!0!==desktopsettings.remotekeymap)desktop.m.SendStringUnicode(t);else{for(var s in t){var a=t.charCodeAt(s),l=i.charCodeAt(s);65<=a&&a<=90||97<=a&&a<=122?(a==l&&0==o&&(n.push([desktop.m.KeyAction.DOWN,16]),o=!0),a!=l&&1==o&&(n.push([desktop.m.KeyAction.UP,16]),o=!1)):48<=a&&a<=57?1==o&&(n.push([desktop.m.KeyAction.UP,16]),o=!1):DeskTypeTranslate[a]?(1==o&&(n.push([desktop.m.KeyAction.UP,16]),o=!1),l=DeskTypeTranslate[a]):DeskTypeShiftTranslate[a]&&(0==o&&(n.push([desktop.m.KeyAction.DOWN,16]),o=!0),l=DeskTypeShiftTranslate[a]),n.push([desktop.m.KeyAction.DOWN,l],[desktop.m.KeyAction.UP,l])}1==o&&(n.push([desktop.m.KeyAction.UP,16]),o=!1),desktop.m.SendKeyMsgKC(n)}}function showDeskClip(){var e;xxdialogMode||null==desktop||3!=desktop.State||(Q("DeskClip").blur(),e="",0==(2048&features2)&&(e+='<input id=dlgClipGet type=button value="獲取剪貼板" style=width:160px onclick=showDeskClipGet()>'),0==(4096&features2)&&(e+='<input id=dlgClipSet type=button value="設置剪貼板" style=width:160px onclick=showDeskClipSet()>'),xxdialogTag="clipboard",setModalContent("xxAddAgent","遠程剪貼板",e=(e+='<div id=dlgClipStatus style="display:inline-block;margin-left:8px" ></div>')+'<textarea id=d2clipText style="width:100%;height:184px;resize:none" maxlength=65535></textarea>'+'<input type=button value="Close" style=width:80px;float:right onclick=dialogclose(0)><div style=height:26px;margin-top:3px><span id=linuxClipWarn style=display:none>遠程剪貼板的有效期為60秒。</span>&nbsp;</div><div></div>'),showModal("xxAddAgentModal","idx_dlgOkButton"),Q("d2clipText").focus())}function showDeskClipGet(){null!=desktop&&3==desktop.State&&meshserver.send({action:"msg",type:"getclip",nodeid:currentNode._id,tag:1})}function showDeskClipSet(){null!=desktop&&3==desktop.State&&(desktop.m.setClipboard?desktop.m.setClipboard(Q("d2clipText").value):(meshserver.send({action:"msg",type:"setclip",nodeid:currentNode._id,data:Q("d2clipText").value}),QV("linuxClipWarn",currentNode&&currentNode.agent&&4<currentNode.agent.id&&21!=currentNode.agent.id&&22!=currentNode.agent.id&&34!=currentNode.agent.id)))}function sendCAD(){xxdialogMode||null==desktop||3!=desktop.State||desktop.m.sendcad()}function toggleDeskTools(){Q("DeskToolsButton").blur(),xxdialogMode||("none"==QS("DeskTools").display?(QV("DeskTools",!0),Q("DeskTools").nodeid=currentNode._id,QH("DeskToolsProcesses",""),QH("DeskToolsServices",""),QV("deskToolsTopTabService",!1),changeDeskToolTab(0),refreshDeskTools(0),refreshDeskTools(1)):QV("DeskTools",!1))}var deskToolTabSelection=0;function changeDeskToolTab(e){deskToolTabSelection=e,QV("DeskToolsProcessTab",0==e),QV("DeskToolsServiceTab",1==e),QS("deskToolsTopTabProcess").bottom=0==e?"0px":"3px",QS("deskToolsTopTabService").bottom=1==e?"0px":"3px",QS("deskToolsTopTabProcess").color=0==e?"black":"gray",QS("deskToolsTopTabService").color=1==e?"black":"gray"}function refreshDeskTools(e){e=null==e?deskToolTabSelection:e;QV("DeskToolsRefreshButton",!1),setTimeout(refreshDeskToolsEx,500),0==e&&meshserver.send({action:"msg",type:"ps",nodeid:currentNode._id}),1==e&&meshserver.send({action:"msg",type:"services",nodeid:currentNode._id})}function refreshDeskToolsEx(){QV("DeskToolsRefreshButton",!0)}var deskTools={sort:1,ssort:1,msg:null,smsg:null,resizing:!1};function sortProcess(e){deskTools.sort=e,showDeskToolsProcesses(deskTools.msg)}function sortService(e){deskTools.ssort=e,showDeskToolsServices(deskTools.smsg)}function sortProcessPid(e,t){return e.p>t.p?1:e.p<t.p?-1:sortProcessName(e,t)}function sortProcessName(e,t){return e.d>t.d?1:e.d<t.d?-1:0}function showDeskToolsProcesses(e){if(null==(deskTools.msg=e))QH("DeskToolsProcesses","");else if(Q("DeskTools").nodeid==e.nodeid){var t=[],n=null;try{n=JSON.parse(e.value)}catch(e){}if(null!=n){for(var o in n)t.push({p:parseInt(o),c:n[o].cmd,d:n[o].cmd.toLowerCase(),u:n[o].user});0==deskTools.sort?t.sort(sortProcessPid):1==deskTools.sort&&t.sort(sortProcessName);var i,s,a="";for(i in t)0!=t[i].p&&(s=t[i].c,a=(a=(a=(a=(a+="<div onclick=showProcessDetails("+t[i].p+') class="deskToolsBar d-flex">')+'<div class="pe-1 text-start" style=width:50px;>'+EscapeHtml(t[i].p)+"</div>")+'<div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="'+EscapeHtml(s)+'">'+s+"</div>")+'<div class="ms-auto">'+(t[i].u?EscapeHtml(t[i].u):""))+'<i class="ps-1 fa-solid fa-trash-can" role="button" title="停止進程" onclick=\'return stopProcess('+EscapeHtml(t[i].p)+',"'+EscapeHtml(t[i].c)+"\")'></i></div></div>");QH("DeskToolsProcesses",a)}}}function showProcessDetails(e){xxdialogMode||(setModalContent("xxAddAgent",format("流程詳情，#{0}",e),"Requesting Process Details..."),xxdialogTag="ps|"+currentNode._id+"|"+e,showModal("xxAddAgentModal","idx_dlgOkButton"),meshserver.send({action:"msg",type:"psinfo",nodeid:currentNode._id,pid:e}))}function showDeskToolsServices(e){if(null==(deskTools.smsg=e))QH("DeskToolsProcesses","");else if(Q("DeskTools").nodeid==e.nodeid){QV("deskToolsTopTabService",!0);var t=[],n=null;try{n=JSON.parse(e.value)}catch(e){}if(null!=(deskTools.services=n)){for(var o in n)n[o].status?t.push({p:capitalizeFirstLetter(n[o].status.state.toLowerCase()),d:n[o].displayName,i:o}):n[o].serviceType&&t.push({p:n[o].serviceType,d:n[o].name,i:o});0==deskTools.ssort?t.sort(sortProcessPid):1==deskTools.ssort&&t.sort(sortProcessName);var i,s,a="";for(o in t)0!=t[o].p&&(i=t[o].d,"Stopped"==(s=t[o].p)?s="停止":"Running"==s&&(s="跑步"),a=(a=(a+="<div onclick=showServiceWaitDialog("+t[o].i+") class=deskToolsBar>")+"<div style=width:70px;float:left;padding-right:5px>"+EscapeHtml(s)+"</div>")+'<div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="'+i+'">'+EscapeHtml(i)+"</div></div>");QH("DeskToolsServices",a)}}}function showServiceDetailsDialog(e){var t,n,o;xxdialogMode&&-1!=xxdialogTag.indexOf("service_")&&(t=xxdialogTag.replace("service_",""),n=e.value?JSON.parse(e.value):deskTools.services[t],e.value&&(n.displayName=deskTools.services[t].displayName),null!=n)&&(e="",n.name&&(e+=addHtmlValue("名稱",n.name)),n.displayName&&(e+=addHtmlValue("顯示名稱",n.displayName)),n.status&&("Stopped"==(o=capitalizeFirstLetter(n.status.state.toLowerCase()))?o="停止":"Running"==o&&(o="跑步"),n.status.state&&(e+=addHtmlValue("狀態",o)),n.status.pid&&(e+=addHtmlValue("PID",n.status.pid)),o=[],!0===n.status.isFileSystemDriver&&o.push("FileSystemDriver"),!0===n.status.isInteractive&&o.push("互動"),!0===n.status.isKernelDriver&&o.push("內核驅動器"),!0===n.status.isOwnProcess&&o.push("自己的過程"),!0===n.status.isSharedProcess&&o.push("共享過程"),0<o.length)&&(e+=addHtmlValue("類型",o.join(", "))),n.startType&&(e+=addHtmlValue("Start Type",n.startType)),n.user&&(e+=addHtmlValue("用戶",n.user)),n.installedBy&&(e+=addHtmlValue("Installed By",n.installedBy)),n.installedDate&&(e+=addHtmlValue("Installed Date",printDateTime(new Date(n.installedDate)))),n.failureActions&&(n.failureActions.resetPeriod&&(e+=addHtmlValue("Restart Fail Count After ",(o=(n.failureActions.resetPeriod<86400?0:n.failureActions.resetPeriod)/86400)+" Day"+(1!=o?"s":""))),n.failureActions.actions)&&(n.failureActions.actions[0]&&(e+=addHtmlValue("First Failure",n.failureActions.actions[0].type)),n.failureActions.actions[1]&&(e+=addHtmlValue("Second Failure",n.failureActions.actions[1].type)),n.failureActions.actions[2])&&(e+=addHtmlValue("Subsequent Failures",n.failureActions.actions[2].type)),xxdialogTag="service_"+t,setModalContent("xxAddAgent","服務詳情",e+='<br/><div style=float:right;margin-bottom:12px><input type=button value="關" onclick=showServiceDetailsDialogEx(0,'+t+')></div><div style=margin-bottom:12px><input type=button value="開始" onclick=showServiceDetailsDialogEx(1,'+t+')><input type=button value="停止" onclick=showServiceDetailsDialogEx(2,'+t+')><input type=button value="重新啟動" onclick=showServiceDetailsDialogEx(3,'+t+")></div>"),showModal("xxAddAgentModal","idx_dlgOkButton"))}function showServiceWaitDialog(e){var t;return xxdialogMode||null!=(t=deskTools.services[e])&&(meshserver.send({action:"msg",type:"service",nodeid:currentNode._id,serviceName:t.name}),xxdialogTag="service_"+e,setModalContent("xxAddAgent","服務詳情","Requesting Service Details..."),showModal("xxAddAgentModal","idx_dlgOkButton")),!1}function showServiceDetailsDialogEx(e,t){setDialogMode(0),0!=e&&null!=(t=deskTools.services[t])&&(1==e&&meshserver.send({action:"msg",type:"serviceStart",nodeid:currentNode._id,serviceName:t.name}),2==e&&meshserver.send({action:"msg",type:"serviceStop",nodeid:currentNode._id,serviceName:t.name}),3==e&&meshserver.send({action:"msg",type:"serviceRestart",nodeid:currentNode._id,serviceName:t.name}),setTimeout(function(){refreshDeskTools(1)},1e3))}function toggleKvmControl(){Q("DeskControl").blur(),putstore("DeskControl",Q("DeskControl").checked?1:0),QS("DeskControlSpan").color=Q("DeskControl").checked?null:"red"}function deskRecordSession(){var e;null!=desktop&&(null==desktop.m.recordedData?(Q("DeskRecordButtonImage").style.color="red",desktop.m.StartRecording()):(Q("DeskRecordButtonImage").style.color="",e=new Date,e="桌面時段-"+currentNode.name+"-"+e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2)+"-"+("0"+e.getHours()).slice(-2)+"-"+("0"+e.getMinutes()).slice(-2),saveAs(data2blob(desktop.m.StopRecording().join("")),e+".mcrec")))}function deskSaveImage(){var e,t;xxdialogMode||null==desktop||3!=desktop.State||(e=new Date,t="桌面-"+currentNode.name+"-"+e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2)+"-"+("0"+e.getHours()).slice(-2)+"-"+("0"+e.getMinutes()).slice(-2),Q("Desk").toBlob(function(e){saveAs(e,t+".png")}))}function deskDisplayInfo(e,t,n){var o,i=0,s="";for(o in t){i++;var a=t[o],l=1,a=("All Displays"==a&&(a="所有顯示",l=2),a.startsWith("Display ")&&(a=format("顯示 {0}",a.substring(8))),"id=DeskMonitorSelectionX"+o+' title="'+EscapeHtml(a)+'" onclick=deskSetDisplay('+o+") role=button");s+=2==l?"<span "+a+' class="fa-layers fa-fw '+(n==o?"":" gray")+'"><i class="fa-solid fa-desktop"></i><i class="fa-solid fa-square" data-fa-transform="shrink-12 left-3 up-3"></i><i class="fa-solid fa-square" data-fa-transform="shrink-12 right-3 up-3"></i></span>':"<i "+a+' class="fa-fw fa-solid fa-desktop '+(n==o?"":" gray")+'"></i>',deskPreferedStickyDisplay==o&&n!=deskPreferedStickyDisplay&&desktop.m.SetDisplay(o),deskPreferedStickyDisplay=-1}QH("DeskMonitorSelectionSpan",s),QV("DeskMonitorSelectionSpan",1<i)}function deskGetDisplayNumbers(e){desktop.m.GetDisplayNumbers()}Q("DeskTools").addEventListener("mousemove",function(e){e=e.clientX-Q("DeskTools").getBoundingClientRect().left;Q("DeskTools").style.cursor=e<5?"col-resize":"default"}),Q("DeskTools").addEventListener("mousedown",function(e){"col-resize"===Q("DeskTools").style.cursor&&(deskTools.resizing=!0,Q("Desk").removeAttribute("onmouseup"),Q("Desk").removeAttribute("onmousedown"),Q("Desk").removeAttribute("onmousemove"))}),document.addEventListener("mouseup",function(){!0===deskTools.resizing&&"col-resize"===Q("DeskTools").style.cursor&&(deskTools.resizing=!1)}),document.addEventListener("mousemove",function(e){deskTools.resizing&&(e=Q("DeskTools").getBoundingClientRect().right-e.clientX)<Q("DeskParent").clientWidth-10&&(Q("DeskTools").style.width=e+"px")});var deskPreferedStickyDisplay=-1;function deskSetDisplay(e){desktop.m.SetDisplay(deskPreferedStickyDisplay=parseInt(e))}var terminalNode,dblClickDetectArgs={t:0,x:0,y:0};function dblClickDetect(e){var t;1==e.buttons&&((t=Date.now())-dblClickDetectArgs.t<250&&Math.abs(e.clientX-dblClickDetectArgs.x)<2&&Math.abs(e.clientY-dblClickDetectArgs.y)<2&&!xxdialogMode&&null!=desktop&&Q("DeskControl").checked&&(null!=webRtcDesktop&&null!=webRtcDesktop.softdesktop?(webRtcDesktop.softdesktop.m.mousedblclick(e),desktop.m.sendKeepAlive()):desktop.m.mousedblclick(e)),dblClickDetectArgs.t=t,dblClickDetectArgs.x=e.clientX,dblClickDetectArgs.y=e.clientY)}function dmousedown(e){setSessionActivity(),e.addx=Q("DeskParent").scrollLeft,e.addy=Q("DeskParent").scrollTop,!xxdialogMode&&null!=desktop&&Q("DeskControl").checked&&(null!=webRtcDesktop&&null!=webRtcDesktop.softdesktop?(webRtcDesktop.softdesktop.m.mousedown(e),desktop.m.sendKeepAlive()):desktop.m.mousedown(e)),dblClickDetect(e)}function dmouseup(e){setSessionActivity(),e.addx=Q("DeskParent").scrollLeft,e.addy=Q("DeskParent").scrollTop,!xxdialogMode&&null!=desktop&&Q("DeskControl").checked&&(null!=webRtcDesktop&&null!=webRtcDesktop.softdesktop?(webRtcDesktop.softdesktop.m.mouseup(e),desktop.m.sendKeepAlive()):desktop.m.mouseup(e))}function dmousemove(e){setSessionActivity(),e.addx=Q("DeskParent").scrollLeft,e.addy=Q("DeskParent").scrollTop,!xxdialogMode&&null!=desktop&&Q("DeskControl").checked?(Q("Desk").style.cursor="",null!=webRtcDesktop&&null!=webRtcDesktop.softdesktop?(webRtcDesktop.softdesktop.m.mousemove(e),desktop.m.sendKeepAlive()):desktop.m.mousemove(e)):xxdialogMode||null==desktop||Q("DeskControl").checked||(Q("Desk").style.cursor="not-allowed")}function dmousewheel(e){return setSessionActivity(),e.addx=Q("DeskParent").scrollLeft,e.addy=Q("DeskParent").scrollTop,!(xxdialogMode||null==desktop||!Q("DeskControl").checked||(null!=webRtcDesktop&&null!=webRtcDesktop.softdesktop?(webRtcDesktop.softdesktop.m.mousewheel(e),desktop.m.sendKeepAlive()):desktop.m.mousewheel&&desktop.m.mousewheel(e),haltEvent(e),0))}function drotate(e){xxdialogMode||null==desktop||(desktop.m.setRotation(desktop.m.rotation+e),deskAdjust(),deskAdjust())}function stopProcess(e,t){return setModalContent("xxAddAgent","進程控制",format('停止進程 #{0} "{1}"？',e,t)),showModal("xxAddAgentModal","idx_dlgOkButton",()=>stopProcessEx(3,e)),!1}function stopProcessEx(e,t){meshserver.send({action:"msg",type:"pskill",nodeid:currentNode._id,value:t}),setTimeout(refreshDeskTools,300)}function setupTerminal(){terminalNode!=currentNode&&null!=terminal&&terminalNode._id!=currentNode._id&&(terminal.Stop(),terminal=terminalNode=null),terminalNode=currentNode,updateTerminalButtons()}function updateTerminalButtons(){var e=null!=terminal&&0!=terminal.state,t=(3==terminalNode.mtype&&null!=terminalNode.agent&&4<terminalNode.agent.id&&512&features2&&(terminalNode.agent.caps=6),QV("disconnectbutton2span",1==e),QV("connectbutton2span",0==e&&null!=terminalNode.agent&&2&terminalNode.agent.caps&&3!=terminalNode.mtype),QV("connectbutton2sspan",512&features2&&0==e&&null!=terminalNode.agent&&2&terminalNode.agent.caps&&3!=terminalNode.agent.id&&0==(16777216&features2)),1==terminalNode.mtype?(QV("connectbutton2hspan",0==e&&null!=terminalNode.intelamt&&2==terminalNode.intelamt.state),QV("terminalSizeDropDown",0==e&&null!=terminalNode.intelamt&&2==terminalNode.intelamt.state)):(QV("connectbutton2hspan",0==e&&null!=terminalNode.intelamt&&2==terminalNode.intelamt.state&&null!=terminalNode.intelamt.ver),QV("terminalSizeDropDown",0==e&&null!=terminalNode.intelamt&&2==terminalNode.intelamt.state&&null!=terminalNode.intelamt.ver)),QV("termActionsBtn",3!=terminalNode.mtype),1==e&&3!=terminal.contype||null==terminalNode.agent||3==terminalNode.agent.id||4==terminalNode.agent.id?QH("terminalCustomUpperRight",""):QH("terminalCustomUpperRight","<a style=cursor:pointer onclick=cmsshportaction(1,event)>"+format("SSH 端口 {0}",terminalNode.sshport||22)+"</a>"),0!=(1&terminalNode.conn)||3==terminalNode.mtype),t=(QE("connectbutton2",t),QE("connectbutton2d",t),QE("connectbutton2s",t),QE("connectbutton2sd",t),0!=(6&terminalNode.conn)),t=(QE("connectbutton2h",t),QE("ctrlcbutton",e),QE("ctrlxbutton",e),QE("escbutton",e),QE("bsbutton",e),QE("pastebutton",e),QE("specialkeylist",e),QE("specialkeylistinput",e),QV("terminalSettingsButtons",terminal&&2==terminal.contype),terminal&&(Q("id_ttypebutton").value=terminalEmulations[terminal.m.terminalEmulation],Q("id_tfxkeysbutton").value=fxEmulations[terminal.m.fxEmulation],Q("id_tcrbutton").value="\r\n"==terminal.m.lineFeed?"CR+LF":"如果"),!(0===args.xterm||null!=terminal&&null==xterm));QV("termarea3xdiv",t),QV("Term",!t),QV("bsbutton",!t),QV("pastebutton",!t),QV("devListToolbarViewIcons2",t),QE("termSizeList",null==terminal)}function onTerminalStateChange(e,t){if(terminal==e){var n=t,o=(3==n&&2==e.contype&&n++,StatusStrs[n]);switch(3==n&&(3==e.contype&&(o+=", SSH"),1==e.webRtcActive)&&(o+="，WebRTC"),QH("termstatus",o),t){case 0:if(QH("termtitle",""),QV("termRecordIcon",!1),null==xterm)try{e.m.TermResetScreen(),e.m.TermDraw()}catch(e){}else xterm.dispose(),xterm=xtermfit=null;null!=e&&(e.Stop(),terminal=null);break;case 3:e&&1==e.serverIsRecording&&QV("termRecordIcon",!0),e.startTime=new Date,null==updateSessionTimer&&(updateSessionTimer=setInterval(updateSessionTime,1e3)),null!=xterm&&xterm.focus()}updateTerminalButtons()}}var autoConnectTerminalTimer=null;function autoConnectTerminal(e){autoConnectTerminalTimer=null==autoConnectTerminalTimer?setInterval(connectTerminal,100):(clearInterval(autoConnectTerminalTimer),null)}function CreateRemoteTunnel(e,t){var n={protocol:1};return null!=t&&"number"==typeof t.protocol&&(n.protocol=t.protocol),n.onTunnelUpdate=e,n.xxStateChange=function(e){},n.ProcessBinaryData=function(e){n.onTunnelUpdate(e)},n.ProcessData=function(e){n.onTunnelUpdate(e)},n.terminalEmulation=1,n.fxEmulation=0,n.lineFeed="\r\n",n}function tunnelUpdate(e){null!=xterm&&(xterm.writeUtf8?"string"==typeof e?xterm.writeUtf8(e):xterm.writeUtf8(new Uint8Array(e)):"string"==typeof e?xterm.write(e):xterm.write(new Uint8Array(e)))}function sshTunnelAuthDialog(e,t){function n(e,t){document.getElementById("xxAddAgentModal").removeEventListener("hide.bs.modal",n),connectTerminal()}var o="";e.askkeypass?o+=addHtmlFormFloating("驗證",'<select id=dp2authmethod class="form-select" onchange=sshAuthUpdate(event)><option value=3 selected>存儲密鑰</option><option value=1>用戶名密碼</option><option value=2>用戶名和密鑰</option></select>'):o+=addHtmlFormFloating("驗證",'<select id=dp2authmethod class="form-select" onchange=sshAuthUpdate(event)><option value=1 selected>用戶名密碼</option><option value=2>用戶名和密鑰</option></select>'),o=(o=(o+="<div id=d2userauth style=display:none>")+addHtmlFormFloating("用戶名",'<input id=dp2user class="form-control" maxlength=64 autocomplete=off onkeyup=sshAuthUpdate(event) />')+"</div><div id=d2passauth style=display:none>")+addHtmlFormFloating("密碼",'<input type=password id=dp2pass class="form-control" maxlength=64 autocomplete=off onkeyup=sshAuthUpdate(event) />'),0==(4194304&features2)&&(o+=addHtmlValue("",'<label><input id=dp2keep type=checkbox class="form-check-input me-2">記住憑據</label>')),o=(o=(o+="</div><div id=d2keyauth style=display:none>")+addHtmlValue("密鑰文件",'<input type=file id=dp2key class="form-control" maxlength=64 autocomplete=off onchange=sshAuthUpdate(event) /><div id=d2badkey style=font-size:x-small>密鑰文件必須是 OpenSSH 格式。</div>'))+addHtmlFormFloating("密鑰密碼",'<input type=password id=dp2keypass class="form-control" maxlength=64 autocomplete=off onkeyup=sshAuthUpdate(event) />'),0==(4194304&features2)&&(o=(o+=addHtmlValue("",'<label><input id=dp2keep1 type=checkbox class="form-check-input me-2" onchange=sshAuthUpdate(event)>記住用戶和密鑰</label>'))+addHtmlValue("",'<label><input id=dp2keep2 type=checkbox class="form-check-input me-2">記住密碼</label>')),o+="</div>",setModalContent("xxAddAgent","驗證",o=e.askkeypass?(o+="<div id=d2keyauth2 style=display:none>")+addHtmlFormFloating("密碼",'<input type=password id=dp2keypass2 class="form-control" maxlength=64 autocomplete=off onkeyup=sshAuthUpdate(event) />')+"</div>":o);document.getElementById("xxAddAgentModal").addEventListener("hide.bs.modal",n),showModal("xxAddAgentModal","idx_dlgOkButton",()=>{document.getElementById("xxAddAgentModal").removeEventListener("hide.bs.modal",n),t(11,"ssh")}),Q("dp2user").focus(),sshAuthUpdate(),setTimeout(sshAuthUpdate,50)}function sshTunnelUpdate(e){if("string"==typeof e)if("{"==e[0]){var t=JSON.parse(e);switch(t.action){case"sshauth":sshTunnelAuthDialog(t,sshConnectEx);break;case"sshautoauth":terminal.socket.send(JSON.stringify({action:"sshautoauth",cols:xterm.cols,rows:xterm.rows,width:Q("termarea3xdiv").offsetWidth,height:Q("termarea3xdiv").offsetHeight}));break;case"connectionerror":p12setConsoleMsg("連接錯誤",5e3);break;case"autherror":p12setConsoleMsg("授權錯誤",5e3);break;case"sessionerror":p12setConsoleMsg("會話已過期",5e3);break;case"sessiontimeout":p12setConsoleMsg("會話超時",5e3)}}else"~"==e[0]&&(xterm.writeUtf8?xterm.writeUtf8(e.substring(1)):xterm.write(e.substring(1)))}function sshAuthUpdate(e){var t;QV("d2userauth",3!=Q("dp2authmethod").value),QV("d2passauth",1==Q("dp2authmethod").value),QV("d2keyauth",2==Q("dp2authmethod").value),QV("d2keyauth2",3==Q("dp2authmethod").value),1==Q("dp2authmethod").value?QE("idx_dlgOkButton",0<Q("dp2user").value.length&&0<Q("dp2pass").value.length):3==Q("dp2authmethod").value?QE("idx_dlgOkButton",0<Q("dp2keypass2").value.length):(QE("idx_dlgOkButton",!1),0==(4194304&features2)&&QE("dp2keep2",Q("dp2keep1").checked),1==(0<Q("dp2user").value.length&&null!=Q("dp2key").files&&1==Q("dp2key").files.length&&Q("dp2key").files[0].size<8e3)&&((t=new FileReader).onload=function(e){e=0<=e.target.result.indexOf("-----BEGIN OPENSSH PRIVATE KEY-----")&&0<=e.target.result.indexOf("-----END OPENSSH PRIVATE KEY-----")||0<=e.target.result.indexOf("-----BEGIN RSA PRIVATE KEY-----")&&0<=e.target.result.indexOf("-----END RSA PRIVATE KEY-----");QE("idx_dlgOkButton",e),QS("d2badkey").color=e?"#000":"#F00"},t.readAsText(Q("dp2key").files[0]))),e&&13==e.keyCode&&e.target&&1==Q("dp2authmethod").value&&("dp2user"==e.target.id&&Q("dp2pass").focus(),"dp2pass"==e.target.id)&&dialogclose(1)}function sshConnectEx(e){var t,n,o;0==e?null!=terminal&&connectTerminal():(t=0,1==Q("dp2authmethod").value?(0==(4194304&features2)&&(t=Q("dp2keep").checked?1:0),terminal.socket.send(JSON.stringify({action:"sshauth",username:Q("dp2user").value,password:Q("dp2pass").value,keep:t,cols:xterm.cols,rows:xterm.rows,width:Q("termarea3xdiv").offsetWidth,height:Q("termarea3xdiv").offsetHeight}))):3==Q("dp2authmethod").value?terminal.socket.send(JSON.stringify({action:"sshkeyauth",keypass:Q("dp2keypass2").value,cols:xterm.cols,rows:xterm.rows,width:Q("termarea3xdiv").offsetWidth,height:Q("termarea3xdiv").offsetHeight})):(0==(4194304&features2)&&1==(t=Q("dp2keep1").checked?1:0)&&(t+=Q("dp2keep2").checked?1:0),e=new FileReader,n=Q("dp2user").value,o=Q("dp2keypass").value,e.onload=function(e){terminal.socket.send(JSON.stringify({action:"sshauth",username:n,keypass:o,key:e.target.result,keep:t,cols:xterm.cols,rows:xterm.rows,width:Q("termarea3xdiv").offsetWidth,height:Q("termarea3xdiv").offsetHeight}))},e.readAsText(Q("dp2key").files[0])))}function xTermSendResize(){(xtermResizeTimer=null)!=xterm&&null!=terminal&&null!=terminal.sendCtrlMsg&&("sshterminalrelay.ashx"==terminal.urlname?terminal.socket.send(JSON.stringify({action:"resize",cols:xterm.cols,rows:xterm.rows,width:Q("termarea3xdiv").offsetWidth,height:Q("termarea3xdiv").offsetHeight})):terminal.sendCtrlMsg(JSON.stringify({ctrlChannel:"102938",type:"termsize",cols:xterm.cols,rows:xterm.rows})))}function connectTerminal(e,t,n){if(p12clearConsoleMsg(),terminal)"ssh"==xxdialogTag&&setDialogMode(0),terminal.Stop(),terminal=null,fullscreen&&deskToggleFull();else if(2==t){if(null==terminalNode.intelamt.user||""==terminalNode.intelamt.user)return void editDeviceAmtSettings(terminalNode._id,connectTerminal,2);var o={};1==Q("termSizeList").value?(o.cols=80,o.rows=25):2==Q("termSizeList").value&&(o.cols=100,o.rows=30),fullscreen&&deskToggleFull(),QV("termarea3xdiv",!1),QV("Term",!0),(terminal=CreateAmtRedirect(CreateAmtRemoteTerminal("Term",o),authCookie)).debugmode=debugmode,terminal.m.debugmode=debugmode,terminal.m.onTitleChange=function(e,t){QH("termtitle"," - "+EscapeHtml(t))},terminal.onStateChanged=onTerminalStateChange,terminal.Start(terminalNode._id,16994,"*","*",0),terminal.contype=2,Q("id_ttypebutton").value=terminalEmulations[terminal.m.terminalEmulation]}else{o={protocol:null!=n&&"number"==typeof n.protocol?n.protocol:1};n&&n.requireLogin&&(o.requireLogin=!0),n&&n.consent&&(o.consent=n.consent),-1==[1,2,3,4,21,22].indexOf(currentNode.agent.id)&&(1==Q("termSizeList").value?(o.cols=80,o.rows=25,o.xterm=!0):2==Q("termSizeList").value?(o.cols=100,o.rows=30,o.xterm=!0):3==Q("termSizeList").value&&(o.cols=Math.floor((Q("column_l").clientWidth-60)/10),o.rows=Math.floor((Q("column_l").clientHeight-120)/20),o.xterm=!0)),e&&1==e.shiftKey&&(4<currentNode.agent.id?1==o.protocol&&(o.protocol=7):1==o.protocol&&(o.protocol=6)),null!=serverinfo.linuxshell&&4<currentNode.agent.id&&("root"==serverinfo.linuxshell&&(o.protocol=1,delete o.requireLogin),"user"==serverinfo.linuxshell&&(o.protocol=8,delete o.requireLogin),"login"==serverinfo.linuxshell)&&(o.protocol=1,o.requireLogin=!0),0!==args.xterm?(QV("termarea3xdiv",!0),QV("Term",!1),null!=xterm&&xterm.dispose(),xtermfit=new FitAddon.FitAddon,xterm=new Terminal,xtermfit&&xterm.loadAddon(xtermfit),xterm.open(Q("termarea3xdiv")),xterm.onData(function(e){null!=terminal&&("sshterminalrelay.ashx"==terminal.urlname?terminal.socket.send("~"+e):terminal.sendText(e))}),xtermfit&&xtermfit.fit(),xterm.onTitleChange(function(e){QH("termtitle"," - "+EscapeHtml(e))}),xterm.onResize(function(e){xtermResizeTimer&&clearTimeout(xtermResizeTimer),xtermResizeTimer=setTimeout(xTermSendResize,200)}),o.cols=xterm.cols,o.rows=xterm.rows,terminal=CreateAgentRedirect(meshserver,CreateRemoteTunnel(3==t?sshTunnelUpdate:tunnelUpdate,o),serverPublicNamePort,authCookie,authRelayCookie,domainUrl),3==t&&(terminal.urlname="sshterminalrelay.ashx"),terminal.debugmode=debugmode,terminal.m.debugmode=debugmode,(terminal.options=o).requireLogin&&(terminal.options.requireLogin=!0),terminal.Start(terminalNode._id),terminal.onStateChanged=onTerminalStateChange,terminal.contype=t,terminal.attemptWebRTC=!1,terminal.onConsoleMessageChange=function(){p12setConsoleMsg(terminal.consoleMessage?formatAgentConsoleMessage(terminal.consoleMessage,terminal.consoleMessageId,terminal.consoleMessageArgs):null,terminal.consoleMessageTimeout)}):(QV("termarea3xdiv",!1),QV("Term",!0),(terminal=CreateAgentRedirect(meshserver,CreateAmtRemoteTerminal("Term",o),serverPublicNamePort,authCookie,authRelayCookie,domainUrl)).options=o,terminal.debugmode=debugmode,terminal.m.debugmode=debugmode,terminal.m.onTitleChange=function(e,t){QH("termtitle"," - "+EscapeHtml(t))},terminal.m.lineFeed=0<=[1,2,3,4,21,22].indexOf(currentNode.agent.id)?"\r\n":"\r",terminal.attemptWebRTC=!1,terminal.onStateChanged=onTerminalStateChange,terminal.onConsoleMessageChange=function(){p12setConsoleMsg(terminal.consoleMessage?formatAgentConsoleMessage(terminal.consoleMessage,terminal.consoleMessageId,terminal.consoleMessageArgs):null,terminal.consoleMessageTimeout)},terminal.Start(terminalNode._id),terminal.contype=t,terminal.m.terminalEmulation=0,terminal.m.fxEmulation=0,Q("id_ttypebutton").value=terminalEmulations[0])}Q("connectbutton2").blur()}var terminalEmulations=["UTF8終端","擴充式ASCII","Intel ASCII"];function termToggleType(){terminal&&!xxdialogMode&&(terminal.m.terminalEmulation=(terminal.m.terminalEmulation+1)%3,Q("id_ttypebutton").value=terminalEmulations[terminal.m.terminalEmulation],Q("id_ttypebutton").blur())}var filesNode,fxEmulations=["Intel（F10 = ESC + [OM）","備用（F10 = ESC + 0）","VT100 +（F10 = ESC + [OY）"];function termToggleFx(){terminal&&!xxdialogMode&&(terminal.m.fxEmulation=(terminal.m.fxEmulation+1)%3,Q("id_tfxkeysbutton").value=fxEmulations[terminal.m.fxEmulation],Q("id_tfxkeysbutton").blur())}function termToggleCr(){terminal&&!xxdialogMode&&("\n"==terminal.m.lineFeed?terminal.m.lineFeed="\r\n":terminal.m.lineFeed="\n",Q("id_tcrbutton").value="\r\n"==terminal.m.lineFeed?"CR+LF":"如果")}function termSendKey(e,t){terminal&&!xxdialogMode&&(null!=xterm?("sshterminalrelay.ashx"==terminal.urlname?terminal.socket.send("~"+String.fromCharCode(e)):terminal.sendText?terminal.sendText(String.fromCharCode(e)):terminal.send(String.fromCharCode(e)),xterm.focus()):null!=terminal&&(terminal.m.TermSendKey(e),Q(t).blur()))}function showTermPasteDialog(){terminal&&!xxdialogMode&&(Q("pastebutton").blur(),setModalContent("xxAddAgent","糊",'<textarea id=d2pasteText style="width:100%;height:184px;resize:none"></textarea>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>showTermPasteDialogEx()),Q("d2pasteText").focus())}function showTermPasteDialogEx(){terminal&&terminal.m.TermSendKeys(Q("d2pasteText").value)}function sendSpecialKey(){null!=xterm?("sshterminalrelay.ashx"==terminal.urlname?terminal.socket.send("~"+String.fromCharCode(Q("specialkeylist").value)):terminal.sendText(String.fromCharCode(Q("specialkeylist").value)),xterm.focus()):null!=terminal&&(terminal.m.TermSendKey(Q("specialkeylist").value),Q("specialkeylist").blur(),Q("specialkeylistinput").blur())}function setupFiles(){filesNode!=currentNode&&null!=files&&filesNode._id!=currentNode._id&&(files.Stop(),files=filesNode=null);var e=0!=(1&(filesNode=currentNode).conn)||3==filesNode.mtype;QE("p13Connect",e),QE("p13Connectdrop",e),QE("p13Connects",e),QE("p13Connectsdrop",e),QV("p13Connectspan",null==files&&2==filesNode.mtype),QV("p13Connectsspan",0!=(512&features2)&&null!=filesNode.agent&&3!=filesNode.agent.id&&4!=filesNode.agent.id&&0==(8388608&features2)),QV("p13Disconnect",null!=files),p13setActions()}function onFilesStateChange(e,t){setSessionActivity(),QV("p13Connectspan",0==t&&2==filesNode.mtype),QV("p13Connectsspan",0==t&&512&features2&&null!=filesNode.agent&&3!=filesNode.agent.id&&4!=filesNode.agent.id&&0==(8388608&features2)),QV("p13Disconnect",0!=t);var n=StatusStrs[t];switch(3==t&&(2==files.contype&&(n+=", SFTP"),1==files.webRtcActive)&&(n+="，WebRTC"),Q("p13Status").textContent=n,t){case 0:QH("p13files",""),p13filetree=null,p13filetreelocation=[],QH("p13currentpath",""),QE("p13FolderUp",!1),QV("filesRecordIcon",!1),p13setActions(),null!=files&&(files.Stop(),files=null),"fileMsgDialog"==xxdialogTag&&setDialogMode(0),null!=uploadFile&&(p13uploadFileTransferDone(),uploadFile=null);break;case 3:if(p13filetreelocation=[],p13targetpath="",files){var o=[];try{o=JSON.parse(getstore("_devFilePaths","[]"))}catch(e){}for(var i=0;i<o.length;i++)o[i].n==currentNode._id&&(p13targetpath=o[i].p);p13filetreelocation=p13targetpath.split("/"),files.sendText({action:"ls",reqid:1,path:p13targetpath}),1==files.serverIsRecording&&QV("filesRecordIcon",!0)}}}function CreateRemoteFiles(e){var t={protocol:5};return t.onFileUpdate=e,t.xxStateChange=function(e){},t.ProcessData=function(e){t.onFileUpdate(e)},t}var autoConnectFilesTimer=null;function autoConnectFiles(e){autoConnectFilesTimer=null==autoConnectFilesTimer?setInterval(connectFiles,100):(clearInterval(autoConnectFilesTimer),null)}function connectFiles(e,t,n){p13clearConsoleMsg(),files?(files.Stop(),files=null):(files=CreateAgentRedirect(meshserver,CreateRemoteFiles(p13gotFiles),serverPublicNamePort,authCookie,authRelayCookie,domainUrl),2==t&&(files.urlname="sshfilesrelay.ashx"),files.contype=t,files.options={consent:n},files.attemptWebRTC=attemptWebRTC,files.webrtcconfig=webrtcconfiguration,files.onStateChanged=onFilesStateChange,files.onConsoleMessageChange=function(){files.consoleMessage?(Q("p13FilesConsoleMsg").innerHTML+=formatAgentConsoleMessage(files.consoleMessage,files.consoleMessageId,files.consoleMessageArgs),QV("p13FilesConsoleMsg",!0),null!=p13FilesConsoleMsgTimer&&clearTimeout(p13FilesConsoleMsgTimer),files.consoleMessageTimeout&&(p13FilesConsoleMsgTimer=setTimeout(p13clearConsoleMsg,1e3*files.consoleMessageTimeout))):p13clearConsoleMsg()},files.Start(filesNode._id)),p13clipboard=p13clipboardFolder=null,p13clipboardCut=0,p13updateClipview()}var p13sortorder,p13filetree=null,p13targetpath=null,p13filetreelocation=[];function p13fileOperationDialogEx(e){0==e&&null!=files&&files.sendText({action:"cancel"})}function p13gotFiles(t){if(0<t.length&&123!=t.charCodeAt(0))p13gotDownloadBinaryData(t);else{try{t=JSON.parse(decode_utf8(t))}catch(e){try{t=JSON.parse(t)}catch(e){return void console.log("Unable to parse: "+t)}}if("download"==t.action)p13gotDownloadCommand(t);else if("findfile"==t.action)xxdialogTag==t.reqid&&(null==t.r?(QE("d2findFilter",!0),QE("filefind_dlgOkButton",!0),xxdialogTag=null,""==Q("d2findResults").innerHTML&&QH("d2findResults","<div style=text-align:center;margin:10px><i>找不到文件</i></div>")):QA("d2findResults","<div style=white-space:nowrap>"+EscapeHtml(t.r)+"</div>"));else if(null!=t.action&&t.action.startsWith("upload"))p13gotUploadData(t);else{switch(t.action){case"sshauth":return void sshTunnelAuthDialog(t,p13sshConnectEx);case"autherror":return void p13setConsoleMsg("授權錯誤",5e3);case"connectionerror":return void p13setConsoleMsg("連接錯誤",5e3);case"sessionerror":return void p13setConsoleMsg("會話已過期",5e3);case"sessiontimeout":return void p13setConsoleMsg("會話超時",5e3)}if("dialogmessage"==t.action)null==t.msg&&"fileMsgDialog"==xxdialogTag?setDialogMode(0):"zipping"!=t.msg||xxdialogMode&&"fileMsgDialog"!=xxdialogTag?"unzipping"!=t.msg||xxdialogMode&&"fileMsgDialog"!=xxdialogTag?"unziperror"!=t.msg||xxdialogMode&&"fileMsgDialog"!=xxdialogTag?"zippingFile"!=t.msg||xxdialogMode&&"fileMsgDialog"!=xxdialogTag||(setModalContent("xxAddAgent","檔案操作","<div style=margin:10px>"+EscapeHtml(t.file)+"</div><br /><progress value="+EscapeHtml(t.progress)+" style=width:100% max=100 />"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13fileOperationDialogEx(10))):(setModalContent("xxAddAgent","檔案操作","<div style=margin:10px>Unzipping Error</div><br />"+EscapeHtml(t.error)),showModal("xxAddAgentModal","idx_dlgOkButton")):(setModalContent("xxAddAgent","檔案操作","<div style=margin:10px>Unzipping file...</div>"),showModal("xxAddAgentModal","idx_dlgOkButton")):(setModalContent("xxAddAgent","檔案操作","<div style=margin:10px>壓縮檔案...</div>"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13fileOperationDialogEx(10)));else if("refresh"==t.action)p13folderup(9999);else if(null!=t.path)if(null==t.dir)""!=p13targetpath&&p13folderup();else if(t.path=t.path.replace(/\//g,"\\"),null!=p13filetree&&t.path==p13filetree.path){var e=p13getCheckedNames();p13filetree=t,p13updateFiles(e)}else{for(var n=t.path.replace(/\//g,"\\"),o=p13targetpath.replace(/\//g,"\\");0<n.length&&"\\"==n[0];)n=n.substring(1);for(;0<o.length&&"\\"==o[0];)o=o.substring(1);(n==o||"\\"==t.path&&""==p13targetpath)&&(p13filetree=t,p13updateFiles())}}}}function p13sshConnectEx(e){var t,n,o;0==e?null!=files&&connectFiles():(t=0,1==Q("dp2authmethod").value?(0==(4194304&features2)&&(t=Q("dp2keep").checked?1:0),files.socket.send(JSON.stringify({action:"sshauth",username:Q("dp2user").value,password:Q("dp2pass").value,keep:t}))):3==Q("dp2authmethod").value?files.socket.send(JSON.stringify({action:"sshkeyauth",keypass:Q("dp2keypass2").value})):(0==(4194304&features2)&&1==(t=Q("dp2keep1").checked?1:0)&&(t+=Q("dp2keep2").checked?1:0),e=new FileReader,n=Q("dp2user").value,o=Q("dp2keypass").value,e.onload=function(e){files.socket.send(JSON.stringify({action:"sshauth",username:n,keypass:o,key:e.target.result,keep:t}))},e.readAsText(Q("dp2key").files[0])))}function p13getCheckedNames(){for(var e=[],t=document.getElementsByName("fd"),n=0;n<t.length;n++)t[n].checked&&e.push(p13filetree.dir[t[n].value].n);return e}function p13updateFiles(e){var t="",n="",o='<a href=# style=cursor:pointer onclick="return p13folderup(0)">根</a>';if(null!=p13filetree){var i=p13filetree.path.split("\\");for(h in p13filetreelocation=[],i)""!=i[h]&&p13filetreelocation.push(i[h]);for(h in p13filetreelocation)o+=' / <a href=# style=cursor:pointer onclick="return p13folderup('+(parseInt(h)+1)+')">'+EscapeHtml(p13filetreelocation[h])+"</a>";var s=p13filetreelocation.join("/"),a=p13sort_files(p13filetree.dir);for(h in a){var l=a[h],r=l.n,d=70<r.length?'<span title="'+EscapeHtml(r)+'">'+EscapeHtml(r.substring(0,70))+"...</span>":EscapeHtml(r),c="",u=(null!=l.d&&(u=new Date(l.d),c=printDateTime(u="number"==typeof l.d?new Date(1e3*l.d):u)+"&nbsp;"),"");if(null!=l.s){var p=["Bytes","KB","MB","GB","TB"];let e=parseInt(Math.floor(Math.log(Math.abs(l.s))/Math.log(1024)),10);var m=Q("p13sizedropdown").options[Q("p13sizedropdown").selectedIndex],u=0==Q("p13sizedropdown").value?0===l.s?"n/a":0===e?l.s+" "+p[e]:(l.s/1024**e).toFixed(2)+" "+p[e]:1==Q("p13sizedropdown").value?getFileSizeStr(l.s):(l.s/2**m.value).toFixed(2)+" "+m.title}p="";l.t<3?(p="<div class=filelist file=999>",p=(p+='<input file=999 style=float:left name=fd class=fcb type=checkbox class="form-check-input me-2" onchange=p13setActions() value=\''+l.nx+'\'>&nbsp;<span style=float:right title=""></span>')+"<span><div class=fileIcon"+("REMOVABLE"==l.dt?5:"CDROM"==l.dt?6:l.t)+' onclick=p13folderset("'+encodeURIComponentEx(l.nx)+'")></div><a href=# style=cursor:pointer onclick=\'return p13folderset("'+encodeURIComponentEx(l.nx)+"\")'>",isWindowsNode(currentNode)&&l.dt&&currentNode.volumes&&currentNode.volumes[d.charAt(0).toUpperCase()]&&currentNode.volumes[d.charAt(0).toUpperCase()].name?p+=currentNode.volumes[d.charAt(0).toUpperCase()].name+" ("+d+")":p+=d,p+="</a></span></div>"):(m=d,0<l.s&&(m=3==filesNode.mtype?"<a href=# style=cursor:pointer onclick=\"return p13downloadfile('"+encodeURIComponentEx(s+"/"+r)+"','"+encodeURIComponentEx(r)+"',"+l.s+')">'+d+"</a>":'<a onclick=downloadFile("devicefile.ashx?c='+authCookie+"&m="+currentNode.meshid.split("/")[2]+"&n="+currentNode._id.split("/")[2]+"&f="+encodeURIComponentEx(s+"/"+r)+'","'+encodeURIComponentEx(r)+'") style=cursor:pointer>'+d+"</a>"),p="<div id=fileEntry cmenu=filesContextMenu fileIndex="+h+' class=filelist file=3><input file=3 style=float:left name=fd class=fcb type=checkbox class="form-check-input me-2" onchange=p13setActions() value=\''+l.nx+"'>&nbsp;<span class=fsize>"+c+"</span><span style=float:right>"+EscapeHtml(u)+"</span><span><div class=fileIcon"+l.t+"></div>"+m+"</span></div>"),l.t<3?t+=p:n+=p}if(QH("p13files",t+n),QH("p13currentpath",o),QE("p13FolderUp",0!=p13filetreelocation.length),null!=e)for(var g=document.getElementsByName("fd"),h=0;h<g.length;h++)0<=e.indexOf(p13filetree.dir[g[h].value].n)&&(g[h].checked=!0);p13setActions()}}function p13openfilefolder(){setModalContent("xxAddAgent","Open File/Folder","Are you sure you want to open this file/folder on the remote devices desktop ?"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13openfilefolderEx())}function p13openfilefolderEx(){for(var e="",t=document.getElementsByName("fd"),n=0;n<t.length;n++)t[n].checked&&(e=(isWindowsNode(currentNode)?"":"/")+p13filetreelocation.join(isWindowsNode(currentNode)?"\\":"/")+(isWindowsNode(currentNode)?"\\":"/")+p13filetree.dir[t[n].value].n);""!=e&&files.sendText({action:"open",reqid:1,path:e,dir:1==p13getFileSelDirCount()})}function p13gotofolder(){xxdialogButtons=3,setModalContent("xxAddAgent","Go To Folder",'<input type=text id=p13folderinput style=width:100% placeholder="'+(isWindowsNode(currentNode)?"C:\\":"/var/www")+'" />'),showModal("xxAddAgentModal","idx_dlgOkButton",p13gotofolderEx),focusTextBox("p13folderinput")}function p13gotofolderEx(){p13targetpath=Q("p13folderinput").value.split("\\").join("/"),files&&(p13storeCurrentPath(p13targetpath),files.sendText({action:"ls",reqid:1,path:p13targetpath}))}function p13folderset(e){p13targetpath=joinPaths(p13filetree.path,p13filetree.dir[e].n).split("\\").join("/"),files&&(p13storeCurrentPath(p13targetpath),files.sendText({action:"ls",reqid:1,path:p13targetpath}))}function p13folderup(e){if(null==e)p13filetreelocation.pop();else for(;p13filetreelocation.length>e;)p13filetreelocation.pop();return p13targetpath=p13filetreelocation.join("/"),files&&(p13storeCurrentPath(p13targetpath),files.sendText({action:"ls",reqid:1,path:p13targetpath})),!1}function p13storeCurrentPath(e){var t=[],n=-1;try{t=JSON.parse(getstore("_devFilePaths","[]"))}catch(e){}for(var o=0;o<t.length;o++)t[o].n==currentNode._id&&(n=o);for(0<=n&&t.splice(n,1),t.push({n:currentNode._id,p:e});40<t.length;)t.shift();putstore("_devFilePaths",JSON.stringify(t))}function p13findfile(){var e;xxdialogMode||(e=addHtmlFormFloating("過濾",'<input id=d2findFilter class="form-control" onkeyup=p13findfileValidate() onkeydown=p13findfileDown(event) placeholder="*.txt"></input>'),setModalContent("xxAddAgent","查找文件",e=(e+='<div id=d2findResults style="width:100%;height:184px;background-color:white;border:1px solid black;padding:3px;overflow:scroll;margin-top:8px"></div>')+"<div style=margin-top:8px><input id=filefind_dlgCancelButton type=button value=關 style=float:right;width:80px;margin-left:5px onclick=p13findfileCancel()>"+"<input id=filefind_dlgOkButton type=submit value=搜尋 style=float:right;width:80px onclick=p13findfileEx()><br /><br /></div>"),showModal("xxAddAgentModal","idx_dlgOkButton"),p13findfileValidate(),Q("d2findFilter").focus())}function p13findfileDown(e){"輸入"==e.code&&p13findfileEx()}function p13findfileValidate(){QE("filefind_dlgOkButton",0<Q("d2findFilter").value.length)}function p13findfileCancel(){null!=xxdialogTag&&files.sendText({action:"cancelfindfile",reqid:xxdialogTag}),dialogclose(0)}function p13findfileEx(e,t){var n,o,i;0!=Q("d2findFilter").value.length&&(n=0<currentNode.agent.id&&currentNode.agent.id<5||14==currentNode.agent.id||34==currentNode.agent.id,i=p13filetreelocation.join(o=n?"\\":"/")+o,n||(i=o+i),xxdialogTag="find:"+Math.random(),files.sendText({action:"findfile",reqid:xxdialogTag,path:i,filter:Q("d2findFilter").value}),QH("d2findResults",""),QE("d2findFilter",!1),QE("filefind_dlgOkButton",!1))}function p13sort_filename(e,t){return e.ln>t.ln?+p13sortorder:e.ln<t.ln?-1*p13sortorder:0}function p13sort_timestamp(e,t){return e.d>t.d?+p13sortorder:e.d<t.d?-1*p13sortorder:0}function p13sort_bysize(e,t){return e.s==t.s?p13sort_filename(e,t):(e.s-t.s)*p13sortorder}function p13sort_files(e){var t,n=[],o=Q("p13sortdropdown").value;for(t in e)e[t].nx=t,null==e[t].s&&(e[t].s=0),null==e[t].n&&(e[t].n=t),e[t].ln=e[t].n.toLowerCase(),n.push(e[t]);return p13sortorder=1,3<o&&(p13sortorder=-1,o-=3),1==o?n.sort(p13sort_filename):2==o?n.sort(p13sort_bysize):3==o&&n.sort(p13sort_timestamp),n}function p13setActions(){var e,t,n,o,i=null!=currentNode.agent&&14!=currentNode.agent.id;null==p13filetree?(QE("p13DeleteFileButton",!1),QE("p13NewFolderButton",!1),QE("p13UploadButton",!1),QE("p13RenameFileButton",!1),QE("p13ViewFileButton",!1),QE("p13SelectAllButton",!1),Q("p13SelectAllButton").value="全選",QE("p13RefreshButton",!1),QE("p13FindButton",!1),QE("p13CutButton",!1),QE("p13CopyButton",!1),QE("p13ZipButton",!1),QE("p13UnZipButton",!1),QE("p13PasteButton",!1),QE("p13GoToFolderButton",!1),QE("p13DownloadButton",!1),QE("p13OpenButton",!1)):(e=p13getFileSelCount(),t=p13getFileCount(),n=p13getFileSelCount(!1),o=0<currentNode.agent.id&&currentNode.agent.id<5||14==currentNode.agent.id||34==currentNode.agent.id,QE("p13DeleteFileButton",0<e&&(0<p13filetreelocation.length||0==o)),QE("p13NewFolderButton",i&&(0<p13filetreelocation.length||0==o)),QE("p13UploadButton",0<p13filetreelocation.length||0==o||14==currentNode.agent.id),QE("p13RenameFileButton",i&&1==e&&(0<p13filetreelocation.length||0==o)),QE("p13ViewFileButton",i&&1==e&&1==n&&(0<p13filetreelocation.length||0==o)),QE("p13SelectAllButton",0<t),Q("p13SelectAllButton").value=0<e?"選擇無":"全選",QE("p13RefreshButton",!0),QE("p13FindButton",i&&(0<p13filetreelocation.length||0==o)),QE("p13CutButton",i&&0<e&&e==n&&(0<p13filetreelocation.length||0==o)),QE("p13CopyButton",i&&0<e&&e==n&&(0<p13filetreelocation.length||0==o)),QE("p13ZipButton",i&&0<e&&(0<p13filetreelocation.length||0==o)),QE("p13UnzipButton",i&&1==e&&1==n&&(0<p13filetreelocation.length||0==o)&&p13getFileSelAllowedExt(".zip")),QE("p13PasteButton",i&&(0<p13filetreelocation.length||0==o)&&null!=p13clipboard&&0<p13clipboard.length),QE("p13GoToFolderButton",i),QE("p13OpenButton",i&&1==e),QE("p13DownloadButton",0<e&&e==n&&(0<p13filetreelocation.length||0==o))),1==(null!=files&&0!=files.state)&&2!=files.contype||null==filesNode.agent||3==filesNode.agent.id||4==filesNode.agent.id?QH("filesCustomUpperRight",""):QH("filesCustomUpperRight","<a style=cursor:pointer onclick=cmsshportaction(1,event)>"+format("SSH 端口 {0}",filesNode.sshport||22)+"</a>"),QV("filesActionsBtn",3!=filesNode.mtype),QV("p13FindButton",3!=filesNode.mtype),QV("p13CutButton",3!=filesNode.mtype),QV("p13CopyButton",3!=filesNode.mtype),QV("p13ZipButton",3!=filesNode.mtype),QV("p13UnzipButton",3!=filesNode.mtype),QV("p13PasteButton",3!=filesNode.mtype)}function p13getFileSelCount(e){for(var t=0,n=document.getElementsByName("fd"),o=0;o<n.length;o++)!n[o].checked||0==e&&"3"!=n[o].attributes.file.value||t++;return t}function p13getFileSelDirCount(){for(var e=0,t=document.getElementsByName("fd"),n=0;n<t.length;n++)t[n].checked&&"999"==t[n].attributes.file.value&&e++;return e}function p13getFileCount(){return document.getElementsByName("fd").length}function p13getFileSelAllowedExt(e){for(var t=document.getElementsByName("fd"),n=0;n<t.length;n++)if(t[n].checked&&!p13filetree.dir[t[n].value].n.endsWith(e))return!1;return!0}function p13selectallfile(){for(var e=0==p13getFileSelCount(),t=document.getElementsByName("fd"),n=0;n<t.length;n++)t[n].checked=e;p13setActions()}function p13createfolder(){setModalContent("xxAddAgent","新建檔案夾","<input type=text id=p13renameinput maxlength=64 onkeyup=p13fileNameCheck(event) style=width:100% />"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13createfolderEx()),focusTextBox("p13renameinput"),p13fileNameCheck()}function p13createfolderEx(){files.sendText({action:"mkdir",reqid:1,path:p13filetreelocation.join("/")+"/"+Q("p13renameinput").value}),p13folderup(999)}function p13deletefile(){var e=p13getFileSelCount(),t=0<p13getFileSelDirCount()?'<br /><br /><label><input type=checkbox class="form-check-input me-2" id=p13recdeleteinput>遞迴刪除</label><br>':"<input type=checkbox class=\"form-check-input me-2\" id=p13recdeleteinput style='display:none'>";setModalContent("xxAddAgent","刪除",1<e?format("刪除{0}個所選項目？",e)+t:"刪除所選項目？"+t),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13deletefileEx())}function p13deletefileEx(){for(var e=[],t=document.getElementsByName("fd"),n=0;n<t.length;n++)t[n].checked&&e.push(p13filetree.dir[t[n].value].n);files.sendText({action:"rm",reqid:1,path:p13filetreelocation.join("/"),delfiles:e,rec:Q("p13recdeleteinput").checked}),p13folderup(999)}function p13renamefile(){for(var e,t=document.getElementsByName("fd"),n=0;n<t.length;n++)t[n].checked&&(e=p13filetree.dir[t[n].value].n);setModalContent("xxAddAgent","改名",'<input type=text id=p13renameinput maxlength=64 onkeyup=p13fileNameCheck(event) style=width:100% value="'+e+'" />'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13renamefileEx(3,{oldname:e})),focusTextBox("p13renameinput"),p13fileNameCheck()}function p13renamefileEx(e,t){t.newname=Q("p13renameinput").value,files.sendText(t),p13folderup(999)}function p13fileNameCheck(e){var t=isFilenameValid(Q("p13renameinput").value);QE("idx_dlgOkButton",t),1==t&&null!=e&&13==e.keyCode&&dialogclose(1)}function p13uploadFile(){setModalContent("xxAddAgent","上載檔案",'<input type=file name=files id=p13uploadinput class="form-control" multiple=multiple onchange="updateUploadDialogOk(\'p13uploadinput\')" />'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13uploadFileEx()),updateUploadDialogOk("p13uploadinput")}function updateUploadDialogOk(e){QE("idx_dlgOkButton",0<Q("p13uploadinput").files.length)}function p13uploadFileEx(){return p13doUploadFiles(Q("p13uploadinput").files),!1}function p13viewfile(){for(var e=document.getElementsByName("fd"),t=0;t<e.length;t++)if(e[t].checked){p13filetree.dir[e[t].value].s<=204800?p13downloadfile(encodeURIComponentEx(p13filetreelocation.join("/")+"/"+p13filetree.dir[e[t].value].n),encodeURIComponentEx(p13filetree.dir[e[t].value].n),p13filetree.dir[e[t].value].s,"viewer"):messagebox("檔案編輯器","只能編輯小於200k的檔案。");break}}function p13unzipFile(){for(var e,t,n,o=document.getElementsByName("fd"),i=0;i<o.length;i++)o[i].checked&&(e=isWindowsNode(currentNode)?"\\":"/",t=(isWindowsNode(currentNode)?"":"/")+p13filetreelocation.join(e)+e+p13filetree.dir[o[i].value].n.split(".zip")[0]+e,n=(isWindowsNode(currentNode)?"":"/")+p13filetreelocation.join(e)+e+p13filetree.dir[o[i].value].n);setModalContent("xxAddAgent","Unzip To Folder",'<input type=text id=p13unzipfolderinput maxlength=64 style=width:100% value="'+t+'" />'),showModal("xxAddAgentModal","idx_dlgOkButton",p13unzipFileEx(3,{action:"unzip",input:n})),focusTextBox("p13unzipfolderinput")}function p13unzipFileEx(e,t){t.dest=Q("p13unzipfolderinput").value,files.sendText(t)}function p13zipFiles(){for(var e=[],t=document.getElementsByName("fd"),n=0;n<t.length;n++)t[n].checked&&e.push(p13filetree.dir[t[n].value].n);setModalContent("xxAddAgent","郵編檔案名",'<input type=text id=p13renameinput maxlength=64 onkeyup=p13fileNameCheck(event) style=width:100% value="" />'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13zipFilesEx(3,{action:"zip",path:p13filetreelocation.join("/"),files:e})),focusTextBox("p13renameinput"),p13fileNameCheck()}function p13zipFilesEx(e,t){t.output=Q("p13renameinput").value,t.output.toLowerCase().endsWith(".zip")||(t.output+=".zip"),files.sendText(t)}var p13clipboard=null,p13clipboardFolder=null,p13clipboardCut=0;function p13copyFile(e){var t=document.getElementsByName("fd");p13clipboard=[],p13clipboardCut=e,p13clipboardFolder=p13targetpath;for(var n=0;n<t.length;n++)t[n].checked&&"3"==t[n].attributes.file.value&&p13clipboard.push(p13filetree.dir[t[n].value].n);p13updateClipview()}function p13pasteFile(){var e="";setModalContent("xxAddAgent","糊",e=null!=p13clipboard&&0<p13clipboard.length?0==p13clipboardCut?1<p13clipboard.length?format("確認{0}個條目的複製到此位置？",p13clipboard.length):format("確認將1個副本複製到此位置？"):1<p13clipboard.length?format("確認將{0}個條目移到該位置？",p13clipboard.length):format("確認將1個條目移動到此位置？"):e),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13pasteFileEx())}function p13pasteFileEx(){files.sendText({action:0==p13clipboardCut?"copy":"move",reqid:1,scpath:p13clipboardFolder,dspath:p13targetpath,names:p13clipboard}),p13folderup(999),1==p13clipboardCut&&(p13clipboardFolder=p13clipboard=null,p13clipboardCut=0,p13updateClipview())}function p13updateClipview(){var e="";null!=p13clipboard&&0<p13clipboard.length&&(e=0==p13clipboardCut?1<p13clipboard.length?format('保留{0}個項目進行複製, <a href=# onclick="return p13clearClip()" style=cursor:pointer>清除</a>.',p13clipboard.length):format('保存1個項目進行複製, <a href=# onclick="return p13clearClip()" style=cursor:pointer>清除</a>.'):1<p13clipboard.length?format('保存{0}個項目以進行移動, <a href=# onclick="return p13clearClip()" style=cursor:pointer>清除</a>.',p13clipboard.length):format('保存1個項目進行移動, <a href=# onclick="return p13clearClip()" style=cursor:pointer>清除</a>.')),QH("p13bottomstatus",e),p13setActions()}function p13clearClip(){return p13clipboardFolder=p13clipboard=null,p13clipboardCut=0,p13updateClipview(),!1}function p13fileDragDrop(e){if(haltEvent(e),QV("p13bigfail",!1),QV("p13bigok",!1),null!=e.dataTransfer&&0!=e.dataTransfer.files.length&&null!=p13filetree){var t,n=[];for(t in e.dataTransfer.files)null!=e.dataTransfer.files[t].size&&0!=e.dataTransfer.files[t].size&&n.push(e.dataTransfer.files[t]);0!=n.length&&p13doUploadFiles(n)}}var gdownloadFile,p13dragtimer=null;function p13fileDragOver(e){haltEvent(e),null!=p13dragtimer&&(clearTimeout(p13dragtimer),p13dragtimer=null);e=null!=p13filetree;QV("p13bigok",e),QV("p13bigfail",!e)}function p13fileDragLeave(e){haltEvent(e),"p13filetable"!=e.target.id?(QV("p13bigfail",!1),QV("p13bigok",!1)):p13dragtimer=setTimeout(function(){QV("p13bigfail",!1),QV("p13bigok",!1),p13dragtimer=null},10)}function p13downloadfile(e,t,n,o){!xxdialogMode&&files&&(gdownloadFile={path:decodeURIComponent(e),file:decodeURIComponent(t),size:n,tsize:0,data:"",state:0,id:Math.random(),tag:o},files.sendText({action:"download",sub:"start",id:gdownloadFile.id,path:gdownloadFile.path}),setModalContent("xxAddAgent","下載檔案","<div>"+gdownloadFile.file+"</div><br /><progress id=d2progressBar style=width:100% value=0 max="+n+" />"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13downloadFileCancel()))}function p13downloadFileCancel(){setDialogMode(0),files.sendText({action:"download",sub:"cancel",id:gdownloadFile.id}),gdownloadFile=null}function p13gotDownloadCommand(e){null!=gdownloadFile&&e.id==gdownloadFile.id&&("start"==e.sub?(gdownloadFile.state=1,files.sendText({action:"download",sub:"startack",id:gdownloadFile.id})):"cancel"==e.sub&&(gdownloadFile=null,setDialogMode(0)))}function p13gotDownloadBinaryData(e){var t;gdownloadFile&&0!=gdownloadFile.state&&(4<e.length&&(gdownloadFile.tsize+=e.length-4,gdownloadFile.data+=e.substring(4),Q("d2progressBar").value=gdownloadFile.tsize),0!=(1&ReadInt(e,0))?"viewer"==gdownloadFile.tag?(setModalContent("xxAddAgent",EscapeHtml(gdownloadFile.file),4,"extra-large"),t=gdownloadFile.file,showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13editSaveBack(3,t)),QV("d4EncodingButton",!0),QV("d4LineBreakButton",!0),Q("d4editorarea").value=1==d4EditEncodingVal?decode_utf8(gdownloadFile.data):gdownloadFile.data,gdownloadFile=null):(saveAs(data2blob(gdownloadFile.data),gdownloadFile.file),gdownloadFile=null,setDialogMode(0)):files.sendText({action:"download",sub:"ack",id:gdownloadFile.id}))}function p13downloadButton(){for(var e,t,n=document.getElementsByName("fd"),o=0;o<n.length;o++)n[o].checked&&(e=p13filetree.dir[n[o].value],t="devicefile.ashx?c="+authCookie,downloadFile(t=(t=(t+="&m="+currentNode.meshid.split("/")[2])+("&n="+currentNode._id.split("/")[2]))+("&f="+encodeURIComponentEx(p13filetreelocation.join("/")+"/"+e.n)),encodeURIComponentEx(e.n)))}var uploadFile,d4EditWrapVal=0,d4EditSizeVal=0,d4EditEncodingVal=0,d4EditLineBreakVal=0;function d4ToggleWrap(e){e||(d4EditWrapVal=++d4EditWrapVal%2),Q("d4WrapButton").value=["换行：開","换行：關"][d4EditWrapVal],QS("d4editorarea").overflow=0==d4EditWrapVal?"auto":"scroll",QS("d4editorarea")["white-space"]=0==d4EditWrapVal?null:"pre",putstore("editorWrap",d4EditWrapVal)}function d4ToggleSize(e){e||(d4EditSizeVal=++d4EditSizeVal%4),QS("d4editorarea")["font-size"]=["100%","125%","150%","200%"][d4EditSizeVal],Q("d4SizeButton").value=["縮放：100％","縮放：125％","縮放：150％","縮放：200％"][d4EditSizeVal],putstore("editorSize",d4EditSizeVal)}function d4ToggleEncoding(e){e||(d4EditEncodingVal=++d4EditEncodingVal%2,Q("d4editorarea").value=(1==d4EditEncodingVal?decode_utf8:encode_utf8)(Q("d4editorarea").value)),Q("d4EncodingButton").value=["編碼：RAW","編碼：UTF8"][d4EditEncodingVal],putstore("editorEncoding",d4EditEncodingVal)}function d4ToggleLineBreak(e){e||(d4EditLineBreakVal=++d4EditLineBreakVal%3),Q("d4LineBreakButton").value=["Line Break: Windows (CR LF)","Line Break: Linux (LF)","Line Break: Mac (CR)"][d4EditLineBreakVal],putstore("editorLineBreak",d4EditLineBreakVal)}function p13editSaveBack(e,t){var n=Q("d4editorarea").value,n=0===d4EditLineBreakVal?n.replace(/\r?\n|\r/g,"\r\n"):2===d4EditLineBreakVal?n.replace(/\r\n|\n/g,"\r"):n.replace(/\r\n|\r/g,"\n"),n=1==d4EditEncodingVal?(new TextEncoder).encode(n):(new TextEncoder).encode(decode_utf8(n));p13uploadFileContinue(1,[{name:t,size:n.byteLength,type:"text/plain",xdata:n}])}function p13doUploadFiles(e){if(!xxdialogMode){var t=0<currentNode.agent.id&&currentNode.agent.id<5||14==currentNode.agent.id||34==currentNode.agent.id,n=[],o=0;for(i in p13filetree.dir)n.push(t?p13filetree.dir[i].n.toLowerCase():p13filetree.dir[i].n);for(var i=0;i<e.length;i++)t?0<=n.indexOf(e[i].name.toLowerCase())&&o++:0<=n.indexOf(e[i].name)&&o++;0==o?p13uploadFileContinue(1,e):(setModalContent("xxAddAgent","上載檔案",format(1==o?"上傳將覆蓋1個檔案。繼續？":"上傳將覆蓋{0}個檔案。繼續？",o)),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13uploadFileContinue(3,e)))}}function p13uploadFileContinue(e,t){if((uploadFile={}).xpath=p13filetreelocation.join("/"),uploadFile.xfiles=t,uploadFile.xfilePtr=-1,setModalContent("xxAddAgent","上載檔案","<div id=p13dfileName>正在連線...</div><br /><progress id=d2progressBar style=width:100% value=0 max=0 />"),showModal("xxAddAgentModal","idx_dlgCancelButton",()=>p13uploadFileCancel(10)),document.getElementById("idx_dlgOkButton").style.display="none",p13uploadNextFile(),3==e)return!1}let byteToHex=[];for(var n=0;n<=255;++n){var hexOctet=n.toString(16).padStart(2,"0");byteToHex.push(hexOctet)}function arrayBufferToHex(e){return Array.prototype.map.call(new Uint8Array(e),e=>byteToHex[e]).join("")}function performHash(e,t){window.crypto.subtle.digest("SHA-384",e).then(function(e){t(arrayBufferToHex(e))},function(){t(null)})}function performHashOnFile(e,t){var n=new FileReader;n.onerror=function(e){t(null)},n.onload=function(){window.crypto.subtle.digest("SHA-384",n.result).then(function(e){t(arrayBufferToHex(e))},function(){t(null)})},n.readAsArrayBuffer(e)}function p13uploadNextFile(){if(uploadFile.xfilePtr++,uploadFile.xfiles.length>uploadFile.xfilePtr){uploadFile.xptr=0;var t=uploadFile.xfiles[uploadFile.xfilePtr];if(QH("p13dfileName",EscapeHtml(t.name)),Q("d2progressBar").max=t.size,Q("d2progressBar").value=0,null==t.xdata){uploadFile.xfile=t;var e,n=null;for(e in p13filetree.dir)p13filetree.dir[e].n==t.name&&(n=p13filetree.dir[e]);null!=n&&n.s<=uploadFile.xfile.size?performHashOnFile(uploadFile.xfile,function(e){files.sendText(JSON.stringify({action:"uploadhash",reqid:uploadFile.xfilePtr,path:uploadFile.xpath,name:t.name,tag:{h:e.toUpperCase(),s:n.s,skip:n.s==uploadFile.xfile.size}}))}):files.sendText(JSON.stringify({action:"upload",reqid:uploadFile.xfilePtr,path:uploadFile.xpath,name:t.name,size:uploadFile.xfile.size}))}else uploadFile.xdata=t.xdata,files.sendText(JSON.stringify({action:"upload",reqid:uploadFile.xfilePtr,path:uploadFile.xpath,name:t.name,size:uploadFile.xdata.byteLength}))}else p13uploadFileTransferDone()}function p13uploadFileCancel(e,t){null!=uploadFile&&(files.sendText(JSON.stringify({action:"uploadcancel",reqid:uploadFile.xfilePtr})),uploadFile=null),p13uploadFileTransferDone()}function p13uploadFileTransferDone(){uploadFile=null,setDialogMode(0),p13folderup(9999)}function p13gotUploadData(e){if(null!=uploadFile&&parseInt(uploadFile.xfilePtr)==parseInt(e.reqid))switch(e.action){case"uploadstart":p13uploadNextPart(!(uploadFile.xdataPriming=8));break;case"uploadack":p13uploadNextPart(!1);break;case"uploaddone":(uploadFile.xfiles.length>uploadFile.xfilePtr+1?p13uploadNextFile:p13uploadFileTransferDone)();break;case"uploaderror":p13uploadFileCancel();break;case"uploadhash":var t=uploadFile.xfiles[uploadFile.xfilePtr];t&&(e.tag.h===e.hash?e.tag.skip?p13uploadNextFile():(uploadFile.xptr=e.tag.s,files.sendText(JSON.stringify({action:"upload",reqid:uploadFile.xfilePtr,path:uploadFile.xpath,name:t.name,size:uploadFile.xfile.size,append:!0}))):files.sendText(JSON.stringify({action:"upload",reqid:uploadFile.xfilePtr,path:uploadFile.xpath,name:t.name,size:uploadFile.xfile.size,append:!1})))}}function p13uploadNextPart(e){if(uploadFile.xdata){var t=uploadFile.xdata,n=uploadFile.xptr;if(n>=t.byteLength)files.sendText(JSON.stringify({action:"uploaddone",reqid:uploadFile.xfilePtr}));else{if((o=uploadFile.xptr+(attemptWebRTC?16384:65536))>t.byteLength){if(1==e)return;o=t.byteLength}t=new Uint8Array(t.slice(n,o));123==t[0]||0==t[0]?((n=new Uint8Array(o-n+1)).set(t,1),files.send(n)):files.send(t),uploadFile.xptr=o,Q("d2progressBar").value=o}}else if(uploadFile.xfile&&null==uploadFile.xreader&&!(uploadFile.xptr>=uploadFile.xfile.size)){var o;if((o=uploadFile.xptr+(attemptWebRTC?16384:65536))>uploadFile.xfile.size){if(1==e)return;o=uploadFile.xfile.size}uploadFile.xreader=new FileReader,uploadFile.xreader.onerror=function(e){console.log(e)},uploadFile.xreader.onload=function(){var e,t=uploadFile.xreader.result;delete uploadFile.xreader,null!=t&&(123==(e=new Uint8Array(t))[0]||0==e[0]?((t=new Uint8Array(t.byteLength+1)).set(e,1),files.send(t)):files.send(e),uploadFile.xptr=o,Q("d2progressBar").value=o,uploadFile.xptr>=uploadFile.xfile.size?files.sendText(JSON.stringify({action:"uploaddone",reqid:uploadFile.xfilePtr})):0<uploadFile.xdataPriming&&(uploadFile.xdataPriming--,p13uploadNextPart(!0)))},uploadFile.xreader.readAsArrayBuffer(uploadFile.xfile.slice(uploadFile.xptr,o))}}var currentDeviceEvents=null;function deviceEventsUpdate(){var e="",t=null;for(l in currentDeviceEvents){var n=currentDeviceEvents[l],o=new Date(n.time);if(n.msg){null==n.h&&(n.h=Math.random()),printDate(o)!=t&&(null!=t&&(e+="</table>"),e+='<table class="table table-hover p3eventsTable" cellpadding=0 cellspacing=0><tr><td colspan=4 class=DevSt>'+(t=printDate(o))+"</td></tr>");var i,s,a="fa-mobile-screen";if("user"==n.etype&&(a="fa-user"),"server"==n.etype&&(a="fa-server"),null==n.msgid||null==eventsMessageId[n.msgid])i="string"==typeof n.msg?EscapeHtml(n.msg).split("(R)").join("&reg;"):"";else{for(var l in i=eventsMessageId[n.msgid],n.msgArgs){var r=n.msgArgs[l];"string"==typeof r&&0==r.indexOf("DATETIME:")&&(r=printFlexDateTime(new Date(parseInt(r.substring(9))))),i=i.split("{"+l+"}").join(r)}i=EscapeHtml(i).split("(R)").join("&reg;")}n.username&&(s="",n.guestname&&(s=' / <span title="這是一個嘉賓分享會">'+EscapeHtml(n.guestname)+"</span>"),i=2&userinfo.siteadmin&&n.userid?"<a href=# onclick='gotoUser(\""+encodeURIComponentEx(n.userid)+"\");haltEvent(event);'>"+EscapeHtml(n.username)+"</a>"+s+" &rarr; "+i:EscapeHtml(n.username)+s+" &rarr; "+i),"relay"!=n.etype&&"relaylog"!=n.action||(a="fa-arrow-right-arrow-left"),e+="<tr onclick=showEventDetails("+n.h+',1) onmouseover=eventMouseHover(this,1) onmouseout=eventMouseHover(this,0) role="button"><td style=width:18px><i class="fa-solid '+a+'"></i></td><td class=g1>&nbsp;</td><td class=style10>'+printTime(o)+" - "+i+"</td></tr><tr></tr>"}}null!=t&&(e+="</table>"),""==e&&(e="<br><i>找不到事件</i><br><br>"),QH("p16events",e)}function refreshDeviceEvents(){""!=p16filterevents.value?meshserver.send({action:"events",nodeid:currentNode._id,limit:parseInt(p16limitdropdown.value),filter:p16filterevents.value}):meshserver.send({action:"events",nodeid:currentNode._id,limit:parseInt(p16limitdropdown.value)})}function showEventDetails(e,t){if(xxdialogMode)return!1;var n,o;for(i in 1==t&&(n=currentDeviceEvents),2==t&&(n=events),n=3==t?currentUserEvents:n)if(n[i].h==e){o=n[i];break}if(o){var i,s="<div style=overflow-y:auto;max-height:300px>";for(i in o)"h"!=i&&"_id"!=i&&"ids"!=i&&"domain"!=i&&null!=o[i]&&("object"==typeof o[i]?s+=addHtmlValue3(EscapeHtml(i),EscapeHtml(JSON.stringify(o[i]))):s+=addHtmlValue3(EscapeHtml(i),EscapeHtml(o[i])));setModalContent("xxAddAgent","事件詳情",s+="</div>"),showModal("xxAddAgentModal","idx_dlgOkButton")}}var deviceDetailsStats=null,deviceDetailsStatsTimer=null,deviceDetailsStatsData=[],deviceDetailsConfig={type:"line",data:{labels:[],datasets:[{label:"CPU",backgroundColor:"rgba(134, 16, 158, .5)",borderColor:"rgb(134, 16, 158)",data:[],fill:!0},{label:"記憶體",backgroundColor:"rgba(255, 99, 132, .5)",borderColor:"rgb(255, 99, 132)",data:[],fill:!0}]},options:{events:["click"],animation:!1,responsive:!0,maintainAspectRatio:!1,tooltips:{enabled:!1},elements:{line:{cubicInterpolationMode:"monotone"}},scales:{x:{type:"linear",display:!0,title:{display:!1,text:""},min:0,max:100,reverse:!0},y:{type:"linear",display:!0,title:{display:!1,text:""},min:0,max:100}}}};function deskToggleCpuGraph(){("none"==QS("p17graph").display?(QV("p17graph",!0),window.deviceDetailsStatsChart=new Chart(document.getElementById("deviceDetailsStats").getContext("2d"),deviceDetailsConfig),deviceDetailsStatsTimer=setInterval(deviceDetailsStatsTimerFunc,2e3),deviceDetailsStatsTimerFunc):deviceDetailsStatsClear)()}function deviceDetailsStatsClear(){QV("p17graph",!1),null!=window.deviceDetailsStatsChart&&(window.deviceDetailsStatsChart.destroy(),delete window.deviceDetailsStatsChart),null!=deviceDetailsStatsTimer&&(clearInterval(deviceDetailsStatsTimer),deviceDetailsStatsTimer=null),deviceDetailsStatsData=[],deviceDetailsStatsDraw(),QV("extraGraphValues",!1),QH("extraGraphValues","")}function deviceDetailsStatsTimerFunc(){null!=currentNode&&meshserver.send({action:"msg",type:"cpuinfo",nodeid:currentNode._id})}function deviceDetailsStatsDraw(e){for(var t=Date.now()/1e3-100;0<deviceDetailsStatsData.length&&deviceDetailsStatsData[0][0]<t-5;)deviceDetailsStatsData.shift();var n=[],o=[];for(s in deviceDetailsStatsData){var i=deviceDetailsStatsData[s];n.push({x:100-(i[0]-t),y:i[1]}),o.push({x:100-(i[0]-t),y:i[2]})}if(deviceDetailsConfig.data.datasets[0].data=n,deviceDetailsConfig.data.datasets[1].data=o,window.deviceDetailsStatsChart&&window.deviceDetailsStatsChart.update(),null!=e&&Array.isArray(e.thermals)&&0<e.thermals.length){var s,a="&nbsp;";for(s in e.thermals)a+='<div class=thermalSensor title="'+e.thermals[s].InstanceName+'">'+parseFloat(e.thermals[s].CurrentTemperature).toFixed(2)+"&deg;C / "+parseFloat(1.8*e.thermals[s].CurrentTemperature+32).toFixed(2)+"&deg;F</div>";QV("extraGraphValues",!0),QH("extraGraphValues",a)}}var consoleNode,DeviceDetailsHardware=null,DeviceDetailsNetwork=null,DeviceDetailsNodeId=null;function updateDeviceDetails(e,t,n){if(null!=currentNode&&(null==e&&(e=currentNode),currentNode._id==e._id)){DeviceDetailsNodeId!=e._id&&(DeviceDetailsNetwork=DeviceDetailsHardware=null,DeviceDetailsNodeId=e._id),null==(t=DeviceDetailsHardware=null!=t?t:DeviceDetailsHardware)&&(t={}),null==(n=DeviceDetailsNetwork=null!=n?n:DeviceDetailsNetwork)&&(n={});var o,i,s=[],a={},l="";if(e.rname&&(l+=addDetailItem("名稱",EscapeHtml(e.rname),a)),t.windows&&t.windows.osinfo&&t.windows.osinfo.Description&&(l+=addDetailItem("描述",EscapeHtml(t.windows.osinfo.Description),a)),e.osdesc&&(l+=addDetailItem("版",EscapeHtml(e.osdesc),a)),t.windows&&t.windows.osinfo&&((d=t.windows.osinfo).OSArchitecture&&(d.OSArchitecture.startsWith("32")?l+=addDetailItem("結構","32 位",a):d.OSArchitecture.startsWith("64")?l+=addDetailItem("結構","64 位",a):l+=addDetailItem("結構",EscapeHtml(d.OSArchitecture),a)),d.LastBootUpTime)&&(i={year:parseInt(d.LastBootUpTime.substring(0,4)),month:parseInt(d.LastBootUpTime.substring(4,6))-1,day:parseInt(d.LastBootUpTime.substring(6,8)),hours:parseInt(d.LastBootUpTime.substring(8,10)),minutes:parseInt(d.LastBootUpTime.substring(10,12)),seconds:parseInt(d.LastBootUpTime.substring(12,14))},l+=addDetailItem("Last Boot Up Time",printDateTime(new Date(i.year,i.month,i.day,i.hours,i.minutes,i.seconds)))),t.linux&&t.linux.LastBootUpTime&&(l+=addDetailItem("Last Boot Up Time",printDateTime(new Date(t.linux.LastBootUpTime)))),t.darwin&&t.darwin.LastBootUpTime&&(l+=addDetailItem("Last Boot Up Time",printDateTime(new Date(1e3*t.darwin.LastBootUpTime)))),""!=l&&s.push({name:"操作系統",html:l,img:"software64.png"}),e.agent&&(l="",null!=e.agent&&null!=e.agent.id&&null!=e.agent.ver&&(i="",i=e.agent.id<=agentsStr.length?agentsStr[e.agent.id]:agentsStr[0],0!=e.agent.ver&&(i+=" v"+e.agent.ver),l+=addDetailItem("Mesh Agent",i=14==e.agent.id?e.agent.core:i)),0!=(1&e.conn)?l+=addDetailItem("上次代理連接","現在已連接"):e.lastconnect&&(l+=addDetailItem("上次代理連接",printDateTime(new Date(e.lastconnect)))),e.lastaddr&&(2<(i=e.lastaddr.split(":")).length?l+=addDetailItem("上次代理地址",e.lastaddr):isPrivateIP(e.lastaddr)?l+=addDetailItem("上次代理地址",i[0]):l+=addDetailItem("上次代理地址",'<a href="https://iplocation.com/?ip='+i[0]+'" rel="noreferrer noopener" target="MeshIPLoopup">'+i[0]+"</a>")),null!=t.agentvers&&t.agentvers.compileTime&&(i=Date.parse(t.agentvers.compileTime),l+=addDetailItem("編譯時間",isNaN(i)?t.agentvers.compileTime:printDateTime(new Date(i)))),""!=l)&&s.push({name:"Mesh Agent",html:l,img:"meshagent64.png"}),t.mobile&&(l="",t.mobile.brand&&t.mobile.model&&(l+=addDetailItem("模型",EscapeHtml(t.mobile.brand+", "+t.mobile.model),a)),t.mobile.device&&(l+=addDetailItem("裝置",EscapeHtml(t.mobile.device),a)),t.mobile.bootloader&&(l+=addDetailItem("引導加載程序",EscapeHtml(t.mobile.bootloader),a)),t.mobile.id&&(l+=addDetailItem("識別符",EscapeHtml(t.mobile.id),a)),t.mobile.host&&(l+=addDetailItem("主機名",EscapeHtml(t.mobile.host),a)),t.mobile.androidapi&&t.mobile.androidrelease&&(l+=addDetailItem("Android Version",EscapeHtml(t.mobile.androidrelease+", API Level "+t.mobile.androidapi),a)),""!=l)&&s.push({name:"移動設備",html:l,img:"mobile64.png"}),null!=n.netif){var r={};for(v in n.netif)"string"==typeof(d=n.netif[v]).mac&&(null==r[d.mac]?(r[d.mac]=d,r[d.mac].ipv4layer=[{v4addr:d.v4addr,v4mask:d.v4mask,v4gateway:d.v4gateway}]):r[d.mac].ipv4layer.push({v4addr:d.v4addr,v4mask:d.v4mask,v4gateway:d.v4gateway}));var l="";for(v in l+='<table class="table table-hover" style=width:100%>',r){var d=r[v];for(p in l=(l+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>")+("<div style=margin-bottom:3px><b>"+EscapeHtml(d.name+(d.dnssuffix?", "+d.dnssuffix:""))+"</b></div>"),d.desc&&(l+=addDetailItem("描述",EscapeHtml(d.desc).split("(R)").join("&reg;"))),d.mac&&(d.gatewaymac?l+=addDetailItem("MAC層",format("MAC：{0}，網關：{1}",EscapeHtml(d.mac),EscapeHtml(d.gatewaymac))):d.mac&&(l+=addDetailItem("MAC層",format("MAC：{0}",EscapeHtml(d.mac))))),d.ipv4layer){var c=d.ipv4layer[p];c.v4gateway&&c.v4mask?l+=addDetailItem("IPv4層",format("IP：{0}，遮罩：{1}，閘道：{2}",EscapeHtml(c.v4addr),EscapeHtml(c.v4mask),EscapeHtml(c.v4gateway))):c.v4addr&&(l+=addDetailItem("IPv4層",format("IP：{0}",EscapeHtml(c.v4addr))))}l+="</div></td></tr>"}""!=(l+="</table>")&&s.push({name:"網路",html:l,img:"networking64.png"})}if(null!=n.netif2){var l="";for(v in l+='<table class="table table-hover" style=width:100%>',n.netif2){d=n.netif2[v];if(!(0==Array.isArray(d)||d.length<1||null==d[0]||"string"==typeof d[0].mac&&d[0].mac.startsWith("00:00:00:00"))){l+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>";var u="";null!=v&&(u+=v),null!=d[0].fqdn&&""!=d[0].fqdn&&(u+=", "+d[0].fqdn),0<u.length&&(l+="<div style=margin-bottom:3px><b>"+EscapeHtml(u)+"</b></div>"),d.desc&&(l+=addDetailItem("描述",EscapeHtml(d.desc).split("(R)").join("&reg;"))),"string"==typeof d[0].mac&&(d[0].gatewaymac?l+=addDetailItem("MAC層",format("MAC：{0}，網關：{1}",EscapeHtml(d[0].mac),EscapeHtml(d[0].gatewaymac))):l+=addDetailItem("MAC層",format("MAC：{0}",EscapeHtml(d[0].mac))));for(var p=0;p<d.length;p++){var m=d[p],g=[];m.address&&g.push(format("IP：{0}",EscapeHtml(m.address))),m.netmask&&g.push(format("掩碼：{0}",EscapeHtml(m.netmask))),m.gateway&&g.push(format("網關：{0}",EscapeHtml(m.gateway))),0<g.length&&("IPv4"==m.family&&(l+=addDetailItem("IPv4層",g.join("，"))),"IPv6"==m.family)&&(l+=addDetailItem("IPv6層",g.join("，")))}l+="</div></td></tr>"}}t.network&&t.network.dns&&(l=(l+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>")+addDetailItem("<b>DNS Servers</b>",t.network.dns.join("，"))+"</div></td></tr>"),""!=(l+="</table>")&&s.push({name:"網路",html:l,img:"networking64.png"})}if(null!=e.intelamt&&(l="",l+=addDetailItem("版",e.intelamt.ver?"v"+EscapeHtml(e.intelamt.ver):"<i>未知</i>",a),i={0:nobreak("未激活"),1:nobreak("預激活"),2:nobreak("已啟動")},o="",2==e.intelamt.state&&e.intelamt.flags&&(2&e.intelamt.flags?o=", 客戶端控制模式（CCM）":4&e.intelamt.flags&&(o=", 管理員控制模式（ACM）")),""!=(l=(l=(l+=addDetailItem("配置狀態",(e.intelamt.state?i[e.intelamt.state]:"<i>未知</i>")+o,a))+addDetailItem("安全",1==e.intelamt.tls?"已使用TLS保安":"未設置TLS",a))+addDetailItem("管理員憑證",null==e.intelamt.user||""==e.intelamt.user||null!=e.intelamt.warn&&0!=(9&e.intelamt.warn)?"未知":"已知的",a)))&&("number"==typeof e.intelamt.sku&&0!=(16&e.intelamt.sku)?s.push({name:"英特爾&reg; 標準可管理性（英特爾&reg; SM）",html:l,img:"amt64.png"}):s.push({name:"Intel &reg; Active Management Technology（Intel&reg; AMT）",html:l,img:"amt64.png"})),t.identifiers){var l="",h=t.identifiers;if(h.bios_vendor&&(l+=addDetailItem("供應商",EscapeHtml(h.bios_vendor),a)),h.bios_version&&(l+=addDetailItem("版",EscapeHtml(h.bios_version),a)),h.bios_serial&&(l+=addDetailItem("序列號",EscapeHtml(h.bios_serial),a)),h.bios_mode&&(l+=addDetailItem("Mode",EscapeHtml(h.bios_mode),a)),""!=l&&s.push({name:"的BIOS",html:l,img:"chip64.png"}),l="",h.board_vendor&&(l+=addDetailItem("供應商",EscapeHtml(h.board_vendor),a)),h.board_name&&(l+=addDetailItem("名稱",EscapeHtml(h.board_name),a)),h.board_serial&&""!=h.board_serial&&(l+=addDetailItem("序列號",EscapeHtml(h.board_serial),a)),h.board_version&&(l+=addDetailItem("版",EscapeHtml(h.board_version),a)),h.product_uuid&&(l+=addDetailItem("識別符",EscapeHtml(h.product_uuid),a)),h.cpu_name&&(l+=addDetailItem("CPU",EscapeHtml(h.cpu_name).split("(TM)").join("&trade;").split("(R)").join("&reg;"),a)),h.gpu_name)for(var v in h.gpu_name)l+=addDetailItem("GPU",EscapeHtml(h.gpu_name[v]).split("(TM)").join("&trade;").split("(R)").join("&reg;"),a);""!=l&&s.push({name:"母板",html:l,img:"motherboard64.png"})}if(t.tpm&&(l="",(i=t.tpm).SpecVersion&&(l+=addDetailItem("SpecVersion",parseFloat(EscapeHtml(i.SpecVersion)).toFixed(1),a)),i.ManufacturerId&&(l+=addDetailItem("ManufacturerId",EscapeHtml(i.ManufacturerId),a)),i.ManufacturerVersion&&(l+=addDetailItem("ManufacturerVersion",EscapeHtml(i.ManufacturerVersion),a)),null!=i.IsActivated&&(l+=addDetailItem("IsActivated",i.IsActivated?"Yes":"No",a)),null!=i.IsEnabled&&(l+=addDetailItem("IsEnabled",i.IsEnabled?"Yes":"No",a)),null!=i.IsOwned&&(l+=addDetailItem("IsOwned",i.IsOwned?"Yes":"No",a)),""!=l)&&s.push({name:"TPM",html:l,img:"tpm64.png"}),t.windows&&t.windows.memory&&0<t.windows.memory.length){l="";for(v in t.windows.memory.sort(function(e,t){return e.BankLabel>t.BankLabel?1:e.BankLabel<t.BankLabel?-1:0}),l+='<table class="table table-hover" style=width:100%>',t.windows.memory){d=t.windows.memory[v];l=(l+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>")+("<div style=margin-bottom:3px><b>"+EscapeHtml(d.BankLabel||d.DeviceLocator||"Unknown")+"</b></div>"),d.Capacity&&d.Speed?l+=addDetailItem("容量/速度",format("{0} Mb，{1} Mhz",d.Capacity/1024/1024,d.Speed),a):d.Capacity&&(l+=addDetailItem("容量",format("{0} Mb",d.Capacity/1024/1024),a)),d.PartNumber&&(l+=addDetailItem("零件號",EscapeHtml(d.Manufacturer&&"Undefined"!=d.Manufacturer?d.Manufacturer+", ":"")+EscapeHtml(d.PartNumber),a)),l+="</div>"}""!=(l+="</table>")&&s.push({name:"記憶體",html:l,img:"ram64.png"})}if(t.linux&&t.linux.memory&&0<t.linux.memory.Memory_Device.length){l="";for(v in t.linux.memory.Memory_Device.sort(function(e,t){return e.Locator>t.Locator?1:e.Locator<t.Locator?-1:0}),l+='<table class="table table-hover" style=width:100%>',t.linux.memory.Memory_Device)(d=t.linux.memory.Memory_Device[v]).Size&&"No Module Installed"==d.Size||(l=(l+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>")+"<div style=margin-bottom:3px><b>"+EscapeHtml(d.Locator||"Unknown")+"</b></div>",d.Size&&d.Speed?l+=addDetailItem("容量/速度",format("{0}, {1}",d.Size,d.Speed),a):d.Size&&(l+=addDetailItem("容量",format("{0}",d.Size),a)),d.PartNumber&&(l+=addDetailItem("零件號",EscapeHtml(d.Manufacturer&&"Undefined"!=d.Manufacturer?d.Manufacturer+", ":"")+EscapeHtml(d.PartNumber),a)),l+="</div>");""!=(l+="</table>")&&s.push({name:"記憶體",html:l,img:"ram64.png"})}if(t.darwin&&t.darwin.memory&&0<t.darwin.memory.length){l="";for(v in l+='<table class="table table-hover" style=width:100%>',t.darwin.memory)(d=t.darwin.memory[v]).Size&&"No Module Installed"==d.Size||(l=(l+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>")+"<div style=margin-bottom:3px><b>"+EscapeHtml(d.DeviceLocator||"Unknown")+"</b></div>",d.Size&&d.Speed?l+=addDetailItem("容量/速度",format("{0}, {1}",d.Size,d.Speed),a):d.Size&&(l+=addDetailItem("容量",format("{0}",d.Size),a)),d.PartNumber&&(l+=addDetailItem("零件號",EscapeHtml(d.Manufacturer&&""!=d.Manufacturer?d.Manufacturer+", ":"")+EscapeHtml(d.PartNumber),a)),l+="</div>");""!=(l+="</table>")&&s.push({name:"記憶體",html:l,img:"ram64.png"})}if(t.identifiers&&t.identifiers.storage_devices){var f,l="";for(v in h.storage_devices.sort(function(e,t){return e.Caption>t.Caption?1:e.Caption<t.Caption?-1:0}),l+="<table style=width:100%>",h.storage_devices)(d=h.storage_devices[v]).Size&&(l=(l+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>")+"<div style=margin-bottom:3px><b>"+EscapeHtml(d.Caption)+"</b></div>",d.Model&&d.Model!=d.Caption&&(l+=addDetailItem("模型",EscapeHtml(d.Model),a)),d.Size&&("string"==typeof d.Size&&parseInt(d.Size)==d.Size&&(d.Size=parseInt(d.Size)),"number"==typeof d.Size&&(l+=addDetailItem("容量",format("{0} Mb",Math.floor(d.Size/1024/1024)),a)),"string"==typeof d.Size)&&(l+=addDetailItem("容量",EscapeHtml(d.Size),a)),t.windows&&t.windows.drives&&d.Model&&(f=t.windows.drives.find(e=>e.Model===d.Model))&&f.Status&&(l+=addDetailItem("狀態",EscapeHtml(f.Status),a)),l+="</div>");""!=(l+="</table>")&&s.push({name:"儲存",html:l,img:"storage64.png"})}if(t.windows&&t.windows.volumes){var x,l="";for(v in t.windows.volumes)l=(l+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>")+("<div style=margin-bottom:3px><b>"+v+":"+(null==(d=t.windows.volumes[v]).name||""==d.name?"":" - "+EscapeHtml(d.name))+"</b></div>"),d.size&&(k=["Bytes","KB","MB","GB","TB"],y=0===(p=parseInt(Math.floor(Math.log(Math.abs(d.size))/Math.log(1024)),10))?d.size+" "+k[p]:(d.size/1024**p).toFixed(2)+" "+k[p],l+=addDetailItem("容量",EscapeHtml(y),a)),d.sizeremaining&&(k=["Bytes","KB","MB","GB","TB"],y=0===(p=parseInt(Math.floor(Math.log(Math.abs(d.sizeremaining))/Math.log(1024)),10))?d.sizeremaining+" "+k[p]:(d.sizeremaining/1024**p).toFixed(2)+" "+k[p],l+=addDetailItem("Capacity Remaining",EscapeHtml(y),a)),d.type&&(l+=addDetailItem("File System",(""!=(b=1==d.removable?"Removable":1==d.cdrom?"CD-ROM":"")?b+" / ":"")+("Unknown"==d.type?"未知":EscapeHtml(d.type)),a)),(d.protectionStatus||d.volumeStatus)&&(x=[],d.protectionStatus&&x.push("已啟用"),d.volumeStatus&&"FullyDecrypted"==d.volumeStatus&&x.push("Fully Decrypted"),d.volumeStatus&&"EncryptionInProgress"==d.volumeStatus&&x.push("Encryption In Progress"),d.volumeStatus&&"FullyEncrypted"==d.volumeStatus&&x.push("Fully Encrypted"),x=x.join(" - "),d.recoveryPassword&&(x+=addKeyLink("",'deviceDetailsShowBitlockerInfo("'+encodeURIComponentEx(v)+'","'+encodeURIComponentEx(d.identifier)+'","'+encodeURIComponentEx(d.recoveryPassword)+'")')),l+=addDetailItem("BitLocker",x,a)),l+="</div>";""!=l&&s.push({name:"Storage Volumes",html:"<table style=width:100%>"+l+"</table>",img:"storage64.png"})}if(t.linux&&t.linux.volumes){var k,y,l="";for(v in t.linux.volumes)(d=t.linux.volumes[v]).mount_point.startsWith("/var/lib/docker/overlay2")||(l=(l+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>")+"<div style=margin-bottom:3px><b>"+d.mount_point+"</b></div>",d.size&&(k=["KB","MB","GB","TB"],y=0===(p=parseInt(Math.floor(Math.log(Math.abs(d.size))/Math.log(1024)),10))?d.size+" "+k[p]:(d.size/1024**p).toFixed(2)+" "+k[p],l+=addDetailItem("容量",EscapeHtml(y),a)),d.available&&(y=0==Math.abs(d.available)?"0 KB":(k=["KB","MB","GB","TB"],0===(p=parseInt(Math.floor(Math.log(Math.abs(d.available))/Math.log(1024)),10))?d.available+" "+k[p]:(d.available/1024**p).toFixed(2)+" "+k[p]),l+=addDetailItem("Capacity Remaining",EscapeHtml(y),a)),d.type&&(l+=addDetailItem("File System",(""!=(b=1==d.removable?"Removable":1==d.cdrom?"CD-ROM":"")?b+" / ":"")+("Unknown"==d.type?"未知":EscapeHtml(d.type)),a)),l+="</div>");""!=l&&s.push({name:"Storage Volumes",html:"<table style=width:100%>"+l+"</table>",img:"storage64.png"})}if(t.darwin&&t.darwin.volumes){var b,l="";for(v in t.darwin.volumes)(d=t.darwin.volumes[v]).mount_point.startsWith("/var/lib/docker/overlay2")||(l=(l+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>")+"<div style=margin-bottom:3px><b>"+d.mount_point+"</b></div>",d.size&&(l+=addDetailItem("容量",EscapeHtml(d.size),a)),d.available&&(l+=addDetailItem("Capacity Remaining",EscapeHtml(d.available),a)),d.type&&(l+=addDetailItem("File System",(""!=(b=1==d.removable?"Removable":1==d.cdrom?"CD-ROM":"")?b+" / ":"")+("Unknown"==d.type?"未知":EscapeHtml(d.type)),a)),l+="</div>");""!=l&&s.push({name:"Storage Volumes",html:"<table style=width:100%>"+l+"</table>",img:"storage64.png"})}l="";for(v in s)null==s[v].img?l+="<div class=DevSt style=margin-bottom:3px;margin-left:16px><b>"+s[v].name+"</b></div><div style=margin-bottom:10px;margin-left:16px>"+s[v].html+"</div>":l=(l=(l+="<table style=width:100%><tr>")+"<td style=width:64px;vertical-align:top><img src=images/details/"+s[v].img+" border=0 width=64 /></td>")+"<td><div class=DevSt style=margin-bottom:3px;margin-left:16px><b>"+s[v].name+"</b></div><div style=margin-bottom:10px;margin-left:16px>"+s[v].html+"</div></td></tr></table>";""==l?QH("p17info2","沒有此裝置的訊息。"):QH("p17info2",l)}}function deviceDetailsShowBitlockerInfo(e,t,n){if(xxdialogMode)return!1;t="<div><p>識別符</p><p style=user-select:text;font-weight:bold>"+(t?decodeURIComponent(t):"未知")+"</p>";t+="<p>Recovery Password</p><p style=user-select:text;font-weight:bold>"+(n?decodeURIComponent(n):"未知")+"</p></div>",setModalContent("xxAddAgent",decodeURIComponent(e)+": BitLocker Information",t),showModal("xxAddAgentModal","idx_dlgOkButton")}function agentConsoleHandleKeys(e){var t,n,o;return!(!e.ctrlKey&&!e.altKey)||(t=0,n=Q("p15consoleText"),e.key?13==e.keyCode&&0==consoleFocus?(p15consoleSend(e),t=1):8==e.keyCode&&0==consoleFocus?(o=n.value,n.value=o.substring(0,o.length-1),t=1):27==e.keyCode?(n.value="",t=1):38==e.keyCode||40==e.keyCode?(o=consoleHistory.indexOf(n.value),38==e.keyCode&&consoleHistory.length-1>o?n.value=consoleHistory[o+1]:40==e.keyCode&&0<o?n.value=consoleHistory[o-1]:40==e.keyCode&&0==o&&(n.value=""),t=1):1===e.key.length&&(insertTextAtCursor(n,e.key),t=1):0!=e.charCode&&0==consoleFocus&&(n.value=n.value+String.fromCharCode(e.charCode),t=1),0<t?haltEvent(e):void 0)}function insertTextAtCursor(e,t){var n,o;document.selection?(e.focus(),(sel=document.selection.createRange()).text=t):e.selectionStart||"0"==e.selectionStart?(n=e.selectionStart,o=e.selectionEnd,e.value=e.value.substring(0,n)+t+e.value.substring(o,e.value.length),e.setSelectionRange(o+1,o+1)):e.value+=myValue}var consoleServerText="";function setupConsole(){var e,t;115==xxcurrentView?(e="server"==consoleNode,consoleNode="server",QH("p15deviceName","我的伺服器控制台"),QE("p15consoleText",!0),QH("p15statetext",""),QH("p15coreName",""),QV("p15outputselecttd",!1),0==e&&(QH("p15agentConsoleText",consoleServerText),Q("p15agentConsoleText").scrollTop=Q("p15agentConsoleText").scrollHeight)):(e=consoleNode==currentNode,meshes[(consoleNode=currentNode).meshid],0!=(16&GetNodeRights(currentNode))?(null==consoleNode.consoleText&&(consoleNode.consoleText=""),0==e&&(QH("p15agentConsoleText",consoleNode.consoleText),Q("p15agentConsoleText").scrollTop=Q("p15agentConsoleText").scrollHeight),0==(1&consoleNode.conn)&&consoleNode.conn,e=0!=(1&consoleNode.conn)?"代理在線":"代理離線",0!=(16&consoleNode.conn)&&(e+="，MQTT在線"),QH("p15statetext",e),QE("p15uploadCore",0!=(1&consoleNode.conn)),QV("p15outputselecttd",0!=(16&consoleNode.conn)||1==currentNode.pmt&&0!=(4&features2)),QV("p15outputselect2",0!=(16&consoleNode.conn)),QV("p15outputselect3",1==currentNode.pmt&&0!=(4&features2)),e=Q("p15outputselect").value,0==(16&consoleNode.conn)&&2==e&&(e=1,Q("p15outputselect").value=1),1==currentNode.pmt&&0!=(4&features2)||3!=e||(e=1,Q("p15outputselect").value=1),t=!1,0!=(1&consoleNode.conn)&&1==e&&(t=!0),0!=(16&consoleNode.conn)&&2==e&&(t=!0),1==currentNode.pmt&&0!=(4&features2)&&3==e&&(t=!0),QE("p15consoleText",t)):(QH("p15statetext","拒絕存取"),QE("p15consoleText",!1),QE("p15uploadCore",!1),QV("p15outputselecttd",!1)),QV("devListToolbarViewIcons3",0!=(1&consoleNode.conn)))}function p15consoleClear(){QH("p15agentConsoleText",""),Q("id_p15consoleClear").blur(),115==xxcurrentView?consoleServerText="":consoleNode.consoleText=""}var consoleHistory=[];function p15consoleSend(e){var t;e&&13!=e.keyCode||(e=Q("p15consoleText").value,t="<div style=color:green>&gt; "+EscapeHtml(e)+"<br/></div>",115==xxcurrentView?(consoleServerText+=t,meshserver.send({action:"serverconsole",value:e})):0!=(16&consoleNode.conn)&&2==Q("p15outputselect").value?(t="<div style=color:orange>MQTT&gt; "+EscapeHtml(e)+"<br/></div>",consoleNode.consoleText+=t,meshserver.send({action:"sendmqttmsg",topic:"console",nodeids:[consoleNode._id],msg:e})):1==consoleNode.pmt&&3==Q("p15outputselect").value&&0!=(4&features2)?(t="<div style=color:violet>推&gt; "+EscapeHtml(e)+"<br/></div>",consoleNode.consoleText+=t,meshserver.send({action:"pushconsole",nodeid:consoleNode._id,console:e})):0!=(1&consoleNode.conn)&&(consoleNode.consoleText+=t,meshserver.send({action:"msg",type:"console",nodeid:consoleNode._id,value:e})),Q("p15agentConsoleText").innerHTML+=t,Q("p15agentConsoleText").scrollTop=Q("p15agentConsoleText").scrollHeight,Q("p15consoleText").value="",0<e.length&&(0<=(t=consoleHistory.indexOf(e))&&consoleHistory.splice(t,1),consoleHistory.unshift(e),consoleHistory.splice(10)))}function p15consoleReceive(e,t,n){"serverconsole"===e?(t="<div>"+EscapeHtml(t)+"</div>",consoleServerText+=t,"server"==consoleNode&&(Q("p15agentConsoleText").innerHTML+=t,Q("p15agentConsoleText").scrollTop=Q("p15agentConsoleText").scrollHeight)):(t="MQTT"==n?"<div style=color:red>MQTT&gt; "+EscapeHtml(t)+"<br/></div>":"<div>"+EscapeHtml(t)+"</div>",null==e.consoleText?e.consoleText=t:e.consoleText+=t,consoleNode==e&&(Q("p15agentConsoleText").innerHTML+=t,Q("p15agentConsoleText").scrollTop=Q("p15agentConsoleText").scrollHeight))}function p15downloadConsoleText(){saveAs(new Blob([Q("p15agentConsoleText").innerText],{type:"application/octet-stream"}),"console.txt")}function p15uploadCore(e){xxdialogMode||(1==e.shiftKey?meshserver.send({action:"uploadagentcore",nodeids:[consoleNode._id],type:"default"}):1==e.altKey?meshserver.send({action:"uploadagentcore",nodeids:[consoleNode._id],type:"clear"}):1==e.ctrlKey?p15uploadCore2():(setModalContent("xxAddAgent","執行代理指令",addHtmlFormFloating("指令",'<select id=d3coreMode class="form-select me-2"><option value=1>上載默認伺服器核心</option><option value=2>清除核心</option><option value=6>上傳恢復核心</option><option value=7>上傳小核心</option><option value=3>上載核心檔案</option><option value=4>軟斷開代理</option><option value=5>強行斷開代理</option><option value=8>Restart agent service</select>')),showModal("xxAddAgentModal","idx_dlgOkButton",p15uploadCoreEx)))}function p15uploadCoreEx(){1==Q("d3coreMode").value?meshserver.send({action:"uploadagentcore",nodeids:[consoleNode._id],type:"default"}):2==Q("d3coreMode").value?meshserver.send({action:"uploadagentcore",nodeids:[consoleNode._id],type:"clear"}):3==Q("d3coreMode").value?p15uploadCore2():4==Q("d3coreMode").value?meshserver.send({action:"agentdisconnect",nodeid:consoleNode._id,disconnectMode:1}):5==Q("d3coreMode").value?meshserver.send({action:"agentdisconnect",nodeid:consoleNode._id,disconnectMode:2}):6==Q("d3coreMode").value?meshserver.send({action:"uploadagentcore",nodeids:[consoleNode._id],type:"recovery"}):7==Q("d3coreMode").value?meshserver.send({action:"uploadagentcore",nodeids:[consoleNode._id],type:"tiny"}):8==Q("d3coreMode").value&&meshserver.send({action:"msg",type:"console",nodeid:consoleNode._id,value:"service restart"})}function p15uploadCore2(){xxdialogMode||(Q("d3localmodeform").action="uploadmeshcorefile.ashx",Q("d3auth").value=authCookie,Q("d3filter").value=".js",Q("d3attrib").value=currentNode._id,setModalContent("xxAddAgent","上載mesh agent核心",""),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p15uploadCoreEx2()),d3init())}function p15uploadCoreEx2(){var e;1==Q("d3uploadMode").value?Q("d3submit").click():1==(e=d3getFileSel()).length&&meshserver.send({action:"uploadagentcore",nodeids:[consoleNode._id],type:"custom",path:d3filetreelocation.join("/")+"/"+e[0]})}function account_viewPreviousLogins(){xxdialogMode||(xxdialogTag="previousLogins",setModalContent("xxAddAgent","以前的登錄","Loading..."),showModal("xxAddAgentModal","idx_dlgOkButton"),meshserver.send({action:"previousLogins"}))}function account_manageImage(e){var t,n,o,i;xxdialogMode||(t=0==e?userinfo:currentUser,setModalContent("xxAddAgent","管理帳戶圖片",'<input id=p2file type=file class="form-control" accept="image/*" onchange=account_manageImageEx()><div style=width:100%><canvas id=p2canvas width=256 height=256 style="width:256px;height:256px;margin-left:60px;margin-top:8px;border-radius:16px;background: var(--sub-menu-bg);border: 1px solid #cfcdcd; cursor: pointer;" onclick=account_canvasClick() /></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",account_manageImageEx2),n=Q("p2canvas").getContext("2d"),null==t.accountImageRnd&&(t.accountImageRnd=Math.floor(9999999999*Math.random())),o="",1==e&&(o="&id="+t._id.split("/")[2]),(i=new Image).onload=function(){n.clearRect(0,0,256,256),n.drawImage(i,0,0)},i.src=null!=t.flags&&1&t.flags?"userimage.ashx?rnd="+t.accountImageRnd+o:"images/user-256.png",QE("idx_dlgDeleteButton",null!=t.flags&&1&t.flags),QE("idx_dlgOkButton",!1))}function account_canvasClick(){Q("p2file").click()}function account_manageImageEx(){var e=Q("p2file").files[0],i=new Image;i.onload=function(){var e=0,t=0,n=Math.min(i.width,i.height),o=(i.width>n&&(e=(i.width-n)/2),i.height>n&&(t=(i.height-n)/2),Q("p2canvas").getContext("2d"));o.imageSmoothingEnabled=!0,o.webkitImageSmoothingEnabled=!0,o.mozImageSmoothingEnabled=!0,o.clearRect(0,0,256,256),o.drawImage(i,e,t,n,n,0,0,256,256),QE("idx_dlgOkButton",!0)},i.src=URL.createObjectURL(e)}function account_manageImageEx2(e,t){meshserver.send({action:"updateUserImage",userid:t,image:2==e?0:Q("p2canvas").toDataURL(Q("p2file").files[0].type)})}function account_managePhone(){xxdialogMode||0==(33554432&features)||(null!=userinfo.phone?(setModalContent("xxAddAgent","電話通知",'<table style=width:100%><tr><td style=width:56px><img src="images/phone80.png" style=padding:8px>'+("<td style=text-align:center><div style=padding:6px>驗證電話號碼</div><div style=font-size:20px>"+EscapeHtml(userinfo.phone)+"</div>")+'<div style=margin:10px><label><input id=d2delPhone type=checkbox class="form-check-input me-2" onclick=account_managePhoneRemoveValidate() />刪除電話號碼</label></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>account_managePhoneRemove()),account_managePhoneRemoveValidate):(xxdialogTag="verifyPhone",setModalContent("xxAddAgent","電話通知",'<table style=width:100%><tr><td style=width:56px><img src="images/phone80.png" style=padding:8px>'+"<td>輸入支持SMS的電話號碼。驗證後，該號碼可用於登入驗證和其他通知。"+'<br /><br /><div style=width:100%;text-align:center>電話號碼： <input type=tel pattern="[0-9]" autocomplete="tel" inputmode="tel" maxlength=18 id=d2phoneinput onKeyUp=account_managePhoneValidate() onkeypress="if (event.key==\'Enter\') account_managePhoneValidate(1)"></div></table>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>account_managePhoneAdd()),Q("d2phoneinput").focus(),account_managePhoneValidate))()}function isPhoneNumber(e){var t=!0;e.startsWith("+")&&(e=e.substring(1));for(var n=0;n<e.length;n++){var o=e.charCodeAt(n);(o<48||57<o)&&32!=o&&45!=o&&46!=o&&(t=!1)}return t&&10<=e.length}function account_managePhoneValidate(e){var t=isPhoneNumber(Q("d2phoneinput").value);QE("idx_dlgOkButton",t),1==e&&t&&dialogclose(1)}function account_managePhoneCodeValidate(e){var t=6==Q("d2phoneCodeInput").value.length&&Q("d2phoneCodeInput").value.match(/[0-9]/);QE("idx_dlgOkButton",t),1==e&&t&&dialogclose(1)}function account_managePhoneConfirm(e,t){meshserver.send({action:"confirmPhone",code:Q("d2phoneCodeInput").value,cookie:t})}function account_managePhoneAdd(){0!=isPhoneNumber(Q("d2phoneinput").value)&&(QE("d2phoneinput",!1),meshserver.send({action:"verifyPhone",phone:Q("d2phoneinput").value}))}function account_managePhoneRemove(){Q("d2delPhone").checked&&meshserver.send({action:"removePhone"})}function account_managePhoneRemoveValidate(){QE("idx_dlgOkButton",Q("d2delPhone").checked)}function account_manageMessaging(){var e,t;xxdialogMode||0==(33554432&features2)||(null!=userinfo.msghandle?(setModalContent("xxAddAgent","Messaging Notifications",e=(e='<table style=width:100%><tr><td style=width:56px><img src="images/messaging40.png" style=padding:8px>')+("<td style=text-align:center><div style=padding:6px>Verified handle</div><div style=font-weight:bold>"+EscapeHtml(userinfo.msghandle)+"</div>")+'<div style=margin:10px><label><input id=d2delPhone type=checkbox class="form-check-input me-2" onclick=account_managePhoneRemoveValidate() />Remove messaging</label></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>account_manageMessagingRemove()),account_managePhoneRemoveValidate):(t="<select id=d2serviceselect style=width:160px;margin-left:8px onchange=account_manageMessagingValidate()>",0!=(1&serverinfo.userMsgProviders)&&(t+="<option value=1>Telegram</option>"),0!=(4&serverinfo.userMsgProviders)&&(t+="<option value=4>Discord</option>"),0!=(8&serverinfo.userMsgProviders)&&(t+="<option value=8>XMPP</option>"),0!=(16&serverinfo.userMsgProviders)&&(t+="<option value=16>CallMeBot</option>"),0!=(32&serverinfo.userMsgProviders)&&(t+="<option value=32>Pushover</option>"),0!=(64&serverinfo.userMsgProviders)&&(t+="<option value=64>ntfy</option>"),0!=(128&serverinfo.userMsgProviders)&&(t+="<option value=128>Zulip</option>"),0!=(256&serverinfo.userMsgProviders)&&(t+="<option value=256>Slack</option>"),e=(e='<table style=width:100%><tr><td style=width:56px;vertical-align:top><img src="images/messaging40.png" style=padding:8px>')+"<td>Enter your messaging service and handle. Once verified, this server can send you login verification and other notifications.<br /><br /><table><tr><td>Service<td>"+(t+="</select>")+"<tr><td>Handle<td><input maxlength=1024 style=width:160px;margin-left:8px id=d2handleinput onKeyUp=account_manageMessagingValidate() onkeypress=\"if (event.key=='Enter') account_manageMessagingValidate(1)\"></table>",serverinfo.discordUrl&&(e+="<div id=d2discordurl style=display:none><br /><a href="+serverinfo.discordUrl+' target="_discord">Join this Discord server to receive notifications.</a></div>'),e+='<div id=d2callmebotinfo style=display:none><br /><a href=https://www.callmebot.com/blog/free-api-signal-send-messages/ target="_callmebot">Signal</a>, <a href=https://www.callmebot.com/blog/free-api-whatsapp-messages/ target="_callmebot">Whatsapp</a>, <a href=https://www.callmebot.com/blog/free-api-facebook-messenger/ target="_callmebot">Facebook</a>, <a href=https://www.callmebot.com/blog/telegram-text-messages/ target="_callmebot">Telegram</a></div><div id=d2pushoverinfo style=display:none><br /><a href=https://pushover.net/ target="_pushover">Information at Pushover.net</a></div>',console.log(serverinfo.userMsgNftyUrl),e+='<div id=d2ntfyinfo style=display:none><br /><a href="'+(serverinfo.userMsgNftyUrl||"https://ntfy.sh/")+'" target="_ntfy">Free service at ntfy.sh</a></div>',xxdialogTag="VerifyMessaging",setModalContent("xxAddAgent","Messaging Notifications",e+='<div id=d2slackinfo style=display:none><br /><a href=https://api.slack.com/messaging/webhooks target="_slack">Slack Webhook Setup</a></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",account_manageMessagingAdd()),Q("d2handleinput").focus(),account_manageMessagingValidate))()}function account_manageMessagingValidate(e){serverinfo.discordUrl&&QV("d2discordurl",4==Q("d2serviceselect").value),QV("d2callmebotinfo",16==Q("d2serviceselect").value),QV("d2pushoverinfo",32==Q("d2serviceselect").value),QV("d2ntfyinfo",64==Q("d2serviceselect").value),QV("d2slackinfo",256==Q("d2serviceselect").value),4==Q("d2serviceselect").value?Q("d2handleinput").placeholder="Username:0000":8==Q("d2serviceselect").value?Q("d2handleinput").placeholder="username@server.com":16==Q("d2serviceselect").value?Q("d2handleinput").placeholder="https://api.callmebot.com/...":32==Q("d2serviceselect").value?Q("d2handleinput").placeholder="User key":64==Q("d2serviceselect").value?Q("d2handleinput").placeholder="主題":128==Q("d2serviceselect").value?Q("d2handleinput").placeholder="username@sample.com":256==Q("d2serviceselect").value?Q("d2handleinput").placeholder="https://hooks.slack.com/...":Q("d2handleinput").placeholder="用戶名";var t=0<Q("d2handleinput").value.length;QE("idx_dlgOkButton",t),1==e&&t&&dialogclose(1)}function account_manageMessagingAdd(){0!=Q("d2handleinput").value.length&&(QE("d2handleinput",!1),meshserver.send({action:"verifyMessaging",service:Q("d2serviceselect").value,handle:Q("d2handleinput").value}))}function account_manageMessagingConfirm(e,t){meshserver.send({action:"confirmMessaging",code:Q("d2phoneCodeInput").value,cookie:t})}function account_manageMessagingRemove(){Q("d2delPhone").checked&&meshserver.send({action:"removeMessaging"})}function account_manageAuthEmail(){var e;xxdialogMode||0==(8388608&features)||(setModalContent("xxAddAgent","電郵認證",'啟用後，每次登入時，你都可以選擇向電郵帳戶接收登入保安編碼，以提高安全性。<br /><br /><label><input id=email2facheck type=checkbox class="form-check-input me-2" '+((e=1==userinfo.otpekey&&null!=userinfo.email&&1==userinfo.emailVerified)?"checked":"")+"/>啟用電郵二因子鑑別。</label>"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){e!=Q("email2facheck").checked&&meshserver.send({action:"otpemail",enabled:Q("email2facheck").checked})}))}function account_manageAuthDuo(){xxdialogMode||0==(536870912&features2)||(0==(1==userinfo.otpduo)?(setModalContent("xxAddAgent","Duo Authentication",'Confirm enabling of Duo 2FA login security. Once enabled you will be given the option to use Duo at login for added security. Click ok to go thru the steps to enable Duo.<p style="text-align:center;margin-top:10px"><img src="images/duo-2fa-250.png"></p>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){window.location.href="/add-duo?rurl="+encodeURIComponentEx(window.location.href)+(urlargs.key?"&key="+urlargs.key:"")})):(setModalContent("xxAddAgent","Duo Authentication",'<p><label><input id=duo2facheck type=checkbox onclick=account_manageAuthDuoConfirm() /> Confirm disabling 2FA Duo login security.</label></p><p style="text-align: center"><img src="images/duo-2fa-250-disable.png"></p>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){meshserver.send({action:"otpduo",enabled:!1})}),QE("idx_dlgOkButton",!1)))}function account_manageAuthDuoConfirm(){QE("idx_dlgOkButton",Q("duo2facheck").checked)}function account_manageAuthApp(){if(!xxdialogMode&&0!=(4096&features))return(1==userinfo.otpsecret?account_removeOtp:account_addOtp)(),!1}function account_addOtp(){xxdialogMode||1==userinfo.otpsecret||0==(4096&features)||(xxdialogTag="otpauth-request",setModalContent("xxAddAgent","認證軟體","<div id=d2optinfo>載入中...</div>"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){meshserver.send({action:"otpauth-setup",secret:Q("d2optsecret").attributes.secret.value,token:Q("d2otpauthinput").value})}),meshserver.send({action:"otpauth-request"}))}function account_addOtpCheck(e){var t=6==Q("d2otpauthinput").value.length;QE("idx_dlgOkButton",t),e&&13==e.keyCode&&t&&dialogclose(1)}function account_removeOtp(){xxdialogMode||1!=userinfo.otpsecret||0==(4096&features)||(setModalContent("xxAddAgent","認證軟體","確認刪除身份驗證軟體兩步登入？"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){meshserver.send({action:"otpauth-clear"})}))}function account_manageOtp(e){return 2==xxdialogMode&&"otpauth-manage"==xxdialogTag&&dialogclose(0),xxdialogMode||0==(4096&features)||0<count2factoraAuths()&&meshserver.send({action:"otpauth-getpasswords",subaction:e}),!1}function account_managePushAuthDev(){if(!xxdialogMode&&0!=(64&features2)){if(1==userinfo.otpdev)setModalContent("xxAddAgent","認證設備","確認移除推送認證設備？"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){meshserver.send({action:"otpdev-clear"})});else{var e=[];for(n in nodes){var t=nodes[n];null!=t.agent&&14==t.agent.id&&1==t.pmt&&4294967295==GetNodeRights(t)&&e.push(t)}if(0==e.length)setModalContent("xxAddAgent","認證設備","In order to use push notification authentication, a mobile device must be setup in your account with full rights."),showModal("xxAddAgentModal","idx_dlgOkButton");else{var n,o="選擇要註冊推送通知身份驗證的設備。選擇後，設備將提示確認。<br /><br />",i='<select id=d2devselect class="form-select">';for(n in e)i+='<option value="'+e[n]._id+'">'+EscapeHtml(e[n].name)+"</option>";setModalContent("xxAddAgent","認證設備",o+=addHtmlFormFloating("裝置",i+="</select>")),showModal("xxAddAgentModal","idx_dlgOkButton",function(){meshserver.send({action:"otpdev-set",nodeid:Q("d2devselect").value})})}}return!1}}function account_manageHardwareOtp(){return 2==xxdialogMode&&"otpauth-hardware-manage"==xxdialogTag&&dialogclose(0),xxdialogMode||0==(4096&features)||meshserver.send({action:"otp-hkey-get"}),!1}function account_addhkey(e){var t;3==e?(t="輸入要新增的密鑰的名稱。<br /><br />",t+=addHtmlFormFloating("鍵名",'<input id=dp1keyname class="form-control" maxlength=20 autocomplete=off placeholder="我的密鍵" onkeyup=account_addhkeyValidate(event,2) />')):2==e&&(t="輸入密鑰名稱，選擇OTP框，然後按YubiKey&trade;上的按鈕。<br /><br />",t=(t+=addHtmlFormFloating("鍵名",'<input id=dp1keyname class="form-control" maxlength=20 autocomplete=off placeholder="我的密鍵" onkeyup=account_addhkeyValidate(event,1) />'))+addHtmlFormFloating("YubiKey&trade;OTP",'<input id=dp1key class="form-control" autocomplete=off onkeyup=account_addhkeyValidate(event,2) />')),setModalContent("xxAddAgent","新增安全密鑰",t),showModal("xxAddAgentModal","idx_dlgOkButton",()=>account_addhkeyEx(3,e)),Q("dp1keyname").focus()}function account_addhkeyValidate(e,t){null!=e&&13==e.keyCode&&(2==t?dialogclose(1):Q("dp1key").focus())}function account_addhkeyEx(e,t){var n=Q("dp1keyname").value;""==n&&(n="MyKey"),2==t?(meshserver.send({action:"otp-hkey-yubikey-add",name:n,otp:Q("dp1key").value}),xxdialogTag="otpauth-hardware-manage",setModalContent("xxAddAgent","新增安全密鑰","<br />檢查...<br /><br /><br />"),showModal("xxAddAgentModal","idx_dlgOkButton")):3==t&&meshserver.send({action:"webauthn-startregister",name:n})}function account_removehkey(e){meshserver.send({action:"otp-hkey-remove",index:e}),meshserver.send({action:"otp-hkey-get"})}var currentMesh,filetreelinkpath,loclist={af:"南非文",sq:"阿爾巴尼亞文",ar:"阿拉伯文（標準）","ar-dz":"阿拉伯文（阿爾及利亞）","ar-bh":"阿拉伯文（巴林）","ar-eg":"阿拉伯文（埃及）","ar-iq":"阿拉伯文（伊拉克）","ar-jo":"阿拉伯文（約旦）","ar-kw":"阿拉伯文（科威特）","ar-lb":"阿拉伯文（黎巴嫩）","ar-ly":"阿拉伯文（利比亞）","ar-ma":"阿拉伯文（摩洛哥）","ar-om":"阿拉伯文（阿曼）","ar-qa":"阿拉伯文（卡塔爾）","ar-sa":"阿拉伯文（沙特阿拉伯）","ar-sy":"阿拉伯文（敘利亞）","ar-tn":"阿拉伯文（突尼斯）","ar-ae":"阿拉伯文（阿聯酋）","ar-ye":"阿拉伯文（也門）",an:"阿拉貢文",hy:"亞美尼亞文",as:"阿薩姆文",ast:"阿斯圖里亞斯文",az:"阿塞拜疆文",eu:"巴斯克",bg:"保加利亞文",be:"白俄羅斯文",bn:"孟加拉",bs:"波斯尼亞文",br:"布列塔尼",my:"緬甸文",ca:"加泰羅尼亞文",ch:"查莫羅",ce:"車臣",zh:"中文","zh-hk":"中文（香港）","zh-cn":"中文（中國）","zh-sg":"中文（新加坡）","zh-tw":"中文（台灣）",cv:"楚瓦什",co:"科西嘉文",cr:"克里語",hr:"克羅地亞文",cs:"捷克文",da:"丹麥文",nl:"荷蘭文（標準）","nl-be":"荷蘭文（比利時）",en:"英文","en-au":"英文（澳洲）","en-bz":"英文（伯利茲）","en-ca":"英文（加拿大）","en-ie":"英文（愛爾蘭）","en-jm":"英文（牙買加）","en-nz":"英文（紐西蘭）","en-ph":"英文（菲律賓）","en-za":"英語（南非）","en-tt":"英文（特立尼達和多巴哥）","en-gb":"英文（英國）","en-us":"美國英語","en-zw":"英文（津巴布韋）",eo:"世界語",et:"愛沙尼亞語",fo:"法羅語",fa:"波斯語（波斯語）",fj:"斐濟",fi:"芬蘭",fr:"法語（標準）","fr-be":"法語（比利時）","fr-ca":"法語（加拿大）","fr-fr":"法語（法國）","fr-lu":"法語（盧森堡）","fr-mc":"法語（摩納哥）","fr-ch":"法語（瑞士）",fy:"弗里斯蘭語",fur:"弗留利",gd:"蓋爾語（蘇格蘭語）","gd-ie":"蓋爾語（愛爾蘭）",gl:"加拉契語",ka:"格魯吉亞文",de:"德語（標準）","de-at":"德語（奧地利）","de-de":"德文（德國）","de-li":"德文（列支敦士登）","de-lu":"德語（盧森堡）","de-ch":"德文（瑞士）",el:"希臘文",gu:"古久拉提",ht:"海地文",he:"希伯來文",hi:"印地文",hu:"匈牙利文",is:"冰島文",id:"印度尼西亞文",iu:"因紐特文",ga:"愛爾蘭文",it:"意大利文（標準）","it-ch":"義大利文（瑞士）",ja:"日文",kn:"卡納達文",ks:"克什米爾文",kk:"哈薩克文",km:"高棉文",ky:"吉爾吉斯",tlh:"克林貢",ko:"韓文","ko-kp":"韓文（朝鮮）","ko-kr":"韓文（韓國）",la:"拉丁文",lv:"拉脫維亞文",lt:"立陶宛文",lb:"盧森堡文",mk:"FYRO馬其頓語",ms:"馬來文",ml:"馬拉雅拉姆文",mt:"馬耳他文",mi:"毛利文",mr:"馬拉地文",mo:"摩爾達維亞文",nv:"納瓦霍文",ng:"恩東加",ne:"尼泊爾文",no:"挪威文",nb:"挪威文（Bokmal）",nn:"挪威文（尼諾斯克）",oc:"歐舒丹",or:"奧里亞",om:"奧羅莫","fa-ir":"波斯/伊朗",pl:"波蘭文",pt:"葡萄牙文","pt-br":"葡萄牙文（巴西）",pa:"旁遮普文","pa-in":"旁遮普（印度）","pa-pk":"旁遮普（巴基斯坦）",qu:"蓋丘亞族",rm:"雷托-羅曼語",ro:"羅馬尼亞文","ro-mo":"羅馬尼亞文（摩爾達維亞）",ru:"俄文","ru-mo":"俄文（摩爾達維亞）",sz:"薩米（拉普蘭）",sg:"三鄉",sa:"梵文",sc:"撒丁島",sd:"信地",si:"僧伽羅文",sr:"塞爾維亞",sk:"斯洛伐克文",sl:"斯洛文尼亞文",so:"索馬尼",sb:"索比亞文",es:"西班牙文","es-ar":"西班牙文（阿根廷）","es-bo":"西班牙文（玻利維亞）","es-cl":"西班牙文（智利）","es-co":"西班牙文（哥倫比亞）","es-cr":"西班牙文（哥斯達黎加）","es-do":"西班牙文（多米尼加共和國）","es-ec":"西班牙文（厄瓜多爾）","es-sv":"西班牙文（薩爾瓦多）","es-gt":"西班牙文（危地馬拉）","es-hn":"西班牙文（洪都拉斯）","es-mx":"西班牙文（墨西哥）","es-ni":"西班牙文（尼加拉瓜）","es-pa":"西班牙文（巴拿馬）","es-py":"西班牙文（巴拉圭）","es-pe":"西班牙文（秘魯）","es-pr":"西班牙文（波多黎各）","es-es":"西班牙文（西班牙）","es-uy":"西班牙文（烏拉圭）","es-ve":"西班牙文（委內瑞拉）",sx:"蘇圖",sw:"斯瓦希里文",sv:"瑞典文","sv-fi":"瑞典文（芬蘭）","sv-sv":"瑞典文（瑞典）",ta:"泰米爾文",tt:"塔塔爾族",te:"泰盧加",th:"泰國",tig:"蒂格雷",ts:"特松加",tn:"茨瓦納",tr:"土耳其",tk:"土庫曼文",uk:"烏克蘭",hsb:"上索布族",ur:"烏爾都文",ve:"文達",vi:"越南文",vo:"沃拉普克",wa:"瓦隆",cy:"威爾士文",xh:"科薩",ji:"意第緒文",zu:"祖魯族"},loclistex={"zh-chs":"簡體中文","zh-cht":"繁體中文"};function account_showLocalizationSettings(){if(!xxdialogMode){var e=getstore("loctag",0),t="",n='<select id=d2locselect class="form-select"><option value="*">用戶瀏覽器值</option>';for(o in loclist)n+='<option value="'+o+'"'+(e==o?" selected":"")+">"+o+" - "+loclist[o]+"</option>";if(n+="</select>",serverinfo.languages&&0<serverinfo.languages.length){t+="更改語言將需要刷新頁面。<br /><br />";var o,i='<select id=d2langselect class="form-select"><option value="*">用戶瀏覽器值</option>';for(o in serverinfo.languages){var s=serverinfo.languages[o];i+='<option value="'+s+'"'+(userinfo.lang==s?" selected":"")+">"+s+" - "+(loclist[s]||loclistex[s])+"</option>"}t+=addHtmlFormFloating("語言",i+="</select>")}t+=addHtmlFormFloating("日期和時間",n),4294967295==userinfo.siteadmin&&""==domain&&(t+='<br /><a rel="noreferrer noopener" target="_blank" href="translator.htm">幫助翻譯MeshCentral</a>'),setModalContent("xxAddAgent","本地化設置",t),showModal("xxAddAgentModal","idx_dlgOkButton",account_showLocalizationSettingsEx)}return!1}function account_showLocalizationSettingsEx(){var e=Q("d2langselect"),e=e?e.value:null,e=((e="*"==e&&null==userinfo.lang?userinfo.lang:e)!=userinfo.lang&&meshserver.send({action:"changelang",lang:e}),getstore("loctag",0)),t=Q("d2locselect").value;e!=t&&("*"!=t?args.locale=t:delete args.locale,putstore("loctag",args.locale),mainUpdate(4294967295))}function account_enableNotifications(){return Notification&&Notification.requestPermission().then(function(e){QV("accountEnableNotificationsSpan","granted"!=e),setupServiceWorker()}),!1}function account_createLoginToken(){if(xxdialogMode)return!1;var e,t="",n="創建一個臨時用戶名和密碼，可用作您帳戶的替代登錄名。這對於允許工具或其他服務訪問您的帳戶很有用。<br /><br />",o={0:"無限",1:"1分鐘",5:"5分鐘",10:"10分鐘",15:"15分鐘",30:"30分鐘",45:"45分鐘",60:"60分鐘",120:"2小時",240:"4個小時",480:"8小時",720:"12小時",960:"16小時",1440:"24小時",2880:"2天",5760:"4天",10080:"7天"};for(e in o)t+="<option value="+e+">"+o[e]+"</option>";setModalContent("xxAddAgent","創建登錄令牌",n+'<div class="form-floating mb-3">'+'<input type=text class="boxsize form-control" id=d2tokenName maxlength="100" placeholder="令牌名稱" onchange=account_createLoginTokenValidate() onkeyup=account_createLoginTokenValidate()>'+"<label for=d2tokenName>令牌名稱</label>"+"</div>"+addHtmlFormFloating("到期時間",'<select class="boxsize form-select" id=d2tokenExpire>'+t+"</select>")),showModal("xxAddAgentModal","idx_dlgOkButton",account_createLoginTokenEx),QE("idx_dlgOkButton",!1),Q("d2tokenName").focus()}function account_createLoginTokenValidate(){QE("idx_dlgOkButton",0<Q("d2tokenName").value.length)}function account_createLoginTokenEx(){meshserver.send({action:"createLoginToken",name:Q("d2tokenName").value,expire:parseInt(Q("d2tokenExpire").value)})}function account_showAccountNotifySettings(){var e;return xxdialogMode||(setModalContent("xxAddAgent","通知設定",'<div class="form-check"><label><input id=p2notifyPlayNotifySound class="form-check-input me-2" type=checkbox />通知音效</label></div><div class="form-check"><label><input id=p2notifyGroupName class="form-check-input me-2" type=checkbox />顯示裝置群名稱</label></div><div class="form-check"><label><input id=p2notifyIntelDeviceConnect class="form-check-input me-2" type=checkbox />裝置連接。</label></div><div class="form-check"><label><input id=p2notifyIntelDeviceDisconnect class="form-check-input me-2" type=checkbox />裝置斷開連接。</label></div><div class="form-check"><label><input id=p2notifyIntelAmtKvmActions class="form-check-input me-2" type=checkbox />Intel&reg; AMT桌面和串行事件</label></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",account_showAccountNotifySettingsEx),e=getstore("notifications",0),Q("p2notifyPlayNotifySound").checked=1&e,Q("p2notifyIntelDeviceConnect").checked=2&e,Q("p2notifyIntelDeviceDisconnect").checked=4&e,Q("p2notifyIntelAmtKvmActions").checked=8&e,Q("p2notifyGroupName").checked=16&e),!1}function account_showAccountNotifySettingsEx(){var e=0;putstore("notifications",(e+=Q("p2notifyPlayNotifySound").checked?1:0)+(Q("p2notifyIntelDeviceConnect").checked?2:0)+(Q("p2notifyIntelDeviceDisconnect").checked?4:0)+(Q("p2notifyIntelAmtKvmActions").checked?8:0)+(Q("p2notifyGroupName").checked?16:0))}function account_showVerifyEmail(){return xxdialogMode||1==userinfo.emailVerified||1!=serverinfo.emailcheck||(setModalContent("xxAddAgent","電郵驗證","單擊確定將驗證電郵發送到：<br /><div style=padding:8px><b>"+EscapeHtml(userinfo.email)+"</b></div>請等待幾分鐘以接收驗證。"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>account_showVerifyEmailEx())),!1}function account_showVerifyEmailEx(){meshserver.send({action:"verifyemail",email:userinfo.email})}function account_showChangeEmail(){return xxdialogMode||(setModalContent("xxAddAgent","電郵地址變更",'在此處更改你的帳戶電郵地址。<br /><br /><div class="form-floating"><input id=dp2email class="form-control" maxlength=256 onchange=account_validateEmail() onkeyup=account_validateEmail(event) placeholder=Email /> <label for=dp2email>Email</label></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",account_changeEmail),null!=userinfo.email&&(Q("dp2email").value=userinfo.email),account_validateEmail(),Q("dp2email").focus()),!1}function account_validateEmail(e,t){QE("idx_dlgOkButton",validateEmail(Q("dp2email").value)&&Q("dp2email").value!=userinfo.email),null!=e&&13==e.keyCode&&dialogclose(1)}function account_changeEmail(){meshserver.send({action:"changeemail",email:Q("dp2email").value})}function account_showDeleteAccount(){return xxdialogMode||(setModalContent("xxAddAgent","刪除帳戶","要刪除此帳戶，請在下面的兩個框中鍵入帳戶密碼，然後單擊確定。<br /><br />"+"<form method=post>"+"<input type=hidden name=action value=deleteaccount />"+('<input type=hidden name=authcookie value="'+authCookie+'" />')+'<div class="container">'+'<div class="form-floating mb-2">'+'<input type=password class="form-control" id=apassword1 name=apassword1 autocomplete=off placeholder="Password" onchange=account_validateDeleteAccount() onkeyup=account_validateDeleteAccount()>'+'<label for="apassword1">Password</label>'+"</div>"+'<div class="form-floating mb-3">'+'<input type=password class="form-control" id=apassword2 name=apassword2 autocomplete=off placeholder="Confirm Password" onchange=account_validateDeleteAccount() onkeyup=account_validateDeleteAccount()>'+"<label for=apassword2>Confirm Password</label>"+"</div>"+"</div>"+"</form>"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){dialogclose(1)}),account_validateDeleteAccount(),Q("apassword1").focus()),!1}function account_showChangePassword(){if(!xxdialogMode){var e="在下面的框中兩次輸入舊密碼和新密碼，以更改帳戶密碼。",e=(e=(e=(e=(e=(e=(e=(e+="<br /><br />")+'<div class="container">'+'<div class="form-floating mb-2">')+'<input type=password class="form-control" id=apassword0 name=apassword0 autocomplete=off placeholder="Old password" onchange=account_validateNewPassword() onkeyup=account_validateNewPassword() onkeydown=account_validateNewPassword()>'+"<label for=apassword0>Old password</label>")+"</div>"+'<div class="form-floating mb-2">')+'<input type=password class="form-control" id=apassword1 name=apassword1 autocomplete=off placeholder="New password" onchange=account_validateNewPassword() onkeyup=account_validateNewPassword() onkeydown=account_validateNewPassword()>'+"<label for=apassword1>New password</label>")+"<b><span id=dxPassWarn></span></b>"+"</div>")+'<div class="form-floating mb-2">'+'<input type=password class="form-control" id=apassword2 name=apassword2 autocomplete=off placeholder="Confirm new password" onchange=account_validateNewPassword() onkeyup=account_validateNewPassword() onkeydown=account_validateNewPassword()>')+"<label for=apassword2>Confirm new password</label>"+"</div>";if(65536&features&&(e+='<div class="form-floating mb-2"><input type=text class="form-control" id=apasswordhint name=apasswordhint maxlength=250 autocomplete=off onchange=account_validateNewPassword() onkeyup=account_validateNewPassword() onkeydown=account_validateNewPassword()><label for=apasswordhint>Password hint</label></div>'),e+="</div>",passRequirements){var t,n=[],o=0;for(t in passRequirements)"reset"!=t&&"hint"!=t&&(n.push(t+":"+passRequirements[t]),o++);0<o&&(e+="<br /><span style=font-size:x-small>要求："+n.join(", ")+".</span>")}setModalContent("xxAddAgent","更改密碼",e+="<br />"),showModal("xxAddAgentModal","idx_dlgOkButton",account_showChangePasswordEx),Q("apassword0").focus(),account_validateNewPassword()}return!1}function account_showChangePasswordEx(){var e;Q("apassword1").value==Q("apassword2").value&&(e={action:"changepassword",oldpass:Q("apassword0").value,newpass:Q("apassword1").value},65536&features&&(e.hint=Q("apasswordhint").value),meshserver.send(e))}function account_showThemesSwitcher(){var n,e,o,i;return xxdialogMode||(n=getstore("theme")||"default",e=JSON.parse(getstore("lastThemes")||"[]"),o=new Set(e),i='<div class="form-group"><label for="theme-switcher">Select a theme:</label>',i+='<select id="theme-switcher" class="form-select" onchange="account_switchThemeEx()">',0<e.length&&(i+='<optgroup label="Recent Themes"">',e.forEach(function(e){i+=`<option value="${e}"${e===n?" selected":""}>${e.charAt(0).toUpperCase()+e.slice(1)}</option>`}),i+="</optgroup>"),i+='<optgroup label="All Themes">',[{value:"default",label:"默認"},{value:"cerulean",label:"Cerulean"},{value:"cosmo",label:"Cosmo"},{value:"cyborg",label:"Cyborg"},{value:"darkly",label:"Darkly"},{value:"flatly",label:"Flatly"},{value:"journal",label:"Journal"},{value:"litera",label:"Litera"},{value:"lumen",label:"Lumen"},{value:"lux",label:"Lux"},{value:"materia",label:"Materia"},{value:"minty",label:"Minty"},{value:"morph",label:"Morph"},{value:"pulse",label:"Pulse"},{value:"sandstone",label:"Sandstone"},{value:"simplex",label:"Simplex"},{value:"sketchy",label:"Sketchy"},{value:"solar",label:"Solar"},{value:"spacelab",label:"Spacelab"},{value:"united",label:"United"},{value:"vapor",label:"Vapor"},{value:"yeti",label:"Yeti"},{value:"zephyr",label:"Zephyr"}].forEach(function(e){var t;o.has(e.value)||(t=e.value===n?" selected":"",i+=`<option value="${e.value}"${t}>${e.label}</option>`)}),setModalContent("xxAddAgent","Switch theme",i=i+"</optgroup>"+"</select></div>"),showModal("xxAddAgentModal","idx_dlgOkButton")),!1}function account_switchThemeEx(){let e=document.getElementById("theme-switcher"),t=e.value;var n="default"!=t?encodeURIComponent(t):encodeURIComponent(".."),n=(document.getElementById("theme-stylesheet").href=`styles/themes/${n}/bootstrap-min.css`,putstore("theme",t),JSON.parse(getstore("lastThemes")||"[]"));(n.includes(t)?n=n.filter(e=>e!==t):(4<=n.length&&n.pop(),n)).unshift(t),putstore("lastThemes",JSON.stringify(n))}function account_createMesh(){if(4294967295!=userinfo.siteadmin&&0!=(64&userinfo.siteadmin))setModalContent("xxAddAgent","新裝置群","This account does not have the rights to create a new device group."),showModal("xxAddAgentModal","idx_dlgOkButton");else if(!0!==userinfo.emailVerified&&1==serverinfo.emailcheck&&4294967295!=userinfo.siteadmin)setModalContent("xxAddAgent","帳號安全",'Unable to access this feature until a email address is verified. This is required for password recovery. Go to the "My Account" tab to change and verify an email address.'),showModal("xxAddAgentModal","idx_dlgOkButton");else if(262144&features&&0==count2factoraAuths())setModalContent("xxAddAgent","帳號安全",'Unable to access this feature until two-factor authentication is enabled. This is required for extra security. Go to the "My Account" tab and look at the "Account Security" section.'),showModal("xxAddAgentModal","idx_dlgOkButton");else{var e=[];if(0==(2&features))for(var t in nodes){var n=nodes[t];2==n.mtype&&null!=n.agent&&4294967295==GetNodeRights(n)&&e.push(n)}var o="使用以下選項創建一個新的裝置群。<br /><br />",i="";if(o+=addHtmlFormFloating("名稱",'<input id=dp2meshname maxlength=128 placeholder="Name" class=form-control onchange=account_validateMeshCreate() onkeyup=account_validateMeshCreate(event,1) />'),0==(1&features)&&(i+="<option value=3>本地設備，無代理</option>"),0==(2&features)&&0<e.length&&(i+="<option value=103>沒有代理設備通過代理中繼</option>"),65536&features2&&(0==(1&features)&&(i+="<option value=4>IP-KVM / 電源設備</option>"),0==(2&features))&&0<e.length&&(i+="<option value=104>IP-KVM / 通過代理中繼的電源設備</option>"),o+=addHtmlFormFloating("類型","<select id=dp2meshtype class=form-select onchange=account_validateMeshCreate() onkeyup=account_validateMeshCreate(event,2) ><option value=2>使用軟體代理進行管理</option><option value=1>僅限Intel&reg; AMT，無代理</option>"+i+"</select>"),0<e.length){o+="<div id=d2devrelaydiv style=display:none>",e.sort(nameSort);var s=[];for(t in e)s.push('<option value="'+e[t]._id+'">'+EscapeHtml(e[t].name)+"</option>");o=o+addHtmlFormFloating("繼電器裝置","<select id=d2devrelay onchange=account_validateMeshCreate() onkeyup=account_validateMeshCreate(event,2) class=form-select >"+s.join("")+"</select>")+"</div>"}setModalContent("xxAddAgent","新裝置群",o=(o=(o=(o=(o=o+addHtmlFormFloating("描述","<textarea id=dp2meshdesc maxlength=1024 class=form-control></textarea>")+"<div id=d2ipkvm style=display:none><hr />")+addHtmlFormFloating("模型","<select id=dp2ipkvmmodel onchange=account_validateMeshCreate() onkeyup=account_validateMeshCreate(event,2) class=form-select ><option value=1>力登 Dominion KX III</option><option value=2>網頁電源開關 7</option></select>"))+addHtmlFormFloating("主機名",'<input id=dp2ipkvmhost maxlength=128 placeholder="Hostname" onchange=account_validateMeshCreate() onkeyup=account_validateMeshCreate(event,1) class=form-control />'))+addHtmlFormFloating("用戶名",'<input id=dp2ipkvmuser maxlength=128 placeholder="Username" onchange=account_validateMeshCreate() onkeyup=account_validateMeshCreate(event,1) class=form-control />'))+addHtmlFormFloating("密碼",'<input id=dp2ipkvmpass type=password placeholder="Password" maxlength=128 onchange=account_validateMeshCreate() onkeyup=account_validateMeshCreate(event,1) class="form-control" />')+"</div>"),showModal("xxAddAgentModal","idx_dlgOkButton",account_createMeshEx),account_validateMeshCreate(),document.getElementById("dp2meshname").focus()}return!1}function account_validateMeshCreate(e,t){var n=parseInt(Q("dp2meshtype").value),t=(1==t&&null!=e&&"輸入"==e.key&&0<Q("dp2meshname").value.length&&Q("dp2meshtype").focus(),2==t&&null!=e&&"輸入"==e.key&&Q("dp2meshdesc").focus(),0<Q("dp2meshname").value.length);QV("d2ipkvm",4==n||104==n);try{QV("d2devrelaydiv",100<n)}catch(e){}4==n&&0==Q("dp2ipkvmhost").value.length&&0==Q("dp2ipkvmuser").value.length&&0==Q("dp2ipkvmpass").value.length&&(t=!1),QE("idx_dlgOkButton",t)}function account_createMeshEx(e,t){var n=parseInt(Q("dp2meshtype").value),o={action:"createmesh",meshname:Q("dp2meshname").value,meshtype:n,desc:Q("dp2meshdesc").value};4!=n&&104!=n||(o.kvmmodel=parseInt(Q("dp2ipkvmmodel").value),o.kvmhost=Q("dp2ipkvmhost").value,o.kvmuser=Q("dp2ipkvmuser").value,o.kvmpass=Q("dp2ipkvmpass").value),100<n&&(o.meshtype=n-100,o.relayid=Q("d2devrelay").value),meshserver.send(o)}function account_validateDeleteAccount(){QE("account_dlgOkButton",0<Q("apassword1").value.length&&Q("apassword1").value==Q("apassword2").value)}function account_validateNewPassword(){var e,t="",n=0<Q("apassword0").value.length&&0<Q("apassword1").value.length&&Q("apassword1").value==Q("apassword2").value&&Q("apassword0").value!=Q("apassword1").value;65536&features&&Q("apasswordhint").value==Q("apassword1").value&&(n=!1),""!=Q("apassword1").value&&(null==passRequirements||""==passRequirements?t=80<=(e=checkPasswordStrength(Q("apassword1").value))?"<span style=color:green>強<span>":60<=e?"<span style=color:blue>好<span>":"<span style=color:red>弱<span>":0==checkPasswordRequirements(Q("apassword1").value,passRequirements)&&(n=!1,t="<span style=color:red>政策<span>")),QH("dxPassWarn",t),QE("idx_dlgOkButton",n)}function checkPasswordStrength(e){var t=0,n={},o=0,i={digits:/\d/.test(e),lower:/[a-z]/.test(e),upper:/[A-Z]/.test(e),nonWords:/\W/.test(e)};if(!e)return 0;for(var s,a=0;a<e.length;a++)n[e[a]]=(n[e[a]]||0)+1,t+=5/n[e[a]];for(s in i)o+=1==i[s]?1:0;return parseInt(t+10*(o-1))}function checkPasswordRequirements(e,t){if(null==t||""==t||"object"!=typeof t)return!0;if(t.min&&e.length<t.min)return!1;if(t.max&&e.length>t.max)return!1;for(var n=0,o=0,i=0,s=0,a=0;a<e.length;a++)/\d/.test(e[a])&&n++,/[a-z]/.test(e[a])&&o++,/[A-Z]/.test(e[a])&&i++,/\W/.test(e[a])&&s++;return!(t.numeric&&n<t.numeric||t.lower&&o<t.lower||t.upper&&i<t.upper||t.nonalpha&&s<t.nonalpha)}function updateMeshes(){var e='<div class="row">',t=0,n=0,o=[];for(i in meshes)o.push(meshes[i]);for(i in o.sort(nameSort),o){1<t&&(e+="</tr><tr>",t=0),t++,n++;var s=GetMeshRights(o[i]),a="部分權限";4294967295==s?a="完整管理員":0==s&&(a="沒有權利"),e+=`
                    <div class="col-sm-12 col-md-6 col-lg-4 col-xl-3 mb-2"
                            onclick="gotoMesh('`+o[i]._id+`')"
                            onkeypress="if (event.key=='Enter') gotoMesh('`+o[i]._id+`')"
                            style="cursor:pointer;">
                        <div class="card mb-3">
                            <div class="row g-0">
                                <div class="col-2 parent" style="display: flex; justify-content: center; align-items: center;">
                                    <i class="mi me-1"></i>
                                </div>
                                <div class="col-10 mx-auto" tabindex="0">
                                    <div class="card-body" style=padding:0;>
                                        <h5 class="card-title e1">`+EscapeHtml(o[i].name)+`</h5>
                                        <p class="card-text">`+a+`</p>
                                        <div class="g2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    `}e+="</div>",meshcount=n,QH("p2meshes",e),QV("p2noMeshFound",0==n)}function updateLoginTokens(){var e="",t=1;if(null!=loginTokens&&0<loginTokens.length){for(var e=e+'<p><strong>活動登錄令牌</strong> - <span id="p2createMeshLink1"> <button class="btn btn-primary btn-sm" onclick="return account_createLoginToken()"><i class="fa-fw fa-solid fa-circle-plus"></i> 新</button></span></p>'+'<div style=margin-left:40px><table class="table table-hover table-striped"><tbody><tr class="table-active"><th scope=col style=text-align:left;width:430px>名稱</th><th scope=col style=text-align:left>用戶名</th></tr>',n=0;n<loginTokens.length;n++){var o=loginTokens[n],i="<a href=# onclick='return p2removeLoginToken(event,\""+encodeURIComponentEx(o.tokenUser)+'")\' title="刪除登錄令牌" role=button><i class="fa-solid fa-trash text-danger fa-xs"></i></a>',s="";0!=o.expire&&(s=EscapeHtml(format("過期{0}",printDateTime(new Date(o.expire))))+" "),e+="<tr "+(++t%2==0?"style=background-color:#DDD":"")+'><td style=width:30%><i class="fa-fw fa-solid fa-user"></i>&nbsp;'+EscapeHtml(o.name)+"<div></div></div></td><td style=width:70%><div style=float:right>"+s+i+"</div><div>"+EscapeHtml(o.tokenUser)+"</div></td></tr>"}e+="</tbody></table></div><br />",QV("accountCreateLoginTokenSpan",!1)}else QV("accountCreateLoginTokenSpan",128&features2);QH("p2logintokens",e)}function p2removeLoginToken(e,t){if(t=decodeURIComponent(t),null!=loginTokens){for(var n,o=null,i=0;i<loginTokens.length;i++)loginTokens[i].tokenUser==t&&(o=loginTokens[i]);null!=o&&(n="確認刪除此登錄令牌？<br /><br />",setModalContent("xxAddAgent","刪除登錄令牌",n=(n+=addHtmlValue("名稱",EscapeHtml(o.name)))+addHtmlValue("用戶名",EscapeHtml(o.tokenUser))),showModal("xxAddAgentModal","idx_dlgOkButton",()=>function(e,t){meshserver.send({action:"loginTokens",remove:[t]})}))}}function gotoMesh(e){return currentMesh=meshes[e],p20updateMesh(),go(20),!1}function server_setupGoogleDriveBackup(){if(xxdialogMode||null==miscState.googleDrive)return!1;var e,t=miscState.googleDrive;t.state<3?(e='<img style=float:right src="images/googledrive-48.png" /><div>將此服務器設置為自動將備份上傳到Google雲端硬盤。首先為您的帳戶創建並輸入Google Drive ClientID和ClientSecret。</div><br />',setModalContent("xxAddAgent","Google雲端硬盤備份",e=(e=(e+=addHtmlValue("證書",'<a href="https://console.developers.google.com/apis/api/drive.googleapis.com/credentials" rel="noreferrer noopener" target="_blank">Google雲端硬盤控制台</a>'))+addHtmlFormFloating("客戶編號",'<input id=gdclientid class="form-control" placeholder="xxxxxxxx.apps.googleusercontent.com" onkeyup=server_setupGoogleDriveBackupCheck1()></input>'))+addHtmlFormFloating("客戶機密",'<input id=gdclientsecret class="form-control" onkeyup=server_setupGoogleDriveBackupCheck1()></input>')),showModal("xxAddAgentModal","idx_dlgOkButton",()=>server_setupGoogleDriveBackupEx(3,"gd1")),Q("gdclientid").focus(),QE("idx_dlgOkButton",!1)):3==t.state&&(e='<img style=float:right src="images/googledrive-48.png" /><div>Google雲端硬盤備份當前處於活動狀態。</div>',setModalContent("xxAddAgent","Google雲端硬盤備份",e+='<br /><label><input id=gdcheck type=checkbox class="form-check-input me-2" onchange=server_setupGoogleDriveBackupCheck2() />刪除配置</label>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>server_setupGoogleDriveBackupEx(3,"gd0")),QE("idx_dlgOkButton",!1))}function server_setupGoogleDriveBackupCheck1(){QE("idx_dlgOkButton",0<Q("gdclientid").value.length&&0<Q("gdclientsecret").value.length)}function server_setupGoogleDriveBackupCheck2(){QE("idx_dlgOkButton",Q("gdcheck").checked)}function server_setupGoogleDriveBackupCheck3(){QE("idx_dlgOkButton",0<Q("gdcode").value.length)}function server_setupGoogleDriveBackupEx(e,t){"gd0"==t&&meshserver.send({action:"serverBackup",service:"googleDrive",state:0}),"gd1"==t&&meshserver.send({action:"serverBackup",service:"googleDrive",state:1,clientid:Q("gdclientid").value,clientsecret:Q("gdclientsecret").value}),"gd2"==t&&meshserver.send({action:"serverBackup",service:"googleDrive",state:2,code:Q("gdcode").value})}function server_showRestoreDlg(){var e;return xxdialogMode||(e="使用備份還原伺服器， <span style=color:red>這將刪除現有伺服器數據。</span> 僅當你知道自己在做什麼時才這樣做。<br /><br />",setModalContent("xxAddAgent","還原伺服器",e=(e=(e+='<form action="/restoreserver.ashx'+(urlargs.key?"?key="+urlargs.key:"")+'" enctype="multipart/form-data" method="post"><div>')+("<input type=hidden name=auth value="+authCookie+">"))+'<input id=account_dlgFileInput type=file name=datafile class="form-control" accept=".zip,application/octet-stream,application/zip,application/x-zip,application/x-zip-compressed" onchange=account_validateServerRestore()>'+"</div></form>"),showModal("xxAddAgentModal","idx_dlgOkButton"),account_validateServerRestore()),!1}function account_validateServerRestore(){QE("idx_dlgOkButton",1==Q("account_dlgFileInput").files.length)}function server_showVersionDlg(){return xxdialogMode||(xxdialogMode=2,xxdialogTag="MeshCentralServerUpdate",setModalContent("xxAddAgent","MeshCentral版本","載入中..."),showModal("xxAddAgentModal","idx_dlgOkButton"),meshserver.send({action:"serverversion"})),!1}function server_showVersionDlgUpdate(){var e=Q("d2updateCheck1").checked,t=Q("d2updateCheck2").checked;QE("d2updateCheck1","未知"!=xxdialogTag.stable&&xxdialogTag.current!=xxdialogTag.stable&&0==t),QE("d2updateCheck2","未知"!=xxdialogTag.latest&&xxdialogTag.current!=xxdialogTag.latest&&0==e),QE("idx_dlgOkButton",e&&!t||!e&&t)}function server_showVersionDlgEx(e,t){Q("d2updateCheck1").checked&&meshserver.send({action:"serverupdate",tag:"stable",version:t.stable}),Q("d2updateCheck2").checked&&meshserver.send({action:"serverupdate",tag:"latest",version:t.latest})}function server_showErrorsDlg(){return xxdialogMode||(xxdialogMode=2,xxdialogTag="MeshCentralServerErrors",setModalContent("xxAddAgent","Server Errors","載入中..."),meshserver.send({action:"servererrors"})),!1}function server_showErrorsDlgUpdate(){QE("idx_dlgOkButton",Q("d2clearErrorsCheck").checked)}function server_showErrorsDlgEx(){meshserver.send({action:"serverclearerrorlog"})}function d2CopyServerErrorsToClip(){saveAs(new Blob([Q("d2ServerErrorsLogPre").innerText],{type:"application/octet-stream"}),"servererrors.txt")}function server_showConfigDlg(){return xxdialogMode||(xxdialogMode=2,xxdialogTag="MeshCentralServerConfig",meshserver.send({action:"serverconfig"})),!1}function d2CopyServerConfigToClip(){saveAs(new Blob([Q("d2ServerConfigPre").innerText],{type:"application/octet-stream"}),"config.json")}function p20updateMesh(){if(null!=currentMesh){var e,t,n=GetMeshRights(currentMesh),o=EscapeHtml(currentMesh.name),i=(0==o.length&&(o="<i>沒有</i>"),0!=(1&n)&&(o='<span role=button tabindex=0 title="單擊此處編輯裝置群名稱" onclick=p20editmesh(1) onkeyup="if (event.key == \'Enter\') p20editmesh(1)">'+o+' <i class="fa-solid fa-pencil fa-2xs"></i></span>'),QH("p20meshName",o),QV("MeshSummary",4!=currentMesh.mtype),format("未知＃{0}",currentMesh.mtype)),s=(1==currentMesh.mtype&&(i="僅限Intel&reg; AMT，無代理"),2==currentMesh.mtype&&(i="使用軟體代理進行管理"),3==currentMesh.mtype&&(i=null==currentMesh.relayid?"本地設備，無代理":"沒有代理設備通過代理中繼"),4==currentMesh.mtype&&(i=null==currentMesh.relayid?"IP-KVM 設備":"通過代理中繼的 IP-KVM 設備",1==currentMesh.kvm.model)&&(i+=", Raritan KX III"),"");if(0!=(8&args.hide)&&(s+=addHtmlValue("名稱",o)),s=(s+=addHtmlValue("描述",addLinkConditional(currentMesh.desc&&""!=currentMesh.desc?EscapeHtml(currentMesh.desc):"<i>沒有</i>","p20editmesh(2)",0!=(1&n))))+addHtmlValue("類型",i),3!=currentMesh.mtype&&4!=currentMesh.mtype||null==currentMesh.relayid||(o="<i>未知</i>",s+=addHtmlValue("繼電器裝置",addLinkConditional(o=null!=(i=getNodeFromId(currentMesh.relayid))?EscapeHtml(i.name):o,"p20editmeshrelay()",0!=(1&n)))),4==currentMesh.mtype&&(s=(s+=addHtmlValue("主機名",currentMesh.kvm.host))+addHtmlValue("用戶名",currentMesh.kvm.user)),null!=currentMesh.creatorid&&null!=users&&null!=users[currentMesh.creatorid]?s+=addHtmlValue("創作者",'<a href=# onclick=gotoUser("'+encodeURIComponentEx((i=users[currentMesh.creatorid])._id)+'",false,null)>'+EscapeHtml(i.name)+"</a>"):null!=currentMesh.creatorname&&(s+=addHtmlValue("創作者",EscapeHtml(currentMesh.creatorname))),null!=currentMesh.creation&&(s+=addHtmlValue("創作時間",printDateTime(new Date(currentMesh.creation)))),3!=currentMesh.mtype&&(e=[],currentMesh.flags&&(1&currentMesh.flags&&e.push("自動刪除"),2&currentMesh.flags&&e.push(4==currentMesh.mtype?"端口名稱同步":"主機名同步"),1==serverinfo.devGroupSessionRecording)&&4&currentMesh.flags&&e.push("記錄會議"),"number"==typeof currentMesh.expireDevs&&0<currentMesh.expireDevs&&e.push("刪除非活動"),s+=addHtmlValue("功能",addLinkConditional(e=""==(e=e.join(", "))?"<i>沒有</i>":e,"p20editmeshfeatures()",1&n))),2==currentMesh.mtype&&(e=[],o=0,currentMesh.consent&&(o=currentMesh.consent),serverinfo.consent&&(o|=serverinfo.consent),64&o&&8&o?e.push("桌面提示+工具欄"):64&o?e.push("桌面工具欄"):8&o?e.push("桌面提示"):1&o&&e.push("桌面通知"),16&o?e.push("終端機提示"):2&o&&e.push("終端機通知"),32&o?e.push("檔案提示"):4&o&&e.push("檔案通知"),7==o&&(e=["一直通知"]),s+=addHtmlValue("用戶同意",addLinkConditional(e=""==(e=(e=56==(56&o)?["一直提示"]:e).join(", "))?"<i>沒有</i>":e,"p20editmeshconsent(1)",1&n))),3==currentMesh.mtype||4294967295!=userinfo.siteadmin&&0!=(1024&userinfo.siteadmin)||(i=0,o=[],userinfo.links&&userinfo.links[currentMesh._id]&&userinfo.links[currentMesh._id].notify&&(i|=userinfo.links[currentMesh._id].notify),userinfo.notify&&userinfo.notify[currentMesh._id]&&(i|=userinfo.notify[currentMesh._id]),2&i&&o.push("連接"),4&i&&o.push("斷線"),8&i&&o.push("Intel&reg; AMT"),16384&features2&&userinfo.emailVerified&&(t=0,16&i&&t++,32&i&&t++,64&i&&t++,0<t)&&o.push(format("Email ({0})",t)),null!=userinfo.msghandle&&0!=(33554432&features2)&&(t=0,128&i&&t++,256&i&&t++,512&i&&t++,0<t)&&o.push(format("Messaging ({0})",t)),0==o.length&&o.push("<i>沒有</i>"),s+=addHtmlValue("通知",addLink(o.join(", "),"p20editMeshNotify()"))),16777216&features&&2==currentMesh.mtype&&(i=!(e="<i>沒有</i>"),null!=currentMesh.invite&&(i=!0,e=currentMesh.invite.codes.join(", ")),s+=addHtmlValue("邀請碼",addLinkConditional(e,"p20editmeshInviteCode()",1&n||i))),currentMesh.mtype<3&&0!=(1&features2)&&(t="沒有政策",currentMesh.amt&&(1==currentMesh.amt.type?t="停用":2==currentMesh.amt.type?(t="簡單客戶端控制模式（CCM）",2==currentMesh.amt.cirasetup&&(t+=" + CIRA")):3==currentMesh.amt.type?(t="簡單管理員控制模式（ACM）",2==currentMesh.amt.cirasetup&&(t+=" + CIRA")):4==currentMesh.amt.type&&(t="全自動的")),s+=addHtmlValue("Intel&reg; AMT",addLinkConditional(t,"p20editMeshAmt()",1&n))),1&n&&(s+='<br><input type=button class="btn btn-primary btn-sm mb-1" value=筆記 title="查看有關此裝置群的註釋" onclick=showNotes(false,"'+encodeURIComponentEx(currentMesh._id)+'") />'),s+="<br style=clear:both><br>",2&n&&(s+='<button class="btn btn-primary btn-sm me-2 mb-1" onclick="return p20showAddMeshUserDialog()"><i class="fa-solid fa-circle-plus"></i> 新增用戶</button>',null!=usergroups)){var a=0,l=!1;for(h in usergroups)null==usergroups[h].membershipType&&usergroups[h]._id.split("/")[1]==currentMesh._id.split("/")[1]&&(a++,null==currentMesh.links||null==currentMesh.links[h])&&(l=!0);0<a&&l&&(s+='<button class="btn btn-primary btn-sm me-2 mb-1" onclick="return p20showAddMeshUserDialog(2)"><i class="fa-solid fa-circle-plus"></i> 新增用戶群</button>')}1==currentMesh.mtype&&(1&n&&(s+='<button class="btn btn-primary btn-sm me-2 mb-1" title="Import Intel&reg; AMT devices." onclick=\'return showAmtImport("'+currentMesh._id+'")\'><i class="fa-solid fa-circle-arrow-down"></i> Import</button>'),null!=currentMesh.amt)&&0<currentMesh.amt.type&&(s+='<button class="btn btn-primary btn-sm me-2 mb-1" title="執行英特爾&reg;AMT激活和配置。" onclick=\'return showAmtSetup("'+currentMesh._id+'")\'><i class="fa-solid fa-gear"></i> 設定</button>'),2!=currentMesh.mtype||4294967295!=userinfo.siteadmin&&0!=(4096&userinfo.siteadmin)||(s=(s+='<button class="btn btn-primary btn-sm me-2 mb-1" onclick=\'return addAgentToMesh("'+currentMesh._id+'")\' title="通過安裝Mesh Agent將新電腦新增到該裝置群。"><i class="fa-solid fa-circle-plus"></i> 新增代理</button>')+'<button class="btn btn-primary btn-sm me-2 mb-1" onclick=\'return inviteAgentToMesh("'+currentMesh._id+'")\' title="邀請某人在該裝置群上安裝mesh agent。"><i class="fa-solid fa-user-plus"></i> 邀請</button>'),3!=currentMesh.mtype||4294967295!=userinfo.siteadmin&&0!=(4096&userinfo.siteadmin)||(s+='<button class="btn btn-primary btn-sm me-2 mb-1" onclick=\'return addLocalDeviceToMesh("'+currentMesh._id+'")\' title="添加位於本地網絡上的設備。"><i class="fa-solid fa-circle-plus"></i> 新增裝置</button>'),currentMesh.amt&&2<currentMesh.amt.type&&(4294967295==userinfo.siteadmin||0==(4096&userinfo.siteadmin))&&(s+='<button class="btn btn-primary btn-sm me-2 mb-1" title="將英特爾AMT切換到管理員控制模式（ACM）。" onclick=\'return showAmtAcmSetup()\'><i class="fa-solid fa-circle-arrow-down"></i> ACM</button>'),s+='<table class="table table-hover table-striped" cellpadding=2 cellspacing=0><tbody><tr><th scope=col>用戶授權</th><th scope=col></th></tr>';var r=1,d=[];for(h in currentMesh.links){var c=h.split("/")[2];currentMesh.links[h].name&&(c=currentMesh.links[h].name),h==userinfo._id&&(c=userinfo.name),null!=usergroups&&null!=usergroups[h]&&(c=usergroups[h].name),d.push({id:h,name:c,rights:currentMesh.links[h].rights})}for(h in d.sort(function(e,t){return e.name>t.name?1:e.name<t.name?-1:0}),d){var u="",p=makeDeviceGroupRightsString(d[h].rights),m="fa-user",g=(d[h].id==userinfo._id||4294967295!=n&&0==(2&n)||(4294967295!=n&&4294967295==currentMesh.links[d[h].id].rights||(u="<a href=# onclick='return p20deleteUser(event,\""+encodeURIComponentEx(d[h].id)+'")\' title="刪除此裝置群的用戶權限"><i role=button class="fa-solid fa-trash text-danger fa-fw fa-xs"></i></a>'),p='<span tabindex=0 style=cursor:pointer onclick=p20viewuser("'+encodeURIComponentEx(d[h].id)+"\") onkeypress=\"if (event.key=='Enter') p20viewuser('"+encodeURIComponentEx(d[h].id)+"')\">"+p+' <i class="fa-fw fa-solid fa-pencil fa-xs"></i></span>'),d[h].id.startsWith("ugrp/")&&(m="fa-users"),EscapeHtml(decodeURIComponent(d[h].name)));null!=usergroups&&d[h].id.startsWith("ugrp/")&&(g="<a tabindex=0 href=# onclick='gotoUserGroup(\""+encodeURIComponentEx(d[h].id)+"\");haltEvent(event);'>"+g+"</a>"),s+="<tr style="+(r%2==0?";background-color:#DDD":"")+'><td style=width:30%><div><i title="用戶" class="fa-solid fa-fw '+m+'"></i>&nbsp;'+(g=null!=users&&d[h].id.startsWith("user/")?"<a tabindex=0 href=# onclick='gotoUser(\""+encodeURIComponentEx(d[h].id)+"\");haltEvent(event);'>"+g+"</a>":g)+"<div></div></div></td><td style=width:70%><div style=float:right>"+u+"</div><div>"+p+"</div></td></tr>",++r}if(s+="</tbody></table>",null!=deviceShares&&deviceSharesNode==currentMesh._id&&0<deviceShares.length){s+='<p></p><table class="table table-hover table-striped" cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col style=text-align:left;width:430px>主動設備共享</th><th scope=col style=text-align:left><th scope=col style=text-align:left></th></tr>';for(var r=1,h=0;h<deviceShares.length;h++){var v=deviceShares[h],u="",f=(null!=v.url&&(u+='<a href="'+v.url+'" rel="noreferrer noopener" target=_blank title="設備共享鏈接" style=cursor:pointer><img src=images/link2.png border=0 height=10 width=10></a> '),u+="<a href=# onclick='return p30removeDeviceSharing(event,\""+encodeURIComponentEx(v.nodeid)+'","'+encodeURIComponentEx(v.publicid)+'","'+encodeURIComponentEx(v.guestName)+'")\' title="刪除設備共享" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>',""),x=(v.p<=7?f=["","終端機","桌面","桌面+終端","檔案","終端 + 文件","桌面 + 文件","桌面+終端+文件"][v.p]:8==v.p?f="HTTP/"+v.port:16==v.p&&(f="HTTPS/"+v.port),f),f=(null!=v.startTime&&null!=v.expireTime&&(x=format("{0}，{1}至{2}",f,printFlexDateTime(new Date(v.startTime)),printFlexDateTime(new Date(v.expireTime)))),null!=v.startTime&&null!=v.duration&&(x=(v.duration,format("{0}、{1} {2} 分鐘",f,printFlexDateTime(new Date(v.startTime)),v.duration))),1==v.recurring&&(x+=", 每天重複"),2==v.recurring&&(x+=", 每週重複一次"),0!=(2&v.p)&&!0===v.viewOnly&&(x+=", 僅查看桌面"),null!=v.consent&&(0==v.consent?x+=", 不同意":(0!=(56&v.consent)&&(x+="，提示同意"),0!=(64&v.consent)&&(x+=", 工具欄"))),EscapeHtml(v.guestName));v.publicid.startsWith("AS:node/")&&(f="<i>代理自行共享</i>"),null!=(y=getNodeFromId(v.nodeid))&&(b=0<y.conn?"":" gray",s+="<tr "+(++r%2==0?"style=background-color:#DDD":"")+"><td style=width:30%>"+("<div onclick='gotoDevice(\""+y._id+'",10);haltEvent(event);\' style=float:left class="j'+y.icon+b+'"></div>&nbsp;<a onclick=\'gotoDevice("'+y._id+"\",10);haltEvent(event);'>"+EscapeHtml(y.name)+"</a>")+"<td style=width:30%><div class=m2></div><div>&nbsp;"+f+"<div></div></div></td><td style=width:70%><div style=float:right>"+u+"</div><div>"+x+"</div></td></tr>")}s+="</tbody></table>"}else deviceSharesNode!=currentMesh._id&&deviceSharesReq!=currentMesh._id&&(deviceSharesReq=currentMesh._id,meshserver.send({action:"deviceMeshShares",meshid:currentMesh._id}));r=0,nodes.sort(deviceSort);var o="",k=(1==currentMesh.mtype&&(o+='<a onclick=meshDownloadDeviceList()><img title="下載設備列表" src="images/link4.png" /></a>',0==(1&features))&&(o+=' <a onclick=meshImportDeviceList()><img title="導入設備列表" src="images/link6.png" /></a>'),'<table class="table table-hover table-striped"><tbody><tr class="class="fw-bold"><th>裝置</th><th scope=col class="text-end">'+o+"</th></tr>");for(h in nodes){var y,b=0<(y=nodes[h]).conn?"":" gray";currentMesh._id==y.meshid&&(k+="<tr><td style=width:30%><div onclick='gotoDevice(\""+y._id+'",10);haltEvent(event);\' style=float:left class="j'+y.icon+b+'"></div>&nbsp;<a onclick=\'gotoDevice("'+y._id+"\",10);haltEvent(event);'>"+EscapeHtml(y.name)+"</a></div></div></td><td><div style=float:right>"+PowerStateStr(y.pwr)+"&nbsp;</div><div>"+(y.osdesc?EscapeHtml(y.osdesc):"")+"</div></td></tr>",++r)}0==r&&(k+='<tr><td colspan="2"><i>沒有</i></td></tr>'),k+="</tbody></table>",4294967295==n&&(k+="<div style=font-size:small;text-align:right><span><a href=# onclick=p20showDeleteMeshDialog() style=cursor:pointer>刪除群組</a></span></div>"),QH("p20info",s),QH("p20info2",k);var w="";if(0==(268435456&features)&&20<=xxcurrentView&&xxcurrentView<=29&&null!=currentMesh){for(var h in w="?viewmode="+xxcurrentView+"&gotomesh="+currentMesh._id.split("/")[2],urlargs)w+="&"+h+"="+urlargs[h];try{window.history.replaceState({},document.title,window.location.pathname+w)}catch(e){}}}}function meshDownloadDeviceList(){if(!xxdialogMode){var e,t={webappversion:"0.9.0",computers:[]};for(e in nodes){var n,o=nodes[e];currentMesh._id==o.meshid&&null!=o.intelamt&&(n={name:o.name,host:o.host,user:o.intelamt.user,pass:"",tls:1==o.intelamt.tls?1:0,ver:o.intelamt.ver,pstate:o.intelamt.state},2==o.intelamt.state&&(n.pmode=1),o.intelamt.realm&&(n.digestrealm=o.intelamt.realm),o.intelamt.hash&&(n.tlscerthash=o.intelamt.hash),t.computers.push(n))}saveAs(stringToUtf8BlobNoHeader(JSON.stringify(t,null,2)),currentMesh.name+".json")}}function meshImportDeviceList(){xxdialogMode||(setModalContent("xxAddAgent","導入英特爾&reg; AMT 設備",'以 MeshCommander JSON 格式導入本地英特爾&reg; AMT 設備列表。<br /><br /><input type=file id=d4importFile class="form-control" accept=".json" onchange=meshImportDeviceListValidate() />'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>meshImportDeviceListEx()),QE("idx_dlgOkButton",!1))}function meshImportDeviceListValidate(){QE("idx_dlgOkButton",null!=Q("d4importFile").value)}function meshImportDeviceListEx(){var e=new FileReader;e.onload=function(e){var t=null;try{t=JSON.parse(e.target.result)}catch(e){return setModalContent("xxAddAgent","導入英特爾&reg; AMT 設備",format("無效的JSON檔案：{0}。",e)),void showModal("xxAddAgentModal","idx_dlgOkButton")}if("object"==typeof t&&"string"==typeof t.webappversion&&"object"==typeof t.computers&&Array.isArray(t.computers)){var n,o=0;for(n in t.computers){var i,s=t.computers[n];"string"==typeof s.name&&"string"==typeof s.host&&"string"==typeof s.user&&"string"==typeof s.pass&&(i={action:"addamtdevice",meshid:currentMesh._id,devicename:s.name,hostname:s.host,amtusername:s.user,amtpassword:s.pass,amttls:1==s.tls?1:0},"string"==typeof s.ver&&(i.ver=s.ver),"number"==typeof s.pstate&&(i.state=s.pstate),"string"==typeof s.digestrealm&&(i.realm=s.digestrealm),"string"==typeof s.tlscerthash&&(i.hash=s.tlscerthash),meshserver.send(i),o++)}0==o&&setModalContent("xxAddAgent","用戶帳戶導入","Unable to import any device.")}else setModalContent("xxAddAgent","導入英特爾&reg; AMT 設備","Invalid JSON file format.");showModal("xxAddAgentModal","idx_dlgOkButton")},e.readAsText(Q("d4importFile").files[0])}function p20editMeshAmt(){xxdialogMode||(setModalContent("xxAddAgent","Intel&reg; AMT政策",""+addHtmlFormFloating("類型",'<select id=dp20amtpolicy class="form-select" onchange=p20editMeshAmtChange()><option value=0>沒有政策</option><option value=1>停用</option><option value=2>簡單客戶端控制模式（CCM）</option>'+(0!=(1048576&features)?"<option value=3>簡單管理員控制模式（ACM）</option>":"")+"<option value=4>全自動的</option></select>")+"<div id=dp20amtpolicydiv></div>"),showModal("xxAddAgentModal","idx_dlgOkButton",p20editMeshAmtEx),currentMesh.amt&&(Q("dp20amtpolicy").value=currentMesh.amt.type),p20editMeshAmtChange(),!currentMesh.amt||2!=currentMesh.amt.type&&3!=currentMesh.amt.type||(Q("dp20amtpolicypass").value=currentMesh.amt.password,2!=currentMesh.amt.type&&3!=currentMesh.amt.type||(null!=currentMesh.amt.badpass&&(Q("dp20amtbadpass").value=currentMesh.amt.badpass),3==currentMesh.amt.type&&null!=currentMesh.amt.ccm&&(Q("dp20amtccmmode").value=currentMesh.amt.ccm)),0==(1024&features)&&(Q("dp20amtcira").value=currentMesh.amt.cirasetup)),dp20amtValidatePolicy())}function p20editMeshAmtChange(){var e=Q("dp20amtpolicy").value,t="";2!=e&&3!=e||(t=(t=(t=t+addHtmlFormFloating("密碼",'<select id=dp20amtpass class="form-select" onchange=dp20amtValidatePolicy() onkeyup=dp20amtValidatePolicy()><option value=0>隨機密碼</option>'+(null!=currentMesh.amt&&1==currentMesh.amt.password?"<option value=1 selected>保留現有密碼</option>":"")+"<option value=2>選擇新密碼</option></select>")+"<div id=dp20amtpassdiv style=display:none>")+addHtmlFormFloating("新密碼*",'<input id=dp20amtpolicypass type=password class="form-control" maxlength=32 placeholder="New password*" onchange=dp20amtValidatePolicy() onkeyup=dp20amtValidatePolicy() autocomplete=off />'))+addHtmlFormFloating("新密碼*",'<input id=dp20amtpolicypass2 type=password class="form-control" maxlength=32 placeholder="New password*" onchange=dp20amtValidatePolicy() onkeyup=dp20amtValidatePolicy() autocomplete=off />')+"</div>",3==e&&(t+=addHtmlFormFloating("CCM模式",'<select id=dp20amtccmmode class="form-select" onchange=dp20amtValidatePolicy() onkeyup=dp20amtValidatePolicy()><option value=0>請勿更改，如果設置請保留CCM</option><option value=1>如果設置停用CCM</option><option value=2>如果ACM失敗，則激活到CCM</option></select>')),t=(t+="<div id=dp20amtbadpassdiv style=display:none>")+addHtmlFormFloating("密碼未知",'<select id=dp20amtbadpass class="form-select"><option value=0>什麼都不做</option><option value=1>如果在CCM中，請重新激活英特爾&reg;AMT</option></select>')+"</div>",0==(1024&features)&&(t+=addHtmlFormFloating("CIRA設置",'<select id=dp20amtcira class="form-select" title="客戶端啟動的遠程訪問"><option value=0>什麼都不做</option><option value=1>不要連接到伺服器</option><option value=2>連接到伺服器</option></select>')),t+='<span id=dp10passNotify style="font-size:10px"> * 8-16個字符，1個大寫，1個小寫，1個數字，1個非字母數字。</span>',2==currentMesh.mtype&&2==e&&(t+='<span style="font-size:10px"> 此政策不會影響採用ACM模式的Intel&reg; AMT的裝置。</span>')),0==e&&(t='<div class="row"><div class="col-2"><i class="fa-solid fa-times-circle text-danger" style="padding-right:8px; font-size:60px;"></i></div><div class="col-10">選擇此策略時，此服務器不管理英特爾&reg;AMT。 仍然可以通過手動激活和配置Intel AMT來使用它。</div></div>'),1==e&&(t='<div class="row"><div class="col-2"><i class="fa-solid fa-times-circle text-danger" style="font-size:60px; padding-right:8px; color:green;"></i></div><div class="col-10">選擇此策略後，將禁用處於客戶端控制模式（CCM）的所有英特爾&reg;AMT。 其他設備將清除CIRA，並且仍然可以手動進行管理。</div></div>'),4==e&&(t='<div class="row"><div class="col-2"><i class="fa-solid fa-check-circle text-success" style="font-size:60px; padding-right:8px; color:blue;"></i></div><div class="col-10">這是推薦的策略。英特爾&reg;AMT激活和管理是完全自動化的，服務器將嘗試最大程度地利用硬件管理。</div></div>'),QH("dp20amtpolicydiv",t),setTimeout(dp20amtValidatePolicy,500)}function dp20amtValidatePolicy(){var e,t=!0,n=Q("dp20amtpolicy").value;2!=n&&3!=n||2!=Q("dp20amtpass").value||(t=(e=Q("dp20amtpolicypass").value)===Q("dp20amtpolicypass2").value&&passwordcheck(e)),QE("idx_dlgOkButton",t),2!=n&&3!=n||QV("dp20amtpassdiv",2==Q("dp20amtpass").value),QV("dp10passNotify",(2==n||3==n)&&2==Q("dp20amtpass").value),QV("dp20amtbadpassdiv",2==n||3==n&&1!=Q("dp20amtccmmode").value)}function p20editMeshAmtEx(){var e=parseInt(Q("dp20amtpolicy").value),t={type:e},n=null;2!=e&&3!=e||(0==Q("dp20amtpass").value&&(n=""),1==Q("dp20amtpass").value&&(n=null),2==Q("dp20amtpass").value&&(n=Q("dp20amtpolicypass").value)),2==e?(t={type:e,password:n,badpass:parseInt(Q("dp20amtbadpass").value)}).cirasetup=0==(1024&features)?parseInt(Q("dp20amtcira").value):1:3==e?(t={type:e,password:n,badpass:parseInt(Q("dp20amtbadpass").value),ccm:parseInt(Q("dp20amtccmmode").value)}).cirasetup=0==(1024&features)?parseInt(Q("dp20amtcira").value):1:4==e&&(t={type:e}),meshserver.send({action:"meshamtpolicy",meshid:currentMesh._id,amtpolicy:t})}function p20showDeleteMeshDialog(){var e;return xxdialogMode||(e=format("你確定要刪除群{0}嗎？刪除裝置群還將刪除該群中有關裝置的所有訊息。",EscapeHtml(currentMesh.name))+"<br /><br />",setModalContent("xxAddAgent","刪除群組",e+='<label class=form-check-label><input id=p20check type=checkbox class="form-check-input m-2" onchange=p20validateDeleteMeshDialog() />確認</label>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20showDeleteMeshDialogEx(3,"")}),p20validateDeleteMeshDialog()),!1}function p20validateDeleteMeshDialog(){QE("idx_dlgOkButton",Q("p20check").checked)}function p20showDeleteMeshDialogEx(e,t){meshserver.send({action:"deletemesh",meshid:currentMesh._id,meshname:currentMesh.name})}function p20editmeshrelay(){if(!xxdialogMode){var e=[];if(0==(2&features))for(var t in nodes){var n=nodes[t];2==n.mtype&&null!=n.agent&&4294967295==GetNodeRights(n)&&e.push(n)}if(e.sort(nameSort),0==e.length)setModalContent("xxAddAgent","編輯裝置群",i="沒有可用的中繼設備。"),showModal("xxAddAgentModal","idx_dlgOkButton");else{var o=[];for(t in e)o.push('<option value="'+e[t]._id+'"'+(currentMesh.relayid==e[t]._id?" selected":"")+">"+EscapeHtml(e[t].name)+"</option>");var i=addHtmlFormFloating("繼電器裝置",'<select id=d2devrelay class="form-select">'+o.join("")+"</select>");setModalContent("xxAddAgent","編輯裝置群",i),showModal("xxAddAgentModal","idx_dlgOkButton",p20editmeshrelayEx)}}}function p20editmeshrelayEx(){meshserver.send({action:"editmesh",meshid:currentMesh._id,relayid:Q("d2devrelay").value})}function p20editmesh(e){xxdialogMode||(setModalContent("xxAddAgent","編輯裝置群",'<div class="form-floating mb-2"><input type=text class="form-control" id=dp20meshname maxlength=128 placeholder="名稱" onchange=p20editmeshValidate() onkeyup=p20editmeshValidate(event) /><label for=dp20meshname>名稱</label></div><div class="form-floating mb-2"><textarea id=dp20meshdesc class="form-control" maxlength=1024 placeholder="描述"></textarea><label for=dp20meshdesc>描述</label></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",p20editmeshEx),Q("dp20meshname").value=currentMesh.name,currentMesh.desc&&(Q("dp20meshdesc").value=currentMesh.desc),p20editmeshValidate(),(2==e?Q("dp20meshdesc"):Q("dp20meshname")).focus())}function p20editmeshEx(){meshserver.send({action:"editmesh",meshid:currentMesh._id,meshname:Q("dp20meshname").value,desc:Q("dp20meshdesc").value})}function p20editmeshValidate(e){QE("idx_dlgOkButton",0<Q("dp20meshname").value.length),e&&"Enter"==e.key&&Q("dp20meshdesc").focus()}function p20editmeshconsent(e){var t,n,o;xxdialogMode||(n=0,o=t="",1==e&&(n=currentMesh.consent||0,o="編輯裝置群用戶同意"),2==e&&(n=currentUser.consent||0,o="編輯用戶同意"),3==e&&(n=currentNode.consent||0,o="編輯裝置用戶同意"),4==e&&(n=currentUserGroup.consent||0,o="編輯用戶組用戶同意"),setModalContent("xxAddAgent",o,t=(t=(t=(t=(t=t+'<div style="width:100%;border-bottom:1px solid gray;margin-bottom:5px"><b>桌面</b></div>'+('<div><label for=d20flag1><input type=checkbox id=d20flag1 class="form-check-input me-2" '+(1&n?"checked":"")+">通知使用者</label></div>"))+('<div><label for=d20flag2><input type=checkbox id=d20flag2 class="form-check-input me-2" '+(8&n?"checked":"")+">用戶同意提示</label></div>")+('<div><label for=d20flag7><input type=checkbox id=d20flag7 class="form-check-input me-2" '+(64&n?"checked":"")+">顯示連接工具欄</label></div>"))+'<div style="width:100%;border-bottom:1px solid gray;margin-bottom:5px;margin-top:8px"><b>終端機</b></div>'+('<div><label for=d20flag3><input type=checkbox id=d20flag3 class="form-check-input me-2" '+(2&n?"checked":"")+">通知使用者</label></div>"))+('<div><label for=d20flag4><input type=checkbox id=d20flag4 class="form-check-input me-2" '+(16&n?"checked":"")+">用戶同意提示</label></div>")+'<div style="width:100%;border-bottom:1px solid gray;margin-bottom:5px;margin-top:8px"><b>檔案</b></div>')+('<div><label for=d20flag5><input type=checkbox id=d20flag5 class="form-check-input me-2" '+(4&n?"checked":"")+">通知使用者</label></div>")+('<div><label for=d20flag6><input type=checkbox id=d20flag6 class="form-check-input me-2" '+(32&n?"checked":"")+">用戶同意提示</label></div>")),xxdialogButtons=3,xxdialogTag=e,showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20editmeshconsentEx(xxdialogButtons,xxdialogTag)}),serverinfo.consent&&(1&serverinfo.consent&&(Q("d20flag1").checked=!0),8&serverinfo.consent&&(Q("d20flag2").checked=!0),2&serverinfo.consent&&(Q("d20flag3").checked=!0),16&serverinfo.consent&&(Q("d20flag4").checked=!0),4&serverinfo.consent&&(Q("d20flag5").checked=!0),32&serverinfo.consent&&(Q("d20flag6").checked=!0),64&serverinfo.consent&&(Q("d20flag7").checked=!0),QE("d20flag1",!(1&serverinfo.consent)),QE("d20flag2",!(8&serverinfo.consent)),QE("d20flag3",!(2&serverinfo.consent)),QE("d20flag4",!(16&serverinfo.consent)),QE("d20flag5",!(4&serverinfo.consent)),QE("d20flag6",!(32&serverinfo.consent)),QE("d20flag7",!(64&serverinfo.consent))))}function p20editmeshconsentEx(e,t){var n=0;Q("d20flag1").checked&&(n+=1),Q("d20flag2").checked&&(n+=8),Q("d20flag3").checked&&(n+=2),Q("d20flag4").checked&&(n+=16),Q("d20flag5").checked&&(n+=4),Q("d20flag6").checked&&(n+=32),Q("d20flag7").checked&&(n+=64),1==t&&meshserver.send({action:"editmesh",meshid:currentMesh._id,consent:n}),2==t&&meshserver.send({action:"edituser",id:currentUser._id,consent:n}),3==t&&meshserver.send({action:"changedevice",nodeid:currentNode._id,consent:n}),4==t&&meshserver.send({action:"editusergroup",ugrpid:currentUserGroup._id,consent:n})}function p20editmeshfeatures(){var e,t,n;xxdialogMode||(e=currentMesh.flags||0,t="",n=0,"number"==typeof currentMesh.expireDevs&&0<currentMesh.expireDevs&&2e3<(n=currentMesh.expireDevs)&&(n=2e3),1==serverinfo.devGroupSessionRecording&&4!=currentMesh.mtype&&(t+='<div class="form-check"><label><input type=checkbox id=d20flag4 class="form-check-input me-2" onchange=p20editmeshfeaturesValidate() '+(4&e?"checked":"")+">記錄會議</label><br></div>"),t=(t=2!=currentMesh.mtype&&4!=currentMesh.mtype?t:t+('<div class="form-check"><label><input type=checkbox id=d20flag2 class="form-check-input me-2" onchange=p20editmeshfeaturesValidate() '+(2&e?"checked":"")+">"+(4==currentMesh.mtype?"將服務器設備名稱同步到端口名稱":"將伺服器裝置名稱同步到主機名稱"))+'</label><br></div><div class="form-check"><label><input type=checkbox id=d20flag1 class="form-check-input me-2" onchange=p20editmeshfeaturesValidate() '+(1&e?"checked":"")+">斷開連接後删除裝置</label><br></div>")+'<div class="form-check"><label><input type=checkbox id=d20expireDevice class="form-check-input me-2" onchange=p20editmeshfeaturesValidate() '+(0<n?"checked":"")+'>自動移除非活動設備</label><br></div><div style=margin-left:20px id=d20expireDeviceDev>停用天數直到移除 <label><input type=number inputmode=numeric class="form-control" onchange=p20editmeshfeaturesValidate() onkeyup=p20editmeshfeaturesValidate() onpaste=p20editmeshfeaturesValidate() onkeydown=p20editmeshfeaturesValidate() maxlength=4 min=1 max=2000 style=width:80px value="'+(0==n?30:n)+'" id=d20expireDeviceDays></label><br></div>',serverinfo.autoremoveinactivedevices&&(1==serverinfo.autoremoveinactivedevices?t+=format("<span style=font-size:x-small;margin-left:6px>默認情況下，非活動設備將在 1 天后移除。</span>",serverinfo.autoremoveinactivedevices):t+=format("<span style=font-size:x-small;margin-left:6px>默認情況下，不活動的設備將在 {0} 天后被移除。</span>",serverinfo.autoremoveinactivedevices)),setModalContent("xxAddAgent","編輯裝置群功能",t),showModal("xxAddAgentModal","idx_dlgOkButton",p20editmeshfeaturesEx),p20editmeshfeaturesValidate())}function p20editmeshfeaturesValidate(){var e=0,t=!0,e=(2!=currentMesh.mtype&&4!=currentMesh.mtype||!Q("d20flag1").checked||(e+=1),QE("d20expireDevice",0==(1&e)),0==(1&e)&&Q("d20expireDevice").checked);QV("d20expireDeviceDev",e),e&&(e=parseInt(Q("d20expireDeviceDays").value),isNaN(e)||e<1||2e3<e||e!=Q("d20expireDeviceDays").value)&&(t=!1),QE("idx_dlgOkButton",t)}function p20editmeshfeaturesEx(){var e=0,t=(2!=currentMesh.mtype&&4!=currentMesh.mtype||(Q("d20flag1").checked&&(e+=1),Q("d20flag2").checked&&(e+=2)),1==serverinfo.devGroupSessionRecording&&4!=currentMesh.mtype&&Q("d20flag4").checked&&(e+=4),0);0==(1&e)&&Q("d20expireDevice").checked&&(t=parseInt(Q("d20expireDeviceDays").value)),meshserver.send({action:"editmesh",meshid:currentMesh._id,flags:e,expireDevs:t})}function p20showAddMeshUserDialog(e,t){if(!xxdialogMode){var n="";if(null==e||5==e)null==t&&(n+=null==e?"允許用戶管理此裝置群和該群中的裝置。":"允許用戶管理此裝置。",524288&features&&(n+=" 用戶需要先登入到該伺服器一次，然後才能將其新增到裝置群。"),n+="<br /><br />"),n=(n+="<div style='position:relative'>")+addHtmlFormFloating("用戶標識符",'<input id=dp20username maxlength=256 onchange=p20validateAddMeshUserDialog() onkeyup=p20validateAddMeshUserDialog() placeholder="user1, user2, user3" class="form-control" />')+"<div id=dp20usersuggest class=suggestionBox style='top:30px;left:130px;display:none'></div></div><br>";else if(1==e){var o="";if(null==t)for(r in s=getOrderedList(meshes,"name"))null!=currentUser.links&&null!=currentUser.links[s[r]._id]||(o+="<option value="+encodeURIComponentEx(s[r]._id)+">"+EscapeHtml(s[r].name)+"</option>");else o+="<option value="+t+">"+EscapeHtml(meshes[decodeURIComponent(t)].name)+"</option>";n+=addHtmlFormFloating("裝置群","<select onchange=p20validateAddMeshUserDialog() id=dp2groupid class=form-select"+(t?" disabled":"")+">"+o+"</select>")}else if(2==e){if(null==usergroups)return;o="";for(r in i=getOrderedList(usergroups,"name"))currentMesh._id.split("/")[1]!=i[r]._id.split("/")[1]||null!=currentMesh.links&&null!=currentMesh.links[i[r]._id]||(o+="<option value="+encodeURIComponentEx(i[r]._id)+">"+EscapeHtml(i[r].name)+"</option>");n+=addHtmlFormFloating("用戶群",'<select onchange=p20validateAddMeshUserDialog() id=dp2groupid class="form-select">'+o+"</select>")}else if(6==e){if(null==usergroups)return;var i,o="";if(null==t)for(r in i=getOrderedList(usergroups,"name"))null!=i[r].membershipType||currentNode._id.split("/")[1]!=i[r]._id.split("/")[1]||null!=currentNode.links&&null!=currentNode.links[i[r]._id]||(o+="<option value="+encodeURIComponentEx(i[r]._id)+">"+EscapeHtml(i[r].name)+"</option>");else o+="<option value="+t+">"+EscapeHtml(usergroups[decodeURIComponent(t)].name)+"</option>";n+=addHtmlFormFloating("用戶群","<select onchange=p20validateAddMeshUserDialog() id=dp2groupid "+(t?" disabled":"")+' class="form-select">'+o+"</select>")}else if(3==e){o="";for(r in t=t&&decodeURIComponent(t),s=getOrderedList(meshes,"name"))null==t&&null!=currentUserGroup.links&&null!=currentUserGroup.links[s[r]._id]||(o+="<option value="+encodeURIComponentEx(s[r]._id)+(t==s[r]._id?" selected":" ")+">"+EscapeHtml(s[r].name)+"</option>");n+=addHtmlFormFloating("裝置群","<select onchange=p20validateAddMeshUserDialog("+e+') id=dp2groupid class="form-select">'+o+"</select>")}else if(4==e||7==e){var s,o="",a=null,l=null;for(r in null!=t&&null!=(l=getNodeFromId(decodeURIComponent(t)))&&(a=l.meshid),s=getOrderedList(meshes,"name"))null!=s[r].links[userinfo._id]&&7&s[r].links[userinfo._id].rights&&(null==a&&(a=s[r]._id),o+="<option value="+encodeURIComponentEx(s[r]._id)+(a==s[r]._id?" selected":" ")+">"+EscapeHtml(s[r].name)+"</option>");n+=addHtmlFormFloating("裝置群","<select onchange=p20changeMeshAddMeshUserDialog("+e+') id=dp2meshid class="form-select">'+o+"</select>"),o="";var r,d=getOrderedList(nodes,"name");for(r in d)d[r].meshid==a&&(o+="<option value="+encodeURIComponentEx(d[r]._id)+(l==d[r]?" selected":" ")+">"+EscapeHtml(d[r].name)+"</option>");n+=addHtmlFormFloating("裝置","<select onchange=p20validateAddMeshUserDialog("+e+') id=dp2nodeid class="form-select">'+o+"</select>")}else{var c=(e=decodeURIComponent(e)).split("/")[2];users&&users[e]&&(c=users[e].name),usergroups&&usergroups[e]&&(c=usergroups[e].name),userinfo._id==e&&(c=userinfo.name),e.startsWith("ugrp/")?n+=format("{0}的群組權限。",c)+"<br /><br />":n+=format("用戶{0}的群組權限。",c)+"<br /><br />"}var c=-1,u=4!=e&&5!=e&&6!=e&&7!=e;n+='<div style="height:120px;overflow-y:scroll;border:1px solid var(--sub-menu-color);resize:vertical;padding:8px;border-radius:0.375rem;">',u&&(n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20fulladmin>完整管理員</label><br><label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20editmesh>編輯裝置群</label><br><label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20manageusers>管理裝置群用戶</label><br><label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20managecomputers>管理裝置群電腦</label><br>'),n=(n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20remotecontrol>Remote Control & Relay</label><br>')+'<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20remoteview style=margin-left:12px>僅遠程查看</label><br>'+'<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20remotelimitedinput style=margin-left:12px>僅有限輸入</label><br>',!1!==serverinfo.guestdevicesharing&&(n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20guestshare style=margin-left:12px>嘉賓分享</label><br>'),n=(n=(n=(n=(n=(n=(n=(n=n+'<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20nodesktop style=margin-left:12px>不能訪問桌面</label><br>'+'<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20noterminal style=margin-left:12px>不能訪問終端</label><br>')+'<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20nofiles style=margin-left:12px>不能存取檔案</label><br>'+'<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20noamt style=margin-left:12px>沒有Intel&reg; AMT</label><br>')+'<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20meshagentconsole>網格代理控制台</label><br>'+'<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20meshserverfiles>伺服器檔案</label><br>')+'<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20wakedevices>喚醒裝置</label><br>'+'<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20editnotes>編輯裝置筆記</label><br>')+'<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20limitevents>只顯示自己的事件</label><br>'+'<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20chatnotify>聊天並通知</label><br>')+'<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20uninstall>卸載代理/刪除設備</label><br>'+'<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20commands>遠程命令</label><br>')+'<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20resetoff>重置/關閉電源</label><br>'+'<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20details>設備詳情</label><br>')+'<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20relay>Use as Relay</label><br>'+"</div>",null==e?(xxdialogButtons=3,xxdialogTag="",setModalContent("xxAddAgent","將用戶新增到裝置群",n),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20showAddMeshUserDialogEx(xxdialogButtons,xxdialogTag)}),QE("p20fulladmin",4294967295==GetMeshRights(currentMesh)),Q("dp20username").focus()):1===e?(xxdialogButtons=t?7:3,xxdialogTag=e,setModalContent("xxAddAgent",null==t?"新增裝置群權限":"編輯裝置群權限",n),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20showAddMeshUserDialogEx(xxdialogButtons,xxdialogTag)}),4294967295==(c=null!=t?meshes[decodeURIComponent(t)].links[currentUser._id].rights:c)&&(Q("p20fulladmin").checked=!0,c=-1)):2===e?(xxdialogButtons=3,xxdialogTag=e,setModalContent("xxAddAgent","新增用戶群",n),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20showAddMeshUserDialogEx(xxdialogButtons,xxdialogTag)}),QE("p20fulladmin",4294967295==GetMeshRights(currentMesh))):3===e?(xxdialogButtons=t?7:3,xxdialogTag=e,setModalContent("xxAddAgent",null==t?"新增裝置群":"編輯裝置群",n),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20showAddMeshUserDialogEx(xxdialogButtons,xxdialogTag)}),QE("dp2groupid",null==t),4294967295==(c=null!=t?currentUserGroup.links[decodeURIComponent(t)].rights:c)&&(Q("p20fulladmin").checked=!0,c=-1)):4===e?(xxdialogButtons=t?7:3,xxdialogTag=e,setModalContent("xxAddAgent",null==t?"新增裝置權限":"編輯裝置權限",n),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20showAddMeshUserDialogEx(xxdialogButtons,xxdialogTag)}),QE("dp2meshid",null==t),QE("dp2nodeid",null==t)):7===e?(xxdialogButtons=t?7:3,xxdialogTag=e,setModalContent("xxAddAgent",null==t?"新增裝置權限":"編輯裝置權限",n),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20showAddMeshUserDialogEx(xxdialogButtons,xxdialogTag)}),QE("dp2meshid",null==t),QE("dp2nodeid",null==t),null!=t&&(c=currentUserGroup.links[decodeURIComponent(t)].rights,QE("dp20username",!1))):5===e?(xxdialogButtons=t?7:3,xxdialogTag=e,setModalContent("xxAddAgent",t?"編輯用戶裝置權限":"新增用戶裝置權限",n),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20showAddMeshUserDialogEx(xxdialogButtons,xxdialogTag)}),null!=t&&(t=decodeURIComponent(t),null!=users&&null!=users[t]?Q("dp20username").value=users[t].name:Q("dp20username").value=t.split("/")[2],c=currentNode.links[t].rights,QE("dp20username",!1)),Q("dp20username").focus()):6===e?(xxdialogButtons=t?7:3,xxdialogTag=e,setModalContent("xxAddAgent",t?"編輯用戶群裝置權限":"新增用戶群裝置權限",n),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20showAddMeshUserDialogEx(xxdialogButtons,xxdialogTag)}),null!=t&&(c=currentNode.links[decodeURIComponent(t)].rights)):(e.startsWith("ugrp/")?(xxdialogButtons=7,xxdialogTag=e,setModalContent("xxAddAgent","編輯裝置群權限",n)):(xxdialogButtons=7,xxdialogTag=e,setModalContent("xxAddAgent","編輯用戶裝置群權限",n)),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20showAddMeshUserDialogEx(xxdialogButtons,xxdialogTag)}),GetMeshRights(currentMesh),4294967295==(c=GetMeshRights(currentMesh,e))&&(Q("p20fulladmin").checked=!0,c=-1),QE("p20fulladmin",4294967295==GetMeshRights(currentMesh))),-1!=c&&(u&&(1&c&&(Q("p20editmesh").checked=!0),2&c&&(Q("p20manageusers").checked=!0),4&c)&&(Q("p20managecomputers").checked=!0),8&c&&(Q("p20remotecontrol").checked=!0,65536&c&&(Q("p20nodesktop").checked=!0),256&c&&(Q("p20remoteview").checked=!0),524288&c&&!1!==serverinfo.guestdevicesharing&&(Q("p20guestshare").checked=!0),512&c&&(Q("p20noterminal").checked=!0),1024&c&&(Q("p20nofiles").checked=!0),2048&c&&(Q("p20noamt").checked=!0),4096&c)&&(Q("p20remotelimitedinput").checked=!0),16&c&&(Q("p20meshagentconsole").checked=!0),32&c&&(Q("p20meshserverfiles").checked=!0),64&c&&(Q("p20wakedevices").checked=!0),128&c&&(Q("p20editnotes").checked=!0),8192&c&&(Q("p20limitevents").checked=!0),16384&c&&(Q("p20chatnotify").checked=!0),32768&c&&(Q("p20uninstall").checked=!0),131072&c&&(Q("p20commands").checked=!0),262144&c&&(Q("p20resetoff").checked=!0),524288&c&&!1!==serverinfo.guestdevicesharing&&(Q("p20guestshare").checked=!0),1048576&c&&(Q("p20details").checked=!0),2097152&c)&&(Q("p20relay").checked=!0),p20validateAddMeshUserDialog(e)}return!1}function p20changeMeshAddMeshUserDialog(e){var t,n="",o=decodeURIComponent(Q("dp2meshid").value);for(t in nodes)nodes[t].meshid==o&&(n+="<option value="+encodeURIComponentEx(nodes[t]._id)+">"+EscapeHtml(nodes[t].name)+"</option>");QH("dp2nodeid",n),p20validateAddMeshUserDialog(e)}function p20setname(e){e=decodeURIComponent(e);var t,n=Q("dp20username").value.split(",");for(t in n)n[t]=n[t].trim();return n[n.length-1]=e,Q("dp20username").value=n.join(", "),p20validateAddMeshUserDialog(),!1}function p20validateAddMeshUserDialog(e){var t,n,o=!0;if(4===e&&(e=0,""!=(t=decodeURIComponent(Q("dp2nodeid").value))&&null!=currentUser.links&&null!=currentUser.links[t]&&(e=currentUser.links[t].rights),Q("p20remotecontrol").checked=0!=(8&e),Q("p20meshagentconsole").checked=0!=(16&e),Q("p20meshserverfiles").checked=0!=(32&e),Q("p20wakedevices").checked=0!=(64&e),Q("p20editnotes").checked=0!=(128&e),Q("p20remoteview").checked=0!=(256&e),Q("p20noterminal").checked=0!=(512&e),Q("p20nofiles").checked=0!=(1024&e),Q("p20noamt").checked=0!=(2048&e),Q("p20remotelimitedinput").checked=0!=(4096&e),Q("p20limitevents").checked=0!=(8192&e),Q("p20chatnotify").checked=0!=(16384&e),Q("p20uninstall").checked=0!=(32768&e),Q("p20nodesktop").checked=0!=(65536&e),Q("p20commands").checked=0!=(131072&e),Q("p20resetoff").checked=0!=(262144&e),!1!==serverinfo.guestdevicesharing&&(Q("p20guestshare").checked=0!=(524288&e)),Q("p20details").checked=0!=(1048576&e),Q("p20relay").checked=0!=(2097152&e),o=""!=t),Q("dp20username")){var i=Q("dp20username").value.split(",");for(c in i){var s=i[c]=i[c].trim();(0==s.length||0<=s.indexOf('"'))&&(o=!1)}var e=!1,a=!1;if(null!=users){var l=i[i.length-1].trim(),r=l.toLowerCase(),d=[];if(0<l.length){for(var c in users){var u=users[c]._id.split("/");if((null==currentMesh||currentMesh.domain==u[1])&&(null==currentNode||currentNode.domain==u[1])){if(u[2]===r){a=!0;break}if(0<=users[c].name.toLowerCase().indexOf(r)&&(d.push([users[c]._id,users[c].name]),8<=d.length))break}}if(0==a&&0<d.length){var p="";for(c in d){var m=d[c][0],g=d[c][1];m.split("/")[2]==g.toLowerCase()?p+="<div class=suggestionBoxItem onclick='p20setname(\""+encodeURIComponentEx(m.split("/")[2])+"\")'>"+EscapeHtml(g)+"</div>":p+="<div class=suggestionBoxItem onclick='p20setname(\""+encodeURIComponentEx(m.split("/")[2])+"\")'><div>"+EscapeHtml(g)+"</div><div class=suggestionBoxSubItem>"+EscapeHtml(m.split("/")[2])+"</div></div>"}QH("dp20usersuggest",p),e=!0}}}QV("dp20usersuggest",e)}QE("idx_dlgOkButton",o),null!=Q("p20fulladmin")?(n=!Q("p20fulladmin").checked,QE("p20editmesh",n),QE("p20manageusers",n),QE("p20managecomputers",n)):n=""!=t,QE("p20remotecontrol",n),QE("p20meshagentconsole",n),QE("p20meshserverfiles",n),QE("p20wakedevices",n),QE("p20editnotes",n),QE("p20limitevents",n),QE("p20remoteview",n&&Q("p20remotecontrol").checked),!1!==serverinfo.guestdevicesharing&&QE("p20guestshare",n&&Q("p20remotecontrol").checked&&(Q("p20remoteview").checked||!Q("p20remotelimitedinput").checked)),QE("p20remotelimitedinput",n&&Q("p20remotecontrol").checked&&!Q("p20remoteview").checked),QE("p20nodesktop",n&&Q("p20remotecontrol").checked),QE("p20noterminal",n&&Q("p20remotecontrol").checked),QE("p20nofiles",n&&Q("p20remotecontrol").checked),QE("p20noamt",n&&Q("p20remotecontrol").checked),QE("p20chatnotify",n),QE("p20uninstall",n),QE("p20commands",n),QE("p20resetoff",n),QE("p20details",n),QE("p20relay",n)}function p20showAddMeshUserDialogEx(e,t){var n,o,i=0;if(null!=Q("p20fulladmin")&&1==Q("p20fulladmin").checked?i=4294967295:(null!=Q("p20fulladmin")&&(1==Q("p20editmesh").checked&&(i+=1),1==Q("p20manageusers").checked&&(i+=2),1==Q("p20managecomputers").checked)&&(i+=4),1==Q("p20remotecontrol").checked&&(i+=8),1==Q("p20meshagentconsole").checked&&(i+=16),1==Q("p20meshserverfiles").checked&&(i+=32),1==Q("p20wakedevices").checked&&(i+=64),1==Q("p20editnotes").checked&&(i+=128),1==Q("p20remoteview").checked&&(i+=256),1==Q("p20nodesktop").checked&&(i+=65536),1==Q("p20noterminal").checked&&(i+=512),1==Q("p20nofiles").checked&&(i+=1024),1==Q("p20noamt").checked&&(i+=2048),1!=Q("p20remotelimitedinput").checked||Q("p20remoteview").checked||(i+=4096),1==Q("p20limitevents").checked&&(i+=8192),1==Q("p20chatnotify").checked&&(i+=16384),1==Q("p20uninstall").checked&&(i+=32768),1==Q("p20commands").checked&&(i+=131072),1==Q("p20resetoff").checked&&(i+=262144),!1===serverinfo.guestdevicesharing||1!=Q("p20guestshare").checked||!Q("p20remoteview").checked&&(Q("p20remoteview").checked||Q("p20remotelimitedinput").checked)||(i+=524288),1==Q("p20details").checked&&(i+=1048576),1==Q("p20relay").checked&&(i+=2097152)),0==(8&i)&&(256&i&&(i-=256),512&i&&(i-=512),1024&i&&(i-=1024),2048&i&&(i-=2048),4096&i&&(i-=4096),65536&i)&&(i-=65536),1===t){var s=decodeURIComponent(Q("dp2groupid").value);null!=(l=meshes[s])&&meshserver.send({action:"addmeshuser",meshid:s,meshname:l.name,userids:[currentUser._id],meshadmin:i,remove:2==e})}else if(2===t){var a=decodeURIComponent(Q("dp2groupid").value);null!=(l=meshes[currentMesh._id])&&meshserver.send({action:"addmeshuser",meshid:currentMesh._id,meshname:currentMesh.name,userid:a,meshadmin:i,remove:2==e})}else if(3===t){var l,s=decodeURIComponent(Q("dp2groupid").value);null!=(l=meshes[s])&&meshserver.send({action:"addmeshuser",meshid:s,meshname:l.name,userids:[currentUserGroup._id],meshadmin:i,remove:2==e})}else if(4===t)null!=(o=getNodeFromId(n=decodeURIComponent(Q("dp2nodeid").value)))&&meshserver.send({action:"adddeviceuser",nodeid:n,nodename:o.name,userids:[currentUser._id],rights:i,remove:2==e});else if(5===t){var r=[];for(c in d=Q("dp20username").value.split(","))r.push(d[c].trim());meshserver.send({action:"adddeviceuser",nodeid:currentNode._id,nodename:currentNode.name,usernames:r,rights:i,remove:2==e})}else if(6===t){a=decodeURIComponent(Q("dp2groupid").value);null!=currentNode&&meshserver.send({action:"adddeviceuser",nodeid:currentNode._id,nodename:currentNode.name,userids:[a],rights:i,remove:2==e})}else if(7===t)null!=(o=getNodeFromId(n=decodeURIComponent(Q("dp2nodeid").value)))&&meshserver.send({action:"adddeviceuser",nodeid:n,nodename:o.name,userids:[currentUserGroup._id],rights:i,remove:2==e});else if(null==t){var d,c,r=[];for(c in d=Q("dp20username").value.split(","))r.push(d[c].trim());meshserver.send({action:"addmeshuser",meshid:currentMesh._id,meshname:currentMesh.name,usernames:r,meshadmin:i,remove:2==e})}else meshserver.send({action:"addmeshuser",meshid:currentMesh._id,meshname:currentMesh.name,userids:[t],meshadmin:i,remove:2==e})}function p20viewuser(e){var t,n,o,i,s,a;xxdialogMode||(t=decodeURIComponent(e),n=GetMeshRights(currentMesh),o=GetMeshRights(currentMesh,t),userinfo._id!=t&&(4294967295==n||0!=(2&n)&&4294967295!=o)?p20showAddMeshUserDialog(e):(e=[],4294967295==o?e.push("完整管理員（保留所有權利）"):(0!=(1&o)&&e.push("編輯裝置群"),0!=(2&o)&&e.push("管理裝置群用戶"),0!=(4&o)&&e.push("管理裝置群電腦"),0!=(8&o)&&e.push("遙控"),0!=(16&o)&&e.push("代理控制台"),0!=(32&o)&&e.push("伺服器檔案"),0!=(64&o)&&e.push("喚醒裝置"),0!=(128&o)&&e.push("編輯筆記"),0!=(8&o)&&0!=(256&o)&&e.push("僅遠程查看"),0!=(8&o)&&0!=(65536&o)&&e.push("沒有桌面"),0!=(8&o)&&0!=(512&o)&&e.push("沒有終端"),0!=(8&o)&&0!=(1024&o)&&e.push("沒有檔案"),0!=(8&o)&&0!=(2048&o)&&e.push("沒有Intel&reg; AMT"),0!=(8&o)&&0!=(4096&o)&&0==(256&o)&&e.push("有限輸入"),0!=(8192&o)&&e.push("僅自我事件"),0!=(16384&o)&&e.push("聊天並通知"),0!=(32768&o)&&e.push("卸載"),0!=(131072&o)&&e.push("指令"),0!=(262144&o)&&e.push("重置/關閉"),0!=(524288&o)&&e.push("分享"),0!=(1048576&o)&&e.push("細節"),0!=(2097152&o)&&e.push("中繼")),0==e.length&&e.push("沒有權利"),i=t.split("/")[2],users&&users[t]&&(i=users[t].name),userinfo._id==t&&(i=userinfo.name),s=1,a=addHtmlValue("用戶名",EscapeHtml(decodeURIComponent(i))),t.split("/")[2]!=i&&(a+=addHtmlValue("用戶識別碼",EscapeHtml(t.split("/")[2]))),a+=addHtmlValue("權限",e.join("，")),userinfo._id!=t&&(4294967295==n||0!=(2&n)&&4294967295!=o)&&(s+=4),setModalContent("xxAddAgent","裝置群用戶",a),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p20viewuserEx(s,t))))}function p20viewuserEx(e,t){2==e&&(e=t.split("/")[2],users&&users[t]&&(e=users[t].name),usergroups&&usergroups[t]&&(e=usergroups[t].name),userinfo._id==t&&(e=userinfo.name),t.startsWith("user/")&&setModalContent("xxAddAgent","刪除用戶權限",format("確認刪除用戶“ {0} ”的權限？",EscapeHtml(decodeURIComponent(e)))),t.startsWith("ugrp/")&&setModalContent("xxAddAgent","刪除用戶群權限",format("確認刪除用戶群“ {0} ”的權限？",EscapeHtml(decodeURIComponent(e))),t),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p20viewuserEx2(3,t)))}function p20deleteUser(e,t){return haltEvent(e),p20viewuserEx(2,decodeURIComponent(t)),!1}function p20viewuserEx2(e,t){meshserver.send({action:"removemeshuser",meshid:currentMesh._id,meshname:currentMesh.name,userid:t})}function p20editmeshInviteCode(){if(xxdialogMode)return!1;var e,t=GetMeshRights(currentMesh),n=serverinfo.name;-1!=n.indexOf(".")&&0==(2&features)||(n=window.location.hostname),n=1==serverinfo.https?"https://"+n+(443==serverinfo.port?"":":"+serverinfo.port)+domainUrl+"invite"+(urlargs.key?"?key="+urlargs.key:""):"http://"+n+(80==serverinfo.port?"":":"+serverinfo.port)+domainUrl+"invite"+(urlargs.key?"?key="+urlargs.key:""),1&t?(setModalContent("xxAddAgent","邀請碼",e=(e=(e=(e=(e="啟用後，任何人都可以使用邀請代碼通過以下公共鏈結將裝置加入該裝置群：<br /><br />")+('<div style=width:100%;text-align:center><a rel="noreferrer noopener" target=_blank href="'+n+'">'+n+"</a></div><br />")+'<div style=margin-bottom:5px><label><input id=agentJoinCheck type=checkbox class="form-check-input me-2" onclick=p20editmeshInviteCodeValidate() />啟用邀請代碼</label></div>')+addHtmlFormFloating("邀請碼",'<input id=agentInviteCode class="form-control" onkeyup=p20editmeshInviteCodeValidate() placeholder="code1, code2, code3" />'))+addHtmlFormFloating("代理",'<select id=agentType class="form-select" onchange=p20editmeshInviteCodeValidate()><option value=0>所有可用的代理</option><option value=1>Windows MeshAgent</option><option value=2>Linux MeshAgent</option><option value=4>MacOS MeshAgent</option><option value=8>MeshCentral 助手</option></select>')+"<div id=d2agentInstallTypeDiv>")+addHtmlFormFloating("安裝方式",'<select id=agentInviteType class="form-select"><option value=0>背景與互動</option><option value=2>僅背景</option><option value=1>僅限互動</option></select>')+"</div>"),showModal("xxAddAgentModal","idx_dlgOkButton",p20editmeshInviteCodeEx),null!=currentMesh.invite&&(Q("agentJoinCheck").checked=!0,Q("agentInviteCode").value=currentMesh.invite.codes.join(", "),currentMesh.invite.ag&&(Q("agentType").value=currentMesh.invite.ag),Q("agentInviteType").value=3&currentMesh.invite.flags),p20editmeshInviteCodeValidate()):(e="任何人都可以使用邀請代碼通過以下公共鏈結將裝置加入該裝置群：<br /><br />",setModalContent("xxAddAgent","邀請碼",e=(e=(e+='<div style=width:100%;text-align:center><a rel="noreferrer noopener" target=_blank href="'+n+'">'+n+"</a></div><br />")+addHtmlValue("邀請碼",currentMesh.invite.codes.join(", ")))+addHtmlValue("安裝方式",["背景與互動","僅限互動","僅背景"][3&currentMesh.invite.flags])),showModal("xxAddAgentModal","idx_dlgOkButton"))}function p20editmeshInviteCodeValidate(){var e,t=!0,n=Q("agentInviteCode").value.split(",");for(e in n)n[e]=n[e].trim(),""==n[e]&&(t=!1);QE("agentInviteCode",Q("agentJoinCheck").checked),QE("agentType",Q("agentJoinCheck").checked),QE("agentInviteType",Q("agentJoinCheck").checked),QE("idx_dlgOkButton",0==Q("agentJoinCheck").checked||t),QV("d2agentInstallTypeDiv",parseInt(Q("agentType").value)<2)}function p20editmeshInviteCodeEx(){if(1==Q("agentJoinCheck").checked){var e,t=Q("agentInviteCode").value.split(",");for(e in t)t[e]=t[e].trim();meshserver.send({action:"editmesh",meshid:currentMesh._id,invite:{codes:t,flags:parseInt(Q("agentInviteType").value),ag:parseInt(Q("agentType").value)}})}else meshserver.send({action:"editmesh",meshid:currentMesh._id,invite:"*"})}function p20editMeshNotify(){var e,t,n;return xxdialogMode||(e=0,t=16384&features2&&userinfo.emailVerified,userinfo.links&&userinfo.links[currentMesh._id]&&userinfo.links[currentMesh._id].notify&&(e|=userinfo.links[currentMesh._id].notify),userinfo.notify&&userinfo.notify[currentMesh._id]&&(e|=userinfo.notify[currentMesh._id]),n='<div style="border-bottom: 1px solid #888;margin-bottom:3px">網頁通知</div><div class="form-check"><label><input id=p20notifyIntelDeviceConnect class="form-check-input me-2" type=checkbox />裝置連接。</label></div><div class="form-check"><label><input id=p20notifyIntelDeviceDisconnect class="form-check-input me-2" type=checkbox />裝置斷開連接。</label></div>',currentMesh.mtype<3&&(n+='<div class="form-check"><label><input id=p20notifyIntelAmtKvmActions class="form-check-input me-2" type=checkbox />Intel&reg; AMT桌面和串行事件</label></div>'),t&&(n+='<br /><div style="border-bottom: 1px solid #888;margin-bottom:3px">電子郵件通知</div><div class="form-check"><label><input id=p20enotifyIntelDeviceConnect class="form-check-input me-2" type=checkbox />裝置連接。</label></div><div class="form-check"><label><input id=p20enotifyIntelDeviceDisconnect class="form-check-input me-2" type=checkbox />裝置斷開連接。</label></div><div class="form-check"><label><input id=p20enotifyIntelDeviceHelp class="form-check-input me-2" type=checkbox />Help requests</label></div>'),null!=userinfo.msghandle&&0!=(33554432&features2)&&(n+='<br /><div style="border-bottom: 1px solid #888;margin-bottom:3px">Messaging Notifications</div><div class="form-check"><label><input id=p20emsgDeviceConnect class="form-check-input me-2" type=checkbox />裝置連接。</label></div><div class="form-check"><label><input id=p20emsgDeviceDisconnect class="form-check-input me-2" type=checkbox />裝置斷開連接。</label></div><div class="form-check"><label><input id=p20emsgDeviceHelp class="form-check-input me-2" type=checkbox />Help requests</label></div>'),setModalContent("xxAddAgent","通知設定",n),showModal("xxAddAgentModal","idx_dlgOkButton",p20editMeshNotifyEx),Q("p20notifyIntelDeviceConnect").checked=2&e,Q("p20notifyIntelDeviceDisconnect").checked=4&e,currentMesh.mtype<3&&(Q("p20notifyIntelAmtKvmActions").checked=8&e),t&&(Q("p20enotifyIntelDeviceConnect").checked=16&e,Q("p20enotifyIntelDeviceDisconnect").checked=32&e,Q("p20enotifyIntelDeviceHelp").checked=64&e),null!=userinfo.msghandle&&0!=(33554432&features2)&&(Q("p20emsgDeviceConnect").checked=128&e,Q("p20emsgDeviceDisconnect").checked=256&e,Q("p20emsgDeviceHelp").checked=512&e)),!1}function p20editMeshNotifyEx(e,t){var n=0,n=(n+=Q("p20notifyIntelDeviceConnect").checked?2:0)+(Q("p20notifyIntelDeviceDisconnect").checked?4:0);currentMesh.mtype<3&&(n+=Q("p20notifyIntelAmtKvmActions").checked?8:0),t&&(n=(n=(n+=Q("p20enotifyIntelDeviceConnect").checked?16:0)+(Q("p20enotifyIntelDeviceDisconnect").checked?32:0))+(Q("p20enotifyIntelDeviceHelp").checked?64:0)),null!=userinfo.msghandle&&0!=(33554432&features2)&&(n=(n=(n+=Q("p20emsgDeviceConnect").checked?128:0)+(Q("p20emsgDeviceDisconnect").checked?256:0))+(Q("p20emsgDeviceHelp").checked?512:0)),meshserver.send({action:"changemeshnotify",meshid:currentMesh._id,notify:n})}function setupMeshSummaryStats(){window.meshPowerChart=new Chart(document.getElementById("meshPowerChart").getContext("2d"),{type:"doughnut",data:{datasets:[{data:[0,0],backgroundColor:["#20F","#40D","#60B","#809","#A07","#C05"]}]},options:{shadowColor:"blue",responsive:!0,plugins:{legend:{display:!1}},animation:{animateScale:!0,animateRotate:!0},layout:{padding:{left:10,right:10,top:10,bottom:10}}}}),window.meshOsChart=new Chart(document.getElementById("meshOsChart").getContext("2d"),{type:"doughnut",data:{datasets:[{data:[0,0],backgroundColor:["#20F","#30E","#40D","#50C","#60B","#70A","#809","#908","#A07","#B06","#C05"]}]},options:{responsive:!0,plugins:{legend:{display:!1}},animation:{animateScale:!0,animateRotate:!0},layout:{padding:{left:10,right:10,top:10,bottom:10}}}}),window.meshConnChart=new Chart(document.getElementById("meshConnChart").getContext("2d"),{type:"doughnut",data:{datasets:[{data:[0,0],backgroundColor:["#20F","#40D","#60B","#809","#A07","#C05"]}],labels:["未連接","代理","Intel&reg; AMT","代理+Intel&reg; AMT"]},options:{responsive:!0,plugins:{legend:{display:!1}},animation:{animateScale:!0,animateRotate:!0},layout:{padding:{left:10,right:10,top:10,bottom:10}}}}),window.meshSecurityChart=new Chart(document.getElementById("meshSecurityChart").getContext("2d"),{type:"doughnut",data:{datasets:[{data:[0,0],backgroundColor:["#20F","#40D","#60B","#809","#A07","#C05"]}],labels:["OK","殺毒軟件未激活","沒有自動更新","防火牆未激活","多個問題"]},options:{responsive:!0,plugins:{legend:{display:!1}},animation:{animateScale:!0,animateRotate:!0},layout:{padding:{left:10,right:10,top:10,bottom:10}}}})}function p21updateMesh(){if(null!=currentMesh){var e,t=GetMeshRights(currentMesh),n=EscapeHtml(currentMesh.name),o=(0==n.length&&(n="<i>沒有</i>"),0!=(1&t)&&(n='<span tabindex=0 title="單擊此處編輯裝置群名稱" onclick=p20editmesh(1) onkeyup="if (event.key == \'Enter\') p20editmesh(1)" role=button>'+n+' <i class="fa-solid fa-pencil fa-2xs"></i></span>'),QH("p21meshName",n),{}),i={},s=[0,0,0,0],a=[0,0,0,0,0],l=!1,r=!1,d=!1,c=!1;for(b in nodes)nodes[b].meshid==currentMesh._id&&(nodes[b].agent&&(l=!0,null==o[nodes[b].agent.id]?o[nodes[b].agent.id]=1:o[nodes[b].agent.id]++),nodes[b].pwr&&(r=!0,null==i[nodes[b].pwr]?i[nodes[b].pwr]=1:i[nodes[b].pwr]++),0==nodes[b].conn?(d=!0,s[0]++):0!=(6&nodes[b].conn)?(d=!0,0!=(1&nodes[b].conn)?s[3]++:s[2]++):0!=(1&nodes[b].conn)&&(d=!0,s[1]++),nodes[b].wsc)&&(c=!0,e=0,"OK"==nodes[b].wsc.antiVirus&&e++,"OK"==nodes[b].wsc.autoUpdate&&e++,"OK"==nodes[b].wsc.firewall&&e++,3==e?a[0]++:e<2?a[4]++:"OK"!=nodes[b].wsc.antiVirus?a[1]++:"OK"!=nodes[b].wsc.autoUpdate?a[2]++:"OK"!=nodes[b].wsc.firewall&&a[3]++);var u=[],p=[],m=[],g=[],h=3==currentMesh.mtype?agentsStrNoAgent:agentsStr;for(b in o)u.push(o[b]),p.push(h[b]);for(b in i)m.push(i[b]),g.push(powerStatetable[b]);window.meshPowerChart.config.data.datasets[0].data=m,window.meshPowerChart.config.data.labels=g,window.meshPowerChart.update(),2<=currentMesh.mtype&&(window.meshOsChart.config.data.datasets[0].data=u,window.meshOsChart.config.data.labels=p,window.meshOsChart.update()),window.meshConnChart.config.data.datasets[0].data=s,window.meshConnChart.update(),window.meshSecurityChart.config.data.datasets[0].data=a,window.meshSecurityChart.update();var v="",f=0;if(0<m.length){var x=[];for(b in i)x.push([powerStatetable[b],i[b]]);for(b in x.sort(function(e,t){return-(e[1]-t[1])}),v+='<table class="table table-hover table-striped" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col colspan=2 style=text-align:left;width:430px>電源狀態</th></tr>',x)v+="<tr style="+(++f%2==0?"background-color:#DDD":"")+"><td style=text-align:right;width:60px>"+x[b][1]+" <td> "+x[b][0]+"</tr>";v+="</tbody></table>"}if(0<u.length&&2<=currentMesh.mtype){var f=0,k=[];for(b in o)k.push([h[b],o[b]]);for(b in k.sort(function(e,t){return-(e[1]-t[1])}),v+='<table class="table table-hover table-striped" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col colspan=2 style=text-align:left;width:430px>代理類型</th></tr>',k)v+="<tr style="+(++f%2==0?"background-color:#DDD":"")+"><td style=text-align:right;width:60px>"+k[b][1]+"<td> "+k[b][0]+"</tr>";v+="</tbody></table>"}if(d){for(var y=[],b=f=0;b<4;b++)y.push([["未連接","代理","Intel&reg; AMT","代理+Intel&reg; AMT"][b],s[b]]);y.sort(function(e,t){return-(e[1]-t[1])}),v+='<table class="table table-hover table-striped" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col colspan=2 style=text-align:left;width:430px>連接性</th></tr>';for(b=0;b<4;b++)0<y[b][1]&&(v+="<tr style="+(++f%2==0?"background-color:#DDD":"")+"><td style=text-align:right;width:60px>"+y[b][1]+"<td> "+y[b][0]+"</tr>");v+="</tbody></table>"}if(c){for(var w=[],b=f=0;b<4;b++)w.push([['<img src="images/link2.png" style=cursor:pointer onclick=\'return p21setDevicesFilter("wsc:ok")\' width=10 height=10 /> OK','<img src="images/link2.png" style=cursor:pointer onclick=\'return p21setDevicesFilter("wsc:noav")\' width=10 height=10 /> 殺毒軟件未激活','<img src="images/link2.png" style=cursor:pointer onclick=\'return p21setDevicesFilter("wsc:noupdate")\' width=10 height=10 /> 沒有自動更新','<img src="images/link2.png" style=cursor:pointer onclick=\'return p21setDevicesFilter("wsc:nofirewall")\' width=10 height=10 /> 防火牆未激活','<img src="images/link2.png" style=cursor:pointer onclick=\'return p21setDevicesFilter("wsc:any")\' width=10 height=10 /> 多個問題'][b],a[b]]);w.sort(function(e,t){return-(e[1]-t[1])}),v+='<table class="table table-hover table-striped" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col colspan=2 style=text-align:left;width:430px>安全</th></tr>';for(b=0;b<4;b++)0<w[b][1]&&(v+="<tr style="+(++f%2==0?"background-color:#DDD":"")+"><td style=text-align:right;width:60px>"+w[b][1]+"<td> "+w[b][0]+"</tr>");v+="</tbody></table>"}""==v&&(v="<i>該裝置群中沒有裝置。</i>"),QH("p21info",v);t=(r?1:0)+(2<=currentMesh.mtype&&l?1:0)+(d?1:0)+(c?1:0);QS("meshPowerChartDiv").display=r?"inline-block":"none",QS("meshOsChartDiv").display=2<=currentMesh.mtype&&l?"inline-block":"none",QS("meshConnChartDiv").display=d?"inline-block":"none",QS("meshSecurityChartDiv").display=c?"inline-block":"none",QS("meshPowerChartDiv").width=3<t?"23%":"31%",QS("meshOsChartDiv").width=3<t?"23%":"31%",QS("meshConnChartDiv").width=3<t?"23%":"31%",QS("meshSecurityChartDiv").width=3<t?"23%":"31%"}}function p21setDevicesFilter(e){go(1),Q("KvmSearchInput").value=Q("SearchInput").value=e,mainUpdate(5)}var sortorder,filetreelocation=[];function updateFiles(){if(QV("MainMenuMyFiles",0==(8&features)),0==(8&features)){for(var e,t,n="",o="",i='<a href=# style=cursor:pointer onclick="return p5folderup(0)">根</a>',s="Root",a=filetree,l=1,r=[],d=filetreelinkpath,c=[],u=document.getElementsByName("fc"),p=0;p<u.length;p++)u[p].checked&&c.push(u[p].value);for(p in filetreelinkpath="",filetreelocation){if(null==a.f||null==a.f[filetreelocation[p]])break;r.push(filetreelocation[p]),s+=" / "+filetreelocation[p],1==l?(e=filetreelocation[p].split("/"),t=window.location.origin+domainUrl+e[0]+"files/"+e[2],filetreelinkpath+=filetreelocation[p]):""!=filetreelinkpath&&(filetreelinkpath+="/"+filetreelocation[p],2<l)&&(t+="/"+filetreelocation[p]),a=a.f[filetreelocation[p]],i+=' / <a href=# style=cursor:pointer onclick="return p5folderup('+l+')">'+EscapeHtml(null!=a.n?a.n:filetreelocation[p])+"</a>",l++}filetreelocation=r;var m=s.toLowerCase().startsWith("root / "+userinfo._id+" / public"),g=p5sort_files(a.f);for(p in g){var h,v,f=g[p],x=f.n,k=70<x.length?'<span title="'+EscapeHtml(x)+'">'+EscapeHtml(x.substring(0,70))+"...</span>":EscapeHtml(x),y="",b=(null!=f.d&&(y=printDateTime(new Date(f.d))+"&nbsp;"),""),w=(null!=f.s&&(b=getFileSizeStr(f.s)),"");w=f.t<3||4==f.t?(h=1==f.t||4==f.t?p5getQuotabar(f):"",'<div class=filelist file=999><input file=999 style=float:left name=fc class="fcb form-check-input me-2" type=checkbox onchange=p5setActions() value="'+EscapeHtml(x)+'">&nbsp;<span style=float:right title="">'+h+"</span><span><div class=fileIcon"+f.t+' onclick=p5folderset("'+encodeURIComponentEx(f.nx)+'")></div><a href=# style=cursor:pointer onclick=\'return p5folderset("'+encodeURIComponentEx(f.nx)+"\")'>"+k+"</a></span></div>"):(x=k,h="",v=urlargs.key?"&key="+urlargs.key:"",m&&(h='<i class="fa-regular fa-copy" style=cursor:pointer title="顯示公共鏈結" onclick=\'return p5showPublicLink("'+t+"/"+encodeURIComponentEx(f.nx)+"?download=1"+v+'")\'></i> <i class="fa-regular fa-copy" title="複製連結到剪貼板" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(t+"/"+encodeURIComponentEx(f.nx)+"?download=1"+v)+'")></i>'),0<f.s&&(x=h+'<a onclick=downloadFile("downloadfile.ashx?link='+encodeURIComponentEx(filetreelinkpath+"/"+f.nx)+'")>'+k+"</a>"),'<div class=filelist file=3><input file=3 style=float:left name=fc class="fcb form-check-input me-2" type=checkbox onchange=p5setActions() value="'+f.nx+'">&nbsp;<span class=fsize>'+y+"</span><span style=float:right>"+b+"</span><span><div class=fileIcon"+f.t+"></div>"+x+"</span></div>"),f.t<3?n+=w:o+=w}if(QH("p5rightOfButtons",p5getQuotabar(a)),QH("p5files",n+o),QH("p5currentpath",i),QE("p5FolderUp",0!=filetreelocation.length),QV("p5PublicShare",m),d==filetreelinkpath)for(u=document.getElementsByName("fc"),p=0;p<u.length;p++)u[p].checked=0<=c.indexOf(u[p].value);p5setActions()}}function getNiceSize(e){return e<=0?"超出儲存空間":e<2048?format("剩餘{0}個字節",e):e<2097152?format("剩餘{0}千字節",Math.round(e/1024)):e<2147483648?format("剩餘{0}兆字節",Math.round(e/1024/1024)):format("剩餘{0} GB",Math.round(e/1024/1024/1024))}function getNiceSize2(e){return e<=0?"沒有":e<2048?format("{0} b",e):e<2097152?format("{0} Kb",Math.round(e/1024)):e<2147483648?format("{0} Mb",Math.round(e/1024/1024)):format("{0} Gb",Math.round(e/1024/1024/1024))}function getNiceSize3(e){return e<=0?"沒有":e<2048?format("{0} b",e):e<2097152?format("{0} Kb",round(e/1024,1)):e<2147483648?format("{0} Mb",round(e/1024/1024,1)):format("{0} Gb",round(e/1024/1024/1024,1))}function p5getQuotabar(e){for(;1<e.t&&4!=e.t;)e=e.parent;var t,n;return 1!=e.t&&4!=e.t||null==e.maxbytes?"":(t=Math.floor(e.s/1024),n=e.maxbytes-e.s,'<span title="'+(1<e.c?format("{1}k在{0}個檔案中。最多{2}k",t,e.c,Math.floor(e.maxbytes/1024/1024)):format("{0}k在1檔案內。最多{1}k",t,Math.floor(e.maxbytes/1024/1024)))+'">'+getNiceSize(n)+" <progress style=height:10px;width:100px value="+e.s+" max="+e.maxbytes+" /></span>")}function p5showPublicLink(e){return setModalContent("xxAddAgent","公開鏈結",'<input type=text style=width:350px value="'+e+'" readonly /> <i class="fa-regular fa-copy" title="複製連結到剪貼板" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(e)+'")></i>'),showModal("xxAddAgentModal","idx_dlgOkButton"),!1}function p5sort_filename(e,t){return e.ln>t.ln?+sortorder:e.ln<t.ln?-1*sortorder:0}function p5sort_timestamp(e,t){return e.d>t.d?+sortorder:e.d<t.d?-1*sortorder:0}function p5sort_bysize(e,t){return e.s==t.s?p5sort_filename(e,t):(e.s-t.s)*sortorder}function p5sort_files(e){var t,n=[],o=Q("p5sortdropdown").value;for(t in e)e[t].nx=t,null==e[t].n&&(e[t].n=t),e[t].ln=e[t].n.toLowerCase(),n.push(e[t]);return sortorder=1,3<o&&(sortorder=-1,o-=3),1==o?n.sort(p5sort_filename):2==o?n.sort(p5sort_bysize):3==o&&n.sort(p5sort_timestamp),n}function p5setActions(){var e=getFileSelCount(),t=getFileCount(),n=getFileSelCount(!1);QE("p5DeleteFileButton",0<e&&0<filetreelocation.length),QE("p5ViewFileButton",1==e&&1==n&&0<filetreelocation.length),QE("p5NewFolderButton",0<filetreelocation.length),QE("p5UploadButton",0<filetreelocation.length),QE("p5DownloadButton",0<e&&e==n&&0<filetreelocation.length),QE("p5RenameFileButton",1==e&&0<filetreelocation.length),QE("p5SelectAllButton",0<t),Q("p5SelectAllButton").value=0<e?"選擇無":"全選",QE("p5CutButton",0<n&&e==n),QE("p5CopyButton",0<n&&e==n),QE("p5PasteButton",null!=p5clipboard&&0<p5clipboard.length&&0<filetreelocation.length)}function getFileSelCount(e){for(var t=0,n=document.getElementsByName("fc"),o=0;o<n.length;o++)!n[o].checked||0==e&&"3"!=n[o].attributes.file.value||t++;return t}function getFileSelDirCount(){for(var e=0,t=document.getElementsByName("fc"),n=0;n<t.length;n++)t[n].checked&&"999"==t[n].attributes.file.value&&e++;return e}function getFileCount(){return document.getElementsByName("fc").length}function p5selectallfile(){for(var e=0==getFileSelCount(),t=document.getElementsByName("fc"),n=0;n<t.length;n++)t[n].checked=e;p5setActions()}function setupBackPointers(e){if(null!=e.f){var t,n=0,o=0;for(t in e.f)setupBackPointers(e.f[t]),(e.f[t].parent=e).f[t].s&&(n+=e.f[t].s),e.f[t].c&&(o+=e.f[t].c),3==e.f[t].t&&o++;e.s=n,e.c=o}return e}function getFileSizeStr(e){return 1==(e="number"!=typeof e?0:e)?"1個位元組":format("{0}個字節",e)}function p5folderup(e){if(null==e)filetreelocation.pop();else for(;filetreelocation.length>e;)filetreelocation.pop();return updateFiles(),!1}function p5folderset(e){return filetreelocation.push(decodeURIComponent(e)),updateFiles(),!1}function p5createfolder(){setModalContent("xxAddAgent","新建檔案夾",'<input type=text id=p5renameinput class="form-control" maxlength=64 onkeyup=p5fileNameCheck(event) />'),showModal("xxAddAgentModal","idx_dlgOkButton",p5createfolderEx),focusTextBox("p5renameinput"),p5fileNameCheck()}function p5createfolderEx(){meshserver.send({action:"fileoperation",fileop:"createfolder",path:filetreelocation,newfolder:Q("p5renameinput").value})}function p5deletefile(){var e=getFileSelCount(),t=0<getFileSelDirCount()?'<br /><br /><label><input type=checkbox class="form-check-input me-2" id=p5recdeleteinput>遞迴刪除</label><br>':"<input type=checkbox id=p5recdeleteinput class=\"form-check-input me-2\" style='display:none'>";setModalContent("xxAddAgent","刪除",1<e?format("刪除{0}個所選項目？",e)+t:"刪除所選項目？"+t),showModal("xxAddAgentModal","idx_dlgOkButton",p5deletefileEx)}function p5deletefileEx(){for(var e=[],t=document.getElementsByName("fc"),n=0;n<t.length;n++)t[n].checked&&e.push(t[n].value);meshserver.send({action:"fileoperation",fileop:"delete",path:filetreelocation,delfiles:e,rec:Q("p5recdeleteinput").checked})}function p5renamefile(){for(var e,t=document.getElementsByName("fc"),n=0;n<t.length;n++)t[n].checked&&(e=t[n].value);setModalContent("xxAddAgent","改名",'<input type=text id=p5renameinput class="form-control" maxlength=64 onkeyup=p5fileNameCheck(event) value="'+e+'" />'),showModal("xxAddAgentModal","idx_dlgOkButton",p5renamefileEx),focusTextBox("p5renameinput"),p5fileNameCheck()}function p5renamefileEx(e,t){t.newname=Q("p5renameinput").value,meshserver.send(t)}function p5fileNameCheck(e){var t=isFilenameValid(Q("p5renameinput").value);QE("idx_dlgOkButton",t),1==t&&e&&13==e.keyCode&&dialogclose(1)}var isFilenameValid=(()=>{var t=/^[^\\/:\*\?"<>\|]+$/,n=/^\./,o=/^(nul|prn|con|lpt[0-9]|com[0-9])(\.|$)/i;return function(e){return t.test(e)&&!n.test(e)&&!o.test(e)&&"."!=e[0]}})();function p5uploadFile(){setModalContent("xxAddAgent","上載檔案",'<form method=post enctype=multipart/form-data action=uploadfile.ashx target=fileUploadFrame><input type=text name=link style=display:none id=p5uploadpath value="'+encodeURIComponentEx(filetreelinkpath)+'" /><input type=file name=files id=p5uploadinput class="form-control" multiple=multiple onchange="p5updateUploadDialogOk(\'p5uploadinput\')" /><input type=hidden name=authCookie value='+authCookie+' /><input type=submit id=p5loginSubmit class="btn btn-outline-success mt-2" style="display:none" /><span id=p5confirmOverwriteSpan style=display:none><br/><label><input type=checkbox class="form-check-input me-2" id=p5confirmOverwrite onchange="p5updateUploadDialogOk(\'p5uploadinput\')" />確認覆蓋？</label></span></ >'),showModal("xxAddAgentModal","idx_dlgOkButton",p5uploadFileEx),p5updateUploadDialogOk("p5uploadinput")}function p5uploadFileEx(){Q("p5loginSubmit").click()}function p5GetFileInfo(e){var t,n=filetree;for(t in filetreelocation)null!=n.f&&null!=n.f[filetreelocation[t]]&&(n=n.f[filetreelocation[t]]);return n.f[e]}function p5updateUploadDialogOk(){var e=Q("p5uploadinput").files,t=[];for(s in e)null!=e[s].size&&0!=e[s].size&&t.push(e[s]);var n=filetree,o=[],i=0;for(s in filetreelocation)null!=n.f&&null!=n.f[filetreelocation[s]]&&(n=n.f[filetreelocation[s]]);if(QE("idx_dlgOkButton",0<e.length),0<e.length){if(null!=n.f){for(var s in n.f)o.push(s);for(s=0;s<e.length;s++)0<=o.indexOf(e[s].name)&&i++}QV("p5confirmOverwriteSpan",0<i),0<i?QE("idx_dlgOkButton",Q("p5confirmOverwrite").checked):(Q("p5confirmOverwrite").checked=!1,QE("idx_dlgOkButton",!0))}}function p5viewfile(){for(var e,t=document.getElementsByName("fc"),n=0;n<t.length;n++)if(t[n].checked)return null==(e=p5GetFileInfo(t[n].value))?void 0:void(e.s<=204800?meshserver.send({action:"fileoperation",fileop:"get",path:filetreelocation,file:t[n].value,tag:"edit"}):messagebox("檔案編輯器","只能編輯小於200k的檔案。"))}var p5clipboard=null,p5clipboardFolder=null,p5clipboardCut=0;function p5copyFile(e){var t=document.getElementsByName("fc");p5clipboard=[],p5clipboardCut=e,p5clipboardFolder=Clone(filetreelocation);for(var n=0;n<t.length;n++)t[n].checked&&"3"==t[n].attributes.file.value&&p5clipboard.push(t[n].value);p5updateClipview()}function p5pasteFile(){var e="";setModalContent("xxAddAgent","糊",e=null!=p5clipboard&&0<p5clipboard.length?format("將{1}入口{2}中的{0}限製到此位置？",0==p5clipboardCut?"copy":"move",p5clipboard.length,1<p5clipboard.length?"s":""):e),showModal("xxAddAgentModal","idx_dlgOkButton",p5pasteFileEx)}function p5pasteFileEx(){meshserver.send({action:"fileoperation",fileop:0==p5clipboardCut?"copy":"move",scpath:p5clipboardFolder,path:filetreelocation,names:p5clipboard}),p5folderup(999),1==p5clipboardCut&&(p5clipboardFolder=p5clipboard=null,p5clipboardCut=0,p5updateClipview())}function p5updateClipview(){var e="";null!=p5clipboard&&0<p5clipboard.length&&(e=format("保存{0}項目{1}給{2}",p5clipboard.length,1<p5clipboard.length?"s":"",0==p5clipboardCut?"複製":"移動")+', <a href=# onclick="return p5clearClip()" style=cursor:pointer>清除</a>.'),QH("p5bottomstatus",e),p5setActions()}function p5clearClip(){return p5clipboardFolder=p5clipboard=null,p5clipboardCut=0,p5updateClipview(),!1}function p5fileDragDrop(e){if(!xxdialogMode&&(haltEvent(e),QV("bigfail",!1),QV("bigok",!1),null!=e.dataTransfer)){var t=[];for(s in e.dataTransfer.files)null!=e.dataTransfer.files[s].size&&0!=e.dataTransfer.files[s].size&&t.push(e.dataTransfer.files[s]);if(0!=t.length){var n=filetree,o=[],i=0;for(s in filetreelocation)null!=n.f&&null!=n.f[filetreelocation[s]]&&(n=n.f[filetreelocation[s]]);if(null!=n.f){for(var s in n.f)o.push(s);for(s=0;s<e.dataTransfer.files.length;s++)0<=o.indexOf(e.dataTransfer.files[s].name)&&i++}0==i?p5PerformUpload(1,e.dataTransfer.files):(setModalContent("xxAddAgent","上載檔案",format(1==i?"上傳將覆蓋1個檔案。繼續？":"上傳將覆蓋{0}個檔案。繼續？",i)),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p5PerformUpload(3,e.dataTransfer.files)))}}}function p5PerformUpload(e,t){var n=0;p5uploadFile();try{Q("p5uploadinput").files=t}catch(e){n=1}if(0==n&&p5uploadFileEx(),setDialogMode(0),1==n&&0!=filetreelocation.length){for(var o=[],i=[],s=[],a=[],l=t.length,r=0,d=0;d<t.length;d++)r+=t[d].size;if(13e5<r)p5uploadFile();else for(d=0;d<t.length;d++){var c=new FileReader,u=t[d];o.push(u.name),i.push(u.size),s.push(u.type),c.onload=function(e){a.push(e.target.result),0==--l&&(Q("p5fileDragName").value=o.join("*"),Q("p5fileDragSize").value=i.join("*"),Q("p5fileDragType").value=s.join("*"),Q("p5fileDragData").value=a.join("*"),Q("p5fileDragLink").value=encodeURIComponentEx(filetreelinkpath),Q("p5fileDragAuthCookie").value=authCookie,Q("p5loginSubmit2").click())},c.readAsDataURL(u)}}}var p5dragtimer=null;function p5fileDragOver(e){xxdialogMode||(haltEvent(e),null!=p5dragtimer&&(clearTimeout(p5dragtimer),p5dragtimer=null),e=!0,0==filetreelocation.length&&(e=!1),QV("bigok",e),QV("bigfail",!e))}function p5fileDragLeave(e){xxdialogMode||(haltEvent(e),"p5filetable"!=e.target.id?(QV("bigfail",!1),QV("bigok",!1)):p5dragtimer=setTimeout(function(){QV("bigfail",!1),QV("bigok",!1),p5dragtimer=null},10))}function p5downloadButton(){for(var e=document.getElementsByName("fc"),t=0;t<e.length;t++)e[t].checked&&downloadFile("downloadfile.ashx?link="+encodeURIComponentEx(filetreelinkpath+"/"+e[t].value))}var eventsMessageId={1:"帳號登錄",2:"帳戶登出",3:"語言從{1}更改為{2}",4:"已加入桌面Multiplex會話",5:"離開桌面多路復用會話",6:"啟動桌面多路復用會話",7:"錄製會話已完成，{0}秒",8:"封閉式桌面多路復用會話，{0}秒",9:"從{1}到{2}，{3}秒結束了中繼會話“{0}”",10:"從{1}到{2}，{3}秒結束了終端會話“{0}”",11:"從{1}到{2}，{3}秒結束了桌面會話“{0}”",12:"從{1}到{2}，{3}秒結束了文件管理會話“{0}”",13:"從{1}到{2}開始中繼會話“{0}”",14:"從{1}到{2}開始了終端會話“{0}”",15:"從{1}到{2}開始了桌面會話“{0}”",16:"從{1}到{2}開始文件管理會話“{0}”",17:"處理控制台命令：“{0}”",18:"顯示消息框，標題= “{0}”，消息= “{1}”",19:"殺死進程{0}",20:"開場：{0}",21:"正在獲取剪貼板內容，{0}個字節",22:"設置剪貼板內容，{0}個字節",23:"嘗試激活英特爾（R）AMT ACM模式",24:"運行命令",25:"執行電源操作= {0}，強制執行= {1}",26:"顯示吐司消息，標題= “{0}”，消息= “{1}”",27:"本地用戶接受的遠程終端請求",28:"本地用戶拒絕了遠程終端請求",29:"本地用戶強行關閉了遠程桌面連接",30:"接受本地用戶後啟動遠程桌面",31:"遠程桌面連接欄已激活/更新",32:"遠程桌面連接欄失敗或不受支持",33:"本地用戶強行關閉了遠程桌面連接",34:"本地用戶拒絕後無法啟動遠程桌面",35:"使用Toast通知啟動遠程桌面",36:"啟動遠程桌面，而無需通知",37:"遠程桌面連接欄已激活/更新",38:"遠程桌面連接欄失敗或不受支持",39:"本地用戶強行關閉了遠程桌面連接",40:"本地用戶接受後啟動遠程文件",41:"本地用戶拒絕後無法啟動遠程文件",42:"啟動帶有Toast通知的遠程文件",43:"已啟動的遠程文件，恕不另行通知",44:"創建文件夾：“{0}”",45:"刪除：“{0}”",46:"遞歸刪除：“{0}”，{1}個元素已刪除",47:"刪除：“{0}”，已刪除{1}個元素",48:"重命名：“{0}”為“{1}”",49:"下載：“{0}”",50:"上傳：“{0}”",51:"複製：“{0}”到“{1}”",52:"移動：“{0}”到“{1}”",53:"將遠程用戶鎖定在桌面之外",54:"代理關閉了與{0}％代理到服務器壓縮的會話。已發送：{1}，已壓縮：{2}",55:"創建的設備組：{0}",56:"未刪除的設備組：{0}",57:"已將設備{0}添加到設備組{1}",58:"設備請求激活Intel（R）AMT ACM，FQDN：{0}",59:"{1}組中的設備{0}已更改：{2}",60:"刪除了{0}的用戶設備權限",61:"已更改{0}的用戶設備權限",62:"從用戶組{1}中刪除了用戶{0}",63:"帳戶已刪除",64:"帳戶已創建，用戶名是{0}",65:"創建帳戶，電子郵件為{0}",66:"帳戶已更改：{0}",67:"用戶組成員身份已更改：{0}",68:"已將用戶組{0}添加到設備組{1}",69:"已創建用戶組：{0}",70:"從設備組{1}中刪除了用戶組{0}",71:"已將用戶{0}添加到用戶組{1}",72:"從用戶組{1}中刪除了用戶{0}",73:"設備組通知已更改",74:"帳戶密碼已更改：{0}",75:"帳戶憑證已更改",76:"設備組已創建：{0}",77:"設備組已刪除：{0}",78:"設備組成員身份已更改：{0}",79:"用戶組已更改：{0}",80:"已將用戶{0}添加到用戶組{1}",81:"刪除了{0}的用戶設備權限",82:"已更改{0}的用戶設備權限",83:"已從設備組{1}中刪除用戶{0}",84:"已將設備{0}添加到設備組{1}",85:"將設備{0}移動到組{1}",86:"刪除了{0}的用戶設備權限",87:"從設備組{1}中刪除了設備{0}",88:"啟用電子郵件兩因素身份驗證",89:"禁用的電子郵件兩因素身份驗證",90:"添加了身份驗證應用程序",91:"刪除身份驗證應用程序",92:"生成新的2FA備份代碼",93:"2FA備份代碼已清除",94:"移除安全密鑰",95:"添加了安全密鑰",96:"用戶{0}的已驗證電話號碼",97:"已刪除用戶{0}的電話號碼",98:"已請求幫助，用戶：{0}，詳細信息：{1}",99:"以用戶身份運行命令",100:"如果可能，以用戶身份運行命令",101:"已將設備共享{0}從{1}添加到{2}",102:"刪除的設備共享{0}",103:"將{0}個文件批量上傳到文件夾{1}",104:"自動下載代理程序核心轉儲文件：“{0}”",105:'上傳："{0}"，大小：{1}',106:'下載："{0}"，大小：{1}',107:"從 {0}、{1}、{2} 登錄帳戶",108:"使用來自 {0}、{1}、{2} 的錯誤第二因素的用戶登錄嘗試",109:"用戶從 {0}、{1}、{2} 嘗試登錄鎖定帳戶",110:"來自 {0}、{1}、{2} 的用戶登錄嘗試無效",111:"設備請求 Intel(R) AMT ACM TLS 激活，FQDN：{0}",112:'從 {1} 到 {2} 結束的 Messenger 會話 "{0}"，{3} 秒',113:"增加推送通知認證設備",114:"移除推送通知認證設備",115:"添加了登錄令牌",116:"刪除了登錄令牌",117:"這是舊代理版本，請考慮更新。",118:"此代理具有過時的證書驗證機制，請考慮更新。",119:"此代理正在使用不安全的隧道，請考慮更新。",120:'已啟動本地中繼會話 "{0}"，協議 {1} 到 {2}',121:'已結束本地中繼會話 "{0}"，協議 {1} 到 {2}，{3} 秒',122:"{0} 秒後離開桌面多路復用會話。",123:'{0} 秒後離開 Web-SSH 會話 "{1}"。',124:'{0} 秒後離開 Web-SFTP 會話 "{1}"。',125:'{0} 秒後離開 Web-RDP 會話 "{1}"。',126:"{0} 秒後離開 Web-VNC 會話。",127:"將帳戶顯示名稱更改為 {0}。",128:"已創建帳戶，名稱為 {0}。",129:"刪除了帳戶顯示名稱。",130:"用戶通知已更改",131:"添加了無限時間的設備共享 {0}。",132:"打開。",133:"關掉。",134:"強行斷開用戶 {0} 的桌面會話",135:"強制斷開用戶 {0} 的終端會話",136:"強制斷開用戶 {0} 的文件會話",137:"強制斷開用戶 {0} 的路由會話",138:"添加了每天重複的設備共享 {0}。",139:"添加了每週重複的設備共享 {0}。",140:"{1}組中的設備{0}已更改：{2}",141:"英特爾(r) AMT 政策變更",142:"設備組 {0} 已更改：{1}",143:'已加入桌面多路復用會話 "{0}"',144:'{1} 秒後離開桌面多路復用會話 "{0}"。',145:'已啟動桌面多路復用會話 "{0}"',146:'已完成錄製會話 "{0}"，{1} 秒',147:'已關閉桌面多路復用會話 "{0}"，{1} 秒',148:'已啟動 Web-SSH 會話 "{0}"。',149:'已啟動 Web-SFTP 會話 "{0}"。',150:'已啟動 Web-RDP 會話 "{0}"。',151:'已啟動 Web-VNC 會話 "{0}"。',152:"不再是“{0}”的中繼。",153:'是 "{0}" 的中繼。',154:"Account changed to sync with LDAP data.",155:"Denied user login from {0}, {1}, {2}",156:"Verified messaging account of user {0}",157:"Removed messaging account of user {0}",158:'Displaying alert box, title="{0}", message="{1}"',159:"Device Powered On",160:"Enabled Duo two-factor authentication",161:"Disabled Duo two-factor authentication"},eventsShortMessageId={1:"團隊名字",2:"描述",3:"標誌",4:"同意",5:"自動刪除",6:"邀請代碼",7:"繼電器裝置"};function eventMouseHover(e,t){e.children[1].classList.remove("g1s"),e.children[2].classList.remove("style10s"),1==t&&(e.children[1].classList.add("g1s"),e.children[2].classList.add("style10s"))}function eventsUpdate(){var e="",t=null;for(a in events){var n=events[a],o=new Date(n.time);if(n.msg){null==n.h&&(n.h=Math.random()),printDate(o)!=t&&(null!=t&&(e+="</table>"),e+='<table class="table table-hover p3eventsTable" cellpadding=0 cellspacing=0><tr><td colspan=4 class=DevSt>'+(t=printDate(o))+"</td></tr>");var i,s="fa-mobile-screen";if("ugrp"==n.etype&&(s="fa-users"),"user"==n.etype&&(s="fa-user"),"server"==n.etype&&(s="fa-server"),null==n.msgid||null==eventsMessageId[n.msgid])i="string"==typeof n.msg?EscapeHtml(n.msg).split("(R)").join("&reg;"):"";else{if(i=eventsMessageId[n.msgid],null!=n.msgArgs)for(var a in n.msgArgs){var l=n.msgArgs[a];if(Array.isArray(l)){var r,d=[];for(r in l)"number"==typeof l[r]&&eventsShortMessageId[l[r]]?d.push(eventsShortMessageId[l[r]]):d.push(l[r]);l=d.join("，")}else"string"==typeof l&&0==l.indexOf("DATETIME:")&&(l=printFlexDateTime(new Date(parseInt(l.substring(9)))));i=i.split("{"+a+"}").join(l)}i=EscapeHtml(i).split("(R)").join("&reg;")}if(n.nodeid){var c=getNodeFromId(n.nodeid);if(null!=c){switch(c.icon){case 1:s="fa-computer";break;case 2:s="fa-laptop";break;case 8:s="fa-laptop-code"}i="<a href=# onclick='gotoDevice(\""+n.nodeid+"\",10);haltEvent(event);'>"+EscapeHtml(c.name)+"</a> &rarr; "+i}}n.username&&(c="",n.guestname&&(c=' / <span title="這是一個嘉賓分享會">'+EscapeHtml(n.guestname)+"</span>"),i=2&userinfo.siteadmin&&n.userid?"<a href=# onclick='gotoUser(\""+encodeURIComponentEx(n.userid)+"\");haltEvent(event);'>"+EscapeHtml(n.username)+"</a>"+c+" &rarr; "+i:EscapeHtml(n.username)+c+" &rarr; "+i),n.remoteaddr&&(i+=" ("+n.remoteaddr+")"),"relay"!=n.etype&&"relaylog"!=n.action||(s="fa-arrow-right-arrow-left"),e+="<tr onclick=showEventDetails("+n.h+',2)  onmouseover=eventMouseHover(this,1) onmouseout=eventMouseHover(this,0) role=button><td style=width:18px><i class="fa-fw fa-solid '+s+'"></i></td><td class=g1>&nbsp;</td><td class=style10>'+printTime(o)+" - "+i+"</td></tr><tr></tr>"}}null!=t&&(e+="</table>"),""==e&&(e="<br><i>找不到事件</i><br><br>"),QH("p3events",e)}function refreshEvents(){""!=p3filterevents.value?meshserver.send({action:"events",limit:parseInt(p3limitdropdown.value),filter:p3filterevents.value}):meshserver.send({action:"events",limit:parseInt(p3limitdropdown.value)})}function p3showReportDialog(){var e;xxdialogMode||(e="<div style=float:right><img src='images/report60.png' height=74 width=60 style=padding-top:2px /></div><div>",setModalContent("xxAddAgent","下載報告",e=(e=(e=(e=(e+=addHtmlFormFloating("報告類型",'<select id=d2reportType class="form-select" onchange=p3showReportValidation()><option value=1>所有事件</option>'))+addHtmlFormFloating("時間跨度",'<select id=d2reportSpan class="form-select" onchange=p3showReportValidation()><option value=1>全部可用</option><option value=2>一天</option></select>'))+("<div id=d2daySelector>"+addHtmlFormFloating("報告日",'<input type=date id=d2reportDay class="form-control" onchange=p3showReportValidation()></input>')+"</div>"))+addHtmlFormFloating("通過...分群",'<select id=d2reportGroupBy class="form-select" onchange=p3showReportValidation()><option value=1>沒有</option><option value=2>裝置群</option><option value=3>用戶</option>'))+addHtmlFormFloating("格式化",'<select id=d2reportFormat class="form-select" onchange=p3showReportValidation()><option value=1>CSV</option><option value=2>JSON</option>')+"</div>"),showModal("xxAddAgentModal","idx_dlgOkButton"),p3showReportValidation(),Q("d2reportType").focus())}function p3showReportValidation(){Q("d2reportType").value;var e=Q("d2reportSpan").value,t=Q("d2reportDay").value,n=(Q("d2reportGroupBy").value,Q("d2reportFormat").value,QV("d2daySelector",2==e),!0);2==e&&""==t&&(n=!1),QE("idx_dlgOkButton",n)}function p3showDownloadEventsDialog(e){var t;xxdialogMode||(t="使用以下一種檔案格式下載事件列表。<br /><br />",setModalContent("xxAddAgent","事件列表輸出",t=(t+=addHtmlValue("CSV格式",'<a href=# style=cursor:pointer onclick="return p3downloadEventsDialogCSV('+e+')">eventslist.csv</a>'))+addHtmlValue("JSON格式",'<a href=# style=cursor:pointer onclick="return p3downloadEventsDialogJSON('+e+')">eventslist.json</a>')),showModal("xxAddAgentModal","idx_dlgOkButton"))}function p3downloadEventsDialogCSV(e){var t,n,o;for(o in 1==e&&(n=currentDeviceEvents),2==e&&(n=events),t="utc，時間，類型，指令，用戶，裝置，消息\r\n",n=3==e?currentUserEvents:n){var i,s="";n[o].nodeid&&(i=getNodeFromId(n[o].nodeid))&&i.name&&(s=i.name),t+='"'+n[o].time+'","'+printDateTime(new Date(n[o].time))+'","'+n[o].etype+'","'+(null!=n[o].action?n[o].action:"")+'","'+(null!=n[o].username?n[o].username:"")+'","'+EscapeHtml(s)+'","'+(null!=n[o].msg?n[o].msg:"").split(",").join(" -")+'"\r\n'}return saveAs(stringToUtf8Blob(t),"eventslist.csv"),!1}function p3downloadEventsDialogJSON(e){var t,n,o=[];for(n in 1==e&&(t=currentDeviceEvents),2==e&&(t=events),t=3==e?currentUserEvents:t)o.push(events[n]);return saveAs(new Blob([JSON.stringify(o,null,2)],{type:"application/octet-stream"}),"eventslist.json"),!1}function updateUsers(){if(QV("UserNewAccountButton",0==(4&features)&&0==serverinfo.domainauth),null==users||0!=(4&features))QH("p3users","");else{var e=null!=userViewSettings&&userViewSettings.noViewLimit?1e5:100,t=[],n=e,o=0;for(c in users)t.push(users[c]);t.sort(nameSort);for(var i=Q("UserSearchInput").value.toLowerCase(),s=i,a=(i.startsWith("email:")?(i=null,s=s.substring(6)):i.startsWith("name:")?(s=null,i=i.substring(5)):i.startsWith("e:")?(i=null,s=s.substring(2)):i.startsWith("n:")&&(s=null,i=i.substring(2)),'<table class="table table-hover" cellpadding=0 cellspacing=0>'),l=!0,r=(a+="<th>名稱<th style=width:80px>裝置群<th style=width:120px>"+nobreak("最後訪問")+"<th style=width:120px>權限",[]),d=document.getElementsByClassName("UserCheckbox"),c=0;c<d.length;c++)d[c].checked&&r.push(d[c].value);for(c in t){var u=t[c],p=null;null!=(p=null!=wssessions?wssessions[u._id]:p)&&(null!=i&&(""==i||0<=u.name.toLowerCase().indexOf(i))||null!=s&&null!=u.email&&0<=u.email.toLowerCase().indexOf(s))&&(0<n?(l&&(a+="<tr><td class=userTableHeader colspan=4>在線用戶",l=!1),a+=addUserHtml(u,p),n--):o++)}for(c in l=!0,t){u=t[c],p=null;null==(p=null!=wssessions?wssessions[u._id]:p)&&(null!=i&&(""==i||0<=u.name.toLowerCase().indexOf(i))||null!=s&&null!=u.email&&0<=u.email.toLowerCase().indexOf(s))&&(0<n?(l&&(a+="<tr><td class=userTableHeader colspan=4>離線用戶",l=!1),a+=addUserHtml(u,p),n--):o++)}a+="</table>",1==o?a+="<br />有1個用戶沒有顯示，請使用搜尋框搜尋用戶...<br />":1<o&&(a+="<br />"+format("{0}未顯示更多用戶，請使用搜索框查找用戶...",o)+"<br />"),n==e&&(a+="<br />未找到相應的用戶。<br />"),QH("p3users",a);for(var d=document.getElementsByClassName("UserCheckbox"),m=encodeURIComponentEx(userinfo._id),c=0;c<d.length;c++)d[c].checked=0<=r.indexOf(d[c].value)&&d[c].value!=m;p3updateInfo(),null!=currentUser&&30==xxcurrentView&&gotoUser(encodeURIComponentEx(currentUser._id),!0)}}function addUserHtml(e,t){var n="",o=" gray",i="",s=e._id!=userinfo._id,a="",l="",t=(null!=t?(o="",s&&(i='<span style=float:right;margin-top:1px;margin-right:4px title=聊天><a href=# onclick=userChat(event,"'+encodeURIComponentEx(e._id)+'","'+encodeURIComponentEx(e.name)+"\")><img src='images/icon-chat.png' height=16 width=16 style=padding-top:2px /></a></span>",i+="<span style=float:right;margin-top:1px;margin-left:4px;margin-right:4px title=Notify><a href=# onclick='return showUserAlertDialog(event,\""+encodeURIComponentEx(e._id)+"\")'><img src='images/icon-notify.png' height=16 width=16 style=padding-top:2px /></a></span>"),a+=nobreak(1==t?"1節":format("{0}節",t))):e.access?a+='<span title="'+format("上次訪問：{0}",printDateTime(new Date(1e3*e.access)))+'">'+printDate(new Date(1e3*e.access))+"</span>":e.login&&(a+='<span title="'+format("上次登入：{0}",printDateTime(new Date(1e3*e.login)))+'">'+printDate(new Date(1e3*e.login))+"</span>"),s&&(l+="<a href=# style=cursor:pointer onclick='return showUserAdminDialog(event,\""+encodeURIComponentEx(e._id)+"\")'>"),null!=e.siteadmin&&0!=(32&e.siteadmin)&&4294967295!=e.siteadmin&&(l+="已鎖定,&nbsp;"),l+="<span title='伺服器權限'>",4294966047&e.siteadmin),r=(null==e.siteadmin||0==t?l+="用戶":8==t?l+="用戶+檔案":4294967295==e.siteadmin?l+="管理員":l+=0!=(2&t)?"經理":"部分的",null!=e.siteadmin&&4294967295!=e.siteadmin&&0!=(1216&e.siteadmin)&&(l+="*"),l+="</span>",s&&(l+="</a>"),0);if(e.links)for(var d in e.links)d.startsWith("mesh/")&&r++;var t=EscapeHtml(e.name),s="";return 1==serverinfo.emailcheck&&(s=1!=e.emailVerified?' <b style=color:red title="電郵未驗證">&#x2717;</b>':' <b style=color:green title="電子郵件已驗證">&#x2713</b>'),null!=e.email&&(0==(2097152&features)||e.email.toLowerCase()!=e.name.toLowerCase()?t+=', <a href="mailto:'+EscapeHtml(e.email)+'">'+EscapeHtml(e.email)+"</a>"+s:t+=' <a href="mailto:'+EscapeHtml(e.email)+'"><img src="images/mail12.png" height=9 width=12 title="發送電郵給用戶" style="margin-top:2px" /></a>'+s),null!=serverinfo.crossDomain&&""!=(s=e._id.split("/")[1])&&(t+=", <span style=color:#26F>"+s+"</span>"),(0<e.otpsecret||0<e.otphkeys||1==e.otpekey&&8388608&features||1==e.otpduo||null!=e.phone&&67108864&features)&&(t+=' <i class="fa-solid fa-key" title="啟用第二因素身份驗證" style="margin-top:2px"></i>'),null!=e.phone&&(t+=' <i class="fa-solid fa-mobile-screen" title="驗證電話號碼" style="margin-top:2px"></i>'),null!=e.siteadmin&&0!=(32&e.siteadmin)&&4294967295!=e.siteadmin&&(t+=' <img src="images/padlock12.png" height=12 width=8 title="帳戶已被鎖定" style="margin-top:2px" />'),null!=e.msghandle&&33554432&features2&&(t+=' <i class="fa-solid fa-comment fa-xs" title="Verified messaging account" style="margin-top:2px" />'),n+("<tr tabindex=0 onkeypress=\"if (event.key=='Enter') gotoUser('"+encodeURIComponentEx(e._id)+"')\"><td>")+"<div>"+('<div class=baricon><input class="UserCheckbox form-check-input me-2" value='+encodeURIComponentEx(e._id)+" onclick=p3updateInfo() type=checkbox"+(e._id==userinfo._id?" disabled":"")+'></div><div style=cursor:pointer onclick=gotoUser("'+encodeURIComponentEx(e._id)+'",false,event)>')+('<div class=baricon><i class="fa-fw fa-solid fa-user '+o+'"></i></div>')+"<div>"+("<div><span style=line-height:24px>"+t+"</span>"+i+"</div></div><td style=text-align:center>"+r+"<td style=text-align:center>"+a+"<td style=text-align:center>"+l)}function p3updateInfo(){for(var e=document.getElementsByClassName("UserCheckbox"),t=0,n=0;n<e.length;n++)!0===e[n].checked&&t++;QE("UsersGroupActionButton",0<t),Q("UsersSelectAllButton").value=0<t?"選擇無":"全選"}function p3usersSelectallButtonFunction(){for(var e=encodeURIComponentEx(userinfo._id),t=document.getElementsByClassName("UserCheckbox"),n=0,o=0;o<t.length;o++)!0===t[o].checked&&n++;for(o=0;o<t.length;o++)t[o].checked=0==n&&t[o].value!=e;p3updateInfo()}function p3usersGroupActionFunction(){for(var e,t,n=document.getElementsByClassName("UserCheckbox"),o=0,i=0;i<n.length;i++)!0===n[i].checked&&o++;0!=o&&(e="",serverinfo.emailcheck&&(e+="<option value=4>驗證電郵</option><option value=5>使電郵無效</option>"),t="選擇要對所有選定用戶執行的操作。<br /><br />",setModalContent("xxAddAgent","集體指令",t+=addHtmlFormFloating("操作","<select id=d3groupop class=form-select><option value=1>鎖定賬戶</option><option value=2>解鎖帳戶</option>"+e+"<option value=3>刪除帳戶</option></select>")),showModal("xxAddAgentModal","idx_dlgOkButton",p3usersGroupActionFunctionEx))}function p3usersGroupActionFunctionEx(){for(var e=document.getElementsByClassName("UserCheckbox"),t=[],n=0;n<e.length;n++)!0===e[n].checked&&t.push(decodeURIComponent(e[n].value));var o,i,s=Q("d3groupop").value;if(1==s)for(var n in t)0==(32&(o=null==(i=users[t[n]]).siteadmin?0:i.siteadmin))&&(o+=32,meshserver.send({action:"edituser",id:i._id,siteadmin:o}));else if(2==s)for(var n in t)0!=(32&(o=null==(i=users[t[n]]).siteadmin?0:i.siteadmin))&&(o-=32,meshserver.send({action:"edituser",id:i._id,siteadmin:o}));else if(3==s)QE("idx_dlgOkButton",!1);else if(4==s)for(var n in t)!0!==(i=users[t[n]]).emailVerified&&meshserver.send({action:"edituser",id:i._id,emailVerified:!0});else if(5==s)for(var n in t)!0===(i=users[t[n]]).emailVerified&&meshserver.send({action:"edituser",id:i._id,emailVerified:!1})}function p3usersGroupActionFunctionDelCheck(){QE("idx_dlgOkButton",Q("d3check").checked)}function p3groupActionFunctionDelExec(e){for(var t=document.getElementsByClassName("UserCheckbox"),n=[],o=0;o<t.length;o++)!0===t[o].checked&&n.push(decodeURIComponent(t[o].value));for(o in n){var i=users[n[o]];meshserver.send({action:"deleteuser",userid:i._id,username:i.name})}}function userMouseHover(e,t){var n=e.children[0].children[0].children[1];n.children[1].classList.remove("g1s"),n.children[2].classList.remove("g2s"),e.children[0].children[0].classList.remove("sbar"),1==t&&(n.children[1].classList.add("g1s"),n.children[2].classList.add("g2s"),e.children[0].children[0].classList.add("sbar"))}function userMouseHover2(e,t){var n=e.children[0].children[0];n.children[2].classList.remove("g1s"),n.children[3].classList.remove("g2s"),e.children[0].children[0].classList.remove("sbar"),1==t&&(n.children[2].classList.add("g1s"),n.children[3].classList.add("g2s"),e.children[0].children[0].classList.add("sbar"))}function userChat(e,t,n){if(!xxdialogMode)return haltEvent(e),e="/messenger?id=meshmessenger/"+t+"/"+encodeURIComponentEx(userinfo._id)+"&title="+n,null!=authCookie&&""!=authCookie&&(e+="&auth="+authCookie),urlargs.key&&(e+="&key="+urlargs.key),safeNewWindow(e,"meshmessenger:"+t),meshserver.send({action:"meshmessenger",userid:decodeURIComponent(t)}),!1}function altUserChat(e,t,n,o){var i,s,a,l,r;if(!xxdialogMode)return haltEvent(e),e=serverinfo.altmessenging[o].url,a=i=encodeURIComponentEx((r=decodeURIComponent(t)).split("/")[2]),l=s=encodeURIComponentEx(r.split("/").join("-")),null!=(r=users[r])&&null!=r.realname&&(a=encodeURIComponentEx(r.realname.split(" ").join("")),l=encodeURIComponentEx(r.realname.split(" ").join("-"))),e=e.split("{0}").join(i).split("{1}").join(s).split("{2}").join(a).split("{3}").join(l),urlargs.key&&(e+="&key="+urlargs.key),safeNewWindow(e,"altmessenger:"+t),meshserver.send({action:"notifyuser",userid:decodeURIComponent(t),msg:serverinfo.altmessenging[o].name,msgid:11,url:e}),!1}function showSendSMS(e){xxdialogMode||(setModalContent("xxAddAgent","發送簡訊","<textarea id=d2smsText maxlength=160 style=width:100%;height:100px;resize:none onKeyUp=showSendSMSValidate()></textarea><span style=font-size:10px><span>"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>showSendSMSEx(3,e)),Q("d2smsText").focus(),showSendSMSValidate())}function showSendSMSValidate(){QE("idx_dlgOkButton",0<Q("d2smsText").value.length)}function showSendSMSEx(e,t){0<Q("d2smsText").value.length&&meshserver.send({action:"smsuser",userid:decodeURIComponent(t),msg:Q("d2smsText").value})}function showSendMessage(e){xxdialogMode||(setModalContent("xxAddAgent","Send Message","<textarea id=d2smsText maxlength=160 style=width:100%;height:100px;resize:none onKeyUp=showSendSMSValidate()></textarea><span style=font-size:10px><span>"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>showSendMessageEx(3,e)),Q("d2smsText").focus(),showSendSMSValidate())}function showSendMessageEx(e,t){0<Q("d2smsText").value.length&&meshserver.send({action:"msguser",userid:decodeURIComponent(t),msg:Q("d2smsText").value})}function showSendEmail(e){xxdialogMode||(setModalContent("xxAddAgent","發電郵",'<input id=d2emailSubject style=width:100% placeholder="主題"></input><textarea id=d2emailText maxlength=10000 style="width:100%;height:200px;resize:none;overflow-y:auto" onKeyUp=showSendEmailValidate()></textarea>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>showSendEmailEx(3,e)),Q("d2emailSubject").focus(),showSendEmailValidate())}function showSendEmailValidate(){QE("idx_dlgOkButton",0<Q("d2emailSubject").value.length&&0<Q("d2emailText").value.length)}function showSendEmailEx(e,t){0<Q("d2emailText").value.length&&meshserver.send({action:"emailuser",userid:decodeURIComponent(t),subject:Q("d2emailSubject").value,msg:Q("d2emailText").value})}function showUserAlertDialog(e,t){if(!xxdialogMode)return haltEvent(e),setModalContent("xxAddAgent",format("通知{0}",EscapeHtml(users[decodeURIComponent(t)].name)),'<div style=margin-bottom:6px>向該用戶發送文本通知。</div><textarea id=d2notifyText maxlength=2048 style="width:100%;height:184px;resize:none"></textarea><select style=width:100% id=broadcastMessageMaxTime><option value=0>顯示消息，直到被用戶拒絕</option><option value=10>顯示10秒</option><option value=60>顯示1分鐘</option><option value=300>顯示5分鐘</option></select>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>showUserAlertDialogEx(3,t)),Q("d2notifyText").focus(),!1}function showUserAlertDialogEx(e,t){meshserver.send({action:"notifyuser",userid:decodeURIComponent(t),msg:Q("d2notifyText").value,maxtime:parseInt(Q("broadcastMessageMaxTime").value)})}function onUsersViewSettings(){var e;xxdialogMode||(e="",setModalContent("xxAddAgent","用戶視圖",e+='<label><input id=d2c1 type=checkbox class="form-check-input me-2"'+((userViewSettings=null==userViewSettings?{}:userViewSettings).noViewLimit?"":" checked")+">僅顯示前 100 個用戶</label><br />"),showModal("xxAddAgentModal","idx_dlgOkButton",onUsersViewSettingsEx))}function onUsersViewSettingsEx(){userViewSettings.noViewLimit=!Q("d2c1").checked,putstore("_usersViewSettings",JSON.stringify(userViewSettings)),mainUpdate(16384)}function p4batchAccountCreate(){xxdialogMode||(setModalContent("xxAddAgent","用戶帳戶導入",'Create many accounts at once by importing a JSON or CSV file<br /><br />JSON file format is as follows:<br /><pre>[\r\n {"user":"x1","pass":"x","email":"x1@x"},\r\n {"user":"x2","pass":"x","resetNextLogin":true}\r\n]</pre><br />CSV file format is as follows:<br /><pre>user,pass,email,resetNextLogin\r\nx1,x,x1@x,\r\nx2,x,,true\r\n</pre><br /><input type=file id=d4importFile class="form-control" accept=".json,.csv" onchange=p4batchAccountCreateValidate() />'),showModal("xxAddAgentModal","idx_dlgOkButton",p4batchAccountCreateEx))}function p4batchAccountCreateValidate(){QE("idx_dlgOkButton",null!=Q("d4importFile").value)}function p4batchAccountCreateEx(){var e=new FileReader;e.onload=function(e){var t=null;if(Q("d4importFile").value.endsWith(".csv")){var n=e.target.result.split("\n"),o=n[0].trim().split(","),i=[];for(let e=1;e<n.length;e++){var s=n[e].trim();if(""!==s){var a=s.split(",");let t=!1;for(let e=0;e<a.length;e++)if(""!==a[e].trim()){t=!0;break}if(t){var l={};for(let e=0;e<o.length;e++){var r=a[e].trim();""!==o[e].trim()&&""!==r&&(l[o[e]]="true"===r.toLowerCase()||r)}i.push(l)}}}if(null!=(t=i)&&Array.isArray(t)){var d=!0;for(c in t)("string"!=typeof t[c].user||t[c].user.length<1||64<t[c].user.length)&&(d=!1),("string"!=typeof t[c].pass||t[c].pass.length<1||256<t[c].pass.length)&&(d=!1),0==checkPasswordRequirements(t[c].pass,passRequirements)&&(d=!1),null!=t[c].email&&("string"!=typeof t[c].email||t[c].email.length<1||128<t[c].email.length)&&(d=!1);0==d?setModalContent("xxAddAgent","用戶帳戶導入","Invalid CSV file format."):meshserver.send({action:"adduserbatch",users:t})}else setModalContent("xxAddAgent","用戶帳戶導入","Invalid CSV file format.")}else{try{t=JSON.parse(e.target.result)}catch(e){return setModalContent("xxAddAgent","用戶帳戶導入",format("無效的JSON檔案：{0}。",e)),void showModal("xxAddAgentModal","idx_dlgOkButton")}if(null!=t&&Array.isArray(t)){var c,d=!0;for(c in t)("string"!=typeof t[c].user||t[c].user.length<1||64<t[c].user.length)&&(d=!1),("string"!=typeof t[c].pass||t[c].pass.length<1||256<t[c].pass.length)&&(d=!1),0==checkPasswordRequirements(t[c].pass,passRequirements)&&(d=!1),null!=t[c].email&&("string"!=typeof t[c].email||t[c].email.length<1||128<t[c].email.length)&&(d=!1);0==d?setModalContent("xxAddAgent","用戶帳戶導入","無效的JSON檔案格式。"):meshserver.send({action:"adduserbatch",users:t})}else setModalContent("xxAddAgent","用戶帳戶導入","無效的JSON檔案格式。");showModal("xxAddAgentModal","idx_dlgOkButton")}},e.readAsText(Q("d4importFile").files[0])}function p4downloadUserInfo(){var e;xxdialogMode||(e="使用以下一種檔案格式下載用戶列表。<br /><br />",setModalContent("xxAddAgent","用戶列表輸出",e=(e+=addHtmlValue("CSV格式","<a href=# style=cursor:pointer onclick='return p4downloadUserInfoCSV()'>userlist.csv</a>"))+addHtmlValue("JSON格式","<a href=# style=cursor:pointer onclick='return p4downloadUserInfoJSON()'>userlist.json</a>")),showModal("xxAddAgentModal","idx_dlgOkButton"))}function p4downloadUserInfoCSV(){var e,t="ID、姓名、電子郵件、創建、lastlogin、組、authfactors、siteadmin、useradmin、鎖定\r\n";for(e in users){var n=!1,o=[];(0<users[e].otpsecret||0<users[e].otphkeys)&&(n=!0,0<users[e].otpsecret&&o.push("AuthApp"),0<users[e].otphkeys&&o.push("SecurityKey"),0<users[e].otpkeys)&&o.push("BackupCodes"),t=(t=(t=(t+='"'+users[e]._id+'","'+users[e].name+'","'+(users[e].email||"")+'","'+(users[e].creation?new Date(1e3*users[e].creation):"")+'","'+(users[e].login?new Date(1e3*users[e].login):"")+'","'+(users[e].groups?users[e].groups.join(","):"")+'","'+(n?o.join(","):"")+'"')+(","+(4294967295==users[e].siteadmin?"1":"0")))+(","+(0!=(2&users[e].siteadmin)?"1":"0")))+(","+(0!=(32&users[e].siteadmin)?"1":"0"))+"\r\n"}return saveAs(stringToUtf8Blob(t),"userlist.csv"),!1}function p4downloadUserInfoJSON(){var e,t=[];for(e in users)t.push(users[e]);return saveAs(new Blob([JSON.stringify(t,null,2)],{type:"application/octet-stream"}),"userlist.json"),!1}function showUserBroadcastDialog(e){xxdialogMode||(setModalContent("xxAddAgent","廣播消息",'<div style=margin-bottom:6px>向所有連接的用戶廣播消息。</div><textarea id=broadcastMessage class="form-control mb-2" style="width:100%;height:184px;resize:none" value="" maxlength=2048 /></textarea><select style=width:100% class="form-select" id=broadcastMessageMaxTime><option value=0>顯示消息，直到被用戶拒絕</option><option value=10>顯示10秒</option><option value=60>顯示1分鐘</option><option value=300>顯示5分鐘</option></select>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){showUserBroadcastDialogEx(3,e?decodeURIComponent(e):null)}),Q("broadcastMessage").focus())}function showUserBroadcastDialogEx(e,t){meshserver.send({action:"userbroadcast",msg:Q("broadcastMessage").value,target:t,maxtime:parseInt(Q("broadcastMessageMaxTime").value)})}function showCreateNewAccountDialog(){if(!xxdialogMode){var e="";if(serverinfo.crossDomain){var t='<select class="form-select" id=p4domain>';for(n in serverinfo.crossDomain)t+="<option value="+n+">"+(""==serverinfo.crossDomain[n]?"默認":EscapeHtml(serverinfo.crossDomain[n]))+"</option>";e+=addHtmlFormFloating("域",t+="</select>")}if(0==(2097152&features)&&(e+=addHtmlFormFloating("<span id=p4hname>用戶名</span>",'<input id=p4name class="form-control" maxlength=64 autocomplete=username onchange=showCreateNewAccountDialogValidate() onkeyup=showCreateNewAccountDialogValidate() />')),e=(e=(e=(e=e+addHtmlFormFloating("<span id=p4hemail>電郵",'<input id=p4email type=email class="form-control" maxlength=256 autocomplete="email" inputmode="email" onchange=showCreateNewAccountDialogValidate() onkeyup=showCreateNewAccountDialogValidate() />')+"")+addHtmlFormFloating("<span id=p4hp1>密碼</span>",'<input id=p4pass1 type=password class="form-control" maxlength=256 autocomplete="new-password" onchange=showCreateNewAccountDialogValidate() onkeyup=showCreateNewAccountDialogValidate() />'))+addHtmlFormFloating("<span id=p4hp2>Confirm Password</span>",'<input id=p4pass2 type=password class="form-control" maxlength=256 autocomplete="new-password" onchange=showCreateNewAccountDialogValidate() onkeyup=showCreateNewAccountDialogValidate() />')+'<div><label><input id=p4randomPassword onchange=showCreateNewAccountDialogValidate() type=checkbox class="form-check-input me-2" />隨機密碼。</label></div>')+'<div><label><input id=p4removeEvents onchange=showCreateNewAccountDialogValidate() type=checkbox class="form-check-input me-2" />刪除此用戶標識的所有先前事件。</label></div>'+'<div><label><input id=p4resetNextLogin onchange=showCreateNewAccountDialogValidate() type=checkbox class="form-check-input me-2" />下次登入時強制重置密碼。</label></div>',serverinfo.emailcheck&&(e+='<div><label><input id=p4verifiedEmail onchange=showCreateNewAccountDialogValidate() type=checkbox class="form-check-input me-2" />電郵已驗證。</label></div><div><label><input id=p4invitationEmail type=checkbox class="form-check-input me-2" title=已通過電郵驗證，並且需要重置密碼。 />發送邀請電郵。</label></div>'),passRequirements){var n,o=[],i=0;for(n in passRequirements)"reset"!=n&&"hint"!=n&&(o.push(n+":"+passRequirements[n]),i++);0<i&&(e+="<div style=font-size:x-small;padding:6px>"+format("要求：{0}。",o.join(", "))+"</div>")}setModalContent("xxAddAgent","創建帳號",e),showModal("xxAddAgentModal","idx_dlgOkButton",showCreateNewAccountDialogEx),showCreateNewAccountDialogValidate(),(0==(2097152&features)?Q("p4name"):Q("p4email")).focus()}}function showCreateNewAccountDialogValidate(){var e=validateEmail(Q("p4email").value),t=!0,n=0<Q("p4pass1").value.length&&Q("p4pass1").value==Q("p4pass2").value&&checkPasswordRequirements(Q("p4pass1").value,passRequirements),t=(0==(2097152&features)&&(t=!Q("p4name")||0<Q("p4name").value.length&&-1==Q("p4name").value.indexOf(" "),QS("p4hname").color=t?"black":"#7b241c"),QS("p4hemail").color=e?"black":"#7b241c",serverinfo.emailcheck&&(QE("p4verifiedEmail",e),QE("p4invitationEmail",e&&Q("p4resetNextLogin").checked&&Q("p4verifiedEmail").checked),0==e&&(Q("p4verifiedEmail").checked=!1),0!=Q("p4resetNextLogin").checked&&0!=Q("p4verifiedEmail").checked||(Q("p4invitationEmail").checked=!1)),QE("p4pass1",!Q("p4randomPassword").checked),QE("p4pass2",!Q("p4randomPassword").checked),QS("p4hp1").color=n||Q("p4randomPassword").checked?"black":"#7b241c",QS("p4hp2").color=n||Q("p4randomPassword").checked?"black":"#7b241c",t&e);0==Q("p4randomPassword").checked&&(t&=n),QE("idx_dlgOkButton",t)}function showCreateNewAccountDialogEx(){var e={action:"adduser",username:(0==(2097152&features)?Q("p4name"):Q("p4email")).value,email:Q("p4email").value,pass:Q("p4pass1").value,resetNextLogin:Q("p4resetNextLogin").checked,randomPassword:Q("p4randomPassword").checked,removeEvents:Q("p4removeEvents").checked};serverinfo.emailcheck&&(e.emailVerified=Q("p4verifiedEmail").checked,e.emailInvitation=Q("p4invitationEmail").checked),serverinfo.crossDomain&&(e.domain=serverinfo.crossDomain[parseInt(Q("p4domain").value)]),meshserver.send(e)}function showUserGroupDialog(e,t){var n,o,i;if(!xxdialogMode)return haltEvent(e),t=decodeURIComponent(t),o="",i="輸入管理領域名稱的逗號分隔列表。<br /><br />",setModalContent("xxAddAgent","管理領域",i+=`<div class="form-floating mb-2"><input id=dp4usergroups value="${o=null!=(n=users[t.toLowerCase()]).groups?n.groups.join(", "):o}" class="form-control" placeholder="Name1, Name2, Name3" maxlength=256 onchange=p4validateUserGroups() onkeyup=p4validateUserGroups() /><label for=dp4usergroups>Realms</label></div>`),showModal("xxAddAgentModal","idx_dlgOkButton",function(){showUserGroupDialogEx(e,n)}),focusTextBox("dp4usergroups"),p4validateUserGroups(),!1}function p4validateUserGroups(){var e,t=Q("dp4usergroups").value,n=0,o=t.indexOf('"')+t.indexOf("/")+t.indexOf(">")+t.indexOf("<")+t.indexOf("'"),i=t.split(",");for(e in i)0==i[e].trim().length&&n++;QE("idx_dlgOkButton",""==t||-5==o&&n<1)}function showUserGroupDialogEx(e,t){var n,o=Q("dp4usergroups").value.split(","),i=[];for(n in o){var s=o[n].trim();0<s.length&&i.push(s)}meshserver.send({action:"edituser",id:t._id,groups:i})}function showUserAdminDialog(e,t){if(!xxdialogMode){haltEvent(e),t=decodeURIComponent(t);var n,o=users[t];if(null!=o)return n=userinfo._id==o._id,(e="")!=(e=(e=(e=(e=(e+='<div class="d-inline-flex align-items-center"><label class="form-label me-2"><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_fileaccess>伺服器檔案</label>, <input type=number class="me-1 form-control" onchange=showUserAdminDialogValidate() maxlength=10 id=ua_fileaccessquota>k max，默認為空白</div><br><hr/>')+'<label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_fulladmin>完整管理員</label><br>'+'<label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_serverbackup>伺服器備份</label><br>')+'<label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_serverrestore>伺服器還原</label><br>'+'<label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_serverupdate>伺服器更新</label><br></div>')+'<div id=d2MngUsr><label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_manageusers>管理用戶</label><br></div>'+'<div id=d2MngGrp><label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_manageusergroups>管理用戶群</label><br></div>')+'<div id=d2MngRec><label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_managerecordings>管理錄音</label><br></div>'+'<div id=d2AllEvnt><label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_allevents>查看所有事件</label><br></div>')&&(e+="<hr/>"),setModalContent("xxAddAgent","伺服器權限",e=(e=(e=(e="<div><div id=d2AdminPermissions>"+e)+'<label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_lockedaccount>鎖定賬戶</label><br>'+'<label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_nonewgroups>沒有新的裝置群</label><br>')+'<label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_nonewdevices>沒有新設備</label><br>'+'<label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_nomeshcmd>沒有工具（MeshCmd /路由器）</label><br>')+'<label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_locksettings>鎖定帳戶設置</label><br>'+"</div>"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){showUserAdminDialogEx(2+(n?0:1),o)}),o.siteadmin&&0!=o.siteadmin&&(Q("ua_fulladmin").checked=4294967295==o.siteadmin,Q("ua_serverbackup").checked=4294967295!=o.siteadmin&&0!=(1&o.siteadmin),Q("ua_serverrestore").checked=4294967295!=o.siteadmin&&0!=(4&o.siteadmin),Q("ua_fileaccess").checked=4294967295!=o.siteadmin&&0!=(8&o.siteadmin),Q("ua_serverupdate").checked=4294967295!=o.siteadmin&&0!=(16&o.siteadmin),Q("ua_lockedaccount").checked=4294967295!=o.siteadmin&&0!=(32&o.siteadmin),Q("ua_nonewgroups").checked=4294967295!=o.siteadmin&&0!=(64&o.siteadmin),Q("ua_nomeshcmd").checked=4294967295!=o.siteadmin&&0!=(128&o.siteadmin),Q("ua_locksettings").checked=4294967295!=o.siteadmin&&0!=(1024&o.siteadmin),Q("ua_nonewdevices").checked=4294967295!=o.siteadmin&&0!=(4096&o.siteadmin)),0!=(2&userinfo.siteadmin)&&(Q("ua_manageusers").checked=4294967295!=o.siteadmin&&0!=(2&o.siteadmin),QE("ua_manageusers",!n&&2&userinfo.siteadmin)),0!=(256&userinfo.siteadmin)&&(Q("ua_manageusergroups").checked=4294967295!=o.siteadmin&&0!=(256&o.siteadmin),QE("ua_manageusergroups",!n&&256&userinfo.siteadmin)),0!=(512&userinfo.siteadmin)&&(Q("ua_managerecordings").checked=4294967295!=o.siteadmin&&0!=(512&o.siteadmin),QE("ua_managerecordings",!n&&512&userinfo.siteadmin)),0!=(2048&userinfo.siteadmin)&&(Q("ua_allevents").checked=4294967295!=o.siteadmin&&0!=(2048&o.siteadmin),QE("ua_allevents",!n&&2048&userinfo.siteadmin)),QE("ua_fulladmin",!n&&4294967295==userinfo.siteadmin),QE("ua_serverbackup",!n&&4294967295==userinfo.siteadmin),QE("ua_serverrestore",!n&&4294967295==userinfo.siteadmin),QE("ua_fileaccess",!n&&4294967295==userinfo.siteadmin),QE("ua_fileaccessquota",!n&&4294967295==userinfo.siteadmin),QE("ua_serverupdate",!n&&4294967295==userinfo.siteadmin),QV("d2AdminPermissions",4294967295==userinfo.siteadmin),QV("d2MngUsr",0!=(2&userinfo.siteadmin)),QV("d2MngGrp",0!=(256&userinfo.siteadmin)),QV("d2MngRec",0!=(512&userinfo.siteadmin)),QE("ua_lockedaccount",!n&&2&userinfo.siteadmin&&4294967295!=o.siteadmin&&userinfo._id!=o._id),QE("ua_nonewgroups",!n&&2&userinfo.siteadmin&&4294967295!=o.siteadmin&&userinfo._id!=o._id),QE("ua_nomeshcmd",!n&&2&userinfo.siteadmin&&4294967295!=o.siteadmin&&userinfo._id!=o._id),QE("ua_nonewdevices",!n&&2&userinfo.siteadmin&&4294967295!=o.siteadmin&&userinfo._id!=o._id),QE("ua_locksettings",!n&&2&userinfo.siteadmin&&4294967295!=o.siteadmin&&userinfo._id!=o._id),Q("ua_fileaccessquota").value=null!=o.quota?o.quota/1024:"",showUserAdminDialogValidate(),!1}}function showUserAdminDialogValidate(){4294967295==userinfo.siteadmin&&(QE("ua_serverbackup",!Q("ua_fulladmin").checked),QE("ua_manageusers",!Q("ua_fulladmin").checked),QE("ua_serverrestore",!Q("ua_fulladmin").checked),QE("ua_fileaccess",!Q("ua_fulladmin").checked),QE("ua_serverupdate",!Q("ua_fulladmin").checked),QE("ua_lockedaccount",!Q("ua_fulladmin").checked),QE("ua_nonewgroups",!Q("ua_fulladmin").checked),QE("ua_nomeshcmd",!Q("ua_fulladmin").checked),QE("ua_nonewdevices",!Q("ua_fulladmin").checked),QE("ua_manageusergroups",!Q("ua_fulladmin").checked),QE("ua_managerecordings",!Q("ua_fulladmin").checked),QE("ua_allevents",!Q("ua_fulladmin").checked),QE("ua_locksettings",!Q("ua_fulladmin").checked),QE("ua_fileaccessquota",Q("ua_fileaccess").checked&&!Q("ua_fulladmin").checked))}function showUserAdminDialogEx(e,t){var n=0,o=parseInt(Q("ua_fileaccessquota").value),t=(1==Q("ua_fulladmin").checked?n=4294967295:(1==Q("ua_serverbackup").checked&&(n+=1),1==Q("ua_manageusers").checked&&(n+=2),1==Q("ua_serverrestore").checked&&(n+=4),1==Q("ua_fileaccess").checked&&(n+=8),1==Q("ua_serverupdate").checked&&(n+=16),1==Q("ua_lockedaccount").checked&&(n+=32),1==Q("ua_nonewgroups").checked&&(n+=64),1==Q("ua_nomeshcmd").checked&&(n+=128),1==Q("ua_manageusergroups").checked&&(n+=256),1==Q("ua_managerecordings").checked&&(n+=512),1==Q("ua_locksettings").checked&&(n+=1024),1==Q("ua_allevents").checked&&(n+=2048),1==Q("ua_nonewdevices").checked&&(n+=4096)),{action:"edituser",id:t._id,siteadmin:n});0==isNaN(o)&&(t.quota=1024*o),meshserver.send(t)}function onUserSearchInputChanged(){mainUpdate(16384)}function updateUserGroups(){QV("p50userGroupOps",0!=(256&userinfo.siteadmin));var e=[],t="";if(usergroups)for(var n in usergroups)e.push(usergroups[n]);e.sort(nameSort);for(var o=[],i=document.getElementsByClassName("UserGroupCheckbox"),n=0;n<i.length;n++)i[n].checked&&o.push(i[n].value);if(0==e.length)t+="<br />找不到群組。<br />",QV("DuplicateUserGroupButton",!1);else{for(var n in t=t+'<table class="table table-hover p3usersTable" cellpadding=0 cellspacing=0>'+"<th>名稱<th style=width:80px>用戶<th style=width:80px>裝置群<th style=width:80px>裝置",e)t+=addUserGroupHtml(e[n]);t+="</table>",QV("DuplicateUserGroupButton",!0)}QH("p50groups",t);for(i=document.getElementsByClassName("UserGroupCheckbox"),n=0;n<i.length;n++)i[n].checked=0<=o.indexOf(i[n].value);p50updateInfo(),null!=currentUserGroup&&51==xxcurrentView&&gotoUserGroup(encodeURIComponentEx(currentUserGroup._id),!0)}function addUserGroupHtml(e){var t=0,n=0,o=0;if(e.links)for(var i in e.links)i.startsWith("user/")&&t++,i.startsWith("mesh/")&&n++,i.startsWith("node/")&&o++;var s=EscapeHtml(e.name),a=(null!=serverinfo.crossDomain&&""!=(a=e._id.split("/")[1])&&(s+=", <span style=color:#26F>"+EscapeHtml(a)+"</span>"),"<tr tabindex=0 onkeypress=\"if (event.key=='Enter') gotoUserGroup('"+encodeURIComponentEx(e._id)+"')\"><td style=cursor:pointer>");return(a+="<div style=width:100%>")+('<div class=baricon><input class="form-check-input me-2 UserGroupCheckbox" value='+encodeURIComponentEx(e._id)+" onclick=p50updateInfo() type=checkbox></div>")+('<div class=baricon onclick=gotoUserGroup("'+encodeURIComponentEx(e._id)+'")><i class="fa-solid fa-users"></i></div>')+('<div onclick=gotoUserGroup("'+encodeURIComponentEx(e._id)+'")></div><div onclick=gotoUserGroup("'+encodeURIComponentEx(e._id)+'")></div>')+('<div style=line-height:24px onclick=gotoUserGroup("'+encodeURIComponentEx(e._id)+'")><span style=font-size:16px>'+s+"</span></div></div><td style=text-align:center>"+t+"<td style=text-align:center>"+n+"<td style=text-align:center>"+o)}function p50updateInfo(){for(var e=document.getElementsByClassName("UserGroupCheckbox"),t=0,n=0;n<e.length;n++)!0===e[n].checked&&t++;QE("UsersGroupsGroupActionButton",0<t),Q("UsersGroupsSelectAllButton").value=0<t?"選擇無":"全選"}function p50usersSelectallButtonFunction(){for(var e=encodeURIComponentEx(userinfo._id),t=document.getElementsByClassName("UserGroupCheckbox"),n=0,o=0;o<t.length;o++)!0===t[o].checked&&n++;for(o=0;o<t.length;o++)t[o].checked=0==n&&t[o].value!=e;p50updateInfo()}function p50usersGroupActionFunction(){for(var e,t=document.getElementsByClassName("UserGroupCheckbox"),n=0,o=0;o<t.length;o++)!0===t[o].checked&&n++;0!=n&&(e="選擇要對所有選定用戶執行的操作。<br /><br />",e+=addHtmlFormFloating("操作","<select id=d50groupop class=form-select><option value=1>刪除群組</option></select>"),xxdialogButtons=3,setModalContent("xxAddAgent","集體指令",e),showModal("xxAddAgentModal","idx_dlgOkButton",p50usersGroupActionFunctionEx))}function p50usersGroupActionFunctionEx(){for(var e=document.getElementsByClassName("UserGroupCheckbox"),t=[],n=0;n<e.length;n++)!0===e[n].checked&&t.push(decodeURIComponent(e[n].value));1==Q("d50groupop").value&&(setModalContent("xxAddAgent","刪除用戶群組",'確認刪除所選用戶群？<br /><br /><label><input id=d3check type=checkbox class="form-check-input me-2" onchange=p50usersGroupActionFunctionDelCheck() />確認</label>'),document.getElementById("idx_dlgOkButton").onclick=function(){p50groupActionFunctionDelExec(3)})}function p50usersGroupActionFunctionDelCheck(){QE("idx_dlgOkButton",Q("d3check").checked)}function p50groupActionFunctionDelExec(e){for(var t=document.getElementsByClassName("UserGroupCheckbox"),n=0;n<t.length;n++)!0===t[n].checked&&meshserver.send({action:"deleteusergroup",ugrpid:decodeURIComponent(t[n].value)})}function showCreateUserGroupDialog(e){if(!xxdialogMode){var t="",n="";if(2==e){if(usergroups)for(var o in usergroups)n+="<option value="+encodeURIComponentEx(o)+">"+EscapeHtml(usergroups[o].name)+"</option>";t+=addHtmlFormFloating("用戶群",'<select id=dp4groupid class="form-select">'+n+"</select>")}if(1==e&&serverinfo.crossDomain){n='<select id=p4domain class="form-select">';for(o in serverinfo.crossDomain)n+="<option value="+o+">"+(""==serverinfo.crossDomain[o]?"默認":EscapeHtml(serverinfo.crossDomain[o]))+"</option>";t+=addHtmlFormFloating("域",n+="</select>")}t=(t+=addHtmlFormFloating("名稱","<input id=p4name class=form-control maxlength=64 onchange=showCreateUserGroupDialogValidate() onkeyup=showCreateUserGroupDialogValidate() />"))+addHtmlFormFloating("描述",'<textarea id=p4desc class=form-control value="" maxlength=1024 /></textarea>'),setModalContent("xxAddAgent",1==e?"創建用戶群":"複製用戶群",t),showModal("xxAddAgentModal","idx_dlgOkButton",function(){showCreateUserGroupDialogEx(3,e)}),showCreateUserGroupDialogValidate(),Q("p4name").focus()}}function showCreateUserGroupDialogValidate(){QE("idx_dlgOkButton",0<Q("p4name").value.length)}function showCreateUserGroupDialogEx(e,t){var n={action:"createusergroup",name:Q("p4name").value,desc:Q("p4desc").value};2==t&&(n.clone=decodeURIComponent(Q("dp4groupid").value)),1==t&&serverinfo.crossDomain&&(n.domain=serverinfo.crossDomain[parseInt(Q("p4domain").value)]),meshserver.send(n)}var currentUserGroup=null;function gotoUserGroup(e,t){if(!xxdialogMode||t){t=currentUserGroup=usergroups?usergroups[decodeURIComponent(e)]:null;if(null==t)51==xxcurrentView&&go(50);else{var e=EscapeHtml(t.name),n=(0==e.length&&(e="<i>沒有</i>"),null==currentUserGroup.membershipType&&0!=(256&userinfo.siteadmin)&&(e='<span role=button tabindex=0 title="單擊此處編輯用戶群名稱" onclick=p51editgroup(1) onkeyup="if (event.key == \'Enter\') p51editgroup(1)">'+e+'  <i class="fa-solid fa-pencil fa-2xs"/></i></span>'),QH("p51groupName",e),0),o=0,i=0;if(t.links)for(var s in t.links)s.startsWith("user/")&&n++,s.startsWith("mesh/")&&o++,s.startsWith("node/")&&i++;var a,l=null==(l=t.desc)||""==l?"<i>沒有<i>":EscapeHtml(l),r="<div style=min-height:80px><table style=width:100%>",l=(0!=(8&args.hide)&&(r+="<br />"+addDeviceAttribute("名稱",e)),null==serverinfo.crossDomain&&0==debugmode||(r=(r+=addDeviceAttribute("域",""!=(e=t._id.split("/")[1])?EscapeHtml(e):"<i>默認</i>"))+addDeviceAttribute("群標識符",EscapeHtml(t._id))),null!=currentUserGroup.membershipType&&(r+=addDeviceAttribute("Group Type",EscapeHtml(currentUserGroup.membershipType))),0!=(256&userinfo.siteadmin)?r+=addDeviceAttribute("描述","<span role=button onclick=p51editgroup(2,"+(null!=currentUserGroup.membershipType)+")>"+l+' <i class="fa-solid fa-pencil fa-xs"/></i></span>'):r+=addDeviceAttribute("描述",l),1==serverinfo.userGroupsSessionRecording&&(e=[],t.flags&&2&t.flags&&e.push("記錄會議"),r+=addDeviceAttribute("功能",addLink(e=""==(e=e.join(", "))?"<i>沒有</i>":e,"p51edituserGroupFeatures()"))),[]),e=0,d=(t.consent&&(e=t.consent),serverinfo.consent&&(e|=serverinfo.consent),64&e&&8&e?l.push("桌面提示+工具欄"):64&e?l.push("桌面工具欄"):8&e?l.push("桌面提示"):1&e&&l.push("桌面通知"),16&e?l.push("終端機提示"):2&e&&l.push("終端機通知"),32&e?l.push("檔案提示"):4&e&&l.push("檔案通知"),7==e&&(l=["一直通知"]),r=(r=(r=(r+=addDeviceAttribute("用戶同意",addLinkConditional(l=""==(l=(l=56==(56&e)?["一直提示"]:l).join(", "))?"<i>沒有</i>":l,"p20editmeshconsent(4)",!0)))+addDeviceAttribute("用戶",n))+addDeviceAttribute("裝置群",o))+addDeviceAttribute("裝置",i)+"</table></div><br />",0!=(256&userinfo.siteadmin)&&(r+='<input type=button class="btn btn-primary btn-sm" value="廣播" title="向該群中的所有用戶發送通知。" onclick=showUserBroadcastDialog("'+encodeURIComponentEx(t._id)+'") />'),QH("p51group",r),r="<br />",null==currentUserGroup.membershipType&&0!=(256&userinfo.siteadmin)&&(r+='<button class="btn btn-primary btn-sm me-2 mb-1" onclick="return p51showAddUserDialog()"><i class="fa-solid fa-circle-plus"></i> 新增用戶</button>'),r+='<table class="table table-hover"><tbody><tr class="table-active"><th scope=col>群組成員</th><th scope=col></th></tr>',1),c=[];for(s in currentUserGroup.links)0!=s.startsWith("user/")&&(a=s.split("/")[2],currentUserGroup.links[s].name&&(a=currentUserGroup.links[s].name),s==userinfo._id&&(a=userinfo.name),c.push({id:s,name:a,rights:currentUserGroup.links[s].rights}));for(s in c.sort(function(e,t){return e.name>t.name?1:e.name<t.name?-1:0}),c){var u="",p=(null==currentUserGroup.membershipType&&(u="<a href=# onclick='return p51deleteUser(event,\""+encodeURIComponentEx(c[s].id)+'")\' title="刪除此裝置群的用戶權限" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>'),EscapeHtml(decodeURIComponent(c[s].name)));r+="<tr "+(d%2==0?"style=background-color:#DDD":"")+'><td><i class="fa-solid fa-user fa-fw" title="用戶"></i>&nbsp;'+(p=null!=users?"<a href=# onclick='gotoUser(\""+encodeURIComponentEx(c[s].id)+"\");haltEvent(event);'>"+p+"</a>":p)+"</td><td><div style=float:right>"+u+"</div></td></tr>",++d}1==d&&(r+="<tr><td><div style=padding:6px>&nbsp;<i>沒有成員</i><div></div></div></td><td></td></tr>"),r+="</tbody></table><br />";var d=1,m=0,g=!1;for(s in meshes)currentUserGroup._id.split("/")[1]==meshes[s]._id.split("/")[1]&&(m++,null==currentUserGroup.links||null==currentUserGroup.links[s])&&(g=!0);if(0<m&&g&&(r+='<button class="btn btn-primary btn-sm me-2 mb-1"onclick="return p20showAddMeshUserDialog(3)"><i class="fa-solid fa-circle-plus"></i> 新增裝置群</button>'),r+='<table class="table table-hover"><tbody><tr class="table-active"><th scope=col>通用裝置群</th><th scope=col></th></tr>',currentUserGroup.links){var h=[];for(s in currentUserGroup.links)s.startsWith("mesh/")&&null!=meshes[s]&&h.push(meshes[s]);for(s in h=getOrderedList(h,"name")){var v=0,f=h[s],u="",x=makeDeviceGroupRightsString(currentUserGroup.links[f._id].rights),k=(userinfo.links&&null!=userinfo.links[f._id]&&null!=userinfo.links[f._id].rights&&(v=userinfo.links[f._id].rights),"<i>未知裝置群</i>");f&&(k="<a href=# onclick='gotoMesh(\""+f._id+"\");haltEvent(event);'>"+f.name+"</a>"),0!=(2&v)&&(u="<a href=# onclick='return p51removeMeshFromUserGroup(event,\""+encodeURIComponentEx(f._id)+'")\' title="刪除此裝置群的用戶群權限" style=cursor:pointer><i class="fa-solid fa-trash text-danger hoverButton"></i></a>',x='<span style=cursor:pointer onclick=p20showAddMeshUserDialog(3,"'+encodeURIComponentEx(f._id)+'")>'+x+" <img class=hoverButton style=cursor:pointer src=images/link5.png></span>"),r+="<tr "+(++d%2==0?"style=background-color:#DDD":"")+'><td style=width:30%><div title="裝置群" class=m99></div><div>&nbsp;'+k+"<div></div></div></td><td style=width:70%><div style=float:right>"+u+"</div><div>"+x+"</div></td></tr>"}}if(1==d&&(r+="<tr><td><div style=padding:6px>&nbsp;<i>沒有共同的裝置群</i><div></div></div></td><td></td></tr>"),d=1,r=r+"</tbody></table>"+"<br />",currentUserGroup._id.split("/")[1]==userinfo._id.split("/")[1]&&(r+='<button class="btn btn-primary btn-sm me-2 mb-1" onclick="return p20showAddMeshUserDialog(7)"><i class="fa-solid fa-circle-plus"></i> 新增裝置</button>'),r+='<table class="table table-hover"><tbody><tr class="table-active"><th scope=col>通用裝置</th><th scope=col></th></tr>',currentUserGroup.links){var y=[];for(s in currentUserGroup.links)s.startsWith("node/")&&null!=(b=getNodeFromId(s))&&y.push(b);for(s in y=getOrderedList(y,"name")){var b=y[s],u="",x=makeUserDeviceRightsString(currentUserGroup.links[b._id].rights),v=GetNodeRights(b),w="<i>未知裝置</i>";b&&(w="<a href=# onclick='gotoDevice(\""+b._id+"\");haltEvent(event);'>"+b.name+"</a>"),0!=(2&v)&&(u="<a href=# onclick='return p51removeDeviceFromUserGroup(event,\""+encodeURIComponentEx(b._id)+'")\' title="刪除此裝置的用戶群權限" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>',x='<span style=cursor:pointer onclick=p20showAddMeshUserDialog(7,"'+encodeURIComponentEx(b._id)+'")>'+x+" <img class=hoverButton style=cursor:pointer src=images/link5.png></span>"),r+="<tr "+(++d%2==0?"style=background-color:#DDD":"")+'><td style=width:30%><div title="裝置群" class=m99></div><div>&nbsp;'+w+"<div></div></div></td><td style=width:70%><div style=float:right>"+u+"</div><div>"+x+"</div></td></tr>"}}1==d&&(r+="<tr><td><div style=padding:6px>&nbsp;<i>沒有共同的裝置</i><div></div></div></td><td></td></tr>"),r+="</tbody></table>",null!=currentUserGroup.membershipType&&0!=n||0==(256&userinfo.siteadmin)||(r+="<div style=font-size:small;text-align:right><span><a href=# onclick=p51showDeleteUserGroupDialog() style=cursor:pointer>刪除用戶群組</a></span></div>"),QH("p51group2",r),go(51);var M="";if(0==(268435456&features)&&51<=xxcurrentView&&xxcurrentView<=59&&null!=currentUserGroup){for(var s in M="?viewmode="+xxcurrentView+"&gotougrp="+(serverinfo.crossDomain?currentUserGroup._id:currentUserGroup._id.split("/")[2]),urlargs)M+="&"+s+"="+urlargs[s];try{window.history.replaceState({},document.title,window.location.pathname+M)}catch(e){}}}}}function p51edituserGroupFeatures(){var e,t;xxdialogMode||(e=currentUserGroup.flags||0,t="",1==serverinfo.userGroupsSessionRecording&&(t+='<div><label><input type=checkbox class="form-check-input me-2" id=d51flag1 '+(2&e?"checked":"")+">記錄會議</label><br></div>"),xxdialogButtons=3,setModalContent("xxAddAgent","編輯用戶組功能",t),showModal("xxAddAgentModal","idx_dlgOkButton",p51edituserGroupFeaturesEx))}function p51edituserGroupFeaturesEx(){var e=0;1==serverinfo.userGroupsSessionRecording&&Q("d51flag1").checked&&(e+=2),meshserver.send({action:"editusergroup",ugrpid:currentUserGroup._id,flags:e})}function p51removeDeviceFromUserGroup(e,t){var n;xxdialogMode||null!=(n=getNodeFromId(decodeURIComponent(t)))&&(setModalContent("xxAddAgent","刪除裝置權限",format("確認刪除裝置“ {0} ”的訪問權限？",n.name)),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p51removeDeviceFromUserGroupEx(3,n._id)))}function p51removeDeviceFromUserGroupEx(e,t){meshserver.send({action:"adddeviceuser",nodeid:t,userids:[currentUserGroup._id],rights:0,remove:!0})}function p51removeMeshFromUserGroup(e,t){var n;xxdialogMode||null!=(n=meshes[decodeURIComponent(t)])&&(setModalContent("xxAddAgent","刪除裝置群權限",format("確認刪除裝置群“ {0} ”的訪問權限？",n.name)),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p51removeMeshFromUserGroupEx(3,n._id)))}function p51editgroup(e,t){xxdialogMode||(t=addHtmlFormFloating("名稱",'<input id=dp51name class="form-control" maxlength=32 onchange=p51editgroupValidate() onkeyup=p51editgroupValidate(event) '+(t?"readonly disabled":"")+"/>"),t+=addHtmlFormFloating("描述",'<textarea id=dp51desc class="form-control" maxlength=1024 style=width:100%;resize:none></textarea>'),xxdialogButtons=3,setModalContent("xxAddAgent","編輯用戶群",t),showModal("xxAddAgentModal","idx_dlgOkButton",p51editgroupEx),Q("dp51name").value=currentUserGroup.name,currentUserGroup.desc&&(Q("dp51desc").value=currentUserGroup.desc),p51editgroupValidate(),(2==e?Q("dp51desc"):Q("dp51name")).focus())}function p51editgroupEx(){meshserver.send({action:"editusergroup",ugrpid:currentUserGroup._id,name:Q("dp51name").value,desc:Q("dp51desc").value})}function p51editgroupValidate(e){QE("idx_dlgOkButton",0<Q("dp51name").value.length),e&&"Enter"==e.key&&Q("dp51desc").focus()}function p51showDeleteUserGroupDialog(){var e;return xxdialogMode||(e=format("刪除用戶群組{0}？",EscapeHtml(currentUserGroup.name))+"<br /><br />",xxdialogButtons=3,setModalContent("xxAddAgent","刪除用戶群組",e+='<label><input id=p51check type=checkbox class="form-check-input me-2" onchange=p51validateDeleteGroupDialog() />確認</label>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p51showDeleteUserGroupDialogEx(xxdialogButtons,xxdialogTag)}),p51validateDeleteGroupDialog()),!1}function p51validateDeleteGroupDialog(){QE("idx_dlgOkButton",Q("p51check").checked)}function p51showDeleteUserGroupDialogEx(e,t){meshserver.send({action:"deleteusergroup",ugrpid:currentUserGroup._id})}function p51deleteUser(e,t){return haltEvent(e),p51viewuserEx(2,decodeURIComponent(t)),!1}function p51viewuserEx(e,t){2==e&&(e=t.split("/")[2],users&&users[t]&&(e=users[t].name),userinfo._id==t&&(e=userinfo.name),setModalContent("xxAddAgent","刪除用戶成員資格",format("確認刪除用戶“ {0} ”的成員身份？",EscapeHtml(decodeURIComponent(e)))),showModal("xxAddAgentModal","idx_dlgOkButton",p51viewuserEx2(3,t)))}function p51viewuserEx2(e,t){meshserver.send({action:"removeuserfromusergroup",ugrpid:currentUserGroup._id,userid:t})}function p51showAddUserDialog(){var e;return xxdialogMode||(e="允許用戶管理此裝置群和該群中的裝置。",524288&features&&(e+=" 用戶需要先登入到該伺服器一次，然後才能將其新增到裝置群。"),setModalContent("xxAddAgent","將用戶新增到用戶群",e=(e=(e+="<br /><br /><div style='position:relative'>")+addHtmlFormFloating("用戶標識符",'<input id=dp51username maxlength=32 class="form-control" onchange=p51validateAddUserDialog() onkeyup=p51validateAddUserDialog() placeholder="user1, user2, user3" />'))+"<div id=dp51usersuggest class=suggestionBox style='top:30px;left:130px;display:none'></div>"+"</div><br>"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p51showAddUserDialogEx(3,xxdialogTag)}),Q("dp51username").focus(),p51validateAddUserDialog()),!1}function p51setname(e){e=decodeURIComponent(e);var t,n=Q("dp51username").value.split(",");for(t in n)n[t]=n[t].trim();return n[n.length-1]=e,Q("dp51username").value=n.join(", "),p51validateAddUserDialog(),!1}function p51validateAddUserDialog(){var e=!0;if(Q("dp51username")){var t=Q("dp51username").value.split(",");for(r in t){var n=t[r]=t[r].trim();(0==n.length||0<=n.indexOf('"'))&&(e=!1)}var o=!1,i=!1;if(null!=users){var s=t[t.length-1].trim(),a=s.toLowerCase(),l=[];if(0<s.length){for(var r in users){var d=users[r]._id.split("/");if(currentUserGroup.domain==d[1]&&d[2]===a){i=!0;break}if(0<=users[r].name.toLowerCase().indexOf(a)&&currentUserGroup.domain==d[1]&&(l.push([users[r]._id,users[r].name]),8<=l.length))break}if(0==i&&0<l.length){var c="";for(r in l){var u=l[r][0],p=l[r][1];u.split("/")[2]==p.toLowerCase()?c+="<div class=suggestionBoxItem onclick='p51setname(\""+encodeURIComponentEx(u.split("/")[2])+"\")'>"+EscapeHtml(p)+"</div>":c+="<div class=suggestionBoxItem onclick='p51setname(\""+encodeURIComponentEx(u.split("/")[2])+"\")'><div>"+EscapeHtml(p)+"</div><div class=suggestionBoxSubItem>"+EscapeHtml(u.split("/")[2])+"</div></div>"}QH("dp51usersuggest",c),o=!0}}}QV("dp51usersuggest",o)}QE("idx_dlgOkButton",e)}function p51showAddUserDialogEx(e,t){if(null==t){var n,o=Q("dp51username").value.split(","),i=[];for(n in o)i.push(o[n].trim());meshserver.send({action:"addusertousergroup",ugrpid:currentUserGroup._id,usernames:i})}else meshserver.send({action:"addusertousergroup",ugrpid:currentUserGroup._id,usernames:[t.split("/")[2]]})}var currentUser=null;function gotoUser(e,t,n){if((!xxdialogMode||t)&&(null==n||null==n.originalTarget||null==n.originalTarget.href)){var o=currentUser=users[decodeURIComponent(e)];if(null==o)go(4);else{QH("p30userName",EscapeHtml(o.name)),QH("p31userName",EscapeHtml(o.name));var t=o._id==userinfo._id,n=0,e=(null!=wssessions&&wssessions[o._id]&&(n=wssessions[o._id]),null!=o.flags&&1&o.flags?(QV("MainUserImage",!1),QV("MainUserImageEx",!0),null==o.accountImageRnd&&(o.accountImageRnd=Math.floor(9999999999*Math.random())),Q("MainUserImageEx").src="userimage.ashx?id="+o._id.split("/")[2]+"&rnd="+o.accountImageRnd):(Q("MainUserImage").classList.remove("gray"),0==n&&Q("MainUserImage").classList.add("gray"),QV("MainUserImage",!0),QV("MainUserImageEx",!1)),o._id.split("/")[2]),e=(e.startsWith("~twitter:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/twitter64.png"):e.startsWith("~google:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/google64.png"):e.startsWith("~github:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/github64.png"):e.startsWith("~azure:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/azure64.png"):e.startsWith("~oidc:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/oidc64.png"):e.startsWith("~jumpcloud:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/jumpcloud64.png"):e.startsWith("~intel:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/intel64.png"):e.startsWith("~:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/generic64.png"):QV("p30userAuthServiceLogo",!1),[]),i="",s=(null!=o.siteadmin&&0!=(32&o.siteadmin)&&4294967295!=o.siteadmin&&(i='<img src="images/padlock12.png" height=12 width=8 title="帳戶已被鎖定" style="margin-top:2px" /> ',e.push("被鎖定賬戶")),null==o.siteadmin||0==(4294966047&o.siteadmin)?e.push("沒有伺服器權限"):8==o.siteadmin?e.push("存取伺服器檔案"):4294967295==o.siteadmin?e.push("完整管理員"):e.push("部分權限"),null!=o.siteadmin&&4294967295!=o.siteadmin&&0!=(1216&o.siteadmin)&&e.push("限制條件"),"<div style=min-height:80px><table style=width:100%>"),a=(0!=(8&args.hide)&&(s+="<br />"+addDeviceAttribute("名稱",o.name)),o.email?EscapeHtml(o.email):"<i>沒有設置</i>"),l="",r=o.realname?EscapeHtml(o.realname):"<i>沒有設置</i>",d=(serverinfo.emailcheck&&(l=1==o.emailVerified?'<b style=color:green;cursor:pointer title="電子郵件已驗證">&#x2713</b> ':'<b style=color:red;cursor:pointer title="電郵未驗證">&#x2717;</b> '),serverinfo.crossDomain||0!=debugmode?s=(s+=addDeviceAttribute("域",""!=(d=o._id.split("/")[1])?EscapeHtml(d):"<i>默認</i>"))+addDeviceAttribute("用戶識別碼",EscapeHtml(o._id)):o.name.toLowerCase()!=o._id.split("/")[2]&&(s+=addDeviceAttribute("用戶識別碼",EscapeHtml(o._id.split("/")[2]))),""),l=(o.email&&(d=' <a href="mailto:'+EscapeHtml(o.email)+'" \'><i class="fa-solid fa-arrow-up-right-from-square fa-xs"></i></a>'),s=4294967295!=o.siteadmin||4294967295==userinfo.siteadmin?(s+=addDeviceAttribute("電郵",'<span role=button onclick=p30showUserEmailChangeDialog(event,"'+encodeURIComponentEx(o._id)+'")>'+l+a+d+' <i class="fa-solid fa-pencil fa-xs"></i></span>'))+addDeviceAttribute("真正的名字",'<span role=button onclick=p30showUserRealNameChangeDialog(event,"'+encodeURIComponentEx(o._id)+'")>'+r+' <i class="fa-solid fa-pencil fa-xs"></i></span>'):(s+=addDeviceAttribute("電郵",l+a+d))+addDeviceAttribute("真正的名字",r),(33554432&features||null!=o.phone)&&(s+=addDeviceAttribute("電話號碼","<span role=button onclick=p30editPhone()>"+(o.phone||"<i>沒有</i>")+' <i class="fa-solid fa-pencil fa-xs"></i></span>')),(33554432&features2||null!=o.msghandle)&&(s+=addDeviceAttribute("Messaging",'<span role=button onclick=p30editMessaging()><i class="fa-solid fa-comment fa-xs" title="Messaging enabled" style="margin-top:2px"></i> '+(o.msghandle||"<i>沒有</i>")+' <i class="fa-solid fa-pencil fa-xs"></i></span>')),[]),c=(1==serverinfo.usersSessionRecording&&o.flags&&2&o.flags&&l.push("記錄會議"),o.removeRights&&(0!=(8&o.removeRights)?l.push("沒有遙控器"):(0!=(65536&o.removeRights)?l.push("沒有桌面"):0!=(256&o.removeRights)&&l.push("僅桌面視圖"),0!=(512&o.removeRights)&&l.push("沒有終端"),0!=(1024&o.removeRights)&&l.push("沒有檔案")),0!=(16&o.removeRights)&&l.push("沒有控制台"),0!=(32768&o.removeRights)&&l.push("無卸載"),0!=(131072&o.removeRights)&&l.push("沒有遙控器"),0!=(64&o.removeRights)&&l.push("沒有喚醒"),0!=(262144&o.removeRights))&&l.push("無重置/關閉"),s=(s+=addDeviceAttribute("功能",addLink(l=""==(l=l.join(", "))?"<i>沒有</i>":l,"p20edituserfeatures()")))+addDeviceAttribute("伺服器權限","<span role=button onclick='return showUserAdminDialog(event,\""+encodeURIComponentEx(o._id)+"\")'>"+i+e.join(", ")+' <i class="fa-solid fa-pencil fa-xs"></i></span>'),o.quota&&(s+=addDeviceAttribute("伺服器配額",EscapeHtml(parseInt(o.quota)/1024)+" k")),s+=addDeviceAttribute("創建",printDateTime(new Date(1e3*o.creation))),o.login&&(s+=addDeviceAttribute("上次登入",printDateTime(new Date(1e3*o.login)))),-1==o.passchange?s+=addDeviceAttribute("密碼","下次登入時將更改。"):o.passchange&&(s+=addDeviceAttribute("密碼",format("上次更改：{0}",printDateTime(new Date(1e3*o.passchange))))),0),a="<i>沒有<i>";if(o.links){for(var u in o.links)u.startsWith("mesh/")&&c++;1==c?a="1群":1<c&&(a=format("{0}個群組",c))}if(s+=addDeviceAttribute("裝置群",a),4294967295==userinfo.siteadmin||2&userinfo.siteadmin){var p="<i>沒有</i>";if(o.groups)for(var u in p="",o.groups)p+='<span class="tagSpan">'+EscapeHtml(o.groups[u])+"</span>";s+=addDeviceAttribute("管理領域",addLinkConditional(p,'showUserGroupDialog(event,"'+encodeURIComponentEx(o._id)+'")',4294967295==userinfo.siteadmin||null==userinfo.groups&&userinfo._id!=o._id&&4294967295!=o.siteadmin))}d=[],r=0,l=(o.consent&&(r=o.consent),serverinfo.consent&&(r|=serverinfo.consent),64&r&&8&r?d.push("桌面提示+工具欄"):64&r?d.push("桌面工具欄"):8&r?d.push("桌面提示"):1&r&&d.push("桌面通知"),16&r?d.push("終端機提示"):2&r&&d.push("終端機通知"),32&r?d.push("檔案提示"):4&r&&d.push("檔案通知"),7==r&&(d=["一直通知"]),s+=addDeviceAttribute("用戶同意",addLinkConditional(d=""==(d=(d=56==(56&r)?["一直提示"]:d).join(", "))?"<i>沒有</i>":d,"p20editmeshconsent(2)",!0)),0);if((0<o.otpsecret||0<o.otphkeys||0<o.otpekey||0<o.otpduo)&&(l=1,i=[],0<o.otpsecret&&i.push("認證軟體"),0<o.otphkeys&&i.push("安全密鑰"),0<o.otpekey&&i.push("電郵"),0<o.otpduo&&i.push("Duo"),0<o.otpkeys&&i.push("備用碼"),0<o.otpdev&&i.push("設備推送"),null!=o.phone&&67108864&features&&i.push("短信"),null!=o.msghandle&&67108864&features2&&i.push("Messaging"),s+=addDeviceAttribute("安全",'<i class="fa-solid fa-key" title="啟用第二因素身份驗證" style="margin-top:2px"></i> '+i.join(", "))),s=(s+="</table></div><br />")+('<input type=button class="btn btn-primary btn-sm me-1" value="筆記" title="查看有關此用戶的註釋" onclick=showNotes(false,"'+encodeURIComponentEx(o._id)+'") />'),o.phone&&33554432&features&&(s+='<input type=button class="btn btn-primary btn-sm me-1" value="短信" title="發送短信給該用戶" onclick=showSendSMS("'+encodeURIComponentEx(o._id)+'") />'),o.msghandle&&33554432&features2&&(s+='<input type=button class="btn btn-primary btn-sm me-1" value="訊息" title="Send a message to this user" onclick=showSendMessage("'+encodeURIComponentEx(o._id)+'") />'),"string"==typeof o.email&&!0===o.emailVerified&&64&features&&(s+='<input type=button class="btn btn-primary btn-sm me-1" value="電郵" title="發送電郵給該用戶" onclick=showSendEmail("'+encodeURIComponentEx(o._id)+'") />'),!t&&(0<n||8&features2&&o.webpush)&&(s=(s+='<input type=button class="btn btn-primary btn-sm me-1" value="通知" title="發送用戶通知" onclick=showUserAlertDialog(event,"'+encodeURIComponentEx(o._id)+'") />')+'<input type=button class="btn btn-primary btn-sm me-1" value="聊天" title="聊天" onclick=userChat(event,"'+encodeURIComponentEx(o._id)+'","'+encodeURIComponentEx(o.name)+'") />',0<n)&&null!=serverinfo&&null!=serverinfo.altmessenging)for(var u in serverinfo.altmessenging){var m=serverinfo.altmessenging[u];null!=m.type&&"user"!=m.type||(s+='<input type=button class="btn btn-primary btn-sm me-1" value="'+EscapeHtml(m.name)+'" onclick=altUserChat(event,"'+encodeURIComponentEx(o._id)+'","'+encodeURIComponentEx(o.name)+'",'+u+") />")}QH("p30html",s),drawUserPermissions();var e=null!=userinfo.siteadmin&&2&userinfo.siteadmin&&4294967295!=o.siteadmin||4294967295==userinfo.siteadmin,g=(s="<div style=float:right;font-size:small>",e&&userinfo._id!=o._id&&(s+="<a href=# style=cursor:pointer onclick='return p30showDeleteUserDialog()' title=\"刪除此用戶\">刪除用戶</a>"),s+="</div><div style=font-size:small>",e&&0==(524288&features)&&"~"!=o._id.split("/")[2][0]&&(s=s+"<a href=# style=cursor:pointer onclick='return p30showUserChangePassDialog("+l+')\' title="更改該用戶的密碼">更改密碼</a> <a href=# style=cursor:pointer onclick=\'return p30viewPreviousLogins()\' title="查看此用戶以前的登錄信息">以前的登錄</a>'),s+="</div><br>",QH("p30html3",s),s="",1==n?s="1個活躍時段":1<n&&(s=format("{0}個活躍節",n)),QH("MainUserState",s),go(30),QH("p31events",""),refreshUsersEvents(),"");if(0==(268435456&features)&&30<=xxcurrentView&&xxcurrentView<=39&&null!=currentUser){for(var u in g="?viewmode="+xxcurrentView+"&gotouser="+(serverinfo.crossDomain?currentUser._id:currentUser._id.split("/")[2]),urlargs)g+="&"+u+"="+urlargs[u];try{window.history.replaceState({},document.title,window.location.pathname+g)}catch(e){}}}}}function p30editPhone(){var e;xxdialogMode||(e=(e='<table style=width:100%><tr><td style=width:56px><img src="images/phone80.png" style=padding:8px>')+'<td style=width:100%;text-align:center>此用戶的短信功能電話號碼。<br />如沒有請留空。<br /><br /><div style=width:100%;text-align:center>電話號碼： <input type=tel pattern="[0-9]" autocomplete="tel" value="'+(currentUser.phone||"")+'" inputmode="tel" maxlength=18 id=d2phoneinput onKeyUp=p30editPhoneValidate() onkeypress="if (event.key==\'Enter\') p30editPhoneValidate(1)"></div></table>',xxdialogButtons=3,xxdialogTag="verifyPhone",setModalContent("xxAddAgent","電話通知",e),showModal("xxAddAgentModal","idx_dlgOkButton",p30editPhoneEx),Q("d2phoneinput").focus(),p30editPhoneValidate())}function p30editMessaging(){var e,t;xxdialogMode||(t="<select id=d2serviceselect style=width:160px;margin-left:8px onchange=p30editMessagingValidate()><option value=0>沒有</option>",0!=(1&serverinfo.userMsgProviders)&&(t+="<option value=1>Telegram</option>"),0!=(4&serverinfo.userMsgProviders)&&(t+="<option value=4>Discord</option>"),0!=(8&serverinfo.userMsgProviders)&&(t+="<option value=8>XMPP</option>"),0!=(16&serverinfo.userMsgProviders)&&(t+="<option value=16>CallMeBot</option>"),0!=(32&serverinfo.userMsgProviders)&&(t+="<option value=32>Pushover</option>"),0!=(64&serverinfo.userMsgProviders)&&(t+="<option value=64>ntfy</option>"),0!=(128&serverinfo.userMsgProviders)&&(t+="<option value=128>Zulip</option>"),0!=(256&serverinfo.userMsgProviders)&&(t+="<option value=256>Slack</option>"),e=(e='<table style=width:100%><tr><td style=width:56px;vertical-align:top><img src="images/messaging40.png" style=padding:8px>')+"<td style=width:100%>Messaging account for this user.<table style=margin-top:12px><tr><td>Service<td>"+(t+="</select>")+"<tr><td>Handle<td><input maxlength=1024 style=width:160px;margin-left:8px id=d2handleinput onKeyUp=p30editMessagingValidate() onkeypress=\"if (event.key=='Enter') p30editMessagingValidate(1)\"></table>",serverinfo.discordUrl&&(e+="<div id=d2discordurl style=display:none><br /><a href="+serverinfo.discordUrl+' target="_discord">Join this Discord server to receive notifications.</a></div>'),e=(e+='<div id=d2callmebotinfo style=display:none><br /><a href=https://www.callmebot.com/blog/free-api-signal-send-messages/ target="_callmebot">Signal</a>, <a href=https://www.callmebot.com/blog/free-api-whatsapp-messages/ target="_callmebot">Whatsapp</a>, <a href=https://www.callmebot.com/blog/free-api-facebook-messenger/ target="_callmebot">Facebook</a>, <a href=https://www.callmebot.com/blog/telegram-text-messages/ target="_callmebot">Telegram</a></div>')+'<div id=d2pushoverinfo style=display:none><br /><a href=https://pushover.net/ target="_pushover">Information at Pushover.net</a></div><div id=d2ntfyinfo style=display:none><br /><a href="'+(serverinfo.userMsgNftyUrl||"https://ntfy.sh/")+'" target="_ntfy">Free service at ntfy.sh</a></div>',xxdialogButtons=3,xxdialogTag="verifyMessaging",setModalContent("xxAddAgent","Messaging Notifications",e+='<div id=d2slackinfo style=display:none><br /><a href=https://api.slack.com/messaging/webhooks target="_slack">Slack Webhook Setup</a></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",p30editMessagingEx),Q("d2handleinput").focus(),currentUser.msghandle&&(currentUser.msghandle.startsWith("telegram:")&&0!=(1&serverinfo.userMsgProviders)&&(Q("d2serviceselect").value=1,Q("d2handleinput").value=currentUser.msghandle.substring(10)),currentUser.msghandle.startsWith("discord:")&&0!=(4&serverinfo.userMsgProviders)&&(Q("d2serviceselect").value=4,Q("d2handleinput").value=currentUser.msghandle.substring(8)),currentUser.msghandle.startsWith("xmpp:")&&0!=(8&serverinfo.userMsgProviders)&&(Q("d2serviceselect").value=8,Q("d2handleinput").value=currentUser.msghandle.substring(5)),currentUser.msghandle.startsWith("callmebot:")&&0!=(16&serverinfo.userMsgProviders)&&(Q("d2serviceselect").value=16,"signal"==(t=currentUser.msghandle.substring(10).split("|"))[0]&&3==t.length&&(Q("d2handleinput").value="https://api.callmebot.com/signal/send.php?phone="+decodeURIComponent(t[1])+"&apikey="+decodeURIComponent(t[2])),"whatsapp"==t[0]&&3==t.length&&(Q("d2handleinput").value="https://api.callmebot.com/whatsapp.php?phone="+decodeURIComponent(t[1])+"&apikey="+decodeURIComponent(t[2])),"facebook"==t[0])&&2==t.length&&(Q("d2handleinput").value="https://api.callmebot.com/facebook/send.php?apikey="+decodeURIComponent(t[1])),currentUser.msghandle.startsWith("pushover:")&&0!=(32&serverinfo.userMsgProviders)&&(Q("d2serviceselect").value=32,Q("d2handleinput").value=currentUser.msghandle.substring(9)),currentUser.msghandle.startsWith("ntfy:")&&0!=(64&serverinfo.userMsgProviders)&&(Q("d2serviceselect").value=64,Q("d2handleinput").value=currentUser.msghandle.substring(5)),currentUser.msghandle.startsWith("zulip:")&&0!=(128&serverinfo.userMsgProviders)&&(Q("d2serviceselect").value=128,Q("d2handleinput").value=currentUser.msghandle.substring(6)),currentUser.msghandle.startsWith("slack:"))&&0!=(256&serverinfo.userMsgProviders)&&(Q("d2serviceselect").value=256,Q("d2handleinput").value=currentUser.msghandle.substring(6)),p30editMessagingValidate())}function p30editMessagingValidate(e){QE("d2handleinput",0!=Q("d2serviceselect").value),serverinfo.discordUrl&&QV("d2discordurl",4==Q("d2serviceselect").value),QV("d2callmebotinfo",16==Q("d2serviceselect").value),QV("d2pushoverinfo",32==Q("d2serviceselect").value),QV("d2ntfyinfo",64==Q("d2serviceselect").value),QV("d2slackinfo",256==Q("d2serviceselect").value),0==Q("d2serviceselect").value?Q("d2handleinput").placeholder="":4==Q("d2serviceselect").value?Q("d2handleinput").placeholder="Username:0000":8==Q("d2serviceselect").value?Q("d2handleinput").placeholder="username@server.com":16==Q("d2serviceselect").value?Q("d2handleinput").placeholder="https://api.callmebot.com/...":32==Q("d2serviceselect").value?Q("d2handleinput").placeholder="User key":64==Q("d2serviceselect").value?Q("d2handleinput").placeholder="主題":128==Q("d2serviceselect").value?Q("d2handleinput").placeholder="username@sample.com":256==Q("d2serviceselect").value?Q("d2handleinput").placeholder="https://hooks.slack.com/...":Q("d2handleinput").placeholder="用戶名",1==e&&dialogclose(1)}function p30editMessagingEx(){var e=null;""==Q("d2handleinput").value||0==Q("d2serviceselect").value?e="":1==Q("d2serviceselect").value?e="telegram:@"+Q("d2handleinput").value:4==Q("d2serviceselect").value?e="discord:"+Q("d2handleinput").value:8==Q("d2serviceselect").value?e="xmpp:"+Q("d2handleinput").value:16==Q("d2serviceselect").value?e="callmebot:"+Q("d2handleinput").value:32==Q("d2serviceselect").value?e="pushover:"+Q("d2handleinput").value:64==Q("d2serviceselect").value?e="ntfy:"+Q("d2handleinput").value:128==Q("d2serviceselect").value?e="zulip:"+Q("d2handleinput").value:256==Q("d2serviceselect").value&&(e="slack:"+Q("d2handleinput").value),null!=e&&meshserver.send({action:"edituser",id:currentUser._id,msghandle:e})}function p20edituserfeatures(){var e,t,n;xxdialogMode||(e=currentUser.flags||0,t=currentUser.removeRights||0,n=n="",1==serverinfo.usersSessionRecording&&(n+='<div><label><input type=checkbox id=d20flag1 class="form-check-input me-2" onchange=p20edituserfeaturesValidate() '+(2&e?"checked":"")+">記錄會議</label><br></div>"),setModalContent("xxAddAgent","編輯用戶特徵",n=(n=(n=(n=(n=n+('<div><label><input type=checkbox id=d20flag7 class="form-check-input me-2" onchange=p20edituserfeaturesValidate() '+(8&t?"checked":"")+">沒有遙控器</label><br></div>")+('<div style=margin-left:8px><label><input type=checkbox id=d20flag2 class="form-check-input me-2" onchange=p20edituserfeaturesValidate() '+(65536&t?"checked":"")+">不能訪問桌面</label><br></div>"))+('<div style=margin-left:16px><label><input type=checkbox id=d20flag3 class="form-check-input me-2" onchange=p20edituserfeaturesValidate() '+(256&t?"checked":"")+">僅遠程查看</label><br></div>")+('<div style=margin-left:8px><label><input type=checkbox id=d20flag4 class="form-check-input me-2" onchange=p20edituserfeaturesValidate() '+(512&t?"checked":"")+">不能訪問終端</label><br></div>"))+('<div style=margin-left:8px><label><input type=checkbox id=d20flag5 class="form-check-input me-2" onchange=p20edituserfeaturesValidate() '+(1024&t?"checked":"")+">不能存取檔案</label><br></div>")+('<div><label><input type=checkbox id=d20flag6 class="form-check-input me-2" onchange=p20edituserfeaturesValidate() '+(16&t?"checked":"")+">無代理控制台</label><br></div>"))+('<div><label><input type=checkbox id=d20flag8 class="form-check-input me-2" onchange=p20edituserfeaturesValidate() '+(32768&t?"checked":"")+">無卸載</label><br></div>")+('<div><label><input type=checkbox id=d20flag9 class="form-check-input me-2" onchange=p20edituserfeaturesValidate() '+(131072&t?"checked":"")+">沒有遙控器</label><br></div>"))+('<div><label><input type=checkbox id=d20flag10 class="form-check-input me-2" onchange=p20edituserfeaturesValidate() '+(64&t?"checked":"")+">沒有喚醒</label><br></div>")+('<div><label><input type=checkbox id=d20flag11 class="form-check-input me-2" onchange=p20edituserfeaturesValidate() '+(262144&t?"checked":"")+">無重置/關閉</label><br></div>")),showModal("xxAddAgentModal","idx_dlgOkButton",p20edituserfeaturesEx),p20edituserfeaturesValidate())}function p20edituserfeaturesValidate(){QE("d20flag2",!Q("d20flag7").checked),QE("d20flag3",!Q("d20flag7").checked&&!Q("d20flag2").checked),QE("d20flag4",!Q("d20flag7").checked),QE("d20flag5",!Q("d20flag7").checked)}function p20edituserfeaturesEx(){var e=1&(currentUser.flags||0),t=(1==serverinfo.usersSessionRecording&&Q("d20flag1").checked&&(e+=2),0);Q("d20flag7").checked?t+=8:(Q("d20flag2").checked?t+=65536:Q("d20flag3").checked&&(t+=256),Q("d20flag4").checked&&(t+=512),Q("d20flag5").checked&&(t+=1024)),Q("d20flag6").checked&&(t+=16),Q("d20flag8").checked&&(t+=32768),Q("d20flag9").checked&&(t+=131072),Q("d20flag10").checked&&(t+=64),Q("d20flag11").checked&&(t+=262144),meshserver.send({action:"edituser",id:currentUser._id,flags:e,removeRights:t})}function p30editPhoneValidate(e){var t=""==Q("d2phoneinput").value||isPhoneNumber(Q("d2phoneinput").value);QE("idx_dlgOkButton",t),1==e&&t&&dialogclose(1)}function p30editPhoneEx(){meshserver.send({action:"edituser",id:currentUser._id,phone:Q("d2phoneinput").value})}function p30showUserRealNameChangeDialog(e){return xxdialogMode||(xxdialogButtons=3,setModalContent("xxAddAgent",format("更改{0}的真實名稱",EscapeHtml(currentUser.name)),'<div class="form-floating mb-2"><input id=dp30realname class="form-control" placeholder="Real Name" maxlength=256 /><label for=dp30realname>Real Name</label></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",p30showUserRealNameChangeDialogEx),Q("dp30realname").focus(),Q("dp30realname").value=currentUser.realname||""),!1}function p30showUserRealNameChangeDialogEx(){meshserver.send({action:"edituser",id:currentUser._id,realname:Q("dp30realname").value})}function p30showUserEmailChangeDialog(e){var t;return xxdialogMode||(t="",t+='<div class="form-floating mb-2"><input id=dp30email class="form-control" maxlength=32 onchange=p30validateEmail() onkeyup=p30validateEmail() placeholder=Email /><label for=dp30email>Email</label></div>',serverinfo.emailcheck&&(t+=addHtmlFormFloating("狀態",'<select id=dp30verified class="form-control" onchange=p30validateEmail()><option value=0>未經審核的</option><option value=1>已驗證</option></select>')),setModalContent("xxAddAgent",format("更改{0}的電郵",EscapeHtml(currentUser.name)),t),xxdialogButtons=3,showModal("xxAddAgentModal","idx_dlgOkButton",p30showUserEmailChangeDialogEx),Q("dp30email").focus(),Q("dp30email").value=currentUser.email||"",serverinfo.emailcheck&&(Q("dp30verified").value=currentUser.emailVerified?1:0),p30validateEmail()),!1}function p30validateEmail(){var e=Q("dp30email").value,t=e.split("@"),t=0==e.length||2==t.length&&0<t[0].length&&1<t[1].split(".").length&&2<t[1].length&&e.length<1024&&(e!=userinfo.email||1==serverinfo.emailcheck&&Q("dp30verified").value!=(userinfo.emailVerified?1:0));QE("idx_dlgOkButton",t)}function p30showUserEmailChangeDialogEx(){var e={action:"edituser",id:currentUser._id,email:Q("dp30email").value};serverinfo.emailcheck&&(e.emailVerified=1==Q("dp30verified").value),meshserver.send(e)}function p30viewPreviousLogins(){xxdialogMode||(setModalContent("xxAddAgent","以前的登錄","Loading..."),meshserver.send({action:"previousLogins",userid:currentUser._id}))}function p30showUserChangePassDialog(e){if(!xxdialogMode){var t=(t="")+'<div class="form-floating mb-2"><input id=p4pass1 type=password class="form-control" maxlength=256 onchange=p30showUserChangePassDialogValidate(1) onkeyup=p30showUserChangePassDialogValidate(1) placeholder=Password></input><label for=p4pass1>Password</label></div>'+'<div class="form-floating mb-2"><input id=p4pass2 type=password class="form-control" maxlength=256 onchange=p30showUserChangePassDialogValidate(1) onkeyup=p30showUserChangePassDialogValidate(1) placeholder=Password></input><label for=p4pass2>Confirm Password</label></div>';if(65536&features&&(t+='<div class="form-floating mb-2"><input id=p4hint type=text class="form-control" maxlength=256 placeholder="Password hint"></input><label for=p4hint>Password hint</label></div>'),passRequirements){var n,o=[],i=0;for(n in passRequirements)"reset"!=n&&"hint"!=n&&(o.push(n+":"+passRequirements[n]),i++);0<i&&(t+="<div style=font-size:x-small;padding:6px>"+format("要求：{0}。",o.join(", "))+"</div>")}t+='<div><label><input id=p4resetNextLogin class="form-check-input me-2" type=checkbox />下次登入時強制重置密碼。</label></div>',1==e&&(t+='<div><label><input id=p4twoFactorRemove class="form-check-input me-2" type=checkbox />刪除所有二因子鑑別。</label></div>'),setModalContent("xxAddAgent",format("更改{0}的密碼",EscapeHtml(currentUser.name)),t),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p30showUserChangePassDialogEx(3,e)}),p30showUserChangePassDialogValidate(),Q("p4pass1").focus(),-1==currentUser.passchange&&(Q("p4resetNextLogin").checked=!0)}}function p30showUserChangePassDialogValidate(){var e=!0;""==Q("p4pass1").value&&""==Q("p4pass2").value||(Q("p4pass1").value!=Q("p4pass2").value||passRequirements&&0==checkPasswordRequirements(Q("p4pass1").value,passRequirements))&&(e=!1),QE("idx_dlgOkButton",e)}function p30showUserChangePassDialogEx(e,t){var n=!1;1==t&&1==Q("p4twoFactorRemove").checked&&(n=!0),Q("p4pass1").value==Q("p4pass2").value&&(t={action:"changeuserpass",userid:currentUser._id,pass:Q("p4pass1").value,removeMultiFactor:n,resetNextLogin:Q("p4resetNextLogin").checked},65536&features&&(t.hint=Q("p4hint").value),meshserver.send(t))}function p30showDeleteUserDialog(){xxdialogMode||(setModalContent("xxAddAgent",format("刪除用戶{0}",EscapeHtml(currentUser.name)),format("確認刪除用戶{0}？",EscapeHtml(currentUser.name))+'<br /><br /><label><input id=p10check type=checkbox class="form-check-input me-2" onchange=p10validateDeleteNodeDialog() />確認</label>'),showModal("xxAddAgentModal","idx_dlgOkButton",p30showDeleteUserDialogEx),p10validateDeleteNodeDialog())}function p30showDeleteUserDialogEx(){meshserver.send({action:"deleteuser",userid:currentUser._id,username:currentUser.name})}function drawUserPermissions(){var e=1,t="",n=0,o=!1;for(v in meshes)meshes[v]._id.split("/")[1]==currentUser._id.split("/")[1]&&(n++,null==currentUser.links||null==currentUser.links[v])&&(o=!0);if(0<n&&o&&(t+='<button class="btn btn-primary btn-sm me-2 mb-1" onclick="return p20showAddMeshUserDialog(1)"><i class="fa-solid fa-circle-plus"></i> 新增裝置群</button>'),t+='<table class="table table-hover"><tbody><tr class="table-active"><th scope=col>通用裝置群</th><th scope=col></th></tr>',currentUser.links){var i=[];for(v in currentUser.links)v.startsWith("mesh/")&&null!=meshes[v]&&i.push(meshes[v]);for(v in i=getOrderedList(i,"name")){var s,a=0,l=i[v],r="",d=makeDeviceGroupRightsString(g=currentUser.links[l._id].rights);null!=l&&(userinfo.links&&null!=userinfo.links[l._id]&&null!=userinfo.links[l._id].rights&&(a=userinfo.links[l._id].rights),s="<i>未知裝置群</i>",l&&(s="<a href=# onclick='gotoMesh(\""+l._id+"\");haltEvent(event);'>"+EscapeHtml(l.name)+"</a>"),currentUser._id!=userinfo._id&&0!=(2&a)&&(r="<a href=# onclick='return p30removeMeshFromUser(event,\""+encodeURIComponentEx(l._id)+'")\' title="刪除此裝置群的用戶權限" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>',d='<span style=cursor:pointer onclick=p20showAddMeshUserDialog(1,"'+encodeURIComponentEx(l._id)+'")>'+d+" <img class=hoverButton style=cursor:pointer src=images/link5.png></span>"),t+="<tr "+(++e%2==0?"style=background-color:#DDD":"")+'><td style=width:30%><div title="裝置群" class=m99></div><div>&nbsp;'+s+"<div></div></div></td><td style=width:70%><div style=float:right>"+r+"</div><div>"+d+"</div></td></tr>")}}if(1==e&&(t+="<tr><td><div style=padding:6px>&nbsp;<i>沒有共同的裝置群</i><div></div></div></td><td></td></tr>"),t+="</tbody></table>",null!=usergroups){if(e=1,t+="<br />",0!=(256&userinfo.siteadmin)){var c=0,u=!1;for(v in usergroups)null==usergroups[v].membershipType&&usergroups[v]._id.split("/")[1]==currentUser._id.split("/")[1]&&(c++,null==currentUser.links||null==currentUser.links[v])&&(u=!0);0<c&&u&&(t+='<button class="btn btn-primary btn-sm me-2 mb-1" onclick="return p30showAddUserGroupDialog()"><i class="fa-solid fa-circle-plus"></i> 新增用戶群</button>')}if(t+='<table class="table table-hover"><tbody><tr class="table-active"><th scope=col>用戶群成員</th><th scope=col></th></tr>',currentUser.links){var p=[];for(v in currentUser.links)v.startsWith("ugrp/")&&null!=usergroups[v]&&p.push(usergroups[v]);for(v in p=getOrderedList(p,"name")){var m=p[v],g=currentUser.links[p[v]._id].rights,r="",h="<i>未知用戶群</i>";t+="<tr "+(++e%2==0?"style=background-color:#DDD":"")+'><td><div title="用戶群" class=m4></div><div>&nbsp;'+(h=null!=m&&(h=EscapeHtml(m.name),null!=usergroups)?"<a href=# onclick='gotoUserGroup(\""+encodeURIComponentEx(p[v]._id)+"\");haltEvent(event);'>"+h+"</a>":h)+"<div></div></div></td><td><div style=float:right>"+(r=null==m.membershipType&&0!=(256&userinfo.siteadmin)?"<a href=# onclick='return p30RemoveUserGroup(event,\""+encodeURIComponentEx(p[v]._id)+'")\' title="刪除用戶群成員身份" style=cursor:pointer><i class="fa-solid fa-trash text-danger hoverButton"></i></a>':r)+"</div></td></tr>"}}1==e&&(t+="<tr><td><div style=padding:6px>&nbsp;<i>沒有用戶群成員身份</i><div></div></div></td><td></td></tr>"),t+="</tbody></table>"}if(e=1,t+="<br />",currentUser._id.split("/")[1]==userinfo._id.split("/")[1]&&(t+='<button class="btn btn-primary btn-sm me-2 mb-1" onclick="return p20showAddMeshUserDialog(4)"><i class="fa-solid fa-circle-plus"></i> 新增裝置</button>'),t+='<table class="table table-hover"><tbody><tr class="table-active"><th scope=col>通用裝置</th><th scope=col></th></tr>',currentUser.links){var v,f=[];for(v in currentUser.links)v.startsWith("node/")&&null!=(x=getNodeFromId(v))&&f.push(x);for(v in f.sort(nameSort),f){var x=f[v],g=currentUser.links[x._id].rights,r="",a=GetNodeRights(x),k=(userinfo.links&&null!=userinfo.links[v]&&null!=userinfo.links[v].rights&&(a=userinfo.links[v].rights),x?EscapeHtml(x.name):"<i>未知裝置</i>");0!=(2&a)&&(r="<a href=# onclick='return p30removeNodeFromUser(event,\""+encodeURIComponentEx(x._id)+'")\' title="刪除此裝置群的用戶權限" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>',d='<span style=cursor:pointer onclick=p20showAddMeshUserDialog(4,"'+encodeURIComponentEx(x._id)+'")>'+makeUserDeviceRightsString(g)+" <img class=hoverButton style=cursor:pointer src=images/link5.png></span>"),k="<a href=# onclick='gotoDevice(\""+x._id+"\",10);haltEvent(event);'>"+k+"</a>",t+="<tr "+(++e%2==0?"style=background-color:#DDD":"")+'><td style=width:30%><div title="裝置" class=si'+x.icon+"></div><div>&nbsp;"+k+"<div></div></div></td><td style=width:70%><div style=float:right>"+r+"</div><div>"+d+"</div></td></tr>"}}1==e&&(t+="<tr><td><div style=padding:6px>&nbsp;<i>沒有共同的裝置</i><div></div></div></td><td></td></tr>"),t+="</tbody></table>",QH("p30html2",t)}function p30removeDeviceSharing(e,t,n,o){xxdialogMode||(setModalContent("xxAddAgent","刪除設備共享",format("確認刪除設備共享“{0}”？",decodeURIComponent(o))),showModal("xxAddAgentModal","idx_dlgOkButton",function(e,t){meshserver.send({action:"removeDeviceShare",nodeid:t[0],publicid:t[1]})},3,[decodeURIComponent(t),decodeURIComponent(n)]))}function p30removeNodeFromUser(e,t){xxdialogMode||(setModalContent("xxAddAgent","刪除裝置權限",format("確認刪除裝置“ {0} ”的訪問權限？",(t=getNodeFromId(decodeURIComponent(t))).name)),showModal("xxAddAgentModal","idx_dlgOkButton",function(e,t){meshserver.send({action:"adddeviceuser",nodeid:t._id,nodename:t.name,userids:[currentUser._id],rights:0,remove:!0})},3,t))}function p30removeUserFromNode(e,n){var t,o;xxdialogMode||(t=null,o="",n=decodeURIComponent(n),xxdialogButtons=3,xxdialogTag=t,n.startsWith("user/")?(setModalContent("xxAddAgent","刪除用戶權限",(o=users&&null!=(t=users[n])?t.name:o)?format("確認刪除用戶“ {0} ”的訪問權限？",o):"確認刪除訪問權限？"),showModal("xxAddAgentModal","idx_dlgOkButton",function(e,t){meshserver.send({action:"adddeviceuser",nodeid:currentNode._id,nodename:currentNode.name,userids:[n],rights:0,remove:!0})})):n.startsWith("ugrp/")&&(setModalContent("xxAddAgent","刪除用戶群權限",(o=usergroups&&null!=(t=usergroups[n])?t.name:o)?format("確認刪除用戶群“ {0} ”的訪問權限？",o):"確認刪除訪問權限？"),showModal("xxAddAgentModal","idx_dlgOkButton",function(e,t){meshserver.send({action:"adddeviceuser",nodeid:currentNode._id,nodename:currentNode.name,userids:[n],rights:0,remove:!0})})))}function p30RemoveUserGroup(e,t){var n;xxdialogMode||null==usergroups||(n=decodeURIComponent(t),setModalContent("xxAddAgent","刪除用戶群成員身份",format("確認刪除用戶群“ {0} ”的成員身份？",null!=(t=usergroups[n])?EscapeHtml(t.name):"<i>未知</i>")),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p30RemoveUserGroupEx(3,n)}))}function p30RemoveUserGroupEx(e,t){meshserver.send({action:"removeuserfromusergroup",ugrpid:t,userid:currentUser._id})}function p30showAddUserGroupDialog(){if(!xxdialogMode&&null!=usergroups){var e,t="";for(e in usergroups)null!=usergroups[e].membershipType||usergroups[e]._id.split("/")[1]!=currentUser._id.split("/")[1]||null!=currentUser.links&&null!=currentUser.links[e]||(t+="<option value="+encodeURIComponentEx(e)+">"+EscapeHtml(usergroups[e].name)+"</option>");var n=addHtmlFormFloating("用戶群",'<select id=dp2groupid class="form-select">'+t+"</select>");return xxdialogButtons=3,setModalContent("xxAddAgent","新增成員身份",n),showModal("xxAddAgentModal","idx_dlgOkButton",p30showAddUserGroupDialogEx),Q("dp2groupid").focus(),!1}}function p30showAddUserGroupDialogEx(){meshserver.send({action:"addusertousergroup",ugrpid:decodeURIComponent(Q("dp2groupid").value),usernames:[currentUser._id.split("/")[2]]})}function p30removeMeshFromUser(e,t){var n;xxdialogMode||null!=(n=meshes[decodeURIComponent(t)])&&(setModalContent("xxAddAgent","刪除裝置群權限",format("確認刪除裝置群“ {0} ”的訪問權限？",n.name)),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p30removeMeshFromUserEx(3,n._id)}))}function p30removeMeshFromUserEx(e,t){meshserver.send({action:"removemeshuser",meshid:t,userid:currentUser._id})}var currentUserEvents=null;function userEventsUpdate(){if(null!=currentUser){var e="",t=null;for(l in currentUserEvents){var n=currentUserEvents[l],o=new Date(n.time);if(n.msg){null==n.h&&(n.h=Math.random()),printDate(o)!=t&&(null!=t&&(e+="</table>"),e+='<table class="table table-hover p3eventsTable" cellpadding=0 cellspacing=0><tr><td colspan=4 class=DevSt>'+(t=printDate(o))+"</td></tr>");var i,s,a="fa-mobile-screen";if("user"==n.etype&&(a="fa-user"),"server"==n.etype&&(a="fa-server"),null==n.msgid||null==eventsMessageId[n.msgid])i="string"==typeof n.msg?EscapeHtml(n.msg).split("(R)").join("&reg;"):"";else{for(var l in i=eventsMessageId[n.msgid],n.msgArgs){var r=n.msgArgs[l];"string"==typeof r&&0==r.indexOf("DATETIME:")&&(r=printFlexDateTime(new Date(parseInt(r.substring(9))))),i=i.split("{"+l+"}").join(r)}i=EscapeHtml(i).split("(R)").join("&reg;")}n.nodeid&&null!=(s=getNodeFromId(n.nodeid))&&(a="si"+s.icon,i="<a href=# onclick='gotoDevice(\""+n.nodeid+"\",10);haltEvent(event);'>"+EscapeHtml(s.name)+"</a> &rarr; "+i),n.username&&n.username!=currentUser.name?(s="",n.guestname&&(s=' / <span title="這是一個嘉賓分享會">'+EscapeHtml(n.guestname)+"</span>"),i=2&userinfo.siteadmin&&n.userid?"<a href=# onclick='gotoUser(\""+encodeURIComponentEx(n.userid)+"\");haltEvent(event);'>"+EscapeHtml(n.username)+"</a>"+s+" &rarr; "+i:EscapeHtml(n.guestname)+" &rarr; "+i):n.guestname&&(i='<span title="這是一個嘉賓分享會">'+EscapeHtml(n.guestname)+"</span> &rarr; "+i),"relay"!=n.etype&&"relaylog"!=n.action||(a="fa-arrow-right-arrow-left"),e+="<tr onclick=showEventDetails("+n.h+',3)  onmouseover=eventMouseHover(this,1) onmouseout=eventMouseHover(this,0) style=cursor:pointer><td style=width:18px><i class="fa-solid '+a+'"></i></td><td class=g1>&nbsp;</td><td class=style10>'+printTime(o)+" - "+i+"</td></tr><tr></tr>"}}null!=t&&(e+="</table>"),""==e&&(e="<br><i>找不到事件</i><br><br>"),QH("p31events",e)}}function refreshUsersEvents(){""!=p31filterevents.value?meshserver.send({action:"events",limit:parseInt(p31limitdropdown.value),userid:currentUser._id,filter:p31filterevents.value}):meshserver.send({action:"events",limit:parseInt(p31limitdropdown.value),userid:currentUser._id})}var d3filetreelinkpath,p52recordings=null;function updateRecordings(){for(var e=[],t=document.getElementsByClassName("RecordingCheckbox"),n="",o=0;o<t.length;o++)t[o].checked&&e.push(t[o].value);if(null==p52recordings)n+="<div style=width:100%;text-align:center;margin-top:20px><i>載入中...</i></div>";else if("number"==typeof p52recordings)n+=1==p52recordings?"<div style=width:100%;text-align:center;margin-top:20px><i>Server is unable to read from the recordings folder.</i></div>":2==p52recordings?"<div style=width:100%;text-align:center;margin-top:20px><i>Server is unable to get recordings from the database.</i></div>":"<div style=width:100%;text-align:center;margin-top:20px><i>An unknown error occured.</i></div>";else if(0==p52recordings.length)n+="<div style=width:100%;text-align:center;margin-top:20px><i>沒有錄音。</i></div>";else{if(n=(n+='<table class="table table-hover" cellpadding=0 cellspacing=0><thead class="text-center"><tr>')+("<th>節</th><th style=width:110px>"+nobreak("開始時間")+"</th><th style=width:110px>持續時間</th><th style=width:110px>尺寸</th></tr></thead><tbody>"),null!=p52recordings){var i=null;for(o in p52recordings){var s=p52recordings[o],a=printDate(new Date(s.time));a!=i&&(n+="<tr><td class=userTableHeader colspan=4>"+(i=a)),n+=addRecordingHtml(o,s)}}n+="</tbody></table>"}QH("p52recordings",n);for(t=document.getElementsByClassName("RecordingCheckbox"),o=0;o<t.length;o++)t[o].checked=0<=e.indexOf(t[o].value);p52updateInfo()}function addRecordingHtml(e,t){var n="",o=(t.lengthTime&&(n=pad2(Math.floor(t.lengthTime/3600))+":"+pad2(Math.floor(t.lengthTime%3600/60))+":"+pad2(Math.floor(t.lengthTime%60))),printTime(new Date(t.time))),i=(t.sessionStart&&(o=printTime(new Date(t.sessionStart))),""),s=(t.size&&(i=format("{0} Kb",Math.round(t.size/1024))),"<i>未知</i>"),a=(t.name&&t.meshname&&(s=null!=meshes[t.meshid]?"<a href=# onclick='gotoMesh(\""+t.meshid+"\")'>"+EscapeHtml(t.meshname)+"</a> - <a href=# onclick='gotoDevice(\""+t.nodeid+"\",10)'>"+EscapeHtml(t.name)+"</a>":EscapeHtml(t.meshname)+" - "+EscapeHtml(t.name)),null!=t.userids&&0<t.userids.length&&(1<t.userids.length?s+=" - "+format("{0} users",t.userids.length):s+=(a=null)!=(a=null!=users?users[t.userids[0]]:a)?" - <a href=# onclick='gotoUser(\""+encodeURIComponentEx(t.userids[0])+"\")'>"+EscapeHtml(a.name)+"</a>":" - "+EscapeHtml(t.userids[0].split("/")[2])),1==t.protocol&&(s+=" - 終端會話"),2==t.protocol&&(s+=" - 桌面會話"),5==t.protocol&&(s+=" - 文件傳輸"),100==t.protocol&&(s+=" - Intle&reg; AMT WSMAN"),101==t.protocol&&(s+=" - Intel&reg; AMT重定向"),200==t.protocol&&(s+=" - 信使"),""),l="fa-circle-xmark text-danger",t=(1==t.present&&(l="fa-circle-check text-success",a='<div style=cursor:pointer;float:right><a onclick=downloadFile("recordings.ashx?file='+encodeURIComponentEx(t.filename)+'")><i class="fa-fw fa-solid fa-download fa-sm" title="Download Recording"></i></a>&nbsp;</div>',a+='<div style=cursor:pointer;float:right><a href="player.htm?stream='+encodeURIComponentEx(t.filename)+'") rel="noreferrer noopener" target="mcplay-'+encodeURIComponentEx(t.filename)+'"><i class="fa-fw fa-solid fa-play fa-sm" title="Play Recording"></i></a>&nbsp;</div>'),"<tr tabindex=0 onmouseover=userMouseHover2(this,1) onmouseout=userMouseHover2(this,0) onkeypress=\"if (event.key=='Enter') showRecordingDialog(event,'"+e+"')\"><td style=cursor:pointer>");return(t+="<div class=bar style=width:100%>")+"<div></div>"+('<div class=baricon onclick=showRecordingDialog(event,"'+e+'")><i class="fa-fw fa-solid '+l+'"></i></div>')+('<div class=g1 onclick=showRecordingDialog(event,"'+e+'")></div><div class=g2 onclick=showRecordingDialog("'+e+'")></div>')+('<div style=line-height:24px onclick=showRecordingDialog(event,"'+e+'")>'+a+"<div style=font-size:16px>"+s+"</div></div></div><td style=text-align:center>"+o+"<td style=text-align:center>"+n+"<td style=text-align:center>"+i)}function showRecordingDialog(e,t){if(!xxdialogMode&&"IMG"!=e.target.tagName&&"A"!=e.target.tagName){var n=p52recordings[t],o="";if(n.protocol&&(e="未知",1==n.protocol&&(e="終端機"),2==n.protocol&&(e="桌面"),5==n.protocol&&(e="檔案"),100==n.protocol&&(e="Intle&reg; AMT WSMAN"),o+=addHtmlValue4("協議",e=101==n.protocol?"Intel&reg; AMT重定向":e)),o+=addHtmlValue4("狀態",1==n.present?"存在於伺服器上":"不在伺服器上"),n.name&&(o+=addHtmlValue4("裝置名稱",EscapeHtml(n.name))),n.meshname&&(o+=addHtmlValue4("裝置群",EscapeHtml(n.meshname))),n.size&&(o+=addHtmlValue4("尺寸",format("{0}個字節",n.size))),n.startTime&&(o+=addHtmlValue4("開始時間",printTime(new Date(n.startTime)))),n.time&&(o+=addHtmlValue4("時間結束",printTime(new Date(n.time)))),n.lengthTime&&(o+=addHtmlValue4("持續時間",pad2(Math.floor(n.lengthTime/3600))+":"+pad2(Math.floor(n.lengthTime%3600/60))+":"+pad2(Math.floor(n.lengthTime%60)))),1==n.multiplex&&(o+=addHtmlValue4("多工器","已啟用")),n.userids)for(var t in n.userids)o+=addHtmlValue4("用戶",n.userids[t].split("/")[2]);xxdialogButtons=9,setModalContent("xxAddAgent","記錄細節",o),showModal("xxAddAgentModal","idx_dlgOkButton",null)}}function refreshRecodings(){meshserver.send({action:"recordings",limit:1e3})}function openRecodringPlayer(){xxdialogMode||safeNewWindow(window.location.origin+"{{{domainurl}}}player.htm","meshcentral-deskplayer")}function p52updateInfo(){for(var e=document.getElementsByClassName("RecordingCheckbox"),t=0;t<e.length;t++)!0===e[t].checked&&0}function d3init(){d3fileoptions={dialog:1,filter:"d3filter",files:"d3serverfiles",folderup:"p3FolderUp",currentFolder:"p3CurrentFolder",func:d3setActions},Q("d3localFile").value="",Q("d3localFile").accept=Q("d3filter").value,d3modechange()}function d3modechange(){var e=Q("d3uploadMode").value;QV("d3localmode",1==e),QV("d3servermode",2==e),(1==e?d3setActions:d3updatefiles)()}var d3filetreelocation=[],d3fileoptions=null;function d3updatefiles(){if(null!=d3fileoptions&&("d3filter"!=d3fileoptions.filter||1!=Q("d3uploadMode").value)){for(var e,t="",n="",o=filetree,i=1,s="",a=[],l=[],r=document.getElementsByName("fc"),d=0;d<r.length;d++)r[d].checked&&l.push(r[d].value);for(d in d3filetreelinkpath="",d3filetreelocation){if(null==o.f||null==o.f[d3filetreelocation[d]])break;a.push(d3filetreelocation[d]),1==i?(e=d3filetreelocation[d].split("/"),window.location.origin,e[0],d3filetreelocation[d]===userinfo._id?d3filetreelinkpath+="self":d3filetreelinkpath+=e[0]+"/"+e[2]):""!=d3filetreelinkpath&&(d3filetreelinkpath+="/"+d3filetreelocation[d],2<i)&&d3filetreelocation[d],s=(o=o.f[d3filetreelocation[d]]).n,i++}d3filetreelocation=a;var c=p5sort_files(o.f),u="";for(d in d3fileoptions.filter&&(u=Q(d3fileoptions.filter).value),c){var p,m,g=c[d],h=g.n;3==g.t&&""!=u&&0==g.nx.toLowerCase().endsWith(u)||(h=70<h.length?'<span title="'+EscapeHtml(h)+'">'+EscapeHtml(h.substring(0,70))+"...</span>":EscapeHtml(h),p="",null!=g.s&&(p=getFileSizeStr(g.s)),m="",m=3!=g.t?'<div class=filelist file=999><span style=float:right title=""></span><span><div class=fileIcon'+g.t+' onclick=d3folderset("'+encodeURIComponentEx(g.nx)+'")></div>&nbsp;<a href=# style=cursor:pointer onclick=\'return d3folderset("'+encodeURIComponentEx(g.nx)+"\")'>"+h+"</a></span></div>":(h=h,'<div class=filelist file=3><input style=float:left name=fcx class="fcb form-check-input me-2" type=checkbox onchange=d3setActions() value="'+g.nx+'">&nbsp;<span style=float:right>'+EscapeHtml(p)+"</span><span><div class=fileIcon"+g.t+"></div>"+h+"</span></div>"),g.t<3?t+=m:n+=m)}d3fileoptions.currentFolder&&QH(d3fileoptions.currentFolder,s),QH(d3fileoptions.files,t+n),QE(d3fileoptions.folderup,0<d3filetreelocation.length),d3fileoptions.func&&d3fileoptions.func()}}function d3folderset(e){return d3filetreelocation.push(decodeURIComponent(e)),d3updatefiles(),!1}function d3folderup(e){if(null==e)d3filetreelocation.pop();else for(;d3filetreelocation.length>e;)d3filetreelocation.pop();d3updatefiles()}function d3getFileSel(){for(var e=[],t=document.getElementsByName("fcx"),n=0;n<t.length;n++)t[n].checked&&e.push(t[n].value);return e}function d3setActions(){1==d3fileoptions.dialog?1==Q("d3uploadMode").value?QE("idx_dlgOkButton",0<Q("d3localFile").value.length):QE("idx_dlgOkButton",1==d3getFileSel().length):2==d3fileoptions.dialog&&QE("idx_dlgOkButton",1==d3getFileSel().length)}var reportCSV=null;function generateReportDialog(){if(!xxdialogMode){var e="",t="",n=JSON.parse(getstore("_ReportSettings","{}")),o={1:"遠程會話",2:"用戶流量使用",3:"用戶登錄"};for(i in 4294967295==userinfo.siteadmin&&(o[4]="Database Records"),o)e+="<option value="+i+(n.type==i?" selected":"")+">"+o[i]+"</option>";t=t+addHtmlFormFloating("類型",'<select id=d2reportType class="form-select" onchange=generateReportDialogValidate()>'+e+"</select>")+"<div id=d2GroupByDiv style=display:none>",e="";for(i in o={1:"用戶",2:"裝置",3:"天"})e+="<option value="+i+(n.groupBy==i?" selected":"")+">"+o[i]+"</option>";for(i in t=(t+=addHtmlFormFloating("通過...分群",'<select id=d2groupBy class="form-select" onchange=generateReportDialogValidate()>'+e+"</select>"))+"</div>"+"<div id=d2GroupByDiv2 style=display:none>",e="",o={1:"用戶",3:"天"})e+="<option value="+i+(n.groupBy2==i?" selected":"")+">"+o[i]+"</option>";t=(t+=addHtmlFormFloating("通過...分群",'<select id=d2groupBy2 class="form-select" onchange=generateReportDialogValidate()>'+e+"</select>"))+"</div>"+"<div id=d2DeviceGroupDiv style=display:none>",e="<option value=0"+(0==n.devGroup?" selected":"")+">所有</option>";var i,s=getOrderedList(meshes,"name");for(i in s)e+="<option value="+encodeURIComponentEx(s[i]._id)+(n.devGroup==s[i]._id?" selected":"")+">"+EscapeHtml(s[i].name)+"</option>";for(i in t=(t+=addHtmlFormFloating("裝置群",'<select onchange=generateReportDialogValidate() id=d2groupId class="form-select">'+e+"</select>"))+"</div>"+"<div id=d2timeBackDiv style=display:none>",e="",null==n.timeRange&&(n.timeRange=1),o={1:"最後一天",7:"過去 7 天",30:"過去30天",0:"時間範圍"})e+="<option value="+i+(n.timeRange==i?" selected":"")+">"+o[i]+"</option>";setModalContent("xxAddAgent","生成報告",t=(t=(t=(t=(t+=addHtmlFormFloating("時間",'<select id=d2timeRange class="form-select" onchange=generateReportDialogValidate()>'+e+"</select>"))+"</div>"+"<div id=d2timeRangeDiv style=display:none>")+addHtmlFormFloating("時間範圍",'<input id=d2timeRangeSelector class="flatpickr form-control" type="text" placeholder="選擇日期和時間..." data-id="altinput">'))+"</div>"+"<div id=d2showTrafficDiv style=display:none>")+addHtmlValue("",'<div style=width:250px><label><input type=checkbox class="form-check-input me-2" id=d2showTraffic '+(n.showTraffic?"checked":"")+">顯示流量</label><div>")+"</div>"),showModal("xxAddAgentModal","idx_dlgOkButton",generateReportDialogEx),generateReportDialogValidate();t=new Date,t=(t.setDate(t.getDate()-7),flatpickr("#d2timeRangeSelector",{mode:"range",enableTime:!0,maxDate:new Date,defaultDate:[t,new Date],minuteIncrement:1}));xxdialogTag=t}}function generateReportDialogValidate(){QV("d2timeRangeDiv",0==Q("d2timeRange").value),QV("d2timeBackDiv",4!=Q("d2reportType").value),QV("d2GroupByDiv",1==Q("d2reportType").value),QV("d2GroupByDiv2",3==Q("d2reportType").value),QV("d2DeviceGroupDiv",1==Q("d2reportType").value),QV("d2showTrafficDiv",1==Q("d2reportType").value)}function generateReportDialogEx(e,t){var n,o=0==Q("d2timeRange").value?(n=Math.floor(t.selectedDates[1].getTime()/1e3),Math.floor(t.selectedDates[0].getTime()/1e3)):(n=Math.floor(new Date/1e3),o=new Date,Math.floor(o.setDate(o.getDate()-Q("d2timeRange").value)/1e3)),t=null;try{t=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(e){}var i=decodeURIComponent(Q("d2groupId").value),s=(0==i&&(i=null),putstore("_ReportSettings",JSON.stringify({type:parseInt(Q("d2reportType").value),groupBy:parseInt(Q("d2groupBy").value),groupBy2:parseInt(Q("d2groupBy2").value),timeRange:parseInt(Q("d2timeRange").value),devGroup:i,showTraffic:Q("d2showTraffic").checked})),parseInt(Q("d2groupBy").value));3==Q("d2reportType").value&&(s=parseInt(Q("d2groupBy2").value)),meshserver.send({action:"report",type:parseInt(Q("d2reportType").value),groupBy:s,start:o,end:n,tz:t,tf:(new Date).getTimezoneOffset(),l:getLang(),devGroup:i,showTraffic:Q("d2showTraffic").checked})}function renderReport(e){var t={time:"時間",device:"裝置",session:"節",user:"用戶",devgroup:"裝置群",guest:"來賓",length:"長度",bytesin:"字節輸入",bytesout:"字節輸出",os:"操作系統",ip:"IP地址",browser:"瀏覽器",msg:"訊息",twofactor:"第二個因素"},n='<table class="table table-hover">',o=null,i=[];if(0==Object.keys(e.groups).length)reportCSV=null,QV("p60downloadReportDiv",!1),n+="<tr><td style=text-align:center;padding-top:32px>報告未返回任何內容。</tr></td>";else{for(var s in reportCSV='"群"',n+="<tr>",e.columns){var a=null!=t[e.columns[s].title]?t[e.columns[s].title]:EscapeHtml(e.columns[s].title),l="";e.columns[s].align?l+=";text-align:"+EscapeHtml(e.columns[s].align):l+=";text-align:left",0!=s||"datetime"!=e.columns[s].format&&"time"!=e.columns[s].format||(l+=";width:1%"),n+="<th style="+l+">"+a+"</th>",reportCSV+=',"'+csvClean(a)+'"'}for(var s in n+="</tr>",reportCSV+="\r\n",e.groups)for(var r in n=(n+="<tr style=height:8px></tr>")+("<tr><td colspan="+e.columns.length+' style="border-bottom:1pt solid black"><b>'),0!=s&&(n+=renderReportFormat(s,e.groupFormat)),n+="</b></td></tr>",e.groups[s].entries){var d,c=e.groups[s].entries[r];for(d in n+="<tr>",reportCSV+=0!=s?'"'+csvClean(renderReportFormatCSV(s,e.groupFormat))+'"':'""',e.columns){var u,p,l="";null!=e.columns[d].format&&(l="white-space:nowrap;"),e.columns[d].align&&(l="text-align:"+EscapeHtml(e.columns[d].align)),null!=c[e.columns[d].id]?(n+='<td style="'+l+'">'+renderReportFormat(c[e.columns[d].id],e.columns[d].format)+"</td>",reportCSV+=',"'+csvClean(renderReportFormatCSV(c[e.columns[d].id],e.columns[d].format))+'"'):(n+="<td></td>",reportCSV+=","),null!=e.columns[d].sumBy&&(u=c[e.columns[d].sumBy],!0===e.columns[d].sumBy&&(u=!0),p=c[e.columns[d].id],o=e.columns[d].sumBy,null!=p)&&(-1==i.indexOf(u)&&i.push(u),null==e.columns[d].subtotals&&(e.columns[d].subtotals={},e.columns[d].totals={}),null==e.columns[d].subtotals[u]?e.columns[d].subtotals[u]=p:e.columns[d].subtotals[u]+=p,null==e.columns[d].totals[u]?e.columns[d].totals[u]=p:e.columns[d].totals[u]+=p)}n+="</tr>",reportCSV+="\r\n"}if(null!=o){var m=-1;if(!0===o)m=99999;else for(var s in e.columns)e.columns[s].id==o&&(m=s);if(0<=m){i.sort();var g=!0;for(r in n+="<tr style=height:8px></tr>",i){for(var s in n+="<tr>",e.columns)s==m?(l="",e.columns[d].align&&(l+=";text-align:"+EscapeHtml(e.columns[d].align)),g&&(l+=";border-top:1pt solid #777"),n+='<td style="color:#777'+l+'">'+renderReportFormat(i[r],e.columns[s].format)):null!=e.columns[s].totals?(l="",e.columns[d].align&&(l+=";text-align:"+EscapeHtml(e.columns[d].align)),g&&(l+=";border-top:1pt solid #777"),n+='<td style="color:#777'+l+'">'+renderReportFormat(e.columns[s].totals[i[r]],e.columns[s].format)):n+="<td></td>";n+="</tr>",g=!1}}}QV("p60downloadReportDiv",!0)}n+="</table>",QH("p60report",n)}function renderReportFormat(e,t){if(null==e)return"";if("datetime"==t)return printDateTime(new Date(e));if("time"==t)return printTime(new Date(e));if("protocol"==t)return 1==e?"終端機":2==e?"桌面":5==e?"檔案":100==e?"AMT-WSMAN":101==e?"AMT-Redir":200==e?"信使":201==e?"網絡RDP":202==e?"網絡SSH":203==e?"網絡SFTP":204==e?"網絡-VNC":"未知 ("+e+")";if("seconds"==t)return a=e%60,s=60&Math.floor(e/60),i=Math.floor(e/3600),zeroPad(i,2)+":"+zeroPad(s,2)+":"+zeroPad(a,2);if("node"==t)return null!=(o=getNodeFromId(e))?"<div onclick='gotoDevice(\""+o._id+'",10);haltEvent(event);\' style=float:left;margin-right:4px class="j'+o.icon+'"></div>'+EscapeHtml(o.name):"<i>未知</i>";if("mesh"==t)return null!=(n=meshes[e])?"<div onclick='gotoMesh(\""+n._id+'",10);haltEvent(event);\' style=float:left;margin-right:4px;cursor:pointer class="m99"></div>'+EscapeHtml(n.name):"<i>未知</i>";if("nodemesh"==t){var n,o,i=null,s=null,a=e.split("/"),l="<table><tr>";if(3<=a.length&&(i=a[0]+"/"+a[1]+"/"+a[2]),null!=(s=6<=a.length?a[3]+"/"+a[4]+"/"+a[5]:s)){if(null==(n=meshes[s]))return"<i>未知</i>";l+="<td><div onclick='gotoMesh(\""+n._id+'",10);haltEvent(event);\' style=float:left;margin-right:4px;cursor:pointer class="m99"></div>'+EscapeHtml(n.name)+"&nbsp;&nbsp;&nbsp;</td>"}return null==(o=getNodeFromId(i))?"<i>未知</i>":l=l+("<td><div onclick='gotoDevice(\""+o._id+'",10);haltEvent(event);\' style=float:left;margin-right:4px class="j'+o.icon+'"></div>'+EscapeHtml(o.name)+"</td>")+"</tr></table>"}if("user"==t)return a=null,e==userinfo._id?a=userinfo:null!=users&&(a=users[e]),null!=a?(s=a.name,null!=a.realname&&(s+=", "+a.realname),"<div onclick='gotoUser(\""+a._id+'",10);haltEvent(event);\' style=float:left;margin-right:4px;cursor:pointer><i class="fa-solid fa-user-circle"></i></div>'+EscapeHtml(s)):"<i>未知用戶</i>";if("msg"==t){if(107==e)return'<div style=float:left;margin-right:4px;cursor:pointer><i class="fa-solid fa-check-circle text-success"></i></div>成功登錄';if(108==e)return'<div style=float:left;margin-right:4px;cursor:pointer class="NotifyIconTiny2"></div>第二個因素不正確';if(109==e)return'<div style=float:left;margin-right:4px;cursor:pointer class="NotifyIconTiny4"></div>被鎖定賬戶';if(110==e)return'<div style=float:left;margin-right:4px;cursor:pointer><i class="fa-solid fa-exclamation-triangle text-warning"></i></div>無效的登錄嘗試'}if("2fa"==t){if(""==e)return"沒有";if("backup"==e)return"備用碼";if("fido"==e)return"FIDO 密鑰";if("sms"==e)return"短信";if("hwotp"==e)return"硬件一次性密碼";if("messenger"==e)return"Messenging";if("push"==e)return"推送通知";if("otp"==e)return"一次性密碼";if("cookie"==e)return"記住設備";if("tokenlogin"==e)return"登錄令牌";if("ipaddr"==e)return"IP地址";if("sso"==e)return"單點登錄"}return"records"==t?null!=(n={node:"Device record",mesh:"Device group record",user:"User records",sysinfo:"Device information records",iploc:"IP location information records",note:"Text notes records",ifinfo:"Network interface information records",cfile:"Configuration file records",lastconnect:"Last connection time records",power:"Device power transition records",events:"Event records",serverstats:"Server statistics records",ugrp:"User group records",deviceshare:"Device sharing records",logintoken:"Account login token records",smbios:"Device SMBIOS record",pmt:"Device Push Notification Record",meshcentral:"Device, users, groups and other records"})[e]?n[e]:e:EscapeHtml(e)}function renderReportFormatCSV(e,t){if("datetime"==t)return printDateTime(new Date(e));if("time"==t)return printTime(new Date(e));if("protocol"==t)return 1==e?"終端機":2==e?"桌面":5==e?"檔案":"未知";if("node"==t){var n=getNodeFromId(e);if(null!=n)return n.name}if("mesh"==t){n=meshes[e];if(null!=n)return n.name}var o;if("user"==t)return n=null,e==userinfo._id?n=userinfo:null!=users&&(n=users[e]),null!=n?(o=n.name,null!=n.realname&&(o+=" - "+n.realname),o):"未知用戶";if("msg"==t){if(107==e)return"成功登錄";if(108==e)return"第二個因素不正確";if(109==e)return"被鎖定賬戶";if(110==e)return"無效的登錄嘗試"}return"records"==t?renderReportFormat(e,t):""+e}function p60downloadReport(){xxdialogMode||null==reportCSV||saveAs(stringToUtf8Blob(reportCSV),"報告.csv")}var notifications=[];function clickNotificationIcon(e){1==e?QV("notifiyBox",!0):0==e?QV("notifiyBox",!1):QV("notifiyBox","none"==QS("notifiyBox").display),drawNotifications()}function setNotificationCount(e){parseInt(Q("notificationCount").innerHTML)!=e&&(QH("notificationCount",e),QS("notificationCount")["background-color"]=0==e?"lightblue":"orange",QV("notificationCount",0<e))}function drawNotifications(){var e=getstore("notifications",0),t="";if(0==notifications.length)t="<div style=margin:5px>目前沒有任何通知</div>";else for(var n in notifications){var o,n=notifications[n],i="",s=new Date(n.time),a=0;null!=n.title&&(i="<b>"+EscapeHtml(n.title)+"</b>: "),null!=n.nodeid&&null!=(o=getNodeFromId(n.nodeid))&&(a=o.icon,i=16&e?"<b>"+EscapeHtml(meshes[o.meshid].name)+" / "+EscapeHtml(o.name)+"</b>: ":"<b>"+EscapeHtml(o.name)+"</b>: "),t+='<div title="'+format("發生在{0}",printDateTime(s))+'" id="notifyx'+n.id+'" class=notification style="cursor:pointer;border-top:1px solid '+(""==t?"transparent":"orange")+'">',a&&(t+="<div class=j"+a+' onclick="notificationSelected('+n.id+')" style=margin:5px;float:left></div>'),t+='<div onclick="notificationDelete('+n.id+')" class=unselectable title="清除此通知" style=margin:5px;float:right;color:orange><b>X</b></div><div onclick="notificationSelected('+n.id+')" style=margin:5px>'+i+EscapeHtml(n.text)+"</div><div style=margin-left:5px;margin-bottom:5px;color:gray;font-size:10px>"+printDateTime(s)+"</div></div>"}var l="";1<notifications.length&&(l='<div id="notifyRemoveAll" onclick="deleteAllNotifications()" style="cursor:pointer;border-top:1px solid orange;margin:5px;color:orange;text-align:right;padding-right:3px">全部清除</div>'),QH("notifiyBox",'<div class=customScroll style="max-height:170px;overflow-y:auto;margin:5px">'+t+l+"</div>")}function notificationSelected(e,t){var n,o=-1;for(n in notifications)notifications[n].id==e&&(o=n);-1!=o&&(notificationSelectedEx(notifications[o],e),t)&&notifications[o]&&(notifications[o].notification&&(notifications[o].notification.close(),delete notifications[o].notification),notificationDelete(e))}function notificationSelectedEx(e,t){null!=e.nodeid?"desktop"==e.tag?gotoDevice(e.nodeid,12):"terminal"==e.tag?gotoDevice(e.nodeid,11):"files"==e.tag?gotoDevice(e.nodeid,13):"intelamt"==e.tag?gotoDevice(e.nodeid,14):"console"==e.tag?gotoDevice(e.nodeid,15):gotoDevice(e.nodeid,10):"backupcodes"!=e.tag||xxdialogMode?null!=e.tag&&e.tag.startsWith("meshmessenger/")?(safeNewWindow("/messenger?id="+e.tag+"&title="+encodeURIComponentEx(e.username),e.tag.split("/")[2]),notificationDelete(t)):null!=e.url&&(safeNewWindow(e.url),notificationDelete(t)):(go(2),account_manageOtp(0),notificationDelete(t))}function notificationDelete(e){var t=-1,n=Q("notifyx"+e);if(null!=n){for(var o in notifications)notifications[o].id==e&&(t=o);-1!=t&&(meshserver.send({action:"intersession",subaction:"removeNotify",id:e}),notifications[t].notification&&(notifications[t].notification.close(),delete notifications[t].notification),notifications.splice(t,1),n.parentNode.removeChild(n),setNotificationCount(notifications.length),0==notifications.length&&QV("notifiyBox",!1),1==notifications.length&&QV("notifyRemoveAll",!1),0<notifications.length)&&0==t&&(n=notifications[0],QS("notifyx"+n.id)["border-top"]="1px solid transparent")}}function addNotification(e){if("number"==typeof e.titleid)try{e.title=[null,"新賬戶","服務器限制","安全警告","帳號設定","裝置群","邀請碼"][e.titleid]}catch(e){}if("number"==typeof e.msgid)try{e.text=[null,"沒有權限","無效的用戶名","無效的密碼","不合規電郵","無效域","無效的網站權限","用戶已存在","此模式下無法添加用戶","驗證異常","達到帳戶限制。","聊天請求，點擊這裡接受。","自上次登錄以來，此帳戶有 {0} 次登錄嘗試失敗。","更改電子郵件地址失敗，另一個帳戶已在使用：{0}。","電郵已發送。","未找到用戶 {0}。","未找到用戶 {0}。","錯誤，無法更改為以前使用的密碼。","錯誤，無法更改為常用密碼。","錯誤，密碼未更改。","密碼已更改。","當前密碼不正確。",'錯誤，邀請碼 "{0}" 已在使用中。',"短信網關未啟用","沒有用戶管理權限","短信無效","沒有此用戶的電話號碼","SMS succesfully sent.","短信錯誤","短信錯誤：{0}",'不允許使用電子郵件域 "{0}"。只允許 ({1})',"Invalid message","Message succesfully sent.","Message error","Message error: {0}"][e.msgid],Array.isArray(e.args)&&(e.text=format(e.text,e.args[0],e.args[1],e.args[2],e.args[3],e.args[4],e.args[5]))}catch(e){}null==e.time&&(e.time=Date.now()),null==e.id&&(e.id=Math.random()),notifications.unshift(e),setNotificationCount(notifications.length),clickNotificationIcon(!0);var t,n,o=getstore("notifications",0),i=(1&o&&Q("chimes").play(),null);Notification&&"granted"==Notification.permission&&(t=e.text.split("&reg;").join("").split("<b>").join("").split("</b>").join("").split("<br />").join("\r\n"),e.nodeid?(n=getNodeFromId(e.nodeid))&&(i=16&o?new Notification(decodeURIComponent("{{{extitle}}}")+" - "+meshes[n.meshid].name+" - "+n.name,{tag:e.tag,body:t,icon:"/images/notify/icons128-"+n.icon+".png"}):new Notification(decodeURIComponent("{{{extitle}}}")+" - "+n.name,{tag:e.tag,body:t,icon:"/images/notify/icons128-"+n.icon+".png"})):(null==e.icon&&(e.icon=0),o=null==(o=e.title)?"":" - "+e.title,i=new Notification(decodeURIComponent("{{{extitle}}}")+o,{tag:e.tag,body:t,icon:"/images/notify/icons128-"+e.icon+".png"})),i.id=e.id,i.xtag=e.tag,i.url=e.url,i.nodeid=e.nodeid,i.username=e.username,i.onclick=function(e){notificationSelected(e.target.id,!0)},e.notification=i),"number"==typeof e.maxtime&&0<e.maxtime&&((n=function e(){notificationDelete(e.xid)}).xid=e.id,setTimeout(n,1e3*e.maxtime))}function deleteAllNotifications(){notifications=[],setNotificationCount(0),drawNotifications(),QV("notifiyBox",!1)}function setupGeneralServerStats(){window.serverStatCpu&&window.serverStatCpu.destroy(),window.serverStatMemory&&window.serverStatMemory.destroy(),window.serverStatCpu=new Chart(document.getElementById("serverCpuChart").getContext("2d"),{type:"doughnut",data:{datasets:[{data:[0,0],backgroundColor:["#AAAAAA","#00AA00"]}],labels:["用過的","自由"]},options:{events:[],responsive:!0,plugins:{legend:{display:!1}},animation:{animateScale:!0,animateRotate:!0},width:"40px"}}),window.serverStatMemory=new Chart(document.getElementById("serverMemoryChart").getContext("2d"),{type:"doughnut",data:{datasets:[{data:[0,0],backgroundColor:["#AAAAAA","#00AA00"]}],labels:["用過的","自由"]},options:{events:[],responsive:!0,plugins:{legend:{display:!1}},animation:{animateScale:!0,animateRotate:!0},width:"40px"}})}var lastServerStats=null;function updateGeneralServerStats(e){if(null!=e?lastServerStats=e:e=lastServerStats,null!=e){var t,n={ServerState:"伺服器狀態",AgentErrorCounters:"代理錯誤計數器",UnknownGroup:"未知群組",InvalidPKCSsignature:"無效的PKCS簽名",InvalidRSAsignature:"無效的RSA密碼",InvalidJSON:"無效的JSON",UnknownAction:"未知動作",BadWebCertificate:"錯誤的網絡憑證",BadSignature:"錯誤的簽名",MaxSessionsReached:"達到連接數量上限",UnknownDeviceGroup:"未知裝置群",InvalidDeviceGroupType:"無效的裝置群類型",DuplicateAgent:"代理重複",ConnectedIntelAMT:"已連接的Intel&reg; AMT",RelayErrors:"中繼錯誤",UserAccounts:"用戶帳戶",DeviceGroups:"裝置群",AgentSessions:"代理時段",ConnectedUsers:"已连接的用户",UsersSessions:"用戶節",RelaySessions:"中繼連接",RelayCount:"中繼數量"},o=(setupGeneralServerStats(),"object"==typeof e.cpuavg&&(t=Math.min(e.cpuavg[0],1),window.serverStatCpu.config.data.datasets[0].data=[t,1-t],QH("serverCpuChartText",'<div style=margin-bottom:5px>CPU負載</div><div><b title="最近一分鐘的CPU負載">'+Math.round(100*e.cpuavg[0])/100+'</b>, <b title="最近5分鐘的CPU負載">'+Math.round(100*e.cpuavg[1])/100+'</b>, <b title="最近15分鐘的CPU負載">'+Math.round(100*e.cpuavg[2])/100+"</b></div>"),QS("serverCpuChartView").display="inline-block",window.serverStatCpu.update()),"number"==typeof e.totalmem&&"number"==typeof e.availablemem?(window.serverStatMemory.config.data.datasets[0].data=[e.totalmem-e.availablemem,e.availablemem],QH("serverMemoryChartText","<div style=margin-bottom:5px>可用內存</div><div><b>"+getNiceSize3(e.availablemem)+"</b> 免費, <b>"+getNiceSize3(e.totalmem)+"</b> 總</div>"),QS("serverMemoryChartView").display="inline-block",window.serverStatMemory.update()):"number"==typeof e.totalmem&&"number"==typeof e.freemem&&(window.serverStatMemory.config.data.datasets[0].data=[e.totalmem-e.freemem,e.freemem],QH("serverMemoryChartText","<div style=margin-bottom:5px>記憶體</div><div><b>"+getNiceSize3(e.freemem)+"</b> 免費, <b>"+getNiceSize3(e.totalmem)+"</b> 總</div>"),QS("serverMemoryChartView").display="inline-block",window.serverStatMemory.update()),"<div style=width:100% cellpadding=0 cellspacing=0>");if("object"==typeof e.values)for(var i in e.values)for(var s in o+="<div class=userTableHeader style=margin-bottom:4px;width:200px>"+(n[i]||i)+"</div>",e.values[i])o+='<div style=display:inline-block class="me-2"><table class=serverStateTableCell><tr><td></td><td><span>'+(n[s]||s)+"</span><span style=float:right>"+e.values[i][s]+"</span></td><td></td></tr></table></div>";o+="</div>",QH("serverStatsTable",o)}}var serverTimelineStats=null,serverTimelineConfig={type:"line",data:{labels:[],datasets:[{label:"",backgroundColor:"rgba(255, 99, 132, .5)",borderColor:"rgb(255, 99, 132)",data:[],fill:!0}]},options:{animation:!1,responsive:!0,maintainAspectRatio:!1,elements:{line:{cubicInterpolationMode:"monotone"}},scales:{x:{type:"time",time:{tooltipFormat:"ll HH:mm"},display:!0,title:{display:!1,text:""}},y:{type:"linear",display:!0,title:{display:!0,text:""},stacked:!0}}}};function refreshServerTimelineStats(e){null!=meshserver&&2==meshserver.State&&meshserver.send({action:"servertimelinestats",hours:720})}function pastDate(e){var t=new Date;return t.setTime(t.getTime()-36e5*e),t}function setServerTimelineStats(e){serverTimelineStats=e,updateServerTimelineStats()}function addServerTimelineStats(e){var t;null!=serverTimelineStats&&((t=null)!=Q("p40server").value&&""==(t=decodeURIComponent(Q("p40server").value))&&(t=null),e.s==t)&&(serverTimelineStats.push(e),0==(t=Q("p40type").value)?(serverTimelineConfig.data.datasets[0].data.push({x:e.time,y:e.conn.ca}),serverTimelineConfig.data.datasets[1].data.push({x:e.time,y:e.conn.cu}),serverTimelineConfig.data.datasets[2].data.push({x:e.time,y:e.conn.us}),serverTimelineConfig.data.datasets[3].data.push({x:e.time,y:e.conn.rs}),null!=e.conn.am&&serverTimelineConfig.data.datasets[4].data.push({x:e.time,y:e.conn.am})):1==t?(serverTimelineConfig.data.datasets[0].data.push({x:e.time,y:e.mem.external/1048576}),serverTimelineConfig.data.datasets[1].data.push({x:e.time,y:e.mem.heapUsed/1048576}),serverTimelineConfig.data.datasets[2].data.push({x:e.time,y:e.mem.heapTotal/1048576}),serverTimelineConfig.data.datasets[3].data.push({x:e.time,y:e.mem.rss/1048576})):3==t||4==t?updateServerTimelineStats():5==t&&"object"==typeof e.cpu&&"number"==typeof e.cpu[0]&&serverTimelineConfig.data.datasets[0].data.push({x:e.time,y:e.cpu[0]}),updateServerTimelineHours())}function updateServerTimelineHours(){serverTimelineConfig.options.scales.y.type=Q("p40log").checked?"logarithmic":"linear",serverTimelineConfig.options.scales.x.min=pastDate(Q("p40time").value),window.serverMainStats.update()}function setupServerTimelineStats(){window.serverMainStats=new Chart(document.getElementById("serverMainStats").getContext("2d"),serverTimelineConfig)}let trafficSeriesNames=["代理","CIRA","AMT操作系統","HTTP","中繼","終端機","桌面","檔案","WebRDP","網絡SSH","網絡VNC","桌面多路復用"],seriesColors=[[158,151,16],[16,84,158],[255,99,132],[39,158,16],[134,16,158],[0,148,255],[255,216,0],[255,127,237],[109,213,255],[89,94,255],[179,104,255],[179,104,255]];function seriesColor1(e){return"rgba("+(seriesColors[e][0]+(255-seriesColors[e][0])/1.5)+","+(seriesColors[e][1]+(255-seriesColors[e][1])/1.5)+","+(seriesColors[e][2]+(255-seriesColors[e][2])/1.5)+")"}function seriesColor2(e){return"rgba("+seriesColors[e][0]+","+seriesColors[e][1]+","+seriesColors[e][2]+")"}function updateServerTimelineStats(){if(null!=serverTimelineStats){var e=Q("p40type").value,t=pastDate(Q("p40time").value),n=[],o=null,i=!1,s=!0;if(null!=Q("p40server").value&&(""==(o=decodeURIComponent(Q("p40server").value))&&(o=null),s=!1),serverTimelineConfig.options.scales.x.min=t,serverTimelineConfig.options.scales.y.stacked=3==e||4==e,0==e){serverTimelineConfig.options.scales.y.title.text="連接數量";for(var a={labels:[pastDate(0),t],datasets:[{label:"代理",data:[],backgroundColor:"rgba(158, 151, 16, .1)",borderColor:"rgb(158, 151, 16)",fill:!0},{label:"用戶",data:[],backgroundColor:"rgba(16, 84, 158, .1)",borderColor:"rgb(16, 84, 158)",fill:!0},{label:"用戶節",data:[],backgroundColor:"rgba(255, 99, 132, .1)",borderColor:"rgb(255, 99, 132)",fill:!0},{label:"中繼連接",data:[],backgroundColor:"rgba(39, 158, 16, .1)",borderColor:"rgb(39, 158, 16)",fill:!0},{label:"英特爾AMT",data:[],backgroundColor:"rgba(134, 16, 158, .1)",borderColor:"rgb(134, 16, 158)",fill:!0}]},l=0;l<serverTimelineStats.length;l++){new Date(serverTimelineStats[l].time);null!=serverTimelineStats[l].s&&-1==n.indexOf(serverTimelineStats[l].s)&&(n.push(serverTimelineStats[l].s),s)&&(o=serverTimelineStats[l].s,s=!1),null==serverTimelineStats[l].s&&(i=!0),serverTimelineStats[l].s==o&&(1==serverTimelineStats[l].first&&(a.datasets[0].data.push({x:serverTimelineStats[l].time-1,y:NaN}),a.datasets[1].data.push({x:serverTimelineStats[l].time-1,y:NaN}),a.datasets[2].data.push({x:serverTimelineStats[l].time-1,y:NaN}),a.datasets[3].data.push({x:serverTimelineStats[l].time-1,y:NaN}),a.datasets[4].data.push({x:serverTimelineStats[l].time-1,y:NaN})),serverTimelineStats[l].conn&&(a.datasets[0].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].conn.ca}),a.datasets[1].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].conn.cu}),a.datasets[2].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].conn.us}),a.datasets[3].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].conn.rs}),null!=serverTimelineStats[l].conn.am))&&a.datasets[4].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].conn.am})}}else if(1==e){serverTimelineConfig.options.scales.y.title.text="Megabyte",a={labels:[pastDate(0),t],datasets:[{label:"外部",data:[],backgroundColor:"rgba(158, 151, 16, .1)",borderColor:"rgb(158, 151, 16)",fill:!0},{label:"堆使用",data:[],backgroundColor:"rgba(16, 84, 158, .1)",borderColor:"rgb(16, 84, 158)",fill:!0},{label:"堆總數",data:[],backgroundColor:"rgba(255, 99, 132, .1)",borderColor:"rgb(255, 99, 132)",fill:!0},{label:"RSS",data:[],backgroundColor:"rgba(39, 158, 16, .1)",borderColor:"rgb(39, 158, 16)",fill:!0}]};for(l=0;l<serverTimelineStats.length;l++)null!=serverTimelineStats[l].s&&-1==n.indexOf(serverTimelineStats[l].s)&&(n.push(serverTimelineStats[l].s),s)&&(o=serverTimelineStats[l].s,s=!1),null==serverTimelineStats[l].s&&(i=!0),serverTimelineStats[l].s==o&&(1==serverTimelineStats[l].first&&(a.datasets[0].data.push({x:serverTimelineStats[l].time-1,y:NaN}),a.datasets[1].data.push({x:serverTimelineStats[l].time-1,y:NaN}),a.datasets[2].data.push({x:serverTimelineStats[l].time-1,y:NaN}),a.datasets[3].data.push({x:serverTimelineStats[l].time-1,y:NaN})),a.datasets[0].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].mem.external/1048576}),a.datasets[1].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].mem.heapUsed/1048576}),a.datasets[2].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].mem.heapTotal/1048576}),a.datasets[3].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].mem.rss/1048576}))}else if(3==e||4==e){serverTimelineConfig.options.scales.y.title.text="Megabyte",a={labels:[pastDate(0),t],datasets:[]};for(var r=0,l=0;l<serverTimelineStats.length;l++)null!=serverTimelineStats[l].traffic&&(null!=serverTimelineStats[l].s&&-1==n.indexOf(serverTimelineStats[l].s)&&(n.push(serverTimelineStats[l].s),s)&&(o=serverTimelineStats[l].s,s=!1),null==serverTimelineStats[l].s&&(i=!0),serverTimelineStats[l].s==o)&&serverTimelineStats[l].traffic&&(0<serverTimelineStats[l].traffic.AgentCtrlIn&&(r|=1),0<serverTimelineStats[l].traffic.CIRAIn&&(r|=2),0<serverTimelineStats[l].traffic.LMSIn&&(r|=4),0<serverTimelineStats[l].traffic.httpIn&&(r|=8),serverTimelineStats[l].traffic.relayIn&&(0<serverTimelineStats[l].traffic.relayIn[0]&&(r|=16),0<serverTimelineStats[l].traffic.relayIn[1]&&(r|=32),0<serverTimelineStats[l].traffic.relayIn[2]&&(r|=64),0<serverTimelineStats[l].traffic.relayIn[5]&&(r|=128),0<serverTimelineStats[l].traffic.relayIn[10]&&(r|=256),0<serverTimelineStats[l].traffic.relayIn[11]&&(r|=512),0<serverTimelineStats[l].traffic.relayIn[12])&&(r|=1024),serverTimelineStats[l].traffic.desktopMultiplex)&&0<serverTimelineStats[l].traffic.desktopMultiplex.in&&(r|=2048);for(l=0;l<13;l++)r&1<<l&&a.datasets.push({label:trafficSeriesNames[l],data:[],backgroundColor:seriesColor1(l),borderColor:seriesColor2(l),fill:!0,steppedLine:!0});for(l=0;l<serverTimelineStats.length;l++)if(null!=serverTimelineStats[l].traffic&&(null!=serverTimelineStats[l].s&&-1==n.indexOf(serverTimelineStats[l].s)&&(n.push(serverTimelineStats[l].s),s)&&(o=serverTimelineStats[l].s,s=!1),null==serverTimelineStats[l].s&&(i=!0),serverTimelineStats[l].s==o)){if(1==serverTimelineStats[l].first)for(var d=1;d<61440;d<<=1)r&d&&a.datasets[0].data.push({x:serverTimelineStats[l].time-1,y:NaN});var c=0;3==e?(1&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.AgentCtrlIn?serverTimelineStats[l].traffic.AgentCtrlIn/1048576:0}),2&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.CIRAIn?serverTimelineStats[l].traffic.CIRAIn/1048576:0}),4&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.LMSIn?serverTimelineStats[l].traffic.LMSIn/1048576:0}),8&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.httpIn?serverTimelineStats[l].traffic.httpIn/1048576:0}),16&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.relayIn&&serverTimelineStats[l].traffic.relayIn[0]?serverTimelineStats[l].traffic.relayIn[0]/1048576:0}),32&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.relayIn&&serverTimelineStats[l].traffic.relayIn[1]?serverTimelineStats[l].traffic.relayIn[1]/1048576:0}),64&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.relayIn&&serverTimelineStats[l].traffic.relayIn[2]?serverTimelineStats[l].traffic.relayIn[2]/1048576:0}),128&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.relayIn&&serverTimelineStats[l].traffic.relayIn[5]?serverTimelineStats[l].traffic.relayIn[5]/1048576:0}),256&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.relayIn&&serverTimelineStats[l].traffic.relayIn[10]?serverTimelineStats[l].traffic.relayIn[10]/1048576:0}),512&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.relayIn&&serverTimelineStats[l].traffic.relayIn[11]?serverTimelineStats[l].traffic.relayIn[11]/1048576:0}),1024&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.relayIn&&serverTimelineStats[l].traffic.relayIn[12]?serverTimelineStats[l].traffic.relayIn[12]/1048576:0}),2048&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.desktopMultiplex&&serverTimelineStats[l].traffic.desktopMultiplex.in?serverTimelineStats[l].traffic.desktopMultiplex.in/1048576:0})):4==e&&(1&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.AgentCtrlOut?serverTimelineStats[l].traffic.AgentCtrlOut/1048576:0}),2&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.CIRAOut?serverTimelineStats[l].traffic.CIRAOut/1048576:0}),4&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.LMSOut?serverTimelineStats[l].traffic.LMSOut/1048576:0}),8&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.httpOut?serverTimelineStats[l].traffic.httpOut/1048576:0}),16&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.relayOut&&serverTimelineStats[l].traffic.relayOut[0]?serverTimelineStats[l].traffic.relayOut[0]/1048576:0}),32&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.relayOut&&serverTimelineStats[l].traffic.relayOut[1]?serverTimelineStats[l].traffic.relayOut[1]/1048576:0}),64&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.relayOut&&serverTimelineStats[l].traffic.relayOut[2]?serverTimelineStats[l].traffic.relayOut[2]/1048576:0}),128&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.relayOut&&serverTimelineStats[l].traffic.relayOut[5]?serverTimelineStats[l].traffic.relayOut[5]/1048576:0}),256&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.relayOut&&serverTimelineStats[l].traffic.relayOut[10]?serverTimelineStats[l].traffic.relayOut[10]/1048576:0}),512&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.relayOut&&serverTimelineStats[l].traffic.relayOut[11]?serverTimelineStats[l].traffic.relayOut[11]/1048576:0}),1024&r&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.relayOut&&serverTimelineStats[l].traffic.relayOut[12]?serverTimelineStats[l].traffic.relayOut[12]/1048576:0}),2048&r)&&a.datasets[c++].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].traffic.desktopMultiplex&&serverTimelineStats[l].traffic.desktopMultiplex.out?serverTimelineStats[l].traffic.desktopMultiplex.out/1048576:0})}}else if(5==e){serverTimelineConfig.options.scales.y.title.text="用法",a={labels:[pastDate(0),t],datasets:[{label:"CPU",data:[],backgroundColor:"rgba(158, 151, 16, .1)",borderColor:"rgb(158, 151, 16)",fill:!0}]};for(l=0;l<serverTimelineStats.length;l++)"object"==typeof serverTimelineStats[l].cpu&&"number"==typeof serverTimelineStats[l].cpu[0]&&(null!=serverTimelineStats[l].s&&-1==n.indexOf(serverTimelineStats[l].s)&&(n.push(serverTimelineStats[l].s),s)&&(o=serverTimelineStats[l].s,s=!1),null==serverTimelineStats[l].s&&(i=!0),serverTimelineStats[l].s==o)&&(1==serverTimelineStats[l].first&&a.datasets[0].data.push({x:serverTimelineStats[l].time-1,y:NaN}),a.datasets[0].data.push({x:serverTimelineStats[l].time,y:serverTimelineStats[l].cpu[0]}))}if(serverTimelineConfig.data=a,window.serverMainStats.update(),0<n.length){for(var u="",l=0;l<n.length;l++)u+='<option value="'+encodeURIComponentEx(n[l])+'"'+(o==n[l]?" selected":"")+">"+EscapeHtml(n[l])+"</option>";i&&(u+='<option value=""'+(null==o?" selected":"")+">無效的</option>"),QH("p40server",u)}QV("p40server",0<n.length)}}function p40downloadEvents(){for(var e="time, conn.agent, conn.users, conn.usersessions, conn.relaysession, conn.intelamt, mem.external, mem.heapused, mem.heaptotal, mem.rss\r\n",t=0;t<serverTimelineStats.length;t++)serverTimelineStats[t].conn&&serverTimelineStats[t].mem&&(e+=new Date(serverTimelineStats[t].time)+", "+serverTimelineStats[t].conn.ca+", "+serverTimelineStats[t].conn.cu+", "+serverTimelineStats[t].conn.us+", "+serverTimelineStats[t].conn.rs+", "+(serverTimelineStats[t].conn.am||"")+", "+serverTimelineStats[t].mem.external+", "+serverTimelineStats[t].mem.heapUsed+", "+serverTimelineStats[t].mem.heapTotal+", "+serverTimelineStats[t].mem.rss+"\r\n");saveAs(stringToUtf8Blob(e),"ServerStats.csv")}var xxdialogMode,xxdialogFunc,xxdialogButtons,xxdialogTag,serverTrace=[],serverTraceSources=[];function displayServerTrace(){var e,t="",n=parseInt(Q("p41limitdropdown").value);for(e in serverTrace.length>n&&serverTrace.splice(n),serverTrace){var o,i=[];for(o in serverTrace[e].args)"object"==typeof serverTrace[e].args[o]?i.push(JSON.stringify(serverTrace[e].args[o])):i.push(serverTrace[e].args[o]);t+="<div class=traceEvent onclick=showTraceEvent("+e+")>"+EscapeHtml(new Date(serverTrace[e].time).toLocaleTimeString())+" - <b>"+EscapeHtml(serverTrace[e].source.toUpperCase())+"</b>: "+EscapeHtml(i.join(", "))+"</div>"}QH("p41events",t)}function showTraceEvent(e){var t=serverTrace[e],n="";if(!xxdialogMode&&null!=t){for(var e in t.args)"object"==typeof t.args[e]?n+=EscapeHtml(JSON.stringify(t.args[e]))+"<br /><br />":n+=EscapeHtml(t.args[e])+"<br /><br />";xxdialogButtons=1,setModalContent("xxAddAgent","服務器跟踪事件","<div class=selecttext style=max-height:300px;overflow-y:auto>"+n+"</div>"),showModal("xxAddAgentModal","idx_dlgOkButton",null)}}function clearServerTracing(){serverTrace=[],displayServerTrace()}function setServerTracing(){var e='<div style="max-height:200px;overflow-y:auto">';setModalContent("xxAddAgent","伺服器追蹤",(e+='<div style="width:100%;border-bottom:1px solid gray;margin-bottom:5px;margin-top:5px"><b>核心伺服器</b></div>')+('<div><label><input type=checkbox class="form-check-input me-2" id=p41c1 '+(0<=serverTraceSources.indexOf("cookie")?"checked":"")+">Cookie編碼器</label></div>")+('<div><label><input type=checkbox class="form-check-input me-2" id=p41c2 '+(0<=serverTraceSources.indexOf("dispatch")?"checked":"")+">電郵調度器</label></div>")+('<div><label><input type=checkbox class="form-check-input me-2" id=p41c3 '+(0<=serverTraceSources.indexOf("main")?"checked":"")+">主伺服器訊息</label></div>")+('<div><label><input type=checkbox class="form-check-input me-2" id=p41c4 '+(0<=serverTraceSources.indexOf("peer")?"checked":"")+">MeshCentral伺服器同級化</label></div>")+('<div><label><input type=checkbox class="form-check-input me-2" id=p41c15 '+(0<=serverTraceSources.indexOf("agent")?"checked":"")+">MeshAgent流量</label></div>")+('<div><label><input type=checkbox class="form-check-input me-2" id=p41c14 '+(0<=serverTraceSources.indexOf("agentupdate")?"checked":"")+">MeshAgent更新</label></div>")+('<div><label><input type=checkbox class="form-check-input me-2" id=p41c16 '+(0<=serverTraceSources.indexOf("cert")?"checked":"")+">伺服器憑證</label></div>")+('<div><label><input type=checkbox class="form-check-input me-2" id=p41c17 '+(0<=serverTraceSources.indexOf("db")?"checked":"")+">伺服器數據庫</label></div>")+('<div><label><input type=checkbox class="form-check-input me-2" id=p41c18 '+(0<=serverTraceSources.indexOf("email")?"checked":"")+">電子郵件/短信/推送流量</label></div>")+'<div style="width:100%;border-bottom:1px solid gray;margin-bottom:5px;margin-top:5px"><b>網絡伺服器</b></div>'+('<div><label><input type=checkbox class="form-check-input me-2" id=p41c5 '+(0<=serverTraceSources.indexOf("web")?"checked":"")+">網絡伺服器</label></div>")+('<div><label><input type=checkbox class="form-check-input me-2" id=p41c6 '+(0<=serverTraceSources.indexOf("webrequest")?"checked":"")+">Web伺服器請求</label></div>")+('<div><label><input type=checkbox class="form-check-input me-2" id=p41c7 '+(0<=serverTraceSources.indexOf("relay")?"checked":"")+">Web插座中繼</label></div>")+('<div><label><input type=checkbox class="form-check-input me-2" id=p41c20 '+(0<=serverTraceSources.indexOf("httpheaders")?"checked":"")+">Web 服務器 HTTP 標頭</label></div>")+('<div><label><input type=checkbox class="form-check-input me-2" id=p41c21 '+(0<=serverTraceSources.indexOf("authlog")?"checked":"")+">User Authentication Log</label></div>")+'<div style="width:100%;border-bottom:1px solid gray;margin-bottom:5px;margin-top:5px"><b>Intel&reg; AMT</b></div>'+('<div><label><input type=checkbox class="form-check-input me-2" id=p41c19 '+(0<=serverTraceSources.indexOf("amt")?"checked":"")+">英特爾 AMT 經理</label></div>")+('<div><label><input type=checkbox class="form-check-input me-2" id=p41c9 '+(0<=serverTraceSources.indexOf("webrelay")?"checked":"")+">連接轉發器</label></div>")+('<div><label><input type=checkbox class="form-check-input me-2" id=p41c10 '+(0<=serverTraceSources.indexOf("mps")?"checked":"")+">CIRA伺服器</label></div>")+('<div><label><input type=checkbox class="form-check-input me-2" id=p41c11 '+(0<=serverTraceSources.indexOf("mpscmd")?"checked":"")+">CIRA伺服器指令</label></div>")+"</div>"),showModal("xxAddAgentModal","idx_dlgOkButton",setServerTracingEx)}function setServerTracingEx(){for(var e=[],t=["cookie","dispatch","main","peer","web","webrequest","relay","webrelaydata","webrelay","mps","mpscmd","swarm","swarmcmd","agentupdate","agent","cert","db","email","amt","httpheaders","authlog"],n=1;n<22;n++)try{Q("p41c"+n).checked&&e.push(t[n-1])}catch(e){}meshserver.send({action:"traceinfo",traceSources:e})}function p41downloadServerTrace(){var e,t="時間，來源，訊息\r\n";for(e in serverTrace)t+='"'+new Date(serverTrace[e].time).toLocaleTimeString()+'","'+serverTrace[e].source+'","'+serverTrace[e].args.join(", ")+'"\r\n';return saveAs(stringToUtf8Blob(t),"servertrace.csv"),!1}function setupServiceWorker(){0!=(8&features2)&&"string"==typeof serverinfo.vapidpublickey&&null!=Notification&&"granted"==Notification.permission&&"serviceWorker"in navigator&&navigator.serviceWorker.register("serviceworker.js").then(function(e){navigator.serviceWorker.ready.then(function(e){e.pushManager.subscribe({applicationServerKey:urlBase64ToUint8Array(serverinfo.vapidpublickey),userVisibleOnly:!0}).then(function(e){meshserver.send({action:"webpush",sub:e})}).catch(function(e){console.error("Worker: Unable to subscribe to push",e)})})}).catch(function(e){console.log("Worker: Registration failed",e)})}var xxcurrentView=-1;function setDialogMode(e,t,n,o,i,s){setSessionActivity(),QV("uiMenu",!1),xxdialogMode=e,xxdialogFunc=o,xxdialogButtons=n,xxdialogTag=s,QV("id_dialogclose",2&n||8&n),QV("idx_dlgDeleteButton",4&n),QV("idx_dlgButtonBar",7&n),QV("idx_dlgMoreButtons",16&n),t&&QH("xxAddAgentTitle",t);for(var a=1;a<24;a++)QV("dialog"+a,a==e);QV("dialog",e),i&&(2==e?QH("id_dialogOptions",i):QH("id_dialogMessage",i)),0==e&&xxModal&&xxModal.hide(),MoreToggle(!1)}function dialogclose(e){setSessionActivity(),(8&xxdialogButtons||e)&&xxdialogFunc&&xxdialogFunc(e,xxdialogTag)}function center(){setSessionActivity(),11==xxcurrentView?deskAdjust():10==xxcurrentView?mainUpdate(256):1==xxcurrentView&&mainUpdate(4)}function messagebox(e,t){setSessionActivity(),QH("id_dialogMessage",t),setDialogMode(1,e,1)}function statusbox(e,t){setSessionActivity(),QH("id_dialogMessage",t),setDialogMode(1,e)}var backStack=[];function goBack(){setSessionActivity(),xxdialogMode||0==goBackStack.length||(fullscreen&&deskToggleFull(),go(goBackStack.pop()),goBackStack.pop())}function goForward(e){xxdialogMode||(backStack.push(e),goStack())}function goStack(){if(0==backStack.length)go(2);else{var e=backStack[backStack.length-1],t=e.split("/")[0];if("node"==t&&(setupDeviceMenu(0),gotoDevice(e)),"mesh"==t&&gotoMesh(e),"devices"==t&&go(1),"account"==t&&go(2),"events"==t&&go(3),"users"==t&&go(4),"files"==t){if(262144&features&&!(1==userinfo.otpsecret||0<userinfo.otphkeys||0<userinfo.otpkeys||8388608&features&&1==userinfo.otpekey))return void setDialogMode(2,"帳號安全",1,null,'Unable to access this feature until two-factor authentication is enabled. This is required for extra security. Go to the "My Account" and look at the "Account Security" section.');go(5)}"server"==t&&go(6)}}function go(e,t){if((!t||3!=t.which&&2!=t.button)&&(262144&features&&0==count2factoraAuths()&&2<e&&(e=2,setModalContent("xxAddAgent","帳號安全",'Unable to access this feature until two - factor authentication is enabled.This is required for extra security.Go to the "My Account" tab and look at the "Account Security" section.'),showModal("xxAddAgentModal","idx_dlgOkButton")),null!=pluginHandler&&pluginHandler.callHook("goPageStart",e,t),setSessionActivity(),!xxdialogMode))if(QV("uiMenu",!1),!t||1!=t.shiftKey&&2!=t.which&&1!=t.button||15==e||""!="{{{currentNode}}}".toLowerCase()){if(xxcurrentView!=e){xxcurrentView<0||e<10?goBackStack=[]:50!=xxcurrentView&&Math.floor(xxcurrentView/10)==Math.floor(e/10)||goBackStack.push(xxcurrentView),11==xxcurrentView&&null!=desktop&&null!=desktop.m.recordedData&&deskRecordSession(),(4==e&&null!=userinfo&&0==(2&userinfo.siteadmin)||0!=(4&features))&&(e=52),17==xxcurrentView&&deviceDetailsStatsClear();for(var n=0;n<61;n++)QV("p"+n,n==e);if(xxcurrentView=e,fullscreen&&deskToggleFull(),0==(268435456&features)&&0<xxcurrentView){var o="";for(n in 10<=xxcurrentView&&xxcurrentView<=19?null!=currentNode&&(o="?viewmode="+xxcurrentView+"&gotonode="+currentNode._id.split("/")[2]):20<=xxcurrentView&&xxcurrentView<=29?null!=currentMesh&&(o="?viewmode="+xxcurrentView+"&gotomesh="+currentMesh._id.split("/")[2]):30<=xxcurrentView&&xxcurrentView<=39?null!=currentUser&&(o="?viewmode="+xxcurrentView+"&gotouser="+(serverinfo.crossDomain?currentUser._id:currentUser._id.split("/")[2])):51<=xxcurrentView&&xxcurrentView<=51?null!=currentUserGroup&&null!=currentUserGroup._id&&(o="?viewmode="+xxcurrentView+"&gotougrp="+(serverinfo.crossDomain?currentUserGroup._id:currentUserGroup._id.split("/")[2])):1<xxcurrentView&&(o="?viewmode="+xxcurrentView),urlargs)o+=(""==o?"?":"&")+n+"="+urlargs[n];try{window.history.replaceState({},document.title,window.location.pathname+o)}catch(e){}}var i=["MainMenuMyDevices","MainMenuMyAccount","MainMenuMyEvents","MainMenuMyFiles","MainMenuMyUsers","MainMenuMyServer"];for(n in i)QC(i[n]).remove("fullselect"),QC(i[n]).remove("semiselect");var s=["LeftMenuMyDevices","LeftMenuMyAccount","LeftMenuMyEvents","LeftMenuMyFiles","LeftMenuMyUsers","LeftMenuMyServer"];for(n in s)QC(s[n]).remove("lbbuttonsel"),QC(s[n]).remove("lbbuttonsel2");var a=e<9?"fullselect":"semiselect",l=e<9||115==e||40==e||41==e||42==e?"lbbuttonsel2":"lbbuttonsel",r=0,d=(0<goBackStack.length&&(r=goBackStack[goBackStack.length-1]),1==e||1==r||0==r&&10<=e&&e<20?(QC("MainMenuMyDevices").add(a),QC("LeftMenuMyDevices").add(l)):2==e||2==r||0==r&&20<=e&&e<30?(QC("MainMenuMyAccount").add(a),QC("LeftMenuMyAccount").add(l)):3==e||60==e?(QC("MainMenuMyEvents").add(a),QC("LeftMenuMyEvents").add(l)):4==e||30<=e&&e<40||50==e||51==e||52==e?(QC("MainMenuMyUsers").add(a),QC("LeftMenuMyUsers").add(l)):5==e?(QC("MainMenuMyFiles").add(a),QC("LeftMenuMyFiles").add(l)):(6==e||115==e||40<=e&&e<50)&&(QC("MainMenuMyServer").add(a),QC("LeftMenuMyServer").add(l)),QV("ServerPlugins",null!=pluginHandler),webPageStackMenu&&10<=e?QC("column_l").add("room4submenu"):QC("column_l").remove("room4submenu"),QV("topbar",0!=e),0==e&&webPageFullScreen&&QC("body").add("arg_hide"),QV("MainSubMenuSpan",10<=e&&e<20),QV("UserDummyMenuSpan",51==e||e<10&&6!=e&&webPageFullScreen),QV("MeshSubMenuSpan",20<=e&&e<30),QV("UserSubMenuSpan",30<=e&&e<40),QV("ServerSubMenuSpan",6==e||115==e||40==e||41==e||42==e||43==e),QV("UsersSubMenuSpan",4==e||50==e||52==e),QV("EventsSubMenuSpan",3==e||60==e),{3:"EventsLive",4:"UsersGeneral",10:"MainDev",11:"MainDevDesktop",12:"MainDevTerminal",13:"MainDevFiles",14:"MainDevAmt",15:"MainDevConsole",16:"MainDevEvents",17:"MainDevInfo",19:"MainDevPlugins",20:"MeshGeneral",21:"MeshSummary",30:"UserGeneral",31:"UserEvents",6:"ServerGeneral",40:"ServerStats",41:"ServerTrace",42:"ServerPlugins",50:"UsersGroups",52:"UsersRecordings",60:"EventsReport",115:"ServerConsole"});for(n in d)QC(d[n]).remove("style3x"),QC(d[n]).remove("style3sel"),QC(d[n]).add(e==n?"style3sel":"style3x");11==e&&deskAdjust(),115==e&&QV("p15",!0),QV("p15uploadCore",115!=e),QV("p15BackButton",115!=e&&0==(32&args.hide)&&""=="{{currentNode}}".toLowerCase()),15!=e&&115!=e||setupConsole(),1==e&&mainUpdate(4),2==e&&Notification&&QV("accountEnableNotificationsSpan","granted"!=Notification.permission),40==e&&null==serverTimelineStats&&refreshServerTimelineStats(),42==e&&refreshPluginLatest(),21==e&&p21updateMesh(),52==e&&(null==p52recordings&&refreshRecodings(),updateRecordings()),12==e&&null!=xtermfit&&(xtermfit.fit(),xterm.focus()),document.title=currentNode&&10<=e&&e<20?currentNode.name+(meshes[currentNode.meshid]?" - "+meshes[currentNode.meshid].name:"")+" - "+decodeURIComponent("{{{extitle}}}"):decodeURIComponent("{{{extitle}}}"),null!=pluginHandler&&pluginHandler.callHook("goPageEnd",e,t),QS("column_l").overflow=0<=[11,12].indexOf(e)?"hidden":null}}else 10<=e&&e<=19?currentNode&&safeNewWindow(window.location.origin+"{{{domainurl}}}?gotonode="+currentNode._id.split("/")[2]+"&viewmode="+e+"&hide=16"+(urlargs.key?"&key="+urlargs.key:""),"meshcentral:"+currentNode._id):20<=e&&e<=29?currentMesh&&safeNewWindow(window.location.origin+"{{{domainurl}}}?gotomesh="+currentMesh._id.split("/")[2]+"&viewmode="+e+"&hide=16"+(urlargs.key?"&key="+urlargs.key:""),"meshcentral:"+currentMesh._id):30<=e&&e<=39?currentUser&&safeNewWindow(window.location.origin+"{{{domainurl}}}?gotouser="+(serverinfo.crossDomain?currentUser._id:currentUser._id.split("/")[2])+"&viewmode="+e+"&hide=16"+(urlargs.key?"&key="+urlargs.key:""),"meshcentral:"+currentUser._id):50<=e&&e<=59?currentUserGroup&&safeNewWindow(window.location.origin+"{{{domainurl}}}?gotougrp="+(serverinfo.crossDomain?currentUserGroup._id:currentUserGroup._id.split("/")[2])+"&viewmode="+e+"&hide=16"+(urlargs.key?"&key="+urlargs.key:""),"meshcentral:"+currentUserGroup._id):safeNewWindow(window.location.origin+"{{{domainurl}}}?viewmode="+e+"&hide=0"+(urlargs.key?"&key="+urlargs.key:""),"meshcentral:"+e)}function updatePluginList(e){if(null!=pluginHandler){if(Array.isArray(e)&&e.forEach(function(e){updatePluginList(e)}),QV("pluginNoneNotice",0==installedPluginList.length),installedPluginList.length){if(null!=e&&(null==installedPluginList.version_info&&(installedPluginList.version_info=[]),installedPluginList.version_info[e.id]=e),(n=Q("p42tbl").querySelectorAll(".p42tblRow")).length)for(var t in Object.values(n))n[t].parentNode.removeChild(n[t]);var a={0:{text:"Disabled",color:"858483"},1:{text:"Installed",color:"00aa00"}},l={0:{install:"Install",delete:"Delete"},1:{disable:"Disable",upgrade:"Upgrade"}},r=Q("p42tbl");installedPluginList.forEach(function(e){var t,n=[],o=(1==e.hasAdminPanel&&e.status?e.nameHtml="<a onclick=\"return goPlugin('"+e.shortName+"', '"+e.name.replace(/'/g,"\\'")+"');\">"+EscapeHtml(e.name)+"</a>":e.nameHtml=EscapeHtml(e.name),e.statusText=a[e.status].text,e.statusColor=a[e.status].color,null==e.versionHistoryUrl&&n.push("downgrade"),e.status||(e.version=" - "),e.upgradeAvail="檢查...",null!=installedPluginList.version_info&&null!=installedPluginList.version_info[e._id]&&(!(i=installedPluginList.version_info[e._id]).hasUpdate&&(n.push("upgrade"),e.status)?e.upgradeAvail="最新":e.upgradeAvail='<a title="查看變更日誌" rel="noreferrer noopener" target="_blank" href="'+i.changelogUrl+'">'+i.version+"</a>",i.meshCentralCompat||(e.upgradeAvail+=" [ <span onclick=\"return setModalContent('xxAddAgent', 'Compatibility Issue', 'This plugin version is not compatible with your MeshCentral installation, please upgrade MeshCentral first.');showModal('xxAddAgentModal', 'idx_dlgOkButton');\" title=\"版本不兼容，請先升級你的MeshCentral\" style=\"cursor: pointer; color:red;\"> ! </span> ]",n.push("install"),n.push("upgrade"))),e.actions="<select onchange=\"return pluginAction(this,'"+e._id+'\');"><option value=""> --</option>',Object.entries(l[e.status]));for(t in o)-1===n.indexOf(o[t][0])&&(e.actions+='<option value="'+o[t][0]+'">'+o[t][1]+"</option>");e.actions+="</select>";var i="<td><img style=margin-top:3px src=images/plugin24.png></td><td class=gradTable1>&nbsp;</td><td class=gradTable2>"+e.nameHtml+"</td><td class=gradTable2>"+EscapeHtml(e.description)+'</td><td class=gradTable2 style=text-align:center><a href="'+EscapeHtml(e.homepage)+'" rel="noreferrer noopener" target="_blank">Home</a></td><td class=gradTable2 style=text-align:center>'+EscapeHtml(e.version)+'</td><td style=text-align:center class="pluginUpgradeAvailable gradTable2">'+e.upgradeAvail+'</td><td class=gradTable2 style="text-align:center;color:#'+e.statusColor+'">'+e.statusText+'</td><td class="pluginAction gradTable2" style=text-align:center>'+e.actions+"</td><td class=gradTable3>&nbsp;</td>",s=r.insertRow(-1);s.innerHTML=i,s.classList.add("p42tblRow"),s.setAttribute("data-id",e._id),s.setAttribute("id","pluginRow-"+e._id)})}else{var n=Q("p42tbl").querySelectorAll(".p42tblRow");for(t in Object.values(n))n[t].parentNode.removeChild(n[t])}null==e&&refreshPluginLatest()}}function refreshPluginLatest(){null!=pluginHandler&&meshserver.send({action:"pluginLatestCheck"})}function distributeCore(){null!=pluginHandler&&(meshserver.send({action:"distributeCore",nodes:nodes}),QV("pluginRestartNotice",!1))}function pluginActionEx(){if(null!=pluginHandler){var e=Q("lastPluginAct").value,t=Q("lastPluginId").value,n=Q("lastPluginVersion").value;switch(e){case"upgrade":case"install":meshserver.send({action:"installplugin",id:t,version_only:!1});break;case"downgrade":Q("lastPluginVersion").querySelectorAll("option").forEach(function(e){e.value==n&&(pVers=e.text)}),meshserver.send({action:"installplugin",id:t,version_only:{name:pVers,url:n}});break;case"delete":meshserver.send({action:"removeplugin",id:t});break;case"disable":meshserver.send({action:"disableplugin",id:t})}QV("pluginRestartNotice",!0)}}function pluginAction(e,t){if(null!=pluginHandler){if("downgrade"==e.value)meshserver.send({action:"getpluginversions",id:t});else{var n,o=null;for(n in installedPluginList)installedPluginList[n]._id==t&&(o=installedPluginList[n]);setModalContent("xxAddAgent","外掛指令",format("你確定要{0}外掛嗎：{1}",e.value,o.name)+'<input id="lastPluginAct" type="hidden" value="'+e.value+'" /><input id="lastPluginId" type="hidden" value="'+t+'" /><input id="lastPluginVersion" type="hidden" value="" />'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>pluginActionEx())}e.value=""}}function goPlugin(e,t){null!=pluginHandler&&(null==e?Q("p43iframe").src="":(QH("p43title",t),Q("p43iframe").src="/pluginadmin.ashx?pin="+e,go(43)))}function removeUserRights(e,t){var n;return t==userinfo._id&&null!=userinfo.removeRights&&((n=t=0)!=(8&userinfo.removeRights)&&(n+=8),0!=(65536&userinfo.removeRights)&&(t+=65536),0!=(256&userinfo.removeRights)&&(t+=256),0!=(512&userinfo.removeRights)&&(t+=512),0!=(1024&userinfo.removeRights)&&(t+=1024),0!=(16&userinfo.removeRights)&&(n+=16),0!=(32768&userinfo.removeRights)&&(n+=32768),0!=(131072&userinfo.removeRights)&&(n+=131072),0!=(64&userinfo.removeRights)&&(n+=64),0!=(262144&userinfo.removeRights)&&(n+=262144),e=4294967295!=e?(e|t)&4294967295-n:((e=2015471)|t)&4294967295-n),e}function GetMeshRights(e,t){if(null==e)return 0;if(null==t&&(t=userinfo._id),null==(e="string"==typeof e?meshes[e]:e)||null==e.links)return 0;if(serverinfo.manageAllDeviceGroups&&t==userinfo._id)return removeUserRights(4294967295,t);var n=0,o=e.links[t];if(null!=o){if(4294967295==o.rights)return removeUserRights(4294967295,t);n=o.rights}var i=null;if(t==userinfo._id?i=userinfo:null!=users&&(i=users[t]),null!=i)for(var s in i.links)if(s.startsWith("ugrp/")&&null!=(o=e.links[s])){if(4294967295==o.rights)return removeUserRights(4294967295,t);n|=o.rights}return removeUserRights(n,t)}function IsMeshViewable(e,t){if(null!=e&&(null==t&&(t=userinfo._id),null!=(e="string"==typeof e?meshes[e]:e))&&null!=e.links){if(null!=e.links[t])return!0;if(serverinfo.manageAllDeviceGroups&&t==userinfo._id)return!0;var n=null;if(t==userinfo._id?n=userinfo:null!=users&&(n=users[t]),null!=n)for(var o in n.links)if(o.startsWith("ugrp/")&&null!=e.links[o])return!0}return!1}function GetNodeRights(e,t){if(null==e)return 0;if(null==t&&(t=userinfo._id),"string"==typeof e&&null==(e=getNodeFromId(e)))return 0;var n=GetMeshRights(e.meshid,t);if(4294967295!=n&&(null!=e.links&&null!=e.links[t]&&(n|=e.links[t].rights),null!=e.links)&&null!=userinfo.links)for(var o in e.links)o.startsWith("ugrp/")&&null!=userinfo.links[o]&&null!=e.links[o].rights&&(n|=e.links[o].rights);return removeUserRights(n,t)}function IsNodeViewable(e,t){if(null!=e&&(null==t&&(t=userinfo._id),"string"!=typeof e||null!=(e=getNodeFromId(e)))){if(IsMeshViewable(e.meshid,t))return!0;if(null!=e.links&&null!=e.links[t])return!0;if(null!=e.links&&null!=userinfo.links)for(var n in e.links)if(n.startsWith("ugrp/")&&null!=userinfo.links[n]&&null!=e.links[n].rights)return!0}return!1}if("undefined"==typeof TextEncoder){window.TextEncoder=function(){},TextEncoder.prototype.encode=function(e){for(var t,n=e.length,o=-1,i="undefined"==typeof Uint8Array?new Array(1.5*n):new Uint8Array(3*n),s=0,a=0;a!==n;){if(s=e.charCodeAt(a),a+=1,55296<=s&&s<=56319){if(a===n){i[o+=1]=239,i[o+=1]=191,i[o+=1]=189;break}if(!(56320<=(t=e.charCodeAt(a))&&t<=57343)){i[o+=1]=239,i[o+=1]=191,i[o+=1]=189;continue}if(a+=1,65535<(s=1024*(s-55296)+t-56320+65536)){i[o+=1]=240|s>>>18,i[o+=1]=128|s>>>12&63,i[o+=1]=128|s>>>6&63,i[o+=1]=128|63&s;continue}}s<=127?i[o+=1]=0|s:(s<=2047?i[o+=1]=192|s>>>6:(i[o+=1]=224|s>>>12,i[o+=1]=128|s>>>6&63),i[o+=1]=128|63&s)}return"undefined"!=typeof Uint8Array?i.subarray(0,o+1):(i.length=o+1,i)},TextEncoder.prototype.toString=function(){return"[object TextEncoder]"};try{Object.defineProperty(TextEncoder.prototype,"encoding",{get:function(){if(TextEncoder.prototype.isPrototypeOf(this))return"utf-8";throw TypeError("Illegal invocation")}})}catch(e){TextEncoder.prototype.encoding="utf-8"}"undefined"!=typeof Symbol&&(TextEncoder.prototype[Symbol.toStringTag]="TextEncoder")}function urlBase64ToUint8Array(e){for(var e=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),t=atob(e),n=new Uint8Array(t.length),o=0;o<t.length;++o)n[o]=t.charCodeAt(o);return n}function joinPaths(){var e,t=[];for(e in arguments){var n=arguments[e];if(null!=n&&""!=n){for(;n.endsWith("/")||n.endsWith("\\");)n=n.substring(0,n.length-1);for(;n.startsWith("/")||n.startsWith("\\");)n=n.substring(1);t.push(n)}}return t.join("/")}function putstore(e,t){try{if("undefined"==typeof localStorage||localStorage.getItem(e)==t)return;null==t?localStorage.removeItem(e):localStorage.setItem(e,t)}catch(e){}if("_"!=e[0]){var n={};try{for(var o=0,i=localStorage.length;o<i;++o){var s=localStorage.key(o);"_"!=s[0]&&(n[s]=localStorage.getItem(s),"desktopsettings"!=s)&&"stars"!=s&&"deskKeyShortcuts"!=s&&"deskStrings"!=s&&"cmdopt"!=s&&"string"==typeof n[s]&&64<n[s].length&&delete n[s]}}catch(e){}meshserver.send({action:"userWebState",state:JSON.stringify(n)})}}function stringToUtf8Blob(e){var t=(new TextEncoder).encode(e),n=new Uint8Array(3+t.length);n[0]=239,n[1]=187,n[2]=191;for(var o=0;o<t.length;o++)n[o+3]=t[o];return new Blob([n],{type:"application/octet-stream"})}function stringToUtf8BlobNoHeader(e){return new Blob([(new TextEncoder).encode(e)],{type:"application/octet-stream"})}function multiTranslate(e){var t=e.indexOf("]|");return e.substring(t+2)}function getLang(){return null!=navigator.languages?navigator.languages[0]:navigator.language}function getNodeAmtVersion(e){return null==e||null==e.intelamt||"string"!=typeof e.intelamt.ver||(e=e.intelamt.ver.split(".")).length<2?0:parseInt(e[0])+parseInt(e[1])/100}function getstore(e,t){try{var n;return"undefined"==typeof localStorage?t:null==(n=localStorage.getItem(e))?t:n}catch(e){return t}}function addLink(e,t){return'<span tabindex=0 role="button" onclick=\''+t+"' onkeypress=\"if (event.key=='Enter') {"+t+'} ">'+e+' <i class="fa-solid fa-pencil fa-xs"></i></span>'}function addLinkConditional(e,t,n){return n?addLink(e,t):e}function addKeyLink(e,t){return"<span tabindex=0 role=button onclick="+t+" onkeypress=\"if (event.key=='Enter') { "+t+' } ">'+e+' <i class="fa-solid fa-key"></i></span>'}function addKeyLinkConditional(e,t,n){return n?"<span title='"+t+"'>"+e+' <i class="fa-solid fa-key"></i></span>':e}function haltEvent(e){return e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),!1}function addOption(e,t,n){var o=document.createElement("option");o.text=t,o.value=n,Q(e).add(o)}function passwordcheck(e){return 7<e.length&&/\d/.test(e)&&/[a-z]/.test(e)&&/[A-Z]/.test(e)&&/\W/.test(e)}function methodcheck(e){return!(!e||null==e||!e.Body||"SUCCESS"==e.Body.ReturnValueStr||(messagebox("呼叫錯誤",e.Header.Method+": "+e.Body.ReturnValueStr.replace("_"," ")),0))}function TableStart(){return"<table cellpadding=0 cellspacing=0 style=width:100%;border-radius:8px><tr><td width=200px><p><td>"}function TableStart2(){return"<table cellpadding=0 cellspacing=0 style=width:100%;border-radius:8px><tr><td><p><td>"}function TableEntry(e,t){return"<tr><td><p>"+e+"<td>"+t}function FullTable(e,t){var n=TableStart();for(i in e)i&&e[i]&&(n+=TableEntry(i,e[i]));return n+TableEnd(t)}function TableEnd(e){return"<tr><td colspan=2><p>"+(e||"")+"</table>"}function AddButton(e,t){return'<input type=button value="'+e+'" onclick="'+t+'" style=margin:4px>'}function AddButton2(e,t){return'<input type=button value="'+e+'" onclick="'+t+'">'}function AddRefreshButton(e){return'<input type=button name=refreshbtn value=Refresh onclick="refreshButtons(false);'+e+'" style=margin:4px '+(0==refreshButtonsState?"disabled":"")+">"}function MoreStart(){return"<div id=idx_dlgMoreButtons3 style=display:none><hr>"}function MoreEnd(){return"</div>"}function MoreToggle(e){QV("idx_dlgMoreButtons1",!e),QV("idx_dlgMoreButtons2",e),QV("idx_dlgMoreButtons3",e)}function getSelectedOptions(e){for(var t,n=[],o=0,i=e.options.length;o<i;o++)(t=e.options[o]).selected&&n.push(t.value);return n}function getInstance(e,t){for(var n in e)if(e[n].InstanceID==t)return e[n];return null}function getItem(e,t,n){for(var o in e)if(e[o][t]==n)return e[o];return null}function guidToStr(e){return e.substring(6,8)+e.substring(4,6)+e.substring(2,4)+e.substring(0,2)+"-"+e.substring(10,12)+e.substring(8,10)+"-"+e.substring(14,16)+e.substring(12,14)+"-"+e.substring(16,20)+"-"+e.substring(20)}function getUrlVars(){for(var e,t=[],n=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),o=0;o<n.length;o++)0<(e=n[o].indexOf("="))&&(t[n[o].substring(0,e)]=n[o].substring(e+1,n[o].length));return t}function addHtmlValue(e,t,n=[]){return`<div class="row mb-1"><div class="${n[0]||"col col-md-2 col-lg-2"}"><b>${e}</b></div><div class="${n[1]||"col col-md-10 col-lg-10"}">${t}</div></div>`}function addHtmlFormFloating(e,t,n=[]){return`<div class="row mb-1"><div class="form-floating mb-3 ${n[0]||"col-md-12"}">${t}<label class="${n[1]||"ms-2"}">${e}</label></div></div>`}function addHtmlValue2(e,t){return"<div><div style=display:inline-block;float:right>"+t+"</div><div style=display:inline-block>"+e+"</div></div>"}function addHtmlValue3(e,t){return"<div><b>"+e+"</b></div><div style=margin-left:16px>"+t+"</div>"}function addHtmlValue4(e,t){return"<table style=width:100%><td style=width:120px>"+e+"<td style=text-align:right><b>"+t+"</b></table>"}function addHtmlValue5(e,t){return"<div style=padding:4px><div style=display:inline-block;float:right><b>"+t+"</b></div><div style=display:inline-block>"+e+"</div></div>"}function focusTextBox(e){setTimeout(function(){Q(e).selectionStart=Q(e).selectionEnd=65535,Q(e).focus()},0)}function validateEmail(e){return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(e)}function isPrivateIP(e){return e.startsWith("10.")||e.startsWith("172.16.")||e.startsWith("192.168.")}function u2fSupported(){return window.u2f&&(0<navigator.userAgent.indexOf("Chrome/")||0<navigator.userAgent.indexOf("Firefox/")||0<navigator.userAgent.indexOf("Opera/")||0<navigator.userAgent.indexOf("Safari/"))}function findOne(t,e){return null!=t&&null!=e&&e.some(function(e){return 0<=t.indexOf(e)})}function copyTextToClip(e){var t,n=document.createElement("DIV");n.textContent=e,document.body.appendChild(n),e=n,document.selection?((t=document.body.createTextRange()).moveToElementText(e),t.select()):window.getSelection&&((t=document.createRange()).selectNode(e),window.getSelection().removeAllRanges(),window.getSelection().addRange(t)),document.execCommand("copy"),n.remove()}function copyTextToClip2(e){var t,n=document.createElement("DIV");n.textContent=decodeURIComponent(e),document.body.appendChild(n),e=n,document.selection?((t=document.body.createTextRange()).moveToElementText(e),t.select()):window.getSelection&&((t=document.createRange()).selectNode(e),window.getSelection().removeAllRanges(),window.getSelection().addRange(t)),document.execCommand("copy"),n.remove()}function capitalizeFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1)}function printDate(e){return e.toLocaleDateString(args.locale)}function printTime(e){return e.toLocaleTimeString(args.locale)}function printDateTime(e){return e.toLocaleString(args.locale)}function printFlexDateTime(e){return(printDate(new Date)==printDate(e)?printTime:printDateTime)(e)}function addDetailItem(e,t,n,o=[]){return`<div class="row mb-1"><div class="${o[0]||"col-md-8"}"> ${nobreak(e)} </div><div class="${o[1]||"col-md-4 text-end"}"> ${t} </div></div>`}function format(e){var n=Array.prototype.slice.call(arguments,1);return e.replace(/{(\d+)}/g,function(e,t){return void 0!==n[t]?n[t]:e})}function addTextLink(e,t,n){var o=t.toLowerCase().indexOf(e.toLowerCase());return-1==o?t:t.substring(0,o)+'<a href="'+n+'">'+e+"</a>"+t.substring(o+e.length)}function getOrderedList(e,n){var t,o=[];for(t in e)o.push(e[t]);return o.sort(function(e,t){e=e[n].toLowerCase(),t=t[n].toLowerCase();return t<e?1:e<t?-1:0}),o}function capitalizeFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1)}function nobreak(e){return e.split(" ").join("&nbsp;")}function pad2(e){e="00"+e;return e.substr(e.length-2)}function encodeURIComponentEx(e){return encodeURIComponent(e).replace(/'/g,"%27")}function getUserName(e){var t=e.split("/"),n=t[0]+"/"+t[1]+"/"+t[2],o="";if(4==t.length&&t[3].startsWith("guest:")&&(o=" - "+decode_utf8(atob(t[3].substring(6)))),users&&null!=users[n])return null!=users[n].realname?users[n].realname+o:users[n].name+o;if(currentNode&&currentNode.links&&currentNode.links[e]&&null!=currentNode.links[e].name)return currentNode.links[e].name+o;if(e==userinfo._id)return userinfo.name+o;if(nodes)for(var i in nodes)if(nodes[i].links)for(var s in nodes[i].links)if(nodes[i].links[s].name&&s==e)return nodes[i].links[s].name+o;return t[2]+o}function round(e,t){t=Math.pow(10,t||0);return Math.round(e*t)/t}function safeNewWindow(e,t){e=window.open(e,t,"noopener,noreferrer");e&&(e.opener=null)}function isWindowsNode(e){return 2==e.mtype&&null!=e.agent&&null!=e.agent.id&&0<=[1,2,3,4,21,22,34,42,43].indexOf(e.agent.id)}function downloadFile(e,t,n){var o=document.createElement("a");o.setAttribute("href",e),o.setAttribute("rel","noreferrer noopener"),o.setAttribute("target","fileDownloadFrame"),o.setAttribute("download",decodeURIComponent(t||"")),document.body.appendChild(o),o.click(),document.body.removeChild(o),n&&setDialogMode(0)}function dialogBoxDrag(){var t=Q("xxAddAgentModal"),n=0,o=0,i=0,s=0;function a(e){(e=e||window.event).preventDefault(),n=i-e.clientX,o=s-e.clientY,i=e.clientX,s=e.clientY,t.style.top=t.offsetTop-o+"px",t.style.left=t.offsetLeft-n+"px"}function l(){document.onmouseup=null,document.onmousemove=null}Q("dialogHeader").onmousedown=function(e){(e=e||window.event).preventDefault(),i=e.clientX,s=e.clientY,document.onmouseup=l,document.onmousemove=a}}window.addEventListener("beforeunload",function(e){(null!=desktop&&11==xxcurrentView||null!=terminal&&12==xxcurrentView)&&(e.preventDefault(),e.returnValue="")})</script>