<!doctypehtml><html lang=zh-chs dir=ltr xmlns=http://www.w3.org/1999/xhtml><meta http-equiv=X-UA-Compatible content="IE=edge"><meta http-equiv=Content-Type content="text/html;charset=utf-8"><meta name=viewport content="user-scalable=1,initial-scale=1,minimum-scale=1,maximum-scale=1"><meta name=apple-mobile-web-app-capable content=yes><meta name=format-detection content="telephone=no"><meta name=robots content=noindex,nofollow><link rel=manifest href={{{domainurl}}}manifest.json><link type=image/x-icon href={{{domainurl}}}favicon.ico rel="shortcut icon"><link keeplink=1 type=text/css href=styles/style.css media=screen rel=stylesheet title=CSS><link type=text/css href=styles/ol.css media=screen rel=stylesheet title=CSS><link type=text/css href=styles/ol3-contextmenu.min.css media=screen rel=stylesheet title=CSS><link type=text/css href=styles/xterm.css media=screen rel=stylesheet title=CSS><link type=text/css href=styles/flatpickr.min.css media=screen rel=stylesheet title=CSS><link rel=apple-touch-icon href=/favicon-303x303.png><script src=scripts/common-0.0.1{{{min}}}.js></script><script src=scripts/meshcentral{{{min}}}.js></script><script src=scripts/amt-0.2.0{{{min}}}.js></script><script src=scripts/amt-wsman-0.2.0{{{min}}}.js></script><script src=scripts/amt-desktop-0.0.2{{{min}}}.js></script><script src=scripts/amt-terminal-0.0.2{{{min}}}.js></script><script src=scripts/zlib{{{min}}}.js></script><script src=scripts/zlib-inflate{{{min}}}.js></script><script src=scripts/zlib-adler32{{{min}}}.js></script><script src=scripts/zlib-crc32{{{min}}}.js></script><script src=scripts/amt-redir-ws-0.1.0{{{min}}}.js></script><script src=scripts/amt-wsman-ws-0.2.0{{{min}}}.js></script><script src=scripts/agent-redir-ws-0.1.1{{{min}}}.js></script><script src=scripts/agent-redir-rtc-0.1.0{{{min}}}.js></script><script src=scripts/agent-desktop-0.0.2{{{min}}}.js></script><script src=scripts/agent-rdp-0.0.1{{{min}}}.js></script><script src=scripts/qrcode.min.js></script><script src=scripts/xterm{{{min}}}.js></script><script src=scripts/xterm-addon-fit{{{min}}}.js></script><script src=scripts/flatpickr.js></script><script src=mstsc/mstsc.js></script><script src=mstsc/keyboard.js></script><script src=mstsc/rle.js></script><script src=mstsc/client.js></script><script src=mstsc/canvas.js></script><script keeplink=1 src=scripts/u2f-api{{{min}}}.js></script><script keeplink=1 src=scripts/charts{{{min}}}.js></script><script keeplink=1 src=scripts/moment{{min}}.js></script><script keeplink=1 src=scripts/chartjs-adapter-moment{{{min}}}.js></script><script keeplink=1 src=scripts/filesaver.min.js></script><script keeplink=1 src=scripts/ol{{{min}}}.js></script><script keeplink=1 src=scripts/ol3-contextmenu{{{min}}}.js></script><script keeplink=1 src=scripts/purify{{{min}}}.js></script><script keeplink=1 src=scripts/marked{{{min}}}.js></script><title>{{{title}}}</title><body id=body oncontextmenu=handleContextMenu(event) style=display:none;min-width:495px onload='"undefined"!=typeof startup&&startup()'><div id=contextMenu class="contextMenu noselect"style=display:none><div id=cxinfo class=cmtext onclick=cmaction(1,event)><b>信息</b></div><div id=cxdesktop class=cmtext onclick=cmaction(3,event)>桌面</div><div id=cxterminal class=cmtext onclick=cmaction(2,event)>终端</div><div id=cxfiles class=cmtext onclick=cmaction(4,event)>档案</div><div id=cxevents class=cmtext onclick=cmaction(5,event)>事件</div><div id=cxdetails class=cmtext onclick=cmaction(6,event)>细节</div><div id=cxconsole class=cmtext onclick=cmaction(7,event)>控制台</div><div id=cxwebrdp class=cmtext onclick=cmaction(11,event)>网络RDP</div><div id=cxwebvnc class=cmtext onclick=cmaction(12,event)>网络VNC</div><div id=cxwebssh class=cmtext onclick=cmaction(13,event)>网络SSH</div><div id=cxrdp class=cmtext onclick=cmaction(14,event)>RDP</div><div id=cxplugins class=cmtext onclick=cmaction(8,event) style=display:none>插件程式</div><hr id=cxmgroupsplit><div id=cxstar class=cmtext onclick=cmaction(10,event) style=display:none>切换星</div><div id=cxmdesktop class=cmtext onclick=cmaction(9,event) style=display:none>多桌面</div></div><div id=meshContextMenu class="contextMenu noselect"style=display:none;min-width:0><div id=cxselectall class=cmtext onclick=cmmeshaction(1,event)>全选</div><div id=cxselectnone class=cmtext onclick=cmmeshaction(2,event)>取消全选</div></div><div id=filesShellContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmconnectfilesaction()>询问同意</div></div><div id=termShellContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmtermaction(1,0,event)><b>管理控制台</b></div><div class=cmtext onclick=cmtermaction(6,0,event)>管理员PowerShell</div><div class=cmtext onclick=cmtermaction(8,0,event)>用户Shell</div><div class=cmtext onclick=cmtermaction(9,0,event)>用户PowerShell</div><div class=cmtext onclick=cmtermaction(1,16,event)>询问管理员外壳</div><div class=cmtext onclick=cmtermaction(6,16,event)>询问管理员 PowerShell</div><div class=cmtext onclick=cmtermaction(8,16,event)>询问用户外壳</div><div class=cmtext onclick=cmtermaction(9,16,event)>询问用户 PowerShell</div></div><div id=termShellContextMenu2 class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmtermaction(8,0,event)><b>用户Shell</b></div><div class=cmtext onclick=cmtermaction(9,0,event)>用户PowerShell</div></div><div id=termShellContextMenuLinux class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmtermaction(1,0,event)><b>Root Shell</b></div><div class=cmtext onclick=cmtermaction(8,0,event)>用户Shell</div><div class=cmtext onclick=cmtermaction(100,0,event)>登录控制台</div></div><div id=deskConnectContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmdeskaction(1,event)>询问同意+工具栏</div><div class=cmtext onclick=cmdeskaction(2,event)>询问同意</div><div class=cmtext onclick=cmdeskaction(3,event)>隐私栏</div></div><div id=deskDisconnectContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmdeskaction(10,event)>断开连接并锁定</div><div class=cmtext onclick=cmdeskaction(11,event)>断线</div></div><div id=altPortContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmaltportaction(1,event)>备用端口</div></div><div id=sshPortContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmsshportaction(1,event)>备用端口</div></div><div id=rfbPortContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmrfbportaction(1,event)>备用端口</div></div><div id=httpPortContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmhttpportaction(1,event)>备用端口</div></div><div id=httpsPortContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmhttpsportaction(1,event)>备用端口</div></div><div id=filesContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmfilesaction(1,event)>改名</div><div class=cmtext onclick=cmfilesaction(2,event)>编辑</div><div class=cmtext onclick=cmfilesaction(3,event)>删除</div></div><div id=expandAllContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmexpandaction(1,event)>展开全部</div><div class=cmtext onclick=cmexpandaction(2,event)>全部收缩</div></div><div id=deskPlayerContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmdeskplayeraction(1,event)>打开播放器...</div></div><div id=deskKeyShortcutContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmdeskshortcutaction(1,event)>定制...</div></div><div id=deskPreConfigShortcutContextMenu class="contextMenu noselect"style="display:none;min-width:0;max-height:calc(80% - 50px);overflow-y:auto"><span id=deskPreConfigShortcutContextMenu1></span> <span id=deskPreConfigShortcutContextMenu2></span><div class=cmtext onclick=cmdeskpreconfigtypeaction(-1,event)>定制...</div></div><div id=deskPreConfigScriptContextMenu class="contextMenu noselect"style="display:none;min-width:0;max-height:calc(80% - 50px);overflow-y:auto"><span id=deskPreConfigScriptContextMenu1></span> <span id=deskPreConfigScriptContextMenu2></span></div><div id=container><div id=notifiyBox class=notifiyBox style=display:none></div><div id=masthead class=noselect><div style=float:left>{{{titlehtml}}}</div><div class=title onclick=go(1,event)>{{{title1}}}</div><div class=title2>{{{title2}}}</div><div style=float:right><div id=notificationCount onclick=clickNotificationIcon() class=unselectable style=display:none title=点击查看当前通知>0</div></div><p id=logoutControl><span id=logoutControlSpan class=logoncontrolspan></span><span id=idleTimeoutNotify style=color:#ff0></span><div class=textnewui id=textnewui onmouseup=toggleBootstrapUIMode() onkeypress='"Enter"==event.key&&toggleBootstrapUIMode()'><b>Try the new MeshCentral UI</b></div></div><div id=page_leftbar><div style=height:16px></div><div id=LeftMenuMyDevices tabindex=0 class="lbbutton lbbuttonsel"title=我的设备 onmouseup=go(1,event) onkeypress='"Enter"==event.key&&go(1)'><div class="lbtg lb2"></div></div><div id=LeftMenuMyAccount tabindex=0 class=lbbutton title=我的帐户 onmouseup=go(2,event) onkeypress='"Enter"==event.key&&go(2)'><div class="lbtg lb1"></div></div><div id=LeftMenuMyEvents tabindex=0 class=lbbutton title=我的事件 onmouseup=go(3,event) onkeypress='"Enter"==event.key&&go(3)'><div class="lbtg lb3"></div></div><div id=LeftMenuMyFiles tabindex=0 class=lbbutton style=display:none title=我的文件 onmouseup=go(5,event) onkeypress='"Enter"==event.key&&go(5)'><div class="lbtg lb4"></div></div><div id=LeftMenuMyUsers tabindex=0 class=lbbutton style=display:none title=我的用户 onmouseup=go(4,event) onkeypress='"Enter"==event.key&&go(4)'><div class="lbtg lb5"></div></div><div id=LeftMenuMyServer tabindex=0 class=lbbutton style=display:none title=我的服务器 onmouseup=go(6,event) onkeypress='"Enter"==event.key&&go(6)'><div class="lbtg lb6"></div></div></div><div id=topbar class=noselect><div><div style=position:relative><span id=logoutControlSpan2></span><div tabindex=0 id=uiMenuButton title=用户界面选择 onclick=showUserInterfaceSelectMenu() onkeypress='"Enter"==event.key&&showUserInterfaceSelectMenu()'>♦<div id=uiMenu style=display:none><table><tr><td><div tabindex=0 id=uiViewButton1 class=uiSelector onclick=userInterfaceSelectMenu(1) title=左栏界面 onkeypress='"Enter"==event.key&&userInterfaceSelectMenu(1)'><div class=uiSelector1></div></div><div tabindex=0 id=uiViewButton2 class=uiSelector onclick=userInterfaceSelectMenu(2) title=顶栏界面 onkeypress='"Enter"==event.key&&userInterfaceSelectMenu(2)'><div class=uiSelector2></div></div><div tabindex=0 id=uiViewButton3 class=uiSelector onclick=userInterfaceSelectMenu(3) title=固定宽度接口 onkeypress='"Enter"==event.key&&userInterfaceSelectMenu(3)'><div class=uiSelector3></div></div><div tabindex=0 id=uiViewButton7 class=uiSelector onclick=toggleBootstrapUIMode() title="Toggle Modern UI"onkeypress='"Enter"==event.key&&toggleBootstrapUIMode()'><div class=uiSelector7></div></div><td><div tabindex=0 id=uiViewButton6 class=uiSelector onclick=showNotes(!1) title=个人笔记 onkeypress='"Enter"==event.key&&showNotes(!1)'><div class=uiSelector6></div></div><div tabindex=0 id=uiViewButton4 class=uiSelector onclick=toggleNightMode() title=切换夜间模式 onkeypress='"Enter"==event.key&&toggleNightMode()'><div class=uiSelector4></div></div><div tabindex=0 id=uiViewButton5 class=uiSelector onclick=toggleFooterBarMode() title=切换页脚栏 onkeypress='"Enter"==event.key&&toggleFooterBarMode()'><div class=uiSelector5></div></div><div class=uiSelector_end>&nbsp;</div></table></div></div><table id=MainMenuSpan cellpadding=0 cellspacing=0 class=style1><tr><td tabindex=0 id=MainMenuMyDevices class="topbar_td style3x"onmouseup=go(1,event) onkeypress='"Enter"==event.key&&go(1)'>我的设备<td tabindex=0 id=MainMenuMyAccount class="topbar_td style3x"onmouseup=go(2,event) onkeypress='"Enter"==event.key&&go(2)'>我的帐户<td tabindex=0 id=MainMenuMyEvents class="topbar_td style3x"onmouseup=go(3,event) onkeypress='"Enter"==event.key&&go(3)'>我的事件<td tabindex=0 id=MainMenuMyFiles class="topbar_td style3x"onmouseup=go(5,event) onkeypress='"Enter"==event.key&&go(5)'>我的文件<td tabindex=0 id=MainMenuMyUsers class="topbar_td style3x"onmouseup=go(4,event) onkeypress='"Enter"==event.key&&go(4)'>我的用户<td tabindex=0 id=MainMenuMyServer class="topbar_td style3x"onmouseup=go(6,event) onkeypress='"Enter"==event.key&&go(6)'>我的服务器<td class="topbar_td_end style3">&nbsp;</table><div id=MainSubMenuSpan style=display:none><table id=MainSubMenu cellpadding=0 cellspacing=0 class=style1><tr><td tabindex=0 id=MainDev class="topbar_td style3x"onmouseup=go(10,event) onkeypress='"Enter"==event.key&&go(10)'>一般<td tabindex=0 id=MainDevDesktop class="topbar_td style3x"onmouseup=go(11,event) onkeypress='"Enter"==event.key&&go(11)'>桌面<td tabindex=0 id=MainDevTerminal class="topbar_td style3x"onmouseup=go(12,event) onkeypress='"Enter"==event.key&&go(12)'>终端<td tabindex=0 id=MainDevFiles class="topbar_td style3x"onmouseup=go(13,event) onkeypress='"Enter"==event.key&&go(13)'>档案<td tabindex=0 id=MainDevEvents class="topbar_td style3x"onmouseup=go(16,event) onkeypress='"Enter"==event.key&&go(16)'>事件<td tabindex=0 id=MainDevInfo class="topbar_td style3x"onmouseup=go(17,event) onkeypress='"Enter"==event.key&&go(17)'>细节<td tabindex=0 id=MainDevAmt class="topbar_td style3x"onmouseup=go(14,event) onkeypress='"Enter"==event.key&&go(14)'>英特尔®AMT<td tabindex=0 id=MainDevConsole class="topbar_td style3x"onmouseup=go(15,event) onkeypress='"Enter"==event.key&&go(15)'>控制台<td tabindex=0 id=MainDevPlugins class="topbar_td style3x"onmouseup=go(19,event) onkeypress='"Enter"==event.key&&go(19)'>插件程式<td class="topbar_td_end style3">&nbsp;</table></div><div id=MeshSubMenuSpan style=display:none><table id=MeshSubMenu cellpadding=0 cellspacing=0 class=style1><tr><td tabindex=0 id=MeshGeneral class="topbar_td style3x"onmouseup=go(20,event) onkeypress='"Enter"==event.key&&go(20)'>一般<td tabindex=0 id=MeshSummary class="topbar_td style3x"onmouseup=go(21,event) onkeypress='"Enter"==event.key&&go(21)'>摘要<td class="topbar_td_end style3">&nbsp;</table></div><div id=EventsSubMenuSpan style=display:none><table id=EventsSubMenu cellpadding=0 cellspacing=0 class=style1><tr><td tabindex=0 id=EventsLive class="topbar_td style3x"onmouseup=go(3,event) onkeypress='"Enter"==event.key&&go(3)'>事件<td tabindex=0 id=EventsReport class="topbar_td style3x"onmouseup=go(60,event) onkeypress='"Enter"==event.key&&go(60)'>报告<td class="topbar_td_end style3">&nbsp;</table></div><div id=UserSubMenuSpan style=display:none><table id=UserSubMenu cellpadding=0 cellspacing=0 class=style1><tr><td tabindex=0 id=UserGeneral class="topbar_td style3x"onmouseup=go(30,event) onkeypress='"Enter"==event.key&&go(30)'>一般<td tabindex=0 id=UserEvents class="topbar_td style3x"onmouseup=go(31,event) onkeypress='"Enter"==event.key&&go(31)'>事件<td class="topbar_td_end style3">&nbsp;</table></div><div id=UsersSubMenuSpan style=display:none><table id=UsersSubMenu cellpadding=0 cellspacing=0 class=style1><tr><td tabindex=0 id=UsersGeneral class="topbar_td style3x"onmouseup=go(4,event) onkeypress='"Enter"==event.key&&go(4)'>用户<td tabindex=0 id=UsersGroups class="topbar_td style3x"onmouseup=go(50,event) onkeypress='"Enter"==event.key&&go(50)'>群组<td tabindex=0 id=UsersRecordings class="topbar_td style3x"onmouseup=go(52,event) onkeypress='"Enter"==event.key&&go(52)'>录音<td class="topbar_td_end style3">&nbsp;</table></div><div id=ServerSubMenuSpan style=display:none><table id=ServerSubMenu cellpadding=0 cellspacing=0 class=style1><tr><td tabindex=0 id=ServerGeneral class="topbar_td style3x"onmouseup=go(6,event) onkeypress='"Enter"==event.key&&go(6)'>一般<td tabindex=0 id=ServerStats class="topbar_td style3x"onmouseup=go(40,event) onkeypress='"Enter"==event.key&&go(40)'>统计<td tabindex=0 id=ServerConsole class="topbar_td style3x"onmouseup=go(115,event) onkeypress='"Enter"==event.key&&go(115)'>控制台<td tabindex=0 id=ServerTrace class="topbar_td style3x"onmouseup=go(41,event) onkeypress='"Enter"==event.key&&go(41)'>追踪<td tabindex=0 id=ServerPlugins class="topbar_td style3x"onmouseup=go(42,event) onkeypress='"Enter"==event.key&&go(42)'>插件程式<td class="topbar_td_end style3">&nbsp;</table></div><div id=UserDummyMenuSpan><table id=UserDummyMenu cellpadding=0 cellspacing=0 class=style1><tr><td class=style3>&nbsp;</table></div></div></div></div><div id=column_l><div id=p0 style=display:none><div id=p0message><span id=p0span>服务器已断开连接</span>,<href onclick=reload() style=cursor:pointer><u>点击重新连接</u></href>.</div></div><div id=p1 style=display:none><div id=p1title><div style=display:none id=devListToolbarViewIcons><div id=devViewPageState style=float:left;line-height:32px;height:32px;font-size:16px;display:none></div><div tabindex=0 id=devViewPageButton1 class=viewSelector onclick=onDeviceViewPageChange(1) onkeypress='"Enter"==event.key&&onDeviceViewPageChange(1)'title="Go to first page"style=display:none><div class=viewSelector9></div></div><div tabindex=0 id=devViewPageButton2 class=viewSelector onclick=onDeviceViewPageChange(2) onkeypress='"Enter"==event.key&&onDeviceViewPageChange(2)'title="Go to previous page"style=display:none><div class=viewSelector10></div></div><div tabindex=0 id=devViewPageButton3 class=viewSelector onclick=onDeviceViewPageChange(3) onkeypress='"Enter"==event.key&&onDeviceViewPageChange(3)'title="Go to next page"style=display:none><div class=viewSelector11></div></div><div tabindex=0 id=devViewPageButton4 class=viewSelector onclick=onDeviceViewPageChange(4) onkeypress='"Enter"==event.key&&onDeviceViewPageChange(4)'title="Go to last page"style=display:none;margin-right:12px><div class=viewSelector8></div></div><div tabindex=0 id=devViewButton1 class=viewSelector onclick=onDeviceViewChange(1) onkeypress='"Enter"==event.key&&onDeviceViewChange(1)'title=列><div class=viewSelector2></div></div><div tabindex=0 id=devViewButton2 class=viewSelector onclick=onDeviceViewChange(2) onkeypress='"Enter"==event.key&&onDeviceViewChange(2)'title=清单><div class=viewSelector1></div></div><div tabindex=0 id=devViewButton3 class=viewSelector onclick=onDeviceViewChange(3) onkeypress='"Enter"==event.key&&onDeviceViewChange(3)'title=台式机><div class=viewSelector3></div></div><div tabindex=0 id=devViewButton5 class=viewSelector onclick=onDeviceViewChange(5) onkeypress='"Enter"==event.key&&onDeviceViewChange(5)'title=台式机><div class=viewSelector7></div></div><div tabindex=0 id=devViewButton4 class=viewSelector onclick=onDeviceViewChange(4) onkeypress='"Enter"==event.key&&onDeviceViewChange(4)'title=地图 style=display:none><div class=viewSelector4></div></div></div><div><h1>我的设备</h1></div></div><table id=devListToolbarSpan class=noselect><tr><td class=h1><td id=devListToolbar class=style14 style=display:none><img style=cursor:pointer;margin-top:4px;display:none title=全部收缩 id=CollapseAllButton src=images/icon-collapse.png width=9 height=11 onclick=cmexpandaction(2)> <img style=cursor:pointer;margin-top:4px;display:none title=展开全部 id=ExpandAllButton src=images/icon-expand.png width=9 height=11 onclick=cmexpandaction(1)> <input type=button id=SelectAllButton onclick=selectallButtonFunction() value=全选>&nbsp; <input type=button id=GroupActionButton disabled value=集体指令 onclick=groupActionFunction()>&nbsp; <input type=button id=ScrollToTopButton onclick=onDevicesScroll(!0) style=display:none;margin-right:4px value="Scroll To Top"> <input id=SearchInput type=input autocomplete=off placeholder=过滤 onchange=onDeviceSearchChanged(event) onclick=onDeviceSearchChanged(event) onkeyup=onDeviceSearchChanged(event) onfocus=onSearchFocus(1) onblur=onSearchFocus(0) title="过滤器：user:xxx or u:xxx ip:xxx group:xxx or g:xxx tag:xxx or t:xxx atag:xxx or a:xxx os:xxx amt:xxx desc:xxx wsc:ok wsc:noav wsc: noupdate wsc:nofirewall wsc:any">&nbsp; <span id=SearchInputClearButton style=display:none;position:relative><img src=images/x16.png type=button onclick=clearDeviceSearch() style=position:absolute;cursor:pointer;left:-18px;top:-8px srcset="images/x32.png 2x"></span><select id=DevFilterSelect onchange=onOnlineCheckBox(event) title=设备过滤器><option value=0>所有<option value=1>在线<option value=5>离线<option value=2>会话<option value=3>已加星标<option value=4>英特尔®AMT<option value=6>救命<option value=7>已标记<option value=8>未标记</select> <label><input type=checkbox id=RealNameCheckBox onclick=onRealNameCheckBox()><span title=显示设备操作系统名称>操作系统名称</span></label> <label style=display:none><input type=checkbox id=OnlineCheckBox onclick=onOnlineCheckBox(event)><span title=仅显示在线设备>在线</span></label> <span id=devsCustomUIBar></span><td id=kvmListToolbar class=style14 style=display:none><img style=cursor:pointer;margin-top:4px;display:none title=全部收缩 id=CollapseAllButton2 src=images/icon-collapse.png width=9 height=11 onclick=cmexpandaction(2)> <img style=cursor:pointer;margin-top:4px;display:none title=展开全部 id=ExpandAllButton2 src=images/icon-expand.png width=9 height=11 onclick=cmexpandaction(1)> <input type=button onclick=connectAllKvmFunction() value=全部连接>&nbsp; <input type=button onclick=disconnectAllKvmFunction() value=全部断线>&nbsp; <input type=button onclick=onDevicesScroll(!0) value="Scroll To Top">&nbsp; <label><input type=checkbox id=autoConnectDesktopCheckbox onclick=autoConnectDesktops(event) title=自动连接>自动&nbsp;</label> <input type=button onclick=showMultiDesktopSettings() value=设定>&nbsp; <input id=KvmSearchInput type=search placeholder=过滤 onchange=onDeviceSearchChanged(event) onclick=onDeviceSearchChanged(event) onkeyup=onDeviceSearchChanged(event) autocomplete=off onfocus=onSearchFocus(1) onblur=onSearchFocus(0)>&nbsp; <span id=KvmSearchInputClearButton style=display:none;position:relative><img src=images/x16.png type=button onclick=clearDeviceSearch() style=position:absolute;cursor:pointer;left:-18px;top:-8px srcset="images/x32.png 2x"></span><td id=devMapToolbar class=style14 style=display:none>&nbsp;&nbsp;<input type=search id=mapSearchLocation placeholder=搜寻位置 onfocus=onMapSearchFocus(1) onblur=onMapSearchFocus(0)> <input type=button value=搜寻 title=寻找位置 onclick=getSearchLocation()> <input type=button id=refreshmap title=重置地图视图 value=重设 onclick=refreshMap(!1,!0)><td class=auto-style1 style=height:100%><img style=display:none;cursor:pointer;margin-top:3px id=devListToolbarSettings src=images/icon-gear.png width=16 height=16 onclick=onDeviceViewSettings()><div style=display:none id=devListToolbarView>检视 <select id=viewselect onchange=onDeviceViewChange()><option value=1>列<option value=2>清单<option value=3>桌面固定宽度<option id=viewselectmapoption value=4 style=display:none>地图<option value=5>台式机</select></div><div style=display:none id=devListToolbarSort>排序 <select id=sortselect onchange=mainUpdate(6)><option>组<option>电源<option>设备<option>标签<option>组标签<option>最后一次露面</select> &nbsp;</div><div style=display:none id=devListToolbarSize>尺寸 <select id=sizeselect onchange=onDeviceViewChange()><option value=0>小<option value=1>中<option value=2>大</select> &nbsp;</div><td class=h2></table><div id=NoMeshesPanel style=display:none><table><tr><td valign=top style=width:50px><img src=images/info.png loading=lazy width=47 height=48><td><div id=getStarted1>开始， <a href=# onclick="return account_createMesh()"><strong>单击此处创建设备组</strong></a>.</div><div id=getStarted2>没有设备组。</div></table></div><div id=xdevices class=noselect style=display:none onscroll=onDevicesScroll(!1)></div><div id=xdevicesmap style=display:none><div id=xmapSearchResultsDlg style=display:none><div id=xmapSearchResultsBck><div id=xmapSearchClose onclick=mapCloseSearchWindow()><b>X</b></div><div style=padding:5px>位置结果</div><div style=width:100%;margin:6px></div></div><div id=xmapSearchResults style=margin:6px></div></div></div><div id=xmap-info-window></div></div><div id=p2 style=display:none><div id=p2title><h1>我的帐户</h1></div><div id=p2info style=overflow-y:auto><div id=p2AccountImageFrame><img id=p2AccountImage alt=""loading=lazy width=128 height=128 onclick=account_manageImage(0) src=images/user-256.png><div><a onclick=account_manageImage(0)>更改图像</a></div></div><div id=p2AccountSecurity style=display:none><p><strong>帐户安全</strong><div style=margin-left:25px><div id=managePhoneNumber1><div class=p2AccountActions><span id=authPhoneNumberCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_managePhone()">管理电话号码</a><br></span></div><div id=manageEmail2FA><div class=p2AccountActions><span id=authEmailSetupCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_manageAuthEmail()">管理电邮身份验证</a><br></span></div><div id=manageAuthApp><div class=p2AccountActions><span id=authAppSetupCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_manageAuthApp()">管理身份验证器应用</a><br></span></div><div id=manageDuoApp><div class=p2AccountActions><span id=authDuoSetupCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_manageAuthDuo()">Manage Duo authentication</a><br></span></div><div id=manageHardwareOtp><div class=p2AccountActions><span id=authKeySetupCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_manageHardwareOtp(0)">管理安全密钥</a><br></span></div><div id=managePushAuthDev><div class=p2AccountActions><span id=authPushAuthDevCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_managePushAuthDev()">管理推送身份验证</a><br></span></div><div id=manageMessaging1><div class=p2AccountActions><span id=authMessagingCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_manageMessaging()">Manage messaging</a><br></span></div><div id=manageOtp><div class=p2AccountActions><span id=authCodesSetupCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_manageOtp(0)">管理备用码</a><br></span></div></div></div><div id=p2AccountActions><p><strong>帐户动作</strong><p class=mL><span id=viewPreviousLogins><a href=# onclick="return account_viewPreviousLogins()">查看以前的登录</a><br></span><span id=managePhoneNumber2 style=display:none><a href=# onclick="return account_managePhone()">管理电话号码</a><br></span><span id=manageMessaging2 style=display:none><a href=# onclick="return account_manageMessaging()">Manage messaging</a><br></span><span id=verifyEmailId style=display:none><a href=# onclick="return account_showVerifyEmail()">验证电邮</a><br></span><span id=accountEnableNotificationsSpan style=display:none><a href=# onclick="return account_enableNotifications()">启用网络通知</a><br></span><a href=# onclick="return account_showLocalizationSettings()">本地化设置</a><br><a href=# onclick="return account_showAccountNotifySettings()">通知设置</a><br><span id=p2AccountPassActions><span id=accountChangeEmailAddressSpan style=display:none><a href=# onclick="return account_showChangeEmail()">更改邮件地址</a><br></span><a href=# onclick="return account_showChangePassword()">更改密码</a><span id=p2nextPasswordUpdateTime></span><br><a href=# onclick="return account_showDeleteAccount()">删除帐户</a><br></span><span id=accountCreateLoginTokenSpan style=display:none><a href=# onclick="return account_createLoginToken()">创建登录令牌</a><br></span></p><br style=clear:both></div><div id=p2logintokens></div><strong>设备组</strong> <span id=p2createMeshLink1>- <a href=# onclick="return account_createMesh()"class=newMeshBtn>新</a></span><br><br><div id=p2meshes></div><div id=p2noMeshFound style=display:none>没有设备组。<span id=p2createMeshLink2> <a href=# onclick="return account_createMesh()"><strong>从这里开始！</strong></a></span></div><br style=clear:both></div></div><div id=p3 style=display:none><div id=p3title><h1>我的事件</h1></div><table class=pTable><tr><td class=h1><td class=auto-style1><input type=button style=display:none value=下载报告 onclick=p3showReportDialog()><td class=auto-style1>过滤 <select id=p3filterevents onchange=refreshEvents()><option notransval=1 value="">All Logs<option notransval=1 value=agentlog>Agent Logs<option notransval=1 value=relaylog>Relay Logs<option notransval=1 value=manual>Manual Logs<option notransval=1 value=runcommands>Run Command Logs<option notransval=1 value=batchupload>Batch Upload Logs<option notransval=1 value=changenode>Change Node Logs<option notransval=1 value=removenode>Remove Node Logs</select> 显示 <select id=p3limitdropdown onchange=refreshEvents()><option notransval=1 value=60>最后60<option notransval=1 value=120>最后120<option notransval=1 value=250>最后250<option notransval=1 value=500>最后500<option notransval=1 value=1000>最后1000<option notransval=1 value="">没有限制</select>&nbsp; <a href=# onclick=p3showDownloadEventsDialog(2)><img src=images/link4.png height=10 width=10 title=下载事件 style=cursor:pointer></a>&nbsp;<td class=h2></table><div id=p3events></div></div><div id=p4 style=display:none><div id=p4title><h1>我的用户</h1></div><table class=pTable><tr><td class=h1><td class=style14><div style=float:right><input type=button onclick=showUserBroadcastDialog() style=margin-right:6px value=广播> <a href=# onclick=p4downloadUserInfo()><img style=cursor:pointer title=下载用户信息 src=images/link4.png></a><a href=# onclick=p4batchAccountCreate()><img id=p4UserBatchCreate style=cursor:pointer;display:none title=批量创建多个用户帐户 src=images/link6.png></a><img style=cursor:pointer;margin-top:3px;margin-left:6px id=usersListToolbarSettings src=images/icon-gear.png width=16 height=16 onclick=onUsersViewSettings()></div><div><input type=button id=UsersSelectAllButton onclick=p3usersSelectallButtonFunction() value=全选> <input type=button id=UsersGroupActionButton disabled value=集体指令 onclick=p3usersGroupActionFunction()> <input id=UserNewAccountButton type=button onclick=showCreateNewAccountDialog() value=新账户...> <input id=UserSearchInput type=search style=width:120px;margin-left:6px placeholder=过滤 onchange=onUserSearchInputChanged() onkeyup=onUserSearchInputChanged() autocomplete=off onfocus=onUserSearchFocus(1) onblur=onUserSearchFocus(0)></div><td class=h2></table><div id=p3users></div></div><div id=p5 style=display:none><div id=p5title><h1>我的文件</h1></div><table id=p5toolbar cellpadding=0 cellspacing=0><tr><td id=p5filehead valign=bottom><div id=p5rightOfButtons></div><div><input type=button id=p5FolderUp disabled onclick="return p5folderup()"value=上>&nbsp; <input type=button id=p5SelectAllButton disabled onclick=p5selectallfile() value=全选>&nbsp; <input type=button id=p5RenameFileButton disabled value=改名 onclick=p5renamefile()>&nbsp; <input type=button id=p5DeleteFileButton disabled value=删除 onclick=p5deletefile()>&nbsp; <input type=button id=p5ViewFileButton disabled value=编辑 onclick=p5viewfile()>&nbsp; <input type=button id=p5NewFolderButton disabled value=新建文件夹 onclick=p5createfolder()>&nbsp; <input type=button id=p5UploadButton disabled value=上传 onclick=p5uploadFile()>&nbsp; <input type=button id=p5DownloadButton disabled value=下载 onclick=p5downloadButton()>&nbsp; <input type=button id=p5CutButton disabled value=剪切 onclick=p5copyFile(1)>&nbsp; <input type=button id=p5CopyButton disabled value=复制 onclick=p5copyFile(0)>&nbsp; <input type=button id=p5PasteButton disabled value=粘贴 onclick=p5pasteFile()>&nbsp;</div><tr><td id=p5filesubhead><div style=float:right><select id=p5sortdropdown onchange=updateFiles()><option value=1 selected>按名称排序<option value=2>按大小排序<option value=3>按日期排序<option value=4>按名称降序<option value=5>按大小降序<option value=6>按日期降序</select></div><div>&nbsp;&nbsp;<span id=p5currentpath></span></div></table><div id=p5filetable><div id=p5PublicShare><div>这些档案是公开共享的，请单击“连结”以获取公用URL。</div></div><div id=bigok style=display:none><b>✓</b></div><div id=bigfail style=display:none><b>✗</b></div><span id=p5files></span></div><table id=p5toolbarBottom style=width:100% cellpadding=0 cellspacing=0><tr><td class=style6>&nbsp;<span id=p5bottomstatus></span></table></div><div id=p6 style=display:none><div id=p6info style=overflow-y:auto><div id=p6title><img id=MainMeshImage src=serverpic.ashx><h1>我的服务器</h1></div><div id=p2ServerActions><p><strong>服务器指令</strong><div style=margin-left:25px><div id=p2ServerActionsBackup><div class=p2AccountActions><span style=display:none><strong>✓</strong></span></div><a id=p6backuplink href={{{domainurl}}}backup.zip rel="noreferrer noopener"target=_blank>下载服务器备份</a></div><div id=p2ServerActionsRestore><div class=p2AccountActions><span style=display:none><strong>✓</strong></span></div><a href=# onclick="return server_showRestoreDlg()">通过备份还原服务器</a></div><div id=p2ServerActionsGoogleBackup style=display:none><div class=p2AccountActions><span id=p2ServerActionsGoogleBackupCheck style=display:none><strong>✓</strong></span></div><span><a href=# onclick="return server_setupGoogleDriveBackup()">Google云端硬盘备份</a><br></span></div><div id=p2ServerActionsVersion><div class=p2AccountActions><span style=display:none><strong>✓</strong></span></div><a href=# onclick="return server_showVersionDlg()">检查服务器版本</a></div><div id=p2ServerActionsErrors><div class=p2AccountActions><span style=display:none><strong>✓</strong></span></div><a href=# onclick="return server_showErrorsDlg()">显示服务器错误日志</a></div><div id=p2ServerActionsConfig><div class=p2AccountActions><span style=display:none><strong>✓</strong></span></div><a href=# onclick="return server_showConfigDlg()">Show server configuration</a></div></div><br></div><strong>服务器统计</strong><br><br><div id=serverStats><div id=serverCpuChartView style=display:none><div class=chartViewCanvas style=height:40px;text-align:center><canvas id=serverCpuChart style=display:inline-block></canvas></div><div class=chartViewText id=serverCpuChartText></div></div><div id=serverMemoryChartView style=display:none><div class=chartViewCanvas style=height:40px;text-align:center><canvas id=serverMemoryChart style=display:inline-block></canvas></div><div class=chartViewText id=serverMemoryChartText></div></div><br><br><div id=serverStatsTable></div></div><div id=serverWarningsDiv style=display:none><br><strong>服务器警告</strong><br><br><div id=serverCertWarnings></div><div id=serverWarnings></div></div></div></div><div id=p10 style=display:none><div id=p10title><div id=p10BackButton><div class=backButton tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'><div class=backButtonEx></div></div></div><h1>一般 - <span id=p10deviceName></span></h1></div><div id=p10info style=overflow-y:auto><table style=width:100% cellpadding=0 cellspacing=0><tr><td style=width:auto valign=top><div id=p10html></div><td style=width:100px;display:none id=notesPanel valign=top><table><thead><tr><th>笔记<tbody><tr><td><div id=notesPanelArea style=width:300px;height:200px;resize:none;overflow-y:scroll></div></table><td style=width:20px><td style=width:200px;vertical-align:top;position:relative valign=top><div class=deviceNotifyLargeDot><div id=p10deviceMsg onclick=showDeviceMessages(null,null,event) class=deviceNotifyDotSub></div><img id=p10deviceStar class=deviceNotifyDotSub src=images/icon-star-notify-16.png width=16 height=16> <img id=p10deviceNotify onclick=showDeviceSessions(null,null,event) class=deviceNotifyDotSub src=images/icon-relay-notify.png width=16 height=16> <img id=p10deviceHelp onclick=showDeviceHelpRequests(null,null,event) class=deviceNotifyDotSub src=images/icon-help-notify-16.png width=16 height=16></div><div id=p10deviceBattery class="deviceBatteryLarge deviceBatteryLarge1"></div><a href=# onclick=p10showiconselector()><img id=MainComputerImage></a><div id=MainComputerState></div></table><br><div id=p10html2></div><div id=p10html3></div><div id=p10html4></div><div id=p10html5></div></div></div><div id=p11 class=noselect style=display:none><div id=p11title><div id=p11deviceNameHeader><div id=p11BackButton><div class=backButton tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'><div class=backButtonEx></div></div></div><div id=devListToolbarViewIcons><div class=viewSelector onclick=deskToggleFull(event) title=全屏。按住shift键更改为全屏浏览器。><div class=viewSelector5></div></div></div><h1>桌面 - <span id=p11deviceName></span></h1></div></div><div id=p11warning onclick=showFeaturesDlg()><div class=icon2></div><div class=warningbox>重定向端口或 KVM 功能已禁用<span id=p11warninga>，请点击此处启用它。</span></div></div><div id=p11warning2 onclick=showPowerActionDlg()><div class=icon2></div><div class=warningbox>远程计算机未打开电源，请单击此处以发出电源命令。</div></div><div style=position:absolute;right:16px;margin-top:-14px;font-size:x-small;color:#000><div id=p11capslock style=display:inline-block;margin-left:1px;border-radius:5px;background-color:#a3ffb8;padding:2px>大写字母</div><div id=p11scrolllock style=display:inline-block;margin-left:1px;border-radius:5px;background-color:#a3ffb8;padding:2px>滚动</div><div id=p11numlock style=display:inline-block;margin-left:1px;border-radius:5px;background-color:#a3ffb8;padding:2px>NUM</div></div><div id=deskarea0 cellpadding=0 cellspacing=0><div id=deskarea1 class=areaHead><div class=toright2><div id=idx_deskFullBtn2 onclick=deskToggleFull(event) style=float:right>&nbsp;✖</div><span id=p11power></span>&nbsp;<div class=deskareaicon title=切换查看模式 onclick=toggleAspectRatio(1)>⇲</div><div class=deskareaicon title=向左旋转 onclick=drotate(-1)>↺</div><div class=deskareaicon title=向右旋转 onclick=drotate(1)>↻</div><div id=deskRecordIcon class=deskareaicon title=服务器正在记录此节 style=display:none;background-color:red;width:12px;height:12px;border-radius:6px;margin-top:5px></div><input id=deskFocusBtn type=button title=切换焦点模式，现用中仅更新鼠标周围的区域 onkeypress=return!1 onkeydown=return!1 value=全部关注 onclick=deskToggleFocus() style=margin-right:3px;display:none> <input id=deskActionsBtn type=button title=在设备上执行电源操作 onkeypress=return!1 onkeydown=return!1 value=动作 onclick=deviceActionFunction() class=mR> <input id=deskActionsSettings type=button value=设定... title=编辑远程桌面设置 onkeypress=return!1 onkeydown=return!1 onclick=showDesktopSettings() class=mR> <input type=button title=更改远程机器的电源状态 onkeypress=return!1 onkeydown=return!1 value=电源指令... onclick=showPowerActionDlg() style=display:none><div id=desktopCustomUpperRight style=float:left;margin-right:6px></div><div id=desktopCustomUiButtons style=float:left></div></div><div><input type=button id=autoconnectbutton1 value=自动连接 onclick=autoConnectDesktop(event) onkeypress=return!1 onkeydown=return!1 style=display:none;margin-right:4px> <span id=connectbutton1span><input type=button id=connectbutton1 cmenu=deskConnectButton title="使用 MeshAgent 远程桌面连接"value=连接 onclick=connectDesktop(event,3) onkeypress=return!1 onkeydown=return!1 disabled></span><span id=connectbutton1rspan><input type=button id=connectbutton1r cmenu=altPortContextMenu value="RDP 连接"title="使用 RDP 连接"onclick=askRdpCredentials() onkeypress=return!1 onkeydown=return!1 disabled></span><span id=connectbutton1hspan><input type=button id=connectbutton1h value=硬件连接 title="使用硬件 KVM 连接"onclick=connectDesktop(event,2) onkeypress=return!1 onkeydown=return!1 disabled></span><span id=disconnectbutton1span><input type=button id=disconnectbutton1 cmenu=deskDisconnectButton value=断线 onclick=connectDesktop(event,0) onkeypress=return!1 onkeydown=return!1></span><span id=deskstatus style=line-height:22px>已断线</span><span id=deskmetadata></span></div></div><div id=deskarea3x><div id=p11bigok style=display:none><b>✓</b></div><div id=p11bigfail style=display:none><b>✗</b></div><div id=DeskFocus oncontextmenu=return!1 onmousedown=dmousedown(event) onmouseup=dmouseup(event) onmousemove=dmousemove(event)></div><div id=DeskParent><canvas id=Desk width=640 height=480 oncontextmenu=return!1 onmousedown=dmousedown(event) onmouseup=dmouseup(event) onmousemove=dmousemove(event) onmousewheel=dmousewheel(event)></canvas></div><div id=DeskTools><div id=deskToolsAreaTop><a id=DeskToolsRefreshButton style=right:2px onclick=refreshDeskTools()>刷新</a><div id=deskToolsTopTabProcess class=deskToolsTopTab onclick=changeDeskToolTab(0) style=left:0;bottom:0>进程</div><div id=deskToolsTopTabService class=deskToolsTopTab onclick=changeDeskToolTab(1) style=display:none;left:90px;color:gray>服务</div></div><div id=deskToolsArea><div id=DeskToolsProcessTab><div id=deskToolsHeader><a class=colmn1 title=按进程ID排序 onclick=sortProcess(0)>PID</a> <a class=colmn2 title=按名称排序 onclick=sortProcess(1)>名称</a></div><div id=DeskToolsProcesses></div></div><div id=DeskToolsServiceTab style=display:none><div id=deskToolsServiceHeader><a class=colmn1 style=width:70px title=按状况排序 onclick=sortService(0)>状况</a> <a class=colmn2 title=按名称排序 onclick=sortService(1)>名称</a></div><div id=DeskToolsServices></div></div></div></div><div id=p11DeskConsoleMsg style=display:none;text-align:left;cursor:pointer;position:absolute;left:30px;top:17px;color:#ff0;background-color:rgba(0,0,0,.6);padding:10px;border-radius:5px;text-align:left onclick=p11clearConsoleMsg()></div><div id=p11DeskSessionSelector style=display:none;position:absolute;left:30px;top:17px;right:30px;bottom:17px;overflow-y:auto></div></div><div id=deskarea4 class=areaFoot><div class=toright2><span id=DeskLatency style=line-height:22px;width:50px title=桌面会话延迟></span> <span id=DeskTimer style=line-height:22px title=会话时间></span> <input id=DeskToolsButton type=button value=工具 title=切换工具视图 onkeypress=return!1 onkeydown=return!1 onclick=toggleDeskTools()> <span>&nbsp;</span> <span id=DeskRunButton cmenu=deskPreConfigScriptContextMenu class=deskarea title="Run a script on this computer"><img class=desktopButtons src=images/icon-play.png onclick=runDeviceCmd() height=16 width=16 style=padding-top:2px></span><span id=DeskChatButton class=deskarea title=打开此计算机的聊天窗口><img class=desktopButtons src=images/icon-chat.png onclick=deviceChat(event) height=16 width=16 style=padding-top:2px></span><span id=DeskNotifyButton title=在远程计算机上显示通知><img class=desktopButtons src=images/icon-notify.png onclick=deviceToastFunction() height=16 width=16 style=padding-top:2px></span><span id=DeskLockButton title=锁定远程计算机><img src=images/icon-lock.png class=desktopButtons onclick=deviceLockFunction() height=16 width=16></span><span id=DeskOpenWebButton title=在远程计算机上打开一个网址><img class=desktopButtons src=images/icon-url2.png onclick=deviceUrlFunction() height=16 width=16></span><span id=DeskBackgroundButton title=切换远程桌面背景><img class=desktopButtons id=DeskBackgroundButtonImage src=images/icon-background.png onclick=deviceToggleBackground(event) height=16 width=16></span><span id=DeskSaveImageButton title=保存远程桌面的屏幕截图><img class=desktopButtons src=images/icon-camera.png onclick=deskSaveImage() height=16 width=16></span><span id=DeskRecordButton cmenu=deskPlayerContextMenu title=将远程桌面会话记录到文件 style=display:none><img class=desktopButtons id=DeskRecordButtonImage src=images/icon-film.png onclick=deskRecordSession() height=16 width=16></span><span id=DeskClipboardInButton title=将远程剪贴板下载到本地剪贴板 style=display:none><img class=desktopButtons id=DeskClipboardInButtonImage src=images/icon-clipboard-in.png onclick=deskClipboardInFunction() height=16 width=16></span><span id=DeskClipboardOutButton title=将本地剪貼板上传到远程设备><img class=desktopButtons id=DeskClipboardOutButtonImage src=images/icon-clipboard-out.png onclick=deskClipboardOutFunction() height=16 width=16></span><span id=DeskRefreshButton title=刷新桌面><img class=desktopButtons id=DeskRefreshButtonImage src=images/icon-refresh.png onclick=deskRefreshFunction() height=16 width=16></span><span id=DeskInputLockedButton title=远程输入被锁定><img class=desktopButtons id=DeskInputLockedButtonImage src=images/icon-keylock-red.png onclick=deskInputLockFunction(0) height=16 width=16></span><span id=DeskInputUnLockedButton title=远程输入解锁><img class=desktopButtons id=DeskInputUnLockedButtonImage src=images/icon-keylock.png onclick=deskInputLockFunction(1) height=16 width=16></span><span id=DeskGuestShareButton title=与访客共享设备><img class=desktopButtons id=DeskGuestShareButtonImage src=images/icon-share2.png onclick=showShareDevice() height=16 width=16></span></div><div class=toright2><span id=DeskMonitorSelectionSpan></span></div><div><select id=deskkeys cmenu=deskKeyShortcutContextMenu></select> <input id=DeskWD type=button value=发送 onkeypress=return!1 onkeydown=return!1 onclick=deskSendKeys()> <input id=DeskESC style=display:none type=button value=ESC onkeypress=return!1 onkeydown=return!1 onclick=sendDeskEsc()> <input id=DeskClip type=button value=剪贴板 onkeypress=return!1 onkeydown=return!1 onclick=showDeskClip()> <input id=DeskType cmenu=deskPreConfigShortcutContextMenu type=button value=类型 onkeypress=return!1 onkeydown=return!1 onclick=showDeskType()> <label><span id=DeskControlSpan title=切换鼠标和键盘输入><input id=DeskControl type=checkbox onkeypress=return!1 onkeydown=return!1 onclick=toggleKvmControl()>输入</span></label>&nbsp;</div></div></div></div><div id=p12 style=display:none><div id=p12title><div id=p12BackButton><div class=backButton tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'><div class=backButtonEx></div></div></div><div id=devListToolbarViewIcons2 style=float:right><div class=viewSelector onclick=deskToggleFull(event) title=全屏。按住shift键更改为全屏浏览器。><div class=viewSelector5></div></div></div><h1>终端 - <span id=p12deviceName></span></h1></div><div id=p12warning onclick=showFeaturesDlg()><div class=icon2></div><div class=warningbox>重定向端口或 KVM 功能已禁用<span id=p12warninga>，请点击此处启用它。</span></div></div><div id=p12warning2 onclick=showPowerActionDlg()><div class=icon2></div><div class=warningbox>远程计算机未打开电源，请单击此处以发出电源命令。</div></div><div id=termTable style=position:relative><table style=width:100% cellpadding=0 cellspacing=0><tr><td class=areaHead style=line-height:22px><div class=toright2><div id=idx_termFullBtn2 onclick=deskToggleFull(event) style=float:right>&nbsp;✖</div><div id=termRecordIcon class=deskareaicon title=服务器正在记录此节 style=display:none;background-color:red;width:12px;height:12px;border-radius:6px;margin-top:5px;margin-left:5px></div><input id=termActionsBtn type=button title=在设备上执行电源操作 onkeypress=return!1 onkeydown=return!1 value=动作 onclick=deviceActionFunction()><div id=terminalCustomUpperRight style=float:left;margin-right:6px></div><div id=terminalCustomUiButtons style=float:left></div></div><div><input type=button id=autoconnectbutton2 value=自动连接 onclick=autoConnectTerminal(event) onkeypress=return!1 onkeydown=return!1 style=display:none><span id=connectbutton2span style=margin-right:4px><input type=button id=connectbutton2 cmenu=termConnectButton value=连接 onclick=connectTerminal(event,1) onkeypress=return!1 onkeydown=return!1 disabled></span><span id=connectbutton2sspan style=margin-right:4px><input type=button id=connectbutton2s cmenu=sshPortContextMenu value="SSH 连接"onclick=connectTerminal(event,3) onkeypress=return!1 onkeydown=return!1 disabled></span><span id=connectbutton2hspan style=margin-right:4px><input type=button id=connectbutton2h value=硬件连接 title=使用英特尔®AMT硬件KVM连接 onclick=connectTerminal(event,2) onkeypress=return!1 onkeydown=return!1 disabled></span><span id=disconnectbutton2span style=margin-right:4px><input type=button id=disconnectbutton2 value=断线 onclick=connectTerminal(event,0) onkeypress=return!1 onkeydown=return!1></span><span id=termstatus style=line-height:22px>已断线</span><span id=termtitle></span></div><tr><td id=termarea3x><div id=termarea3xdiv style=width:100%;height:100%;text-align:left></div><pre id=Term></pre><tr><td class=areaFoot><div class=toright2><span id=TermTimer title=会话时间></span>&nbsp; <span id=terminalSettingsButtons style=display:none><input id=id_tcrbutton type=button onkeypress=return!1 onkeydown=return!1 class=bottombutton value=CR+LF title=切换返回键将发送的内容 onclick=termToggleCr()> <input id=id_tfxkeysbutton type=button onkeypress=return!1 onkeydown=return!1 class=bottombutton value="英特尔（F10 = ESC + [OM）"title=切换F1至F10键仿真类型 onclick=termToggleFx()> <input id=id_ttypebutton type=button onkeypress=return!1 onkeydown=return!1 class=bottombutton value=扩充式ASCII title=切换终端仿真类型 onclick=termToggleType()> </span><span id=terminalSizeDropDown style=display:none><select id=termSizeList onkeypress=return!1><option value=1>80x25<option value=2>100x30</select> </span><span id=specialKeyDropDown><select id=specialkeylist onkeypress=return!1></select> <input id=specialkeylistinput type=button onkeypress=return!1 class=bottombutton value=发送 title=发送选定的特殊键 onclick=sendSpecialKey()></span></div><div>&nbsp; <input type=button onkeypress=return!1 onkeydown=return!1 class=bottombutton id=ctrlcbutton value=Ctl-C onclick='termSendKey(3,"ctrlcbutton")'> <input type=button onkeypress=return!1 onkeydown=return!1 class=bottombutton id=ctrlxbutton value=Ctl-X onclick='termSendKey(24,"ctrlxbutton")'> <input type=button onkeypress=return!1 onkeydown=return!1 class=bottombutton id=escbutton value=ESC onclick='termSendKey(27,"escbutton")'> <input type=button onkeypress=return!1 onkeydown=return!1 class=bottombutton id=bsbutton value=退格键 onclick='termSendKey(8,"bsbutton")'style=display:none> <input type=button onkeypress=return!1 onkeydown=return!1 class=bottombutton id=pastebutton value=粘贴 title=将文本粘贴到终端中 onclick=showTermPasteDialog() style=display:none></div></table><div id=p12TermConsoleMsg style=display:none;text-align:left;cursor:pointer;position:absolute;left:30px;top:45px;color:#ff0;background-color:rgba(0,0,0,.6);padding:10px;border-radius:5px onclick=p12clearConsoleMsg()></div></div></div><div id=p13 style=display:none><div id=p13title><div id=p13BackButton style=float:left><div class=backButton tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'><div class=backButtonEx></div></div></div><h1>档案- <span id=p13deviceName></span></h1></div><table id=p13toolbar cellpadding=0 cellspacing=0><tr><td class=areaHead style=line-height:22px><div class=toright2><input id=filesActionsBtn type=button title=在设备上执行电源操作 value=动作 onclick=deviceActionFunction()><div id=filesRecordIcon class=deskareaicon title=服务器正在记录此节 style=display:none;background-color:red;width:12px;height:12px;border-radius:6px;margin-top:5px;margin-left:5px></div><div id=filesCustomUpperRight style=float:left;margin-right:6px></div><div id=filesCustomUiButtons style=float:left></div></div><div><input id=p13AutoConnect value=自动连接 onclick=autoConnectFiles(event) type=button style=display:none> <input id=p13Connect value=连接 cmenu=filesConnectButton onclick=connectFiles(event,1) type=button> <input id=p13Disconnect value=断线 onclick=connectFiles(event) type=button> <input id=p13Connects value="SFTP 连接"cmenu=sshPortContextMenu onclick=connectFiles(event,2) type=button> <span id=p13Status>已断线</span></div><tr><td class=areaHead2 valign=bottom><div id=p13rightOfButtons class=toright2></div><div><input type=button style=margin-right:2px disabled id=p13FolderUp value=上 onclick=p13folderup()> <input type=button style=margin-right:2px disabled id=p13SelectAllButton value=全选 onclick=p13selectallfile()> <input type=button style=margin-right:2px disabled id=p13RenameFileButton value=改名 onclick=p13renamefile()> <input type=button style=margin-right:2px disabled id=p13DeleteFileButton value=删除 onclick=p13deletefile()> <input type=button style=margin-right:2px disabled id=p13ViewFileButton value=编辑 onclick=p13viewfile()> <input type=button style=margin-right:2px disabled id=p13NewFolderButton value=新建文件夹 onclick=p13createfolder()> <input type=button style=margin-right:2px disabled id=p13UploadButton value=上传 onclick=p13uploadFile()> <input type=button style=margin-right:2px disabled id=p13DownloadButton value=下载 onclick=p13downloadButton()> <input type=button style=margin-right:2px disabled id=p13CutButton value=剪切 onclick=p13copyFile(1)> <input type=button style=margin-right:2px disabled id=p13CopyButton value=复制 onclick=p13copyFile(0)> <input type=button style=margin-right:2px disabled id=p13PasteButton value=粘贴 onclick=p13pasteFile()> <input type=button style=margin-right:2px disabled id=p13ZipButton value=Zip onclick=p13zipFiles()> <input type=button style=margin-right:2px disabled id=p13UnzipButton value=Unzip onclick=p13unzipFile()> <input type=button style=margin-right:2px disabled id=p13RefreshButton value=刷新 onclick=p13folderup(9999)> <input type=button style=margin-right:2px disabled id=p13FindButton value=找 onclick=p13findfile()> <input type=button style=margin-right:2px disabled id=p13GoToFolderButton value=GoTo onclick=p13gotofolder()> <input type=button style=margin-right:2px disabled id=p13OpenButton value=Open onclick=p13openfilefolder()></div><tr><td class=areaHead3><div class=toright2><select id=p13sizedropdown onchange=p13updateFiles()><option value=0 selected>Human Readable<option value=1 title=Bytes>Bytes<option value=10 title=KB>Kilobytes<option value=20 title=MB>Megabyte<option value=30 title=GB>Gigabyte</select> <select id=p13sortdropdown onchange=p13updateFiles()><option value=1 selected>按名称排序<option value=2>按大小排序<option value=3>按日期排序<option value=4>按名称降序<option value=5>按大小降序<option value=6>按日期降序</select></div><div>&nbsp;&nbsp;<span id=p13currentpath></span></div></table><div id=p13FilesConsoleMsg style=display:none;text-align:left;cursor:pointer;position:absolute;left:30px;top:165px;color:#ff0;background-color:rgba(0,0,0,.6);padding:10px;border-radius:5px onclick=p13clearConsoleMsg()></div><div id=p13filetable><div id=p13bigok style=display:none><b>✓</b></div><div id=p13bigfail style=display:none><b>✗</b></div><span id=p13files></span></div><table id=p13toolbarBottom cellpadding=0 cellspacing=0><tr><td class=style6>&nbsp;<span id=p13bottomstatus></span></table></div><div id=p14 style=display:none><div id=p14title><div id=p14BackButton style=float:left><div class=backButton tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'><div class=backButtonEx></div></div></div><div id=devListToolbarViewIcons><div class=viewSelector onclick=deskToggleFull(event) title=全屏。按住shift键更改为全屏浏览器。><div class=viewSelector5></div></div></div><h1><span id=p14deviceNamePrefix>英特尔®AMT</span> - <span id=p14deviceName></span></h1></div><iframe id=p14iframe src={{{domainurl}}}commander.ashx></iframe></div><div id=p15 style=display:none><div id=p15title><div id=p15BackButton style=float:left><div class=backButton tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'><div class=backButtonEx></div></div></div><h1><span id=p15deviceName></span></h1></div><table id=consoleTable cellpadding=0 cellspacing=0><tr><td class=areaHead><div class=toright2><div id=p15coreName title=有关在此代理上运行的当前核心的信息></div><input type=button id=p15uploadCore value=代理指令 onclick=p15uploadCore(event) title=更改代理的Java脚本代码模块> <img onclick=p15downloadConsoleText() style=cursor:pointer;margin-top:6px title=下载控制台文字 src=images/link4.png></div><div id=p15statetext></div><tr><td><div class=areaProgress><div id=consoleprogressbar></div></div><tr><td id=p15agentConsole><pre id=p15agentConsoleText></pre><tr><td class=areaFoot><table style=width:100%><tr><td style=width:99%><input id=p15consoleText style=width:100% onkeyup=p15consoleSend(event) onfocus=onConsoleFocus(1) onblur=onConsoleFocus(0)><td>&nbsp;<td id=p15outputselecttd><select id=p15outputselect onchange=setupConsole()><option id=p15outputselect1 value=1>代理<option id=p15outputselect3 value=3>推<option id=p15outputselect2 value=2>MQTT</select><td style=width:1%><input id=id_p15consoleClear type=button class=bottombutton value=清除 onclick=p15consoleClear()></table></table></div><div id=p16 style=display:none><div id=p16title><div id=p16BackButton style=float:left><div class=backButton tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'><div class=backButtonEx></div></div></div><h1>事件- <span id=p16deviceName></span></h1></div><table class=pTable><tr><td class=h1><td class=auto-style1>过滤 <select id=p16filterevents onchange=refreshDeviceEvents()><option notransval=1 value="">All Logs<option notransval=1 value=agentlog>Agent Logs<option notransval=1 value=relaylog>Relay Logs<option notransval=1 value=manual>Manual Logs<option notransval=1 value=runcommands>Run Command Logs<option notransval=1 value=batchupload>Batch Upload Logs<option notransval=1 value=changenode>Change Node Logs<option notransval=1 value=removenode>Remove Node Logs</select> 显示 <select id=p16limitdropdown onchange=refreshDeviceEvents()><option notransval=1 value=60>最后60<option notransval=1 value=120>最后120<option notransval=1 value=250>最后250<option notransval=1 value=500>最后500<option notransval=1 value=1000>最后1000</select> <a href=# onclick=p3showDownloadEventsDialog(1)><img src=images/link4.png height=10 width=10 title=下载事件 style=cursor:pointer></a>&nbsp;<td class=h2></table><div id=p16events></div></div><div id=p17 style=display:none;margin-left:-18px><div id=p17title style=margin-left:18px><div id=p17BackButton style=float:left><div class=backButton tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'><div class=backButtonEx></div></div></div><div id=devListToolbarViewIcons3><div class=viewSelector onclick=deskToggleCpuGraph(event) title=显示设备的CPU和内存使用情况。><div class=viewSelector6></div></div></div><h1>细节 - <span id=p17deviceName></span></h1></div><div id=p17info style=overflow-y:auto><div id=p17graph style=width:100%><table style=width:100%><tr><td style=width:64px;vertical-align:top><img src=images/details/graph64.png border=0 width=64><td><div class=DevSt style=margin-bottom:3px;margin-left:16px><b>实时图表</b></div><div style="margin-bottom:10px;margin-left:16px;height:240px;width:calc(100% - 16px);position:relative"><canvas id=deviceDetailsStats style=position:absolute;top:0;left:0;right:0;bottom:0></canvas></div><div id=extraGraphValues style=display:none;margin-left:30px;margin-bottom:15px></div></table></div><div id=p17info2></div></div></div><div id=p19 style=display:none><div id=p19title><div id=p19BackButton style=float:left><div class=backButton tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'><div class=backButtonEx></div></div></div><h1>插件- <span id=p19deviceName></span></h1></div><div id=p19headers></div><div id=p19pages></div></div><div id=p20 style=display:none><div id=p20main style=overflow-y:auto><div id=p20title><picture id=MainMeshImage style=border-width:0;height:200px;width:200px;float:right><source type=image/webp width=200 height=200 srcset=images/webp/mesh-256.webp><img alt=""width=200 height=200 src=images/mesh-256.png></picture><div style=float:left><div class=backButton tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'><div class=backButtonEx></div></div></div><h1>一般 - <span id=p20meshName></span></h1></div><p id=p20info><p id=p20info2></div></div><div id=p21 style=display:none><div id=p21title><div style=float:left><div class=backButton tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'><div class=backButtonEx></div></div></div><h1>摘要- <span id=p21meshName></span></h1></div><div id=p21main style=overflow-y:auto><div style=width:100%><div style=display:table;width:93%><div id=meshPowerChartDiv style=width:23%;display:inline-block;text-align:center;max-width:250px><div style=margin:10px;font-size:16px>电源状态</div><canvas id=meshPowerChart style=width:250px;height:250px></canvas></div><div id=meshOsChartDiv style=width:23%;display:inline-block;text-align:center;max-width:250px><div style=margin:10px;font-size:16px>代理类型</div><canvas id=meshOsChart style=width:250px;height:250px></canvas></div><div id=meshConnChartDiv style=width:23%;display:inline-block;text-align:center;max-width:250px><div style=margin:10px;font-size:16px>连接性</div><canvas id=meshConnChart style=width:250px;height:250px></canvas></div><div id=meshSecurityChartDiv style=width:23%;display:inline-block;text-align:center;max-width:250px><div style=margin:10px;font-size:16px>安全</div><canvas id=meshSecurityChart style=width:250px;height:250px></canvas></div></div></div><p id=p21info style=overflow-y:auto></div></div><div id=p30 style=display:none><div id=p30title><div style=float:left><div class=backButton tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'><div class=backButtonEx></div></div></div><h1>一般 - <span id=p30userName></span></h1></div><div id=p30info style=overflow-y:auto><table style=width:100% cellpadding=0 cellspacing=0><tr><td style=width:auto valign=top><div id=p30html></div><td style=width:20px><td style=width:200px;position:relative valign=top><img id=p30userAuthServiceLogo loading=lazy style=display:none class=userAuthStrategyLogo width=64 height=64><picture id=MainUserImage style=display:none;border-width:0;height:200px;width:200px;float:right onclick=account_manageImage(1)><source type=image/webp width=200 height=200 srcset=images/webp/user-256.webp><img alt=""width=200 height=200 src=images/user-256.png></picture><img id=MainUserImageEx alt=""width=200 height=200 src=images/user-256.png onclick=account_manageImage(1)><div style=width:100%;text-align:center><strong><span id=MainUserState></span></strong></div></table><br><div id=p30html2></div><div id=p30html3></div></div></div><div id=p31 style=display:none><div id=p31title><div style=float:left><div class=backButton tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'><div class=backButtonEx></div></div></div><h1>事件- <span id=p31userName></span></h1></div><table class=pTable><tr><td class=h1><td class=auto-style1>过滤 <select id=p31filterevents onchange=refreshUsersEvents()><option notransval=1 value="">All Logs<option notransval=1 value=agentlog>Agent Logs<option notransval=1 value=relaylog>Relay Logs<option notransval=1 value=manual>Manual Logs<option notransval=1 value=runcommands>Run Command Logs<option notransval=1 value=batchupload>Batch Upload Logs<option notransval=1 value=changenode>Change Node Logs<option notransval=1 value=removenode>Remove Node Logs</select> 显示 <select id=p31limitdropdown onchange=refreshUsersEvents()><option notransval=1 value=60>最后60<option notransval=1 value=120>最后120<option notransval=1 value=250>最后250<option notransval=1 value=500>最后500<option notransval=1 value=1000>最后1000<option notransval=1 value="">没有限制</select> <a href=# onclick=p3showDownloadEventsDialog(3)><img src=images/link4.png height=10 width=10 title=下载事件 style=cursor:pointer></a>&nbsp;<td class=h2></table><div id=p31events></div></div><div id=p40 style=display:none><div id=p40title><h1>我的服务器统计</h1></div><div class=areaHead><div class=toright2><select id=p40server style=display:none onchange=updateServerTimelineStats()></select>&nbsp; <select id=p40type onchange=updateServerTimelineStats()><option value=0>连接<option value=1>内存<option value=5>CPU<option value=3>入站流量<option value=4>出站流量</select>&nbsp; <select id=p40time onchange=updateServerTimelineHours()><option value=3>过去3小时<option value=8>过去8小时<option value=24>最后一天<option value=168>上个星期<option value=720>过去30天</select>&nbsp; <img src=images/link4.png height=10 width=10 title=下载数据点（.csv） style=cursor:pointer onclick=p40downloadEvents()>&nbsp;</div><div><input value=刷新 type=button onclick=refreshServerTimelineStats()> &nbsp;<label><input id=p40log type=checkbox onclick=updateServerTimelineHours()>Log-X</label></div></div><canvas id=serverMainStats></canvas></div><div id=p41 style=display:none><div id=p41title><h1>我的服务器跟踪</h1></div><div class=areaHead><div class=toright2>显示 <select id=p41limitdropdown onchange=displayServerTrace()><option value=100>最后100<option value=250>最后250<option value=500>最后500<option value=1000>最后1000</select> <input value=清除 type=button onclick=clearServerTracing()> <img src=images/link4.png height=10 width=10 title=下载跟踪（.csv） style=cursor:pointer onclick=p41downloadServerTrace()>&nbsp;</div><div><input value=追踪中 type=button onclick=setServerTracing()> <span id=p41traceStatus>没有</span></div></div><div id=p41events></div></div><div id=p42 style=display:none><h1>我的服务器插件</h1><div class=areaHead><div class=toright2></div><div><input value=下载插件 type=button onclick="return pluginHandler.addPluginDlg()"></div></div><div id=pluginRestartNotice class=areaHead style=background-color:gold;display:none><div class=toright2><input value=刷新代理核心 type=button onclick="return distributeCore(),!1"></div><div style=padding:2px><div style=padding:2px><b>注意：</b> 插件已更改，这可能需要代理核心更新。</div></div></div><table id=p42tbl><tr class=DevSt><th style=width:26px><th style=width:10px><th class=chName>名称<th class=chDescription>描述<th class=chSite style=text-align:center>连结<th class=chVersion style=text-align:center>版本<th class=chUpgradeAvail style=text-align:center>最新<th class=chStatus style=text-align:center>状况<th class=chAction style=text-align:center>指令<th style=width:10px></table><div id=pluginNoneNotice style=width:100%;text-align:center;padding-top:10px;display:none><i>服务器上没有插件。</i></div></div><div id=p43 style=display:none><div id=p43BackButton><div class=backButton tabindex=0 onmouseup=go(42) title=返回 onkeypress='"Enter"==event.key&&go(42)'><div class=backButtonEx></div></div></div><h1>我的服务器插件- <span id=p43title></span></h1><iframe id=p43iframe frameborder=0 style="width:100%;height:calc(100vh - 245px);max-height:calc(100vh - 245px)"></iframe></div><div id=p50 style=display:none><div id=p50title><h1>我的用户组</h1></div><table class=pTable><tr><td class=h1><td class=style14><div style=float:right></div><div id=p50userGroupOps><input type=button id=UsersGroupsSelectAllButton onclick=p50usersSelectallButtonFunction() value=全选> <input type=button id=UsersGroupsGroupActionButton disabled value=集体指令 onclick=p50usersGroupActionFunction()> <input id=NewUserGroupButton type=button onclick=showCreateUserGroupDialog(1) value=新组...> <input id=DuplicateUserGroupButton type=button style=display:none onclick=showCreateUserGroupDialog(2) value=复制群组...></div><td class=h2></table><div id=p50groups></div></div><div id=p51 style=display:none><div id=p51title><div style=float:left><div class=backButton tabindex=0 onclick=goBack() title=返回 onkeypress='"Enter"==event.key&&goBack()'><div class=backButtonEx></div></div></div><h1>用户组- <span id=p51groupName></span></h1></div><div id=p51info style=overflow-y:auto><table style=width:100% cellpadding=0 cellspacing=0><tr><td style=width:auto valign=top><div id=p51group></div><td style=width:20px><td style=width:200px valign=top><picture id=MainUserImage style=border-width:0;height:200px;width:200px;float:right><source type=image/webp width=200 height=200 srcset=images/webp/group-256.webp><img alt=""width=200 height=200 src=images/group-256.png></picture><div style=width:100%;text-align:center><strong><span id=MainUserState></span></strong></div></table><div id=p51group2></div><br></div></div><div id=p52 style=display:none><div id=p52title><h1>我的用户记录</h1></div><table class=pTable><tr><td class=h1><td class=style14><div style=float:right><input type=button onclick=openRecodringPlayer() value=打开播放器...></div><div><input type=button onclick=refreshRecodings() value=刷新></div><td class=h2></table><div id=p52recordings style=overflow-y:auto></div></div><div id=p60 style=display:none><div id=p60title><h1>我的报告</h1></div><table class=pTable><tr><td class=h1><td class=style14><div style=float:right;line-height:22px><a id=p60downloadReportDiv style=display:none href=# onclick=p60downloadReport()><img src=images/link4.png height=10 width=10 title=下载报告 style=cursor:pointer></a>&nbsp;</div><div><input type=button onclick=generateReportDialog() value=生成报告...></div><td class=h2></table><div id=p60report style=overflow-y:auto></div></div><br id=column_l_bottomgap></div><div id=footer><div class=footer1>{{{footer}}}</div><div class=footer2><a id=verifyEmailId2 style=display:none href=# onclick=account_showVerifyEmail()>验证电邮</a> &nbsp;<a id=termsLinkFooter href=terms>条款和隐私</a></div></div><div id=dialog class=noselect style=display:none><div id=dialogHeader><div tabindex=0 id=id_dialogclose onclick=setDialogMode() onkeypress='"Enter"==event.key&&setDialogMode()'>✖</div><div id=id_dialogtitle></div></div><div id=dialogBody><div id=dialog1><div id=id_dialogMessage></div></div><div id=dialog2><div id=id_dialogOptions></div></div><div id=dialog3><div id=d3upload><div>档案选择</div><select id=d3uploadMode onchange=d3modechange()><option value=1>本地档案上传<option value=2>服务器档案选择</select></div><div id=d3localmode style=display:none><div>上传文件</div><form id=d3localmodeform method=post enctype=multipart/form-data action=uploadfile.ashx target=fileUploadFrame><input id=d3auth name=auth style=display:none> <input id=d3filter name=filter style=display:none> <input id=d3attrib name=attrib style=display:none> <input type=file id=d3localFile name=files onchange=d3setActions()> <input type=submit id=d3submit style=display:none></form></div><div id=d3servermode><div id=d3serveraction valign=bottom><input type=button id=p3FolderUp disabled onclick=d3folderup() value=上>&nbsp;<span id=p3CurrentFolder></span></div><div id=d3serverfiles></div></div></div><div id=dialog4><input id=d4WrapButton type=button value=换行 onclick=d4ToggleWrap()> <input id=d4SizeButton type=button value=小 onclick=d4ToggleSize()> <input id=d4EncodingButton type=button value=生的 onclick=d4ToggleEncoding()> <input id=d4LineBreakButton type=button value=Windows onclick=d4ToggleLineBreak()> <textarea id=d4editorarea autocomplete=off style="height:calc(100vh - 286px);width:100%;overflow:scroll;resize:none;white-space:pre"></textarea></div><div id=dialog7><div class=dtab><button id=td7meshkvm class=tablinks onclick='changeDesktopSettingsTab(event,"d7meshkvm")'>代理</button> <button id=td7rdpkvm class=tablinks onclick='changeDesktopSettingsTab(event,"d7rdpkvm")'>RDP</button> <button id=td7amtkvm class=tablinks onclick='changeDesktopSettingsTab(event,"d7amtkvm")'>英特尔®AMT</button></div><div id=d7meshkvm class=tabcontent><div style=margin-top:8px><div>质量</div><select id=d7bitmapquality dir=rtl></select></div><div><div>缩放比例</div><select id=d7bitmapscaling dir=rtl><option selected value=1024>100％<option value=896>87.5%<option value=768>75%<option value=640>62.5%<option value=512>50%<option value=384>37.5%<option value=256>25%<option value=128>12.5%</select></div><div><div>贞速率</div><select id=d7framelimiter dir=rtl><option selected value=50>快速<option value=100>中<option value=400>慢<option value=1000>非常慢</select></div><div><div>编码</div><select id=d7encoding dir=rtl><option value=1>JPEG<option value=2>PNG<option value=3>TIFF<option selected value=4>WEBP</select></div><div id=d7desktopOtherSettings><div>其他设定</div><div id=d7otherset2 style=display:block><label style=display:block><input type=checkbox id=d7deskSwapMouse>交换鼠标按钮</label> <label style=display:block><input type=checkbox id=d7deskrmw>反向鼠标滚轮</label> <label style=display:block><input type=checkbox id=d7deskRemoteKeyMap>使用远程键盘映射</label> <label style=display:block id=d7deskAutoClipboardLabel><input type=checkbox id=d7deskAutoClipboard>自动剪贴板</label> <label style=display:block id=d7deskAutoLockLabel><input type=checkbox id=d7deskAutoLock>断开连接锁定</label></div></div></div><div id=d7amtkvm class=tabcontent><div style=margin-top:8px><div>图像编码</div><select id=d7desktopmode><option value=1>RLE8，最快<option value=2>RLE16，推荐<option value=3>RAW8，慢<option value=4>RAW16，非常慢</select></div><div><div>其他设定</div><div id=d7otherset style=display:block><label style=display:block><input type=checkbox id=d7showfocus>显示焦点工具</label> <label style=display:block><input type=checkbox id=d7showcursor>显示本地鼠标光标</label> <label style=display:block><input type=checkbox id=d7localKeyMap>本地键盘图</label> <label style=display:block><input type=checkbox id=d7kvmrmw>反向鼠标滚轮</label></div></div></div><div id=d7rdpkvm class=tabcontent><div style=margin-top:8px><div>显示屏尺寸</div><select id=d7rdpsize><option notransval=1 value=canvas>画布的尺寸<option notransval=1 value=browser>浏览器大小<option notransval=1 value=screen>屏幕尺寸<option notransval=1 value=640x480>640x480<option notransval=1 value=1024x768>1024x768<option notransval=1 value=1280x800>1280x800<option notransval=1 value=1440x900>1440x900<option notransval=1 value=1600x900>1600x900<option notransval=1 value=1680x1050>1680x1050<option notransval=1 value=1920x1080>1920x1080</select></div><div><div>选项</div><div id=d7rdpflags style=display:block><label style=display:block><input type=checkbox id=d7rdp1>禁用壁纸</label> <label style=display:block><input type=checkbox id=d7rdp2>禁用全窗口拖动</label> <label style=display:block><input type=checkbox id=d7rdp3>禁用菜单动画</label> <label style=display:block><input type=checkbox id=d7rdp4>禁用主题</label> <label style=display:block><input type=checkbox id=d7rdp6>禁用光标阴影</label> <label style=display:block><input type=checkbox id=d7rdp7>禁用光标设置</label> <label style=display:block><input type=checkbox id=d7rdp8>启用字体 Smoothing</label> <label style=display:block><input type=checkbox id=d7rdp9>启用桌面组合</label> <label style=display:block><input type=checkbox id=d7rdpclip>自动剪贴板</label> <label style=display:block><input type=checkbox id=d7rdpsmb>交换鼠标按钮</label> <label style=display:block><input type=checkbox id=d7rdprmw>反向鼠标滚轮</label></div></div></div></div></div><div id=idx_dlgButtonBar><input id=idx_dlgCancelButton type=button value=取消 onclick=dialogclose(0)> <input id=idx_dlgOkButton type=button value=OK onclick=dialogclose(1)><div><input id=idx_dlgDeleteButton type=button value=删除 style=display:none onclick=dialogclose(2)></div><div id=idx_dlgMoreButtons><a href=# id=idx_dlgMoreButtons1 style=cursor:pointer;color:gray;text-decoration:none title=切换高级选项 onclick=MoreToggle(!0)>▼</a> <a href=# id=idx_dlgMoreButtons2 style=cursor:pointer;color:gray;text-decoration:none title=切换高级选项 onclick=MoreToggle(!1)>▲</a></div></div></div><iframe name=fileUploadFrame style=display:none></iframe><form style=display:none method=post action=uploadfile.ashx enctype=multipart/form-data target=fileUploadFrame><input id=p5fileDragName name=name><input id=p5fileDragAuthCookie name=auth><input id=p5fileDragSize name=size><input id=p5fileDragType name=type><input id=p5fileDragData name=data><input id=p5fileDragLink name=link><input type=submit id=p5loginSubmit2 style=display:none></form><form style=display:none method=post action=uploadnodefile.ashx enctype=multipart/form-data target=fileUploadFrame><input id=p13fileDragName name=name><input id=p13fileDragSize name=size><input id=p13fileDragType name=type><input id=p13fileDragData name=data><input id=p13fileDragLink name=link><input type=submit id=p13loginSubmit2 style=display:none></form><audio id=chimes><source src=sounds/chimes.mp3 type=audio/mp3></audio><iframe style=display:none name=fileDownloadFrame></iframe></div><script>var i,args,urlargs,random="{{{randomlength}}}",webState="{{{webstate}}}";for(i in webState=null!=(webState=""!=webState?JSON.parse(decodeURIComponent(webState)):webState)&&"object"==typeof webState?webState:{})if("desktopsettings"!=i)try{localStorage.setItem(i,webState[i])}catch(e){}if(!webState.loctag)try{localStorage.removeItem("loctag")}catch(e){}var desktop,terminal,files,autoReconnect=!0,powerStatetable=["","有电源","休眠","休眠","休眠","休眠","关机","存在"],StatusStrs=["已断线","正在连线...","设定...","已连接","英特尔&reg;AMT已连接"],agentsStr=["未知","Windows 32位控制台","Windows 64位控制台","Windows 32位服务","Windows 64位服务","Linux 32位","Linux 64位","MIPS","XENx86","Android","Linux ARM","macOS x86-32位","安卓x86","PogoPlug ARM","Android","Linux Poky x86-32位","macOS x86-64位","ChromeOS","Linux Poky x86-64位","Linux NoKVM x86-32位","Linux NoKVM x86-64位","Windows MinCore控制台","Windows MinCore服务","NodeJS","ARM-Linaro","ARMv6l / ARMv7l","ARMv8 64位","ARMv6l / ARMv7l / NoKVM","MIPS24KC（OpenWRT）","苹果硅","FreeBSD x86-64","未知","Linux ARM 64 bit (glibc/2.24 NOKVM)","Alpine Linux x86 64 Bit (MUSL)","助手 (Windows)","Armada370 - ARM32/HF (libc/2.26)","OpenWRT x86-64","OpenBSD x86-64","未知","未知","MIPSEL24KC (OpenWRT)","ARMADA/CORTEX-A53/MUSL (OpenWRT)","Windows ARM 64bit console","Windows ARM 64bit service"],agentsStrNoAgent=["","","","","Windows","","Linux","","","","","","","","","","","","","","","","","","","","","","","苹果"],sort=0,searchFocus=0,mapSearchFocus=0,userSearchFocus=0,consoleFocus=0,showRealNames=!1,meshserver=null,meshes={},loginTokens={},meshcount=0,nodes=null,usergroups=null,filetree={},userinfo=null,serverinfo=null,events=[],users=null,wssessions=null,stars={},nodeShortIdent=0,desktopsettings={encoding:2,showfocus:!1,showmouse:!0,showcad:!0,quality:40,scaling:1024,framerate:50,localkeymap:!1,swapmouse:!1,remotekeymap:!1,autoclipboard:!1,autolock:!1,agentencoding:4},multidesktopsettings={quality:20,scaling:128,framerate:1e3,agentencoding:4},debugLevel=parseInt("{{{debuglevel}}}"),features=parseInt("{{{features}}}"),features2=parseInt("{{{features2}}}"),sessionTime=parseInt("{{{sessiontime}}}"),webRelayPort=parseInt("{{{webRelayPort}}}"),webRelayDns="{{{webRelayDns}}}",hidePowerTimeline="{{{hidePowerTimeline}}}",showNotesPanel="{{{showNotesPanel}}}",sessionRefreshTimer=null,domain="{{{domain}}}",domainUrl="{{{domainurl}}}",authCookie="{{{authCookie}}}",authRelayCookie="{{{authRelayCookie}}}",logoutControls=JSON.parse(decodeURIComponent("{{{logoutControls}}}")),authCookieRenewTimer=null,multiDesktop={},serverPublicNamePort="{{{serverDnsName}}}:{{{serverPublicPort}}}",amtScanResults=null,debugmode=0,windowsBrowser=detectWindowsBrowser(),attemptWebRTC=0!=(128&features),webrtcconfiguration="{{{webrtcconfig}}}";if(""==webrtcconfiguration)webrtcconfiguration=null;else try{webrtcconfiguration=JSON.parse(decodeURIComponent(webrtcconfiguration))}catch(e){console.log('Invalid WebRTC config: "'+webrtcconfiguration+'".'),webrtcconfiguration=null}var passRequirements="{{{passRequirements}}}";""!=passRequirements&&(passRequirements=JSON.parse(decodeURIComponent(passRequirements)));var customui=""!=(customui="{{{customui}}}")?JSON.parse(decodeURIComponent(customui)):null,deskAspectRatio=0;try{deskAspectRatio=parseInt(getstore("deskAspectRatio","0"))}catch(e){}var uiMode=parseInt(getstore("uiMode",1)),webPageStackMenu=!1,webPageFullScreen=!0,nightMode=setNightMode(),footerBar="1"==getstore("footerBar","1"),sessionActivity=Date.now(),updateSessionTimer=null,pluginHandlerBuilder={{{pluginHandler}}},pluginHandler=null,installedPluginList=(null!=pluginHandlerBuilder&&(pluginHandler=new pluginHandlerBuilder),null),goBackStack=[],CollapsedGroups={};try{CollapsedGroups=JSON.parse(getstore("_collapse","{}"))}catch(e){}var deviceViewSettings={};try{deviceViewSettings=JSON.parse(getstore("_deviceViewSettings","{}"))}catch(e){}var userViewSettings={};try{userViewSettings=JSON.parse(getstore("_usersViewSettings","{}"))}catch(e){}var xterm=null,xtermfit=null,xtermResizeTimer=null,miscState={},checkedNodeids={},deskKeyboardShortcuts=[],deskKeyboardStrings=[],deskLastClipboardSent=null,requestedLastConnects=!1,devicePagingState=null,p11DeskConsoleMsgTimer=null,p12TermConsoleMsgTimer=null,p13FilesConsoleMsgTimer=null,webpSupport=!1;function startup(){if(0==(32&features)){var e=null;try{e=top.location.toString().toLowerCase()}catch(e){}if(top!=self&&(null==e||0==top.active))return void(top.location=self.location)}null!=(urlargs=parseUriArgs()).key&&(urlargs.key=""+urlargs.key),urlargs.key&&0==isAlphaNumeric(urlargs.key)&&delete urlargs.key,urlargs.locale&&0==isAlphaNumeric(urlargs.locale)&&delete urlargs.locale,delete urlargs.user,delete urlargs.pass,delete urlargs.viewmode,delete urlargs.gotonode,delete urlargs.gotodevicename,delete urlargs.gotodeviceip,delete urlargs.gotomesh,delete urlargs.gotouser,delete urlargs.gotougrp,urlargs.key&&(Q("termsLinkFooter").href+="?key="+urlargs.key),(args=parseUriArgs()).key&&0==isAlphaNumeric(args.key)&&delete args.key,args.locale&&0==isAlphaNumeric(args.locale)&&delete args.locale,args.locale||null!=(i=getstore("loctag",0))&&"*"!=i&&(args.locale=i),debugmode=args.debug,null!=args.webrtc&&(attemptWebRTC=1==args.webrtc),QV("p13AutoConnect",debugmode),QV("autoconnectbutton2",debugmode),QV("autoconnectbutton1",debugmode),nightMode&&(QC("body").add("night"),QS("body")["background-color"]="#000"),toggleFullScreen();try{stars=JSON.parse(getstore("stars","{}"))}catch(e){}var e=0,t=parseInt("{{{hide}}}"),t=((t||args.hide)&&(args.hide&&(e=parseInt(args.hide)),t)&&(e|=t),args.hide=e,QV("uiViewButton5",!(4&args.hide)),adjustPanels(),"");logoutControls&&(null!=logoutControls.name&&(t='<span onmouseup=go(2) CLASS="LogoffLinkColor" style="cursor:pointer">'+format("欢迎{0}。",logoutControls.name)+"</span>"),null!=logoutControls.logoutUrl)&&(t+=format(' <a href="'+logoutControls.logoutUrl+'" CLASS="LogoffLinkColor">登出</a>')),1&args.hide?QH("logoutControlSpan2",t):QH("logoutControlSpan",t),document.onclick=function(e){hideContextMenu()},document.onkeypress=ondockeypress,document.onkeydown=ondockeydown,document.onkeyup=ondockeyup,window.addEventListener("blur",ondocblur,!1),window.onresize=function(){hideContextMenu(),mainUpdate(512),browserfullscreen=isBrowserFullscreen(),QV("DeskESC",browserfullscreen),null!=xtermfit&&12==xxcurrentView&&xtermfit.fit()},setTimeout(function(){urlargs.filter&&(Q("SearchInput").value=urlargs.filter,Q("KvmSearchInput").value=urlargs.filter),mainUpdate(512)},200),DOMPurify&&DOMPurify.addHook("afterSanitizeAttributes",function(e){"target"in e&&(e.setAttribute("target","_blank"),e.setAttribute("rel","noopener noreferrer")),e.hasAttribute("target")||!e.hasAttribute("xlink:href")&&!e.hasAttribute("href")||e.setAttribute("xlink:show","new")}),QV("textnewui",0!=(1073741824&features2)),(meshserver=MeshServerCreateControl(domainUrl)).onStateChanged=onStateChanged,meshserver.onMessage=onMessage,meshserver.trace=args.trace,meshserver.Start(),Q("sortselect").selectedIndex=sort=getstore("sort",0),Q("sizeselect").selectedIndex=getstore("viewsize",1),Q("KvmSearchInput").value=Q("SearchInput").value=getstore("_search",""),showRealNames=1==getstore("showRealNames",0),Q("RealNameCheckBox").checked=showRealNames,Q("DevFilterSelect").value=getstore("devFilterSelect",0),Q("viewselect").value=getstore("deviceView",1),Q("DeskControl").checked=1==getstore("DeskControl",1),QV("accountChangeEmailAddressSpan",0==(2097152&features)),mainUpdate(3);for(var n=1;n<5;n++)Q("devViewButton"+n).classList.remove("viewSelectorSel");Q("devViewButton"+Q("viewselect").value).classList.add("viewSelectorSel"),Q("p5filetable").addEventListener("drop",p5fileDragDrop,!1),Q("p5filetable").addEventListener("dragover",p5fileDragOver,!1),Q("p5filetable").addEventListener("dragleave",p5fileDragLeave,!1),Q("deskarea0").addEventListener("drop",p11fileDragDrop,!1),Q("deskarea0").addEventListener("dragover",p11fileDragOver,!1),Q("deskarea0").addEventListener("dragleave",p11fileDragLeave,!1),Q("p13filetable").addEventListener("drop",p13fileDragDrop,!1),Q("p13filetable").addEventListener("dragover",p13fileDragOver,!1),Q("p13filetable").addEventListener("dragleave",p13fileDragLeave,!1),setInterval(updateDeviceTimeline,12e4);e=null;try{e=localStorage.getItem("desktopsettings")}catch(e){}null!=e&&(desktopsettings=JSON.parse(e)),e=null;try{e=localStorage.getItem("multidesktopsettings")}catch(e){}null!=e&&(multidesktopsettings=JSON.parse(e)),applyDesktopSettings();for(var i="",o=1;o<27;o++)i+="<option value='"+o+"'>Ctrl-"+String.fromCharCode(64+o)+" ("+o+")</option>";QH("specialkeylist",i),setupGeneralServerStats(),setupServerTimelineStats(),userInterfaceSelectMenu(),setupMeshSummaryStats(),QV("p4UserBatchCreate",0==(524288&features)),d4EditWrapVal=Number(getstore("editorWrap",0)),d4EditSizeVal=Number(getstore("editorSize",0)),d4EditEncodingVal=Number(getstore("editorEncoding",0)),d4EditLineBreakVal=Number(getstore("editorLineBreak",0)),d4ToggleWrap(!0),d4ToggleSize(!0),d4ToggleEncoding(!0),d4ToggleLineBreak(!0),null!=pluginHandler&&pluginHandler.callHook("onWebUIStartupEnd"),-1==["en","ko","ja","zh-chs","zh-cht"].indexOf("{{{lang}}}")&&""!="{{{lang}}}".toLowerCase()&&QC("body").add("nonenglish");var s=document.getElementsByClassName("topbar_td");for(r in s)s[r].innerHTML&&(s[r].innerHTML=s[r].innerHTML.split(" ").join("&nbsp;"));if(null!=customui){if(customui.devicesbarbuttons){i="";for(r in customui.devicesbarbuttons){var a="one"==customui.devicesbarbuttons[r].selection||"many"==customui.devicesbarbuttons[r].selection?"disabled":"";i+='<input id="cui:'+r+'" type="button" value="'+customui.devicesbarbuttons[r].name+'" '+a+' onclick=customUIAction(event,"devicesbarbuttons") />'}QH("devsCustomUIBar",i)}if(customui.desktopbuttons){i="";for(r in customui.desktopbuttons)i+='<input id="cui:'+r+'" type="button" value="'+customui.desktopbuttons[r].name+'" style="float:left" onclick=customUIAction(event,"desktopbuttons") />';QH("desktopCustomUiButtons",i)}if(customui.terminalbuttons){i="";for(r in customui.terminalbuttons)i+='<input id="cui:'+r+'" type="button" value="'+customui.terminalbuttons[r].name+'" style="float:left" onclick=customUIAction(event,"terminalbuttons") />';QH("terminalCustomUiButtons",i)}if(customui.filesbuttons){i="";for(r in customui.filesbuttons)i+='<input id="cui:'+r+'" type="button" value="'+customui.filesbuttons[r].name+'" style="float:left" onclick=customUIAction(event,"filesbuttons") />';QH("filesCustomUiButtons",i)}}10<=sessionTime&&(sessionRefreshTimer=setTimeout(refreshCookieSession,Math.round(6e4*sessionTime*.8))),deskKeyboardShortcuts=[];var r,l=getstore("deskKeyShortcuts","0x0A002E,0x100000,0x100028,0x100026,0x10004C,0x10004D,0x11004D,0x100052,0x020073,0x080057,0x020009,0x100025,0x100027").split(",");for(r in l)""!=l[r]&&deskKeyboardShortcuts.push(parseInt(l[r]));updateDeskShortcutKeys();try{deskKeyboardStrings=JSON.parse(getstore("deskStrings","[]"))}catch(e){}updateDesktopStrings(),updateCollapseAllButton(),dialogBoxDrag(),urlargs.key&&(Q("p6backuplink").href+="?key="+urlargs.key),QV("uiViewButton4",0==(3145728&features2)),Q("DeskType").value=multiTranslate("[KeyboardTyping]|类型"),QV("ScrollToTopButton",0!=(134217728&features2))}function refreshCookieSession(){var e=null;try{e=new XDomainRequest}catch(e){}(e=e||new XMLHttpRequest).open("GET",window.location.origin+domainUrl+"refresh.ashx"),e.timeout=15e3,e.onload=function(){sessionRefreshTimer=setTimeout(refreshCookieSession,Math.round(6e4*sessionTime*.8))},e.onerror=e.ontimeout=function(){sessionRefreshTimer=null},e.send()}function customUIAction(e,t){e=e.srcElement.id;if(0!=e.startsWith("cui:")){var n=customui[t][e.substring(4)];if(null!=n){if("devicesbarbuttons"==t){for(var i=document.getElementsByClassName("DeviceCheckbox"),o=[],s=0;s<i.length;s++)!0===i[s].checked&&o.push(i[s].defaultValue.substring(6));if("string"==typeof n.action&&("event"==n.action&&meshserver.send({action:"uicustomevent",section:t,element:e.substring(4),selectedDevices:o,logmsg:n.logmsg}),n.action.startsWith("dialog:")&&showCustomUiDialog(n.action.substring(7),{section:t,element:e.substring(4),selectedDevices:o}),n.deselectdevices)){for(s=0;s<i.length;s++)i[s].checked=!1;checkedNodeids={},p1updateInfo()}}"devicebuttons"!=t&&"desktopbuttons"!=t&&"terminalbuttons"!=t&&"filesbuttons"!=t||(o=[currentNode._id],"string"==typeof n.action&&("event"==n.action&&meshserver.send({action:"uicustomevent",section:t,element:e.substring(4),selectedDevices:o,logmsg:n.logmsg}),n.action.startsWith("dialog:"))&&showCustomUiDialog(n.action.substring(7),{section:t,element:e.substring(4),selectedDevices:o}))}}}function showCustomUiDialog(e,t){if(null!=customui&&null!=customui.dialogs&&"object"==typeof customui.dialogs[e]){var n="",i=customui.dialogs[e],o=3;if("string"==typeof i.text&&(n+="<div style=margin-bottom:8px>"+i.text+"</div>"),"number"==typeof i.buttons&&(o=i.buttons),"object"==typeof i.elements)for(var s in i.elements){var a=i.elements[s];if("text"==a.type&&(n+=addHtmlValue(a.name,"<input id=cui:"+s+" style=width:230px autocomplete=off />")),"textarea"==a.type&&(null==a.name?n+="<textarea id=cui:"+s+" style=width:356px;resize:none;height:100px autocomplete=off></textarea>":n+=addHtmlValue(a.name,"<textarea id=cui:"+s+" style=width:230px;resize:none;height:100px autocomplete=off></textarea>")),"droplist"==a.type){var r,l="";for(r in a.options)l+='<option value="'+r+'">'+EscapeHtml(a.options[r])+"</option>";n+=addHtmlValue(a.name,'<select id="cui:'+s+'" style=width:230px autocomplete=off />'+l+"</select>")}}setDialogMode(2,i.title,o,showCustomUiDialogEx,n,{action:"uicustomevent",section:"dialogs",element:e,src:t,values:{},logmsg:i.logmsg})}}function showCustomUiDialogEx(e,t){if(1==e){var n=customui.dialogs[t.element];if("object"==typeof n.elements)for(var i in n.elements){var o=n.elements[i];"droplist"!=o.type&&"textarea"!=o.type&&"text"!=o.type||(t.values[i]=Q("cui:"+i).value)}if(meshserver.send(t),n.deselectdevices){for(var s=document.getElementsByClassName("DeviceCheckbox"),i=0;i<s.length;i++)s[i].checked=!1;checkedNodeids={},p1updateInfo()}}}function adjustPanels(){var e=args.hide,e=(0==footerBar&&(e|=4),QV("masthead",!(1&e)),QV("topbar",!(2&e)),QV("footer",!(4&e)),QV("p1title",!(8&e)),QV("p2title",!(8&e)),QV("p3title",!(8&e)),QV("p4title",!(8&e)),QV("p5title",!(8&e)),QV("p6title",!(8&e)),QV("p10title",!(8&e)),QV("p11title",!(8&e)),QV("p12title",!(8&e)),QV("p13title",!(8&e)),QV("p14title",!(8&e)),QV("p15title",!(8&e)),QV("p16title",!(8&e)),QV("p17title",!(8&e)),QV("p20title",!(8&e)),QV("p21title",!(8&e)),QV("p30title",!(8&e)),QV("p31title",!(8&e)),QV("p40title",!(8&e)),QV("p41title",!(8&e)),QV("p50title",!(8&e)),QV("p51title",!(8&e)),footerBar?QC("body").remove("nofooter"):QC("body").add("nofooter"),0!=args.hide&&(2==uiMode?(QS("container")["grid-template-rows"]=(1&e?"0":"66")+"px fit-content(48px) auto "+(4&e?"0":"45")+"px",QS("container")["-ms-grid-rows"]=(1&e?"0":"66")+"px fit-content(48px) auto "+(4&e?"0":"45")+"px"):(QS("container")["grid-template-rows"]=(1&e?"0":"66")+"px "+(2&e?"0":"24")+"px auto "+(4&e?"0":"45")+"px",QS("container")["-ms-grid-rows"]=(1&e?"0":"66")+"px "+(2&e?"0":"24")+"px auto "+(4&e?"0":"45")+"px")),(1&e?0:66)+(2&e?0:24)+(4&e?0:45)+(8&e?0:60)),t=1<uiMode?24:0,n=(QS("p2info").height="calc(100vh - "+(20+e+t)+"px)",QS("p2info")["max-height"]="calc(100vh - "+(20+e+t)+"px)",QS("p3users")["max-height"]="calc(100vh - "+(50+e)+"px)",QS("p50groups")["max-height"]="calc(100vh - "+(50+e)+"px)",QS("p3events").height="calc(100vh - "+(50+e)+"px)",QS("p5filetable").height="calc(100vh - "+(99+e)+"px)",QS("p13filetable").height="calc(100vh - "+(127+e+t)+"px)",QS("serverMainStats").height="calc(100vh - "+(50+e+t)+"px)",QS("serverMainStats")["max-height"]="calc(100vh - "+(50+e+t)+"px)",QS("xdevices")["max-height"]="calc(100vh - "+(46+e)+"px)",QS("xdevicesmap")["max-height"]="calc(100vh - "+(46+e)+"px)",QS("p15agentConsole").height="calc(100vh - "+(84+e+t)+"px)",QS("p15agentConsole")["max-height"]="calc(100vh - "+(84+e+t)+"px)",QS("p15agentConsoleText").height="calc(100vh - "+(81+e+t)+"px)",QS("p15agentConsoleText")["max-height"]="calc(100vh - "+(81+e+t)+"px)",!(0===args.xterm||null!=terminal&&null==xterm));fullscreen?(QS("deskarea3x").height=null,QS("deskarea3x")["max-height"]=null,QS("p14iframe").height=null,QS("p14iframe")["max-height"]=null,n&&(QS("termarea3x").height="calc(100vh - 55px)",QS("termarea3xdiv").height="calc(100vh - 55px)",QS("termarea3x")["max-width"]="calc(1px)")):(QS("deskarea3x").height="calc(100vh - "+(74+e+t)+"px)",QS("deskarea3x")["max-height"]="calc(100vh - "+(74+e+t)+"px)",QS("p14iframe").height="calc(100vh - "+(23+e+t)+"px)",QS("p14iframe")["max-height"]="calc(100vh - "+(23+e+t)+"px)",n&&(QS("termarea3x").height="calc(100vh - "+(74+e+t)+"px)",QS("termarea3xdiv").height="calc(100vh - "+(74+e+t)+"px)",QS("termarea3x")["max-width"]="calc(1px)")),QS("p43iframe").height="calc(100vh - "+(84+e)+"px)",QS("p43iframe")["max-height"]="calc(100vh - "+(84+e)+"px)",QS("p6info").height="calc(100vh - "+(e-50+t)+"px)",QS("p6info")["max-height"]="calc(100vh - "+(e-50+t)+"px)",QS("p10info").height="calc(100vh - "+(20+e+t)+"px)",QS("p10info")["max-height"]="calc(100vh - "+(20+e+t)+"px)",QS("p17info").height="calc(100vh - "+(20+e+t)+"px)",QS("p17info")["max-height"]="calc(100vh - "+(20+e+t)+"px)",QS("p20main").height="calc(100vh - "+(e-50+t)+"px)",QS("p20main")["max-height"]="calc(100vh - "+(e-50+t)+"px)",QS("p21main").height="calc(100vh - "+(20+e+t)+"px)",QS("p21main")["max-height"]="calc(100vh - "+(20+e+t)+"px)",QS("p30info").height="calc(100vh - "+(20+e+t)+"px)",QS("p30info")["max-height"]="calc(100vh - "+(20+e+t)+"px)",QS("p51info").height="calc(100vh - "+(20+e+t)+"px)",QS("p51info")["max-height"]="calc(100vh - "+(20+e+t)+"px)",QS("p16events").height="calc(100vh - "+(50+e+t)+"px)",QS("p16events")["max-height"]="calc(100vh - "+(50+e+t)+"px)",QS("p31events").height="calc(100vh - "+(50+e+t)+"px)",QS("p31events")["max-height"]="calc(100vh - "+(50+e+t)+"px)",QS("p41events").height="calc(100vh - "+(48+e+t)+"px)",QS("p41events")["max-height"]="calc(100vh - "+(48+e+t)+"px)",QS("p52recordings").height="calc(100vh - "+(48+e+t)+"px)",QS("p52recordings")["max-height"]="calc(100vh - "+(48+e+t)+"px)",QS("p60report").height="calc(100vh - "+(48+e+t)+"px)",QS("p60report")["max-height"]="calc(100vh - "+(48+e+t)+"px)",(32&args.hide||""!="{{currentNode}}".toLowerCase())&&(QV("p10BackButton",!1),QV("p11BackButton",!1),QV("p12BackButton",!1),QV("p13BackButton",!1),QV("p14BackButton",!1),QV("p15BackButton",!1),QV("p16BackButton",!1),QV("p17BackButton",!1)),p1updateInfo()}function toggleAspectRatio(e){1===e&&putstore("deskAspectRatio",deskAspectRatio=(deskAspectRatio+1)%3),deskAdjust()}function toggleStackMenu(e){1==webPageFullScreen&&(1===e&&putstore("webPageStackMenu",webPageStackMenu=!webPageStackMenu),0==webPageStackMenu?QC("body").remove("menu_stack"):(QC("body").add("menu_stack"),10<=xxcurrentView&&QC("column_l").remove("room4submenu")),deskAdjust())}function showUserInterfaceSelectMenu(){if(!xxdialogMode){Q("uiViewButton1").classList.remove("uiSelectorSel"),Q("uiViewButton2").classList.remove("uiSelectorSel"),Q("uiViewButton3").classList.remove("uiSelectorSel"),Q("uiViewButton4").classList.remove("uiSelectorSel"),Q("uiViewButton5").classList.remove("uiSelectorSel");try{Q("uiViewButton"+uiMode).classList.add("uiSelectorSel")}catch(e){}QV("uiMenu","none"==QS("uiMenu").display),nightMode&&Q("uiViewButton4").classList.add("uiSelectorSel"),footerBar&&Q("uiViewButton5").classList.add("uiSelectorSel")}}function userInterfaceSelectMenu(e){e&&putstore("uiMode",uiMode=e),webPageFullScreen=uiMode<3,webPageStackMenu=1<uiMode,toggleFullScreen(0),toggleStackMenu(0),webPageStackMenu&&10<=xxcurrentView?QC("column_l").add("room4submenu"):QC("column_l").remove("room4submenu"),adjustPanels()}function toggleNightMode(){var e;xxdialogMode||(setDialogMode(2,"夜间模式",3,toggleNightModeEx,"<input type=radio id=night0 name=nightmoderadio value=0 "+(0==(e=getstore("nightMode","0"))?"checked":"")+"><label for=night0>浏览器默认</label><br>"+("<input type=radio id=night2 name=nightmoderadio value=2 "+(2==e?"checked":"")+"><label for=night2>灯光模式</label><br>")+("<input type=radio id=night1 name=nightmoderadio value=1 "+(1==e?"checked":"")+"><label for=night1>黑暗模式</label><br>")),QV("uiMenu",!1))}function toggleNightModeEx(){var e="0";Q("night1").checked&&(e="1"),putstore("nightMode",e=Q("night2").checked?"2":e),setNightMode()}function setNightMode(){var e=getstore("nightMode","0");return nightMode=!1,0!=(1048576&features2)&&(e="1"),"1"==(e=0!=(2097152&features2)?"2":e)?nightMode=!0:"0"==e&&window.matchMedia&&(nightMode=window.matchMedia("(prefers-color-scheme: dark)").matches),nightMode?(QC("body").add("night"),QS("body")["background-color"]="#000"):(QC("body").remove("night"),QS("body")["background-color"]="#d3d9d6"),nightMode}function toggleFooterBarMode(){putstore("footerBar",(footerBar=!footerBar)?"1":"0"),QS("container")["grid-template-rows"]=null,QS("container")["-ms-grid-rows"]=null,adjustPanels()}function toggleFullScreen(e){1===e&&putstore("webPageFullScreen",webPageFullScreen=!webPageFullScreen),0==webPageFullScreen?(QC("body").remove("menu_stack"),QC("body").remove("fullscreen"),QC("body").remove("arg_hide"),10<=xxcurrentView&&QC("column_l").add("room4submenu"),QV("UserDummyMenuSpan",!1)):(QC("body").add("fullscreen"),16&args.hide&&QC("body").add("arg_hide"),QV("page_leftbar",!(16&args.hide)),QV("MainMenuSpan",!(16&args.hide)),10<=xxcurrentView&&QC("column_l").remove("room4submenu"),QV("UserDummyMenuSpan",xxcurrentView<10&&webPageFullScreen)),mainUpdate(512),QV("body",!0)}function saveUserInterfaceMode(){var e=2;Q("ui1").checked&&(e=3),getstore("uiViewMode",2)!=e&&(putstore("uiViewMode",e),reload())}function toggleBootstrapUIMode(){var e,t;xxdialogMode||(t="<input type=radio id=ui0 name=uiradio value=2 "+(2==(e=getstore("uiViewMode",2))?"checked":"")+"><label for=ui0>Classic</label><br>",setDialogMode(2,"User Interface",3,saveUserInterfaceMode,t+="<input type=radio id=ui1 name=uiradio value=3 "+(3==e?"checked":"")+"><label for=ui1>Modern</label><br>"),QV("uiMenu",!1))}function getNodeFromId(e){if(null!=nodes)for(var t in nodes)if(nodes[t]._id==e)return nodes[t];return null}function reload(){var e=window.location.href;(e=e.endsWith("/#")?e.substring(0,e.length-2):e).endsWith("#")&&(e=e.substring(0,e.length-1)),window.location.href=e}function onStateChanged(e,t,n,i){0==t?(setDialogMode(0),go(0),deviceShares=powerTimelineUpdate=powerTimelineNode=powerTimelineReq=powerTimeline=null,deleteAllNotifications(),hideContextMenu(),QV("verifyEmailId2",!1),QV("logoutControl",!1),"noauth"==i?QH("p0span","无法执行身份验证"):"invalidorigin"==i?QH("p0span","Invalid origin in HTTP request"):(2==n?autoReconnect&&setTimeout(serverPoll,5e3):QH("p0span","无法连接网络套接字"),null!=authCookieRenewTimer&&(clearInterval(authCookieRenewTimer),authCookieRenewTimer=null))):2==t&&(meshserver.send({action:"usergroups"}),meshserver.send({action:"meshes"}),meshserver.send({action:"nodes",id:"{{currentNode}}",skip:null==devicePagingState?0:devicePagingState.skip}),meshserver.send({action:"loginTokens"}),null!=pluginHandler&&meshserver.send({action:"plugins"}),""=="{{currentNode}}".toLowerCase()&&meshserver.send({action:"files"}),""=="{{viewmode}}".toLowerCase()&&go(1),authCookieRenewTimer=setInterval(function(){meshserver.send({action:"authcookie"})},18e5),40==xxcurrentView)&&refreshServerTimelineStats()}function serverPoll(){var e=null;try{e=new XDomainRequest}catch(e){}(e=e||new XMLHttpRequest).open("HEAD",window.location.href),e.timeout=15e3,e.onload=function(){e.status<500?reload():setTimeout(serverPoll,1e4)},e.onerror=e.ontimeout=function(){setTimeout(serverPoll,1e4)},e.send()}function detectWindowsBrowser(){var e=window.navigator.userAgent.toUpperCase();return 0<=e.indexOf("WINDOWS")||0<=e.indexOf("WIN32")||0<=e.indexOf("WIN64")}function updateSiteAdmin(){var e=parseInt("{{{serverfeatures}}}"),t=userinfo.siteadmin,n=4294967295!=t&&0!=(1024&t)||0!=(256&features2);QV("p2AccountSecurity",0==(4&features)&&0==serverinfo.domainauth&&0!=(4096&features)&&0==n),QV("p2AccountActions",!n),QV("managePhoneNumber1",33554432&features&&67108864&features&&1!=serverinfo.lock2factor),QV("managePhoneNumber2",33554432&features&&!(67108864&features)&&1!=serverinfo.lock2factor),QV("manageMessaging1",33554432&features2&&67108864&features2&&1!=serverinfo.lock2factor),QV("manageMessaging2",33554432&features2&&!(67108864&features2)&&1!=serverinfo.lock2factor),QV("manageEmail2FA",8388608&features&&1!=serverinfo.lock2factor),QV("p2AccountPassActions",0==(4&features)&&0==serverinfo.domainauth&&null!=userinfo&&0==userinfo._id.split("/")[2].startsWith("~")),QV("accountCreateLoginTokenSpan",128&features2),QV("p2AccountImageFrame",!n),QV("p2ServerActions",21&t&&0!=(143&e)),QV("LeftMenuMyServer",21&t&&0!=(64&e)),QV("MainMenuMyServer",21&t),QV("p2ServerActionsBackup",1&t&&0!=(1&e)),QV("p2ServerActionsRestore",4&t&&0!=(2&e)),QV("p2ServerActionsVersion",16&t&&0!=(4&e)),QV("p2ServerActionsErrors",16&t&&0!=(8&e)),QV("p2ServerActionsConfig",16&t&&0!=(128&e)),QV("MainMenuMyFiles",8&t),QV("LeftMenuMyFiles",8&t),0==(8&t)&&5==xxcurrentView&&(setDialogMode(0),go(1)),null!=currentNode&&gotoDevice(currentNode._id,xxcurrentView,!0),null!=userinfo.flags&&1&userinfo.flags?(null==userinfo.accountImageRnd&&(userinfo.accountImageRnd=Math.floor(9999999999*Math.random())),Q("p2AccountImage").src="userimage.ashx?rnd="+userinfo.accountImageRnd):Q("p2AccountImage").src="images/user-256.png",0!=(2&userinfo.siteadmin)?(null==users&&meshserver.send({action:"users"}),null==wssessions&&meshserver.send({action:"wssessioncount"}),mainUpdate(24576)):(wssessions=users=null,mainUpdate(16384),(4==xxcurrentView||30<=xxcurrentView&&xxcurrentView<40)&&(setDialogMode(0),go(1),currentUser=null)),meshserver.send({action:"events",limit:parseInt(p3limitdropdown.value)}),QV("ServerConsole",4294967295===userinfo.siteadmin&&0!=(16&e)),QV("ServerTrace",4294967295===userinfo.siteadmin&&0!=(32&e)),115==xxcurrentView&&4294967295!=userinfo.siteadmin&&go(6),6==xxcurrentView&&0==(21&userinfo.siteadmin)&&go(1),0!=(21&t)&&meshserver.send({action:"serverstats",interval:1e4})}check_webp_feature("lossy",function(e,t){(webpSupport=t)||(d7encoding.options[1].disabled=!0,d7encoding.value=1)}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",setNightMode);var updateNaggleTimer=null,updateNaggleFlags=0;function mainUpdate(e){updateNaggleFlags|=e,null==updateNaggleTimer&&(updateNaggleTimer=setTimeout(function(){512&updateNaggleFlags&&center(),1&updateNaggleFlags&&onSearchInputChanged(),2&updateNaggleFlags&&onSortSelectChange(!1),128&updateNaggleFlags&&updateMeshes(),4&updateNaggleFlags&&(updateDevices(),updateDeviceDetails(),21==xxcurrentView)&&p21updateMesh(),8&updateNaggleFlags&&drawNotifications(),16&updateNaggleFlags&&32768&features&&updateMapMarkers(),32&updateNaggleFlags&&eventsUpdate(),64&updateNaggleFlags&&32768&features&&refreshMap(!1,!0),256&updateNaggleFlags&&drawDeviceTimeline(),1024&updateNaggleFlags&&deviceEventsUpdate(),2048&updateNaggleFlags&&userEventsUpdate(),4096&updateNaggleFlags&&p20updateMesh(),8192&updateNaggleFlags&&updateUserGroups(),16384&updateNaggleFlags&&updateUsers(),32768&updateNaggleFlags&&updateRecordings(),65536&updateNaggleFlags&&updateLoginTokens(),updateNaggleTimer=null,updateNaggleFlags=0,gotoStartViewPage()},150))}function count2factoraAuths(){var e;return null==userinfo?-1:(e=0,1==userinfo.otpsecret&&e++,0<userinfo.otphkeys&&(e+=userinfo.otphkeys),8388608&features&&1==userinfo.otpekey&&e++,33554432&features&&67108864&features&&null!=userinfo.phone&&e++,33554432&features2&&67108864&features2&&null!=userinfo.msghandle&&e++,0<e&&0<userinfo.otpkeys&&0==(262144&features2)&&e++,e)}var backupCodesWarningDone=!1;function updateSelf(){var e,t=count2factoraAuths(),n=4294967295!=userinfo.siteadmin&&0!=(1024&userinfo.siteadmin),n=(QV("verifyEmailId",!0!==userinfo.emailVerified&&null!=userinfo.email&&1==serverinfo.emailcheck),QV("verifyEmailId2",!0!==userinfo.emailVerified&&null!=userinfo.email&&1==serverinfo.emailcheck&&0==n),QV("manageOtp",1!=serverinfo.lock2factor&&0<t&&0==(262144&features2)),QV("authPhoneNumberCheck",null!=userinfo.phone),QV("authMessagingCheck",null!=userinfo.msghandle),QV("authEmailSetupCheck",1==userinfo.otpekey&&null!=userinfo.email&&1==userinfo.emailVerified),QV("authDuoSetupCheck",1==userinfo.otpduo&&0!=(536870912&features2)),QV("authAppSetupCheck",1==userinfo.otpsecret),QV("manageAuthApp",1!=serverinfo.lock2factor&&(1==userinfo.otpsecret||0==(131072&features2))),QV("manageDuoApp",1!=serverinfo.lock2factor&&0!=(536870912&features2)),QV("authKeySetupCheck",0<userinfo.otphkeys),QV("authPushAuthDevCheck",0<userinfo.otpdev&&0!=(64&features2)),QV("authCodesSetupCheck",0<userinfo.otpkeys),QV("managePushAuthDev",1!=serverinfo.lock2factor&&64&features2&&0<t),QV("manageHardwareOtp",1!=serverinfo.lock2factor),mainUpdate(4228),0==backupCodesWarningDone&&1==t&&0==(524288&features2)&&(addNotification({text:"请添加两因素认证的备用验证码。如果丢失了当前因素，则无法恢复该帐户。",title:"两因素身份验证",tag:"backupcodes"}),backupCodesWarningDone=!0),4294967295==userinfo.siteadmin||0==(64&userinfo.siteadmin));QV("p2createMeshLink1",n),QV("p2createMeshLink2",n),QV("getStarted1",n),QV("getStarted2",!n),"number"==typeof userinfo.passchange&&(-1==userinfo.passchange?QH("p2nextPasswordUpdateTime"," -下次登录时重置。"):null!=passRequirements&&"number"==typeof passRequirements.reset&&((t=userinfo.passchange+86400*passRequirements.reset-Math.floor(Date.now()/1e3))<0?QH("p2nextPasswordUpdateTime"," -下次登录时重置。"):t<3600?(n=Math.floor(t/60),QH("p2nextPasswordUpdateTime",format(1==n?" - 1分钟后重设。":" - 在{0}分钟内重置。",n))):t<86400?(e=Math.floor(t/3600),QH("p2nextPasswordUpdateTime",format(1==e?" - 1小时后重设。":" - 在{0}小时内重置。",e))):(n=Math.floor(t/86400),QH("p2nextPasswordUpdateTime",format(1==e?" - 1天后重设。":" - 在{0}天内重置。",n))))),QV("MainMenuMyUsers",null!=users&&0==(4&features)||0!=(512&userinfo.siteadmin)&&0!=(134217728&features)),QV("LeftMenuMyUsers",null!=users&&0==(4&features)||0!=(512&userinfo.siteadmin)&&0!=(134217728&features)),QV("UsersGeneral",null!=users&&0==(4&features)),QV("UsersGroups",null!=users&&0==(4&features)),QV("UsersRecordings",0!=(512&userinfo.siteadmin)&&0!=(134217728&features))}function setSessionActivity(){sessionActivity=Date.now(),QH("idleTimeoutNotify","")}function checkIdleSessionTimeout(){var e=Date.now()-sessionActivity;e>serverinfo.timeout?(null!=desktop&&(desktop.Stop(),webRtcDesktopReset(),(desktopNode=desktop=null)!=pluginHandler)&&pluginHandler.callHook("onDesktopDisconnect"),null!=terminal&&(terminal.Stop(),terminal=null),null!=files&&(files.Stop(),files=null),serverinfo.logoutOnIdleSessionTimeout&&(window.location.href="logout")):(e=Math.round((serverinfo.timeout-e)/1e3))<=60?QH("idleTimeoutNotify","<br />"+format(1==e?"1秒之后断开连接":"{0}秒后断开连接",e)):(e=Math.round(e/60))<=5&&QH("idleTimeoutNotify","<br />"+format(1==e?"1分钟之后断开连接":"{0}分钟直到断开连接",e))}function onMessage(H,e){switch(e.action){case"trace":serverTrace.unshift(e),displayServerTrace();break;case"intersession":"removeNotify"==e.subaction&&notificationDelete(e.id);break;case"traceinfo":"object"==typeof e.traceSources&&(null!=e.traceSources&&0<e.traceSources.length?(serverTraceSources=e.traceSources,QH("p41traceStatus",EscapeHtml(e.traceSources.join(", ")))):(serverTraceSources=[],QH("p41traceStatus","没有")));break;case"serverstats":updateGeneralServerStats(e);break;case"serverwarnings":if(null!=e.warnings&&0<e.warnings.length){var F={1:"",2:"缺少 WebDAV 参数。",3:'无法识别的配置选项 "{0}"。',4:"WebSocket 压缩被禁用，此功能在 NodeJS v11.11 到 v12.15 和 v13.2 中被破坏",5:"无法为默认域加载 Intel AMT TLS 根证书。",6:"无法为域 {0} 加载 Intel AMT TLS 根证书。",7:"当服务器处于仅 LAN 或仅 WAN 模式时，CIRA 本地 FQDN 将被忽略。",8:"不能有超过 4 个 CIRA 本地 FQDN。忽略价值。",9:"正在跳过代理哈希检查，这是不安全的。",10:"缺少让我们加密电子邮件地址。",11:"无效的 Let's Encrypt 主机名。",12:"无效的 Let's Encrypt 名称，不能包含 *。",13:"无法设置 Let's Encrypt 模块。",14:"Let's Encrypt 名称无效，无法解析：{0}",15:"Let's Encrypt 电子邮件地址无效，无法解决：{0}",16:"无法加载 CloudFlare 可信代理 IPv6 地址列表。",17:"SendGrid 服务器在 LAN 模式下的使用受到限制。",18:"SMTP 服务器在 LAN 模式下的使用受到限制。",19:"SMS 网关在 LAN 模式下的使用有限。",20:"config.json 中的“LoginCookieEncryptionKey”无效。",21:"备份路径不能在 meshcentral-data 文件夹中设置，备份设置被忽略。",22:"未能签署代理 {0}：{1}",23:"Unable to load agent icon file: {0}.",24:"Unable to load agent logo file: {0}.",25:"This NodeJS version does not support OpenID.",26:"This NodeJS version does not support Discord.js.",27:"Firebase now requires a service account JSON file, Firebase disabled."},t="";for(r in e.warnings)"string"==typeof(n=e.warnings[r])?t+="<div style=color:red;padding-bottom:6px><b>警告： "+n+"</b></div>":(null==(o=F[n.id])?o=n.msg:null!=n.args&&(o=format(o,...n.args)),t+="<div style=color:red;padding-bottom:6px><b>警告： "+o+"</b></div>");QH("serverWarnings",t),QV("serverWarningsDiv",!0)}break;case"servertimelinestats":setServerTimelineStats(e.events);break;case"authcookie":authCookie=e.cookie,authRelayCookie=e.rcookie;break;case"serverinfo":if((serverinfo=e.serverinfo).timeout&&(setInterval(checkIdleSessionTimeout,1e4),checkIdleSessionTimeout()),1==debugmode&&console.log("Server time: ",printDateTime(new Date(serverinfo.serverTime))),setupServiceWorker(),null!=serverinfo.certExpire&&0<=(c=Math.floor((serverinfo.certExpire-Date.now())/864e5))&&c<20&&(QH("serverCertWarnings","<div style=color:red;padding-bottom:6px><b>警告： "+format("证书将在 {0} 天后到期",c)+"</b></div>"),QV("serverWarningsDiv",!0),addNotification({text:format("证书将在 {0} 天后到期",c)})),serverinfo.preConfiguredRemoteInput){t="";for(r in serverinfo.preConfiguredRemoteInput)t+='<div class="cmtext" onclick="cmdeskpreconfigtypeaction('+r+',event)">'+EscapeHtml(serverinfo.preConfiguredRemoteInput[r].name)+"</div>";""!=t&&(t+="<hr />"),QH("deskPreConfigShortcutContextMenu1",t)}if(serverinfo.preConfiguredScripts){var t="",n="";for(r in serverinfo.preConfiguredScripts){var i=serverinfo.preConfiguredScripts[r],o='<div class="cmtext" onclick="cmdeskpreconfigscriptaction('+r+',event)">'+EscapeHtml(serverinfo.preConfiguredScripts[r].name)+"</div>";3!=i.type&&(t+=o),3<=i.type&&(n+=o)}QH("deskPreConfigScriptContextMenu1",t),QH("deskPreConfigScriptContextMenu2",n)}break;case"userinfo":userinfo=e.userinfo,updateSiteAdmin(),updateSelf();break;case"users":for(var s in users={},e.users)users[e.users[s]._id]=e.users[s];null!=currentUser&&(currentUser=users[currentUser._id]),mainUpdate(16384),updateSelf();break;case"wssessioncount":wssessions=e.wssessions,mainUpdate(16384);break;case"meshes":for(var s in meshes={},e.meshes)meshes[e.meshes[s]._id]=e.meshes[s];null!=currentMesh&&(currentMesh=meshes[currentMesh._id]),mainUpdate(132);break;case"usergroups":var a=0;if(Array.isArray(e.ugroups))for(var r in usergroups={},e.ugroups)a++,usergroups[e.ugroups[r]._id]=e.ugroups[r];else for(var r in usergroups=e.ugroups,e.ugroups)a++,e.ugroups[r]._id=r;0==a&&(usergroups=null),mainUpdate(8192);break;case"files":filetree=setupBackPointers(e.filetree),updateFiles(),d3updatefiles();break;case"nodes":for(var s in nodes=[],e.nodes)for(var l in e.nodes[s])null==e.nodes[s][l]._id?console.log("Invalid node ("+l+"): "+JSON.stringify(e.nodes)):(null==e.nodes[s][l].name&&(e.nodes[s][l].name="???"),e.nodes[s][l].namel=e.nodes[s][l].name.toLowerCase(),e.nodes[s][l].rname?e.nodes[s][l].rnamel=e.nodes[s][l].rname.toLowerCase():e.nodes[s][l].rnamel=e.nodes[s][l].namel,e.nodes[s][l].meshnamel=meshes[s]?meshes[s].name.toLowerCase():"*",e.nodes[s][l].meshid=s,e.nodes[s][l].state=e.nodes[s][l].state||0,e.nodes[s][l].icon||(e.nodes[s][l].icon=1),e.nodes[s][l].ident=++nodeShortIdent,nodes.push(e.nodes[s][l]));for(var r in stars)null==getNodeFromId(r)&&delete stars[r];null!=currentNode&&0==IsNodeViewable(currentNode)&&(currentNode=null,go(1)),null!=currentNode&&(null!=(currentNode=getNodeFromId(currentNode._id))?gotoDevice(currentNode._id,xxcurrentView,!0):go(1)),devicePagingState=null==e.totalcount?null:{total:e.totalcount,skip:e.skip,limit:e.limit},updateDevicePageState(),mainUpdate(71);break;case"powertimeline":if(e.nodeid==powerTimelineReq){for(var r in powerTimelineNode=e.nodeid,powerTimeline=e.timeline,powerTimelineUpdate=Date.now()+3e5,powerTimeline)r%2==1&&(powerTimeline[r]=1e3*powerTimeline[r]);currentNode._id==e.nodeid&&mainUpdate(256)}break;case"deviceShares":e.nodeid==deviceSharesReq&&(deviceSharesNode=e.nodeid,deviceShares=e.deviceShares,null!=currentNode&&currentNode._id==e.nodeid)&&gotoDevice(currentNode._id,xxcurrentView,!0);break;case"deviceMeshShares":e.meshid==deviceSharesReq&&(deviceSharesNode=e.meshid,deviceShares=e.deviceShares,null!=currentMesh&&currentMesh._id==e.meshid)&&p20updateMesh();break;case"getsysinfo":e.nodeid==powerTimelineReq&&(!0===e.noinfo?updateDeviceDetails(getNodeFromId(e.nodeid)):updateDeviceDetails(getNodeFromId(e.nodeid),e.hardware));break;case"lastconnect":null!=(E=getNodeFromId(e.nodeid))&&(E.lastconnect=e.time,E.lastaddr=e.addr,currentNode._id==E._id)&&""==Q("MainComputerState").innerHTML&&null!=E.lastconnect&&QH("MainComputerState","<span>最后一次发现：<br />"+printDateTime(new Date(E.lastconnect))+"</span>");break;case"lastconnects":var B=Object.keys(e.lastconnects);for(r in B){var P=B[r];null!=(E=getNodeFromId(P))&&(E.lastconnect=e.lastconnects[P])}mainUpdate(4);case"msg":if(null!=e.nodeid){var d=-1;if(null!=nodes)for(var r in nodes)if(nodes[r]._id==e.nodeid){d=r;break}if(-1!=d)if("cpuinfo"===e.type&&null!=currentNode&&currentNode._id==e.nodeid){var c=Date.now()/1e3,u=0,p=0;"number"==typeof e.cpu.total&&(u=e.cpu.total),"number"==typeof e.memory.percentConsumed&&(p=e.memory.percentConsumed),deviceDetailsStatsData.push([c,u,p]),deviceDetailsStatsDraw(e)}else if("console"===e.type)p15consoleReceive(nodes[d],e.value,e.source);else if("notify"===e.type){if(0==(8&(l=getstore("notifications",0)))&&null!=e.amtMessage)break;l={text:e.value,title:e.title,icon:e.icon,titleid:e.titleid,msgid:e.msgid,args:e.args};null!=e.id&&(l.id=e.id),null!=e.nodeid&&(l.nodeid=e.nodeid),null!=e.tag&&(l.tag=e.tag),null!=e.url&&(l.url=e.url),null!=e.username&&(l.username=e.username),"number"==typeof e.maxtime&&(l.maxtime=e.maxtime),addNotification(l)}else if("ps"===e.type)showDeskToolsProcesses(e);else if("services"===e.type)showDeskToolsServices(e);else if("service"===e.type)showServiceDetailsDialog(e);else if("getclip"===e.type&&null!=currentNode&&currentNode._id==e.nodeid)1==e.tag&&"clipboard"===xxdialogTag?Q("d2clipText").value=e.data:2===e.tag&&null!=navigator.clipboard&&navigator.clipboard.writeText(e.data).then(function(){}).catch(function(e){console.log(e)});else if("setclip"===e.type&&"clipboard"===xxdialogTag&&null!=currentNode&&currentNode._id==e.nodeid)QH("dlgClipStatus",e.success?"<span style=color:green>成功</span>":"<span style=color:red>失败</span>"),setTimeout(function(){try{QH("dlgClipStatus","")}catch(e){}},2e3);else if("userSessions"===e.type&&null!=currentNode&&currentNode._id===e.nodeid&&null==desktop){var m=[];if(null!=e.data)for(var r in e.data)"Active"!=e.data[r].State&&"Connected"!=e.data[r].State&&"Console"!=e.data[r].StationName&&3!=debugmode||m.push(e.data[r]);if(0===m.length)connectDesktop(null,1,null,e.tag);else if(1===m.length)connectDesktop(null,1,m[0].SessionId,e.tag);else{var t="",g="{{{userSessionsSort}}}";for(r in m.sort(function(e,t){return e[g]?t[g]?e[g]<t[g]?-1:t[g]<e[g]?1:0:1:-1}),m)t+='<div style="text-align:left;cursor:pointer;background-color:gray;margin:5px;padding:5px;border-radius:5px" onclick=connectDesktop(event,1,'+m[r].SessionId+","+e.tag+")>"+m[r].State+(m[r].StationName?", "+m[r].StationName:""),m[r].Username&&(m[r].Domain?t+=" - "+m[r].Domain+"/"+m[r].Username:t+=" - "+m[r].Username),t+="</div>";QH("p11DeskSessionSelector",t),QV("p11DeskSessionSelector",!0)}}else"psinfo"===e.type?xxdialogTag==="ps|"+e.nodeid+"|"+e.pid&&(t="<div style=max-height:200px;overflow-y:auto>","object"==typeof e.value&&0<Object.keys(e.value).length?(e.value=jsonToCamel(e.value),!e.value.cmd&&e.value.path&&(e.value.cmd=e.value.path),!e.value.processUser&&e.value.userName&&(e.value.processUser=e.value.userName.split("\\")[1]),!e.value.processDomain&&e.value.userName&&(e.value.processDomain=e.value.userName.split("\\")[0]),e.value.processName&&(t+="<div style=padding:4px><div style=padding-bottom:4px>进程名称</div><div style=word-wrap:break-word;padding-left:6px><b>"+e.value.processName+"</b></div></div>"),e.value.machineName&&(t+=addHtmlValue5("机器名称",e.value.machineName)),e.value.cmd&&(t+="<div style=padding:4px><div style=padding-bottom:4px>命令行</div><div style=word-wrap:break-word;padding-left:6px><b>"+e.value.cmd+"</b></div></div>"),e.value.mainWindowTitle&&(t+="<div style=padding:4px><div style=padding-bottom:4px>窗口标题</div><div style=word-wrap:break-word;padding-left:6px><b>"+e.value.mainWindowTitle+"</b></div></div>"),e.value.processUser&&(t+=addHtmlValue5("用户",e.value.processUser)),e.value.processDomain&&(t+=addHtmlValue5("域",e.value.processDomain)),e.value.startTime&&(t+=addHtmlValue5("开始时间",e.value.startTime)),t+="<hr />",e.value.PriorityBoostEnabled&&(t+=addHtmlValue5("优先提升",e.value.PriorityBoostEnabled?"已启用":"已禁用")),e.value.sessionId&&(t+=addHtmlValue5("会话 ID",e.value.sessionId)),e.value.handleCount&&(t+=addHtmlValue5("处理计数",e.value.handleCount)),e.value.privilegedProcessorTime&&(t+=addHtmlValue5("特权处理器时间",format("{0} 秒",e.value.privilegedProcessorTime))),e.value.totalProcessorTime&&(t+=addHtmlValue5("总处理器时间",format("{0} 秒",e.value.totalProcessorTime))),e.value.userProcessorTime&&(t+=addHtmlValue5("用户处理器时间",format("{0} 秒",e.value.userProcessorTime))),e.value.nonpagedSystemMemorySize&&(t+=addHtmlValue5("非分页内存",getNiceSize2(e.value.nonpagedSystemMemorySize))),e.value.pagedMemorySize&&(t+=addHtmlValue5("分页内存",getNiceSize2(e.value.pagedMemorySize))),e.value.privateMemorySize&&(t+=addHtmlValue5("私人内存",getNiceSize2(e.value.privateMemorySize))),e.value.virtualMemorySize&&(t+=addHtmlValue5("虚拟内存",getNiceSize2(e.value.virtualMemorySize))),e.value.workingSet&&(t+=addHtmlValue5("工作集",getNiceSize2(e.value.workingSet))),e.value.peakWorkingSet&&(t+=addHtmlValue5("峰值工作集",getNiceSize2(e.value.peakWorkingSet))),e.value.peakPagedMemorySize&&(t+=addHtmlValue5("峰值分页内存",getNiceSize2(e.value.peakPagedMemorySize))),e.value.peakVirtualMemorySize&&(t+=addHtmlValue5("峰值虚拟内存",getNiceSize2(e.value.peakVirtualMemorySize)))):t+="未提供信息",t+="</div>",QH("id_dialogOptions",t)):"deskBackground"===e.type&&(""!=e.data?Q("DeskBackgroundButtonImage").src="images/icon-background.png":Q("DeskBackgroundButtonImage").src="images/icon-background-red.png")}else"notify"===e.type&&(l={text:e.value,title:e.title,icon:e.icon,titleid:e.titleid,msgid:e.msgid,args:e.args},null!=e.id&&(l.id=e.id),null!=e.tag&&(l.tag=e.tag),null!=e.url&&(l.url=e.url),null!=e.username&&(l.username=e.username),"number"==typeof e.maxtime&&(l.maxtime=e.maxtime),addNotification(l));break;case"getnetworkinfo":if(currentNode._id!=e.nodeid)return;if(updateDeviceDetails(getNodeFromId(e.nodeid),null,e),2==xxdialogMode&&xxdialogTag=="if"+e.nodeid){var t="<div class=dialogText>";if(currentNode.lastconnect&&(t+=addHtmlValue2("上次代理连接",printDateTime(new Date(currentNode.lastconnect)))),currentNode.lastaddr&&(2<(c=currentNode.lastaddr.split(":")).length?t+=addHtmlValue2("上次代理地址",currentNode.lastaddr+' <img src="images/link4.png" title="将地址复制到剪贴板" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(currentNode.lastaddr)+'") width=10 height=10>'):isPrivateIP(currentNode.lastaddr)?t+=addHtmlValue2("上次代理地址",c[0]+' <img src="images/link4.png" title="将地址复制到剪贴板" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(c[0])+'") width=10 height=10>'):t+=addHtmlValue2("上次代理地址",'<a href="https://iplocation.com/?ip='+c[0]+'" rel="noreferrer noopener" target="MeshIPLoopup">'+c[0]+'</a> <img src="images/link4.png" title="将地址复制到剪贴板" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(c[0])+'") width=10 height=10>')),null!=e.updateTime&&(t+=addHtmlValue2("最后接口更新",printDateTime(new Date(e.updateTime)))),null!=e.netif)for(var r in e.netif)t+="<hr />",(h=e.netif[r]).name&&(t+=addHtmlValue2("名称","<b>"+EscapeHtml(h.name)+"</b>")),h.desc&&(t+=addHtmlValue2("描述",EscapeHtml(h.desc).replace("(R)","&reg;").replace("(r)","&reg;"))),h.dnssuffix&&(t+=addHtmlValue2("DNS suffix",EscapeHtml(h.dnssuffix)+' <img src="images/link4.png" title="将名称复制到剪贴板" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(h.dnssuffix)+'") width=10 height=10>')),h.mac&&(t+=addHtmlValue2("MAC地址",'<a href="https://maclookup.app/search/result?mac='+h.mac.substring(0,6)+'" rel="noreferrer noopener" target="MeshMACLoopup">'+EscapeHtml(h.mac.toLowerCase())+'</a> <img src="images/link4.png" title="将MAC地址复制到剪贴板" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(h.mac.toLowerCase())+'") width=10 height=10>')),h.v4addr&&(t+=addHtmlValue2("IPv4地址",EscapeHtml(h.v4addr)+' <img src="images/link4.png" title="将地址复制到剪贴板" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(h.v4addr)+'") width=10 height=10>')),h.v4mask&&(t+=addHtmlValue2("IPv4掩码",EscapeHtml(h.v4mask)+' <img src="images/link4.png" title="将地址复制到剪贴板" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(h.v4mask)+'") width=10 height=10>')),h.v4gateway&&(t+=addHtmlValue2("IPv4网关",EscapeHtml(h.v4gateway)+' <img src="images/link4.png" title="将地址复制到剪贴板" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(h.v4gateway)+'") width=10 height=10>')),h.gatewaymac&&(t+=addHtmlValue2("网关MAC",'<a href="https://maclookup.app/search/result?mac='+h.gatewaymac.substring(0,6)+'" rel="noreferrer noopener" target="MeshMACLoopup">'+EscapeHtml(h.gatewaymac.toLowerCase())+'</a> <img src="images/link4.png" title="将MAC地址复制到剪贴板" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(h.gatewaymac.toLowerCase())+'") width=10 height=10>'));else if(null!=e.netif2)for(var r in e.netif2){var h=e.netif2[r];if(!(0==Array.isArray(h)||h.length<1||null==h[0]||"string"==typeof h[0].mac&&h[0].mac.startsWith("00:00:00:00"))){t=(t+="<hr />")+addHtmlValue2("名称","<b>"+EscapeHtml(r)+"</b>"),"string"==typeof h[0].mac&&(t+=addHtmlValue2("MAC地址",'<a href="https://maclookup.app/search/result?mac='+h[0].mac.split(":").join("").substring(0,6)+'" rel="noreferrer noopener" target="MeshMACLoopup">'+EscapeHtml(h[0].mac.toLowerCase())+'</a> <img src="images/link4.png" title="将MAC地址复制到剪贴板" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(h[0].mac.toLowerCase())+'") width=10 height=10>')),h[0].fqdn&&(t+=addHtmlValue2("完整网域名称",h[0].fqdn));for(var v=0;v<h.length;v++){var f=h[v];"IPv6"==f.family?(f.address&&(t+=addHtmlValue2("IPv6地址",EscapeHtml(f.address)+' <img src="images/link4.png" title="将地址复制到剪贴板" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(f.address)+'") width=10 height=10>')),f.netmask&&(t+=addHtmlValue2("IPv6掩码",EscapeHtml(f.netmask)+' <img src="images/link4.png" title="将地址复制到剪贴板" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(f.netmask)+'") width=10 height=10>')),f.gateway&&(t+=addHtmlValue2("IPv6网关",EscapeHtml(f.gateway)+' <img src="images/link4.png" title="将地址复制到剪贴板" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(f.gateway)+'") width=10 height=10>'))):"IPv4"==f.family&&(f.address&&(t+=addHtmlValue2("IPv4地址",EscapeHtml(f.address)+' <img src="images/link4.png" title="将地址复制到剪贴板" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(f.address)+'") width=10 height=10>')),f.netmask&&(t+=addHtmlValue2("IPv4掩码",EscapeHtml(f.netmask)+' <img src="images/link4.png" title="将地址复制到剪贴板" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(f.netmask)+'") width=10 height=10>')),f.gateway)&&(t+=addHtmlValue2("IPv4网关",EscapeHtml(f.gateway)+' <img src="images/link4.png" title="将地址复制到剪贴板" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(f.gateway)+'") width=10 height=10>'))}}}else t+="<hr />没有适用于此设备的网络接口讯息。";t+="</div>",QH("d2netinfo",t)}break;case"serverversion":2==xxdialogMode&&"MeshCentralServerUpdate"==xxdialogTag&&(t="<div class=dialogText>",e.tags.current||(e.tags.current="未知"),e.tags.stable||(e.tags.stable="未知"),e.tags.latest||(e.tags.latest="未知"),t=(t=(t=t+addHtmlValue2("当前版本","<b>"+EscapeHtml(e.tags.current)+"</b>")+"<hr />")+addHtmlValue2("<label><input id=d2updateCheck1 type=checkbox onclick=server_showVersionDlgUpdate()"+("未知"==e.tags.stable||e.tags.current==e.tags.stable||0==(2048&features)?" disabled":"")+" /> 稳定版</label>","<b>"+EscapeHtml(e.tags.stable)+"</b>"))+addHtmlValue2("<label><input id=d2updateCheck2 type=checkbox onclick=server_showVersionDlgUpdate()"+("未知"==e.tags.latest||e.tags.current==e.tags.latest||0==(2048&features)?" disabled":"")+" /> 最新版本</label>","<b>"+EscapeHtml(e.tags.latest)+"</b>")+"</div>",e.tags.current==e.tags.latest&&e.tags.current==e.tags.stable||0==(2048&features)?setDialogMode(2,"MeshCentral版本",1,null,t):(setDialogMode(2,"MeshCentral版本",3,server_showVersionDlgEx,t+="<hr />检查并单击确定以开始服务器自我更新。",e.tags),server_showVersionDlgUpdate()));break;case"servererrors":2==xxdialogMode&&"MeshCentralServerErrors"==xxdialogTag&&(null==e.data?setDialogMode(2,"Server Errors",1,null,"服务器没有错误日志。"):(setDialogMode(2,"MeshCentral服务器错误",3,server_showErrorsDlgEx,t=(t='<div class="dialogText dialogTextLog"><pre id=d2ServerErrorsLogPre>'+EscapeHtml(e.data)+"</pre></div>")+'<br /><div style=float:right><img src=images/link4.png height=10 width=10 title="下载错误日志" style=cursor:pointer onclick=d2CopyServerErrorsToClip()></div>'+"<div><label><input id=d2clearErrorsCheck type=checkbox onclick=server_showErrorsDlgUpdate() /> 检查并单击确定以清除错误日志。</label></div>"),server_showErrorsDlgUpdate()));break;case"serverconfig":2==xxdialogMode&&"MeshCentralServerConfig"==xxdialogTag&&(null==e.data?setDialogMode(2,"Server Configuration",1,null,"Server has no config file."):(setDialogMode(4,"Server Configuration",2),QV("d4EncodingButton",!1),QV("d4LineBreakButton",!1),QS("dialog").width="auto",QS("dialog").bottom="80px",QS("dialog").top=QS("dialog").left=QS("dialog").right="100px",Q("d4editorarea").value=e.data,Q("d4editorarea").setAttribute("readonly","readonly")));break;case"serverconsole":p15consoleReceive("serverconsole",e.value);break;case"events":null!=e.nodeid&&null!=currentNode&&e.nodeid==currentNode._id?(currentDeviceEvents=e.events,mainUpdate(1024)):null!=e.userid&&null!=currentUser&&e.userid==currentUser._id?(currentUserEvents=e.events,mainUpdate(2048)):(events=e.events,mainUpdate(32));break;case"recordings":p52recordings=e.events,null!=e.error&&(p52recordings=e.error),updateRecordings();break;case"getcookie":"MCRouter"==e.tag?(-1!=(I=serverinfo.name).indexOf(".")&&0==(2&features)||(I=window.location.hostname),domainUrl.substring(0,domainUrl.length-1),_="mcrouter://"+I+(443==serverinfo.port?"":":"+serverinfo.port)+domainUrl+"control.ashx?c="+authCookie+"&t="+serverinfo.tlshash+"&l={{{lang}}}"+(urlargs.key?"&key="+urlargs.key:""),null!=e.nodeid&&(_+="&nodeid="+e.nodeid),null!=e.tcpport&&(_+="&protocol=1&remoteport="+e.tcpport),e.localRelay&&(_+="&local=1"),e.localport&&(_+="&localport="+e.localport),null!=e.name&&(_+="&name="+encodeURIComponentEx(e.name)),null!=e.ip&&(_+="&remoteip="+e.ip),downloadFile(_+="&appid="+e.protocol+"&autoexit=1","")):"novnc"==e.tag?(u=window.location.origin+domainUrl+"novnc/vnc.html?ws=wss%3A%2F%2F"+window.location.host+encodeURIComponentEx(domainUrl)+(e.localRelay?"local":"mesh")+"relay.ashx%3Fauth%3D"+e.cookie+"&show_dot=1"+(urlargs.key?"&key="+urlargs.key:"")+"&l={{{lang}}}",null!=(E=getNodeFromId(e.nodeid))&&(u+="&name="+encodeURIComponentEx(E.name)),safeNewWindow(u,"mcnovnc/"+e.nodeid)):"mstsc"==e.tag?(p=window.location.origin+domainUrl+"mstsc.html?ws="+e.cookie+(urlargs.key?"&key="+urlargs.key:""),null!=(E=getNodeFromId(e.nodeid))&&(p+="&name="+encodeURIComponentEx(E.name)),e.localRelay&&(p+="&local=1"),safeNewWindow(p,"mcmstsc/"+e.nodeid)):"ssh"==e.tag&&(c=window.location.origin+domainUrl+"ssh.html?ws="+e.cookie+(urlargs.key?"&key="+urlargs.key:""),null!=(E=getNodeFromId(e.nodeid))&&(c+="&name="+encodeURIComponentEx(E.name)),e.localRelay&&(c+="&local=1"),safeNewWindow(c,"mcssh/"+e.nodeid));break;case"getNotes":(l=Q("d2devNotes"))&&e.id==decodeURIComponent(l.attributes.noteid.value)?(e.notes?QH("d2devNotes",decodeURIComponent(e.notes)):QH("d2devNotes",""),0==("true"==l.attributes.ro.value)&&(l.removeAttribute("readonly"),QE("idx_dlgOkButton",!0),QV("idx_dlgOkButton",!0),focusTextBox("d2devNotes"))):(Q("notesPanelArea").innerHTML=e.notes&&marked&&DOMPurify?DOMPurify.sanitize(marked.parse(decodeURIComponent(e.notes),{breaks:!0}),{USE_PROFILES:{html:!0}}):"","true"===showNotesPanel&&e.notes?QV("notesPanel",!0):QV("notesPanel",!1));break;case"otpauth-request":2==xxdialogMode&&"otpauth-request"==xxdialogTag&&(null!=e.err?(u=["","2FA被锁定","备用代码已锁定","正在使用的登录令牌","不允许 OTP 2FA","帐户已被锁定","无法加载 OTPLIB"],0<e.err&&e.err<u.length?QH("d2optinfo",u[e.err]):QH("d2optinfo",format("错误 #{0}",e.err))):(52==(p=e.secret).length?p=p.split(/(.............)/).filter(Boolean).join(" "):32==p.length&&(p=(p=p.split(/(....)/).filter(Boolean).join(" ")).substring(0,20)+"<br/>"+p.substring(20)),QH("d2optinfo","<table style=width:380px><tr><td style=vertical-align:top>"+format('安装 <a href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2" rel="noreferrer noopener" target=_blank>Google Authenticator</a> 或兼容的应用软件并扫描条码，使用<a href="{0}" rel="noreferrer noopener" target=_blank>此连结</a>或输入密码。然后，在下面输入当前的6位数保安编码以激活两步登录。',e.url)+'<br /><br />Secret <img src=images/link4.png height=10 width=10 title="Copy Secret to clipboard" style=cursor:pointer onclick=d2CopySecretToClip()><br /><tt id=d2optsecret secret="'+e.secret+'" style=font-size:12px>'+p+'</tt><br /><br /></td><td style=width:1px;vertical-align:top><a href="'+e.url+'" rel="noreferrer noopener" target=_blank><div id="qrcode"></div></a></td><tr><td colspan=2 style="text-align:center;border-top:1px solid black"><br />在此处输入保安编码以进行两步登录： <input type=text autocomplete="one-time-code" inputmode="numeric" pattern="[0-9]*" onkeypress="return (event.keyCode == 8) || (event.charCode >= 48 && event.charCode <= 57)" onkeyup=account_addOtpCheck(event) onkeydown=account_addOtpCheck() maxlength=6 id=d2otpauthinput type=text></td></table>'),new QRCode(Q("qrcode"),{text:e.url,width:128,height:128,colorDark:"#000000",colorLight:"#EEE",correctLevel:QRCode.CorrectLevel.H}),QV("idx_dlgOkButton",!0),QE("idx_dlgOkButton",!1),Q("d2otpauthinput").focus()));break;case"otpauth-setup":if(xxdialogMode)return;setDialogMode(2,"认证软件",1,null,e.success?"<b style=color:green>认证软件激活成功。</b> 您现在需要一个有效的保安编码才能再次登录。":"<b style=color:red>两步登录激活失败。</b> 从应用程序中清除机密，然后重试。您只有几分钟的时间来输入正确的代码。");break;case"otpauth-clear":if(xxdialogMode)return;setDialogMode(2,"认证软件",1,null,e.success?"<b>认证软件已删除。</b> 您可以随时重新激活此功能。":"<b style=color:red>两步登录激活删除失败。</b> 再试一次。");break;case"otpauth-getpasswords":if(xxdialogMode)return;t="一次性保安编码可以用作辅助身份验证。生成一组，打印并保存在安全的地方。";if(t+='<div style="border-radius:6px;border: 2px dashed #888;width:100%;margin-top:8px"><div style="padding:8px;font-family:Arial, Helvetica, sans-serif;font-size:20px;font-weight:bold"><table class=selecttext style=width:100%;text-align:center>',e.passwords){var v=0,k="";for(r in e.passwords){++v%2&&(t+="<tr>");for(var x=""+e.passwords[r].p;x.length<8;)x="0"+x;!0===e.passwords[r].u?(t+="<td>"+x.substring(0,4)+"&nbsp;"+x.substring(4),""!=k&&(k+=" "),k+=x):t+="<td><strike style=color:#BBB>"+x.substring(0,4)+"&nbsp;"+x.substring(4)}}else t+="<tr><td>没有有效保安编码";t=(t+="</table></div></div><br />")+"<div><input type=button value=关 onclick=setDialogMode(0) style=float:right></input>"+'<input type=button value="生成新保安编码" onclick="account_manageOtp(1);"></input>',null!=e.passwords&&(t=(t+='<input type=button value="清除保安编码" onclick="account_manageOtp(2);"></input>')+'&nbsp;<img src=images/link4.png height=10 width=10 title="将有效代码复制到剪贴板" style=cursor:pointer onclick=copyTextToClip2("'+encodeURIComponentEx(k)+'")>'),setDialogMode(2,"管理备用码",8,null,t+="</div><br />","otpauth-manage");break;case"otp-hkey-get":if(xxdialogMode&&"otpauth-hardware-manage"!=xxdialogTag)return;var L='<div style="border-radius:6px;border:2px solid #CCC;background-color:#BBB;width:100%;box-sizing:border-box;margin-bottom:6px"><div style="margin:3px;font-family:Arial, Helvetica, sans-serif;font-size:16px;font-weight:bold"><table style=width:100%;text-align:left>',O="</table></div></div>",t='<a href="https://www.yubico.com/" rel="noreferrer noopener" target="_blank">硬件密钥</a> 用作辅助登录身份验证。';if(t+='<div style="max-height:150px;overflow-y:auto;overflow-x:hidden;margin-top:6px;margin-bottom:6px">',e.keys&&0<e.keys.length)for(var r in e.keys){var z=e.keys[r];t+=L+'<tr style=margin:5px><td style=width:30px><img width=24 height=18 src="images/hardware-key-'+(U=2==z.type?"OTP":"WebAuthn")+'-24.png" style=margin-top:4px><td style=width:250px>'+z.name+'<td><input type=button value="删除" onclick=account_removehkey('+z.i+")></input>"+O}else t+=L+"<tr style=text-align:center><td>未配置任何键"+O;t=t+"</div>"+'<div><input type=button value="关" onclick=setDialogMode(0) style=float:right></input>';c="number"==typeof userinfo.otphkeys?userinfo.otphkeys:0;"number"!=typeof serverinfo.maxfidokeys||serverinfo.maxfidokeys>c?(0!=(131072&features)&&(t+='<input id=d2addkey3 type=button value="新增密钥" onclick="account_addhkey(3);"></input>'),0!=(16384&features)&&(t+='<input id=d2addkey2 type=button value="添加YubiKey&reg;OTP" onclick="account_addhkey(2);"></input>')):t+="已达到最大键数。",setDialogMode(2,"管理安全密钥",8,null,t+="</div><br />","otpauth-hardware-manage"),0==u2fSupported()&&QE("d2addkey1",!1);break;case"otp-hkey-yubikey-add":e.result?meshserver.send({action:"otp-hkey-get"}):setDialogMode(2,"添加安全密钥",1,null,"<br />错误，无法添加密钥。<br /><br />");break;case"otp-hkey-setup-response":if(xxdialogMode&&"otpauth-hardware-manage"!=xxdialogTag)return;1==e.result?meshserver.send({action:"otp-hkey-get"}):setDialogMode(2,"添加安全密钥",1,null,"<br />错误：无法添加密钥。<br /><br />","otpauth-hardware-manage");break;case"webauthn-startregister":if(xxdialogMode&&"otpauth-hardware-manage"!=xxdialogTag)return;setDialogMode(2,"添加安全密钥",2,null,t='现在按下按键。<br /><br /><div style=width:100%;text-align:center><img width=120 height=117 src="images/hardware-keypress-120.png" /></div><input id=dp1keyname style=display:none value='+e.name+" />");u=e.request;e.request.challenge=Uint8Array.from(atob(e.request.challenge),function(e){return e.charCodeAt(0)}),e.request.user.id=Uint8Array.from(atob(e.request.user.id),function(e){return e.charCodeAt(0)}),navigator.credentials.create({publicKey:u}).then(function(e){meshserver.send({action:"webauthn-endregister",response:{rawId:btoa(String.fromCharCode.apply(null,new Uint8Array(e.rawId))),response:{attestationObject:btoa(String.fromCharCode.apply(null,new Uint8Array(e.response.attestationObject))),clientDataJSON:btoa(String.fromCharCode.apply(null,new Uint8Array(e.response.clientDataJSON)))},type:e.type}}),setDialogMode(0)},function(e){console.log("错误："+e),setDialogMode(2,"添加安全密钥",1,null,"错误："+e)});break;case"verifyPhone":if(xxdialogMode&&"verifyPhone"!=xxdialogTag)return;setDialogMode(2,"电话通知",3,account_managePhoneConfirm,t=(t='<table><tr><td><img src="images/phone80.png" style=padding:8px>')+"<td>检查您的手机并输入验证码。"+'<br /><br /><div style=width:100%;text-align:center>验证码： <input type=tel pattern="[0-9]" inputmode="number" maxlength=6 id=d2phoneCodeInput onKeyUp=account_managePhoneCodeValidate() onkeypress="if (event.key==\'Enter\') account_managePhoneCodeValidate(1)"></div></table>',e.cookie),Q("d2phoneCodeInput").focus(),account_managePhoneCodeValidate();break;case"verifyMessaging":if(xxdialogMode&&"verifyMessaging"!=xxdialogTag)return;setDialogMode(2,"Messaging Notifications",3,account_manageMessagingConfirm,t=(t='<table><tr><td><img src="images/messaging40.png" style=padding:8px>')+"<td>Check your messaging application and enter the verification code."+'<br /><br /><div style=width:100%;text-align:center>验证码： <input type=tel pattern="[0-9]" inputmode="number" maxlength=6 id=d2phoneCodeInput onKeyUp=account_managePhoneCodeValidate() onkeypress="if (event.key==\'Enter\') account_managePhoneCodeValidate(1)"></div></table>',e.cookie),Q("d2phoneCodeInput").focus(),account_managePhoneCodeValidate();break;case"fileoperation":setDialogMode(4,EscapeHtml(e.file),3,function(e,t){var n=Q("d4editorarea").value,n=0===d4EditLineBreakVal?n.replace(/\r?\n|\r/g,"\r\n"):2===d4EditLineBreakVal?n.replace(/\r\n|\n/g,"\r"):n.replace(/\r\n|\r/g,"\n"),n=1==d4EditEncodingVal?encode_utf8(n):n;meshserver.send({action:"fileoperation",fileop:"set",path:t.path,file:t.file,data:btoa(n)})},null,e),QV("d4EncodingButton",!0),QV("d4LineBreakButton",!0),QS("dialog").width="auto",QS("dialog").bottom="80px",QS("dialog").top=QS("dialog").left=QS("dialog").right="100px",Q("d4editorarea").value=1==d4EditEncodingVal?decode_utf8(atob(e.data)):atob(e.data);break;case"event":if(!e.event.nolog){if(currentNode&&e.event.nodeid==currentNode._id&&null!=currentDeviceEvents&&(e.event.action==p16filterevents.value||""==p16filterevents.value)){if(null!=currentDeviceEvents){currentDeviceEvents.unshift(e.event);for(var y=parseInt(p16limitdropdown.value);currentDeviceEvents.length>y;)currentDeviceEvents.pop()}mainUpdate(1024)}if(currentUser&&e.event.userid==currentUser._id&&(e.event.action==p31filterevents.value||""==p31filterevents.value)){if(null!=currentUserEvents){currentUserEvents.unshift(e.event);for(y=parseInt(p31limitdropdown.value);currentUserEvents.length>y;)currentUserEvents.pop()}mainUpdate(2048)}if(e.event.action==p3filterevents.value||""==p3filterevents.value){if(null!=events){events.unshift(e.event);for(y=parseInt(p3limitdropdown.value);events.length>y;)events.pop()}mainUpdate(32)}}if(!e.event.noact)switch(e.event.action){case"serverinfochange":null!=e.event.lock2factor&&(serverinfo.lock2factor=e.event.lock2factor,updateSelf(),updateSiteAdmin());break;case"deviceShareUpdate":e.event.nodeid==deviceSharesReq&&(deviceSharesNode=e.event.nodeid,deviceShares=e.event.deviceShares,currentNode._id==deviceSharesNode)&&gotoDevice(currentNode._id,xxcurrentView,!0);break;case"agentlog":98==e.event.msgid&&0<GetNodeRights(e.event.nodeid)&&(l=getNodeFromId(e.event.nodeid),addNotification({text:format("从{0}请求的帮助：{1}",e.event.msgArgs[0],e.event.msgArgs[1]),title:l.name,icon:l.icon,nodeid:e.event.nodeid}));break;case"recording":null!=p52recordings&&"object"==typeof p52recordings&&(p52recordings.unshift(e.event),e.event.present=1,updateRecordings());break;case"userWebState":try{if(null!=localStorage){var b=localStorage.getItem("showRealNames"),w=localStorage.getItem("uiMode"),G=localStorage.getItem("sort"),S=localStorage.getItem("loctag"),W=localStorage.getItem("nightMode"),K=localStorage.getItem("footerBar"),D=JSON.parse(e.event.state);for(r in D)localStorage.setItem(r,D[r]);if(null!=D.showRealNames&&D.showRealNames!=b&&(showRealNames=Q("RealNameCheckBox").checked="1"==D.showRealNames,mainUpdate(6)),null!=D.uiMode&&D.uiMode!=w&&userInterfaceSelectMenu(parseInt(D.uiMode)),null!=D.sort&&D.sort!=G&&(document.getElementById("sortselect").selectedIndex=sort=parseInt(D.sort),mainUpdate(6)),null!=D.loctag&&D.loctag!=S&&(null!=D.loctag?args.locale=D.loctag:delete args.locale,mainUpdate(4294967295)),null!=D.nightMode&&D.nightMode!=W&&(putstore("nightMode",D.nightMode),setNightMode()),null!=D.footerBar&&D.footerBar!=K&&(footerBar="1"==D.footerBar,QS("container")["grid-template-rows"]=null,QS("container")["-ms-grid-rows"]=null,adjustPanels()),null!=D.stars&&D.stars!=JSON.stringify(stars)&&(stars=JSON.parse(D.stars),3==Q("DevFilterSelect").value?mainUpdate(5):mainUpdate(4),currentNode)&&refreshDevice(currentNode._id),null!=D.deskKeyShortcuts){deskKeyboardShortcuts=[];var j=D.deskKeyShortcuts.split(",");for(r in j)""!=j[r]&&deskKeyboardShortcuts.push(parseInt(j[r]));updateDeskShortcutKeys()}if(null!=D.deskStrings){i=null;try{i=JSON.parse(D.deskStrings)}catch(e){}Array.isArray(i)&&(deskKeyboardStrings=i,updateDesktopStrings())}}}catch(e){}break;case"servertimelinestats":addServerTimelineStats(e.event.data);break;case"accountcreate":case"accountchange":if("object"!=typeof e.event.account||null==e.event.account)return void console.log(e.event);userinfo._id==e.event.account._id&&(b=e.event.account.siteadmin||0,w=userinfo.siteadmin||0,G=e.event.account.removeRights||0,S=userinfo.removeRights||0,(e.event.account.quota!=userinfo.quota||0==(8&userinfo.siteadmin)&&0!=(8&e.event.account.siteadmin))&&meshserver.send({action:"files"}),W=userinfo.groups,userinfo=e.event.account,w==b&&S==G&&1!=e.event.accountImageChange||(1==e.event.accountImageChange&&(userinfo.accountImageRnd=Math.floor(9999999999*Math.random())),updateSiteAdmin()),updateSelf(),0!=(2&userinfo.siteadmin)&&(K=userinfo.groups||[],(W||[]).join(",")!=K.join(","))&&(users=wssessions=null,meshserver.send({action:"users"}),meshserver.send({action:"wssessioncount"})),e.event.nodeListChange==userinfo._id)&&meshserver.send({action:"nodes",skip:null==devicePagingState?0:devicePagingState.skip}),currentNode&&refreshDevice(currentNode._id),null!=users&&(null==userinfo.groups||0==userinfo.groups.length||1==findOne(e.event.account.groups,userinfo.groups)?users[e.event.account._id]=e.event.account:delete users[e.event.account._id],mainUpdate(16388));break;case"accountremove":null!=users&&(delete users[e.event.userid],mainUpdate(16384));break;case"createusergroup":case"usergroupchange":w=(usergroups=null==usergroups?{}:usergroups)[e.event.ugrpid];null==w?usergroups[e.event.ugrpid]={_id:e.event.ugrpid,name:e.event.name,desc:e.event.desc,domain:e.event.domain,links:e.event.links}:(w.name=e.event.name,e.event.desc?w.desc=e.event.desc:delete w.desc,e.event.links?w.links=e.event.links:delete w.links,e.event.flags?w.flags=e.event.flags:delete w.flags,"number"==typeof e.event.consent&&(w.consent=e.event.consent)),mainUpdate(28672),meshserver.send({action:"meshes"}),meshserver.send({action:"nodes",skip:null==devicePagingState?0:devicePagingState.skip});break;case"deleteusergroup":if(null!=usergroups&&null!=usergroups[e.event.ugrpid]){delete usergroups[e.event.ugrpid];var C=0;for(r in usergroups)C++;0==C&&(usergroups=null),mainUpdate(24576)}break;case"createmesh":null!=meshes[e.event.meshid]||!serverinfo.manageAllDeviceGroups&&null==e.event.mesh.links[userinfo._id]||(meshes[e.event.meshid]=e.event.mesh,mainUpdate(24708),meshserver.send({action:"files"}));break;case"meshchange":if(null==meshes[e.event.meshid]){var M=!1;for(r in null!=e.event.links[userinfo._id]&&(M=!0),null!=userinfo.links[e.event.meshid]&&(M=!0),userinfo.links)r.startsWith("ugrp/")&&null!=e.event.links[r]&&(M=!0);M&&(meshes[e.event.meshid]={_id:e.event.meshid,name:e.event.name,mtype:e.event.mtype,desc:e.event.desc,links:e.event.links,amt:e.event.amt,invite:e.event.invite,expireDevs:e.event.expireDevs,relayid:e.event.relayid},meshserver.send({action:"nodes",skip:null==devicePagingState?0:devicePagingState.skip}))}else{if(null!=e.event.name)for(var r in meshes[e.event.meshid].name=e.event.name,nodes)nodes[r].meshid==e.event.meshid&&(nodes[r].meshnamel=e.event.name.toLowerCase());if(null!=e.event.desc&&(meshes[e.event.meshid].desc=e.event.desc),null!=e.event.flags&&(meshes[e.event.meshid].flags=e.event.flags),null!=e.event.consent&&(meshes[e.event.meshid].consent=e.event.consent),e.event.links&&(meshes[e.event.meshid].links=e.event.links),e.event.amt&&(meshes[e.event.meshid].amt=e.event.amt),null!=e.event.invite?meshes[e.event.meshid].invite=e.event.invite:delete meshes[e.event.meshid].invite,null!=e.event.expireDevs&&(0<e.event.expireDevs?meshes[e.event.meshid].expireDevs=e.event.expireDevs:delete meshes[e.event.meshid].expireDevs),null!=e.event.relayid&&(meshes[e.event.meshid].relayid=e.event.relayid),0==IsMeshViewable(e.event.meshid)){20==xxcurrentView&&currentMesh==meshes[e.event.meshid]&&go(2),delete meshes[e.event.meshid];var T=[];for(r in nodes)(nodes[r].meshid!=e.event.meshid||null!=userinfo.links&&null!=userinfo.links[nodes[r]._id])&&T.push(nodes[r]);nodes=T,10<=xxcurrentView&&xxcurrentView<20&&currentNode&&!IsNodeViewable(currentNode)&&(setDialogMode(0),go(1))}}mainUpdate(24708),currentNode&&!IsNodeViewable(currentNode)&&(currentNode=null,10<=xxcurrentView)&&xxcurrentView<20&&go(1),20==xxcurrentView&&currentMesh._id==e.event.meshid&&mainUpdate(4096);break;case"deletemesh":meshes[e.event.meshid]&&(delete meshes[e.event.meshid],mainUpdate(128),meshserver.send({action:"files"}));T=[];if(null!=nodes)for(var r in nodes)nodes[r].meshid!=e.event.meshid&&T.push(nodes[r]);nodes=T,mainUpdate(24580),20<=xxcurrentView&&xxcurrentView<30&&currentMesh._id==e.event.meshid&&(setDialogMode(0),go(2)),10<=xxcurrentView&&xxcurrentView<20&&currentNode&&!IsNodeViewable(currentNode)&&(setDialogMode(0),go(1));break;case"addnode":var E=e.event.node;meshes[E.meshid]&&null==getNodeFromId(E._id)&&(E.namel=E.name.toLowerCase(),E.rname?E.rnamel=E.rname.toLowerCase():E.rnamel=E.namel,E.meshnamel=meshes[E.meshid]?meshes[E.meshid].name.toLowerCase():"*",E.state=0,E.icon||(E.icon=1),E.ident=++nodeShortIdent,nodes.push(E),mainUpdate(23),20==xxcurrentView)&&null!=currentMesh&&currentMesh._id==E.meshid&&mainUpdate(4096);break;case"removenode":d=-1;for(r in nodes)if(nodes[r]._id==e.event.nodeid){d=r;break}-1!=d&&(E=nodes[d],currentNode==E&&(10<=xxcurrentView&&xxcurrentView<20&&(setDialogMode(0),go(1)),currentNode=null),nodes.splice(d,1),mainUpdate(20),20==xxcurrentView)&&null!=currentMesh&&currentMesh._id==E.meshid&&mainUpdate(4096);break;case"changenode":d=-1;for(r in nodes)if(nodes[r]._id==e.event.nodeid){d=r;break}if(-1!=d){if((E=nodes[d]).name=e.event.node.name,E.rname=e.event.node.rname,E.lusers=e.event.node.lusers,E.users=e.event.node.users,E.host=e.event.node.host,E.desc=e.event.node.desc,E.ip=e.event.node.ip,E.osdesc=e.event.node.osdesc,E.publicip=e.event.node.publicip,E.iploc=e.event.node.iploc,E.wifiloc=e.event.node.wifiloc,E.gpsloc=e.event.node.gpsloc,E.tags=e.event.node.tags,E.ssh=e.event.node.ssh,E.rdp=e.event.node.rdp,E.userloc=e.event.node.userloc,E.rdpport=e.event.node.rdpport,E.rfbport=e.event.node.rfbport,E.sshport=e.event.node.sshport,E.httpport=e.event.node.httpport,E.httpsport=e.event.node.httpsport,E.consent=e.event.node.consent,E.pmt=e.event.node.pmt,null!=e.event.node.links?E.links=e.event.node.links:delete E.links,null!=e.event.node.agent&&(null==E.agent&&(E.agent={}),null!=e.event.node.agent.ver&&(E.agent.ver=e.event.node.agent.ver),null!=e.event.node.agent.id&&(E.agent.id=e.event.node.agent.id),null!=e.event.node.agent.caps&&(E.agent.caps=e.event.node.agent.caps),null!=e.event.node.agent.root&&(E.agent.root=e.event.node.agent.root),null!=e.event.node.agent.core?E.agent.core=e.event.node.agent.core:E.agent.core&&delete E.agent.core,E.agent.tag=e.event.node.agent.tag),null!=e.event.node.intelamt&&(null==E.intelamt&&(E.intelamt={}),null!=e.event.node.intelamt.state&&(E.intelamt.state=e.event.node.intelamt.state),null!=e.event.node.intelamt.host&&(E.intelamt.user=e.event.node.intelamt.host),null!=e.event.node.intelamt.user?E.intelamt.user=e.event.node.intelamt.user:delete E.intelamt.user,null!=e.event.node.intelamt.tls&&(E.intelamt.tls=e.event.node.intelamt.tls),null!=e.event.node.intelamt.ver&&(E.intelamt.ver=e.event.node.intelamt.ver),null!=e.event.node.intelamt.tag&&(E.intelamt.tag=e.event.node.intelamt.tag),null!=e.event.node.intelamt.uuid&&(E.intelamt.uuid=e.event.node.intelamt.uuid),null!=e.event.node.intelamt.realm&&(E.intelamt.realm=e.event.node.intelamt.realm),null!=e.event.node.intelamt.flags&&(E.intelamt.flags=e.event.node.intelamt.flags),null!=e.event.node.intelamt.warn?E.intelamt.warn=e.event.node.intelamt.warn:delete E.intelamt.warn),null!=e.event.node.av&&(E.av=e.event.node.av),null!=e.event.node.wsc&&(E.wsc=e.event.node.wsc),null!=e.event.node.volumes&&(E.volumes=e.event.node.volumes),E.namel=E.name.toLowerCase(),E.rname?E.rnamel=E.rname.toLowerCase():E.rnamel=E.namel,e.event.node.icon&&(E.icon=e.event.node.icon),e.event.node.meshid!=E.meshid)if(null!=meshes[e.event.node.meshid]||null!=userinfo.links&&null!=userinfo.links[E._id])E.meshid=e.event.node.meshid,E.meshnamel=meshes[e.event.node.meshid]?meshes[e.event.node.meshid].name.toLowerCase():"*",mainUpdate(7);else{null!=currentNode&&currentNode._id==E._id&&10<=xxcurrentView&&xxcurrentView<20&&!IsNodeViewable(currentNode)&&(currentNode=null,setDialogMode(0),go(1));d=-1;for(r in nodes)if(nodes[r]._id==e.event.nodeid){d=r;break}nodes.splice(d,1),mainUpdate(20)}updateDeviceViewDevice(E),mainUpdate(26),refreshDevice(E._id),20==xxcurrentView&&null!=currentMesh&&currentMesh._id==E.meshid&&mainUpdate(4096),currentNode==E&&null!=xxdialogMode&&"@xxmap"==xxdialogTag&&p10showNodeLocationDialog()}break;case"nodemeshchange":d=-1;for(r in nodes)if(nodes[r]._id==e.event.nodeid){d=r;break}if(-1!=d){E=nodes[d];null!=meshes[e.event.newMeshId]||null!=userinfo.links&&null!=userinfo.links[E._id]?(E.meshid=e.event.newMeshId,E.meshnamel=meshes[e.event.newMeshId]?meshes[e.event.newMeshId].name.toLowerCase():"*",mainUpdate(7)):(null!=currentNode&&currentNode._id==E._id&&10<=xxcurrentView&&xxcurrentView<20&&!IsNodeViewable(currentNode)&&(currentNode=null,setDialogMode(0),go(1)),nodes.splice(d,1),mainUpdate(20)),refreshDevice(e.event.nodeid)}else{E=e.event.node;if(!meshes[E.meshid])break;E.namel=E.name.toLowerCase(),E.rname?E.rnamel=E.rname.toLowerCase():E.rnamel=E.namel,E.meshnamel=meshes[E.meshid]?meshes[E.meshid].name.toLowerCase():"*",E.state=0,E.icon||(E.icon=1),E.ident=++nodeShortIdent,nodes.push(E),mainUpdate(23)}break;case"nodeconnect":var N,d=-1;for(r in nodes)if(nodes[r]._id==e.event.nodeid){d=r;break}-1!=d&&(E=nodes[d],l=getstore("notifications",0),e.event.meshid&&userinfo.links&&userinfo.links[e.event.meshid]&&userinfo.links[e.event.meshid].notify&&(l|=userinfo.links[e.event.meshid].notify),null!=userinfo.notify&&(null!=userinfo.notify[e.event.meshid]&&(l|=userinfo.notify[e.event.meshid]),null!=userinfo.notify[e.event.nodeid])&&(l|=userinfo.notify[e.event.nodeid]),2&l&&(b="代理已连接",null!=E.agent&&!1===E.agent.root&&(b="与有限特权相关的代理"),N={title:E.name,icon:E.icon,nodeid:E._id,id:e.event.id},0==(1&E.conn)&&0!=(1&e.event.conn)&&(N.text=b,addNotification(N)),0==(2&E.conn)&&0!=(2&e.event.conn)&&(N.text="检测到英特尔 AMT",addNotification(N)),0==(4&E.conn)&&0!=(4&e.event.conn)&&(N.text="英特尔 AMT CIRA 已连接",addNotification(N)),0==(16&E.conn))&&0!=(16&e.event.conn)&&(N.text="MQTT已连接",addNotification(N)),4&l&&(N={title:E.name,icon:E.icon,nodeid:E._id,id:e.event.id},0!=(1&E.conn)&&0==(1&e.event.conn)&&(N.text="代理已断开连接",addNotification(N)),0!=(2&E.conn)&&0==(2&e.event.conn)&&(N.text="未检测到英特尔 AMT",addNotification(N)),0!=(4&E.conn)&&0==(4&e.event.conn)&&(N.text="英特尔 AMT CIRA 断开连接",addNotification(N)),0!=(16&E.conn))&&0==(16&e.event.conn)&&(N.text="MQTT已断开连接",addNotification(N)),E.conn=e.event.conn,E.pwr=e.event.pwr,E.lastconnect=Date.now(),0==(1&E.conn)&&delete E.sessions,1==(S=Q("DevFilterSelect").value)||5==S?mainUpdate(21):(updateDeviceViewDevice(E),mainUpdate(17)),refreshDevice(E._id),20==xxcurrentView)&&null!=currentMesh&&currentMesh._id==E.meshid&&mainUpdate(4096);break;case"wssessioncount":null!=wssessions&&(0==e.event.count&&wssessions[e.event.userid]?delete wssessions[e.event.userid]:wssessions[e.event.userid]=e.event.count,mainUpdate(16384));break;case"login":null!=users&&users[e.event.userid]&&(users[e.event.userid].login=Math.floor(new Date(e.event.time).getTime()/1e3));break;case"scanamtdevice":if(null==xxdialogMode||!Q("dp1range")||xxdialogTag!="AMTSCAN:"+e.event.range)return;t="";if(null==e.event.results)t="<div style=width:100%;text-align:center;margin-top:12px>无法扫描该地址范围。</div><div style=width:100%;text-align:center;margin-top:12px;color:gray;line-height:1.5>IP范围值样本<br />192.168.0.100<br />192.168.1.0/24<br />192.167.0.1-192.168.0.100</div>";else{for(var r in amtScanResults=e.event.results,e.event.results){var V=e.event.results[r],A=V.hostname,A=(20<(A="host"==V.hosttype?capitalizeFirstLetter(A.split(".")[0]):A).length&&(A=A.substring(0,20)+"..."),'<b title="'+EscapeHtml(V.hostname)+'">'+EscapeHtml(A)+"</b> - v"+V.ver);2==V.state?1==V.tls?A+=" TLS。":A+=" 没有TLS。":A+=" not activated.",t+='<div style=width:100%;margin-bottom:2px;background-color:lightgray><div style=padding:4px><div style=display:inline-block;margin-right:5px><input class=DevScanCheckbox name=dp1checkbox tag="'+EscapeHtml(r)+'" type=checkbox onclick=addAmtScanToMeshCheckbox() /></div><div class=j1 style=display:inline-block></div><div style=display:inline-block;margin-left:5px;overflow-x:auto;white-space:nowrap>'+A+"</div></div></div>"}""==t&&(t="<div style=width:100%;text-align:center;margin-top:12px>扫描未有任何结果。</div><div style=width:100%;text-align:center;margin-top:12px;color:gray;line-height:1.5>IP范围值样本<br />192.168.0.100<br />192.168.1.0/24<br />192.167.0.1-192.168.0.100</div>")}QH("dp1results",t),QE("dp1range",!0),QE("dp1rangebutton",!0),QE("d2scanSelectButton",!0);break;case"notify":l={text:e.event.value,title:e.event.title,icon:e.event.icon,titleid:e.titleid,msgid:e.msgid,args:e.args};null!=e.id&&(l.id=e.id),null!=e.event.tag&&(l.tag=e.event.tag),"number"==typeof e.maxtime&&(l.maxtime=e.maxtime),addNotification(l);break;case"traceinfo":"object"==typeof e.event.traceSources&&(null!=e.event.traceSources&&0<e.event.traceSources.length?(serverTraceSources=e.event.traceSources,QH("p41traceStatus",EscapeHtml(e.event.traceSources.join(", ")))):(serverTraceSources=[],QH("p41traceStatus","没有")));break;case"sysinfohash":null!=currentNode&&e.event.nodeid==powerTimelineReq&&meshserver.send({action:"getsysinfo",nodeid:e.event.nodeid});break;case"ifchange":null!=currentNode&&currentNode._id==e.event.nodeid&&meshserver.send({action:"getnetworkinfo",nodeid:currentNode._id});break;case"devicesessions":if(null!=(E=getNodeFromId(e.event.nodeid))){if(E.sessions=e.event.sessions,null!=E.sessions){for(var r in E.sessions)0==Object.keys(E.sessions[r]).length&&delete E.sessions[r];0==Object.keys(E.sessions).length&&delete E.sessions}updateDeviceViewDevice(E),null!=currentNode&&currentNode._id==e.event.nodeid&&gotoDevice(currentNode._id,xxcurrentView,!0),xxdialogTag=="SESSIONS-"+e.event.nodeid&&showDeviceSessions(e.event.nodeid,!0),xxdialogTag=="MESSAGES-"+e.event.nodeid&&showDeviceMessages(e.event.nodeid,!0),xxdialogTag=="HELPREQ-"+e.event.nodeid&&showDeviceHelpRequests(e.event.nodeid,!0),2!=Q("DevFilterSelect").value&&6!=Q("DevFilterSelect").value||mainUpdate(1)}break;case"loginTokenChanged":if(e.event.userid!=userinfo._id)return;loginTokens=e.event.loginTokens,mainUpdate(65536);break;case"loginTokenAdded":if(e.event.userid!=userinfo._id)return;(loginTokens=null==loginTokens?[]:loginTokens).push(e.event.newToken),mainUpdate(65536);break;case"stopped":break;case"updatePluginList":installedPluginList=e.event.list,updatePluginList();break;case"pluginStateChange":null!=pluginHandler&&pluginHandler.refreshPluginHandler();break;case"plugin":if(null!=pluginHandler)try{pluginHandler[e.event.plugin][e.event.pluginaction](e)}catch(e){console.log("PluginHandler无法事件消息：",e)}}break;case"createInviteLink":var I,_;xxdialogTag==e.meshid&&(-1!=(I=serverinfo.name).indexOf(".")&&0==(2&features)||(I=window.location.hostname),domainUrl.substring(0,domainUrl.length-1),_=1==serverinfo.https?"https://"+I+(443==serverinfo.port?"":":"+serverinfo.port)+domainUrl+"agentinvite?c="+e.cookie+(urlargs.key?"&key="+urlargs.key:""):"http://"+I+(80==serverinfo.port?"":":"+serverinfo.port)+domainUrl+"agentinvite?c="+e.cookie+(urlargs.key?"&key="+urlargs.key:""),Q("agentInvitationLink").href=_,p=format(1==e.expire?"1小时":"{0}小時",e.expire),24==e.expire&&(p="1天"),168==e.expire&&(p="1周"),5040==e.expire&&(p="1个月"),0==e.expire&&(p="无限制"),QH("agentInvitationLink",format("邀请连接（{0}）",p)),QV("agentInvitationLinkDiv",!0));break;case"createDeviceShareLink":var U;xxdialogTag||(t="",null!=(E=getNodeFromId(e.nodeid))&&(t=(t=(t+=addHtmlValue("设备",E.name))+addHtmlValue("访客姓名",e.guestname))+addHtmlValue("用户输入",e.viewOnly?"不允许，只能查看":"允许"),e.start&&e.expire&&(e.recurring?(t+=addHtmlValue("开始时间",printDateTime(new Date(e.start))),e.expire,t+=addHtmlValue("持续时间",format("{0} 分钟",e.expire))):t=(t+=addHtmlValue("开始时间",printDateTime(new Date(e.start))))+addHtmlValue("到期时间",printDateTime(new Date(e.expire)))),1==e.recurring&&(t+=addHtmlValue("再次发生的","日常的")),2==e.recurring&&(t+=addHtmlValue("再次发生的","每周")),n=[],7&e.consent&&n.push("通知"),56&e.consent&&n.push("提示"),64&e.consent&&n.push("隐私栏"),0==n.length&&n.push("没有"),t+=addHtmlValue("用户同意",n.join(", ")),U="",e.p<=7?U=["","远程终端链接","远程桌面连结","远程桌面+终端链接","远程文件链接","远程终端 + 文件链接","远程桌面 + 文件链接","远程桌面 + 终端 + 文件链接"][e.p]:8==e.p?U=format("HTTP/{0} link",e.port):16==e.p&&(U=format("HTTPS/{0}",e.port)),setDialogMode(2,"共享设备",1,null,t+='<div id=agentInvitationLinkDiv style="text-align:center;font-size:large;margin:16px"><a href="'+e.url+'" id=agentInvitationLink rel="noreferrer noopener" target="_blank" style=cursor:pointer>'+U+'</a> <img src=images/link4.png height=10 width=10 title="复制连结到剪贴板" style=cursor:pointer onclick=d2CopyInviteToClip()></div></div>')));break;case"getmqttlogin":if(null==currentNode||currentNode._id!=e.nodeid||null!=xxdialogMode)return;t="这些设置可用于连接该设备的MQTT。<br /><br />";delete e.action,delete e.nodeid,setDialogMode(2,"MQTT凭证",1,null,t+="<textarea readonly=readonly style=width:100%;resize:none;height:100px;overflow:auto;font-size:12px readonly>"+JSON.stringify(e)+"</textarea>");break;case"stopped":autoReconnect=!1,QH("p0span",e.msg);break;case"updatePluginList":installedPluginList=e.list,updatePluginList();break;case"pluginVersionsAvailable":null!=pluginHandler&&updatePluginList(e.list);break;case"downgradePluginVersions":var q='<select id="lastPluginVersion">';e.info.versionList.forEach(function(e){q+='<option value="'+e.zipball_url+'">'+e.name+"</option>"}),q+="</select>",setDialogMode(2,"插件指令",3,pluginActionEx,format("Select the version to downgrade the plugin: {0}",e.info.name)+"<hr />"+q+"<hr />请注意，不建议降级。请仅在最近的升级后发生问题时才这样做。NaN"+e.info.id+'" />');break;case"serverBackup":"googleDrive"==e.service&&(QV("p2ServerActionsGoogleBackup",0<e.state),QV("p2ServerActionsGoogleBackupCheck",2<e.state),miscState.googleDrive={state:e.state},2==e.state)&&(t='<img style=float:right src="images/googledrive-48.png" /><div>导航到下面的URL，授予访问权限并将令牌代码复制回去。</div><br />',setDialogMode(2,"Google云端硬盘备份",3,server_setupGoogleDriveBackupEx,t=(t+=addHtmlValue("激活",'<a href="'+e.url+'" rel="noreferrer noopener" target="_blank">Browse to this URL</a>'))+addHtmlValue("码","<input id=gdcode onkeyup=server_setupGoogleDriveBackupCheck3() style=width:240px></input>"),"gd2"),Q("gdcode").focus(),QE("idx_dlgOkButton",!1));break;case"pluginError":setDialogMode(2,"插件错误",1,null,e.msg);break;case"plugin":if(null!=pluginHandler&&"string"==typeof e.plugin)try{pluginHandler[e.plugin][e.method](H,e)}catch(e){console.log("Error loading plugin handler ("+e+")")}break;case"amtsetupbin":saveAs(new Blob([Uint8Array.from(atob(e.file),function(e){return e.charCodeAt(0)})],{type:"application/octet-stream"}),"setup.bin");break;case"previousLogins":c="previousLogins";if(null!=e.userid&&(c+=":"+e.userid),2==xxdialogMode&&xxdialogTag==c){var t="",C="BBB",R="";if(0==e.events.length)t+="No previous login.";else{for(var r in t+="<div style=max-height:260px;overflow-y:scroll;overflow-x:hidden><table>",e.events)107==(s=e.events[r].m)?(s="有效登录",C="BBD1BB",R="",null!=e.events[r].tn&&(s=format("令牌：{0}",e.events[r].tn),C="88D188")):108==s?(s="无效的 2FA",C="DD9DC3",R="x"):109==s?(s="被锁定账户",C="E1BBBB",R="x"):110==s&&(s="无效的密码",C="E1BBBB",R="x"),t+="<tr><td><img src=images/user-32"+R+'.png height=32 width=32 style=float:left srcset="images/user-64'+R+'.png 2x"><td><div style=width:300px;background-color:#'+C+";border-radius:6px;margin-bottom:4px;padding:4px><div>"+printDateTime(new Date(e.events[r].t))+", <b>"+EscapeHtml(s)+"</b></div><div style=font-size:x-small>"+EscapeHtml(e.events[r].a.join(", "))+"</div></div></tr>";t+="</table></div>"}setDialogMode(2,"以前的登录",1,null,t)}break;case"getDeviceDetails":saveAs(new Blob([e.data],{type:"application/octet-stream"}),"设备列表."+e.type);break;case"createLoginToken":if(xxdialogMode)return;t="记下这个用户名和密码，密码不能再次显示。<br /><br />";t+=addHtmlValue("名称",EscapeHtml(e.name)),0!=e.expire&&(t+=addHtmlValue("到期",EscapeHtml(printDateTime(new Date(e.expire))))),setDialogMode(2,"创建登录令牌",1,null,t=(t+=addHtmlValue("用户名",'<img src="images/link4.png" title="复制连结到剪贴板" style="margin:9px;cursor:pointer;float:right" onclick=copyTextToClip2("'+encodeURIComponentEx(e.tokenUser)+'") width=10 height=10><div class=selecttext style=width:230px;padding:5px;background-color:orange;border-radius:5px;font-size:15px>'+EscapeHtml(e.tokenUser)+"</div>"))+addHtmlValue("密码",'<img src="images/link4.png" title="复制连结到剪贴板" style="margin:9px;cursor:pointer;float:right" onclick=copyTextToClip2("'+encodeURIComponentEx(e.tokenPass)+'") width=10 height=10><div class=selecttext style=width:230px;padding:5px;background-color:orange;border-radius:5px;font-size:15px>'+EscapeHtml(e.tokenPass)+"</div>"));break;case"loginTokens":loginTokens=e.loginTokens,mainUpdate(65536);break;case"report":renderReport(e.data)}}function gotoStartViewPage(){var e=parseInt("{{viewmode}}");if(-1==xxcurrentView){if(""!="{{currentNode}}".toLowerCase()){if(null==getNodeFromId("{{currentNode}}"))return;gotoDevice("{{currentNode}}",e)}else if(null!=args.gotonode){if(96==args.gotonode.length&&(args.gotonode=btoa(hex2rstr(args.gotonode)).split("+").join("@").split("/").join("$")),null==getNodeFromId("node/"+domain+"/"+args.gotonode))return;gotoDevice("node/"+domain+"/"+args.gotonode,e),goBackStack.push(1)}else if(null!=args.gotodevicename){var t=null;if(null!=nodes)for(var n in nodes)nodes[n].name==args.gotodevicename&&(t=nodes[n]._id);t&&(gotoDevice(t,e),goBackStack.push(1))}else if(null!=args.gotodeviceip){t=null;if(null!=nodes)for(var n in nodes)nodes[n].ip==args.gotodeviceip&&(t=nodes[n]._id);t&&(gotoDevice(t,e),goBackStack.push(1))}else if(null!=args.gotomesh){if(null==meshes["mesh/"+domain+"/"+args.gotomesh])return;gotoMesh("mesh/"+domain+"/"+args.gotomesh),go(e),goBackStack.push(2)}else if(null!=args.gotouser){var i=args.gotouser;if(args.gotouser.indexOf("/")<0&&(i="user/"+domain+"/"+args.gotouser),null==users||null==users[i])return;gotoUser(encodeURIComponentEx(i)),go(e),goBackStack.push(4)}else if(null!=args.gotougrp){i=args.gotougrp;if(args.gotougrp.indexOf("/")<0&&(i="ugrp/"+domain+"/"+args.gotougrp),null==usergroups||null==usergroups[i])return;gotoUserGroup(i),go(e),goBackStack.push(50)}else isNaN(e)?(setDialogMode(0),go(1)):go(e);delete args.gotonode,delete args.gotomesh,delete args.gotouser,delete args.gotougrp}}function onRealNameCheckBox(){putstore("showRealNames",(showRealNames=Q("RealNameCheckBox").checked)?1:0),mainUpdate(7)}function onOnlineCheckBox(e){putstore("devFilterSelect",Q("DevFilterSelect").value),onDeviceSearchChanged(e)}function updateDevicePageState(){var e,t;null==devicePagingState||devicePagingState.total<=devicePagingState.limit?(QV("devViewPageState",!1),QV("devViewPageButton1",!1),QV("devViewPageButton2",!1),QV("devViewPageButton3",!1),QV("devViewPageButton4",!1)):(e=Math.floor((devicePagingState.skip+devicePagingState.limit)/devicePagingState.limit),t=Math.ceil(devicePagingState.total/devicePagingState.limit),QV("devViewPageState",!0),QV("devViewPageButton1",!0),QV("devViewPageButton2",!0),QV("devViewPageButton3",!0),QV("devViewPageButton4",!0),QH("devViewPageState",e+"/"+t))}function onDeviceViewPageChange(e){if(null!=devicePagingState){var t=Math.floor((devicePagingState.skip+devicePagingState.limit)/devicePagingState.limit),n=Math.ceil(devicePagingState.total/devicePagingState.limit);switch(e){case 1:1<t&&meshserver.send({action:"nodes",skip:0});break;case 2:1<t&&meshserver.send({action:"nodes",skip:(t-2)*devicePagingState.limit});break;case 3:t<n&&meshserver.send({action:"nodes",skip:t*devicePagingState.limit});break;case 4:t<n&&meshserver.send({action:"nodes",skip:(n-1)*devicePagingState.limit})}}}function onDeviceViewChange(e){null!=e&&(Q("viewselect").value=e);for(var t=1;t<6;t++)Q("devViewButton"+t).classList.remove("viewSelectorSel");Q("devViewButton"+Q("viewselect").value).classList.add("viewSelectorSel"),putstore("deviceView",Q("viewselect").value),putstore("viewsize",Q("sizeselect").value),mainUpdate(4),setTimeout(function(){mainUpdate(512)},200)}function onDeviceViewSettings(){var e;xxdialogMode||(null==deviceViewSettings&&(deviceViewSettings={}),Array.isArray(deviceViewSettings.devsCols)||(deviceViewSettings.devsCols=["user","ip","conn"]),e="",setDialogMode(2,"设备视图列",3,onDeviceViewSettingsEx,e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e+="<label><input id=d2c8 type=checkbox"+(0<=deviceViewSettings.devsCols.indexOf("agtype")?" checked":"")+">代理类型</label><br />")+("<label><input id=d2c9 type=checkbox"+(0<=deviceViewSettings.devsCols.indexOf("agver")?" checked":"")+">代理版本</label><br />"))+("<label><input id=d2c6 type=checkbox"+(0<=deviceViewSettings.devsCols.indexOf("desc")?" checked":"")+">设备描述</label><br />"))+("<label><input id=d2c5 type=checkbox"+(0<=deviceViewSettings.devsCols.indexOf("os")?" checked":"")+">操作系统</label><br />"))+("<label><input id=d2c10 type=checkbox"+(0<=deviceViewSettings.devsCols.indexOf("tags")?" checked":"")+">标签</label><br />"))+("<label><input id=d2c11 type=checkbox"+(0<=deviceViewSettings.devsCols.indexOf("windowsav")?" checked":"")+">Windows AV</label><br />"))+("<label><input id=d2c12 type=checkbox"+(0<=deviceViewSettings.devsCols.indexOf("windowsupdate")?" checked":"")+">Windows Update</label><br />"))+("<label><input id=d2c13 type=checkbox"+(0<=deviceViewSettings.devsCols.indexOf("windowsfirewall")?" checked":"")+">Windows Firewall</label><br />"))+("<label><input id=d2c14 type=checkbox"+(0<=deviceViewSettings.devsCols.indexOf("lastbootuptime")?" checked":"")+">Last Boot Up Time</label><br />"))+("<label><input id=d2c1 type=checkbox"+(0<=deviceViewSettings.devsCols.indexOf("links")?" checked":"")+">MeshCentral 路由器链接</label><br />"))+("<label><input id=d2c2 type=checkbox"+(0<=deviceViewSettings.devsCols.indexOf("user")?" checked":"")+">已登录用户</label><br />"))+("<label><input id=d2c3 type=checkbox"+(0<=deviceViewSettings.devsCols.indexOf("ip")?" checked":"")+">代理IP地址</label><br />"))+("<label><input id=d2c4 type=checkbox"+(0<=deviceViewSettings.devsCols.indexOf("conn")?" checked":"")+">服务器连接</label><br />"))+("<label><input id=d2c7 type=checkbox"+(0<=deviceViewSettings.devsCols.indexOf("lastseen")?" checked":"")+">最后一次露面</label><br />"))+("<label><input id=d2c15 type=checkbox"+(0<=deviceViewSettings.devsCols.indexOf("amthost")?" checked":"")+">Intel&reg; AMT hostname</label><br />"))+("<label><input id=d2c17 type=checkbox"+(0<=deviceViewSettings.devsCols.indexOf("amtstate")?" checked":"")+">Intel&reg; AMT state</label><br />")))}function onDeviceViewSettingsEx(){var e=[];Q("d2c1").checked&&e.push("links"),Q("d2c2").checked&&e.push("user"),Q("d2c3").checked&&e.push("ip"),Q("d2c4").checked&&e.push("conn"),Q("d2c5").checked&&e.push("os"),Q("d2c6").checked&&e.push("desc"),Q("d2c7").checked&&e.push("lastseen"),Q("d2c8").checked&&e.push("agtype"),Q("d2c9").checked&&e.push("agver"),Q("d2c10").checked&&e.push("tags"),Q("d2c11").checked&&e.push("windowsav"),Q("d2c12").checked&&e.push("windowsupdate"),Q("d2c13").checked&&e.push("windowsfirewall"),Q("d2c14").checked&&e.push("lastbootuptime"),Q("d2c15").checked&&e.push("amthost"),Q("d2c17").checked&&e.push("amtstate"),deviceViewSettings.devsCols=e,putstore("_deviceViewSettings",JSON.stringify(deviceViewSettings)),mainUpdate(4)}function ondockeypress(e){if(setSessionActivity(),!xxdialogMode&&11==xxcurrentView&&desktop&&Q("DeskControl").checked){if(null!=currentNode){var t=GetNodeRights(currentNode);if(0==(0==(8192&features2)&&(4294967295==t||0!=(8&t)&&0==(256&t))))return!1;t=4294967295!=t&&0!=(8&t)&&0==(256&t)&&0!=(4096&t);if(1==t&&(1==e.altKey||1==e.ctrlKey||e.keyCode<32&&8!=e.keyCode&&13!=e.keyCode||90<e.keyCode))return!1}return desktop.m.handleKeys(e)}if(!xxdialogMode&&12==xxcurrentView&&terminal&&3==terminal.State&&null==xterm)return terminal.m.TermHandleKeys(e);if(!xxdialogMode&&(15==xxcurrentView||115==xxcurrentView))return agentConsoleHandleKeys(e);if(!xxdialogMode&&4==xxcurrentView){if(1==e.ctrlKey||1==e.altKey||1==e.metaKey)return;var n=0;if(e.key?(1===e.key.length&&0==userSearchFocus&&(Q("UserSearchInput").value=Q("UserSearchInput").value+e.key,n=1),8==e.keyCode&&0==userSearchFocus&&(i=Q("UserSearchInput").value,Q("UserSearchInput").value=i.substring(0,i.length-1),n=1),27==e.keyCode&&(Q("UserSearchInput").value="",n=1)):0!=e.charCode&&0==userSearchFocus&&(Q("UserSearchInput").value=Q("UserSearchInput").value+String.fromCharCode(e.charCode),n=1),0<n)return 1==n&&onUserSearchInputChanged(),haltEvent(e)}if(!xxdialogMode&&1==xxcurrentView)if(1==e.ctrlKey&&96==e.charCode)showRealNames=!showRealNames,putstore("showRealNames",(Q("RealNameCheckBox").value=showRealNames)?1:0),mainUpdate(6);else if(1!=e.ctrlKey&&1!=e.altKey&&1!=e.metaKey){if(Q("viewselect").value<4){var i,n=0;if(e.key?(1===e.key.length&&0==searchFocus&&(Q("KvmSearchInput").value=Q("SearchInput").value=Q("SearchInput").value+e.key,n=1),8==e.keyCode&&0==searchFocus&&(i=Q("SearchInput").value,Q("KvmSearchInput").value=Q("SearchInput").value=i.substring(0,i.length-1),n=1),27==e.keyCode&&(Q("KvmSearchInput").value=Q("SearchInput").value="",n=1)):0!=e.charCode&&0==searchFocus&&(Q("KvmSearchInput").value=Q("SearchInput").value=Q("SearchInput").value+String.fromCharCode(e.charCode),n=1),0<n)return 1==n&&mainUpdate(5),haltEvent(e)}4==Q("viewselect").value&&(e.key?(1===e.key.length&&0==mapSearchFocus&&(Q("mapSearchLocation").value=Q("mapSearchLocation").value+e.key,n=1),27==e.keyCode&&(Q("mapSearchLocation").value="",mapCloseSearchWindow(),n=1),13==e.keyCode&&getSearchLocation()):0!=e.charCode&&0==mapSearchFocus&&(Q("mapSearchLocation").value=Q("mapSearchLocation").value+String.fromCharCode(e.charCode)))}}function ondockeydown(e){if(setSessionActivity(),!xxdialogMode&&11==xxcurrentView&&desktop&&Q("DeskControl").checked){if(null!=currentNode){var t=GetNodeRights(currentNode);if(0==(0==(8192&features2)&&(4294967295==t||0!=(8&t)&&0==(256&t))))return!1;t=4294967295!=t&&0!=(8&t)&&0==(256&t)&&0!=(4096&t);if(1==t&&(1==e.altKey||1==e.ctrlKey||e.keyCode<32&&8!=e.keyCode&&13!=e.keyCode||90<e.keyCode))return!1}return desktop.m.handleKeyDown(e)}if(!xxdialogMode&&12==xxcurrentView&&terminal&&3==terminal.State&&null==xterm&&(terminal.m.TermHandleKeyDown(e),37<=e.keyCode)&&e.keyCode<=40&&haltEvent(e),!xxdialogMode&&13==xxcurrentView&&116==e.keyCode&&null!=p13filetree)return haltEvent(e),!1;if(!xxdialogMode&&(15==xxcurrentView||115==xxcurrentView))return agentConsoleHandleKeys(e);if(!xxdialogMode&&4==xxcurrentView&&(8===e.keyCode&&0==userSearchFocus&&(n=Q("UserSearchInput").value,Q("UserSearchInput").value=n.substring(0,n.length-1),i=1),27===e.keyCode&&(Q("UserSearchInput").value="",i=1),0<i))return 1==i&&mainUpdate(5),haltEvent(e);if(!xxdialogMode&&1==xxcurrentView&&1!=e.ctrlKey&&1!=e.altKey&&1!=e.metaKey){var n,i=0;if(Q("viewselect").value<4)if(8===e.keyCode&&0==searchFocus&&(n=Q("SearchInput").value,Q("KvmSearchInput").value=Q("SearchInput").value=n.substring(0,n.length-1),i=1),27===e.keyCode&&(Q("KvmSearchInput").value=Q("SearchInput").value="",i=1),0<i)return 1==i&&mainUpdate(5),haltEvent(e);4==Q("viewselect").value&&(8===e.keyCode&&0==mapSearchFocus&&(n=Q("mapSearchLocation").value,Q("mapSearchLocation").value=n.substring(0,n.length-1),i=1),27===e.keyCode)&&(Q("mapSearchLocation").value="",mapCloseSearchWindow())}}function ondockeyup(e){if(setSessionActivity(),!xxdialogMode&&11==xxcurrentView&&desktop&&Q("DeskControl").checked){if(null!=currentNode){var t=GetNodeRights(currentNode);if(0==(0==(8192&features2)&&(4294967295==t||0!=(8&t)&&0==(256&t))))return!1;t=4294967295!=t&&0!=(8&t)&&0==(256&t)&&0!=(4096&t);if(1==t&&(1==e.altKey||1==e.ctrlKey||e.keyCode<32&&8!=e.keyCode&&13!=e.keyCode||90<e.keyCode))return!1}return desktop.m.handleKeyUp(e)}return!xxdialogMode&&12==xxcurrentView&&terminal&&3==terminal.State&&null==xterm?terminal.m.TermHandleKeyUp(e):xxdialogMode||13!=xxcurrentView||116!=e.keyCode||null==p13filetree?xxdialogMode||4!=xxcurrentView||(8!==e.keyCode||0!=searchFocus)&&27!==e.keyCode?(xxdialogMode&&27==e.keyCode&&dialogclose(0),1!=e.shiftKey||27!=e.keyCode?!xxdialogMode&&0==xxcurrentView&&1!=e.ctrlKey&&1!=e.altKey&&1!=e.metaKey&&(Q("viewselect").value<4&&(8===e.keyCode&&0==searchFocus||27===e.keyCode)||4==Q("viewselect").value&&(8===e.keyCode&&0==mapSearchFocus||27===e.keyCode))?haltEvent(e):void 0:(dialogclose(0),Q("KvmSearchInput").value=Q("SearchInput").value="",mainUpdate(5),null!=desktop&&connectDesktop(),null!=terminal&&connectTerminal(),null!=files&&connectFiles(),void go(1))):haltEvent(e):(p13folderup(9999),haltEvent(e),!1)}function ondocblur(){if(!xxdialogMode&&11==xxcurrentView&&desktop&&Q("DeskControl").checked&&desktop.m.handleReleaseKeys)return desktop.m.handleReleaseKeys()}function devGrpMouseHover(e,t){setSessionActivity();Q("viewselect").value;e=e.children[1].children[1];e.children[0].classList.remove("g1s"),e.children[1].classList.remove("e2s"),e.children[2].classList.remove("g2s"),1==t&&(e.children[0].classList.add("g1s"),e.children[1].classList.add("e2s"),e.children[2].classList.add("g2s"))}function devMouseHover(e,t){setSessionActivity();var n,i=Q("viewselect").value;1==i?((n=e.children[0].children[0].children[1].children[0].children[0].children[0]).children[1].classList.remove("g1s"),n.children[2].classList.remove("e2s"),n.children[3].classList.remove("g2s"),1==t&&(n.children[1].classList.add("g1s"),n.children[2].classList.add("e2s"),n.children[3].classList.add("g2s"))):2==i&&((n=e).children[2].classList.remove("g1s"),n.children[4].classList.remove("e2s"),n.children[3].classList.remove("g2s"),1==t)&&(n.children[2].classList.add("g1s"),n.children[4].classList.add("e2s"),n.children[3].classList.add("g2s"))}var deviceHeaderCount,deviceHeaderId=0,deviceHeaderTotal=0,deviceHeadersTitles={},deviceHeaders={},oldviewmode=0;function updateDevices(){if(null!=nodes&&1==xxcurrentView){var e="",t=0,n=null,i={},o=Q("viewselect").value,s={},a={};if(QV("xdevices",4!=o),QV("xdevicesmap",4==o),QV("devListToolbar",o<3),QV("kvmListToolbar",3==o||5==o),QV("devMapToolbar",4==o),QV("devListToolbarSize",3==o||5==o),QV("devListToolbarSettings",2==o),QV("NoMeshesPanel",0==nodes.length&&0==meshcount),QV("devListToolbarViewIcons",0<nodes.length),QV("devListToolbarSort",0<nodes.length&&4!=o),0==nodes.length&&(o=1,sort=0),4==o)setTimeout(function(){null!=xxmap.map&&xxmap.map.updateSize()},200);else{deviceHeaderCount={},deviceHeaders={},deviceHeadersTitles={};var r=[],l=((deviceHeaderTotal=deviceHeaderId=0)==sort?nodes.sort(meshSort):1==sort?nodes.sort(powerSort):2==sort?1==showRealNames?nodes.sort(deviceHostSort):nodes.sort(deviceSort):5==sort&&(deviceViewSettings&&deviceViewSettings.devsCols&&0<=deviceViewSettings.devsCols.indexOf("lastseen")||(0==requestedLastConnects&&(requestedLastConnects=!0,meshserver.send({action:"lastconnects"})),null==deviceViewSettings&&(deviceViewSettings={}),Array.isArray(deviceViewSettings.devsCols)?deviceViewSettings.devsCols.push("lastseen"):deviceViewSettings.devsCols=["user","ip","conn","lastseen"]),nodes.sort(lastConnectSort)),Q("column_l").clientWidth-60),d=Math.floor(l/301),d=301+Math.floor((l-301*d)/d),c=4;for(w in deviceViewSettings&&deviceViewSettings.devsCols&&(c=deviceViewSettings.devsCols.length+1,0<=deviceViewSettings.devsCols.indexOf("desc"))&&c--,nodes){var u=nodes[w];if(0!=u.v){var p,m,g=meshes[u.meshid],h=GetNodeRights(u);if(0==sort?(meshes[u.meshid]?u.meshid:"*")!=n&&(1!=o&&3!=o&&5!=o||null==n||(e+="</div>"),deviceHeaderSet(),p="",2==o&&(e+="<tr><td colspan="+c+">"),meshes[u.meshid]&&1==meshes[u.meshid].mtype&&(p="<span class=devHeaderx>，仅限于Intel&reg; AMT</span>"),meshes[u.meshid]&&3==meshes[u.meshid].mtype&&(p=meshes[u.meshid].relayid?"<span class=devHeaderx>, 中继设备</span>":"<span class=devHeaderx>, 本地设备</span>"),1==o&&null!=n&&(2==t&&(e+="<td><div style=width:301px></div></td>"),""!=e)&&(e+="</tr></table>"),2==o&&(e+="<div>"),e=(e+="<div class=DevSt style=width:100%;padding-top:4px><span style=float:right>")+"<span id=DevxHeader"+deviceHeaderId+" class=devHeaderx></span>"+p+"</span>",1!=o&&2!=o&&3!=o&&5!=o||(k=CollapsedGroups[u.meshid],e+='<img class=collapseImage cmenu=expandAllContextMenu id="DevxColImg'+deviceHeaderId+'" src=images/c'+(!0===k?"1":"2")+'.png height=8 width=8 style=margin-left:2px;margin-right:2px;cursor:pointer onclick=toggleCollapseGroup("'+deviceHeaderId+'","'+u.meshid+'",'+o+")></img>"),n=meshes[u.meshid]?(e+='<span id=MxMESH cmenu=meshContextMenu tabindex=0 style=cursor:pointer onclick=gotoMesh("'+u.meshid+"\") onkeypress=\"if (event.key=='Enter') gotoMesh('"+u.meshid+"')\">"+EscapeHtml(meshes[u.meshid].name)+"</span>"+getMeshActions(g,h)+"</div>",u.meshid):(e+="<span id=MxMESH><i>个别装置</i></span></div>","*"),2==o&&(e+="</div>"),t=0,(i[n]=1)!=o&&3!=o&&5!=o||(e+="<div id=DevxCol"+deviceHeaderId+(!0===k?" style=display:none":"")+">")):1==sort?(p=u.pwr||0)!==n&&(1!=o&&3!=o&&5!=o||null==n||(e+="</div>"),deviceHeaderSet(),1==o&&null!==n&&(2==t&&(e+="<td><div style=width:301px></div></td>"),""!=e)&&(e+="</tr></table>"),2==o&&(e+="<tr><td colspan="+c+">"),e+="<div class=DevSt style=width:100%;padding-top:4px><span id=DevxHeader"+deviceHeaderId+" class=devHeaderx style=float:right></span>",1!=o&&2!=o&&3!=o&&5!=o||(k=CollapsedGroups["pwr:"+p],e+='<img class=collapseImage cmenu=expandAllContextMenu id="DevxColImg'+deviceHeaderId+'" src=images/c'+(!0===k?"1":"2")+'.png height=8 width=8 style=margin-left:2px;margin-right:2px;cursor:pointer onclick=toggleCollapseGroup("'+deviceHeaderId+'","pwr:'+p+'",'+o+")></img>"),e+="<span>"+PowerStateStr2(u.pwr)+"</span></div>",n=p,t=0,1!=o&&3!=o&&5!=o||(e+="<div id=DevxCol"+deviceHeaderId+(!0===k?" style=display:none":"")+">")):2!=sort&&5!=sort||null==n&&(n="1"),1==o?e+="<div name=xxdevice1 id=xv1"+u._id+" style=display:inline-block;position:relative;width:"+d+"px;height:50px;padding-top:1px;padding-bottom:1px></div>":2==o?(m=u.meshid,1==sort?m="pwr:"+(u.pwr||0):3!=sort&&4!=sort||(m="tag:**xx**xx*TaG*xx**xx**"),e+="<tr name=xxdevice2 colname=DevxCol"+m+" style=height:20px"+((k=3!=sort&4!=sort&CollapsedGroups[m])?";display:none":"")+" id=xv2"+u._id+"></tr>"):(3==o||5==o)&&1&u.conn&&0!=(8&h||256&h)&&u.agent&&0!=(1&u.agent.caps)&&(0!=Object.keys(checkedNodeids).length&&!checkedNodeids[u._id]||(e+=updateDeviceViewHtml(o,null,u),r.push(u._id))),(3==sort||4==sort)&&""!=e){if(u.tags)for(var v in u.tags){var f=u.tags[v],k=(4==sort&&(f=g?g.name+" - "+u.tags[v]:"**INDV*~*DEVS** - "+u.tags[v]),CollapsedGroups["tag:"+encodeURIComponentEx(f)]),x=e.replace("**xx**xx*TaG*xx**xx**",encodeURIComponentEx(f)+(k?" style=display:none":""));if(null==s[f]?(s[f]=x,a[f]=1):(s[f]+=x,a[f]+=1),3==o||5==o)break}else 4!=sort||null==g||null!=u.tags&&0!=u.tags.length||(f=g.name,k=CollapsedGroups["tag:"+encodeURIComponentEx(f)],x=e.replace("**xx**xx*TaG*xx**xx**",encodeURIComponentEx(f)+(k?" style=display:none":"")),null==s[f]?(s[f]=x,a[f]=1):(s[f]+=x,a[f]+=1));e=""}deviceHeaderTotal++,void 0===deviceHeaderCount[u.state]?deviceHeaderCount[u.state]=1:deviceHeaderCount[u.state]++}}if(1==o&&null!=n&&(e+="</div>"),32<=r.length&&(Q("autoConnectDesktopCheckbox").checked=!1),QE("autoConnectDesktopCheckbox",r.length<32),3==sort||4==sort){var y=[],b=0;for(w in s)y.push(w);for(v in y.sort(function(e,t){return sortCollator.compare(e.toLowerCase(),t.toLowerCase())}),y){var w=y[v];e=2==o?(e=(e+="<tr><td colspan="+c+"><div class=DevSt style=width:100%;padding-top:4px>")+'<img class=collapseImage cmenu=expandAllContextMenu id="DevxColImg'+b+'" src=images/c'+(!0===(k=CollapsedGroups["tag:"+encodeURIComponentEx(w)])?"1":"2")+'.png height=8 width=8 style=margin-left:2px;margin-right:2px;cursor:pointer onclick=toggleCollapseGroup("'+b+'","tag:'+encodeURIComponentEx(w)+'",2)></img>')+"<span class=devHeaderx style=float:right>"+a[w]+" node"+(1<a[w]?"s":"")+"</span><span>"+EscapeHtml(w).split("|").join(" &rarr; ").split("**INDV*~*DEVS**").join("<i>个别装置</i>")+"</span></div>"+s[w]:(e=(e=(e+="<div class=DevSt style=width:100%;padding-top:4px><span class=devHeaderx style=float:right>"+format(1<a[w]?"{0} nodes":"{0} node",a[w])+"</span>")+'<img class=collapseImage cmenu=expandAllContextMenu id="DevxColImg'+b+'" src=images/c'+(!0===(k=CollapsedGroups["tag:"+encodeURIComponentEx(w)])?"1":"2")+'.png height=8 width=8 style=margin-left:2px;margin-right:2px;cursor:pointer onclick=toggleCollapseGroup("'+b+'","tag:'+encodeURIComponentEx(w)+'")></img>')+"<span>"+EscapeHtml(w).split("|").join(" &rarr; ").split("**INDV*~*DEVS**").join("<i>个别装置</i>")+"</span></div>")+"<div id=DevxCol"+b+(!0===k?" style=display:none":"")+">"+s[w]+"</div>",b++}}var S=!1;if(""==e&&0<nodes.length&&(""!=Q("SearchInput").value||0!=Q("DevFilterSelect").value)&&(S=!0,e=3==sort?'<div style="margin:30px">没有一个设备被加入任何一组，请单击一个设备的“组”以添加到一个组中。</div>':'<div style="margin:30px">没有与此搜索匹配的设备。 <a onclick=clearDeviceSearch()>清除搜索过滤器</a></div>'),1==o&&2==t&&(e+="<td><div style=width:301px></div></td>"),0==sort&&""==Q("SearchInput").value&&0==Q("DevFilterSelect").value&&o<3){var D=deviceHeaderId,C=[];for(w in meshes)C.push(meshes[w]);for(w in C.sort(nameSort),C){var M=C[w],h=GetMeshRights(M);null==i[M._id]&&(""!=n&&""!=e&&(e+="</tr></table>"),e=(e=(e=(e+="<table style=width:100%;padding-top:4px cellpadding=0 cellspacing=0><tr><td colspan=3 class=DevSt>")+'<img class=collapseImage cmenu=expandAllContextMenu id="DevxColImg'+ ++D+'" src=images/c'+(!0===(k=CollapsedGroups[M._id])?"1":"2")+'.png height=8 width=8 style=margin-left:2px;margin-right:2px;cursor:pointer onclick=toggleCollapseGroup("'+D+'","'+M._id+'")></img>')+'<span id=MxMESH style=cursor:pointer onclick=gotoMesh("'+M._id+'")>'+EscapeHtml(M.name)+"</span><span>")+getMeshActions(M,h)+"</span></td></tr><tr>",1==M.mtype?(e+="<td><div style=padding:10px><i>此设备组中没有英特尔&reg; AMT 设备",0==(4&h)||4294967295!=userinfo.siteadmin&&0!=(4096&userinfo.siteadmin)||(e+=", <a href=# style=cursor:pointer onclick='return addDeviceToMesh(\""+M._id+"\")'>添加</a>")):2==M.mtype?(e=e+"<td><div id=DevxCol"+D+(!0===k?" style=display:none":"")+"><div style=padding:10px><i>此设备组中没有设备",0==(4&h)||4294967295!=userinfo.siteadmin&&0!=(4096&userinfo.siteadmin)||(e+=", <a href=# style=cursor:pointer onclick='return addAgentToMesh(\""+M._id+"\")'>添加</a>")):3==M.mtype?(e=e+"<td><div id=DevxCol"+D+(!0===k?" style=display:none":"")+"><div style=padding:10px><i>此设备组中没有本地设备",0==(4&h)||4294967295!=userinfo.siteadmin&&0!=(4096&userinfo.siteadmin)||(e+=", <a href=# style=cursor:pointer onclick='return addLocalDeviceToMesh(\""+M._id+"\")'>添加</a>")):4==M.mtype&&(e=e+"<td><div id=DevxCol"+D+(!0===k?" style=display:none":"")+"><div style=padding:10px><i>此设备组中没有设备"),e+=".</i></div></td></div>",n=M._id,0)}}for(w in""!=e&&0==S?(e+="</table>",2==o&&(S="",null==deviceViewSettings&&(deviceViewSettings={}),Array.isArray(deviceViewSettings.devsCols)||(deviceViewSettings.devsCols=["user","ip","conn"]),0<=deviceViewSettings.devsCols.indexOf("agtype")&&(S+="<th style=color:gray;width:100px>代理类型"),0<=deviceViewSettings.devsCols.indexOf("agver")&&(S+="<th style=color:gray;width:100px>代理版本"),0<=deviceViewSettings.devsCols.indexOf("os")&&(S+="<th style=color:gray;width:160px>操作系统"),0<=deviceViewSettings.devsCols.indexOf("tags")&&(S+="<th style=color:gray;width:120px>标签"),0<=deviceViewSettings.devsCols.indexOf("windowsav")&&(S+="<th style=color:gray;width:100px>Windows AV"),0<=deviceViewSettings.devsCols.indexOf("windowsupdate")&&(S+="<th style=color:gray;width:120px>Windows Update"),0<=deviceViewSettings.devsCols.indexOf("windowsfirewall")&&(S+="<th style=color:gray;width:120px>Windows Firewall"),0<=deviceViewSettings.devsCols.indexOf("lastbootuptime")&&(S+="<th style=color:gray;width:120px>Last Boot Up Time"),0<=deviceViewSettings.devsCols.indexOf("links")&&(S+="<th style=color:gray;width:120px>链接"),0<=deviceViewSettings.devsCols.indexOf("user")&&(S+="<th style=color:gray;width:120px>用户"),0<=deviceViewSettings.devsCols.indexOf("ip")&&(S+="<th style=color:gray;width:120px>地址"),0<=deviceViewSettings.devsCols.indexOf("conn")&&(S+="<th style=color:gray;width:100px>连接性"),0<=deviceViewSettings.devsCols.indexOf("amthost")&&(S+="<th style=color:gray;width:100px>AMT Host"),0<=deviceViewSettings.devsCols.indexOf("amtstate")&&(S+="<th style=color:gray;width:100px>AMT State"),0<=deviceViewSettings.devsCols.indexOf("lastseen")&&(S+="<th style=color:gray;width:120px>最后一次露面",0==requestedLastConnects)&&(requestedLastConnects=!0,meshserver.send({action:"lastconnects"})),e="<table style=width:100%;margin-top:4px cellpadding=0 cellspacing=0><th style=color:gray>"+S+e+"</tr></table><div style=height:1px></div>")):(e+="</table>",3==sort&&(e='<div style="margin:10px"><i>找不到带有标签的设备。</i></div>')),e+="<div style=border-top-style:solid;border-top-width:1px;border-top-color:#DDDDDD;cursor:pointer;font-size:small;margin-top:4px>",o<3&&0==sort&&0<Object.keys(meshes).length&&(4294967295==userinfo.siteadmin||0==(64&userinfo.siteadmin))&&(e+='<a href=# onclick="return account_createMesh()" title="创建一个新的设备组。" style=cursor:pointer>添加设备组</a>&nbsp'),4294967295!=userinfo.siteadmin&&0!=(128&userinfo.siteadmin)||(e+="<a href=# onclick='return p10showMeshCmdDialog(0)' style=cursor:pointer title=\"下载MeshCmd，这是一个多功能的指令执行工具。\">MeshCmd</a>&nbsp","win32"!=navigator.platform.toLowerCase()&&"macintel"!=navigator.platform.toLowerCase())||(e+="<a href=# onclick='return p10showMeshRouterDialog()' style=cursor:pointer title=\"下载MeshCentral Router，一个TCP端口映射工具。\">路由器</a>&nbsp"),e+="</div><br/>",QH("xdevices",e),deviceHeaderSet(),deviceHeaders)QH(w,deviceHeaders[w]);for(w in deviceHeadersTitles)Q(w).title=deviceHeadersTitles[w];if(p1updateInfo(),3!=o&&5!=o||1!=xxcurrentView)disconnectAllKvmFunction(),Q("autoConnectDesktopCheckbox").checked=!1;else{var T,E=[{x:180,y:101},{x:302,y:169},{x:454,y:255}][Q("sizeselect").selectedIndex];for(w in 3==o&&(S=E.x+2,l=l-5,T=Math.floor(l/S),T=S+Math.floor((l-T*S)/T),E.y=E.y*(T/E.x),E.x=T),multiDesktop)multiDesktop[w].xxdelete=!0;for(w in r){var N=r[w],V=N.split("/")[2],A=multiDesktop[N];if(null!=A){var I=5==o?A.m.width*E.y/A.m.height:E.x;A.m.CanvasId.setAttribute("style","background-color:black;width:"+I+"px;height:"+E.y+"px"),Q("xkvmid_"+V).appendChild(A.m.CanvasId),delete A.xxdelete,QH("skvmid_"+V,["已断线","正在连线...","设定...","",""][null==A.m.State?A.m.state:A.m.State])}else{u=getNodeFromId(N);if(desktopNode==u&&null!=desktop){var t=desktop.m.CanvasId,I=5==o?desktop.m.width*E.y/desktop.m.height:E.x;t.setAttribute("id","kvmid_"+V),t.setAttribute("style","background-color:black;width:"+I+"px;height:"+E.y+"px"),t.setAttribute("onclick","toggleKvmDevice('"+N+"')"),t.removeAttribute("onmousedown"),t.removeAttribute("onmouseup"),t.removeAttribute("onmousemove"),Q("xkvmid_"+V).appendChild(t),QH("skvmid_"+V,["已断线","正在连线...","设定...","",""][null==desktop.m.State?desktop.m.state:desktop.m.State]),desktop.m.SendCompressionLevel&&desktop.m.SendCompressionLevel(multidesktopsettings.agentencoding,multidesktopsettings.quality,multidesktopsettings.scaling,multidesktopsettings.framerate),desktop.shortid=V,desktop.onStateChanged=onMultiDesktopStateChange,desktop.m.onRemoteInputLockChanged=null,desktop.m.onKeyboardStateChanged=null,multiDesktop[N]=desktop,desktop=desktopNode=currentNode=null,QH("DeskParent",'<canvas id="Desk" oncontextmenu="return false" onmousedown=dmousedown(event) onmouseup=dmouseup(event) onmousemove=dmousemove(event)></canvas>')}else{(t=document.createElement("canvas")).setAttribute("id","kvmid_"+V),t.setAttribute("width",640),t.setAttribute("height",480),t.setAttribute("oncontextmenu","return false"),t.setAttribute("style","background-color:black;width:"+E.x+"px;height:"+E.y+"px"),t.setAttribute("onclick","toggleKvmDevice('"+N+"')");try{Q("xkvmid_"+V).appendChild(t)}catch(e){}1==Q("autoConnectDesktopCheckbox").checked&&setTimeout(function(){connectMultiDesktop(u,1)},100)}}}for(w in multiDesktop)1==multiDesktop[w].xxdelete?(multiDesktop[w].Stop(),delete multiDesktop[w]):debugmode&&multiDesktop[w].m&&multiDesktop[w].m.onScreenSizeChange&&mdeskAdjust(multiDesktop[w].m,multiDesktop[w].m.ScreenWidth,multiDesktop[w].m.ScreenHeight,multiDesktop[w].m.CanvasId);deskAdjust()}}oldviewmode=o,onDevicesScrollEx()}}var onDevicesTouchActive=!1,onDevicesScrollnagleTimer=null;function onDevicesScroll(e){(e=void 0===e?!1:e)&&(Q("xdevices").scrollTop=0),null!=onDevicesScrollnagleTimer||onDevicesTouchActive||(onDevicesScrollnagleTimer=setTimeout(onDevicesScrollEx,250))}function onDeviceTouch(e){onDevicesTouchActive!=e&&0==(onDevicesTouchActive=e)&&onDevicesScrollEx()}function onDevicesScrollEx(){null!=onDevicesScrollnagleTimer&&(clearTimeout(onDevicesScrollnagleTimer),onDevicesScrollnagleTimer=null);for(var e,t=Q("xdevices").scrollTop-200,n=Q("xdevices").scrollTop+Q("xdevices").clientHeight+200,i=Q("viewselect").value,o=document.getElementsByName("xxdevice"+i),s=0;s<o.length;s++)o[s].offsetTop>=t&&o[s].offsetTop<n&&null!=(e=getNodeFromId(o[s].id.substring(3)))?updateDeviceViewHtml(i,o[s],e):o[s].innerHTML=""}function updateDeviceViewDevice(e){var t,n=Q("viewselect").value;1!=n&&2!=n?mainUpdate(4):null!=(e="string"==typeof e?getNodeFromId(e):e)&&null!=(t=Q("xv"+n+e._id))&&""!=t.innerHTML&&updateDeviceViewHtml(n,t,e)}function updateDeviceViewHtml(e,t,n){var i=EscapeHtml(n.name),o=(0==i.length&&(i="<i>没有</i>"),null!=n.rname&&0<n.rname.length&&(i+=" / "+EscapeHtml(n.rname)),EscapeHtml(n.name));if(0==(o=1==showRealNames&&null!=n.rname?EscapeHtml(n.rname):o).length&&(o="<i>没有</i>"),1==e&&"none"==t.parentNode.style.display||2==e&&"none"==t.style.display)t.innerHTML="";else{var s="",a="",r=(1==stars[n._id]&&(a+=2==e?"<img class=deviceNotifySmallDotSub src=images/icon-star-notify-10.png width=10 height=10>":"<img class=deviceNotifyDotSub src=images/icon-star-notify-16.png width=16 height=16>"),null!=n.sessions&&(null!=n.sessions.msg&&(a+=2==e?"<div onclick=showDeviceMessages('"+n._id+'\',null,event) style="width:10;height:10" class=deviceNotifySmallDotSub></div>':"<div onclick=showDeviceMessages('"+n._id+'\',null,event) style="width:16;height:16" class=deviceNotifyDotSub>'+Object.keys(n.sessions.msg).length+"</div>"),null==n.sessions.kvm&&null==n.sessions.terminal&&null==n.sessions.files&&null==n.sessions.tcp&&null==n.sessions.udp||(a+=2==e?"<img onclick=showDeviceSessions('"+n._id+"',null,event) class=deviceNotifySmallDotSub src=images/icon-relay-notify10.png width=10 height=10>":"<img onclick=showDeviceSessions('"+n._id+"',null,event) class=deviceNotifyDotSub src=images/icon-relay-notify.png width=16 height=16>"),null!=n.sessions.help&&(a+=2==e?"<img onclick=showDeviceHelpRequests('"+n._id+"',null,event) class=deviceNotifySmallDotSub src=images/icon-help-notify-10.png width=10 height=10>":"<img onclick=showDeviceHelpRequests('"+n._id+"',null,event) class=deviceNotifyDotSub src=images/icon-help-notify-16.png width=16 height=16>"),null!=n.sessions.battery)&&1==e&&(l="","ac"==(r=n.sessions.battery).state&&(l="设备已插入"),"dc"==r.state&&(l="设备由电池供电"),c="",d=-1,"number"==typeof r.level&&0<=r.level&&r.level<=100&&(c=r.level+"%",5<(d=Math.floor((r.level+10)/25)+1)&&(lvl=5),"ac"==r.state)&&(100==r.level?d=11:d+=5),0<d)&&(s+='<div class="deviceBatterySmall deviceBatterySmall'+d+'" title="'+(null!=l?l+", "+c:c)+'"></div>'),""!=a&&(s+=2==e?"<div class=deviceNotifySmallDot>"+a+"</div>":"<div class=deviceNotifyDot>"+a+"</div>"),n.icon);if(n.conn&&0!=n.conn||3==n.mtype||(r+=" gray"),1==e)t.innerHTML='<table id=devs cmenu=devsContentMenu onmouseover=devMouseHover(this,1) onmouseout=devMouseHover(this,0) style=width:100%;height:100%><tr><td style=width:22px><input class="'+n.meshid+' DeviceCheckbox" onchange=p1devcheck(event) value=devid_'+n._id+" type=checkbox "+(checkedNodeids[n._id]?" checked":"")+"></td><td><table onmouseup=gotoDevice('"+n._id+"',null,null,event) border=0 cellspacing=0 style=width:100%;height:100%;cursor:pointer><tr><td style=width:50px tabindex=0 onkeypress=\"if (event.key=='Enter') gotoDevice('"+n._id+'\',null,null,event)"><div class="i'+r+'" style=width:50px></div></td><td class=g1t></td><td class=e2t><div class=e1t style=width:'+(t.clientWidth-120)+'px title="'+i+'">'+o+"</div><div>"+NodeStateStr(n)+"</div></td><td class=g2t></td></tr></table></td></tr></table>"+s;else if(2==e){var l,d=[],c=(n.conn&&(0!=(1&n.conn)&&(4==n.mtype?"PDU"==n.porttype?d.push('<span title="交换机端口已准备好使用。">转变</span>'):d.push('<span title="IP-KVM 端口已连接并可使用。">IP-KVM</span>'):d.push('<span title="已连接Mesh代理并准备使用。">代理</span>')),0!=(2&n.conn)?d.push('<span title="英特尔&reg;AMT CIRA已连接并可以使用。">CIRA</span>'):0!=(4&n.conn)&&d.push('<span title="英特尔&reg;AMT是可路由的。">AMT</span>'),0!=(8&n.conn)&&d.push('<span title="Mesh代理可以经过其他代理作为中继访问得到。">中继</span>'),0!=(16&n.conn))&&d.push('<span title="与设备的MQTT连接已激活。">MQTT</span>'),3==n.mtype&&((l=meshes[n.meshid])&&l.relayid?d.push('<span title="通过中继代理的本地网络连接。">中继</span>'):d.push('<span title="本地网络连接。">本地</span>')),n.desc&&0<=deviceViewSettings.devsCols.indexOf("desc")&&(o="<div style=float:right"+(1==stars[n._id]?";padding-right:15px":"")+">"+EscapeHtml(n.desc)+"</div><div>"+o+"</div>"),n.meshid),u=(1==sort?c="pwr:"+(n.pwr||0):3!=sort&&4!=sort||(c="tag:**xx**xx*TaG*xx**xx**"),CollapsedGroups[c],"<td style=position:relative><div id=devs cmenu=devsContentMenu class=bar18 tabindex=0 onmouseover=devMouseHover(this,1) onmouseout=devMouseHover(this,0) style=height:18px;width:100%;font-size:medium onkeypress=\"if (event.key=='Enter') gotoDevice('"+n._id+"',null,null,event)\">");if(u=(u=(u+='<div class=deviceBarCheckbox><input class="'+n.meshid+' DeviceCheckbox" value=devid_'+n._id+" type=checkbox onchange=p1devcheck(event) "+(checkedNodeids[n._id]?" checked":"")+"></div>")+("<div class=deviceBarIcon onmouseup=gotoDevice('"+n._id+"',null,null,event)><div class=\"j"+r+'" style=width:16px;margin-top:1px;margin-left:2px;height:16px></div></div>'))+"<div class=g1 style=height:18px;float:left></div><div class=g2 style=height:18px;float:right></div>"+('<div class=style10 style=cursor:pointer;font-size:14px;max-height:18px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap title="'+i+"\" onmouseup=gotoDevice('"+n._id+"',null,null,event)>"+o+"</div></div>"+s+"</td>"),null==deviceViewSettings&&(deviceViewSettings={}),Array.isArray(deviceViewSettings.devsCols)||(deviceViewSettings.devsCols=["user","ip","conn"]),0<=deviceViewSettings.devsCols.indexOf("agtype")&&(u+='<td style=text-align:center;font-size:x-small;padding-left:4px;padding-right:4px title="'+EscapeHtml(3!=n.mtype&&n.agent&&n.agent.id&&n.agent.id<=agentsStr.length?agentsStr[n.agent.id]:"")+'">'+EscapeHtml(3!=n.mtype&&n.agent&&n.agent.id&&n.agent.id<=agentsStr.length?agentsStr[n.agent.id]:"").replace(",","<br />")),0<=deviceViewSettings.devsCols.indexOf("agver")&&(u+='<td style=text-align:center;font-size:x-small;padding-left:4px;padding-right:4px title="'+EscapeHtml(n.agent&&n.agent.core?n.agent.core:"")+'">'+EscapeHtml(n.agent&&n.agent.core?n.agent.core:"").replace(",","<br />")),0<=deviceViewSettings.devsCols.indexOf("os")&&(3==n.mtype?(a="",4==n.agent.id&&(a="Windows"),6==n.agent.id&&(a="Linux"),29==n.agent.id&&(a="MacOS"),u+='<td style=text-align:center;font-size:x-small title="'+EscapeHtml(a)+'">'+EscapeHtml(a)):u+='<td style=text-align:center;font-size:x-small title="'+EscapeHtml(n.osdesc||"")+'">'+EscapeHtml(n.osdesc||"")),0<=deviceViewSettings.devsCols.indexOf("tags")){u+="<td style=text-align:center;font-size:x-small>";var p="";if(null!=n.tags)for(var m in n.tags)p+="<span class=tagSpan>"+EscapeHtml(n.tags[m])+"</span> ";u+="<span style=line-height:20px>"+p+"</span>"}0<=deviceViewSettings.devsCols.indexOf("windowsav")&&(u+="<td style=text-align:center>"+(n.wsc&&null!=n.wsc.antiVirus?"OK"==n.wsc.antiVirus?"<span style=color:green>OK</span>":"<span style=color:red>坏的</span>":"")),0<=deviceViewSettings.devsCols.indexOf("windowsupdate")&&(u+="<td style=text-align:center>"+(n.wsc&&null!=n.wsc.autoUpdate?"OK"==n.wsc.autoUpdate?"<span style=color:green>OK</span>":"<span style=color:red>坏的</span>":"")),0<=deviceViewSettings.devsCols.indexOf("windowsfirewall")&&(u+="<td style=text-align:center>"+(n.wsc&&null!=n.wsc.firewall?"OK"==n.wsc.firewall?"<span style=color:green>OK</span>":"<span style=color:red>坏的</span>":"")),0<=deviceViewSettings.devsCols.indexOf("lastbootuptime")&&(u+="<td style=text-align:center;font-size:x-small>"+(null!=n.lastbootuptime?printDateTime(new Date(n.lastbootuptime)):"")),0<=deviceViewSettings.devsCols.indexOf("links")&&(u+="<td style=text-align:center;font-size:x-small>"+getShortRouterLinks(n)),0<=deviceViewSettings.devsCols.indexOf("user")&&(u+="<td style=text-align:center>"+getUserShortStr(n)),0<=deviceViewSettings.devsCols.indexOf("ip")&&(l="",3==n.mtype?l=n.host:n.ip&&(l=n.ip),u+="<td style=text-align:center>"+l),0<=deviceViewSettings.devsCols.indexOf("conn")&&(u+="<td style=text-align:center>"+d.join("&nbsp;+&nbsp;")),0<=deviceViewSettings.devsCols.indexOf("lastseen")&&(u+="<td style=text-align:center;font-size:x-small>",0<n.conn?u+="已连接":null!=n.lastconnect&&(u+=printDateTime(new Date(n.lastconnect)))),0<=deviceViewSettings.devsCols.indexOf("amthost")&&(u+="<td style=text-align:center>"+(null==n.intelamt||null==n.intelamt.host?"":EscapeHtml(n.intelamt.host))),0<=deviceViewSettings.devsCols.indexOf("amtstate")&&(c="",n.intelamt&&(0==n.intelamt.state&&(c=' <span title="Intel&reg; AMT is not activated">Pre</span>'),1==n.intelamt.state&&(c=' <span title="Intel&reg; AMT is in activation mode">In</span>'),2==n.intelamt.state)&&n.intelamt.flags&&(2&n.intelamt.flags?c=' <span title="英特尔AMT在客户端控制模式下被激活">CCM</span>':4&n.intelamt.flags&&(c+=' <span title="在Intel&reg; AMT尔AMT">ACM</span>')),u+="<td style=text-align:center>"+c),t.innerHTML=u}else if(3==e||5==e)return u="<div id=devs cmenu=devsContentMenu style=display:inline-block;position:relative;margin:1px;background-color:lightgray;border-radius:5px;position:relative><div tabindex=0 style=padding:3px;cursor:pointer onmouseup=gotoDevice('"+n._id+"',11,null,event) onkeypress=\"if (event.key=='Enter') gotoDevice('"+n._id+"',11,null,event)\">"+s,(u+='<div class="j'+r+'" style=width:16px;float:left></div>&nbsp;'+o+"</div>")+"<span onmouseup=gotoDevice('"+n._id+"',null,null,event)></span><div id=xkvmid_"+n._id.split("/")[2]+"><div id=skvmid_"+n._id.split("/")[2]+' tabindex=0 style="position:absolute;color:white;left:5px;top:27px;text-shadow:0px 0px 5px #000;z-index:10;cursor:default" onclick=toggleKvmDevice(\''+n._id+"') onkeypress=\"if (event.key=='Enter') toggleKvmDevice('"+n._id+"')\">已断线</div></div></div>"}}function getShortRouterLinks(e){var t="",n=GetNodeRights(e);if((0!=(1&e.conn)||3==e.mtype)&&e.agent&&0!=(8&n)&&14!=e.agent.id&&(0!=webRelayPort&&(t=(t+='<a href=# onclick=p10WebRouter("'+e._id+'",1,'+(e.httpport||80)+")>HTTP"+(e.httpport&&80!=e.httpport?"/"+e.httpport:"")+"</a>&nbsp;")+'<a href=# onclick=p10WebRouter("'+e._id+'",2,'+(e.httpsport||443)+")>HTTPS"+(e.httspport&&443!=e.httpsport?"/"+e.httpsport:"")+"</a>&nbsp;"),0<e.agent.id&&e.agent.id<5&&("win32"!=navigator.platform.toLowerCase()||null!=serverinfo.devicemeshrouterlinks&&0==serverinfo.devicemeshrouterlinks.rdp||(t+='<a href=# cmenu=altPortContextMenu id=rdpMCRouterLink onclick=p10MCRouter("'+e._id+'",3)>RDP</a>&nbsp;')),4<e.agent.id&&("win32"!=navigator.platform.toLowerCase()&&"macintel"!=navigator.platform.toLowerCase()||null!=serverinfo.devicemeshrouterlinks&&0==serverinfo.devicemeshrouterlinks.ssh||(t+='<a href=# onclick=p10MCRouter("'+e._id+'",4,'+(e.sshport||22)+")>SSH</a>&nbsp;"),"win32"!=navigator.platform.toLowerCase()||null!=serverinfo.devicemeshrouterlinks&&0==serverinfo.devicemeshrouterlinks.scp||(t+='<a href=# onclick=p10MCRouter("'+e._id+'",5,'+(e.sshport||22)+")>SCP</a>&nbsp;")),"win32"==navigator.platform.toLowerCase()||"macintel"==navigator.platform.toLowerCase())&&null!=serverinfo.devicemeshrouterlinks&&Array.isArray(serverinfo.devicemeshrouterlinks.extralinks))for(var i in serverinfo.devicemeshrouterlinks.extralinks){var i=serverinfo.devicemeshrouterlinks.extralinks[i],o='"'+i.protocol+'"';doesDeviceMatchFilterTags(e,i.filter)&&(3!=e.mtype||"mcrdesktop"!=i.protocol&&"mcrfiles"!=i.protocol)&&("number"==typeof i.protocol?o=i.protocol:"http"==i.protocol?o=1:"https"==i.protocol?o=2:"rdp"==i.protocol?o=3:"ssh"==i.protocol?o=4:"scp"==i.protocol?o=5:"mcrdesktop"==i.protocol?o=6:"mcrfiles"==i.protocol&&(o=7),t+='<a href=# onclick=p10MCRouter("'+e._id+'",'+o+","+i.port+(i.ip?',"'+i.ip+'"':",null")+","+(i.localport||0)+")>"+i.name+"</a>&nbsp;")}return t}function doesDeviceMatchFilterTags(e,t){if(null==t)return!0;if(Array.isArray(t)){if(0<=t.indexOf(e.meshid))return!0;if(0<=t.indexOf(e._id))return!0;if(Array.isArray(e.tags))for(var n in e.tags)if(0<=t.indexOf("tag:"+e.tags[n]))return!0}return!1}function showDeviceHelpRequests(e,t,n){if(n&&haltEvent(n),!xxdialogMode||t){var i=null,o="";if(null==(i=null==e?currentNode:getNodeFromId(e))||null==i.sessions)setDialogMode(0);else{if(null!=i.sessions.help)for(var s in i.sessions.help)o+='<div style="background-color:#CCC;padding:6px;border-radius:6px"><a style="float:right" onclick=closeDeviceHelpRequest("'+encodeURIComponentEx(s)+'","'+encodeURIComponentEx(i._id)+'")>解雇</a><div style=margin-bottom:6px><b>'+EscapeHtml(s)+"</b></div><div style=margin-bottom:6px>"+EscapeHtml(i.sessions.help[s])+"</div></div>";""!=o?setDialogMode(2,"帮助请求 - "+EscapeHtml(i.name),1,null,o,"HELPREQ-"+i._id):setDialogMode(0)}}return!1}function closeDeviceHelpRequest(e,t){setDialogMode(0),meshserver.send({action:"msg",type:"localapp",nodeid:decodeURIComponent(t),appid:decodeURIComponent(e),value:{cmd:"cancelhelp"}})}function showDeviceSessions(e,t,n){if(n&&haltEvent(n),!xxdialogMode||t){var i=null,o="";if(null==(i=null==e?currentNode:getNodeFromId(e))||null==i.sessions)setDialogMode(0);else{for(var s in i.sessions)if("kvm"==s&&null==i.sessions.multidesk)for(var a in o+="<u>远程桌面</u>",i.sessions.kvm)a.startsWith("user/")?(r="",a!=userinfo._id&&4294967295!=GetNodeRights(i)||(r=' <a href=# onclick=\'return endDeviceSession("kvm", "'+encodeURIComponentEx(i._id)+'", "'+encodeURIComponentEx(a)+'")\' title="断开此会话" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>'),o+=addHtmlValue2(getUserName(a),(1==i.sessions.kvm[a]?"1节":nobreak(format("{0}节",i.sessions.kvm[a])))+r)):"busy"==a&&(o+=addHtmlValue2("设备忙",1==i.sessions.kvm[a]?"1节":nobreak(format("{0}节",i.sessions.kvm[a]))));else if("multidesk"==s)for(var a in o+="<u>远程桌面</u>",i.sessions.multidesk){var r="";a!=userinfo._id&&4294967295!=GetNodeRights(i)||(r=' <a href=# onclick=\'return endDeviceSession("multidesk", "'+encodeURIComponentEx(i._id)+'", "'+encodeURIComponentEx(a)+'")\' title="断开此会话" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>'),o+=addHtmlValue2(getUserName(a),(1==i.sessions.multidesk[a]?"1节":nobreak(format("{0}节",i.sessions.multidesk[a])))+r)}else if("terminal"==s)for(var a in o+="<u>终端</u>",i.sessions.terminal){r="";a!=userinfo._id&&4294967295!=GetNodeRights(i)||(r=' <a href=# onclick=\'return endDeviceSession("terminal", "'+encodeURIComponentEx(i._id)+'", "'+encodeURIComponentEx(a)+'")\' title="断开此会话" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>'),o+=addHtmlValue2(getUserName(a),(1==i.sessions.terminal[a]?"1节":nobreak(format("{0}节",i.sessions.terminal[a])))+r)}else if("files"==s)for(var a in o+="<u>档案</u>",i.sessions.files){r="";a!=userinfo._id&&4294967295!=GetNodeRights(i)||(r=' <a href=# onclick=\'return endDeviceSession("files", "'+encodeURIComponentEx(i._id)+'", "'+encodeURIComponentEx(a)+'")\' title="断开此会话" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>'),o+=addHtmlValue2(getUserName(a),(1==i.sessions.files[a]?"1节":nobreak(format("{0}节",i.sessions.files[a])))+r)}else if("tcp"==s)for(var a in o+="<u>TCP路由</u>",i.sessions.tcp){r="";a!=userinfo._id&&4294967295!=GetNodeRights(i)||(r=' <a href=# onclick=\'return endDeviceSession("tcp", "'+encodeURIComponentEx(i._id)+'", "'+encodeURIComponentEx(a)+'")\' title="断开此会话" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>'),o+=addHtmlValue2(getUserName(a),(1==i.sessions.tcp[a]?"1节":nobreak(format("{0}节",i.sessions.tcp[a])))+r)}else if("udp"==s)for(var a in o+="<u>UDP路由</u>",i.sessions.udp){r="";a!=userinfo._id&&4294967295!=GetNodeRights(i)||(r=' <a href=# onclick=\'return endDeviceSession("udp", "'+encodeURIComponentEx(i._id)+'", "'+encodeURIComponentEx(a)+'")\' title="断开此会话" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>'),o+=addHtmlValue2(getUserName(a),(1==i.sessions.udp[a]?"1节":nobreak(format("{0}节",i.sessions.udp[a])))+r)}""!=o?setDialogMode(2,"会话 - "+EscapeHtml(i.name),1,null,o,"SESSIONS-"+i._id):setDialogMode(0)}}return!1}function endDeviceSession(e,t,n){var n=decodeURIComponent(n).split("/"),i=n[0]+"/"+n[1]+"/"+n[2],o=null;4==n.length&&n[3].startsWith("guest:")&&(o=atob(n[3].substring(6))),"multidesk"==e?meshserver.send({action:"endDesktopMultiplex",nodeid:decodeURIComponent(t),xuserid:i,guestname:o,guestname:o}):meshserver.send({action:"msg",type:"endtunnel",nodeid:decodeURIComponent(t),xuserid:i,guestname:o,guestname:o,protocol:e})}function showDeviceMessages(e,t,n){if(n&&haltEvent(n),!xxdialogMode||t){var i=null,o="<div style=max-height:200px;overflow-y:auto>",s=0;if(null==(i=null==e?currentNode:getNodeFromId(e))||null==i.sessions||null==i.sessions.msg)setDialogMode(0);else{for(var a in i.sessions.msg){var r=a,l=5;"string"==typeof i.sessions.msg[a].msg&&(r=i.sessions.msg[a].msg),"number"==typeof i.sessions.msg[a].msgid&&null!=eventsMessageId[i.sessions.msg[a].msgid]&&(r=eventsMessageId[i.sessions.msg[a].msgid]),o+="<table style=width:96%><td style=width:24px><div class=NotifyIconSmall"+(l=(l="number"==typeof i.sessions.msg[a].icon?i.sessions.msg[a].icon:l)<1||9<l?5:l)+'></div><td><div style="border-radius:5px;background-color:#BBB;width:100%;padding:8px">'+EscapeHtml(r)+"</div></table>",s++}o+="</div>",0<s&&setDialogMode(2,"代理消息 - "+EscapeHtml(i.name),1,null,o,"MESSAGES-"+i._id)}}return!1}function toggleCollapseGroup(e,t,n){if(2==n){var i=document.getElementsByName("xxdevice2");if(0==i.length)return;for(var o,s=[],a=0;a<i.length;a++)i[a].attributes.colname.value.substring(7)==t&&s.push(i[a]);(o="none"==s[0].style.display)?delete CollapsedGroups[t]:CollapsedGroups[t]=!0;for(a=0;a<s.length;a++)s[a].style.display=o?"":"none"}else(o="none"==QS("DevxCol"+e).display)?delete CollapsedGroups[t]:CollapsedGroups[t]=!0,QV("DevxCol"+e,o);Q("DevxColImg"+e).src=o?"images/c2.png":"images/c1.png",putstore("_collapse",JSON.stringify(CollapsedGroups)),updateCollapseAllButton(),onDevicesScrollEx(),onDevicesScrollEx()}function toggleKvmDevice(e){var t=GetNodeRights(e="string"==typeof e?getNodeFromId(e):e);(8&t||256&t)&&1&e.conn&&connectMultiDesktop(e,1)}function getUserShortStr(e){var t,n;return null!=e&&null!=e.users&&Array.isArray(e.users)&&0!=e.users.length?1<e.users.length?'<span title="'+EscapeHtml(e.users.join(", "))+'">'+nobreak(format("{0}个用户",e.users.length))+"</span>":(0<(n=(t=e=e.users[0]).indexOf("\\"))&&(t=e.substring(n+1)),15<(t=EscapeHtml(t)).length&&(t=t.substring(0,14)+"&#8230;"),'<span title="'+EscapeHtml(e)+'">'+t+"</span>"):""}function autoConnectDesktops(){1==Q("autoConnectDesktopCheckbox").checked&&connectAllKvmFunction()}function connectAllKvmFunction(e){if(xxdialogMode)return!1;if(!0!==e){var t=0;for(o in nodes){var n=nodes[o],i=nodes[o]._id;null!=multiDesktop[i]||0!=Object.keys(checkedNodeids).length&&!checkedNodeids[i]||(8&(i=GetNodeRights(n))||256&i)&&1&n.conn&&1==n.v&&t++}if(8<t)return void setDialogMode(2,"全部连接",3,function(){connectAllKvmFunction(!0)},format("您确定要连接到{0}设备吗？",t))}for(var o in nodes)1!=nodes[o].v||null!=multiDesktop[nodes[o]._id]||0!=Object.keys(checkedNodeids).length&&!checkedNodeids[nodes[o]._id]||toggleKvmDevice(nodes[o]._id)}function disconnectAllKvmFunction(){if(xxdialogMode)return!1;for(var e in multiDesktop)multiDesktop[e].Stop();multiDesktop={}}function onMultiDesktopStateChange(e,t){try{QH("skvmid_"+e.shortid,["已断线","正在连线...","设定...","",""][t])}catch(e){}}function onDeviceSearchChanged(e){var t=new URL(window.location.href);if(null==e||"SearchInput"!=e.target.id&&"KvmSearchInput"!=e.target.id?null!=e&&"DevFilterSelect"==e.target.id||(t.searchParams.delete("filter"),urlargs.filter&&delete urlargs.filter):("SearchInput"==e.target.id?Q("KvmSearchInput").value=Q("SearchInput").value:Q("SearchInput").value=Q("KvmSearchInput").value,""!=e.target.value?(t.searchParams.set("filter",e.target.value),urlargs.filter&&(urlargs.filter=e.target.value)):(t.searchParams.delete("filter"),urlargs.filter&&delete urlargs.filter)),0==(268435456&features)&&0<xxcurrentView)try{window.history.replaceState({},document.title,decodeURIComponent(t.toString()))}catch(e){}mainUpdate(5)}function showMultiDesktopSettings(){QV("td7amtkvm",!1),QV("td7meshkvm",!0),QV("td7rdpkvm",!1),QV("d7desktopOtherSettings",!1),d7bitmapquality.value=multidesktopsettings.quality,d7bitmapscaling.value=multidesktopsettings.scaling,d7encoding.value=multidesktopsettings.agentencoding,multidesktopsettings.framerate?d7framelimiter.value=multidesktopsettings.framerate:d7framelimiter.value=100,setDialogMode(7,"远程桌面设置",3,showMultiDesktopSettingsChanged)}function showMultiDesktopSettingsChanged(){for(var e in multidesktopsettings.quality=d7bitmapquality.value,multidesktopsettings.scaling=d7bitmapscaling.value,multidesktopsettings.framerate=d7framelimiter.value,multidesktopsettings.agentencoding=d7encoding.value,localStorage.setItem("multidesktopsettings",JSON.stringify(multidesktopsettings)),multiDesktop)multiDesktop[e].m.SendCompressionLevel(multidesktopsettings.agentencoding,multidesktopsettings.quality,multidesktopsettings.scaling,multidesktopsettings.framerate)}function connectMultiDesktop(e,t){var n=e._id,i=n.split("/")[2],o=multiDesktop[n];null==o?null!=Q("kvmid_"+i)&&(2==t?null!=e.intelamt.user&&""!=e.intelamt.user&&((o=CreateAmtRedirect(CreateAmtRemoteDesktop("kvmid_"+i),authCookie)).shortid=i,o.onStateChanged=onMultiDesktopStateChange,o.m.bpp=1,o.m.useZRLE=!0,o.m.showmouse=!0,o.m.onKvmData=function(e){console.log("KVM Data received in multi-desktop mode, this is not supported.")},o.m.onScreenSizeChange=mdeskAdjust,o.Start(n,16994,"*","*",0),o.contype=2,multiDesktop[n]=o):1==t&&((o=CreateAgentRedirect(meshserver,CreateAgentRemoteDesktop("kvmid_"+i),serverPublicNamePort,authCookie,authRelayCookie,domainUrl)).m.UseExtendedKeyFlag=e.agent.id<5,o.m.mouseCursorActive(11==xxcurrentView),o.shortid=i,o.attemptWebRTC=attemptWebRTC,o.webrtcconfig=webrtcconfiguration,o.onStateChanged=onMultiDesktopStateChange,o.m.ImageType=multidesktopsettings.agentencoding,o.m.CompressionLevel=multidesktopsettings.quality,o.m.ScalingLevel=multidesktopsettings.scaling,multidesktopsettings.framerate&&(o.m.FrameRateTimer=multidesktopsettings.framerate),multidesktopsettings.swapmouse&&(o.m.SwapMouse=multidesktopsettings.swapmouse),multidesktopsettings.rmw&&(o.m.ReverseMouseWheel=multidesktopsettings.rmw),1==multidesktopsettings.remotekeymap&&(o.m.remoteKeyMap=multidesktopsettings.remotekeymap),o.m.onScreenSizeChange=mdeskAdjust,o.Start(n),o.contype=1,multiDesktop[n]=o)):(o.Stop(),delete multiDesktop[n])}function getMeshActions(e,t){return 0==(4&t)?"":(t="",1==e.mtype&&(0==(1&features)&&(t=(t+=' <a href=# style=cursor:pointer;font-size:small title="添加位于本地网络上的新英特尔&reg;AMT计算机。" onclick=\'return addDeviceToMesh("'+e._id+"\")'>添加本地</a>")+' <a href=# style=cursor:pointer;font-size:small title="通过扫描本地网络添加新的英特尔&reg;AMT计算机。" onclick=\'return addAmtScanToMesh("'+e._id+"\")'>扫描网络</a>"),e.amt)&&0<e.amt.type&&(t+=' <a href=# style=cursor:pointer;font-size:small title="执行英特尔&reg;AMT激活和配置。" onclick=\'return showAmtSetup("'+e._id+"\")'>设定</a>"),2!=e.mtype||4294967295!=userinfo.siteadmin&&0!=(4096&userinfo.siteadmin)||(t+=' <a href=# style=cursor:pointer;font-size:small title="通过安装Mesh Agent将新计算机添加到该设备组。" onclick=\'return addAgentToMesh("'+e._id+"\")'>添加代理</a>",0==(2&features)&&(t+=' <a href=# style=cursor:pointer;font-size:small title="邀请某人在该设备组上安装Mesh代理。" onclick=\'return inviteAgentToMesh("'+e._id+"\")'>邀请</a>")),3==e.mtype&&(t+=' <a href=# style=cursor:pointer;font-size:small title="添加位于本地网络上的设备。" onclick=\'return addLocalDeviceToMesh("'+e._id+"\")'>添加设备</a>"),t)}function addLocalDeviceToMesh(e){if(xxdialogMode)return!1;var t=meshes[e],t=format('将本地设备添加到设备组 "{0}"。',EscapeHtml(t.name))+"<br /><br />";setDialogMode(2,"添加本地设备",3,addLocalDeviceToMeshEx,(t+=addHtmlValue("设备名称","<input id=dp1devicename style=width:230px maxlength=32 autocomplete=off onchange=validateLocalDeviceToMesh() onkeyup=validateLocalDeviceToMesh() />"))+addHtmlValue("主机名",'<input id=dp1hostname style=width:230px maxlength=32 autocomplete=off placeholder="与设备名称相同" onchange=validateLocalDeviceToMesh() onkeyup=validateLocalDeviceToMesh() />')+addHtmlValue("类型","<select id=dp1type style=width:236px><option value=4>Windows (RDP)</option><option value=6>Linux (SSH/SCP/VNC)</option><option value=29>macOS (SSH/SCP/VNC)</option></select>"),e),validateLocalDeviceToMesh(),Q("dp1devicename").focus()}function validateLocalDeviceToMesh(){QE("idx_dlgOkButton",0<Q("dp1devicename").value.length)}function addLocalDeviceToMeshEx(e,t){var n=Q("dp1hostname").value;""==n&&(n=Q("dp1devicename").value),meshserver.send({action:"addlocaldevice",meshid:t,devicename:Q("dp1devicename").value,hostname:n,type:parseInt(Q("dp1type").value)})}function addDeviceToMesh(e){var t;return xxdialogMode||(t=meshes[e],t=format("将新的英特尔&reg;AMT设备添加到设备组“{0}”。",EscapeHtml(t.name))+"<br /><br />",setDialogMode(2,"添加英特尔&reg;AMT设备",3,addDeviceToMeshEx,t=(t=(t=(t=(t+=addHtmlValue("设备名称","<input id=dp1devicename style=width:230px maxlength=32 autocomplete=off onchange=validateDeviceToMesh() onkeyup=validateDeviceToMesh() />"))+addHtmlValue("主机名",'<input id=dp1hostname style=width:230px maxlength=32 autocomplete=off placeholder="与设备名称相同" onchange=validateDeviceToMesh() onkeyup=validateDeviceToMesh() />'))+addHtmlValue("用户名",'<input id=dp1username style=width:230px maxlength=32 autocomplete=off placeholder="管理员" onchange=validateDeviceToMesh() onkeyup=validateDeviceToMesh() />'))+addHtmlValue("密码","<input id=dp1password type=password style=width:230px autocomplete=off maxlength=32 onchange=validateDeviceToMesh() onkeyup=validateDeviceToMesh() />"))+addHtmlValue("安全","<select id=dp1tls style=width:236px><option value=0>没有TLS加密</option><option value=1>需要TLS加密</option></select>"),e),validateDeviceToMesh(),Q("dp1devicename").focus()),!1}function showAmtImport(e){xxdialogMode||(setDialogMode(2,"Intel&reg; AMT Device Import",3,showAmtImportEx,'Create many Intel&reg; AMT device at once by importing a JSON file with the following format:<br /><pre>[\r\n  {\r\n    "fqdn":"mycomputer.com",\r\n    "uuid":"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",\r\n    "version":"12.0.1",\r\n    "username":"admin",\r\n    "password":"password",\r\n    "tls":true\r\n  }\r\n]</pre><input style=width:370px type=file id=d4importFile accept=".json" onchange=showAmtImportValidate() />',e),QE("idx_dlgOkButton",!1))}function showAmtImportValidate(){QE("idx_dlgOkButton",null!=Q("d4importFile").value)}function showAmtImportEx(e,n){var t=new FileReader;t.onload=function(e){var t=null;try{t=JSON.parse(e.target.result)}catch(e){return void setDialogMode(2,"Intel&reg; AMT Device Import",1,null,format("无效的JSON档案：{0}。",e))}null!=t?meshserver.send({action:"importamtdevices",meshid:n,amtdevices:t}):setDialogMode(2,"Intel&reg; AMT Device Import",1,null,"无效的JSON档案格式。")},t.readAsText(Q("d4importFile").files[0])}function showAmtSetup(e){var t,n;return xxdialogMode||(t=serverinfo.name,n=meshes[e],-1!=t.indexOf(".")&&0==(2&features)||(t=window.location.hostname),domainUrl.substring(0,domainUrl.length-1),t=1==serverinfo.https?"wss://"+t+(443==serverinfo.port?"":":"+serverinfo.port)+domainUrl:"ws://"+t+(80==serverinfo.port?"":":"+serverinfo.port)+domainUrl,n=format("通过定期在远程设备上以管理员身份运行MeshCmd，添加，激活和配置Intel&reg; AMT以将“{0}”分组。",EscapeHtml(n.name))+"<br /><br />",n+="<textarea readonly=readonly style=width:100%;resize:none;height:100px;overflow:auto;font-size:12px readonly>meshcmd amtconfig --url "+t+"apf.ashx --id '"+e.split("/")[2]+"' --serverhttpshash "+serverinfo.tlshash+"</textarea>",null!=serverinfo.amtAcmFqdn&&(n+="<div style=margin-top:8px>对于ACM激活，需要将英特尔&reg;AMT设置为以下受信任的FQDN： <b>"+serverinfo.amtAcmFqdn.join(", ")+"</b></div>"),setDialogMode(2,"英特尔&reg;AMT设置",9,null,n),Q("idx_dlgOkButton").focus()),!1}function showAmtAcmSetup(){if(xxdialogMode)return!1;var e="<table><tr><td><img src=images/usbkey70.png height=70 width=31 style=margin-left:4px;margin-right:8px><td><div>使用FAT格式的USB密钥在管理控制模式（ACM）中激活英特尔&reg;AMT。将setup.bin放在其上，然后使用此键引导一台或多台计算机。</div><div style=margin-top:6px>首先输入新旧MBEx密码。</div></table>",e=(e=(e+=addHtmlValue("旧密码","<input id=dp1password0 type=password style=width:230px autocomplete=off maxlength=32 onchange=validateAmtAcmSetupEx() onkeyup=validateAmtAcmSetupEx() />"))+addHtmlValue("新密码*","<input id=dp1password1 type=password style=width:230px autocomplete=off maxlength=32 onchange=validateAmtAcmSetupEx() onkeyup=validateAmtAcmSetupEx() />"))+addHtmlValue("新密码*","<input id=dp1password2 type=password style=width:230px autocomplete=off maxlength=32 onchange=validateAmtAcmSetupEx() onkeyup=validateAmtAcmSetupEx() />");32&features2&&1==currentMesh.mtype&&serverinfo.amtProvServerMeshId==currentMesh._id&&(e+="<label><input id=dp1lanprov type=checkbox /> 用于裸机 LAN 激活。</label>"),setDialogMode(2,"英特尔&reg;AMT ACM",3,showAmtAcmSetupEx,e+='<div><span id=dp10passNotify style="font-size:10px"> * 8-16个字符，1个大写，1个小写，1个数字，1个非字母数字。</span></div>'),Q("dp1password0").focus(),validateAmtAcmSetupEx()}function validateAmtAcmSetupEx(){var e=Q("dp1password0").value,t=Q("dp1password1").value,n=Q("dp1password2").value,i=!0;"admin"!=e&&0==checkPasswordRequirements(e,{min:8,max:16,numeric:1,lower:1,upper:1,nonalpha:1})&&(i=!1),t==n&&0!=checkPasswordRequirements(t,{min:8,max:16,numeric:1,lower:1,upper:1,nonalpha:1})||(i=!1),QE("idx_dlgOkButton",i)}function showAmtAcmSetupEx(){meshserver.send({action:"amtsetupbin",oldmebxpass:Q("dp1password0").value,newmebxpass:Q("dp1password1").value,baremetal:32&features2&&Q("dp1lanprov").checked})}function addAmtScanToMesh(e){return xxdialogMode||(setDialogMode(2,"扫描英特尔&reg;AMT设备",0,addAmtScanToMeshEx,"输入IP地址范围以扫描英特尔AMT设备。<br /><br />"+addHtmlValue("IP范围",'<table style=width:250px><tr><td style=width:99%><input id=dp1range style=width:100% list=iprangelist value="192.168.1.0/24" onkeyup=addAmtScanToMeshKeyUp(event) /><td style=width:1%><input id=dp1rangebutton type=button value="扫瞄" onclick=addAmtScanToMeshButton()></input></tr></table>')+'<div id=dp1results style="width:100%;height:200px;background-color:white;border:1px gray solid;overflow-y:scroll"></div>'+('<input type=hidden id=amtScanMeshId value="'+e+'" />')+'<div style="padding:10px;margin-bottom:5px"><input id="idx_dlgCancelButton2" type="button" value="取消" style="" onclick="dialogclose(0)" /><input id="idx_dlgOkButton2" type="button" value="OK" style="" onclick="dialogclose(1)" /><div><input id="d2scanSelectButton" type="button" value="全选" onclick="scanSelectAll()" /></div></div>',e),QE("idx_dlgOkButton2",!1),QE("d2scanSelectButton",!1),QH("dp1results","<div style=width:100%;text-align:center;margin-top:12px;color:gray;line-height:1.5>IP范围值样本<br />192.168.0.100<br />192.168.1.0/24<br />192.167.0.1-192.168.0.100</div>"),focusTextBox("dp1range"),addAmtScanToMeshKeyUp()),!1}function scanSelectAll(){for(var e=document.getElementsByClassName("DevScanCheckbox"),t=0;t<e.length;t++)e[t].checked=!0;addAmtScanToMeshCheckbox()}function addAmtScanToMeshKeyUp(e){QE("dp1rangebutton",3<Q("dp1range").value.split(".").length),e&&13==e.keyCode&&(haltEvent(e),addAmtScanToMeshButton())}function addAmtScanToMeshEx(e){for(var t,n,i=document.getElementsByClassName("DevScanCheckbox"),o=0;o<i.length;o++)i[o].checked&&(t=i[o].getAttribute("tag"),n=(t=amtScanResults[t]).hostname,"host"==t.hosttype&&(n=capitalizeFirstLetter(n.split(".")[0])),meshserver.send({action:"addamtdevice",meshid:Q("amtScanMeshId").value,devicename:n,hostname:t.hostname,amtusername:"",amtpassword:"",amttls:t.tls}))}function addAmtScanToMeshButton(){var e=Q("dp1range").value.trim(),t=e.split(" ");""!=(e=(e=1<t.length?t[t.length-1]:e).trim())&&(QE("dp1range",!1),QE("dp1rangebutton",!1),QH("dp1results","<div style=width:100%;text-align:center;margin-top:20px>扫描...</div><div style=width:100%;text-align:center;margin-top:6px;color:#666>"+e+"</div>"),xxdialogTag="AMTSCAN:"+e,meshserver.send({action:"scanamtdevice",range:e}))}function addAmtScanToMeshCheckbox(){for(var e=document.getElementsByClassName("DevScanCheckbox"),t=0,n=0;n<e.length;n++)e[n].checked&&t++;QE("idx_dlgOkButton2",0<t)}function checkEmail(e){var e=e.split("@"),t=2==e.length&&0<e[0].length&&1<e[1].split(".").length&&2<e[1].length;if(1==t){var n,i=e[1].split(".");for(n in i)0==i[n].length&&(t=!1)}return t}function inviteAgentToMesh(e){var t,n;return xxdialogMode||(t="",n=meshes[e],64&features&&(t=(t=(t=(t=(t=(t=(t=(t+=addHtmlValue("邀请类型","<select id=d2InviteType onchange=d2ChangedInviteType() style=width:236px><option value=0>连结邀请</option><option value=1>邮件邀请</option></select>")+"<hr />")+"<div id=emailInviteDiv style=display:none>"+format("邀请某人安装网状代理。将发送一封电邮，其中包含指向“ {0} ”设备组的网状代理安装的连结。",EscapeHtml(n.name))+"<br /><br />")+addHtmlValue("名称（可选）",'<input id=agentInviteName value="" style=width:230px maxlength=64 />'))+addHtmlValue("电邮",'<input id=agentInviteEmail style=width:230px placeholder="example@email.com" onkeyup=validateAgentInvite()></input>'))+addHtmlValue("操作系统","<select id=agentInviteNameOs onchange=d2ChangedInviteType() style=width:236px><option value=4>发送安装连结</option><option value=0 selected>任何可支持的</option><option value=1>仅Windows</option><option value=3>仅限Apple macOS</option><option value=2>只限Linux</option><option value=5>MeshCentral 助手</option></select>")+"<div id=d2agentexpirediv>")+addHtmlValue("连结过期","<select id=agentInviteExpire style=width:236px><option value=1>1小时</option><option value=8>8小時</option><option value=24>1天</option><option value=168>1周</option><option value=5040>1个月</option><option value=0>无限制</option></select>")+"</div><div id=d2agentInstallTypeDiv2>")+addHtmlValue("安装类型","<select id=agentInviteType style=width:236px><option value=0>后台运行与交互式运行</option><option value=2>仅后台运行</option><option value=1>仅交互式运行</option></select>")+"</div>")+addHtmlValue("消息<br />（可选的）",'<textarea id=agentInviteMessage value="" style=width:230px;height:100px;resize:none maxlength=1024 /></textarea>')+"</div>"),setDialogMode(2,"邀请",3,performAgentInvite,t=(t=(t=(t=(t+="<div id=urlInviteDiv>"+format("通过共享邀请链接来邀请某人安装Mesh代理。该链接为用户提供“ {0} ”设备组的安装说明。该链接是公用的，不需要这台服务器的帐户。",EscapeHtml(n.name))+"<br /><br />")+addHtmlValue("连结过期","<select id=d2inviteExpire style=width:236px onchange=d2RequestInvitationLink()><option value=1>1小时</option><option value=8>8小時</option><option value=24>1天</option><option value=168>1周</option><option value=5040>1个月</option><option value=0>无限制</option></select>"))+addHtmlValue("代理","<select id=d2agentType style=width:236px onchange=d2ChangedInviteType()><option value=0>所有可用的代理</option><option value=1>Windows MeshAgent</option><option value=2>Linux MeshAgent</option><option value=4>MacOS MeshAgent</option><option value=8>MeshCentral 助手</option><option value=16>Android MeshAgent</option></select>")+"<div id=d2agentInstallTypeDiv>")+addHtmlValue("安装类型","<select id=d2agentInviteType style=width:236px onchange=d2RequestInvitationLink()><option value=0>后台运行与交互式运行</option><option value=2>仅后台运行</option><option value=1>仅交互式运行</option></select>"))+"</div>"+'<div id=agentInvitationLinkDiv style="text-align:center;font-size:large;margin:16px;display:none"><a href=# id=agentInvitationLink rel="noreferrer noopener" target="_blank" style=cursor:pointer></a> <img src=images/link4.png height=10 width=10 title="复制连结到剪贴板" style=cursor:pointer onclick=d2CopyInviteToClip()></div></div>',e),(64&features?(Q("d2InviteType").focus(),d2ChangedInviteType):(Q("d2inviteExpire").focus(),validateAgentInvite))(),d2RequestInvitationLink()),!1}function d2RequestInvitationLink(){meshserver.send({action:"createInviteLink",meshid:xxdialogTag,expire:parseInt(Q("d2inviteExpire").value),flags:parseInt(Q("d2agentInviteType").value),agents:parseInt(Q("d2agentType").value)})}function d2ChangedInviteType(){64&features&&(QV("urlInviteDiv",0==Q("d2InviteType").value),QV("d2agentexpirediv",4==Q("agentInviteNameOs").value),QV("d2agentInstallTypeDiv2",Q("agentInviteNameOs").value<2),QV("emailInviteDiv",1==Q("d2InviteType").value)),QV("d2agentInstallTypeDiv",parseInt(Q("d2agentType").value)<2),validateAgentInvite(),d2RequestInvitationLink()}function d2CopyInviteToClip(){copyTextToClip(Q("agentInvitationLink").href)}function d2CopySecretToClip(){copyTextToClip(Q("d2optsecret").getAttribute("secret"))}function validateAgentInvite(){64&features&&1==Q("d2InviteType").value?(QE("idx_dlgOkButton",checkEmail(Q("agentInviteEmail").value)),QV("idx_dlgCancelButton",!0)):(QE("idx_dlgOkButton",!0),QV("idx_dlgCancelButton",!1))}function performAgentInvite(e,t){64&features&&1==Q("d2InviteType").value&&meshserver.send({action:"inviteAgent",meshid:t,email:Q("agentInviteEmail").value,name:Q("agentInviteName").value,os:Q("agentInviteNameOs").value,flags:Q("agentInviteType").value,msg:Q("agentInviteMessage").value,expire:parseInt(Q("agentInviteExpire").value)})}function addAgentToMesh(e){if(!xxdialogMode){var t,n=meshes[e],i="",o="",s="<select id=aginsSelect onchange=addAgentToMeshClick() style=width:236px><option value=0>Windows</option><option value=1>Linux / BSD</option><option value=5>Linux / BSD / macOS二进制安装程序</option><option value=2>苹果macOS</option>",s=(0==(2&features)&&(s+="<option value=6>移动设备</option>"),i+=addHtmlValue("操作系统",s=s+"<option value=7>MeshCentral 助手</option>"+"<option value=3>Windows（卸载）</option><option value=4>Linux / BSD（卸载）</option><option value=8>Apple macOS (UnInstall)</option></select>"),serverinfo.name),a=(-1!=s.indexOf(".")&&0==(2&features)||(s=window.location.hostname),domainUrl.substring(0,domainUrl.length-1)),r="",r=1==serverinfo.https?443==serverinfo.port?"":":"+serverinfo.port:80==serverinfo.port?"":":"+serverinfo.port,l=[6,5,10005,25,26,28,30,32,36,37,40,41,16,29],d={6:"Linux x86-64",5:"Linux x86-32",10005:"Apple OSX Universal",25:"Linux ARM-HF, Rasberry Pi",26:"Linux ARM64-HF",28:"Linux MIPS24KC (OpenWRT)",30:"FreeBSD x86-64",32:"Linux ARM 64 bit (glibc/2.24 NOKVM)",36:"OpenWRT x86-64",37:"OpenBSD x86-64",40:"Linux MIPSEL24KC (OpenWRT)",41:"ARMADA/CORTEX-A53/MUSL (OpenWRT)",16:"Apple macOS x86-64",29:"Apple macOS ARM-64"};for(t in l)o+="<option value="+l[t]+">"+d[l[t]]+"</option>";i=(i=(i=(i=(i+="<div id=aginsSysTypeDiv>")+addHtmlValue("系统类型","<select id=aginsSysType onchange=addAgentToMeshClick() style=width:236px>"+o+"</select>"))+"</div>"+"<div id=aginsTypeDiv>")+addHtmlValue("安装类型","<select id=aginsType onchange=addAgentToMeshClick() style=width:236px><option value=0>后台运行与交互式运行</option><option value=2>仅后台运行</option><option value=1>仅交互式运行</option></select>")+"</div><div id=asinsTypeDiv>")+addHtmlValue("安装类型","<select id=asinsType onchange=addAgentToMeshClick() style=width:236px><option value=2>应用程序，根据用户请求连接</option><option value=3>应用程序，始终连接</option><option value=0>系统托盘，根据用户要求连接</option><option value=1>系统托盘，始终连接</option><option value=4>系统托盘，仅显示器</option></select>")+"</div><hr>",n.name.split("\\").join("").split("/").join("").split(":").join("").split("*").join("").split("?").join("").split('"').join("").split("<").join("").split(">").join("").split("|").join("").split(" ").join("").split("'").join("");i=(i=(i=(i+="<div id=agins_windows>"+format("要将新计算机添加到设备组“ {0} ”，请下载网状代理并安装该计算机以进行管理。这代理中已嵌入了服务器和设备组信息。",EscapeHtml(n.name))+"<br /><br />")+addHtmlValue("Mesh代理",'<a id=aginsw32lnk name="meshagents?id=3&meshid='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'" title="x86 32bit version of the MeshAgent">Windows x86-32 (.exe)</a> <img src=images/link4.png height=10 width=10 title="Copy Windows x86 32bit agent URL to clipboard" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=3&meshid='+e.split("/")[2]+'&installflags=",1)>'))+addHtmlValue("Mesh代理",'<a id=aginsw64lnk name="meshagents?id=4&meshid='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'" title="x86 64bit version of the MeshAgent">Windows x86-64 (.exe)</a> <img src=images/link4.png height=10 width=10 title="Copy Windows x86 64bit agent URL to clipboard" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=4&meshid='+e.split("/")[2]+'&installflags=",1)>'))+addHtmlValue("Mesh代理",'<a id=aginswa64lnk name="meshagents?id=43&meshid='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'" title="ARM 64bit version of the MeshAgent">Windows ARM-64 (.exe)</a> <img src=images/link4.png height=10 width=10 title="Copy Windows ARM 64bit agent URL to clipboard" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=43&meshid='+e.split("/")[2]+'&installflags=",1)>'),0<debugmode&&(i+=addHtmlValue("设定档案",'<a id=aginswmshlnk name="meshsettings?id='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'">'+format("{0}设置（.msh）",EscapeHtml(n.name))+"</a>")),setDialogMode(2,"添加 Mesh Agent",2,null,i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i+="</div>")+("<div id=agins_linux style=display:none>"+format('要将计算机添加到"{0}"，请运行以下命令。命令需要root凭证。',EscapeHtml(n.name))+"<br />"))+"<textarea id=agins_linux_area rows=2 cols=20 readonly=readonly style=border-radius:4px;padding:6px;margin-top:4px;margin-bottom:4px;background-color:#FFF9D3;border:0;width:100%;resize:none;height:160px;overflow:auto;font-size:12px></textarea>"+'<div style=font-size:x-small;float:right>*对于BSD，首先运行“ pkg install wget sudo bash ”。</div><a style=text-decoration:none title="复制到剪贴板" onclick=copyAgentIdValue("agins_linux_area")><img src=images/link4.png height=10 width=10 style=cursor:pointer> 复制</a></div>')+("<div id=agins_osx style=display:none>"+format("要将新计算机添加到设备组“ {0} ”，请下载网状代理并安装该计算机以进行管理。该代理安装程序中已嵌入了服务器和设备组讯息。",EscapeHtml(n.name))+"<br /><br />"))+addHtmlValue("Mesh代理",'<a onclick=downloadFile("meshosxagent?id=16&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'") title="x86-64bit version of macOS Mesh Agent">macOS x86-64位</a> <img src=images/link4.png height=10 width=10 title="将macOS代理URL复制到剪贴板" style=cursor:pointer onclick=copyAgentUrl("meshosxagent?id=16&meshid='+e.split("/")[2]+'",0)>'))+addHtmlValue("Mesh代理",'<a onclick=downloadFile("meshosxagent?id=29&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'") title="ARM 64bit version of macOS Mesh Agent">macOS ARM (64位)</a> <img src=images/link4.png height=10 width=10 title="将macOS代理URL复制到剪贴板" style=cursor:pointer onclick=copyAgentUrl("meshosxagent?id=29&meshid='+e.split("/")[2]+'",0)>'))+addHtmlValue("Mesh代理",'<a onclick=downloadFile("meshosxagent?id=10005&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'") title="Universal version of macOS Mesh Agent">macOS (Universal)</a> <img src=images/link4.png height=10 width=10 title="将macOS代理URL复制到剪贴板" style=cursor:pointer onclick=copyAgentUrl("meshosxagent?id=10005&meshid='+e.split("/")[2]+'",0)>')+"</div>")+('<div id=agins_qrcode style=display:none;min-height:180px><a id=agins_qrimage_a rel="noreferrer noopener" target=_blank><div id=agins_qrimage style=float:right;margin-left:10px;width:180px;height:180px;cursor:pointer></div></a><div>'+format("要将移动设备添加到组“{0}”，请下载 MeshAgent 应用程序并扫描此二维码。",EscapeHtml(n.name))+"</div>"))+"<table style=width:180px>"+'<tr><td style=text-align:center><a title="谷歌商店"rel="noreferrer noopener" target=_blank href="https://play.google.com/store/apps/details?id=com.meshcentral.agent2"><img style=cursor:pointer src="images/google-play-140.png" width=140 srcset="images/google-play-280.png 2x" /></a></td></tr>')+'<tr><td style=text-align:center><a title="Amazon App Store" rel="noreferrer noopener" target=_blank href="https://www.amazon.co.uk/gp/product/B097Z4Q7SK/"><img style=cursor:pointer src="images/amazon-appstore-140.png"  width=140 srcset="images/amazon-appstore-280.png 2x" /></a></td></tr>'+"</table>")+addHtmlValue("Android APK",'<a onclick=downloadFile("meshagents?id=14'+(urlargs.key?"&key="+urlargs.key:"")+'",null,true) title="APK version of the MeshAgent">APK</a> <img src=images/link4.png height=10 width=10 title="将 URL 复制到剪贴板" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=14&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'")>')+"</div>")+("<div id=agins_assistant style=display:none><table><tr><td style=vertical-align:top><div>"+format('MeshCentral Assistant 是一个 Windows 工具，用户可以使用它来寻求帮助。使用下面的链接下载将连接到设备组 "{0}" 的版本。',EscapeHtml(n.name))+"</div><div></div><br />"))+('<a id=asinslnk name="meshagents?id=10006&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'" title="适用于 Windows 的 MeshCentral 助手">Windows 助手 (.exe)</a> <img src=images/link4.png height=10 width=10 title="将 URL 复制到剪贴板" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=10006&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'")>'))+'</td><td><img id=agass_img1 src=images/assistant-100.png width=74 height=100 srcset="images/assistant-200.png 2x"><img id=agass_img2 src=images/assistant2-100.png width=74 height=100 srcset="images/assistant2-200.png 2x"></td></tr></table></div>'+"<div id=agins_assistant2 style=display:none><table><tr><td style=vertical-align:top><div>MeshCentral Assistant 是一个 Windows 工具，用户可以使用它来寻求帮助。使用下面的链接下载将监控后台代理的版本。</div><div></div><br />")+('<a id=asinslnk2 name="meshagents?id=10006&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'" title="适用于 Windows 的 MeshCentral 助手">Windows 助手 (.exe)</a> <img src=images/link4.png height=10 width=10 title="将 URL 复制到剪贴板" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=10006&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'")>'))+'</td><td><img src=images/assistant-100.png width=74 height=100 srcset="images/assistant-200.png 2x"></td></tr></table></div>'+"<div id=agins_windows_un style=display:none>要删除Mesh代理，请下载以下文件，运行并单击“卸载”。<br /><br />")+addHtmlValue("Mesh代理",'<a id=aginsw32unlnk name="meshagents?id=3&meshid='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'" title="x86 32bit version of the MeshAgent">Windows x86-32 (.exe)</a> <img src=images/link4.png height=10 width=10 title="Copy Windows x86 32bit agent URL to clipboard" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=3&meshid='+e.split("/")[2]+'&installflags=",1)>'))+addHtmlValue("Mesh代理",'<a id=aginsw64unlnk name="meshagents?id=4&meshid='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'" title="x86 64bit version of the MeshAgent">Windows x86-64 (.exe)</a> <img src=images/link4.png height=10 width=10 title="Copy Windows x86 64bit agent URL to clipboard" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=4&meshid='+e.split("/")[2]+'&installflags=",1)>'))+addHtmlValue("Mesh代理",'<a id=aginswa64unlnk name="meshagents?id=43&meshid='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'" title="ARM 64bit version of the MeshAgent">Windows ARM-64 (.exe)</a> <img src=images/link4.png height=10 width=10 title="Copy Windows ARM 64bit agent URL to clipboard" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=43&meshid='+e.split("/")[2]+'&installflags=",1)>')+"</div>")+"<div id=agins_linux_un style=display:none>要删除Mesh代理，请运行以下命令。需要根凭证。<br />"+"<textarea id=agins_linux_area_un rows=2 cols=20 readonly=readonly style=border-radius:4px;padding:6px;margin-top:4px;margin-bottom:4px;background-color:#FFF9D3;border:0;width:100%;resize:none;height:160px;overflow:auto;font-size:12px></textarea>")+'<a style=text-decoration:none title="复制到剪贴板" onclick=copyAgentIdValue("agins_linux_area_un")><img src=images/link4.png height=10 width=10 style=cursor:pointer> Copy</a></div>'+'<div id=agins_osx_un style=display:none>To remove a mesh agent, download the file below, right click on the ".mpkg" file and click "Show Package Contents", then right click on "Uninstall.command" and click "Open"<br /><br />')+addHtmlValue("Mesh代理",'<a onclick=downloadFile("meshosxagent?id=10005&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'") title="Universal version of macOS Mesh Agent">macOS Agent (Universal)</a> <img src=images/link4.png height=10 width=10 title="将macOS代理URL复制到剪贴板" style=cursor:pointer onclick=copyAgentUrl("meshosxagent?id=10005&meshid='+e.split("/")[2]+'",0)>'))+"</div>"+"<div id=agins_linux_inst style=display:none>This is a executable on OS's with graphical user interfaces<br /><br />Apple macOS executables will need to be removed from quarantine to run 'xattr -r -d com.apple.quarantine meshagent'<br /><br />You need to 'chmod +x meshagent' and run this file<br /><br />")+addHtmlValue("Mesh代理",'<a id=aginsbinlnk name="meshagents?id='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'">MeshAgent</a> <img src=images/link4.png height=10 width=10 title="将代理URL复制到剪贴板" style=cursor:pointer onclick=copyAgentUrl("meshagents?id='+e.split("/")[2]+'&installflags=",1)>'))+addHtmlValue("命令",'<input id=aginsbincmd type=text style="width:216px" readonly value=\'wget -O meshagent'+(0!=(2147483648&features)?" --no-check-certificate":"")+' "https://'+s+r+domainUrl+"meshagents?id="+e.split("/")[2].split("$").join("%24").split("@").join("%40")+'\' /> <img src=images/link4.png height=10 width=10 title="将代理URL复制到剪贴板" style=cursor:pointer onclick=copyAgentIdValue("aginsbincmd")>')+"</div>","fileDownload"),new QRCode(Q("agins_qrimage"),{text:serverinfo.magenturl+","+serverinfo.agentCertHash+","+e.split("/")[2],width:180,height:180,colorDark:"#000000",colorLight:"#EEE",correctLevel:QRCode.CorrectLevel.M}),Q("agins_qrimage_a").setAttribute("href",serverinfo.magenturl+","+serverinfo.agentCertHash+","+e.split("/")[2]),0==(8192&features)?(Q("agins_linux_area").value='(wget "https://'+s+r+domainUrl+"meshagents?script=1"+(urlargs.key?"&key="+urlargs.key:"")+'"'+(0!=(2147483648&features)?" --no-check-certificate":"")+' -O ./meshinstall.sh || wget "https://'+s+r+domainUrl+'meshagents?script=1" --no-proxy'+(0!=(2147483648&features)?" --no-check-certificate":"")+" -O ./meshinstall.sh) && chmod 755 ./meshinstall.sh && sudo -E ./meshinstall.sh https://"+s+r+a+" '"+e.split("/")[2]+"' || ./meshinstall.sh https://"+s+r+a+" '"+e.split("/")[2]+"'\r\n",Q("agins_linux_area_un").value='(wget "https://'+s+r+domainUrl+"meshagents?script=1"+(urlargs.key?"&key="+urlargs.key:"")+'"'+(0!=(2147483648&features)?" --no-check-certificate":"")+' -O ./meshinstall.sh || wget "https://'+s+r+domainUrl+'meshagents?script=1" --no-proxy'+(0!=(2147483648&features)?" --no-check-certificate":"")+" -O ./meshinstall.sh) && chmod 755 ./meshinstall.sh && sudo -E ./meshinstall.sh uninstall https://"+s+r+a+" '"+e.split("/")[2]+"' || ./meshinstall.sh uninstall https://"+s+r+a+" '"+e.split("/")[2]+"'\r\n"):(Q("agins_linux_area").value='wget "https://'+s+r+domainUrl+"meshagents?script=1"+(urlargs.key?"&key="+urlargs.key:"")+'" --no-proxy'+(0!=(2147483648&features)?" --no-check-certificate":"")+" -O ./meshinstall.sh && chmod 755 ./meshinstall.sh && sudo -E ./meshinstall.sh https://"+s+r+a+" '"+e.split("/")[2]+"' || ./meshinstall.sh https://"+s+r+a+" '"+e.split("/")[2]+"'\r\n",Q("agins_linux_area_un").value='wget "https://'+s+r+domainUrl+"meshagents?script=1"+(urlargs.key?"&key="+urlargs.key:"")+'" --no-proxy'+(0!=(2147483648&features)?" --no-check-certificate":"")+" -O ./meshinstall.sh && chmod 755 ./meshinstall.sh && sudo -E ./meshinstall.sh uninstall https://"+s+r+a+" '"+e.split("/")[2]+"' || ./meshinstall.sh uninstall https://"+s+r+a+" '"+e.split("/")[2]+"'\r\n"),Q("aginsSelect").focus(),addAgentToMeshClick()}return!1}function copyAgentIdValue(e){copyTextToClip(Q(e).value)}function copyAgentUrl(e,t){var n=serverinfo.name,n=(-1!=n.indexOf(".")&&0==(2&features)||(n=window.location.hostname),domainUrl.substring(0,domainUrl.length-1),"https://"+n+(443==serverinfo.port?"":":"+serverinfo.port)+domainUrl+e);1==t&&(n+=Q("aginsType").value),n+=urlargs.key?"&key="+urlargs.key:"",5==Q("aginsSelect").value&&(n+="&meshinstall="+Q("aginsSysType").value),7==Q("aginsSelect").value&&(n+="&ac="+Q("asinsType").value),copyTextToClip(n)}function addAgentToMeshClick(){var e=Q("aginsSelect").value;QV("agins_windows",0==e),QV("agins_linux",1==e),QV("agins_osx",2==e),QV("agins_windows_un",3==e),QV("agins_linux_un",4==e),QV("agins_linux_inst",5==e),QV("aginsSysTypeDiv",5==e),QV("agins_qrcode",6==e),QV("agins_assistant",7==e&&4!=Q("asinsType").value),QV("agins_assistant2",7==e&&4==Q("asinsType").value),QV("agins_osx_un",8==e),Q("aginsbinlnk").onclick=function(){downloadFile(Q("aginsbinlnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:"")+"&meshinstall="+Q("aginsSysType").value)},Q("aginsbincmd").value=Q("aginsbincmd").value.split("&installflags=")[0]+"&installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:"")+"&meshinstall="+Q("aginsSysType").value+'"',QV("aginsTypeDiv",0==e||5==e),QV("asinsTypeDiv",7==e),Q("aginsw32lnk").onclick=function(){downloadFile(Q("aginsw32lnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:""),null,!0)},Q("aginsw64lnk").onclick=function(){downloadFile(Q("aginsw64lnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:""),null,!0)},Q("aginswa64lnk").onclick=function(){downloadFile(Q("aginswa64lnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:""),null,!0)},Q("aginsw32unlnk").onclick=function(){downloadFile(Q("aginsw32lnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:""),null,!0)},Q("aginsw64unlnk").onclick=function(){downloadFile(Q("aginsw64lnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:""),null,!0)},Q("aginswa64unlnk").onclick=function(){downloadFile(Q("aginswa64lnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:""),null,!0)},0<debugmode&&(Q("aginswmshlnk").onclick=function(){downloadFile(Q("aginswmshlnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:""),null,!0)}),Q("asinslnk").onclick=function(){downloadFile(Q("asinslnk").name+"&ac="+Q("asinsType").value,null,!0)},Q("asinslnk2").onclick=function(){downloadFile(Q("asinslnk").name+"&ac="+Q("asinsType").value,null,!0)},7==e&&(QV("agass_img1",Q("asinsType").value<2),QV("agass_img2",2<=Q("asinsType").value))}function validateDeviceToMesh(){QE("idx_dlgOkButton",0<Q("dp1devicename").value.length&&passwordcheck(Q("dp1password").value))}function addDeviceToMeshEx(e,t){var n=Q("dp1username").value,i=(""==n&&(n="admin"),Q("dp1hostname").value);""==i&&(i=Q("dp1devicename").value),meshserver.send({action:"addamtdevice",meshid:t,devicename:Q("dp1devicename").value,hostname:i,amtusername:n,amtpassword:Q("dp1password").value,amttls:Q("dp1tls").value})}function deviceHeaderSet(){0==deviceHeaderId?deviceHeaderId=1:(deviceHeaders["DevxHeader"+deviceHeaderId]=1==deviceHeaderTotal?"1个节点":format("{0}个节点",deviceHeaderTotal),deviceHeaderId++,deviceHeaderCount={},deviceHeaderTotal=0)}var powerStateStrings=["",'<span title="设备已连接电源。">有电源</span>','<span title="设备处于睡眠状态（S1）。">休眠中</span>','<span title="设备处于睡眠状态（S2）。">休眠中</span>','<span title="设备处于深度睡眠状态（S3）。">沉睡</span>','<span title="设备处于休眠状态（S4）。">休眠</span>','<span title="设备处于关机状态（S5）。">软关机</span>','<span title="检测到设备，但无法获得电源状态。">存在</span>','<span title="设备已断电。">离开</span>'],powerStateStrings2=["","设备已连接电源","设备处于睡眠状态（S1）","设备处于睡眠状态（S2）","设备处于深度睡眠状态（S3）","设备正在休眠（S4）","设备处于软关机状态（S5）","设备存在，但无法确定电源状态","设备已断电"],powerColorTable=["pwsTransparent","pwsBlack","pwsBlue","pwsBlue2","pwsLightblue","pwsBlueviolet","pwsDarkgreen","pwsLightseagreen","pwsLightseagreen2"];function NodeStateStr(e){var t=[];return 0<e.state&&e.state<powerStatetable.length&&state.push(powerStatetable[e.state]),e.conn&&(0!=(1&e.conn)&&(4==e.mtype?"PDU"==e.porttype?t.push('<span title="电源开关即可使用。">转变</span>'):t.push('<span title="IP-KVM 端口已启动并可以使用。">IP-KVM</span>'):t.push('<span title="已连接Mesh代理并准备使用。">代理</span>')),0!=(2&e.conn)?t.push('<span title="英特尔&reg;AMT CIRA已连接并可以使用。">CIRA</span>'):0!=(4&e.conn)&&t.push('<span title="英特尔&reg;AMT是可路由的。">AMT</span>'),0!=(8&e.conn)&&t.push('<span title="Mesh代理可以经过其他代理作为中继访问得到。">中继</span>'),0!=(16&e.conn))&&t.push('<span title="与设备的MQTT连接已激活。">MQTT</span>'),null!=e.pwr&&0!=e.pwr&&t.push(powerStateStrings[e.pwr]),0==t.length?"&nbsp;":t.join(", ")}function PowerStateStr(e){return e<powerStatetable.length?powerStatetable[e]:""}function PowerStateStr2(e){return 0!=e&&e<powerStatetable.length?powerStatetable[e]:"未知"}function updateCollapseAllButton(){var e=0<Object.keys(CollapsedGroups).length;QV("CollapseAllButton",!e),QV("ExpandAllButton",e),QV("CollapseAllButton2",!e),QV("ExpandAllButton2",e)}function selectallButtonFunction(){for(var e=document.getElementsByClassName("DeviceCheckbox"),t=Object.keys(checkedNodeids).length,n=0;n<e.length;n++)e[n].checked=0==t;if(checkedNodeids={},0==t){checkedNodeids={};for(var i=document.getElementsByName("xxdevice"+Q("viewselect").value),n=0;n<i.length;n++)(null==i[n].parentElement.attributes.style||i[n].parentElement.attributes.style.value.indexOf("display")<0)&&(checkedNodeids[i[n].id.substring(3)]=1)}p1updateInfo()}function p1devcheck(e){e.srcElement.checked?checkedNodeids[e.srcElement.value.substring(6)]=1:delete checkedNodeids[e.srcElement.value.substring(6)],p1updateInfo()}function p1updateInfo(){var e=Object.keys(checkedNodeids).length;if(0<e?(QE("GroupActionButton",!0),Q("SelectAllButton").value="取消全选",QV("cxmdesktop",!0)):(QE("GroupActionButton",!1),Q("SelectAllButton").value="全选",QV("cxmdesktop",!1)),null!=customui&&customui.devicesbarbuttons)for(var t in customui.devicesbarbuttons)"one"==customui.devicesbarbuttons[t].selection&&QE("cui:"+t,1==e),"many"==customui.devicesbarbuttons[t].selection&&QE("cui:"+t,1<=e)}function groupActionFunction(){var e=[],t=getCheckedDevices(),n=0;if(262144&features&&0==count2factoraAuths())setDialogMode(2,"账户安全",1,null,"在启用两因素身份验证之前，无法访问此功能。这是额外的安全性所必需的。转到“我的帐户”标签，然后查看“帐户安全性”部分。");else{if(4194304&features)for(var i in t)if(0!=(16&getNodeFromId(t[i]).conn)){e.push({v:103,name:"发送MQTT消息"});break}for(var i in e.push({v:105,name:"输出设备信息",s:!0}),t){var o=getNodeFromId(t[i]),s=GetNodeRights(o);1&s&&0==(2&n)&&(n|=2,e.push({v:102,name:"移至设备组"})),0!=(1&o.conn)&&0!=(32768&s)&&0==(1&n)&&(n|=1,e.push({v:104,name:"卸载代理"})),64&s&&0==(8&n)&&(n|=8,e.push({v:100,name:"唤醒设备"})),262144&s&&0==(4&n)&&(n|=4,e.push({v:4,name:"把装置休眠"}),e.push({v:3,name:"重置设备"}),e.push({v:2,name:"关闭设备"})),131072&s&&0==(16&n)&&(n|=16,e.push({v:106,name:"运行命令"})),16384&s&&0==(32&n)&&(n|=32,e.push({v:108,name:"设备通知"})),4&s&&0==(64&n)&&(n|=64,e.push({v:107,name:"编辑标签"})),8&s&&0==(256&n)&&(n|=256,e.push({v:109,name:"上传文件"})),32768&s&&0==(128&n)&&(n|=128,e.push({v:101,name:"删除设备"})),null!=o.agent&&16&features2&&4294967295==s&&0==(512&n)&&(n|=512,e.push({v:110,name:"强制代理更新"}),e.push({v:111,name:"清除代理核心"}),e.push({v:112,name:"上载默认服务器核心"}))}var a="";for(i in e.sort(nameSort),e)a+="<option value="+e[i].v+(e[i].s?" selected":"")+">"+e[i].name+"</option>";var r="选择要在所有选定设备上执行的操作。仅在拥有适当权限的情况下才能执行操作。<br /><br />";setDialogMode(2,"集体指令",3,groupActionFunctionEx,r+=addHtmlValue("运作","<select id=d2groupop>"+a+"</select>"))}}function getCheckedDevices(){return Object.keys(checkedNodeids)}function uncheckAllDevices(){for(var e=document.getElementsByClassName("DeviceCheckbox"),t=0;t<e.length;t++)e[t].checked=!1;checkedNodeids={}}function groupActionFunctionEx(){var e=Q("d2groupop").value;if(100==e)meshserver.send({action:"wakedevices",nodeids:getCheckedDevices()}),uncheckAllDevices();else if(101==e){var t=getCheckedDevices(),n="";if(0!=t.length){if(1==t.length)n+="确认移除所选设备？<br /><br />";else{n+=format("确认移除 {0} 个选定的设备？<br />",t.length);var i=0,o=0;for(l in t)null!=(d=getNodeFromId(t[l])).conn&&0<d.conn?i++:o++;var s="";1==i?s+=format("1 个选定的设备在线。<br />",i):1<i&&(s+=format("{0} 个选定的设备在线。<br />",i)),1==o?s+=format("1 个选定的设备处于离线状态。<br />",o):1<o&&(s+=format("{0} 个选定的设备处于离线状态。<br />",o)),n+=""!=s?"<div style=padding:8px>"+s+"</div>":"<br />"}setDialogMode(2,"删除设备",3,d2groupActionFunctionDelExec,n+="<label><input id=d2check type=checkbox onchange=d2groupActionFunctionDelCheck() />确认</label>"),QE("idx_dlgOkButton",!1)}}else if(102==e)p10showChangeGroupDialog(getCheckedDevices());else if(103==e)p10showSendMqttMsgDialog(getCheckedDevices());else if(104==e)p10showSendUninstallAgentDialog(getCheckedDevices());else if(105==e)p2downloadDeviceInfo();else if(106==e)d2runCommandDialog({nodeids:getCheckedDevices(),title:"在所选设备上运行命令。",func:uncheckAllDevices});else if(107==e){var n="执行批量设备标签操作<br /><br />",a=(n=(n+=addHtmlValue("运作","<select id=d2deviceop style=float:right;width:250px><option value=1>添加标签</option><option value=2>设置标签</option><option value=3>移除标签</option></select>"))+addHtmlValue("标签",'<input id=dp10devicevalue maxlength=4096 placeholder="标签1，标签2，标签3" />'),[]),s="";for(l in nodes)if(nodes[l].tags)for(var r in nodes[l].tags)-1==a.indexOf(nodes[l].tags[r])&&a.push(nodes[l].tags[r]);if(0<a.length){for(var l in a.sort(),a)s+='<span style=padding:4px;background-color:#BBB;border-radius:3px;cursor:pointer onclick=showEditNodeValueDialogAddTag("'+encodeURIComponentEx(a[l])+'")>'+EscapeHtml(a[l])+"</span> ";n+="<div style=margin-top:8px;width:370px;line-height:26px;max-height:160px;overflow-y:auto>"+s+"</div>"}setDialogMode(2,"编辑设备标签",3,d2groupActionFunctionTagsExec,n)}else if(108==e){var n="<div style=margin-bottom:4px>执行批量设备通知</div>";setDialogMode(2,"设备通知",3,d2groupActionFunctionNotifyExec,n=(n=(n=(n=(n=(n+="<select id=d2deviceop style=width:100%;margin-bottom:4px><option value=2>吐司通知</option><option value=1>留言框</option><option value=3>Alert Box</option></select>")+'<input id=dp2notifyTitle maxlength=256 placeholder="标题" style=width:100%;box-sizing:border-box;margin-bottom:4px />'+"<textarea id=d2notifyMsg style=background-color:#fcf3cf;width:100%;height:140px;resize:none;overflow-y:scroll;box-sizing:border-box;margin-bottom:4px></textarea>")+"<select style=width:100% id=d2notifyTimeout>"+'<option disabled value="">Only Applicable to Message Box Notifications</option>')+"<option value=2 selected>Show for 2 Minutes (Default)</option>"+"<option value=10>Show for 10 minutes</option>")+"<option value=30>Show for 30 minutes</option>"+"<option value=60>Show for 60 minutes</option>")+"<option value=0>显示消息，直到被用户拒绝</option>"+"</select>"),Q("d2notifyMsg").focus()}else if(109==e){var d,c=!1,u=!1;for(l in t=getCheckedDevices())(d=getNodeFromId(t[l])).agent&&(0<d.agent.id&&d.agent.id<5||34==d.agent.id?c=!0:u=!0);var n="将所选文件上传到所有所选设备<br /><br />";n=(n+="<form method=post enctype=multipart/form-data action=uploadfilebatch.ashx target=fileUploadFrame>")+("<input type=hidden name=authCookie value="+authCookie+" /><input type=hidden name=nodeIds value="+t.join(",")+" /><input type=submit id=d2batchUploadSubmit style=display:none />")+'<input type=file name=files id=d2uploadinput style=width:100% multiple=multiple onchange="d2batchUploadValidate()" /><br /><br />',c&&(n+=addHtmlValue("Windows路径",'<input style=width:250px type=text onchange="d2batchUploadValidate()" onkeyup="d2batchUploadValidate()" name=winpath id=d2winuploadpath placeholder="C:\\temp" value="" />')),u&&(n+=addHtmlValue("Linux路径",'<input style=width:250px type=text onchange="d2batchUploadValidate()" onkeyup="d2batchUploadValidate()" name=linuxpath id=d2linuxuploadpath placeholder="/tmp" value="" />')),setDialogMode(2,"批处理文件上传",3,d2batchUploadValidateOk,n=n+"<br /><label><input type=checkbox name=createFolder />创建文件夹（如果不存在）？</label><br />"+"<label><input type=checkbox name=overwriteFiles />是否覆盖文件存在？</label></form>"),d2batchUploadValidate()}else 110==e?setDialogMode(2,"强制代理更新",3,d2groupActionFunctionAgentUpdateExec,n="在选定的设备上强制更新代理？<br /><br />"):111==e?setDialogMode(2,"清除代理核心",3,d2groupActionFunctionAgentClearCoreExec,n="清除选定设备上的代理核心？<br /><br />"):112==e?setDialogMode(2,"上载默认服务器核心",3,d2groupActionFunctionAgentDefaultCodeExec,n="在所选设备上上传默认服务器核心？<br /><br />"):(meshserver.send({action:"poweraction",nodeids:getCheckedDevices(),actiontype:parseInt(e)}),uncheckAllDevices())}function d2batchUploadValidate(){QE("idx_dlgOkButton",!(0==Q("d2uploadinput").files.length||null!=Q("d2winuploadpath")&&""==Q("d2winuploadpath").value||null!=Q("d2linuxuploadpath")&&""==Q("d2linuxuploadpath").value))}function d2batchUploadValidateOk(){Q("d2batchUploadSubmit").click()}function d2groupActionFunctionAgentUpdateExec(){meshserver.send({action:"updateAgents",nodeids:getCheckedDevices()})}function d2groupActionFunctionAgentClearCoreExec(){meshserver.send({action:"uploadagentcore",nodeids:getCheckedDevices(),type:"clear"})}function d2groupActionFunctionAgentDefaultCodeExec(){meshserver.send({action:"uploadagentcore",nodeids:getCheckedDevices(),type:"default"})}function d2groupActionFunctionNotifyExec(){var e=Q("d2deviceop").value,t=Q("dp2notifyTitle").value,n=Q("d2notifyMsg").value,i=getCheckedDevices(),o=parseFloat(Q("d2notifyTimeout").value);if(0!=n.length)if(""==(t=""==t?decodeURIComponent("{{{extitle}}}"):t)&&(t="网格中心"),isNaN(o)&&(o=2),1==e)for(var s=0;s<i.length;s++)meshserver.send({action:"msg",type:"messagebox",nodeid:i[s],title:t,msg:n,timeout:6e4*o});else if(2==e)meshserver.send({action:"toast",nodeids:i,title:t,msg:n});else if(3==e)for(s=0;s<i.length;s++)meshserver.send({action:"msg",type:"alertbox",nodeid:i[s],title:t,msg:n})}function d2groupActionFunctionTagsExec(){var e=getCheckedDevices(),t=Q("d2deviceop").value,n=Q("dp10devicevalue").value;if(2==t)for(var i in e)meshserver.send({action:"changedevice",nodeid:e[i],tags:n});else{var o=[];for(i in n=n.split(",")){var s=n[i].trim();0<s.length&&s.length<64&&-1==o.indexOf(s)&&o.push(s)}for(i in e){var a=null,r=!1,l=getNodeFromId(e[i]);null==(a=null!=l.tags?Clone(l.tags):a)&&(a=[]);for(var d,c=0;c<n.length;c++)1==t&&-1==a.indexOf(n[c])&&(a.push(n[c]),r=!0),3==t&&0<=(d=a.indexOf(n[c]))&&(a.splice(d,1),r=!0);r&&meshserver.send({action:"changedevice",nodeid:e[i],tags:a.join(",")})}}}function p2downloadDeviceInfo(){if(!xxdialogMode){var e,t=getCheckedDevices(),n=!1;for(e in t)null!=getNodeFromId(t[e]).intelamt&&(n=!0);var i="使用以下一种档案格式下载设备列表。<br /><br />",i=(i+=addHtmlValue("CSV格式","<a href=# style=cursor:pointer onclick='return p2downloadDeviceInfoCSV()'>devicelist.csv</a>"))+addHtmlValue("JSON格式","<a href=# style=cursor:pointer onclick='return p2downloadDeviceInfoJSON()'>devicelist.json</a>");n&&(i+=addHtmlValue("英特尔&reg; AMT JSON","<a href=# style=cursor:pointer onclick='return p2downloadAmtInfoJSON()'>计算机列表.json</a>")),setDialogMode(2,"设备信息导出",1,null,i+="<div style=margin-top:8px><label><input type=checkbox id=d2DevInfoDetailsCheck />包括设备详细信息</label></div>")}}function csvClean(e){return null==e?"":e.split(",").join("")}function p2downloadDeviceInfoCSV(){var e=getCheckedDevices();if(Q("d2DevInfoDetailsCheck").checked){var t=null;try{t=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(e){}meshserver.send({action:"getDeviceDetails",nodeids:e,tz:t,tf:(new Date).getTimezoneOffset(),l:getLang(),type:"csv"})}else{var n,i="id、名称、rname、主机、图标、ip、osdesc、状态、组名、conn、pwr、av、更新、防火墙、bitlocker,avdetails,tags,lastbootuptime\r\n";for(n in e){var o=getNodeFromId(e[n]);if(i+='"'+o._id.split(",").join("")+'","'+o.name.split(",").join("")+'","'+(o.rname?o.rname.split(",").join(""):"")+'","'+(o.host?o.host.split(",").join(""):"")+'","'+o.icon+'","'+(o.ip||"")+'","'+(o.osdesc?o.osdesc.split(",").join(""):"")+'","'+o.state+'","'+meshes[o.meshid].name.split(",").join("")+'","'+(o.conn||"")+'","'+(o.pwr||"")+'"',"object"==typeof o.wsc?i+=',"'+csvClean(o.wsc.antiVirus)+'","'+csvClean(o.wsc.autoUpdate)+'","'+csvClean(o.wsc.firewall)+'"':i+=",,,","object"==typeof o.volumes){var s="",a=!0;for(d in o.volumes)void 0!==o.volumes[d].protectionStatus&&(a?a=!1:s+="|",s+=d+"/"+o.volumes[d].volumeStatus);i+=',"'+csvClean(s)+'"'}else i+=",";if("object"==typeof o.av){var r="",l=!0;for(d in o.av)"string"==typeof o.av[d].product&&(l?l=!1:r+="|",r+=o.av[d].product+"/"+(o.av[d].enabled?"enabled":"disabled")+"/"+(o.av[d].updated?"updated":"notupdated"));i+=',"'+csvClean(r)+'"'}else i+=",";if("object"==typeof o.tags){var d,c="",u=!0;for(d in o.tags)u?u=!1:c+="|",c+=o.tags[d];i+=',"'+csvClean(c)+'"'}else i+=",";"number"==typeof o.lastbootuptime&&(i+=',"'+o.lastbootuptime+'"'),i+="\r\n"}saveAs(stringToUtf8Blob(i),"devicelist.csv")}return!1}function p2downloadAmtInfoJSON(){var e,t=getCheckedDevices(),n={webappversion:"0.9.0",computers:[]};for(e in t){var i,o=getNodeFromId(t[e]);null!=o.intelamt&&(i={name:o.name,host:o.host,user:o.intelamt.user,pass:"",tls:1==o.intelamt.tls?1:0,ver:o.intelamt.ver,pstate:o.intelamt.state},2==o.intelamt.state&&(i.pmode=1),o.intelamt.realm&&(i.digestrealm=o.intelamt.realm),o.intelamt.hash&&(i.tlscerthash=o.intelamt.hash),n.computers.push(i))}saveAs(new Blob([JSON.stringify(n,null,2)],{type:"application/octet-stream"}),"计算机列表.json")}function p2downloadDeviceInfoJSON(){var e=getCheckedDevices();if(Q("d2DevInfoDetailsCheck").checked){var t=null;try{t=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(e){}meshserver.send({action:"getDeviceDetails",nodeids:e,tz:t,tf:(new Date).getTimezoneOffset(),l:getLang(),type:"json"})}else{var n,i=[];for(n in e)i.push(getNodeFromId(e[n]));saveAs(new Blob([JSON.stringify(i,null,2)],{type:"application/octet-stream"}),"devicelist.json")}return!1}function d2groupActionFunctionDelCheck(){QE("idx_dlgOkButton",Q("d2check").checked)}function d2groupActionFunctionDelExec(){meshserver.send({action:"removedevices",nodeids:getCheckedDevices()}),uncheckAllDevices()}function d2runCommandDialog(e){var t,n=!1,i=!1,o=!1;for(t in e.nodeids){var s=getNodeFromId(e.nodeids[t]);s.agent&&(24==(24&GetNodeRights(s))&&(o=!0),0<s.agent.id&&s.agent.id<5?n=!0:i=!0)}if(1==n||1==i||1==o){var a={type:1,runAs:0,source:1,cmd:""};try{a=JSON.parse(getstore("runopt",a))}catch(e){}e.selectedFile&&(r=e.selectedFile.name.toLowerCase(),console.log("filename",r),r.endsWith(".bat")&&(a.type=1),r.endsWith(".ps1")&&(a.type=2),r.endsWith(".sh")&&(a.type=3),r.endsWith(".agentconsole"))&&(a.type=4);var r="";e.title&&(r+=e.title+"<br />"),r+="<select id=d2cmdtype onclick=d2runCommandValidate() style=width:100%;margin-bottom:4px;margin-top:4px>",1==n&&(r+="<option value=1"+(1==a.type?" selected":"")+">Windows命令提示</option><option value=2"+(2==a.type?" selected":"")+">Windows PowerShell</option>"),1==i&&(r+="<option value=3"+(3==a.type?" selected":"")+">Linux / BSD / macOS命令外壳</option>"),1==o&&(r+="<option value=4"+(4==a.type?" selected":"")+">代理控制台</option>"),r=r+"</select>"+("<select id=d2cmduser style=width:100%;margin-bottom:4px><option value=0"+(0==a.runAs?" selected":"")+">以代理身份运行</option><option value=1"+(1==a.runAs?" selected":"")+">以用户身份运行，如果没有用户，则运行代理</option><option value=2"+(2==a.runAs?" selected":"")+">必须以用户身份运行</option></select>"),null==e.selectedFile&&(r+="<select id=d2cmdsource onclick=d2runCommandValidate() style=width:100%;margin-bottom:4px><option value=0"+(0==a.source?" selected":"")+">Commands from text box</option><option value=1"+(1==a.source?" selected":"")+">Commands from file</option>",8&userinfo.siteadmin&&(r+="<option value=2"+(2==a.source?" selected":"")+">Commands from file on server</option>"),r=r+("</select><textarea id=d2runcmd onkeyup=d2runCommandValidate() style=background-color:#fcf3cf;width:100%;height:200px;resize:none;overflow-y:scroll>"+(a.cmd?EscapeHtml(decodeURIComponent(a.cmd)):""))+"</textarea><div id=d2runfile style=display:none><input id=d2runfileex type=file onchange=d2runCommandValidate() id=d2localFile name=files onchange=d2runCommandValidate() /></div>",8&userinfo.siteadmin)&&(r+='<div id=d2runsfile style=display:none><div id=d2serveraction valign=bottom><input type=button id=p2FolderUp disabled="disabled" onclick=d3folderup() value="Up" />&nbsp;<span id=p2CurrentFolder></span></div><div id=d2serverfiles></div></div>'),setDialogMode(2,"运行命令",3,d2groupActionFunctionRunCommands,r,e),null==e.selectedFile&&(Q("d2runcmd").focus(),8&userinfo.siteadmin)&&(d3fileoptions={dialog:2,files:"d2serverfiles",folderup:"p2FolderUp",currentFolder:"p2CurrentFolder",func:null},d3updatefiles()),d2runCommandValidate()}}function d2runCommandValidate(){var e;QV("d2cmduser",Q("d2cmdtype").value<4),null==xxdialogTag.selectedFile?(QV("d2runcmd",0==Q("d2cmdsource").value),QV("d2runfile",1==Q("d2cmdsource").value),QV("d2runsfile",2==Q("d2cmdsource").value),e=!1,0==Q("d2cmdsource").value&&0<Q("d2runcmd").value.length&&(e=!0),1==Q("d2cmdsource").value&&1==Q("d2runfileex").files.length&&(e=!0),2==Q("d2cmdsource").value&&(e=!1),QE("idx_dlgOkButton",e)):QE("idx_dlgOkButton",!0)}function d2groupActionFunctionRunCommands(e,t){var n=3;try{n=parseInt(Q("d2cmdtype").value)}catch(e){}null==t.selectedFile&&putstore("runopt",JSON.stringify({type:n,runAs:parseInt(Q("d2cmduser").value),source:parseInt(Q("d2cmdsource").value),cmd:encodeURIComponent(Q("d2runcmd").value)}));var i,o={action:"runcommands",nodeids:t.nodeids,type:n,runAsUser:parseInt(Q("d2cmduser").value)};t.selectedFile?((i=new FileReader).onload=function(e){o.cmds=e.target.result,meshserver.send(o),t.func&&t.func()},i.readAsText(t.selectedFile)):0==Q("d2cmdsource").value?(o.cmds=Q("d2runcmd").value,meshserver.send(o),t.func&&t.func()):1==Q("d2cmdsource").value?((i=new FileReader).onload=function(e){o.cmds=e.target.result,meshserver.send(o),t.func&&t.func()},i.readAsText(Q("d2runfileex").files[0])):2==Q("d2cmdsource").value&&1==(n=d3getFileSel()).length&&(o.cmdpath=d3filetreelocation.join("/")+"/"+n[0],meshserver.send(o),t.func)&&t.func()}function onSortSelectChange(e){sort=document.getElementById("sortselect").selectedIndex,e||putstore("sort",sort)}var sortCollator=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});function nameSort(e,t){e=e.name.toLowerCase(),t=t.name.toLowerCase();return sortCollator.compare(e,t)}function meshSort(e,t){var n=sortCollator.compare(e.meshnamel,t.meshnamel);return 0!=n||0!=(n=sortCollator.compare(e.meshid,t.meshid))?n:1==showRealNames?sortCollator.compare(e.rnamel,t.rnamel):sortCollator.compare(e.namel,t.namel)}function powerSort(e,t){var n=e.pwr||0,i=t.pwr||0;return i<n?-1:n<i?1:n==i?1==showRealNames?sortCollator.compare(e.rnamel,t.rnamel):sortCollator.compare(e.namel,t.namel):void 0}function deviceSort(e,t){return sortCollator.compare(e.namel,t.namel)}function deviceHostSort(e,t){return sortCollator.compare(e.rnamel,t.rnamel)}function lastConnectSort(e,t){var n=e.lastconnect,i=t.lastconnect;return null==n&&(n=99999999999999),null==i&&(i=99999999999999),(n=0<e.conn?99999999999998:n)==(i=0<t.conn?99999999999998:i)?nameSort(e,t):n-i}function onSearchFocus(e){searchFocus=e}function clearDeviceSearch(){Q("KvmSearchInput").value=Q("SearchInput").value="",onOnlineCheckBox(),mainUpdate(1)}function onMapSearchFocus(e){mapSearchFocus=e}function onUserSearchFocus(e){userSearchFocus=e}function onConsoleFocus(e){consoleFocus=e}function parseSearchAndInput(e){var t,n=e.split(" 和 "),i=null;for(t in n){var o=getDevicesThatMatchFilter(n[t]);if(null==i)i=o;else{var s,a=[];for(s in o)0<=i.indexOf(o[s])&&a.push(o[s]);i=a}}return i}function parseSearchOrInput(e){var t,n=e.split(" 或者 "),i=null;for(t in n){var o=parseSearchAndInput(n[t]);if(null==i)i=o;else for(var s in o)i.indexOf(0<=o[s])&&i.push(o[s])}return i}function getDevicesThatMatchFilter(e){var t=[],n=null,i=null,o=null,s=null,a=null,r=null,l=null,d=null,c=null;if(e.startsWith("用户：".toLowerCase())?n=e.substring("用户：".length):e.startsWith("u:".toLowerCase())?n=e.substring("u:".length):e.startsWith("ip:".toLowerCase())?i=e.substring("ip:".length):e.startsWith("组：".toLowerCase())?o=e.substring("组：".length):e.startsWith("G：".toLowerCase())?o=e.substring("G：".length):e.startsWith("标签：".toLowerCase())?s=e.substring("标签：".length):e.startsWith("t：".toLowerCase())?s=e.substring("t：".length):e.startsWith("atag：".toLowerCase())?a=e.substring("atag：".length):e.startsWith("a:".toLowerCase())?a=e.substring("a:".length):e.startsWith("操作系统：".toLowerCase())?l=e.substring("操作系统：".length):e.startsWith("数量：".toLowerCase())?d=e.substring("数量：".length):e.startsWith("描述：".toLowerCase())?c=e.substring("描述：".length):"wsc:ok"==e?r=1:"wsc:noav"==e?r=2:"wsc:noupdate"==e?r=3:"wsc:nofirewall"==e?r=4:"wsc:any"==e&&(r=5),""==e)for(var u in nodes)t.push(u);else if(null!=i)for(var u in nodes)null!=nodes[u].ip&&0<=nodes[u].ip.toLowerCase().indexOf(i)&&t.push(u);else if(null!=o)for(var u in nodes)0<=meshes[nodes[u].meshid].name.toLowerCase().indexOf(o)&&t.push(u);else if(null!=s){for(var u in nodes)if(null==nodes[u].tags&&""==s)t.push(u);else if(null!=nodes[u].tags)for(var p in nodes[u].tags)if(0<=nodes[u].tags[p].toLowerCase().indexOf(s)){t.push(u);break}}else if(null!=a)for(var u in nodes)(null!=nodes[u].agent&&null==nodes[u].agent.tag&&""==a||null!=nodes[u].agent&&null!=nodes[u].agent.tag&&0<=nodes[u].agent.tag.toLowerCase().indexOf(a))&&t.push(u);else if(null!=n){for(var u in nodes)if(nodes[u].users&&0<nodes[u].users.length)for(var m in nodes[u].users)0<=nodes[u].users[m].toLowerCase().indexOf(n)&&t.push(u)}else if(null!=l)for(var u in nodes)null!=nodes[u].osdesc&&0<=nodes[u].osdesc.toLowerCase().indexOf(l)&&t.push(u);else if(null!=d)for(var u in nodes)null==nodes[u].intelamt||""!=d&&nodes[u].intelamt.state!=d||t.push(u);else if(null!=c)for(var u in nodes)null!=nodes[u].desc&&""!=nodes[u].desc&&(""==c||0<=nodes[u].desc.toLowerCase().indexOf(c))&&t.push(u);else if(null!=r)for(var u in nodes)!nodes[u].wsc||(1==r&&"OK"==nodes[u].wsc.antiVirus&&"OK"==nodes[u].wsc.autoUpdate&&"OK"==nodes[u].wsc.firewall||(2==r||5==r)&&"OK"!=nodes[u].wsc.antiVirus||(3==r||5==r)&&"OK"!=nodes[u].wsc.autoUpdate||(4==r||5==r)&&"OK"!=nodes[u].wsc.firewall)&&t.push(u);else if("*"==e)for(var u in nodes)1==stars[nodes[u]._id]&&t.push(u);else try{var g=e.split(/\s+/).join("|"),h=new RegExp(g);for(u in nodes)32768&features2?268435456&features2?(h.test(nodes[u].name.toLowerCase())||h.test(meshes[nodes[u].meshid].name.toLowerCase())||null!=nodes[u].rnamel&&h.test(nodes[u].rnamel.toLowerCase()))&&t.push(u):(h.test(nodes[u].name.toLowerCase())||null!=nodes[u].rnamel&&h.test(nodes[u].rnamel.toLowerCase()))&&t.push(u):268435456&features2?showRealNames?(null!=nodes[u].rnamel&&h.test(nodes[u].rnamel.toLowerCase())||h.test(meshes[nodes[u].meshid].name.toLowerCase()))&&t.push(u):(h.test(nodes[u].name.toLowerCase())||h.test(meshes[nodes[u].meshid].name.toLowerCase()))&&t.push(u):showRealNames?null!=nodes[u].rnamel&&h.test(nodes[u].rnamel.toLowerCase())&&t.push(u):h.test(nodes[u].name.toLowerCase())&&t.push(u)}catch(e){for(var u in nodes)t.push(u)}return t}function onSearchInputChanged(){var e=Q("SearchInput").value.toLowerCase().trim(),t=(putstore("_search",Q("SearchInput").value),QS("SearchInput")["background-color"]=QS("KvmSearchInput")["background-color"]=""==e?null:"#FDFFBE",QV("SearchInputClearButton",""!=e),QV("KvmSearchInputClearButton",""!=e),parseSearchOrInput(e));for(i in nodes)nodes[i].v=0<=t.indexOf(i);var n,e=Q("DevFilterSelect").value;if(1==e)for(var i in nodes)null!=nodes[i].conn&&0!=nodes[i].conn||3==nodes[i].mtype||(nodes[i].v=!1);if(2==e)for(var i in nodes)(null==(n=nodes[i]).sessions||null==n.sessions.kvm&&null==n.sessions.terminal&&null==n.sessions.files&&null==n.sessions.tcp&&null==n.sessions.udp)&&(n.v=!1);if(3==e)for(var i in nodes)1!=stars[nodes[i]._id]&&(nodes[i].v=!1);if(4==e)for(var i in nodes)null==nodes[i].intelamt&&(nodes[i].v=!1);if(5==e)for(var i in nodes)null!=nodes[i].conn&&0!=nodes[i].conn&&(nodes[i].v=!1);if(6==e)for(var i in nodes)null!=(n=nodes[i]).sessions&&null!=n.sessions.help||(n.v=!1);if(7==e)for(var i in nodes)null!=(n=nodes[i]).tags&&0!=n.tags.length||(n.v=!1);if(8==e)for(var i in nodes)null!=(n=nodes[i]).tags&&0<n.tags.length&&(n.v=!1)}var contextelement=null;function handleContextMenu(e){if(hideContextMenu(),!xxdialogMode){for(var t=null!==window.pageXOffset?window.pageXOffset:(document.documentElement||document.body.parentNode||document.body).scrollLeft,n=null!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop,i=document.elementFromPoint(e.pageX-t,e.pageY-n);i&&null!=i&&null==i.attributes.cmenu;)i=i.parentElement;if(null==i)return!0;var o=i.attributes.cmenu.value;switch(o){case"filesConnectButton":if(null==currentNode||null==currentNode.agent)return!0;contextelement=i,showContextMenuDiv(document.getElementById("filesShellContextMenu"),e.pageX,e.pageY);break;case"termConnectButton":if(null==currentNode||null==currentNode.agent||3==currentNode.mtype)return!0;if(serverinfo.linuxshell&&4<currentNode.agent.id)return;contextelement=i;var s=document.getElementById("termShellContextMenu");4<currentNode.agent.id&&!isWindowsNode(currentNode)&&(s=document.getElementById("termShellContextMenuLinux")),showContextMenuDiv(s=34==currentNode.agent.id?document.getElementById("termShellContextMenu2"):s,e.pageX,e.pageY);break;case"deskConnectButton":if(null==currentNode||null==currentNode.agent)return!0;contextelement=i,showContextMenuDiv(document.getElementById("deskConnectContextMenu"),e.pageX,e.pageY);break;case"deskDisconnectButton":if(null==currentNode||null==currentNode.agent)return!0;contextelement=i,showContextMenuDiv(document.getElementById("deskDisconnectContextMenu"),e.pageX,e.pageY);break;case"devsContentMenu":contextelement=i;showContextMenuDiv(s=document.getElementById("contextMenu"),e.pageX,e.pageY);var a=getNodeFromId((a=(1==Q("viewselect").value?contextelement.children[0].children[0].children[1].children[0]:contextelement.children[1]).attributes.onmouseup.value).substring(12,a.length-18)),r=GetNodeRights(a),l=0!=(16&r),d=4294967295==r||0==(512&r),c=4294967295==r||0==(1024&r);QV("cxdesktop",0!=(1&a.conn)&&4!=a.mtype&&(1==a.mtype||null==a.agent||null==a.agent.caps||0!=(1&a.agent.caps)||a.intelamt&&2==a.intelamt.state)&&(8&r||256&r)&&(4294967295==r||0==(65536&r))),QV("cxterminal",0!=(1&a.conn)&&4!=a.mtype&&(1==a.mtype||null==a.agent||null==a.agent.caps||0!=(2&a.agent.caps)||a.intelamt&&2==a.intelamt.state)&&8&r&&d),QV("cxfiles",4!=a.mtype&&2==a.mtype&&(null==a.agent||null==a.agent.caps||0!=(4&a.agent.caps))&&8&r&&c),QV("cxevents",null!=a.intelamt&&(2==a.intelamt.state||2&a.conn)&&8&r),QV("cxdetails",a.mtype<3),QV("cxwebvnc",(0!=(1&a.conn)||3==a.mtype)&&a.agent&&0!=(8&r)&&0==(536870912&features)),QV("cxwebrdp",(0!=(1&a.conn)||3==a.mtype)&&a.agent&&0!=(8&r)&&0==(1073741824&features)),QV("cxwebssh",512&features2&&(0!=(1&a.conn)||3==a.mtype)&&a.agent&&0!=(8&r)),QV("cxconsole",l&&2==a.mtype&&(null==a.agent||null==a.agent.caps||0!=(8&a.agent.caps))&&8&r),QV("cxrdp",!1),0==(1&a.conn)&&3!=a.mtype||!a.agent||0==(8&r)||0<a.agent.id&&a.agent.id<5&&("win32"!=navigator.platform.toLowerCase()||null!=serverinfo.devicemeshrouterlinks&&0==serverinfo.devicemeshrouterlinks.rdp||QV("cxrdp",!0)),QV("cxmgroupsplit",!0),QV("cxstar",!0);break;default:if(null==(s=document.getElementById(o)))return!0;contextelement=i,showContextMenuDiv(s,e.pageX,e.pageY)}return haltEvent(e)}}function showContextMenuDiv(e,t,n){var i=document.documentElement.getBoundingClientRect(),o=i.height,i=i.width;e.style.left=e.style.right=e.style.top=e.style.bottom=null,i/2<t?e.style.right=i-event.pageX+"px":e.style.left=event.pageX+"px",o/2<n?e.style.bottom=o-event.pageY+"px":e.style.top=event.pageY+"px",e.style.display="block"}function cmaction(e,t){var n,i=(1==Q("viewselect").value?contextelement.children[0].children[0].children[1].children[0]:contextelement.children[1]).attributes.onmouseup.value;if(i=i.substring(12,i.length-18),9==e&&(Q("viewselect").value=3,Q("viewselect").onchange(),Q("autoConnectDesktopCheckbox").checked=!0,Q("autoConnectDesktopCheckbox").onclick()),0<e&&e<9&&(n=[0,10,12,11,13,16,17,15,19][e],t&&1==t.shiftKey?safeNewWindow(window.location.origin+"?node="+i.split("/")[2]+"&viewmode="+n+"&hide=16"+(urlargs.key?"&key="+urlargs.key:""),"meshcentral:"+i):(gotoDevice(i,n),t=meshes[currentNode.meshid],1&currentNode.conn&&2==t.mtype&&(11==n&&null==desktop&&1&currentNode.agent.caps&&connectDesktop(null,3),12==n&&null==terminal&&2&currentNode.agent.caps&&connectTerminal(null,1),13==n)&&null==files&&connectFiles(null))),10==e){for(var o=document.getElementsByClassName("DeviceCheckbox"),s=[],a=0;a<o.length;a++)!0===o[a].checked&&s.push(o[a].defaultValue.substring(6));for(a in 0==s.length&&s.push(i),s)null!=stars[s[a]]&&(delete stars[s[a]],delete s[a]);var r=Object.keys(stars).length;for(a in s)r<200&&null==stars[s[a]]&&(stars[s[a]]=1,r++);putstore("stars",JSON.stringify(stars)),updateDeviceViewDevice(i),3==Q("DevFilterSelect").value&&mainUpdate(1)}else 11==e?p10mstsc(i):12==e?p10rfb(i):13==e?p10ssh(i):14==e&&p10MCRouter(i,3)}function cmmeshaction(e){var t=contextelement.attributes.onclick.value.substring(10,contextelement.attributes.onclick.value.length-2),n=document.getElementsByClassName("DeviceCheckbox");if(1==e||2==e){for(var i=0;i<n.length;i++)n[i].attributes&&n[i].attributes.class.value.split(" ")[0]==t&&(n[i].checked=1==e);if(1==e)for(var i in nodes)nodes[i].meshid==t&&1==nodes[i].v&&(checkedNodeids[nodes[i]._id]=1);else if(2==e)for(var i in checkedNodeids){var o=getNodeFromId(i);null!=o&&o.meshid==t&&1==o.v&&delete checkedNodeids[i]}}p1updateInfo()}function cmconnectfilesaction(){connectFiles(null,1,32)}function cmtermaction(e,t){e<100?connectTerminal(null,1,{protocol:e,consent:t}):100==e&&connectTerminal(null,1,{protocol:1,requireLogin:!0,consent:t})}function cmdeskaction(e){1==e&&connectDesktop(null,3,null,72),2==e&&connectDesktop(null,3,null,8),3==e&&connectDesktop(null,3,null,64),10==e&&null!=desktop&&(desktop.sendCtrlMsg('{"ctrlChannel":"102938","type":"autolock","value":true}'),connectDesktop()),11==e&&null!=desktop&&(desktop.sendCtrlMsg('{"ctrlChannel":"102938","type":"autolock","value":false}'),connectDesktop())}function cmaltportaction(e){xxdialogMode||(setDialogMode(2,"RDP连接",3,function(){var e=0<Q("d10rdpport").value.length?parseInt(Q("d10rdpport").value):3389;meshserver.send({action:"changedevice",nodeid:currentNode._id,rdpport:e})},'RDP远程连接端口：<br /><br /><input type=text placeholder="3389" inputmode="numeric" pattern="[0-9]*" onkeypress="return (event.keyCode == 8) || (event.charCode >= 48 && event.charCode <= 57)" maxlength=5 id=d10rdpport type=text>',currentNode),Q("d10rdpport").focus(),null!=currentNode.rdpport&&(Q("d10rdpport").value=currentNode.rdpport))}function cmsshportaction(e){xxdialogMode||(setDialogMode(2,"SSH 连接",3,function(){var e=0<Q("d10sshport").value.length?parseInt(Q("d10sshport").value):22;meshserver.send({action:"changedevice",nodeid:currentNode._id,sshport:e})},'SSH远程连接端口：<br /><br /><input type=text placeholder="22" inputmode="numeric" pattern="[0-9]*" onkeypress="return (event.keyCode == 8) || (event.charCode >= 48 && event.charCode <= 57)" maxlength=5 id=d10sshport type=text>',currentNode),Q("d10sshport").focus(),null!=currentNode.sshport&&(Q("d10sshport").value=currentNode.sshport))}function cmrfbportaction(e){xxdialogMode||(setDialogMode(2,"VNC 连接",3,function(){var e=0<Q("d10rfbport").value.length?parseInt(Q("d10rfbport").value):3389;meshserver.send({action:"changedevice",nodeid:currentNode._id,rfbport:e})},'VNC远程连接端口：<br /><br /><input type=text placeholder="5900" inputmode="numeric" pattern="[0-9]*" onkeypress="return (event.keyCode == 8) || (event.charCode >= 48 && event.charCode <= 57)" maxlength=5 id=d10rfbport type=text>',currentNode),Q("d10rfbport").focus(),null!=currentNode.rfbport&&(Q("d10rfbport").value=currentNode.rfbport))}function cmhttpportaction(e){xxdialogMode||(setDialogMode(2,"HTTP 连接",3,function(){var e=0<Q("d10httpport").value.length?parseInt(Q("d10httpport").value):80;meshserver.send({action:"changedevice",nodeid:currentNode._id,httpport:e})},'HTTP远程连接端口：<br /><br /><input type=text placeholder="80" inputmode="numeric" pattern="[0-9]*" onkeypress="return (event.keyCode == 8) || (event.charCode >= 48 && event.charCode <= 57)" maxlength=5 id=d10httpport type=text>',currentNode),Q("d10httpport").focus(),null!=currentNode.httpport&&(Q("d10httpport").value=currentNode.httpport))}function cmhttpsportaction(e){xxdialogMode||(setDialogMode(2,"HTTPS 连接",3,function(){var e=0<Q("d10httpsport").value.length?parseInt(Q("d10httpsport").value):443;meshserver.send({action:"changedevice",nodeid:currentNode._id,httpsport:e})},'HTTPS远程连接端口：<br /><br /><input type=text placeholder="443" inputmode="numeric" pattern="[0-9]*" onkeypress="return (event.keyCode == 8) || (event.charCode >= 48 && event.charCode <= 57)" maxlength=5 id=d10httpsport type=text>',currentNode),Q("d10httpsport").focus(),null!=currentNode.httpsport&&(Q("d10httpsport").value=currentNode.httpsport))}function cmfilesaction(e){var t;xxdialogMode||(t=p13sort_files(p13filetree.dir)[parseInt(contextelement.attributes.fileindex.nodeValue)],1==e?(setDialogMode(2,"改名",3,p13renamefileEx,'<input type=text id=p13renameinput maxlength=64 onkeyup=p13fileNameCheck(event) style=width:100% value="'+t.n+'" />',{action:"rename",path:p13filetreelocation.join("/"),oldname:t.n}),focusTextBox("p13renameinput"),p13fileNameCheck()):2==e?t.s<=204800?p13downloadfile(encodeURIComponentEx(p13filetreelocation.join("/")+"/"+t.n),encodeURIComponentEx(t.n),t.s,"viewer"):messagebox("文件编辑器","只能编辑小于200k的文件。"):3==e&&setDialogMode(2,"删除",3,p13deletefileCm,"删除项目？",t))}function cmexpandaction(e){if(1==e)CollapsedGroups={};else{if(0==sort){for(var t in CollapsedGroups={},meshes)CollapsedGroups[t]=!0;for(var t in nodes)null==meshes[nodes[t].meshid]&&(CollapsedGroups[nodes[t].meshid]=!0)}if(1==sort){CollapsedGroups={};for(t=0;t<10;t++)CollapsedGroups["pwr:"+t]=!0}if(3==sort)for(var t in CollapsedGroups={},nodes)if((i=nodes[t]).tags)for(var n in i.tags)CollapsedGroups["tag:"+encodeURIComponentEx(i.tags[n])]=!0;if(4==sort)for(var t in CollapsedGroups={},nodes){var i=nodes[t],o=meshes[i.meshid];if(o){if(CollapsedGroups["tag:"+encodeURIComponentEx(o.name)]=!0,i.tags)for(var n in i.tags)CollapsedGroups["tag:"+encodeURIComponentEx(o.name+" - "+i.tags[n])]=!0}else if(i.tags)for(var n in i.tags)CollapsedGroups["tag:"+encodeURIComponentEx("**INDV*~*DEVS** - "+i.tags[n])]=!0}}putstore("_collapse",JSON.stringify(CollapsedGroups)),updateCollapseAllButton(),mainUpdate(4)}function cmdeskplayeraction(e){xxdialogMode||safeNewWindow(window.location.origin+"{{{domainurl}}}player.htm"+(urlargs.key?"?key="+urlargs.key:""),"meshcentral-deskplayer")}function cmdeskshortcutaction(e){xxdialogMode||deskCustomizeKeys()}function cmdeskpreconfigtypeaction(e){xxdialogMode||(-1==e?deskCustomizeStrings():showDeskTypeEx(e<1e3?serverinfo.preConfiguredRemoteInput[e].value:deskKeyboardStrings[e-1e3].v))}function cmdeskpreconfigscriptaction(e){meshserver.send({action:"runcommands",nodeids:[currentNode._id],presetcmd:e})}function p13deletefileCm(e,t){files.sendText({action:"rm",reqid:1,path:p13filetreelocation.join("/"),delfiles:[t.n],rec:!1}),p13folderup(999)}function hideContextMenu(){QV("contextMenu",!1),QV("meshContextMenu",!1),QV("filesShellContextMenu",!1),QV("termShellContextMenu",!1),QV("termShellContextMenu2",!1),QV("termShellContextMenuLinux",!1),QV("deskConnectContextMenu",!1),QV("deskDisconnectContextMenu",!1),QV("altPortContextMenu",!1),QV("rfbPortContextMenu",!1),QV("sshPortContextMenu",!1),QV("httpPortContextMenu",!1),QV("httpsPortContextMenu",!1),QV("filesContextMenu",!1),QV("deskPlayerContextMenu",!1),QV("deskKeyShortcutContextMenu",!1),QV("deskPreConfigShortcutContextMenu",!1),QV("deskPreConfigScriptContextMenu",!1),QV("expandAllContextMenu",!1),contextelement=null}var map_cm_popup,map_cm_editMarker,map_cm_clearMarker,map_cm_saveMarker,map_cm_nodemenu_items,contextmenu_items,currentNode,xxmap={map:null,contextmenu:null,activeInteractions:[],showindex:0,markersSource:null,markersLayer:null,mapLayer:null,mapView:null};function updateMapMarkers(e){if(0!=(32768&features)){if(null!=xxmap&&null==xxmap.map)try{loadmap()}catch(e){console.error("loadmap() exception",e)}if(null!=xxmap){var t,n=null;for(t in nodes)try{var i,o,s=map_parseNodeLoc(nodes[t]),a=xxmap.markersSource.getFeatureById(nodes[t]._id);null==s||nodes[t].meshid!=e&&null!=e?a&&xxmap.markersSource.removeFeature(a):(i=s[0],o=s[1],s[2],null==n?n=[i,o,i,o,0]:(i<n[0]&&(n[0]=i),o<n[1]&&(n[1]=o),i>n[2]&&(n[2]=i),o>n[3]&&(n[3]=o)),null==a?(addFeature(nodes[t]),n[4]=1):(updateFeature(nodes[t],a),a.setStyle(markerStyle(nodes[t],s[2]))))}catch(e){console.error("updateMapMarkers() exception",e,JSON.stringify(nodes[t]))}return n}}}function stringToIntHash(e){for(var t=0,n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return t}function map_parseNodeLoc(e){var t=null,n=0;return e.iploc&&(t=e.iploc,n=1),e.wifiloc&&(t=e.wifiloc,n=2),e.gpsloc&&(t=e.gpsloc,n=3),e.userloc&&(t=e.userloc,n=4),null==t||"string"!=typeof t?null:(t=t.split(","),1==n?[parseFloat(t[0])+stringToIntHash(e._id.substring(0,20))/1e11,parseFloat(t[1])+stringToIntHash(e._id.substring(20))/1e11,n]:[parseFloat(t[0]),parseFloat(t[1]),n])}function loadmap(){if(0!=(32768&features)&&null!=xxmap)if(0==(32768&features))xxmap=null;else{QV("viewselectmapoption",!0),QV("devViewButton4",!0);try{xxmap.markersSource=new ol.source.Vector,xxmap.markersLayer=new ol.layer.Vector({source:xxmap.markersSource}),xxmap.mapLayer=new ol.layer.Tile({source:new ol.source.OSM}),xxmap.mapView=new ol.View({center:ol.proj.transform([0,0],"EPSG:4326","EPSG:3857"),zoom:2,minZoom:2,maxZoom:20,extent:ol.proj.transformExtent([-1e5,-69.55,1e5,69.55],"EPSG:4326","EPSG:3857")}),xxmap.map=new ol.Map({target:"xdevicesmap",layers:[xxmap.mapLayer,xxmap.markersLayer],view:xxmap.mapView}),xxmap.map.addOverlay(map_cm_popup),xxmap.map.on("click",function(e){var t,e=xxmap.map.forEachFeatureAtPixel(e.pixel,function(e,t){return e});e&&gotoDevice(null!=(t=e.getId())?t:getCorrespondingFeature(e).getId(),10)}),xxmap.map.on("pointermove",function(e){var t,e=xxmap.map.forEachFeatureAtPixel(e.pixel,function(e,t){return e});e?(xxmap.map.getTargetElement().style.cursor="pointer",t=e.getGeometry().getCoordinates(),map_cm_popup.setPosition(t),e.getId()?QH("xmap-info-window",e.get("name")):(t=getCorrespondingFeature(e),QH("xmap-info-window",t.get("name")))):(xxmap.map.getTargetElement().style.cursor="",QH("xmap-info-window",""))});var e=new ContextMenu({width:160,defaultItems:!1,items:contextmenu_items});e.on("open",function(e){var e=xxmap.map.forEachFeatureAtPixel(e.pixel,function(e,t){return e});xxmap.contextmenu.clear(),e?e.getId()?addContextMenuItems(e):(e=getCorrespondingFeature(e))?addContextMenuItems(e):xxmap.contextmenu.extend(contextmenu_items):xxmap.contextmenu.extend(contextmenu_items)}),null==xxmap.contextmenu&&(xxmap.contextmenu=e),xxmap.map.addControl(xxmap.contextmenu)}catch(e){console.log(e),QV("viewselectmapoption",!1),QV("devViewButton4",!1),xxmap=null}}}function addFeature(e,t,n){var i=getModifiedFeature(e._id);i?xxmap.markersSource.addFeature(i):(t||n||(t=(i=map_parseNodeLoc(e))[0],n=i[1]),180<n&&meshserver.send({action:"changedevice",nodeid:e._id,userloc:[t,n=180-n]}),t<90&&-90<t&&n<180&&-180<n&&((i=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform([n,t],"EPSG:4326","EPSG:3857")),name:e.name,status:e.conn,lat:t,lon:n})).setId(e._id),i.setStyle(markerStyle(e)),xxmap.markersSource.addFeature(i)))}function removeFeature(e){e=xxmap.markersSource.getFeatureById(e._id);e&&xxmap.markersSource.removeFeature(e)}function updateFeature(e,t){e.conn!=t.get("status")&&(t.set("status",e.conn),t.setStyle(markerStyle(e)));var n,i=map_parseNodeLoc(e);null!=i&&(n=i[0],i=i[1],n==t.get("lat")&&i==t.get("lon")||(t.set("lat",n),t.set("lon",i),i=ol.proj.transform([parseFloat(i),parseFloat(n)],"EPSG:4326","EPSG:3857"),t.getGeometry().setCoordinates(i))),e.name!=t.get("name")&&t.set("name",e.name)}function modifyMarkerloc(e){var t,n=e.getId();n&&(e.setStyle(markerStyle(getNodeFromId(e.a),4)),getActiveInteractions(e)||(t=new ol.interaction.Modify({features:new ol.Collection([e]),pixelTolerance:10}),xxmap.activeInteractions.push({featureid:n,feature:e,interaction:t}),xxmap.map.addInteraction(t)))}function saveMarkerloc(e){var t,n=e.getId();n&&(t=getActiveInteractions(e))&&(xxmap.map.removeInteraction(t),removeInteraction(n),t=e.getGeometry().getCoordinates(),180<(e=ol.proj.transform(t,"EPSG:3857","EPSG:4326"))[0]&&(e[0]=180-e[0]),meshserver.send({action:"changedevice",nodeid:n,userloc:[e[1],e[0]]}))}function markerStyle(e,t){null==t&&(t=0,e.iploc&&(t=1),e.wifiloc&&(t=2),e.gpsloc&&(t=3),e.userloc)&&(t=4);e=connStateColor(e);return[new ol.style.Style({image:new ol.style.Icon({color:e,anchor:[.5,1],src:"images/mapmarker"+["","-ip","-wifi","-gps","-user"][t]+".png"})})]}function connStateColor(e){return 1==e.conn||3==e.conn||5==e.conn?"#00ffdd":"#C70039"}function addContextMenuItems(t){getActiveInteractions(t)?(map_cm_saveMarker.data=t,xxmap.contextmenu.push(map_cm_saveMarker)):(map_cm_editMarker.data=t,xxmap.contextmenu.push(map_cm_editMarker),getNodeFromId(t.a).userloc&&(map_cm_clearMarker.data=t,xxmap.contextmenu.push(map_cm_clearMarker))),map_cm_nodemenu_items.forEach(function(e){"放大到一定程度"==e.text||"缩小到一定程度"==e.text?e.data=t:"-"!=e&&(e.data=t.getId())}),xxmap.contextmenu.extend(map_cm_nodemenu_items)}function getActiveInteractions(e){for(var t=e.getId(),n=0;n<xxmap.activeInteractions.length;n++)if(xxmap.activeInteractions[n].featureid==t)return xxmap.activeInteractions[n].interaction;return!1}function getModifiedFeature(e){if(e)for(var t=0;t<xxmap.activeInteractions.length;t++)if(xxmap.activeInteractions[t].featureid==e)return xxmap.activeInteractions[t].feature;return null}function removeInteraction(e){for(var t=-1,n=0;n<xxmap.activeInteractions.length;n++)if(xxmap.activeInteractions[n].featureid===e){t=n;break}0<=t&&xxmap.activeInteractions.splice(t,1)}function getCorrespondingFeature(e){for(var t=e.getGeometry().getCoordinates(),n=0;n<xxmap.activeInteractions.length;n++){var i=xxmap.activeInteractions[n].feature,o=i.getGeometry().getCoordinates();if(o[0].toFixed(5)==t[0].toFixed(5)&&o[1].toFixed(5)==t[1].toFixed(5))return i}return null}function refreshMap(e,t){e&&(xxmap.map.setTarget(null),xxmap.map=null,xxmap.markersSource=null,xxmap.mapView=null,xxmap.mapLayer=null,xxmap.activeInteractions=[]);e=updateMapMarkers();if(null!=e&&(t||1==e[4])){for(var t=(e[0]+e[2])/2,n=(e[1]+e[3])/2,i=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),e=xxmap.map.getView(),o=(e.setCenter(ol.proj.transform([n,t],"EPSG:4326","EPSG:3857")),360),s=-2;i<o;)s++,o/=2;e.setZoom(s)}}function placeNode(e){if(!xxdialogMode){var t,n='<div style=margin-bottom:6px><label for=selectnode-search>搜寻</label>&nbsp&nbsp<input type=text placeholder="设备名称" id="selectnode-search" onchange=onPlaceNodeInputChange() onkeyup=onPlaceNodeInputChange() autocomplete=off style=width:120px></div><div id=placenode style="height:254px;overflow-y:auto;width:100%;margin:12px 1px 4px 1px;"><div id=noNodesMapPlace style=text-align:center;width:100%;display:none>找不到设备。</div>';for(t in nodes)n=(n+="<div class=noselect id="+nodes[t]._id+"-rowid onclick=selectNodeToPlace(event,'"+nodes[t]._id+"') style=background-color:lightgray;margin-bottom:4px;border-radius:2px><input name=PlaceMapDeviceCheckbox id="+nodes[t]._id+"-checkid type=checkbox style=width:16px;display:inline />")+"<div class=j"+nodes[t].icon+" style=width:16px;height:16px;margin-top:2px;margin-right:4px;display:inline-block></div><div style=width:16px;display:inline>"+nodes[t].name+"</div></div>";setDialogMode(2,"选择要放置的节点",3,placeNodeEx,n+"</div>",e),onPlaceNodeInputChange()}}function placeNodeEx(e,t){var n,i,o,s,a=document.getElementsByName("PlaceMapDeviceCheckbox");for(n in a)a[n].checked&&(i=getNodeFromId(a[n].id.substring(0,a[n].id.length-8)))&&(o=xxmap.markersSource.getFeatureById(n),s=[(s=ol.proj.transform(t,"EPSG:3857","EPSG:4326"))[1],s[0]],o&&(o.getGeometry().setCoordinates(t),getActiveInteractions(o))?saveMarkerloc(o):meshserver.send({action:"changedevice",nodeid:i._id,userloc:s}))}function onPlaceNodeInputChange(){updatePlaceNodeTable(Q("selectnode-search").value.trim().toLowerCase())}function updatePlaceNodeTable(e){document.getElementsByName("PlaceMapDeviceCheckbox");var t,n=0;for(t in nodes){var i=0<=nodes[t].namel.indexOf(e)||""==e||null!=nodes[t].rnamel&&0<=nodes[t].rnamel.indexOf(e);i&&n++,QV(nodes[t]._id+"-rowid",i)}QV("noNodesMapPlace",0==n)}function selectNodeToPlace(e,t){"PlaceMapDeviceCheckbox"!=e.target.name&&((e=Q(t+"-checkid")).checked=!e.checked);var n,i=document.getElementsByName("PlaceMapDeviceCheckbox"),o=0;for(n in i)i[n].checked&&o++;QE("idx_dlgOkButton",0<o)}function addMeshOptions(e,t){}function meshOptionRmvMod(e,t){}function meshExists(){for(var e in meshes)if(meshes[e])return!0;return!1}function setMeshView(e){var t=Q("select-mesh");t[t.selectedIndex].value==e&&(t[0].selected=!0,onSelectMeshChange())}function clearMeshOptions(){}function getSearchLocation(){try{var e,t=Q("mapSearchLocation").value.trim();0<t.length&&((e=new XMLHttpRequest).onreadystatechange=function(){4==e.readyState&&200==e.status&&formatSearchData(e.responseText)},e.open("GET","https://nominatim.openstreetmap.org/search?q="+t+"&format=json",!0),e.send())}catch(e){}}function formatSearchData(e){try{QH("xmapSearchResults","");for(var t=JSON.parse(e),n=0,i='<div class="xmapItem">',o=0;o<t.length;o++)t[o].display_name&&t[o].boundingbox[0]&&t[o].boundingbox[1]&&t[o].boundingbox[2]&&t[o].boundingbox[3]&&(n++,i+='<div class="xmapItemSel1" onclick=mapGotoSelectedLocation(this)><div>'+t[o].display_name+"</div><div style=display:none>"+t[o].boundingbox[0]+"!#!"+t[o].boundingbox[1]+"!#!"+t[o].boundingbox[2]+"!#!"+t[o].boundingbox[3]+"</div></div>");i+="</div>",1==n?zoomToExtent([parseFloat(t[0].boundingbox[2]),parseFloat(t[0].boundingbox[0]),parseFloat(t[0].boundingbox[3]),parseFloat(t[0].boundingbox[1])]):(0==n&&(i="<div style=width:200px>找不到位置。<div>"),QV("xmapSearchResultsDlg",!0)),QH("xmapSearchResults",i)}catch(e){}}function mapGotoSelectedLocation(e){e=e.children[1].innerHTML.split("!#!");zoomToExtent([parseFloat(e[2]),parseFloat(e[0]),parseFloat(e[3]),parseFloat(e[1])]),mapCloseSearchWindow()}function mapCloseSearchWindow(){QH("xmapSearchResults",""),QV("xmapSearchResultsDlg",!1)}function zoomToLocation(e,t){var n=xxmap.map.getView();n.setCenter(e),n.setZoom(t)}function zoomToFitExtent(){var e;0<xxmap.markersSource.getFeatures().length&&(e=xxmap.markersSource.getExtent(),xxmap.map.getView().fit(e,xxmap.map.getSize()))}function zoomToExtent(e){e=ol.proj.transformExtent(e,ol.proj.get("EPSG:4326"),ol.proj.get("EPSG:3857"));xxmap.map.getView().fit(e,xxmap.map.getSize())}function refreshDevice(e){currentNode&&currentNode._id==e&&gotoDevice(e,xxcurrentView,!0)}32768&features&&(map_cm_popup=new ol.Overlay({element:Q("xmap-info-window"),positioning:"bottom-center",stopEvent:!1}),map_cm_editMarker={text:"修改节点位置",callback:function(e){modifyMarkerloc(e.data)}},map_cm_clearMarker={text:"删除节点位置",callback:function(e){meshserver.send({action:"changedevice",nodeid:e.data.a,userloc:[]})}},map_cm_saveMarker={text:"保存节点位置",callback:function(e){saveMarkerloc(e.data)}},map_cm_nodemenu_items=[{text:"一般信息",callback:function(e){null!=e.data&&gotoDevice(e.data,10)}},{text:"桌面",callback:function(e){null!=e.data&&gotoDevice(e.data,11)}},{text:"终端",callback:function(e){null!=e.data&&gotoDevice(e.data,12)}},{text:"英特尔&reg;AMT",callback:function(e){null!=e.data&&gotoDevice(e.data,14)}},"-",{text:"放大到一定程度",callback:function(e){zoomToLocation(e.data.getGeometry().getCoordinates(),19)}},{text:"缩小到一定程度",callback:function(e){zoomToLocation(e.data.getGeometry().getCoordinates(),2)}}],contextmenu_items=[{text:"刷新",callback:function(){refreshMap(!0,!0)}},{text:"缩放至适合范围",callback:function(){zoomToFitExtent()}},{text:"在这里为中心显示地图",callback:function(e){xxmap.mapView.animate({center:e.coordinate})}},{text:"将节点放在这里",callback:function(e){placeNode(e.coordinate)}}]);var powerTimelineNode=null,powerTimelineReq=null,powerTimelineUpdate=null,powerTimeline=null,deviceSharesNode=null,deviceSharesReq=null,deviceShares=null;function getCurrentNode(){return currentNode}function gotoDevice(e,t,n,i){if(!i||3!=i.which&&2!=i.button)if(!0!==userinfo.emailVerified&&1==serverinfo.emailcheck&&4294967295!=userinfo.siteadmin)setDialogMode(2,"账户安全",1,null,"在验证电子邮件地址之前，无法访问此功能。这是密码恢复所必需的。转到“我的帐户”标签以更改和验证电子邮件地址。");else if(262144&features&&0==count2factoraAuths())setDialogMode(2,"账户安全",1,null,"在启用两因素身份验证之前，无法访问此功能。这是额外的安全性所必需的。转到“我的帐户”标签，然后查看“帐户安全性”部分。");else if(!i||1!=i.shiftKey&&2!=i.which&&1!=i.button){var o=getNodeFromId(e);if(null!=o){null!=currentNode&&currentNode._id==o._id&&0!=(1&o.conn)||deviceDetailsStatsClear();var s=meshes[o.meshid],a=GetNodeRights(o),H=null==currentNode||currentNode._id!=e;if(!currentNode||currentNode._id!=o._id||1==n){currentNode=o,QV("deskPreConfigScriptContextMenu1",2==currentNode.mtype&&isWindowsNode(currentNode)),QV("deskPreConfigScriptContextMenu2",2==currentNode.mtype&&!isWindowsNode(currentNode)),QV("p10deviceNotify",null!=currentNode.sessions&&(null!=currentNode.sessions.kvm||null!=currentNode.sessions.terminal||null!=currentNode.sessions.files||null!=currentNode.sessions.tcp||null!=currentNode.sessions.udp)),QV("p10deviceStar",1==stars[currentNode._id]),QV("p10deviceHelp",null!=currentNode.sessions&&null!=currentNode.sessions.help),null!=currentNode.sessions&&null!=currentNode.sessions.msg?(QV("p10deviceMsg",!0),QH("p10deviceMsg",Object.keys(currentNode.sessions.msg).length)):QV("p10deviceMsg",!1),QV("p10deviceBattery",!1),null!=currentNode.sessions&&null!=currentNode.sessions.battery?(f="","ac"==(r=currentNode.sessions.battery).state&&(f="设备已插入"),"dc"==r.state&&(f="设备由电池供电"),d="",w=-1,"number"==typeof r.level&&0<=r.level&&r.level<=100&&(d=r.level+"%",5<(w=Math.floor((r.level+10)/25)+1)&&(lvl=5),"ac"==r.state)&&(100==r.level?w=11:w+=5),0<w&&(Q("p10deviceBattery").title=null!=f?f+", "+d:d,QV("p10deviceBattery",!0),Q("p10deviceBattery").className="deviceBatteryLarge deviceBatteryLarge"+w)):QV("p10deviceBattery",!1);var r=EscapeHtml(o.name),l=(0==r.length&&(r="<i>没有</i>"),f=r=0==(4&a)||s.flags&&0!=(2&s.flags)?r:'<span tabindex=0 title="单击此处编辑服务器端设备名称" onclick=showEditNodeValueDialog(0) onkeyup="if (event.key == \'Enter\') showEditNodeValueDialog(0)" style=cursor:pointer>'+r+' <img class=hoverButton src="images/link5.png" /></span>',s&&(r+="<span style=color:#AAA;font-size:small> - "+EscapeHtml(s.name)+"</span>"),QH("p10deviceName",r),QH("p11deviceName",r),QH("p12deviceName",r),QH("p13deviceName",r),QH("p14deviceName",r),QH("p15deviceName","控制台 -"+r),QH("p16deviceName",r),QH("p17deviceName",r),QH("p19deviceName",r),"<table style=width:100%>"),d=(0!=(8&args.hide)&&(l+="<br />"+addDeviceAttribute("名称",f)),s&&(l+=addDeviceAttribute('<span title="此计算机所属的设备组的名称。">组</span>','<a href=# title="此计算机所属的设备组的名称" onclick=gotoMesh("'+o.meshid+'") style=cursor:pointer>'+EscapeHtml(meshes[o.meshid].name)+"</a>")),null!=o.rname&&o.name!=o.rname&&(l+=addDeviceAttribute('<span title="此计算机的在操作系统中已设置的名称">操作系统名称</span>','<span title="此计算机的在操作系统中已设置的名称">'+EscapeHtml(o.rname)+"</span>")),(0==(1&features)&&4!=o.mtype||3==o.mtype)&&(l+=addDeviceAttribute("主机名",addLinkConditional("<span onclick=showEditNodeValueDialog(1) style=cursor:pointer>"+(o.host?EscapeHtml(o.host):"<i>没有</i>")+"</span>","showEditNodeValueDialog(1)",4&a))),o.desc?EscapeHtml(o.desc):"<i>没有</i>");if(l+=addDeviceAttribute("描述",0!=(4&a)?"<span onclick=showEditNodeValueDialog(2) style=cursor:pointer>"+d+' <img class=hoverButton src="images/link5.png" /></span>':d),4==o.mtype&&(null!=o.portnum&&(l+=addDeviceAttribute("端口号",o.portnum)),null!=o.porttype)&&(l+=addDeviceAttribute("端口类型",o.porttype)),null!=o.agent&&null!=o.agent.id&&3==o.mtype?(4==o.agent.id&&(l+=addDeviceAttribute("设备类型","Windows")),6==o.agent.id&&(l+=addDeviceAttribute("设备类型","Linux")),29==o.agent.id&&(l+=addDeviceAttribute("设备类型","macOS"))):null!=o.agent&&null!=o.agent.id&&null!=o.agent.ver&&(k="",k=o.agent.id<=agentsStr.length?agentsStr[o.agent.id]:agentsStr[0],0!=o.agent.ver&&(k+=" v"+o.agent.ver),14==o.agent.id&&(k=o.agent.core),!1===o.agent.root&&0!=(1&o.conn)&&(k+=", 受限制的"),l+=addDeviceAttribute("Mesh代理",k)),null!=o.intelamt&&(k="",w={0:nobreak("未激活（预）"),1:nobreak("未激活（输入）"),2:nobreak("已激活")},null!=o.intelamt.ver&&null==o.intelamt.state?k+="<i>未知状态</i>, v"+EscapeHtml(o.intelamt.ver):null==o.intelamt.ver&&2==o.intelamt.state?k+="<i>已激活</i>":null==o.intelamt.ver||null==o.intelamt.state?k+="<i>未知版本和状态</i>":(k+=w[o.intelamt.state],2==o.intelamt.state&&o.intelamt.flags&&(2&o.intelamt.flags?k+=' <span title="英特尔AMT在客户端控制模式下被激活">CCM</span>':4&o.intelamt.flags&&(k+=' <span title="在Intel&reg; AMT尔AMT">ACM</span>')),k+=", v"+EscapeHtml(o.intelamt.ver)),2==o.intelamt.state&&(1==o.intelamt.tls&&(k+=', <span title="英特尔AMT已设置TLS网络安全">TLS</span>'),r=!1,null==o.intelamt.user||""==o.intelamt.user?0!=(4&a)?(k+=', <i style=color:#FF0000;cursor:pointer title="编辑英特尔&reg;AMT凭证" onclick=editDeviceAmtSettings("'+o._id+'")>没有凭证</i>',r=!0):k+=", <i style=color:#FF0000>没有凭证</i>":0!=(1&features2)&&null!=o.intelamt.warn&&(f=null,0!=(1&o.intelamt.warn)&&(f="无效证件"),null!=(f=0!=(8&o.intelamt.warn)?"尝试凭据":f))&&(0!=(4&a)?(k+=', <i style=color:#FF0000;cursor:pointer title="编辑英特尔&reg;AMT凭证" onclick=editDeviceAmtSettings("'+o._id+'")>'+f+"</i>",r=!0):k+=", <i style=color:#FF0000>"+f+"</i>"),k+=" ",r=0!=(4&a)&&0==(1&features2)||r)&&(k+='<img src=images/link4.png height=10 width=10 title="编辑英特尔&reg;AMT凭证" style=cursor:pointer onclick=editDeviceAmtSettings("'+o._id+'")>'),d='<span title="英特尔&reg;可管理性引擎">英特尔&reg;ME<span>',"number"==typeof o.intelamt.sku&&(0!=(8&o.intelamt.sku)?d='<span title="英特尔&reg;主动管理技术">英特尔&reg;AMT<span>':0!=(16&o.intelamt.sku)&&(d='<span title="英特尔&reg;标准可管理性">英特尔&reg;SM<span>')),l+=addDeviceAttribute(d,k)),null!=o.agent&&null!=o.agent.tag?l+=addDeviceAttribute("代理标签",p=(p=EscapeHtml(o.agent.tag)).startsWith("mailto:")?'<a href="'+EscapeHtml(p)+'">'+EscapeHtml(p.substring(7))+"</a>":p):null!=o.intelamt&&null!=o.intelamt.tag&&(l+=addDeviceAttribute("英特尔&reg;AMT标签",p=(p=EscapeHtml(o.intelamt.tag)).startsWith("mailto:")?'<a href="'+EscapeHtml(p)+'">'+EscapeHtml(p.substring(7))+"</a>":p)),o.osdesc&&(l+=addDeviceAttribute("操作系统",o.osdesc)),o.wsc&&(u=[],null!=o.wsc.antiVirus&&("OK"==o.wsc.antiVirus?u.push("影音 - <span style=color:green>OK</span>"):u.push("影音 - <span style=color:red>坏的</span>")),null!=o.wsc.autoUpdate&&("OK"==o.wsc.autoUpdate?u.push("更新 - <span style=color:green>OK</span>"):u.push("更新 - <span style=color:red>坏的</span>")),null!=o.wsc.firewall&&("OK"==o.wsc.firewall?u.push("防火墙 - <span style=color:green>OK</span>"):u.push("防火墙 - <span style=color:red>坏的</span>")),l+=addDeviceAttribute("Windows安全",u.join(", "))),o.defender&&(u=[],null!=o.defender.RealTimeProtection&&(1==o.defender.RealTimeProtection?u.push("RealTimeProtection - <span style=color:green>On</span>"):u.push("RealTimeProtection - <span style=color:red>离开</span>")),null!=o.defender.TamperProtected&&(1==o.defender.TamperProtected?u.push("TamperProtection - <span style=color:green>On</span>"):u.push("TamperProtection - <span style=color:red>离开</span>")),0<u.length)&&(l+=addDeviceAttribute("Windows Defender",u.join(", "))),o.av&&0<o.av.length){var c,u=[];for(g in o.av)o.av[g].product&&(c=EscapeHtml(o.av[g].product),!0!==o.av[g].enabled&&(c+=" - <span style=color:red>已禁用</span>"),!0!==o.av[g].updated&&(c+=" - <span style=color:red>过时的</span>"),1==o.av[g].enabled&&1==o.av[g].updated&&(c+=" - <span style=color:green>OK</span>"),u.push(c));l+=addDeviceAttribute("杀毒软件",u.join("<br />"))}o.users&&0<o.users.length&&(w=o.users.map(function(e){return addKeyLinkConditional(EscapeHtml(e),"已锁定",o.lusers&&0<=o.lusers.indexOf(e))}).join(", "),l+=addDeviceAttribute((o.users.length,"活跃用户"),w)),null!=o.agent&&14!=o.agent.id&&3!=o.mtype&&(f=[],r=0,o.consent&&(r=o.consent),serverinfo.consent&&(r|=serverinfo.consent),64&r&&8&r?f.push("桌面提示+工具栏"):64&r?f.push("桌面工具栏"):8&r?f.push("桌面提示"):1&r&&f.push("桌面通知"),16&r?f.push("终端提示"):2&r&&f.push("终端通知"),32&r?f.push("档案提示"):4&r&&f.push("档案通知"),7==r&&(f=["一直通知"]),l+=addDeviceAttribute("用户同意",addLinkConditional(f=""==(f=(f=56==(56&r)?["一直提示"]:f).join(", "))?"<i>没有</i>":f,"p20editmeshconsent(3)",1&a)));var d=[],p=(null!=userinfo.notify&&null!=userinfo.notify[o._id]&&(2&(k=userinfo.notify[o._id])&&d.push("连接"),4&k&&d.push("断线"),null!=o.intelamt&&8&k&&d.push("英特尔&reg;AMT"),16384&features2&&userinfo.emailVerified&&(x=0,16&k&&x++,32&k&&x++,64&k&&x++,0<x)&&d.push(format("Email ({0})",x)),null!=userinfo.msghandle)&&0!=(33554432&features2)&&(x=0,128&k&&x++,256&k&&x++,512&k&&x++,0<x)&&d.push(format("Messaging ({0})",x)),l+=addDeviceAttribute("通知",addLink(d=""==(d=d.join(", "))?"<i>没有</i>":d,"p20editDeviceNotify()")),o.conn),m=(p&&1<p&&(w=[],0!=(1&o.conn)&&w.push('<span title="已连接Mesh代理并准备使用。">Mesh代理</span>'),0!=(2&o.conn)?w.push('<span title="英特尔&reg;AMT CIRA已连接并可以使用。">英特尔&reg;AMT CIRA</span>'):0!=(4&o.conn)&&w.push('<span title="英特尔&reg;AMT可路由并可以使用。">英特尔&reg;AMT</span>'),0!=(8&o.conn)&&w.push('<span title="Mesh代理可以经过其他代理作为中继访问得到。">网格中继</span>'),0!=(16&o.conn)&&w.push('<span title="与设备的MQTT连接已激活。">MQTT</span>'),l+=addDeviceAttribute("连接性",w.join(", "))),"<i>没有</i>");if(null!=o.tags)for(var g in m="",o.tags)m+="<span class=tagSpan>"+EscapeHtml(o.tags[g])+"</span> ";l+=addDeviceAttribute("标签",0!=(4&a)?"<span onclick=showEditNodeValueDialog(3) style=line-height:26px;cursor:pointer>"+m+' <img class=hoverButton src="images/link5.png" width=10 height=10 /></span>':"<span style=line-height:26px>"+m+"</span>"),null==o.ssh&&null==o.rdp||(u=[],0!=(4&a)?(null!=o.ssh&&u.push("<span onclick=showClearSshDialog(3) style=cursor:pointer>"+(1==o.ssh?"SSH-用户+密码":2==o.ssh?"SSH-用户+密钥+密码":"SSH-用户+密钥")+' <img class=hoverButton src="images/link5.png" width=10 height=10 /></span>'),null!=o.rdp&&u.push('<span onclick=showClearRdpDialog(3) style=cursor:pointer>RDP <img class=hoverButton src="images/link5.png" width=10 height=10 /></span>')):(null!=o.ssh&&u.push(1==o.ssh?"SSH-用户+密码":2==o.ssh?"SSH-用户+密钥+密码":"SSH-用户+密钥"),null!=o.rdp&&u.push("RDP")),l+=addDeviceAttribute("证书",u.join(", ")));var h=[];for(g in meshes)meshes[g].relayid==o._id&&h.push('<a href=# onclick=gotoMesh("'+meshes[g]._id+'") style=cursor:pointer>'+EscapeHtml(meshes[g].name)+"</a>");if(0<h.length&&(l+=addDeviceAttribute('<span title="设备组此设备是中继">继电器</span>',h.join("，"))),l+="</table><br />",0!=(262220&a)&&o.mtype<3&&(null==o.agent||34!=o.agent.id)&&(l+='<input type=button value="动作" title="在设备上执行电源操作" onclick=deviceActionFunction() />'),l=(l+='<input type=button value="笔记" title="查看有关此设备的注释" onclick=showNotes('+(0==(128&a))+',"'+encodeURIComponentEx(o._id)+'") />')+('<input type=button value="记录事件" title="为此设备写一个事件" onclick=writeDeviceEvent("'+encodeURIComponentEx(o._id)+'") />'),2==o.mtype&&1&p&&0!=(131072&a)&&(l+='<input type=button cmenu=deskPreConfigScriptContextMenu value="Run" title="在此设备上运行命令。" onclick=runDeviceCmd("'+encodeURIComponentEx(o._id)+'") />'),4!=o.mtype){if((8&a&&1&p&&0!=(16384&a)||1==o.pmt&&0!=(2&features2))&&(l+='<input type=button value="消息" title="在远程设备上显示短信" onclick=deviceMessageFunction() />'),(8&a&&1&p&&0!=(16384&a)||1==o.pmt&&0!=(2&features2))&&(l+='<input type=button value="聊天" title="打开此计算机的聊天窗口" onclick=deviceChat(event) />'),null!=serverinfo&&null!=serverinfo.altmessenging&&8&a&&1&p)for(var g in serverinfo.altmessenging){var v=serverinfo.altmessenging[g];null!=v.type&&"device"!=v.type||(l+='<input type=button value="'+EscapeHtml(serverinfo.altmessenging[g].name)+'" onclick=altDeviceChat(event,'+g+") />")}!1!==serverinfo.guestdevicesharing&&null!=o.agent&&3&o.agent.caps&&1&p&&524296==(524296&a)&&(4294967295==a||0==(4096&a))?(l+='<input type=button value="共享" title="创建连结以与访客共享此设备" onclick=showShareDevice() />',QV("DeskGuestShareButton",!0)):QV("DeskGuestShareButton",!1)}if(4==o.mtype&&1&p&&("PDU"==o.porttype?1==o.pwr?262144&a&&(l+='<input type=button value="关掉" title="关掉" onclick=setIpPduState(0) />'):8==o.pwr&&64&a&&(l+='<input type=button value="打开" title="打开" onclick=setIpPduState(1) />'):8&a&&(l+='<input type=button value="遥控" title="遥控" onclick=openIpKvmRemoteControl("'+encodeURIComponentEx(o._id)+'") />')),null!=customui&&null!=customui.devicebuttons)for(var g in customui.devicebuttons)(null==customui.devicebuttons[g].showif||null!=s&&customui.devicebuttons[g].showif==s._id||customui.devicebuttons[g].showif==currentNode._id)&&(l+='<input id="cui:'+g+'" type="button" value="'+customui.devicebuttons[g].name+'" onclick=customUIAction(event,"devicebuttons") />');QH("p10html",l),mainUpdate(256);var r=4294967295==a||0==(65536&a),f=4294967295==a||0==(512&a),k=4294967295==a||0==(1024&a),x=4294967295==a||0==(2048&a),l='<div class="p10html3right">';if(0!=(1&a)&&4!=o.mtype&&(l+='&nbsp;<a href=# onclick=p10showChangeGroupDialog(["'+o._id+'"]) title="将此设备移到其他设备组">更改组</a>'),0!=(32768&a)&&(l+='&nbsp;<a href=# onclick=p10showDeleteNodeDialog("'+o._id+'") title="删除此设备">删除设备</a>'),l+='</div><div class="p10html3left">',o.agent&&3!=o.mtype&&0!=(1048576&a)&&(l+='<a href=# onclick=p10showNodeNetInfoDialog("'+o._id+'") title="显示设备网络接口信息">介面</a>&nbsp;'),32768&features&&null!=xxmap&&(l+='<a href=# onclick=p10showNodeLocationDialog("'+o._id+'") title="显示设备位置信息">位置</a>&nbsp;'),null==o.agent||14!=o.agent.id&&34!=o.agent.id){if(4294967295!=userinfo.siteadmin&&0!=(128&userinfo.siteadmin)||f&&0!=(8&a)&&null!=o.agent&&14!=o.agent.id&&(l+='<a href=# onclick=p10showMeshCmdDialog(1,"'+o._id+'") title="用于通过此服务器连接到设备的流量路由器.">MeshCmd</a>&nbsp;'),0!==args.xterm||!o.agent||0==(2&o.agent.caps)||0==(8&a)||4294967295!=a&&0!=(512&a)||(l+='<a href=# onclick=p10openxterm(event,"'+o._id+'") title="打开XTerm终端">XTerm</a>&nbsp;'),(0!=(1&p)||3==o.mtype)&&o.agent&&0!=(8&a)&&(0!=webRelayPort&&(l=(l+='<a href=# cmenu=httpPortContextMenu onclick=p10WebRouter("'+o._id+'",1,'+(o.httpport||80)+")>HTTP"+(o.httpport&&80!=o.httpport?"/"+o.httpport:"")+"</a>&nbsp;")+'<a href=# cmenu=httpsPortContextMenu onclick=p10WebRouter("'+o._id+'",2,'+(o.httpsport||443)+")>HTTPS"+(o.httpsport&&443!=o.httpsport?"/"+o.httpsport:"")+"</a>&nbsp;"),0<o.agent.id&&o.agent.id<5&&("win32"!=navigator.platform.toLowerCase()||null!=serverinfo.devicemeshrouterlinks&&0==serverinfo.devicemeshrouterlinks.rdp||(l+='<a href=# cmenu=altPortContextMenu id=rdpMCRouterLink onclick=p10MCRouter("'+o._id+'",3) title="需要安装MeshCentral路由器.">RDP'+(o.rdpport&&3389!=o.rdpport?"/"+o.rdpport:"")+"</a>&nbsp;")),4<o.agent.id&&("win32"!=navigator.platform.toLowerCase()&&"macintel"!=navigator.platform.toLowerCase()||null!=serverinfo.devicemeshrouterlinks&&0==serverinfo.devicemeshrouterlinks.ssh||(l+='<a href=# cmenu=sshPortContextMenu onclick=p10MCRouter("'+o._id+'",4,'+(o.sshport||22)+') title="需要安装MeshCentral Router。">SSH'+(o.sshport&&22!=o.sshport?"/"+o.sshport:"")+"</a>&nbsp;"),"win32"!=navigator.platform.toLowerCase()||null!=serverinfo.devicemeshrouterlinks&&0==serverinfo.devicemeshrouterlinks.scp||(l+='<a href=# cmenu=sshPortContextMenu onclick=p10MCRouter("'+o._id+'",5,'+(o.sshport||22)+') title="需要安装MeshCentral Router。">SCP'+(o.sshport&&22!=o.sshport?"/"+o.sshport:"")+"</a>&nbsp;")),"win32"==navigator.platform.toLowerCase()||"macintel"==navigator.platform.toLowerCase())&&null!=serverinfo.devicemeshrouterlinks&&Array.isArray(serverinfo.devicemeshrouterlinks.extralinks))for(var g in serverinfo.devicemeshrouterlinks.extralinks){var y=serverinfo.devicemeshrouterlinks.extralinks[g],b='"'+y.protocol+'"';doesDeviceMatchFilterTags(o,y.filter)&&("number"==typeof y.protocol?b=y.protocol:"http"==y.protocol?b=1:"https"==y.protocol?b=2:"rdp"==y.protocol?b=3:"ssh"==y.protocol?b=4:"scp"==y.protocol?b=5:"mcrdesktop"==y.protocol?b=6:"mcrfiles"==y.protocol&&(b=7),6!=b&&7!=b||2==o.mtype)&&(l+='<a href=# onclick=p10MCRouter("'+o._id+'",'+b+","+y.port+(y.ip?',"'+y.ip+'"':",null")+","+(y.localport||0)+') title="需要安装MeshCentral Router。">'+y.name+"</a>&nbsp;")}0==(1&p)&&3!=o.mtype||!o.agent||0==(8&a)||0!=(536870912&features)||(l+='<a href=# cmenu=rfbPortContextMenu id=rfbLink onclick=p10rfb("'+o._id+'") title="启动与此设备的基于 Web 的 VNC 会话.">网络VNC</a>&nbsp;'),0==(1&p)&&3!=o.mtype||!o.agent||0==(8&a)||0!=(1073741824&features)||(l+='<a href=# cmenu=altPortContextMenu id=mstscLink onclick=p10mstsc("'+o._id+'") title="启动基于Web的RDP连接到此设备.">网络RDP</a>&nbsp;'),512&features2&&(0!=(1&p)||3==o.mtype)&&o.agent&&0!=(8&a)&&(l+='<a href=# cmenu=sshPortContextMenu id=sshLink onclick=p10ssh("'+o._id+'") title="启动与此设备的基于 Web 的 SSH 会话.">网络SSH</a>&nbsp;'),4294967295==a&&4194304&features&&(l+='<a href=# onclick=p10showMqttLoginDialog("'+o._id+'") title="获取此设备的MQTT登录凭证。">MQTT登录</a>&nbsp;')}l+="</div><br>",3==o.mtype?(QH("p10html3",""),QH("p10html5",l)):(QH("p10html3",l),QH("p10html5",""));var d=PowerStateStr(o.state),w="",w=(null!=o.agent&&!1===o.agent.root&&(w=', <span title="代理在特权降低的远程设备上运行。">受限制的</span>'),0!=(1&p)&&(0<d.length&&(d+="<br/>"),4==o.mtype?"PDU"==o.porttype?d+='<span style=font-size:12px title="交换机端口已连接">交换机端口已连接</span>'+w:d+='<span style=font-size:12px title="已连接 IP-KVM 端口">已连接 IP-KVM 端口</span>'+w:d+='<span style=font-size:12px title="代理已连接">代理已连接</span>'+w),0!=(2&p)?(0<d.length&&(d+="<br/>"),d+='<span style=font-size:12px title="英特尔&reg;AMT已连接">英特尔&reg;AMT已连接</span>'):0!=(4&p)&&(0<d.length&&(d+="<br/>"),d+='<span style=font-size:12px title="检测到英特尔&reg;AMT">检测到英特尔&reg;AMT</span>'),0!=(16&p)&&(0<d.length&&(d+="<br/>"),d+='<span style=font-size:12px title="MQTT已连接">MQTT通道已连接</span>'),""==d&&o.lastconnect?d="<span style=font-size:12px>最后一次发现：<br />"+printDateTime(new Date(o.lastconnect))+"</span>":("PDU"==o.porttype||1<o.pwr&&7!=o.pwr)&&(d+="<br/>"+powerStateStrings[o.pwr]),QH("MainComputerState",d),Q("MainComputerImage").setAttribute("src","images/icons256-"+o.icon+"-1.png"),Q("MainComputerImage").className=o.conn&&0!=o.conn||3==o.mtype?"":"gray",3==o.mtype&&null!=o.agent&&4<o.agent.id&&512&features2&&(o.agent.caps=6),f&&setupTerminal(),k&&setupFiles(),0!=(16&a)),p=(w?setupConsole():15==t&&(t=10),QV("MainDevDesktop",r&&(null==o.agent&&null!=o.intelamt&&("number"!=typeof o.intelamt.sku||0!=(8&o.intelamt.sku))||null!=o.agent&&(null==o.agent.caps||0!=(1&o.agent.caps)||o.intelamt&&2==o.intelamt.state)||3==o.mtype&&(3==o.agent.id||4==o.agent.id))&&(8&a||256&a)),QV("MainDevTerminal",(null==o.agent&&null!=o.intelamt||o.agent&&null==o.agent.caps||o.agent&&0!=(2&o.agent.caps)||o.intelamt&&2==o.intelamt.state)&&8&a&&f),QV("MainDevFiles",null!=o.agent&&null!=o.agent.caps&&0!=(4&o.agent.caps)&&8&a&&k),QV("MainDevInfo",o.mtype<3&&0!=(1048576&a)),QV("MainDevAmt",null!=o.intelamt&&(2==o.intelamt.state||2&o.conn)&&8&a&&x),QV("MainDevConsole",w&&null!=o.agent&&null!=o.agent.caps&&0!=(8&o.agent.caps)&&8&a),QV("MainDevPlugins",!1),QV("p15uploadCore",null!=o.agent&&null!=o.agent.caps&&0!=(16&o.agent.caps)),QH("p15coreName",null!=o.agent&&null!=o.agent.core?o.agent.core:""),null!=o.intelamt&&"number"==typeof o.intelamt.sku&&0!=(16&o.intelamt.sku)?(QH("MainDevAmt","英特尔&reg; SM"),QH("p14deviceNamePrefix","英特尔&reg;SM")):(QH("MainDevAmt","英特尔&reg;AMT"),QH("p14deviceNamePrefix","英特尔&reg;AMT")),Q("p14iframe").contentWindow.getCurrentMeshNode()),d=(null!=p&&p._id!=currentNode._id&&Q("p14iframe").contentWindow.disconnect(),0!=(6&o.conn));if(Q("p14iframe").contentWindow.setConnectionState(d),Q("p14iframe").contentWindow.setFrameHeight("650px"),Q("p14iframe").contentWindow.setAuthCallback(updateAmtCredentials),powerTimelineNode!=currentNode._id&&powerTimelineReq!=currentNode._id&&(QH("p10html2",""),powerTimelineReq=currentNode._id,meshserver.send({action:"powertimeline",nodeid:currentNode._id}),meshserver.send({action:"lastconnect",nodeid:currentNode._id}),meshserver.send({action:"getsysinfo",nodeid:currentNode._id}),meshserver.send({action:"getnetworkinfo",nodeid:currentNode._id}),meshserver.send({action:"getNotes",id:currentNode._id}),QH("p17info2","")),deviceSharesNode!=currentNode._id&&deviceSharesReq!=currentNode._id&&(deviceSharesReq=currentNode._id,meshserver.send({action:"deviceShares",nodeid:currentNode._id})),QV("DeskTools",!1),showDeskToolsProcesses(),refreshDeviceEvents(),document.title=currentNode&&10<=xxcurrentView&&xxcurrentView<20?currentNode.name+(s?" - "+s.name:"")+" - "+decodeURIComponent("{{{extitle}}}"):decodeURIComponent("{{{extitle}}}"),H&&(p11clearConsoleMsg(),p12clearConsoleMsg(),p13clearConsoleMsg()),null!=pluginHandler&&(QH("p19headers",""),QH("p19pages",""),pluginHandler.callHook("onDeviceRefreshEnd",e,t,n,i),null!=(r=getstore("_curPluginPage",null)))&&null!=Q("p19ph-"+r)&&pluginHandler.callPluginPage(r,Q("p19ph-"+r)),l="",7&a&&(l+='<a href=# onclick="return p20showAddMeshUserDialog(5)" style=cursor:pointer;margin-right:10px><img src=images/icon-addnew.png border=0 height=12 width=12> 添加用户</a>',null!=usergroups)){var S=0,D=!1;for(g in usergroups)null==usergroups[g].membershipType&&usergroups[g]._id.split("/")[1]==e.split("/")[1]&&(S++,null==currentNode.links||null==currentNode.links[g])&&(D=!0);0<S&&D&&(l+='<a href=# onclick="return p20showAddMeshUserDialog(6)" style=cursor:pointer;margin-right:10px><img src=images/icon-addnew.png border=0 height=12 width=12> 添加用户组</a>')}l+='<table style="color:black;background-color:#EEE;border-color:#AAA;border-width:1px;border-style:solid;border-collapse:collapse" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col style=text-align:left;width:430px>用户授权</th><th scope=col style=text-align:left></th></tr>';var C=1;if(null!=currentNode.links){var M=[];for(g in currentNode.links)(g.startsWith("user/")||g.startsWith("ugrp/"))&&M.push(g);for(g in M.sort(),M){var T="",E="",N=M[g],V=currentNode.links[N].rights,A=EscapeHtml(N.split("/")[2]),E=makeUserDeviceRightsString(V),V=!1;null!=currentNode.links[N].name&&(A=EscapeHtml(currentNode.links[N].name)),N==userinfo._id&&(A=EscapeHtml(userinfo.name)),null!=users&&null!=users[N]&&(A=EscapeHtml(users[N].name)),null!=usergroups&&null!=usergroups[N]&&(A=EscapeHtml(usergroups[N].name),V=!0),0!=(2&a)&&(E=V?(T="<a href=# onclick='return p30removeUserFromNode(event,\""+encodeURIComponentEx(N)+'")\' title="删除此设备组的用户组权限" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>','<span style=cursor:pointer onclick=p20showAddMeshUserDialog(6,"'+encodeURIComponentEx(N)+'")>'+E+" <img class=hoverButton style=cursor:pointer src=images/link5.png></span>"):(T="<a href=# onclick='return p30removeUserFromNode(event,\""+encodeURIComponentEx(N)+'")\' title="删除此设备组的用户权限" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>','<span style=cursor:pointer onclick=p20showAddMeshUserDialog(5,"'+encodeURIComponentEx(N)+'")>'+E+" <img class=hoverButton style=cursor:pointer src=images/link5.png></span>")),l+="<tr "+(++C%2==0?"style=background-color:#DDD":"")+'><td style=width:30%><div title="'+(V?"用户组":"用户")+'" class=m'+(V?4:2)+"></div><div>&nbsp;"+(A=null!=users?V?"<a href=# onclick='gotoUserGroup(\""+encodeURIComponentEx(N)+"\");haltEvent(event);'>"+A+"</a>":"<a href=# onclick='gotoUser(\""+encodeURIComponentEx(N)+"\");haltEvent(event);'>"+A+"</a>":A)+"<div></div></div></td><td style=width:70%><div style=float:right>"+T+"</div><div>"+E+"</div></td></tr>"}}if(1==C&&(l+="<tr><td><div style=padding:6px>&nbsp;<i>没有拥有特殊设备权限的用户</i><div></div></div></td><td></td></tr>"),l+="</tbody></table>",null!=deviceShares&&deviceSharesNode==currentNode._id&&0<deviceShares.length){l+='<br /><table style="color:black;background-color:#EEE;border-color:#AAA;border-width:1px;border-style:solid;border-collapse:collapse" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col style=text-align:left;width:430px>主动设备共享</th><th scope=col style=text-align:left></th></tr>';for(C=1,g=0;g<deviceShares.length;g++){var I=deviceShares[g],T="",_=(null!=I.url&&(T+='<a href="'+I.url+'" rel="noreferrer noopener" target=_blank title="设备共享链接" style=cursor:pointer><img src=images/link2.png border=0 height=10 width=10></a> '),T+="<a href=# onclick='return p30removeDeviceSharing(event,\""+encodeURIComponentEx(currentNode._id)+'","'+encodeURIComponentEx(I.publicid)+'","'+encodeURIComponentEx(I.guestName)+'")\' title="删除设备共享" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>',""),U=(I.p<=7?_=["","终端","桌面","桌面 + 终端","档案","终端 + 文件","桌面 + 文件","桌面 + 终端 + 文件"][I.p]:8==I.p?_="HTTP/"+I.port:16==I.p&&(_="HTTPS/"+I.port),_),_=(null!=I.startTime&&null!=I.expireTime&&(U=format("{0}，{1}至{2}",_,printFlexDateTime(new Date(I.startTime)),printFlexDateTime(new Date(I.expireTime)))),null!=I.startTime&&null!=I.duration&&(U=(I.duration,format("{0}、{1} {2} 分钟",_,printFlexDateTime(new Date(I.startTime)),I.duration))),1==I.recurring&&(U+=", 每天重复"),2==I.recurring&&(U+=", 每周重复一次"),0!=(2&I.p)&&!0===I.viewOnly&&(U+=", 仅查看桌面"),null!=I.consent&&(0==I.consent?U+=", 不同意":(0!=(56&I.consent)&&(U+="，提示同意"),0!=(64&I.consent)&&(U+=", 工具栏"))),EscapeHtml(I.guestName));l+="<tr "+(++C%2==0?"style=background-color:#DDD":"")+"><td style=width:30%><div class=m2></div><div>&nbsp;"+(_=I.publicid.startsWith("AS:node/")?"<i>代理自行共享</i>":_)+"<div></div></div></td><td style=width:70%><div style=float:right>"+T+"</div><div>"+U+"</div></td></tr>"}l+="</tbody></table>"}QH("p10html4",l);var R="";if(0==(268435456&features)&&10<=xxcurrentView&&xxcurrentView<=19&&null!=currentNode){for(var g in R="?viewmode="+xxcurrentView+"&gotonode="+currentNode._id.split("/")[2],urlargs)R+="&"+g+"="+urlargs[g];try{window.history.replaceState({},document.title,window.location.pathname+R)}catch(e){}}QV("p11DeskSessionSelector",!1),QH("p11DeskSessionSelector","")}setupDesktop(),go(t=t||10)}}else safeNewWindow(window.location.origin+"?node="+e.split("/")[2]+"&viewmode=10&hide=16"+(urlargs.key?"&key="+urlargs.key:""),"meshcentral:"+e)}function setIpPduState(e){0==e?setDialogMode(2,"电源操作",3,function(){meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:2})},"执行断电？"):setDialogMode(2,"电源操作",3,function(){meshserver.send({action:"wakedevices",nodeids:[currentNode._id]})},"执行开机？")}function p20editDeviceNotify(){var e,t,n;return xxdialogMode||(e=0,t=16384&features2&&userinfo.emailVerified?1:0,userinfo.notify&&userinfo.notify[currentNode._id]&&(e=userinfo.notify[currentNode._id]),n='<div style="border-bottom: 1px solid #888;margin-bottom:3px">网页通知</div><div><label><input id=p20notifyIntelDeviceConnect type=checkbox />设备连接。</label></div><div><label><input id=p20notifyIntelDeviceDisconnect type=checkbox />设备断开连接。</label></div>',null!=currentNode.intelamt&&(t+=2,n+="<div><label><input id=p20notifyIntelAmtKvmActions type=checkbox />英特尔&reg;AMT桌面和串行事件</label></div>"),1&t&&(n+='<br /><div style="border-bottom: 1px solid #888;margin-bottom:3px">电子邮件通知</div><div><label><input id=p20enotifyIntelDeviceConnect type=checkbox />设备连接。</label></div><div><label><input id=p20enotifyIntelDeviceDisconnect type=checkbox />设备断开连接。</label></div><div><label><input id=p20enotifyIntelDeviceHelp type=checkbox />Help requests</label></div>'),null!=userinfo.msghandle&&0!=(33554432&features2)&&(n+='<br /><div style="border-bottom: 1px solid #888;margin-bottom:3px">Messaging Notifications</div><div><label><input id=p20emsgDeviceConnect type=checkbox />设备连接。</label></div><div><label><input id=p20emsgDeviceDisconnect type=checkbox />设备断开连接。</label></div><div><label><input id=p20emsgDeviceHelp type=checkbox />Help requests</label></div>'),setDialogMode(2,"通知设置",3,p20editDeviceNotifyEx,n,t),Q("p20notifyIntelDeviceConnect").checked=2&e,Q("p20notifyIntelDeviceDisconnect").checked=4&e,2&t&&(Q("p20notifyIntelAmtKvmActions").checked=8&e),1&t&&(Q("p20enotifyIntelDeviceConnect").checked=16&e,Q("p20enotifyIntelDeviceDisconnect").checked=32&e,Q("p20enotifyIntelDeviceHelp").checked=64&e),null!=userinfo.msghandle&&0!=(33554432&features2)&&(Q("p20emsgDeviceConnect").checked=128&e,Q("p20emsgDeviceDisconnect").checked=256&e,Q("p20emsgDeviceHelp").checked=512&e)),!1}function p20editDeviceNotifyEx(e,t){var n=0,n=(n+=Q("p20notifyIntelDeviceConnect").checked?2:0)+(Q("p20notifyIntelDeviceDisconnect").checked?4:0);2&t&&(n+=Q("p20notifyIntelAmtKvmActions").checked?8:0),1&t&&(n=(n=(n+=Q("p20enotifyIntelDeviceConnect").checked?16:0)+(Q("p20enotifyIntelDeviceDisconnect").checked?32:0))+(Q("p20enotifyIntelDeviceHelp").checked?64:0)),null!=userinfo.msghandle&&0!=(33554432&features2)&&(n=(n=(n+=Q("p20emsgDeviceConnect").checked?128:0)+(Q("p20emsgDeviceDisconnect").checked?256:0))+(Q("p20emsgDeviceHelp").checked?512:0)),meshserver.send({action:"changeusernotify",nodeid:currentNode._id,notify:n})}function makeUserDeviceRightsString(e){var t,n;return 57592==e?"完整设备权限":(t=[],8&e&&(n=[],256&e&&n.push("无输入"),512&e&&n.push("没有终端"),1024&e&&n.push("没有文件"),2048&e&&n.push("没有AMT"),4096&e&&n.push("有限输入"),65536&e&&n.push("没有桌面"),524288&e&&!1!==serverinfo.guestdevicesharing&&n.push("嘉宾分享"),t.push(0<n.length?"Control ("+n.join(", ")+")":"控制")),16&e&&t.push("控制台"),32&e&&t.push("服务器档案"),64&e&&t.push("唤醒"),128&e&&t.push("笔记"),8192&e&&t.push("限制事件"),16384&e&&t.push("聊天"),32768&e&&t.push("卸载"),131072&e&&t.push("指令"),262144&e&&t.push("重置/关闭"),524288&e&&t.push("分享"),1048576&e&&t.push("细节"),2097152&e&&t.push("中继"),0==t.length?"沒有权限":t.join(", "))}function makeDeviceGroupRightsString(e){var t,n;return 4294967295==e?"全部权限":(t=[],1&e&&t.push("编辑群组"),2&e&&t.push("管理用户"),4&e&&t.push("管理设备"),8&e&&(n=[],256&e&&n.push("无输入"),512&e&&n.push("没有终端"),1024&e&&n.push("没有文件"),2048&e&&n.push("没有AMT"),4096&e&&n.push("有限输入"),65536&e&&n.push("没有桌面"),524288&e&&!1!==serverinfo.guestdevicesharing&&n.push("嘉宾分享"),t.push(0<n.length?"Control ("+n.join(", ")+")":"控制")),16&e&&t.push("控制台"),32&e&&t.push("服务器档案"),64&e&&t.push("唤醒"),128&e&&t.push("笔记"),8192&e&&t.push("限制事件"),16384&e&&t.push("聊天"),32768&e&&t.push("卸载"),131072&e&&t.push("指令"),262144&e&&t.push("重置/关闭"),524288&e&&t.push("分享"),1048576&e&&t.push("细节"),2097152&e&&t.push("中继"),0==t.length?"沒有权限":t.join(", "))}function runDeviceCmd(e){xxdialogMode||d2runCommandDialog({nodeids:[e?decodeURIComponent(e):currentNode._id]})}function writeDeviceEvent(e){xxdialogMode||(setDialogMode(2,"添加设备日志",3,writeDeviceEventEx,"<textarea id=d2devEvent style=background-color:#fcf3cf;width:100%;height:200px;resize:none;overflow-y:scroll></textarea><span style=font-size:10px>这会在此设备的事件日志中添加一个条目。<span>",e),Q("d2devEvent").focus())}function writeDeviceEventEx(e,t){meshserver.send({action:"setDeviceEvent",nodeid:decodeURIComponent(t),msg:encodeURIComponentEx(Q("d2devEvent").value)})}function showNotes(e,t){xxdialogMode||(e="<textarea id=d2devNotes ro="+e+" noteid="+(t=null==t?encodeURIComponentEx("p"+userinfo._id):t)+" readonly style=background-color:#fcf3cf;width:100%;height:200px;resize:none;overflow-y:scroll></textarea>",t.startsWith("node%2F%2F")&&(e+=" <span style=font-size:10px>其他设备组管理员可以查看和更改设备组注释。</span>"),"true"===showNotesPanel&&(e+=" <span style=font-size:10px><a target=_blank href='https://www.markdownguide.org/cheat-sheet/'>Markdown syntax supported</a></span>"),setDialogMode(2,"笔记",3,showNotesEx,e,t),meshserver.send({action:"getNotes",id:decodeURIComponent(t)}))}function showNotesEx(e,t){Q("notesPanelArea").innerHTML=marked&&DOMPurify?DOMPurify.sanitize(marked.parse(Q("d2devNotes").value,{breaks:!0}),{USE_PROFILES:{html:!0}}):Q("d2devNotes").value,meshserver.send({action:"setNotes",id:decodeURIComponent(t),notes:encodeURIComponentEx(Q("d2devNotes").value)}),"true"===showNotesPanel&&""!=Q("d2devNotes").value?QV("notesPanel",!0):QV("notesPanel",!1)}function openIpKvmRemoteControl(e){xxdialogMode||safeNewWindow("/ipkvm.ashx/"+(e=decodeURIComponent(e).split("/")[2])+"/","ipkvm:"+e)}function deviceChat(e){var t;xxdialogMode||(t="/messenger?id=meshmessenger/"+encodeURIComponentEx(currentNode._id)+"/"+encodeURIComponentEx(userinfo._id)+"&title="+currentNode.name,""!=serverinfo.domainsuffix&&(t="/"+serverinfo.domainsuffix+t),null!=authCookie&&""!=authCookie&&(t+="&auth="+authCookie),1==currentNode.pmt&&0!=(2&features2)&&(t+="&pmt=1"),e&&1==e.shiftKey?safeNewWindow(t,"meshmessenger:"+currentNode._id):safeNewWindow(t,"meshmessenger:"+currentNode._id,"directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=400,height=560"),meshserver.send({action:"meshmessenger",nodeid:decodeURIComponent(currentNode._id)}))}function altDeviceChat(e,t){var n,i,o,s,a,r;xxdialogMode||(n=serverinfo.altmessenging[t].url.split("{0}").join(currentNode._id.split("/")[2]).split("{1}").join(currentNode._id.split("/")[2]).split("{2}").join(currentNode._id.split("/")[2]).split("{3}").join(currentNode._id.split("/")[2]),s=i=encodeURIComponentEx(userinfo._id.split("/")[2]),a=o=encodeURIComponentEx(userinfo._id.split("/").join("-")),null!=userinfo.realname&&(s=encodeURIComponentEx(userinfo.realname.split(" ").join("")),a=encodeURIComponentEx(userinfo.realname.split(" ").join("-"))),r=n=n.split("{4}").join(i).split("{5}").join(o).split("{6}").join(s).split("{7}").join(a),"string"==typeof serverinfo.altmessenging[t].localurl&&(r=(r=serverinfo.altmessenging[t].localurl.split("{0}").join(currentNode._id.split("/")[2]).split("{1}").join(currentNode._id.split("/")[2]).split("{2}").join(currentNode._id.split("/")[2]).split("{3}").join(currentNode._id.split("/")[2])).split("{4}").join(i).split("{5}").join(o).split("{6}").join(s).split("{7}").join(a)),""!=n&&meshserver.send({action:"msg",type:"openUrl",nodeid:currentNode._id,url:n}),""!=r&&safeNewWindow(r,"altmessenger:"+currentNode._id,"directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=400,height=560"))}function deviceToggleBackground(){xxdialogMode||meshserver.send({action:"msg",type:"deskBackground",nodeid:currentNode._id,op:1})}function deviceUrlFunction(){xxdialogMode||(setDialogMode(2,"在设备上打开页面",3,deviceUrlFunctionEx,'<input id=d2devurl placeholder="http://server.com" style=width:100%;overflow-y:scroll onkeyup=deviceUrlFunctionValidate() onchange=deviceUrlFunctionValidate()></input>'),Q("d2devurl").focus(),deviceUrlFunctionValidate())}function deviceUrlFunctionValidate(){var e=Q("d2devurl").value.toLowerCase();QE("idx_dlgOkButton",e.startsWith("http://")&&7<e.length||e.startsWith("https://")&&8<e.length)}function deviceUrlFunctionEx(){meshserver.send({action:"msg",type:"openUrl",nodeid:currentNode._id,url:Q("d2devurl").value})}function deviceMessageFunction(){xxdialogMode||(setDialogMode(2,"设备消息",3,deviceMessageFunctionEx,"<div style=margin-bottom:4px>在远程设备上显示一个消息框。</div><textarea id=d2devMessage style=background-color:#fcf3cf;width:100%;height:80px;resize:none;overflow-y:scroll;box-sizing:border-box;margin-bottom:4px></textarea><select style=width:100% id=d2devTimeout><option value=2 selected>Show for 2 Minutes (Default)</option><option value=10>Show for 10 minutes</option><option value=30>Show for 30 minutes</option><option value=60>Show for 60 minutes</option><option value=0>显示消息，直到被用户拒绝</option></select>"),Q("d2devMessage").focus())}function deviceMessageFunctionEx(){var e=decodeURIComponent("{{{extitle}}}"),t=parseFloat(Q("d2devTimeout").value);""==e&&(e="网格中心"),isNaN(t)&&(t=2),1==currentNode.pmt?meshserver.send({action:"pushmessage",nodeid:currentNode._id,title:e,msg:Q("d2devMessage").value}):meshserver.send({action:"msg",type:"messagebox",nodeid:currentNode._id,title:e,msg:Q("d2devMessage").value,timeout:6e4*t})}function deskClipboardInFunction(){var e;null!=desktop&&3==desktop.State&&(desktop.m.getClipboard?null!=(e=desktop.m.getClipboard())&&null!=navigator.clipboard&&navigator.clipboard.writeText(e).then(function(){}).catch(function(e){console.log(e)}):meshserver.send({action:"msg",type:"getclip",nodeid:currentNode._id,tag:2}))}function deskInputLockFunction(e){xxdialogMode||null==desktop||3!=desktop.State||setDialogMode(2,"远程输入锁定",3,function(){try{desktop.m.SendRemoteInputLock(e)}catch(e){}},1==e?"锁定远程用户的鼠标和键盘？":"解锁远程用户的鼠标和键盘？")}function deskClipboardOutFunction(){if(null!=navigator.clipboard&&null!=navigator.clipboard.readText)try{navigator.clipboard.readText().then(function(e){desktop.m.setClipboard?desktop.m.setClipboard(e):meshserver.send({action:"msg",type:"setclip",nodeid:currentNode._id,data:e})}).catch(function(e){console.log(e)})}catch(e){console.log(e)}return!0}function deskRefreshFunction(){null!=desktop&&3==desktop.State&&desktop.m.SendRefresh()}function deviceToastFunction(){xxdialogMode||(setDialogMode(2,"设备通知",3,deviceToastFunctionEx,'<select id=d2deviceop style=width:100%;margin-bottom:4px><option value=2>吐司通知</option><option value=1>留言框</option><option value=3>Alert Box</option></select><input id=dp2notifyTitle maxlength=256 placeholder="标题" style=width:100%;box-sizing:border-box;margin-bottom:4px /><textarea id=d2notifyMsg style=background-color:#fcf3cf;width:100%;height:140px;resize:none;overflow-y:scroll;box-sizing:border-box;margin-bottom:4px></textarea><select style=width:100% id=d2notifyTimeout><option disabled value="">Only Applicable to Message Box Notifications</option><option value=2 selected>Show for 2 Minutes (Default)</option><option value=10>Show for 10 minutes</option><option value=30>Show for 30 minutes</option><option value=60>Show for 60 minutes</option><option value=0>显示消息，直到被用户拒绝</option></select>'),Q("d2notifyMsg").focus())}function deviceToastFunctionEx(){var e=Q("d2deviceop").value,t=Q("dp2notifyTitle").value,n=Q("d2notifyMsg").value,i=parseFloat(Q("d2notifyTimeout").value);0!=n.length&&(""==(t=""==t?decodeURIComponent("{{{extitle}}}"):t)&&(t="网格中心"),isNaN(i)&&(i=2),1==e?meshserver.send({action:"msg",type:"messagebox",nodeid:currentNode._id,title:t,msg:n,timeout:6e4*i}):2==e?meshserver.send({action:"toast",nodeids:[currentNode._id],title:t,msg:n}):3==e&&meshserver.send({action:"msg",type:"alertbox",nodeid:currentNode._id,title:t,msg:n}))}function deviceLockFunction(){null==xxdialogMode&&null!=desktop&&1==desktop.contype&&setDialogMode(2,"锁定桌面",3,function(){null!=desktop&&1==desktop.contype&&desktop.sendCtrlMsg('{"ctrlChannel":"102938","type":"lock"}')},"锁定用户桌面？")}function showShareDevice(){if(!xxdialogMode){var e,t=GetNodeRights(currentNode),n="",i="创建一个链接，该链接允许没有帐户的访客在有限的时间内远程控制此设备。<br /><br />",o=(i+=addHtmlValue("访客姓名","<input id=d2inviteName style=width:250px maxlength=128 type=text onkeyup=showShareDeviceValidate() />"),"<option value=2>桌面</option>"),s=(4294967295!=t&&0!=(256&t)&&(o=""),"<option value=1>终端</option>"),a=(4294967295!=t&&0!=(512&t)&&(s=""),"<option value=4>档案</option>"),r=(4294967295!=t&&0!=(1024&t)&&(a=""),"<option value=5>桌面 + 文件</option>"),l=(4294967295!=t&&0!=(1280&t)&&(r=""),"<option value=6>终端 + 文件</option>"),d=(4294967295!=t&&0!=(1536&t)&&(l=""),"<option value=7>桌面 + 终端 + 文件</option>"),c=(4294967295!=t&&0!=(1792&t)&&(d=""),""),n=(0!=webRelayPort&&(c="<option value=8>HTTP</option><option value=9>HTTPS</option>",4294967295!=t)&&0!=(8&t)&&(c=""),""),u="",p=(1==(1&currentNode.agent.caps)&&(n+=o+"<option value=3>桌面，仅查看</option>"),2==(2&currentNode.agent.caps)&&(n+=s),4==(4&currentNode.agent.caps)&&(n+=a),5==(5&currentNode.agent.caps)&&(n+=r),6==(6&currentNode.agent.caps)&&(n+=l),7==(7&currentNode.agent.caps)&&(n+=d),i+=addHtmlValue("类型","<select id=d2shareType style=float:right;width:250px onchange=showShareDeviceValidate()>"+(n+=c)+"</select>"),{1:"1分钟",5:"5分钟",10:"10分钟",15:"15分钟",30:"30分钟",45:"45分钟",60:"60分钟",120:"2小时",240:"4个小时",480:"8小時",720:"12小时",960:"16小时",1440:"24小时",2880:"2天",5760:"4天",0:"无限制"});for(e in n="",p)(null==serverinfo.guestdevicesharingmaxtime||0<e&&e<=serverinfo.guestdevicesharingmaxtime)&&(n+="<option value="+e+">"+p[e]+"</option>"),0<e&&e<=720&&(null==serverinfo.guestdevicesharingmaxtime||0<e&&e<=serverinfo.guestdevicesharingmaxtime)&&(u+="<option value="+e+">"+p[e]+"</option>");i=(i=(i=(i=(i=i+addHtmlValue("有效期","<select id=d2timeRange style=float:right;width:250px onchange=showShareDeviceValidate()><option value=0>现在开始</option><option value=1>时间范围</option><option value=2>每天重复</option><option value=3>每周重复</option></select>")+"<div id=d2modenow>")+addHtmlValue("到期时间","<select id=d2inviteExpire style=float:right;width:250px>"+n+"</select>")+"</div><div id=d2moderange style=display:none>")+addHtmlValue("时间范围",'<input id=d2timeRangeSelector style=float:right;width:250px class=flatpickr type="text" placeholder="选择日期和时间..." data-id="altinput">')+"</div><div id=d2moderecurring style=display:none>")+addHtmlValue("开始时间",'<input id=d2timeStartSelector style=float:right;width:250px class=flatpickr type="text" placeholder="选择日期和时间..." data-id="altinput">'))+addHtmlValue("持续时间","<select id=d2inviteDuration style=float:right;width:250px>"+u+"</select>")+"</div>",1&currentNode.agent.caps&&(i+="<div id=d2userConsentSelector>"+addHtmlValue("用户同意","<select id=d2userConsent style=float:right;width:250px><option value=0>仅通知<option value=1>用户同意提示</option><option value=2>No Consent</option></select>")+"</div>"),setDialogMode(2,"共享设备",3,showShareDeviceEx,i=(i+="<div id=d2httpPortSelector>"+addHtmlValue("Port","<input id=d2httpPort style=float:right;width:250px value=80 onkeyup=showShareDeviceValidate()></input>")+"</div>")+("<div id=d2httpsPortSelector>"+addHtmlValue("Port","<input id=d2httpsPort style=float:right;width:250px value=443 onkeyup=showShareDeviceValidate()></input>")+"</div>")),showShareDeviceValidate();t=new Date,o=(t.setDate(t.getDate()+1),flatpickr("#d2timeRangeSelector",{mode:"range",enableTime:!0,minDate:new Date,defaultDate:[new Date,t],minuteIncrement:1})),s=flatpickr("#d2timeStartSelector",{enableTime:!0,minDate:new Date,defaultDate:new Date,minuteIncrement:1});xxdialogTag={range:o,start:s}}}function showShareDeviceValidate(){1&currentNode.agent.caps&&QV("d2userConsentSelector",Q("d2shareType").value<8),QV("d2httpPortSelector",8==Q("d2shareType").value),QV("d2httpsPortSelector",9==Q("d2shareType").value),QV("d2modenow",0==Q("d2timeRange").value),QV("d2moderange",1==Q("d2timeRange").value),QV("d2moderecurring",2<=Q("d2timeRange").value);var e,t=!0;8==Q("d2shareType").value&&(e=parseInt(Q("d2httpPort").value),Q("d2httpPort").value!=e||e<1||65535<e)&&(t=!1),9==Q("d2shareType").value&&(e=parseInt(Q("d2httpsPort").value),Q("d2httpsPort").value!=e||e<1||65535<e)&&(t=!1),0==Q("d2inviteName").value.trim().length&&(t=!1),QE("idx_dlgOkButton",t)}function showShareDeviceEx(e,t){var n=0,i=parseInt(Q("d2shareType").value),o=!1;8==i?meshserver.send({action:"createDeviceShareLink",nodeid:currentNode._id,guestname:Q("d2inviteName").value.trim(),p:8,expire:parseInt(Q("d2inviteExpire").value),port:parseInt(Q("d2httpPort").value),consent:0}):9==i?meshserver.send({action:"createDeviceShareLink",nodeid:currentNode._id,guestname:Q("d2inviteName").value.trim(),p:16,expire:parseInt(Q("d2inviteExpire").value),port:parseInt(Q("d2httpsPort").value),consent:0}):(3==i&&(o=!0),1&(i=[0,1,2,2,4,6,5,7][i])&&(n|=2,1&currentNode.agent.caps&&1==Q("d2userConsent").value&&(n|=16),1&currentNode.agent.caps)&&2==Q("d2userConsent").value&&(n=0),2&i&&(n|=65,1&currentNode.agent.caps&&1==Q("d2userConsent").value&&(n|=8),1&currentNode.agent.caps)&&2==Q("d2userConsent").value&&(n=0),4&i&&(n|=4,1&currentNode.agent.caps&&1==Q("d2userConsent").value&&(n|=32),1&currentNode.agent.caps)&&2==Q("d2userConsent").value&&(n=0),0==Q("d2timeRange").value?meshserver.send({action:"createDeviceShareLink",nodeid:currentNode._id,guestname:Q("d2inviteName").value.trim(),p:i,expire:parseInt(Q("d2inviteExpire").value),consent:n,viewOnly:o}):1==Q("d2timeRange").value?meshserver.send({action:"createDeviceShareLink",nodeid:currentNode._id,guestname:Q("d2inviteName").value.trim(),p:i,start:Math.floor(t.range.selectedDates[0].getTime()/1e3),end:Math.floor(t.range.selectedDates[1].getTime()/1e3),consent:n,viewOnly:o}):meshserver.send({action:"createDeviceShareLink",nodeid:currentNode._id,guestname:Q("d2inviteName").value.trim(),p:i,start:Math.floor(t.start.selectedDates[0].getTime()/1e3),expire:parseInt(Q("d2inviteDuration").value),recurring:Q("d2timeRange").value-1,consent:n,viewOnly:o}))}function deviceActionFunction(){var e,t,n,i,o;xxdialogMode||(e=GetNodeRights(currentNode),t=0,n="选择要在此设备上执行的操作。<br /><br />",i="<select id=d2deviceop style=float:right;width:250px onchange=deviceActionFunctionValidate()>",o="",null!=currentNode.agent&&14==currentNode.agent.id?0!=(1&currentNode.conn)&&0!=(8&e)&&(t++,i+="<option value=400>闪光</option><option value=401>颤动</option>",o+="<div id=d2devicetimediv>"+addHtmlValue("时间","<select id=d2devicetime style=float:right;width:250px><option value=1000>1秒</option><option value=5000>5秒</option><option value=10000>10 秒</option></select>")+"</div>"):(0!=(64&e)&&(t++,i+="<option value=100>唤醒</option>"),0!=(1&currentNode.conn)&&0!=(131072&e)&&(t++,i+="<option value=106>运行命令</option>"),0!=currentNode.conn&&0!=(262144&e)&&(t++,i+="<option value=4>休眠</option><option value=3>重设</option><option value=2>关机</option>"),0!=(16&currentNode.conn)&&(t++,i+="<option value=103>发送MQTT消息</option>"),null!=currentNode.intelamt&&2==currentNode.intelamt.state&&0!=(6&currentNode.conn)&&0!=(262144&e)&&(t++,i+="<option value=310>英特尔&reg; AMT 重置</option><option value=308>英特尔&reg; AMT 关机</option>",11!=xxcurrentView&&12!=xxcurrentView||(i+="<option value=312>Intel&reg; AMT Reset to BIOS</option><option value=311>Intel&reg; AMT Power on to BIOS</option><option value=315>Intel&reg; AMT Power on to PXE</option><option value=316>Intel&reg; AMT Reset to PXE</option>")),null!=currentNode.intelamt&&2==currentNode.intelamt.state&&0!=(6&currentNode.conn)&&0!=(64&e)&&(t++,i+="<option value=302>英特尔&reg; AMT 开机</option>"),(11==xxcurrentView||12==xxcurrentView)&&15<=getNodeAmtVersion(currentNode)&&2==currentNode.intelamt.state&&0!=(6&currentNode.conn)&&4294967295==e&&0==(1024&features)&&(t++,i+="<option value=107>英特尔&reg; AMT 一键恢复</option>"),0!=(1&currentNode.conn)&&0!=(32768&e)&&(t++,i+="<option value=104>卸载代理</option>")),n+=addHtmlValue("运作",i+="</select>"),setDialogMode(2,"设备指令",0==t?2:3,deviceActionFunctionEx,(n=0==t?"该设备当前无可用操作。":n)+o),0<t&&deviceActionFunctionValidate())}function deviceActionFunctionValidate(){var e=Q("d2deviceop").value;try{QV("d2devicetimediv",400==e||401==e)}catch(e){}}function deviceActionFunctionEx(){var e,t,n,i=Q("d2deviceop").value;100==i?meshserver.send({action:"wakedevices",nodeids:[currentNode._id]}):103==i?p10showSendMqttMsgDialog([currentNode._id]):104==i?p10showSendUninstallAgentDialog([currentNode._id]):106==i?(t=e=!1,currentNode.agent&&(0<currentNode.agent.id&&currentNode.agent.id<5?e=!0:t=!0),1!=e&&1!=t||(n="在所选设备上运行命令。<br />",1==e&&(n+="<select id=d2cmdtype style=width:100%;margin-bottom:4px;margin-top:4px><option value=1>Windows命令提示</option><option value=2>Windows PowerShell</option>",1==t&&(n+="<option value=3>Linux / BSD / macOS命令外壳</option>"),n+="</select>"),setDialogMode(2,"运行命令",3,deviceRunCmdsFunctionEx,n=n+"<select id=d2cmduser style=width:100%;margin-bottom:4px><option value=0>以代理身份运行</option><option value=1>以用户身份运行，如果没有用户，则运行代理</option><option value=2>必须以用户身份运行</option></select>"+"<textarea id=d2runcmd style=background-color:#fcf3cf;width:100%;height:200px;resize:none;overflow-y:scroll></textarea>"),Q("d2runcmd").focus())):107==i?(Q("d3localmodeform").action="oneclickrecovery.ashx",Q("d3auth").value=authCookie,Q("d3filter").value=".efi",Q("d3attrib").value=currentNode._id,setDialogMode(3,"英特尔&reg; AMT 一键恢复",3,deviceActionOneClickRecovery),d3init()):302==i?setDialogMode(2,"英特尔&reg; AMT 电源操作",3,function(){meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:parseInt(i)})},"执行英特尔&reg; AMT 电源？"):308==i?setDialogMode(2,"英特尔&reg; AMT 电源操作",3,function(){meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:parseInt(i)})},"Perform Intel&reg; AMT power off?<br><br><b>NOTE: If there is an active AMT session, then power off command will be rejected, so you must disconnect from the AMT session first!</b>"):310==i?setDialogMode(2,"英特尔&reg; AMT 电源操作",3,function(){meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:parseInt(i)})},"执行英特尔&reg; AMT 重置？"):311==i?setDialogMode(2,"英特尔&reg; AMT 电源操作",3,function(){meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:parseInt(i)+(12==xxcurrentView?2:0)})},"Perform Intel&reg; AMT power on to BIOS?"):312==i?setDialogMode(2,"英特尔&reg; AMT 电源操作",3,function(){meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:parseInt(i)+(12==xxcurrentView?2:0)})},"Perform Intel&reg; AMT reset to BIOS?"):315==i?setDialogMode(2,"英特尔&reg; AMT 电源操作",3,function(){meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:parseInt(i)+(12==xxcurrentView?2:0)})},"Perform Intel&reg; AMT power on to PXE?"):316==i?setDialogMode(2,"英特尔&reg; AMT 电源操作",3,function(){meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:parseInt(i)+(12==xxcurrentView?2:0)})},"Perform Intel&reg; AMT reset to PXE?"):400==i||401==i?meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:parseInt(i),time:parseInt(Q("d2devicetime").value)}):meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:parseInt(i)})}function deviceActionOneClickRecovery(){var e;1==Q("d3uploadMode").value?Q("d3submit").click():1==(e=d3getFileSel()).length&&meshserver.send({action:"oneclickrecovery",nodeids:[Q("d3attrib").value],type:"diskimage",path:d3filetreelocation.join("/")+"/"+e[0]})}function deviceRunCmdsFunctionEx(){var e=3;try{e=parseInt(Q("d2cmdtype").value)}catch(e){}meshserver.send({action:"runcommands",nodeids:[currentNode._id],type:e,cmds:Q("d2runcmd").value,runAsUser:parseInt(Q("d2cmduser").value)})}function updateAmtCredentials(e){var t=getNodeFromId(currentNode._id);1==e||null==t.intelamt.user||""==t.intelamt.user?editDeviceAmtSettings(currentNode._id,updateAmtCredentialsEx):Q("p14iframe").contentWindow.connectButtonfunctionEx()}function updateAmtCredentialsEx(e,t){Q("p14iframe").contentWindow.connectButtonfunctionEx()}function updateDeviceTimeline(){2==meshserver.State&&null!=powerTimelineNode&&null!=powerTimelineUpdate&&null!=currentNode&&3!=currentNode.mtype&&powerTimelineNode==powerTimelineReq&&currentNode._id==powerTimelineNode&&powerTimelineUpdate<Date.now()&&(powerTimelineUpdate=null,meshserver.send({action:"powertimeline",nodeid:currentNode._id}),meshserver.send({action:"lastconnect",nodeid:currentNode._id}))}function drawDeviceTimeline(){if(!(null==currentNode||xxcurrentView<10||19<xxcurrentView||3==currentNode.mtype||"true"===hidePowerTimeline)){var e=null,t=Date.now(),n=(currentNode._id==powerTimelineNode&&(e=powerTimeline),new Date),i=(n.setHours(0,0,0,0),(n=new Date(n.getTime()-5184e5)).getTime(),[]);if(null!=e&&1<e.length){i.push([0,e[1],e[0]]);for(var o=e[1],s=2;s<e.length;s+=2){var a=e[s],r=t;e.length>s+1&&(r=e[s+1]),i.push([o,o+r,a]),o+=r}}var l="",d=1,c=new Date,u=Q("column_l").offsetWidth-192;c.setHours(0,0,0,0);for(s=0;s<7;s++){var p,m="",g=c.getTime(),h=g+864e5;for(p in i){var v,f,k,x=i[p];1==isTimeBlockInside(g,h,x[0],x[1])&&(k=Math.max(g,x[0]),v=Math.min(Math.min(h,x[1]),t),0<(f=Math.round((v-k)*u/864e5)))&&(k=format("{0} 从 {1} 到 {2}。",powerStateStrings2[x[2]],printTime(new Date(k)),printTime(new Date(v))),m+='<div class="pwState '+powerColor(x[2])+'" title="'+k+'" style="width:'+f+'px;"></div>')}l+="<tr class="+(d%2==0?"altBack":"")+"><td><div>&nbsp;"+printDate(c)+"<div></div></div></td><td><div>"+m+"</div></td></tr>",++d,c=new Date(c.getFullYear(),c.getMonth(),c.getDate()-1)}n="";try{n="&tz="+encodeURIComponentEx(Intl.DateTimeFormat().resolvedOptions().timeZone)}catch(e){}QH("p10html2",'<table cellpadding=2 cellspacing=0><thead><tr style=><th scope=col style=text-align:center;width:150px>天</th><th scope=col style=text-align:center><a onclick=downloadFile("devicepowerevents.ashx?id='+currentNode._id+"&tf="+(new Date).getTimezoneOffset()+"&l="+encodeURIComponentEx(getLang())+n+(urlargs.key?"&key="+urlargs.key:"")+'",null,true)><img title="下载电源事件" src="images/link4.png" /></a>7天电源状态</th></tr></thead><tbody>'+l+"</tbody></table>")}}function powerColor(e){return e<powerColorTable.length?powerColorTable[e]:"pwsYellow"}function isTimeBlockInside(e,t,n,i){return n<e&&t<i||e<n&&n<t||e<i&&i<t}function addDeviceAttribute(e,t){return"<tr><td class=style7>"+e+"</td><td class=style9>"+t+"</td></tr>"}function editDeviceAmtSettings(e,t,n){var i,o;xxdialogMode||(i="",o=3,0!=(4&GetNodeRights(e=getNodeFromId(e)))&&(i=(i+=addHtmlValue("用户名",'<input id=dp10username style=width:230px maxlength=32 autocomplete=nope placeholder="admin" onchange=validateDeviceAmtSettings() onkeyup=validateDeviceAmtSettings() />'))+addHtmlValue("密码","<input id=dp10password type=password style=width:230px autocomplete=nope maxlength=32 onchange=validateDeviceAmtSettings() onkeyup=validateDeviceAmtSettings() />"),0==(1&features2)&&(i+=addHtmlValue("安全","<select id=dp10tls style=width:236px><option value=0>没有TLS加密</option><option value=1>需要TLS加密</option></select>")),setDialogMode(2,"编辑英特尔&reg;AMT凭证",o=null!=e.intelamt.user&&""!=e.intelamt.user?7:o,editDeviceAmtSettingsEx,i,{node:e,func:t,arg:n}),null!=e.intelamt.user&&""!=e.intelamt.user?Q("dp10username").value=e.intelamt.user:Q("dp10username").value="admin",0==(1&features2)&&(Q("dp10tls").value=e.intelamt.tls),validateDeviceAmtSettings()))}function validateDeviceAmtSettings(){QE("idx_dlgOkButton",passwordcheck(Q("dp10password").value))}function editDeviceAmtSettingsEx(e,t){var n;2==e?meshserver.send({action:"changedevice",nodeid:t.node._id,intelamt:{user:"",pass:""}}):(""==(e=Q("dp10username").value)&&(e="admin"),n=Q("dp10password").value,e={action:"changedevice",nodeid:t.node._id,intelamt:{user:e=""==n?"":e,pass:n}},0==(1&features2)&&(e.intelamt.tls=parseInt(Q("dp10tls").value)),meshserver.send(e),t.func&&setTimeout(function(){t.func(null,t.arg)},1e3))}function p10showSendMqttMsgDialog(e){var t;return xxdialogMode||(t=addHtmlValue("主题","<input id=dp2topic style=width:230px maxlength=64 onchange=p10validateSendMqttMsgDialog() onkeyup=p10validateSendMqttMsgDialog(event,1) />"),setDialogMode(2,"发送MQTT消息",3,p10showSendMqttMsgDialogEx,t+=addHtmlValue("消息","<div style=width:230px;margin:0;padding:0><textarea id=dp2msg maxlength=4096 style=width:100%;height:150px;resize:none onchange=p10validateSendMqttMsgDialog() onkeyup=p10validateSendMqttMsgDialog(event,1)></textarea></div>"),e),p10validateSendMqttMsgDialog(),Q("dp2topic").focus()),!1}function p10validateSendMqttMsgDialog(){QE("idx_dlgOkButton",0<Q("dp2topic").value.length&&0<Q("dp2msg").value.length)}function p10showSendMqttMsgDialogEx(e,t){meshserver.send({action:"sendmqttmsg",nodeids:t,topic:Q("dp2topic").value,msg:Q("dp2msg").value}),uncheckAllDevices()}function p10showSendUninstallAgentDialog(e){var t;return xxdialogMode||(t="",t=1<e.length?format("您确定要卸载所选的{0}代理吗？",e.length):"您确定要卸载所选代理吗？",setDialogMode(2,"卸载代理",3,p10showSendUninstallAgentDialogEx,t=(t+="<br /><br />")+"这不会从服务器上删除该设备，但是该设备将不再能够连接到服务器。该设备的所有远程访问都将丢失。该设备必须连线，此命令才能起作用。"+"<br /><br /><label style=color:red><input id=p10check type=checkbox onchange=p10validateDeleteNodeDialog() />确认</label>",e),p10validateSendUninstallAgentDialog()),!1}function p10validateSendUninstallAgentDialog(){QE("idx_dlgOkButton",Q("p10check").checked)}function p10showSendUninstallAgentDialogEx(e,t){meshserver.send({action:"uninstallagent",nodeids:t}),uncheckAllDevices()}function p10showChangeGroupDialog(e){if(!xxdialogMode){var t=null;if(1==e.length)try{t=meshes[getNodeFromId(e[0]).meshid]._id}catch(e){}var n,i,o="<select id=p10newGroup style=width:236px>",s=0,a=[];for(n in meshes){var r=GetMeshRights(n);meshes[n]._id!=t&&4&r&&a.push(meshes[n])}for(n in a.sort(nameSort),a)s++,o+="<option value='"+a[n]._id+"'>"+a[n].name+"</option>";o+="</select>",0<s?(i=1==e.length?"选择此设备的新组<br /><br />":"为所选设备选择一个新组<br /><br />",setDialogMode(2,"更改组",3,p10showChangeGroupDialogEx,i+=addHtmlValue("新设备组",o),e)):setDialogMode(2,"更改组",1,null,"没有其他相同类型的设备组。")}return!1}function p10showChangeGroupDialogEx(e,t){meshserver.send({action:"changeDeviceMesh",nodeids:t,meshid:Q("p10newGroup").value}),uncheckAllDevices()}function p10showDeleteNodeDialog(e){return xxdialogMode||(setDialogMode(2,"删除节点",3,p10showDeleteNodeDialogEx,format("您确定要删除节点{0}吗？",EscapeHtml(currentNode.name))+"<br /><br /><label><input id=p10check type=checkbox onchange=p10validateDeleteNodeDialog() />确认</label>",e),p10validateDeleteNodeDialog()),!1}function p10validateDeleteNodeDialog(){QE("idx_dlgOkButton",Q("p10check").checked)}function p10showDeleteNodeDialogEx(e,t){meshserver.send({action:"removedevices",nodeids:[t]})}function p10WebRouter(e,t,n,i){var o=null,s=getNodeFromId(e),a=(3==s.mtype&&(a=meshes[s.meshid])&&a.relayid&&(o=a.relayid,i=s.host),serverinfo.name),s=(-1!=a.indexOf(".")&&0==(2&features)||(a=window.location.hostname),"https://"+(a=""!=webRelayDns?webRelayDns:a)+":"+webRelayPort+"/control-redirect.ashx?n="+e+"&p="+n+"&appid="+t+"&c="+authRelayCookie);return null!=i&&(s+="&addr="+i),null!=o&&(s+="&relayid="+o),safeNewWindow(s,"WebRelay"),!1}function p10MCRouter(e,t,n,i,o){var s=getNodeFromId(e),a=meshes[s.meshid];return 3==t&&null==n&&(n=null!=s.rdpport?s.rdpport:3389),3==s.mtype&&a&&a.relayid&&(e=a.relayid,i=s.host),meshserver.send({action:"getcookie",nodeid:e,tcpport:n,ip:i,tag:"MCRouter",protocol:t,localport:o,name:a?a.name:null}),!1}function p10rfb(e,t){var n=getNodeFromId(e),i=null,o=meshes[n.meshid];null==t&&(t=null!=n.rfbport?n.rfbport:5900),3==n.mtype&&o&&o.relayid&&(e=o.relayid,i=n.host),meshserver.send({action:"getcookie",nodeid:e,tcpport:t,tcpaddr:i,tag:"novnc",name:o?o.name:null})}function p10mstsc(e,t){var n=getNodeFromId(e),i=meshes[n.meshid];null==t&&(t=null!=n.rdpport?n.rdpport:3389),meshserver.send({action:"getcookie",nodeid:e,tcpport:t,tag:"mstsc",name:i?i.name:null})}function p10ssh(e,t){var n=getNodeFromId(e),i=meshes[n.meshid];null==t&&(t=null!=n.sshport?n.sshport:22),meshserver.send({action:"getcookie",nodeid:e,tcpport:t,tag:"ssh",name:i?i.name:null})}var d2map=null;function p10showNodeLocationDialog(){if(null!=xxdialogMode&&"@xxmap"==xxdialogTag)setDialogMode(0);else if(xxdialogMode)return!1;var e,t,n,i,o=[],s=["iploc","wifiloc","gpsloc","userloc"],a=null;for(e in s)null!=currentNode[s[e]]&&(n=currentNode[s[e]].split(","),t=parseFloat(n[0]),n=parseFloat(n[1]),t<90)&&-90<t&&n<180&&-180<n&&((i=new ol.Feature({geometry:new ol.geom.Point(ol.proj.fromLonLat([n,t]))})).setStyle(markerStyle(currentNode,parseInt(e)+1)),o.push(i),null==a?a=[t,n,t,n,0]:(t<a[0]&&(a[0]=t),n<a[1]&&(a[1]=n),t>a[2]&&(a[2]=t),n>a[3]&&(a[3]=n)));var r=new ol.source.Vector({features:o}),r=new ol.layer.Vector({source:r}),l=(setDialogMode(2,"设备位置",1,null,"<div id=d2map style=width:100%;height:300px></div>","@xxmap"),0),d=0,c=8;if(null!=a)for(var d=(a[0]+a[2])/2,l=(a[1]+a[3])/2,u=Math.max(Math.abs(a[0]-a[2]),Math.abs(a[1]-a[3])),p=360,c=-2;u<p;)c++,p/=2;return 1==o.length&&(c=8),d2map=new ol.Map({target:"d2map",interactions:ol.interaction.defaults({dragPan:!1,mouseWheelZoom:!1}),layers:[new ol.layer.Tile({source:new ol.source.OSM}),r],view:new ol.View({center:ol.proj.fromLonLat([l,d]),zoom:c})}),!1}function p10showNodeNetInfoDialog(){return xxdialogMode||(setDialogMode(2,"网络接口",1,null,"<div id=d2netinfo>载入中...</div>","if"+currentNode._id),meshserver.send({action:"getnetworkinfo",nodeid:currentNode._id})),!1}function p10showMeshRouterDialog(){var e,t;xxdialogMode||(e="<div>MeshCentral 路由器是Windows工具，用于TCP端口映射。例如，您可以通过该服务器将RDP放入远程设备。</div><br />",e=(e+=addHtmlValue("Win32可执行文件",'<a style=cursor:pointer onclick=downloadFile("meshagents?meshaction=winrouter'+(urlargs.key?"&key="+urlargs.key:"")+'",null,true)>MeshCentralRouter.exe</a>'))+addHtmlValue("MacOS 安装程序",'<a style=cursor:pointer onclick=downloadFile("meshagents?meshaction=macrouter'+(urlargs.key?"&key="+urlargs.key:"")+'",null,true)>MeshCentralRouter.dmg</a>'),-1!=(t=serverinfo.name).indexOf(".")&&0==(2&features)||(t=window.location.hostname),domainUrl.substring(0,domainUrl.length-1),setDialogMode(2,"MeshCentral路由器",1,null,e=(e+="<br /><div>运行MeshCentral Router，然后单击“安装”以使其可从浏览器启动。</div>")+('<br /><a style=cursor:pointer target="mcrouterframe" rel="noreferrer noopener" href="'+("mcrouter://"+t+(443==serverinfo.port?"":":"+serverinfo.port)+domainUrl+"control.ashx?c="+authCookie+"&t="+serverinfo.tlshash+"&l={{{lang}}}"+(urlargs.key?"&key="+urlargs.key:""))+'"><input type=button style=width:100%;cursor:pointer value="启动MeshCentral路由器" /></a>')+'<iframe style=display:none name="mcrouterframe"></iframe>',"fileDownload"))}function p10showMqttLoginDialog(e){meshserver.send({action:"getmqttlogin",nodeid:e})}function p10openxterm(e,t){haltEvent(e);var e="/xterm?nodeid="+encodeURIComponentEx(t)+"&auto=1",n=getNodeFromId(t);if(null!=n)return 0<=[1,2,3,4,21,22].indexOf(n.agent.id)?e+="&os=win":e+="&os=linux",urlargs.key&&(e+="&key="+urlargs.key),safeNewWindow(e,"xterm:"+t),!1}function p10showMeshCmdDialog(e,t){var n;xxdialogMode||(n="",0==e&&(n+="<div>MeshCmd是一个可以执行许多不同操作的命令行工具。可以选择下载和编辑操作档案以提供服务器信息和凭据。<br /><br />"),1==e&&(n+="<div>下载带有指令档案的“ meshcmd”，以通过此服务器将网络讯息发送到该设备。紧记编辑meshaction.txt并添加您的帐户密码或进行任何必要的更改。<br /><br />"),n=(n+=addHtmlValue("操作系统","<select id=aginsSelect onchange=meshCmdOsClick() style=width:236px><option value=4>Windows x86 (64bit)</option><option value=3>Windows x86 (32bit)</option><option value=43>Windows ARM (64bit)</option><option value=6>Linux x86（64位）</option><option value=5>Linux x86（32位）</option><option value=16>macOS x86 (64位)</option><option value=29>macOS ARM (64位)</option><option value=25>Linux ARM，Raspberry Pi（32位）</option><option value=26>Linux ARM, Raspberry Pi (64位)</option></select>"))+addHtmlValue("MeshCmd",'<a id=meshcmddownloadid onclick=downloadFile("meshagents?meshcmd=3'+(urlargs.key?"&key="+urlargs.key:"")+'")></a>'),0==e&&(n+=addHtmlValue("动作档案",'<a onclick=downloadFile("meshagents?meshaction=generic'+(urlargs.key?"&key="+urlargs.key:"")+'")>MeshAction（.txt）</a>')),1==e&&(n+=addHtmlValue("动作档案",'<a onclick=downloadFile("meshagents?meshaction=route&nodeid='+t+(urlargs.key?"&key="+urlargs.key:"")+'")>MeshAction（.txt）</a>')),setDialogMode(2,"下载MeshCmd",9,null,n+="</div>","fileDownload"),meshCmdOsClick())}function meshCmdOsClick(){var e=Q("aginsSelect").value,t="";3==e&&(t="MeshCmd (Win x86-32 executable)"),4==e&&(t="MeshCmd (Win x86-64 executable)"),43==e&&(t="MeshCmd (Win ARM-64 executable)"),5==e&&(t="MeshCmd（Linux x86，32bit）"),6==e&&(t="MeshCmd（Linux x86，64位）"),16==e&&(t="MeshCmd（macOS，x86-ARM-64位）"),29==e&&(t="MeshCmd（macOS，ARM-64位）"),25==e&&(t="MeshCmd（Linux ARM，32位）"),26==e&&(t="MeshCmd（Linux ARM，64位）"),QH("meshcmddownloadid",t),Q("meshcmddownloadid").onclick=function(){downloadFile("meshagents?meshcmd="+e+(urlargs.key?"&key="+urlargs.key:""))}}function p10showiconselector(){xxdialogMode||0!=(4&GetNodeRights(currentNode))&&(setDialogMode(2,"图标选择",0,null,'<div style=text-align:center><br /><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i1 onclick=p10setIcon(1) onkeypress="if (event.key==\'Enter\') p10setIcon(1)"></div><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i2 onclick=p10setIcon(2) onkeypress="if (event.key==\'Enter\') p10setIcon(2)"></div><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i3 onclick=p10setIcon(3) onkeypress="if (event.key==\'Enter\') p10setIcon(3)"></div><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i4 onclick=p10setIcon(4) onkeypress="if (event.key==\'Enter\') p10setIcon(4)"></div><br /><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i5 onclick=p10setIcon(5) onkeypress="if (event.key==\'Enter\') p10setIcon(5)"></div><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i6 onclick=p10setIcon(6) onkeypress="if (event.key==\'Enter\') p10setIcon(6)"></div><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i7 onclick=p10setIcon(7) onkeypress="if (event.key==\'Enter\') p10setIcon(7)"></div><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i8 onclick=p10setIcon(8) onkeypress="if (event.key==\'Enter\') p10setIcon(8)"></div><br /><br /></div>'),QV("id_dialogclose",!0))}function p10setIcon(e){setDialogMode(0),meshserver.send({action:"changedevice",nodeid:currentNode._id,icon:e})}function showClearSshDialog(){setDialogMode(2,"编辑设备",3,showClearSshDialogEx,"清除 SSH 凭据？")}function showClearSshDialogEx(e,t){meshserver.send({action:"changedevice",nodeid:currentNode._id,ssh:0})}function showClearRdpDialog(){setDialogMode(2,"编辑设备",3,showClearRdpDialogEx,"清除 RDP 凭据？")}function showClearRdpDialogEx(e,t){meshserver.send({action:"changedevice",nodeid:currentNode._id,rdp:0})}var desktopNode,showEditNodeValueDialog_modes=["设备名称","主机名","描述","标签"],showEditNodeValueDialog_modes2=["name","host","desc","tags"],showEditNodeValueDialog_modes3=["","","","标签1，标签2，标签3"],showEditNodeValueDialog_modes4=[64,64,64,4096];function showEditNodeValueDialog(e){if(!xxdialogMode){var t=addHtmlValue(showEditNodeValueDialog_modes[e],"<input id=dp10devicevalue maxlength="+showEditNodeValueDialog_modes4[e]+' placeholder="'+showEditNodeValueDialog_modes3[e]+'" onchange=p10editdevicevalueValidate('+e+",event) onkeyup=p10editdevicevalueValidate("+e+",event) />");if(3==e){var n=[],i="";for(s in nodes)if(nodes[s].tags)for(var o in nodes[s].tags)-1==n.indexOf(nodes[s].tags[o])&&n.push(nodes[s].tags[o]);if(0<n.length){for(var s in n.sort(),n)i+='<span style=padding:4px;background-color:#BBB;border-radius:3px;cursor:pointer onclick=showEditNodeValueDialogAddTag("'+encodeURIComponentEx(n[s])+'")>'+EscapeHtml(n[s])+"</span> ";t+="<div style=margin-top:8px;width:370px;line-height:26px;max-height:160px;overflow-y:auto>"+i+"</div>"}}setDialogMode(2,"编辑设备",3,showEditNodeValueDialogEx,t,e);t=currentNode[showEditNodeValueDialog_modes2[e]];null==t&&(t=""),Array.isArray(t)&&(t=t.join(", ")),Q("dp10devicevalue").value=t,p10editdevicevalueValidate(),Q("dp10devicevalue").focus()}}function showEditNodeValueDialogAddTag(e){var t,n=Q("dp10devicevalue").value.split(","),i=[];for(t in n)i.push(n[t].trim());0<=i.indexOf(e)||(Q("dp10devicevalue").value+=(0==Q("dp10devicevalue").value.length?"":", ")+decodeURIComponent(e),setTimeout(function(){Q("dp10devicevalue").selectionStart=Q("dp10devicevalue").selectionEnd=9e4},0),p10editdevicevalueValidate())}function showEditNodeValueDialogEx(e,t){var n={action:"changedevice",nodeid:currentNode._id};n[showEditNodeValueDialog_modes2[t]]=Q("dp10devicevalue").value,meshserver.send(n)}function p10editdevicevalueValidate(e,t){e=1<e||0<Q("dp10devicevalue").value.length;QE("idx_dlgOkButton",e),null!=t&&1==e&&13==t.keyCode&&dialogclose(1)}function setupDesktop(){var e,t;desktopNode!=currentNode&&null!=desktop&&desktopNode._id!=currentNode._id&&(desktop.Stop(),desktop=desktopNode=null),desktopNode==currentNode&&null!=desktop||(null!=(e=multiDesktop[currentNode._id])?(QH("DeskParent",""),(t=e.m.CanvasId).setAttribute("id","Desk"),t.setAttribute("onmousedown","dmousedown(event)"),t.setAttribute("onmouseup","dmouseup(event)"),t.setAttribute("onmousemove","dmousemove(event)"),t.removeAttribute("onclick"),Q("DeskParent").appendChild(t),(desktop=e).m.SendCompressionLevel&&desktop.m.SendCompressionLevel(desktopsettings.agentencoding,desktopsettings.quality,desktopsettings.scaling,desktopsettings.framerate),desktop.onStateChanged=onDesktopStateChange,desktop.onMetadataChange=function(e){updateMetadata(desktop,"deskmetadata")},0!=(8192&features2)&&(desktop.m.stopInput=!0),desktop&&desktop.m.mouseCursorActive&&desktop.m.mouseCursorActive(!0),QV("DeskInputLockedButton",1==desktop.m.RemoteInputLock),QV("DeskInputUnLockedButton",0==desktop.m.RemoteInputLock),desktop.m.onRemoteInputLockChanged=function(e,t){QV("DeskInputLockedButton",t),QV("DeskInputUnLockedButton",!t)},desktop.m.onKeyboardStateChanged=function(e,t){QS("p11numlock").display=1&t?"inline-block":"none",QS("p11scrolllock").display=2&t?"inline-block":"none",QS("p11capslock").display=4&t?"inline-block":"none"},desktopNode=currentNode,onDesktopStateChange(desktop,desktop.State),delete multiDesktop[currentNode._id]):(null==desktop&&QH("DeskParent",'<canvas id=Desk oncontextmenu="return false" onmousedown=dmousedown(event) onmouseup=dmouseup(event) onmousemove=dmousemove(event)></canvas>'),desktopNode=currentNode),Q("Desk").addEventListener("DOMMouseScroll",function(e){return dmousewheel(e)}),Q("Desk").addEventListener("mousewheel",function(e){return dmousewheel(e)})),desktopNode=currentNode,desktop&&(desktop.m.onDisplayinfo=deskDisplayInfo)(desktop.m,desktop.m.displays,desktop.m.selectedDisplay),updateDesktopButtons(),deskAdjust(),updateMetadata(desktop,"deskmetadata")}function updateDesktopButtons(){var e=0,t=(null!=desktop&&(e=desktop.State),GetNodeRights(currentNode)),n=1==currentNode.agent?1:2,n=(QV("disconnectbutton1span",0!=e),QV("connectbutton1span",0==e&&(8&t||256&t)&&null!=currentNode.agent&&1&currentNode.agent.caps),QV("connectbutton1rspan",0==(1073741824&features)&&0==e&&8&t&&null!=currentNode.agent&&(3==currentNode.agent.id||4==currentNode.agent.id)),1==n?QV("connectbutton1hspan",0==e&&8&t&&null!=currentNode.intelamt&&2==currentNode.intelamt.state):QV("connectbutton1hspan",0==e&&8&t&&null!=currentNode.intelamt&&2==currentNode.intelamt.state&&null!=currentNode.intelamt.ver&&(null==currentNode.intelamt.sku||"number"==typeof currentNode.intelamt.sku&&0!=(8&currentNode.intelamt.sku))),QV("td7amtkvm",!(null==currentNode.intelamt||"number"==typeof currentNode.intelamt.sku&&0!=(16&currentNode.intelamt.sku)||null==currentNode.intelamt.ver&&null!=currentNode.agent||0!=e&&2!=desktop.contype)),QV("td7meshkvm",webRtcDesktop||null!=currentNode.agent&&1&currentNode.agent.caps&&(0==e||1==desktop.contype)),QV("td7rdpkvm",!(null==currentNode.agent||3!=currentNode.agent.id&&4!=currentNode.agent.id||0!=e&&4!=desktop.contype)),0==(8192&features2)&&(null==currentNode.agent||14!=currentNode.agent.id)&&(4294967295==t||0!=(8&t)&&0==(256&t)&&0==(4096&t))),i=0!=(1&currentNode.conn),o=(QE("connectbutton1",i),QE("connectbutton1r",i||3==currentNode.mtype),currentNode.rdpport&&3389!=currentNode.rdpport?QH("desktopCustomUpperRight",'<a style="cursor:pointer;line-height:22px" onclick="cmaltportaction(1,event)">'+format("RDP Port {0}",currentNode.rdpport||3389)+"</a>"):QH("desktopCustomUpperRight",""),0!=(6&currentNode.conn)),o=(QE("connectbutton1h",o),QV("deskFocusBtn",null!=desktop&&2==desktop.contype&&0!=e&&desktopsettings.showfocus),QE("DeskClip",3==e),QV("DeskClip",n&&currentNode.agent&&6144!=(6144&features2)&&11!=currentNode.agent.id&&16!=currentNode.agent.id&&(null==desktop||2!=desktop.contype)&&(1!=desktopsettings.autoclipboard||null==navigator.clipboard||null==navigator.clipboard.readText)),QE("DeskESC",3==e&&4!=desktop.contype),QV("DeskESC",browserfullscreen&&n),QE("DeskType",3==e),QV("DeskType",n),QE("DeskWD",3==e),QV("DeskWD",n),QV("deskkeys",n),QE("deskkeys",null!=desktop),QV("DeskTimer",3==e),QV("DeskLatency",3==e),QS("DeskLatency").display=3==e?"inline-block":"none",desktop&&4==desktop.contype?desktopsettings.rdpautoclipboard:desktopsettings.autoclipboard);QV("DeskClipboardOutButton",i&&n&&null!=desktop&&0==(4096&features2)&&null!=navigator.clipboard&&null!=navigator.clipboard.readText&&(1!=o||null==navigator.clipboard||null==navigator.clipboard.readText)),QV("d7deskAutoClipboardLabel",null!=navigator.clipboard.readText&&0==(4096&features2)),QV("DeskClipboardInButton",i&&n&&null!=desktop&&0==(2048&features2)&&null!=navigator.clipboard&&null!=navigator.clipboard.writeText&&(1!=o||null==navigator.clipboard||null==navigator.clipboard.readText)),3!=e&&(QV("DeskInputLockedButton",!1),QV("DeskInputUnLockedButton",!1),QV("p11numlock",!1),QV("p11scrolllock",!1),QV("p11capslock",!1)),QV("DeskRunButton",0!=(131072&t)&&i),QV("DeskSaveImageButton",3==e&&null!=Q("Desk").toBlob&&0==(1024&features2)),QV("DeskRecordButton",3==e&&null!=Q("Desk").toBlob&&null!=desktop.m.StartRecording&&0==(1024&features2)),QV("DeskChatButton",0!=(16384&t)&&0==browserfullscreen&&currentNode.agent&&i),QV("DeskNotifyButton",0!=(16384&t)&&0==browserfullscreen&&currentNode.agent&&i),QV("DeskLockButton",0!=(16384&t)&&0==browserfullscreen&&currentNode.agent&&currentNode.agent.id<5&&n&&3==e),QV("DeskToolsButton",currentNode.agent&&i),QE("DeskToolsButton",n),QV("DeskOpenWebButton",0==browserfullscreen&&n&&currentNode.agent&&i),QV("DeskBackgroundButton",n&&3==e&&1==desktop.contype&&currentNode.agent&&11!=currentNode.agent.id&&16!=currentNode.agent.id&&i),QV("DeskControlSpan",n),QV("DeskRefreshButton",3==e&&1==desktop.contype),Q("DeskControl").checked=!!(8&t)&&1==getstore("DeskControl",1),QS("DeskControlSpan").color=Q("DeskControl").checked?null:"red",0==i&&QV("DeskTools",!1)}var autoConnectDesktopTimer=null;function autoConnectDesktop(e){autoConnectDesktopTimer=null==autoConnectDesktopTimer?setInterval(function(){connectDesktop(null,1)},1e3):(clearInterval(autoConnectDesktopTimer),null)}var agentConsoleMessages=["","正在等待用户授予访问权限...","被拒绝","无法启动远程终端接合{0}（{1}）","超时","收到无效的网络数据","无法捕捉显示","协议协商失败 ({0})","不支持 NLA","服务器需要 SSL","服务器不允许 SSL","SSL 证书不在服务器上","不一致的标志","服务器所需的混合","服务器需要具有用户身份验证的 SSL"];function formatAgentConsoleMessage(e,t,n){for(null==n&&(n=[]);n.length<3;)n.push("");return(t&&t<agentConsoleMessages.length?EscapeHtml(format(agentConsoleMessages[t],n[0],n[1],n[2])):EscapeHtml(e)).split("\n").join("<br />")+"<br /><br />"}function connectDesktop(e,t,n,i){xxdialogMode||(null!=e&&0!=e.shiftKey&&3==t&&(t=1),QV("p11DeskSessionSelector",!1),p11clearConsoleMsg(),null==desktop?(desktopNode=currentNode,2==t?null==desktopNode.intelamt.user||""==desktopNode.intelamt.user?editDeviceAmtSettings(desktopNode._id,connectDesktop,2):((desktop=CreateAmtRedirect(CreateAmtRemoteDesktop("Desk"),authCookie)).debugmode=debugmode,desktop.onStateChanged=onDesktopStateChange,desktop.m.bpp=1==desktopsettings.encoding||3==desktopsettings.encoding?1:2,desktop.m.useZRLE=desktopsettings.encoding<3,desktop.m.localKeyMap=desktopsettings.localkeymap,desktop.m.ReverseMouseWheel=desktopsettings.kvmrmw,desktop.m.showmouse=desktopsettings.showmouse,desktop.m.onScreenSizeChange=deskAdjust,desktop.m.onKvmData=function(e){if(0==e.length)desktop.m._sentPresence||(desktop.m._sentPresence=!0,desktop.m.sendKvmData(JSON.stringify({action:"present",ver:1})));else{var t=null;try{t=JSON.parse(e)}catch(e){}null!=t&&null!=t.action&&("restart"==t.action?(webRtcDesktopReset(),desktop.m.sendKvmData(JSON.stringify({action:"present",ver:1}))):"present"==t.action&&null==webRtcDesktop?(webRtcDesktop={platform:t.platform},"undefined"!=typeof RTCPeerConnection?webRtcDesktop.webrtc=new RTCPeerConnection(null):"undefined"!=typeof webkitRTCPeerConnection&&(webRtcDesktop.webrtc=new webkitRTCPeerConnection(null)),webRtcDesktop.webchannel=webRtcDesktop.webrtc.createDataChannel("数据通道",{}),webRtcDesktop.webchannel.onopen=function(){console.log("WebRTC Data Channel Open"),Q("deskstatus").textContent=StatusStrs[desktop.State]+"，软体KVM",desktop.m.hold(!0),webRtcDesktop.webRtcActive=!0,webRtcDesktop.softdesktop=CreateKvmDataChannel(webRtcDesktop.webchannel,CreateAgentRemoteDesktop("Desk",Q("id_mainarea")),desktop.m),webRtcDesktop.softdesktop.m.setRotation(desktop.m.rotation),webRtcDesktop.softdesktop.m.onScreenSizeChange=deskAdjust,webRtcDesktop.softdesktop.m.ImageType=webpSupport?4:1,desktopsettings.quality&&(webRtcDesktop.softdesktop.m.CompressionLevel=desktopsettings.quality),desktopsettings.scaling&&(webRtcDesktop.softdesktop.m.ScalingLevel=desktopsettings.scaling),webRtcDesktop.softdesktop.Start()},webRtcDesktop.webchannel.onclose=function(e){console.log("WebRTC Data Channel Closed"),webRtcDesktopReset()},webRtcDesktop.webrtc.onicecandidate=function(e){null==e.candidate?desktop.m.sendKvmData(JSON.stringify({action:"offer",ver:1,sdp:webRtcDesktop.webrtcoffer.sdp})):webRtcDesktop.webrtcoffer.sdp+="a="+e.candidate.candidate+"\r\n"},webRtcDesktop.webrtc.oniceconnectionstatechange=function(){null==webRtcDesktop||null==webRtcDesktop.webrtc||"disconnected"!=webRtcDesktop.webrtc.iceConnectionState&&"failed"!=webRtcDesktop.webrtc.iceConnectionState||webRtcDesktopReset()},webRtcDesktop.webrtc.createOffer(function(e){webRtcDesktop.webrtcoffer=e,webRtcDesktop.webrtc.setLocalDescription(e,function(){},webRtcDesktopReset)},webRtcDesktopReset,{mandatory:{OfferToReceiveAudio:!1,OfferToReceiveVideo:!1}})):"answer"==t.action&&null!=webRtcDesktop&&webRtcDesktop.webrtc.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:t.sdp}),function(){},webRtcDesktopReset))}},4==desktopNode.conn&&null!=desktopNode.intelamt&&1==desktopNode.intelamt.tls?desktop.Start(desktopNode._id,16995,"*","*",1):desktop.Start(desktopNode._id,16994,"*","*",0),desktop.contype=2):null==t||1==t||3==t&&4<currentNode.agent.id&&null==debugmode?((desktop=CreateAgentRedirect(meshserver,CreateAgentRemoteDesktop("Desk"),serverPublicNamePort,authCookie,authRelayCookie,domainUrl)).m.UseExtendedKeyFlag=desktopNode.agent.id<5,desktop.m.mouseCursorActive(11==xxcurrentView),desktop.debugmode=debugmode,desktop.m.debugmode=debugmode,desktop.attemptWebRTC=attemptWebRTC,desktop.webrtcconfig=webrtcconfiguration,desktop.options={},null!=n&&(desktop.options.tsid=n),null!=i&&(desktop.options.consent=i),1==desktopsettings.autolock&&(desktop.options.autolock=!0),desktop.onStateChanged=onDesktopStateChange,0!=(8192&features2)&&(desktop.m.stopInput=!0),desktop.m.onRemoteInputLockChanged=function(e,t){QV("DeskInputLockedButton",t),QV("DeskInputUnLockedButton",!t)},desktop.m.onKeyboardStateChanged=function(e,t){QS("p11numlock").display=1&t?"inline-block":"none",QS("p11scrolllock").display=2&t?"inline-block":"none",QS("p11capslock").display=4&t?"inline-block":"none"},desktop.onConsoleMessageChange=function(){desktop.consoleMessage?(Q("p11DeskConsoleMsg").innerHTML+=formatAgentConsoleMessage(desktop.consoleMessage,desktop.consoleMessageId,desktop.consoleMessageArgs),QV("p11DeskConsoleMsg",!0),null!=p11DeskConsoleMsgTimer&&clearTimeout(p11DeskConsoleMsgTimer),desktop.consoleMessageTimeout&&(p11DeskConsoleMsgTimer=setTimeout(p11clearConsoleMsg,1e3*desktop.consoleMessageTimeout))):p11clearConsoleMsg()},desktop.onMetadataChange=function(e){updateMetadata(desktop,"deskmetadata")},desktop.m.ImageType=desktopsettings.agentencoding,desktop.m.CompressionLevel=desktopsettings.quality,desktop.m.ScalingLevel=desktopsettings.scaling,desktopsettings.framerate&&(desktop.m.FrameRateTimer=desktopsettings.framerate),desktopsettings.swapmouse&&(desktop.m.SwapMouse=desktopsettings.swapmouse),desktopsettings.rmw&&(desktop.m.ReverseMouseWheel=desktopsettings.rmw),1==desktopsettings.remotekeymap&&(desktop.m.remoteKeyMap=desktopsettings.remotekeymap),desktop.m.onScreenSizeChange=deskAdjust,desktop.Start(desktopNode._id),desktop.latency.callback=function(e){updateSessionTime()},desktop.contype=1):3==t?meshserver.send({action:"msg",type:"userSessions",nodeid:currentNode._id,tag:i}):4==t&&((desktop=CreateRDPDesktop("Desk",domainUrl)).onStateChanged=onDesktopStateChange,desktop.m.onScreenSizeChange=mdeskAdjust,desktop.m.onClipboardChanged=function(e){null!=e&&desktopsettings.rdpautoclipboard&&null!=navigator.clipboard&&navigator.clipboard.writeText(e).then(function(){}).catch(function(e){console.log(e)})},desktopsettings.rdpsmb&&(desktop.m.SwapMouse=desktopsettings.rdpsmb),desktopsettings.rdprmw&&(desktop.m.ReverseMouseWheel=desktopsettings.rdprmw),desktop.Start(desktopNode._id,currentNode.rdpport||3389,n),desktop.contype=4,desktop.onConsoleMessageChange=function(){desktop.consoleMessage?(Q("p11DeskConsoleMsg").innerHTML+=formatAgentConsoleMessage(desktop.consoleMessage,desktop.consoleMessageId,desktop.consoleMessageArgs),QV("p11DeskConsoleMsg",!0),null!=p11DeskConsoleMsgTimer&&clearTimeout(p11DeskConsoleMsgTimer),desktop.consoleMessageTimeout&&(p11DeskConsoleMsgTimer=setTimeout(p11clearConsoleMsg,1e3*desktop.consoleMessageTimeout))):p11clearConsoleMsg()})):(desktop.Stop(),webRtcDesktopReset(),(desktopNode=desktop=null)!=pluginHandler&&pluginHandler.callHook("onDesktopDisconnect")))}function askRdpCredentials(){var e;xxdialogMode||(e="<div>",1==currentNode.rdp?e=e+addHtmlValue("证书","<select id=d2mode style=width:230px onchange=askRdpCredentialsValidate()><option value=1>使用服务器凭据</option><option value=2>使用新凭据</option></select>")+"<div id=d2cred style=display:none>":e+="<div id=d2cred>",e=(e=(e+=addHtmlValue("域","<input type=text id=d2domain style=width:230px maxlength=128 />"))+addHtmlValue("用户名","<input type=text id=d2user style=width:230px onKeyUp=askRdpCredentialsValidate() maxlength=128 />"))+addHtmlValue("密码","<input type=password id=d2pass style=width:230px maxlength=128 autocomplete=off />"),0==(4194304&features2)&&(e+=addHtmlValue("",'<label><input type="checkbox" id=d2savecred>记住凭据</label>')),setDialogMode(2,"RDP 凭证",19,askRdpCredentialsEx,e=(e=(e=(e=(e+="</div>")+MoreStart())+addHtmlValue("替代Shell","<input type=text id=d2altshell style=width:230px maxlength=2048 />"))+addHtmlValue("工作目录","<input type=text id=d2workdir style=width:230px maxlength=2048 />"))+MoreEnd()))}function askRdpCredentialsValidate(){1==currentNode.rdp&&(QV("d2cred",2==Q("d2mode").value),1==Q("d2mode").value)?QE("idx_dlgOkButton",!0):QE("idx_dlgOkButton",""!=Q("d2user").value)}function askRdpCredentialsEx(){var e,t=null,n=null;desktopsettings.rdpsize?"browser"==desktopsettings.rdpsize?(t=window.innerWidth,n=window.innerHeight):"screen"==desktopsettings.rdpsize?(t=window.screen.width,n=window.screen.height):"canvas"==desktopsettings.rdpsize?(t=Q("DeskParent").offsetWidth,n=Q("DeskParent").offsetHeight):1<=(e=desktopsettings.rdpsize.indexOf("x"))&&(t=parseInt(desktopsettings.rdpsize.substring(0,e)),n=parseInt(desktopsettings.rdpsize.substring(e+1))):(t=Q("DeskParent").offsetWidth,n=Q("DeskParent").offsetHeight),1==currentNode.rdp&&1==Q("d2mode").value?connectDesktop(null,4,{servercred:!0,width:t,height:n,flags:null!=desktopsettings.rdpflags?desktopsettings.rdpflags:47,altshell:Q("d2altshell").value,workdir:Q("d2workdir").value}):(e=!1,0==(4194304&features2)&&(e=Q("d2savecred").checked),connectDesktop(null,4,{domain:Q("d2domain").value,username:Q("d2user").value,password:Q("d2pass").value,savecred:e,width:t,height:n,flags:null!=desktopsettings.rdpflags?desktopsettings.rdpflags:47,altshell:Q("d2altshell").value,workdir:Q("d2workdir").value}))}function updateMetadata(e,t){var n="",i=0;if(e&&3==e.State){if(e.metadata&&e.metadata.users)for(var o in e.metadata.users)i+=e.metadata.users[o];1<i&&(n="<span onclick=showSessionMetadata(1) style=cursor:pointer>"+format("，{0}观看",i)+"</span>")}QH("deskmetadata",n),e==desktop&&"sessionMetadata1"==xxdialogTag&&showSessionMetadata(1)}function showSessionMetadata(e){if(!xxdialogMode||xxdialogTag=="sessionMetadata"+e){xxdialogMode&&setDialogMode(0);var t=1==e?desktop:null;if(t&&t.metadata){var n="";if(t.metadata.startTime&&(n+=addHtmlValue4("开始时间",printDateTime(new Date(t.metadata.startTime)))),t.metadata.users)for(var i in t.metadata.users){var o=1==t.metadata.users[i]?"1条连接":format("{0}个连接",t.metadata.users[i]);n+=addHtmlValue2(getUserName(i),o)}setDialogMode(2,"会话信息",1,null,n,"sessionMetadata"+e)}}}function p11clearConsoleMsg(){QH("p11DeskConsoleMsg",""),QV("p11DeskConsoleMsg",!1),p11DeskConsoleMsgTimer&&(clearTimeout(p11DeskConsoleMsgTimer),p11DeskConsoleMsgTimer=null)}function p12clearConsoleMsg(){QH("p12TermConsoleMsg",""),QV("p12TermConsoleMsg",!1),p12TermConsoleMsgTimer&&(clearTimeout(p12TermConsoleMsgTimer),p12TermConsoleMsgTimer=null)}function p13clearConsoleMsg(){QH("p13FilesConsoleMsg",""),QV("p13FilesConsoleMsg",!1),p13FilesConsoleMsgTimer&&(clearTimeout(p13FilesConsoleMsgTimer),p13FilesConsoleMsgTimer=null)}function p12setConsoleMsg(e,t){e?(Q("p12TermConsoleMsg").innerHTML+=e,QV("p12TermConsoleMsg",!0),null!=p12TermConsoleMsgTimer&&clearTimeout(p12TermConsoleMsgTimer),t&&(p12TermConsoleMsgTimer=setTimeout(p12clearConsoleMsg,t))):p12clearConsoleMsg()}function p13setConsoleMsg(e,t){e?(Q("p13FilesConsoleMsg").innerHTML+=e,QV("p13FilesConsoleMsg",!0),null!=p13FilesConsoleMsgTimer&&clearTimeout(p13FilesConsoleMsgTimer),t&&(p13FilesConsoleMsgTimer=setTimeout(p13clearConsoleMsg,t))):p13clearConsoleMsg()}var webRtcDesktop=null;function webRtcDesktopReset(){if(null!=webRtcDesktop){if(null!=webRtcDesktop.softdesktop&&(webRtcDesktop.softdesktop.Stop(),webRtcDesktop.softdesktop=null),null!=webRtcDesktop.webchannel){try{webRtcDesktop.webchannel.close()}catch(e){}webRtcDesktop.webchannel=null}if(null!=webRtcDesktop.webrtc){try{webRtcDesktop.webrtc.close()}catch(e){}webRtcDesktop.webrtc=null}webRtcDesktop=null,desktop&&desktop.m&&(desktop.m.hold(!1),Q("deskstatus").textContent=StatusStrs[desktop.State])}}function onDesktopStateChange(e,t){var n=t,e=(3==n&&2==e.contype&&n++,StatusStrs[n]);switch(null!=desktop&&1==desktop.webRtcActive&&(e+="，WebRTC"),null!=desktop&&3==n&&4==desktop.contype&&(e+=", RDP"),QH("deskstatus",e),t){case 0:null!=desktop&&(null!=desktop.m.recordedData&&deskRecordSession(),desktop.Stop()),desktopNode=desktop=null,QV("DeskFocus",!1),QV("DeskMonitorSelectionSpan",!1),QV("deskRecordIcon",!1),QV("DeskInputLockedButton",!1),QV("DeskInputUnLockedButton",!1),deskFocusBtn.value="全部聚焦",1==fullscreen&&deskToggleFull(),webRtcDesktopReset(),deskPreferedStickyDisplay=0;break;case 2:break;case 3:desktop&&1==desktop.serverIsRecording&&QV("deskRecordIcon",!0),desktop.startTime=new Date,(deskLastClipboardSent=null)==updateSessionTimer&&(updateSessionTimer=setInterval(updateSessionTime,1e3))}updateDesktopButtons(),deskAdjust(),setTimeout(deskAdjust,50),updateMetadata(desktop,"deskmetadata")}function updateSessionTime(){var e="",t=0;if(desktop&&desktop.startTime){if(desktop.latency&&0<=desktop.latency.current&&(e=format("{0} ms",desktop.latency.current)),t=Math.floor((new Date-desktop.startTime)/1e3),QH("DeskTimer",zeroPad(Math.floor(t/3600),2)+":"+zeroPad(Math.floor(t/60)%60,2)+":"+zeroPad(t%60,2)),QH("DeskLatency",e),(4!=desktop.contype&&!0===desktopsettings.autoclipboard||4==desktop.contype&&!0===desktopsettings.rdpautoclipboard)&&null!=navigator.clipboard&&null!=navigator.clipboard.readText){if("firefox"==Mstsc.browser())return;try{navigator.clipboard.readText().then(function(e){null!=desktop&&null!=e&&deskLastClipboardSent!=e&&(desktop.m.setClipboard?desktop.m.setClipboard(e):(console.log("s3"),meshserver.send({action:"msg",type:"setclip",nodeid:currentNode._id,data:e})),deskLastClipboardSent=e)}).catch(function(e){})}catch(e){console.log(e)}}}else QH("DeskTimer",""),QH("DeskLatency","");t=0,terminal&&terminal.startTime?(terminal.latency&&0<=terminal.latency.current&&(e=format("{0} ms, ",terminal.latency.current)),t=Math.floor((new Date-terminal.startTime)/1e3),QH("TermTimer",e+zeroPad(Math.floor(t/3600),2)+":"+zeroPad(Math.floor(t/60)%60,2)+":"+zeroPad(t%60,2))):QH("TermTimer",""),null==desktop&&null==terminal&&(clearInterval(updateSessionTimer),updateSessionTimer=null)}function showDesktopSettings(){var e;xxdialogMode||(applyDesktopSettings(),updateDesktopButtons(),e=!1,0==(e="none"!=QS("td7meshkvm").display&&0<Q("td7meshkvm").className.indexOf("active")||"none"!=QS("td7rdpkvm").display&&0<Q("td7rdpkvm").className.indexOf("active")||"none"!=QS("td7amtkvm").display&&0<Q("td7amtkvm").className.indexOf("active")?!0:e)&&("none"!=QS("td7meshkvm").display?changeDesktopSettingsTab(null,"d7meshkvm"):"none"!=QS("td7rdpkvm").display?changeDesktopSettingsTab(null,"d7rdpkvm"):"none"!=QS("td7amtkvm").display&&changeDesktopSettingsTab(null,"d7amtkvm")),setDialogMode(7,"远程桌面设置",3,showDesktopSettingsChanged))}function changeDesktopSettingsTab(e,t){for(var n,i=document.getElementsByClassName("tabcontent"),o=0;o<i.length;o++)i[o].style.display="none";for(n=document.getElementsByClassName("tablinks"),o=0;o<n.length;o++)n[o].className=n[o].className.replace(" active","");document.getElementById(t).style.display="block",null!=e?e.currentTarget.className+=" active":document.getElementById("t"+t).className+=" active"}function showDesktopSettingsChanged(){desktopsettings.encoding=d7desktopmode.value,desktopsettings.showfocus=d7showfocus.checked,desktopsettings.showmouse=d7showcursor.checked,desktopsettings.quality=d7bitmapquality.value,desktopsettings.scaling=d7bitmapscaling.value,desktopsettings.framerate=d7framelimiter.value,desktopsettings.agentencoding=d7encoding.value,desktopsettings.swapmouse=d7deskSwapMouse.checked,desktopsettings.rmw=d7deskrmw.checked,desktopsettings.remotekeymap=d7deskRemoteKeyMap.checked,desktopsettings.autoclipboard=d7deskAutoClipboard.checked,desktopsettings.autolock=d7deskAutoLock.checked,desktopsettings.localkeymap=d7localKeyMap.checked,desktopsettings.kvmrmw=d7kvmrmw.checked,desktopsettings.rdpsize=d7rdpsize.value,desktopsettings.rdpsmb=d7rdpsmb.checked,desktopsettings.rdprmw=d7rdprmw.checked,desktopsettings.rdpautoclipboard=d7rdpclip.checked;for(var e=0,t=1;t<10;t++)5!=t&&Q("d7rdp"+t).checked&&(e|=1<<t-1);desktopsettings.rdpflags=e,localStorage.setItem("desktopsettings",JSON.stringify(desktopsettings)),applyDesktopSettings(),updateDesktopButtons(),desktop&&(1==desktop.contype&&(desktop.m.SwapMouse=desktopsettings.swapmouse,desktop.m.ReverseMouseWheel=desktopsettings.rmw,desktop.m.remoteKeyMap=desktopsettings.remotekeymap,0!=desktop.State)&&(desktop.m.SendCompressionLevel(desktopsettings.agentencoding,desktopsettings.quality,desktopsettings.scaling,desktopsettings.framerate),desktop.sendCtrlMsg('{"ctrlChannel":"102938","type":"autolock","value":'+desktopsettings.autolock+"}"),desktop.m.SendRefresh()),2==desktop.contype&&(desktop.m.ReverseMouseWheel=desktopsettings.kvmrmw,0==desktopsettings.showfocus&&(desktop.m.focusmode=0,deskFocusBtn.value="全部聚焦"),0!=desktop.State)&&(desktop.Stop(),setTimeout(function(){connectDesktop(null,2)},50)),4==desktop.contype)&&(desktop.m.SwapMouse=desktopsettings.rdpsmb,desktop.m.ReverseMouseWheel=desktopsettings.rdprmw)}function applyDesktopSettings(){var e="",t=512&features?[100,90,80,70,60,50,40,30,20,10,5,1]:[60,50,40,30,20,10,5,1];for(n in t)e+="<option value="+t[n]+">"+t[n]+"%</option>";QH("d7bitmapquality",e),d7desktopmode.value=desktopsettings.encoding,d7showfocus.checked=desktopsettings.showfocus,d7showcursor.checked=desktopsettings.showmouse,desktopsettings.agentencoding?d7encoding.value=desktopsettings.agentencoding:desktopsettings.agentencoding=4,d7bitmapquality.value=40,0<=t.indexOf(parseInt(desktopsettings.quality))&&(d7bitmapquality.value=desktopsettings.quality),d7bitmapscaling.value=desktopsettings.scaling,desktopsettings.framerate?d7framelimiter.value=desktopsettings.framerate:d7framelimiter.value=100,null!=desktopsettings.swapmouse&&(d7deskSwapMouse.checked=desktopsettings.swapmouse),null!=desktopsettings.rmw&&(d7deskrmw.checked=desktopsettings.rmw),null!=desktopsettings.remotekeymap&&(d7deskRemoteKeyMap.checked=desktopsettings.remotekeymap),null!=desktopsettings.autoclipboard&&(d7deskAutoClipboard.checked=desktopsettings.autoclipboard),null!=desktopsettings.autolock&&(d7deskAutoLock.checked=desktopsettings.autolock),desktopsettings.localkeymap&&(d7localKeyMap.checked=desktopsettings.localkeymap),desktopsettings.kvmrmw&&(d7kvmrmw.checked=desktopsettings.kvmrmw),QV("deskFocusBtn",null!=desktop&&2==desktop.contype&&0!=desktop.state&&desktopsettings.showfocus),null!=desktopsettings.rdpsize&&(d7rdpsize.value=desktopsettings.rdpsize),null==desktopsettings.rdpflags&&(desktopsettings.rdpflags=47),null!=desktopsettings.rdpsmb&&(d7rdpsmb.checked=desktopsettings.rdpsmb),null!=desktopsettings.rdprmw&&(d7rdprmw.checked=desktopsettings.rdprmw),null!=desktopsettings.rdpautoclipboard&&(d7rdpclip.checked=desktopsettings.rdpautoclipboard);for(var n=1;n<10;n++)5!=n&&(Q("d7rdp"+n).checked=0!=(desktopsettings.rdpflags&1<<n-1))}function enterBrowserFullscreen(e){navigator.keyboard&&navigator.keyboard.lock&&navigator.keyboard.lock(),e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}function exitBrowserFullscreen(){document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),navigator.keyboard&&navigator.keyboard.unlock&&navigator.keyboard.unlock()}function isBrowserFullscreen(){return!!(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement)}var fullscreen=!1,browserfullscreen=!1;function deskToggleFull(e){var t=!(0===args.xterm||null!=terminal&&null==xterm);(fullscreen=!fullscreen)?(QC("body").add("fulldesk"),QS("deskarea3x").height="100%",QS("deskarea3x")["max-height"]="100%",t?(QS("termTable").position="absolute",QS("termTable").top=QS("termTable").bottom=QS("termTable").left=QS("termTable").right="0"):(QS("termTable").height="100%",QS("termTable")["max-height"]="100%"),1==e.shiftKey&&(enterBrowserFullscreen(Q("container")),browserfullscreen=!0)):(QC("body").remove("fulldesk"),e=args.hide,0==footerBar&&(e|=4),e=(1&e?0:66)+(2&e?0:24)+(4&e?0:45)+(8&e?0:60),QS("deskarea3x").height="calc(100vh - "+(75+e)+"px)",QS("deskarea3x")["max-height"]="calc(100vh - "+(75+e)+"px)",t?(QS("termTable").position=null,QS("termTable").top=QS("termTable").bottom=QS("termTable").left=QS("termTable").right=null):(QS("termTable").height="calc(100vh - "+(75+e)+"px)",QS("termTable")["max-height"]="calc(100vh - "+(75+e)+"px)"),1==browserfullscreen&&(exitBrowserFullscreen(),browserfullscreen=!1)),deskAdjust(),updateDesktopButtons(),adjustPanels(),null!=xterm&&12==xxcurrentView&&(xtermfit.fit(),xterm.focus())}function deskToggleFocus(){desktop.m.focusmode=(desktop.m.focusmode+64)%192,Q("deskFocusBtn").value=["全部聚焦","小焦点","大焦点"][desktop.m.focusmode/64]}function deskAdjust(){var e=Q("DeskParent").clientHeight,t=Q("DeskParent").clientWidth,n=Q("Desk").height,i=Q("Desk").width;2==deskAspectRatio?(QS("Desk")["margin-top"]=null,QS("Desk").height="100%",QS("Desk").width="100%",QS("DeskParent").overflow="hidden"):1==deskAspectRatio?(QS("Desk")["margin-top"]="0px",QS("Desk").height=n+"px",QS("Desk").width=i+"px",QS("DeskParent").overflow="scroll"):(n/i<e/t?(t=n*t/i+"px",QS("Desk").height=t,QS("Desk").width="100%"):(t=i*e/n+"px",QS("Desk").height=webPageFullScreen||fullscreen?null:"100%",QS("Desk").width=t),QS("Desk")["margin-top"]=null,QS("DeskParent").overflow="hidden")}function mdeskAdjust(e,t,n,i){var o;e&&t&&n&&i&&(3!=(o=Q("viewselect").value)&&5!=o||("Desk"==i.id?deskAdjust():(5==o&&(o=[{x:180,y:101},{x:302,y:169},{x:454,y:255}][Q("sizeselect").selectedIndex],QS(i.id).width=(0!=e.State?t*o.y/n:o.x)+"px"),QS(i.id)["margin-top"]=null,QS(i.id)["margin-bottom"]=null)))}function sendDeskEsc(){null!=desktop&&3==desktop.State&&(2==desktop.contype?desktop.m.sendkey([[65307,1],[65307,0]]):desktop.m.SendKeyMsgKC([[desktop.m.KeyAction.EXDOWN,27],[desktop.m.KeyAction.EXUP,27]]))}function p11fileDragDrop(e){var t;haltEvent(e),QV("p11bigfail",!1),QV("p11bigok",!1),null==xxdialogMode&&null!=desktop&&3==desktop.State&&null!=e.dataTransfer&&0!=e.dataTransfer.files.length&&((t=(e=e.dataTransfer.files[0]).name.toLowerCase()).endsWith(".bat")||t.endsWith(".ps1")||t.endsWith(".sh")||t.endsWith(".agentconsole")?d2runCommandDialog({nodeids:[currentNode._id],selectedFile:e}):t.endsWith(".txt")&&((t=new FileReader).onload=function(e){showDeskType(e.target.result)},t.readAsText(e)))}var p11dragtimer=null;function p11fileDragOver(e){haltEvent(e),null!=p11dragtimer&&(clearTimeout(p11dragtimer),p11dragtimer=null);e=null==xxdialogMode&&null!=desktop&&3==desktop.State;QV("p11bigok",e),QV("p11bigfail",!e)}function p11fileDragLeave(e){haltEvent(e),"Desk"!=e.target.id?(QV("p11bigfail",!1),QV("p11bigok",!1)):p11dragtimer=setTimeout(function(){QV("p11bigfail",!1),QV("p11bigok",!1),p11dragtimer=null},10)}function updateDeskShortcutKeys(){var e,t="",n=parseInt(Q("deskkeys").value);for(e in""==n&&0<deskKeyboardShortcuts.length&&(n=deskKeyboardShortcuts[0]),deskKeyboardShortcuts)t+="<option value="+deskKeyboardShortcuts[e]+(n==deskKeyboardShortcuts[e]?" selected":"")+">"+keyShortcutTotext(deskKeyboardShortcuts[e])+"</option>";QH("deskkeys",t)}var keyStrings={8:"退格",9:"Tab",13:"输入",27:"逃脱",32:"Space",44:"打印屏幕",45:"插",46:"Del",36:"家",35:"结尾",33:"向上翻页",34:"向下翻页",37:"左",38:"上",39:"右",40:"下",0:"没有"};function keyShortcutTotext(e){var t=[];return 65536&e&&t.push("Shift"),131072&e&&t.push("Alt"),524288&e&&t.push("Ctrl"),1048576&e&&t.push("Win"),112<=(e&=65535)&&e<=123?t.push("F"+(e-111)):0!=e&&keyStrings[e]?t.push(keyStrings[e]):0!=e&&t.push(String.fromCharCode(e)),t.join(" + ")}function deskCustomizeKeys(){if(!xxdialogMode){var e=(e='<div id=d2shortcuts style="width:100%;height:180px;padding:4px;overflow-y:auto;border:1px solid gray"></div><div style=width:100%;padding:5px>')+"<label><input id=d1kshift type=checkbox /> Shift</label><label> <input id=d1kalt type=checkbox /> Alt</label><label> <input id=d1kctrl type=checkbox /> Ctrl</label> <input id=d1kwin type=checkbox /> Win</label>"+" <select id=d2keySelect>";for(t in keyStrings)e+="<option value="+t+">"+keyStrings[t]+"</option>";for(var t=1;t<=12;t++)e+="<option value="+(t+111)+">F"+t+"</option>";for(t=0;t<10;t++)e+="<option value="+(t+48)+">"+t+"</option>";for(t=0;t<26;t++)e+="<option value="+(t+65)+">"+String.fromCharCode(t+65)+"</option>";setDialogMode(2,"键盘快捷键自定义",1,deskCustomizeKeysEx,e=e+"</select> <input type=button value=添加 onclick=addDeskCustomizeKey() /></div>"+'<div style=width:100%;padding:2px;text-align:center><input type=button value="Restore Default Keyboard Shortcuts" onclick=restoreDeskCustomizeKey() /></div>'),deskUpdateShortcutList()}}function deskCustomizeKeysEx(){putstore("deskKeyShortcuts",deskKeyboardShortcuts.join(",")),updateDeskShortcutKeys()}function deskUpdateShortcutList(){var e,t="";for(e in deskKeyboardShortcuts){var n=keyShortcutTotext(deskKeyboardShortcuts[e]),i="";e!=deskKeyboardShortcuts.length-1&&(i+='<img width=8 height=8 style=float:right;cursor:pointer;padding:3px src="images/c2.png" onclick=deskCustomizeKeyDown('+deskKeyboardShortcuts[e]+")>"),0!=e&&(i+='<img width=8 height=8 style=float:right;cursor:pointer;padding:3px src="images/c3.png" onclick=deskCustomizeKeyUp('+deskKeyboardShortcuts[e]+")>"),t+='<div style="width:100%;background-color:#AAA;border-radius:4px;margin-bottom:4px;padding:4px;text-align:left;box-sizing:border-box" value='+deskKeyboardShortcuts[e]+">"+n+'<img width=10 height=10 style=float:right;cursor:pointer;padding:2px;margin-left:8px src="images/trash.png" onclick=removeDeskCustomizeKey('+deskKeyboardShortcuts[e]+")>"+i+"</div>"}""==t&&(t="<i>未定义键盘快捷键</i>"),QH("d2shortcuts",t)}function deskCustomizeKeyDown(e){var e=deskKeyboardShortcuts.indexOf(e),t=deskKeyboardShortcuts[e+1];deskKeyboardShortcuts[e+1]=deskKeyboardShortcuts[e],deskKeyboardShortcuts[e]=t,deskUpdateShortcutList()}function deskCustomizeKeyUp(e){var e=deskKeyboardShortcuts.indexOf(e),t=deskKeyboardShortcuts[e];deskKeyboardShortcuts[e]=deskKeyboardShortcuts[e-1],deskKeyboardShortcuts[e-1]=t,deskUpdateShortcutList()}function removeDeskCustomizeKey(e){var t,n=[];for(t in deskKeyboardShortcuts)deskKeyboardShortcuts[t]!=e&&n.push(deskKeyboardShortcuts[t]);deskKeyboardShortcuts=n,deskUpdateShortcutList()}function restoreDeskCustomizeKey(){deskKeyboardShortcuts=[],putstore("deskKeyShortcuts",null);var e,t=getstore("deskKeyShortcuts","0x0A002E,0x100000,0x100028,0x100026,0x10004C,0x10004D,0x11004D,0x100052,0x020073,0x080057,0x020009,0x100025,0x100027").split(",");for(e in t)""!=t[e]&&deskKeyboardShortcuts.push(parseInt(t[e]));updateDeskShortcutKeys(),deskUpdateShortcutList()}function addDeskCustomizeKey(){var e=parseInt(Q("d2keySelect").value);Q("d1kshift").checked&&(e|=65536),Q("d1kalt").checked&&(e|=131072),Q("d1kctrl").checked&&(e|=524288),Q("d1kwin").checked&&(e|=1048576),0<e&&-1==deskKeyboardShortcuts.indexOf(e)&&(deskKeyboardShortcuts.push(e),deskUpdateShortcutList())}function deskCustomizeStrings(){var e;xxdialogMode||(e='<div id=d2strings style="width:100%;height:180px;padding:4px;overflow-y:auto;border:1px solid gray"></div><div style=width:100%;padding:5px>',setDialogMode(2,"键盘字符串自定义",1,deskCustomizeStringsEx,e=(e=(e+=addHtmlValue("名称","<input type=text id=d2shortcutname style=width:230px maxlength=32 autocomplete=off onkeyup=deskCustomizeStringsUpdate(event) />"))+addHtmlValue("价值","<input type=text id=d2shortcutvalue style=width:230px maxlength=256 autocomplete=off onkeyup=deskCustomizeStringsUpdate(event) />"))+addHtmlValue("","<input id=d2addbutton type=button value=添加 onclick=addDeskCustomizeString() style=float:right />")),deskUpdateStringsList(),deskCustomizeStringsUpdate())}function deskCustomizeStringsUpdate(){QE("d2addbutton",""!=Q("d2shortcutname").value&&""!=Q("d2shortcutvalue").value)}function deskCustomizeStringsEx(){putstore("deskStrings",JSON.stringify(deskKeyboardStrings)),updateDesktopStrings()}function deskUpdateStringsList(){var e,t="";for(e in deskKeyboardStrings){var n="";e!=deskKeyboardStrings.length-1&&(n+='<img width=8 height=8 style=float:right;cursor:pointer;padding:3px src="images/c2.png" onclick=deskCustomizeStringDown('+e+")>"),0!=e&&(n+='<img width=8 height=8 style=float:right;cursor:pointer;padding:3px src="images/c3.png" onclick=deskCustomizeStringUp('+e+")>"),t=(t+='<div style="width:100%;background-color:#AAA;border-radius:4px;margin-bottom:4px;padding:4px;text-align:left;box-sizing:border-box" value='+(e+1e3)+"><div><b>"+EscapeHtml(deskKeyboardStrings[e].n)+'</b><img width=10 height=10 style=float:right;cursor:pointer;padding:2px;margin-left:8px src="images/trash.png" onclick=removeDeskCustomizeString('+e+")>"+n+"</div>")+("<div stlye=font-size:x-small>"+EscapeHtml(deskKeyboardStrings[e].v)+"</div>")+"</div>"}""==t&&(t="<i>未定义键盘字符串</i>"),QH("d2strings",t)}function deskCustomizeStringDown(e){var t=deskKeyboardStrings[e+1];deskKeyboardStrings[e+1]=deskKeyboardStrings[e],deskKeyboardStrings[e]=t,deskUpdateStringsList()}function deskCustomizeStringUp(e){var t=deskKeyboardStrings[e];deskKeyboardStrings[e]=deskKeyboardStrings[e-1],deskKeyboardStrings[e-1]=t,deskUpdateStringsList()}function removeDeskCustomizeString(e){deskKeyboardStrings.splice(e,1),deskUpdateStringsList()}function addDeskCustomizeString(){Array.isArray(deskKeyboardStrings)||(deskKeyboardStrings=[]);var e=Q("d2shortcutname").value,t=Q("d2shortcutvalue").value;""!=e&&""!=t&&(deskKeyboardStrings.push({n:e,v:t}),deskUpdateStringsList())}function updateDesktopStrings(){var e,t="";for(e in deskKeyboardStrings)t+='<div class="cmtext" onclick="cmdeskpreconfigtypeaction('+(parseInt(e)+1e3)+',event)">'+EscapeHtml(deskKeyboardStrings[e].n)+"</div>";""!=t&&(t+="<hr />"),QH("deskPreConfigShortcutContextMenu2",t)}function deskSendKeys(){if(Q("DeskWD").blur(),!xxdialogMode&&null!=desktop&&3==desktop.State){var e=parseInt(Q("deskkeys").value);if(655406==e)desktop.m.sendcad();else{var t=(16711680&e)>>16,e=65535&e,n=[],i=[],o={8:65288,9:65289,13:65293,27:65307,45:65379,46:65535,36:65360,35:65367,33:65365,34:65366,37:65361,38:65362,39:65363,40:65364,112:65470,113:65471,114:65472,115:65473,116:65474,117:65475,118:65476,119:65477,120:65478,121:65479,122:65480,123:65481};if(2==desktop.contype){1&t&&(n.push([65505,1]),i.push([65505,0])),2&t&&(n.push([65513,1]),i.push([65513,0])),8&t&&(n.push([65507,1]),i.push([65507,0])),16&t&&(n.push([65511,1]),i.push([65511,0])),65<=(e=o[e]?o[e]:e)&&e<=90&&(e+=32),0!=e&&(n.push([e,1]),i.push([e,0])),i.reverse();for(var s=0;s<i.length;s++)n.push(i[s]);desktop.m.sendkey(n)}else{1&t&&(n.push([desktop.m.KeyAction.DOWN,16]),i.push([desktop.m.KeyAction.UP,16])),2&t&&(n.push([desktop.m.KeyAction.EXDOWN,18]),i.push([desktop.m.KeyAction.EXUP,18])),8&t&&(n.push([desktop.m.KeyAction.EXDOWN,17]),i.push([desktop.m.KeyAction.EXUP,17])),16&t&&(n.push([desktop.m.KeyAction.EXDOWN,91]),i.push([desktop.m.KeyAction.EXUP,91])),0!=e&&(n.push([desktop.m.KeyAction.DOWN,e]),i.push([desktop.m.KeyAction.UP,e])),i.reverse();for(s=0;s<i.length;s++)n.push(i[s]);desktop.m.SendKeyMsgKC(n)}}}}function showDeskType(e){var t;xxdialogMode||null==desktop||3!=desktop.State||(Q("DeskType").blur(),t="<div>输入文本，然后单击确定以远程键入它。在继续操作之前，请确保将远程光标放置在正确的位置。<div>",setDialogMode(2,"远程键盘输入",3,showDeskTypeEx,t+='<textarea id=d2typeText style="margin-top:5px;width:100%;height:184px;resize:none" maxlength=2000>'+(e?EscapeHtml(e):"")+"</textarea>"),Q("d2typeText").focus())}var AmtDeskTypeTimer=null,AmtDeskTypeContent=null,DeskTypeTranslate={39:222,42:106,43:107,44:188,45:189,46:190,47:191,59:186,61:187,91:219,92:220,93:221,96:192,191:111},DeskTypeShiftTranslate={33:49,34:222,35:51,36:52,37:53,38:55,40:57,41:48,58:186,60:188,62:190,63:191,64:50,94:54,95:189,106:56,107:187,123:219,124:220,125:221,126:192};function showDeskTypeEx(e){var t,n=[],i=!1,o=("string"==typeof e?t=e:(t=Q("d2typeText").value,Q("d2typeText").value)).toUpperCase();if(2==desktop.contype){for(var s in t){var a=t.charCodeAt(s);n.push([a,1],[a,0])}AmtDeskTypeContent=n,AmtDeskTypeTimer=setInterval(function(){var e=AmtDeskTypeContent.shift();desktop&&desktop.m.sendkey(e[0],e[1]),null!=desktop&&0!=AmtDeskTypeContent.length||(clearInterval(AmtDeskTypeTimer),AmtDeskTypeContent=null)},10)}else if(4==desktop.contype)desktop.m.SendStringUnicode(t);else if(!0!==desktopsettings.remotekeymap)desktop.m.SendStringUnicode(t);else{for(var s in t){var a=t.charCodeAt(s),r=o.charCodeAt(s);65<=a&&a<=90||97<=a&&a<=122?(a==r&&0==i&&(n.push([desktop.m.KeyAction.DOWN,16]),i=!0),a!=r&&1==i&&(n.push([desktop.m.KeyAction.UP,16]),i=!1)):48<=a&&a<=57?1==i&&(n.push([desktop.m.KeyAction.UP,16]),i=!1):DeskTypeTranslate[a]?(1==i&&(n.push([desktop.m.KeyAction.UP,16]),i=!1),r=DeskTypeTranslate[a]):DeskTypeShiftTranslate[a]&&(0==i&&(n.push([desktop.m.KeyAction.DOWN,16]),i=!0),r=DeskTypeShiftTranslate[a]),n.push([desktop.m.KeyAction.DOWN,r],[desktop.m.KeyAction.UP,r])}1==i&&(n.push([desktop.m.KeyAction.UP,16]),i=!1),desktop.m.SendKeyMsgKC(n)}}function showDeskClip(){var e;xxdialogMode||null==desktop||3!=desktop.State||(Q("DeskClip").blur(),e="",0==(2048&features2)&&(e+='<input id=dlgClipGet type=button value="获取剪贴板" style=width:160px onclick=showDeskClipGet()>'),0==(4096&features2)&&(e+='<input id=dlgClipSet type=button value="设置剪贴板" style=width:160px onclick=showDeskClipSet()>'),setDialogMode(2,"远程剪贴板",8,null,e=(e+='<div id=dlgClipStatus style="display:inline-block;margin-left:8px" ></div>')+'<textarea id=d2clipText style="width:100%;height:184px;resize:none" maxlength=65535></textarea>'+'<input type=button value="Close" style=width:80px;float:right onclick=dialogclose(0)><div style=height:26px;margin-top:3px><span id=linuxClipWarn style=display:none>远程剪贴板的有效期为60秒。</span>&nbsp;</div><div></div>',"clipboard"),Q("d2clipText").focus())}function showDeskClipGet(){null!=desktop&&3==desktop.State&&meshserver.send({action:"msg",type:"getclip",nodeid:currentNode._id,tag:1})}function showDeskClipSet(){null!=desktop&&3==desktop.State&&(desktop.m.setClipboard?desktop.m.setClipboard(Q("d2clipText").value):(meshserver.send({action:"msg",type:"setclip",nodeid:currentNode._id,data:Q("d2clipText").value}),QV("linuxClipWarn",currentNode&&currentNode.agent&&4<currentNode.agent.id&&21!=currentNode.agent.id&&22!=currentNode.agent.id&&34!=currentNode.agent.id)))}function sendCAD(){xxdialogMode||null==desktop||3!=desktop.State||desktop.m.sendcad()}function toggleDeskTools(){Q("DeskToolsButton").blur(),xxdialogMode||("none"==QS("DeskTools").display?(QV("DeskTools",!0),Q("DeskTools").nodeid=currentNode._id,QH("DeskToolsProcesses",""),QH("DeskToolsServices",""),QV("deskToolsTopTabService",!1),changeDeskToolTab(0),refreshDeskTools(0),refreshDeskTools(1)):QV("DeskTools",!1))}var deskToolTabSelection=0;function changeDeskToolTab(e){deskToolTabSelection=e,QV("DeskToolsProcessTab",0==e),QV("DeskToolsServiceTab",1==e),QS("deskToolsTopTabProcess").bottom=0==e?"0px":"3px",QS("deskToolsTopTabService").bottom=1==e?"0px":"3px",QS("deskToolsTopTabProcess").color=0==e?"black":"gray",QS("deskToolsTopTabService").color=1==e?"black":"gray"}function refreshDeskTools(e){e=null==e?deskToolTabSelection:e;QV("DeskToolsRefreshButton",!1),setTimeout(refreshDeskToolsEx,500),0==e&&meshserver.send({action:"msg",type:"ps",nodeid:currentNode._id}),1==e&&meshserver.send({action:"msg",type:"services",nodeid:currentNode._id})}function refreshDeskToolsEx(){QV("DeskToolsRefreshButton",!0)}var deskTools={sort:1,ssort:1,msg:null,smsg:null,resizing:!1};function sortProcess(e){deskTools.sort=e,showDeskToolsProcesses(deskTools.msg)}function sortService(e){deskTools.ssort=e,showDeskToolsServices(deskTools.smsg)}function sortProcessPid(e,t){return e.p>t.p?1:e.p<t.p?-1:sortProcessName(e,t)}function sortProcessName(e,t){return e.d>t.d?1:e.d<t.d?-1:0}function showDeskToolsProcesses(e){if(null==(deskTools.msg=e))QH("DeskToolsProcesses","");else if(Q("DeskTools").nodeid==e.nodeid){var t=[],n=null;try{n=JSON.parse(e.value)}catch(e){}if(null!=n){for(var i in n)t.push({p:parseInt(i),c:n[i].cmd,d:n[i].cmd.toLowerCase(),u:n[i].user});0==deskTools.sort?t.sort(sortProcessPid):1==deskTools.sort&&t.sort(sortProcessName);var o,s,a="";for(o in t)0!=t[o].p&&(s=t[o].c,a=(a=(a=(a=(a+="<div onclick=showProcessDetails("+t[o].p+") class=deskToolsBar>")+"<div style=width:50px;float:left;text-align:right;padding-right:5px>"+EscapeHtml(t[o].p)+"</div>")+'<a href=# style=float:right;padding-right:5px;cursor:pointer title="停止进程" onclick=\'return stopProcess('+EscapeHtml(t[o].p)+',"'+EscapeHtml(t[o].c)+'")\'><img width=10 height=10 src="images/trash.png"></a>')+"<div style=float:right;padding-right:5px>"+(t[o].u?EscapeHtml(t[o].u):"")+"</div>")+'<div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding-right:5px" title="'+EscapeHtml(s)+'">'+s+"</div></div>");QH("DeskToolsProcesses",a)}}}function showProcessDetails(e){xxdialogMode||(setDialogMode(2,format("流程详情，#{0}",e),1,null,"Requesting Process Details...","ps|"+currentNode._id+"|"+e),meshserver.send({action:"msg",type:"psinfo",nodeid:currentNode._id,pid:e}))}function showDeskToolsServices(e){if(null==(deskTools.smsg=e))QH("DeskToolsProcesses","");else if(Q("DeskTools").nodeid==e.nodeid){QV("deskToolsTopTabService",!0);var t=[],n=null;try{n=JSON.parse(e.value)}catch(e){}if(null!=(deskTools.services=n)){for(var i in n)n[i].status?t.push({p:capitalizeFirstLetter(n[i].status.state.toLowerCase()),d:n[i].displayName,i:i}):n[i].serviceType&&t.push({p:n[i].serviceType,d:n[i].name,i:i});0==deskTools.ssort?t.sort(sortProcessPid):1==deskTools.ssort&&t.sort(sortProcessName);var o,s,a="";for(i in t)0!=t[i].p&&(o=t[i].d,"Stopped"==(s=t[i].p)?s="停止":"Running"==s&&(s="跑步"),a=(a=(a+="<div onclick=showServiceWaitDialog("+t[i].i+") class=deskToolsBar>")+"<div style=width:70px;float:left;padding-right:5px>"+EscapeHtml(s)+"</div>")+'<div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="'+o+'">'+EscapeHtml(o)+"</div></div>");QH("DeskToolsServices",a)}}}function showServiceDetailsDialog(e){var t,n,i;xxdialogMode&&-1!=xxdialogTag.indexOf("service_")&&(t=xxdialogTag.replace("service_",""),n=e.value?JSON.parse(e.value):deskTools.services[t],e.value&&(n.displayName=deskTools.services[t].displayName),null!=n)&&(e="",n.name&&(e+=addHtmlValue("名称",n.name)),n.displayName&&(e+=addHtmlValue("显示名称",n.displayName)),n.status&&("Stopped"==(i=capitalizeFirstLetter(n.status.state.toLowerCase()))?i="停止":"Running"==i&&(i="跑步"),n.status.state&&(e+=addHtmlValue("状况",i)),n.status.pid&&(e+=addHtmlValue("PID",n.status.pid)),i=[],!0===n.status.isFileSystemDriver&&i.push("文件系统驱动"),!0===n.status.isInteractive&&i.push("互动"),!0===n.status.isKernelDriver&&i.push("内核驱动器"),!0===n.status.isOwnProcess&&i.push("自己的过程"),!0===n.status.isSharedProcess&&i.push("共享过程"),0<i.length)&&(e+=addHtmlValue("类型",i.join(", "))),n.startType&&(e+=addHtmlValue("Start Type",n.startType)),n.user&&(e+=addHtmlValue("用户",n.user)),n.installedBy&&(e+=addHtmlValue("Installed By",n.installedBy)),n.installedDate&&(e+=addHtmlValue("Installed Date",printDateTime(new Date(n.installedDate)))),n.failureActions&&(n.failureActions.resetPeriod&&(e+=addHtmlValue("Restart Fail Count After ",(i=(n.failureActions.resetPeriod<86400?0:n.failureActions.resetPeriod)/86400)+" Day"+(1!=i?"s":""))),n.failureActions.actions)&&(n.failureActions.actions[0]&&(e+=addHtmlValue("First Failure",n.failureActions.actions[0].type)),n.failureActions.actions[1]&&(e+=addHtmlValue("Second Failure",n.failureActions.actions[1].type)),n.failureActions.actions[2])&&(e+=addHtmlValue("Subsequent Failures",n.failureActions.actions[2].type)),setDialogMode(2,"服务详情",8,null,e+='<br/><div style=float:right;margin-bottom:12px><input type=button value="关" onclick=showServiceDetailsDialogEx(0,'+t+')></div><div style=margin-bottom:12px><input type=button value="开始" onclick=showServiceDetailsDialogEx(1,'+t+')><input type=button value="停止" onclick=showServiceDetailsDialogEx(2,'+t+')><input type=button value="重新启动" onclick=showServiceDetailsDialogEx(3,'+t+")></div>","service_"+t))}function showServiceWaitDialog(e){var t;return xxdialogMode||null!=(t=deskTools.services[e])&&(meshserver.send({action:"msg",type:"service",nodeid:currentNode._id,serviceName:t.name}),setDialogMode(2,"服务详情",1,null,"Requesting Service Details...","service_"+e)),!1}function showServiceDetailsDialogEx(e,t){setDialogMode(0),0!=e&&null!=(t=deskTools.services[t])&&(1==e&&meshserver.send({action:"msg",type:"serviceStart",nodeid:currentNode._id,serviceName:t.name}),2==e&&meshserver.send({action:"msg",type:"serviceStop",nodeid:currentNode._id,serviceName:t.name}),3==e&&meshserver.send({action:"msg",type:"serviceRestart",nodeid:currentNode._id,serviceName:t.name}),setTimeout(function(){refreshDeskTools(1)},1e3))}function toggleKvmControl(){Q("DeskControl").blur(),putstore("DeskControl",Q("DeskControl").checked?1:0),QS("DeskControlSpan").color=Q("DeskControl").checked?null:"red"}function deskRecordSession(){var e;null!=desktop&&(null==desktop.m.recordedData?(Q("DeskRecordButtonImage").src="images/icon-film-red.png",desktop.m.StartRecording()):(Q("DeskRecordButtonImage").src="images/icon-film.png",e=new Date,e="桌面时段-"+currentNode.name+"-"+e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2)+"-"+("0"+e.getHours()).slice(-2)+"-"+("0"+e.getMinutes()).slice(-2),saveAs(data2blob(desktop.m.StopRecording().join("")),e+".mcrec")))}function deskSaveImage(){var e,t;xxdialogMode||null==desktop||3!=desktop.State||(e=new Date,t="桌面-"+currentNode.name+"-"+e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2)+"-"+("0"+e.getHours()).slice(-2)+"-"+("0"+e.getMinutes()).slice(-2),Q("Desk").toBlob(function(e){saveAs(e,t+".png")}))}function deskDisplayInfo(e,t,n){var i,o=0,s="";for(i in t){o++;var a=t[i],r=1;"All Displays"==a&&(a="所有显示",r=2),a.startsWith("Display ")&&(a=format("显示{0}",a.substring(8))),s+="<img id=DeskMonitorSelectionX"+i+' class="'+(n==i?"":" gray")+"\" src='images/icon-monitor"+r+".png' title=\""+EscapeHtml(a)+'" onclick=deskSetDisplay('+i+") height=16 width=16 style=padding-top:2px;margin-left:2px />",deskPreferedStickyDisplay==i&&n!=deskPreferedStickyDisplay&&desktop.m.SetDisplay(i),deskPreferedStickyDisplay=-1}QH("DeskMonitorSelectionSpan",s),QV("DeskMonitorSelectionSpan",1<o)}function deskGetDisplayNumbers(e){desktop.m.GetDisplayNumbers()}Q("DeskTools").addEventListener("mousemove",function(e){e=e.clientX-Q("DeskTools").getBoundingClientRect().left;Q("DeskTools").style.cursor=e<5?"col-resize":"default"}),Q("DeskTools").addEventListener("mousedown",function(e){"col-resize"===Q("DeskTools").style.cursor&&(deskTools.resizing=!0,Q("Desk").removeAttribute("onmouseup"),Q("Desk").removeAttribute("onmousedown"),Q("Desk").removeAttribute("onmousemove"))}),document.addEventListener("mouseup",function(){!0===deskTools.resizing&&"col-resize"===Q("DeskTools").style.cursor&&(deskTools.resizing=!1,Q("Desk").setAttribute("onmouseup","dmouseup(event)"),Q("Desk").setAttribute("onmousedown","dmousedown(event)"),Q("Desk").setAttribute("onmousemove","dmousemove(event)"))}),document.addEventListener("mousemove",function(e){deskTools.resizing&&(e=Q("DeskTools").getBoundingClientRect().right-e.clientX)<Q("DeskParent").clientWidth-10&&(Q("DeskTools").style.width=e+"px")});var deskPreferedStickyDisplay=-1;function deskSetDisplay(e){desktop.m.SetDisplay(deskPreferedStickyDisplay=parseInt(e))}var terminalNode,dblClickDetectArgs={t:0,x:0,y:0};function dblClickDetect(e){var t;1==e.buttons&&((t=Date.now())-dblClickDetectArgs.t<250&&Math.abs(e.clientX-dblClickDetectArgs.x)<2&&Math.abs(e.clientY-dblClickDetectArgs.y)<2&&!xxdialogMode&&null!=desktop&&Q("DeskControl").checked&&(null!=webRtcDesktop&&null!=webRtcDesktop.softdesktop?(webRtcDesktop.softdesktop.m.mousedblclick(e),desktop.m.sendKeepAlive()):desktop.m.mousedblclick(e)),dblClickDetectArgs.t=t,dblClickDetectArgs.x=e.clientX,dblClickDetectArgs.y=e.clientY)}function dmousedown(e){setSessionActivity(),e.addx=Q("DeskParent").scrollLeft,e.addy=Q("DeskParent").scrollTop,!xxdialogMode&&null!=desktop&&Q("DeskControl").checked&&(null!=webRtcDesktop&&null!=webRtcDesktop.softdesktop?(webRtcDesktop.softdesktop.m.mousedown(e),desktop.m.sendKeepAlive()):desktop.m.mousedown(e)),dblClickDetect(e)}function dmouseup(e){setSessionActivity(),e.addx=Q("DeskParent").scrollLeft,e.addy=Q("DeskParent").scrollTop,!xxdialogMode&&null!=desktop&&Q("DeskControl").checked&&(null!=webRtcDesktop&&null!=webRtcDesktop.softdesktop?(webRtcDesktop.softdesktop.m.mouseup(e),desktop.m.sendKeepAlive()):desktop.m.mouseup(e))}function dmousemove(e){setSessionActivity(),e.addx=Q("DeskParent").scrollLeft,e.addy=Q("DeskParent").scrollTop,!xxdialogMode&&null!=desktop&&Q("DeskControl").checked?(Q("Desk").style.cursor="",null!=webRtcDesktop&&null!=webRtcDesktop.softdesktop?(webRtcDesktop.softdesktop.m.mousemove(e),desktop.m.sendKeepAlive()):desktop.m.mousemove(e)):xxdialogMode||null==desktop||Q("DeskControl").checked||(Q("Desk").style.cursor="not-allowed")}function dmousewheel(e){return setSessionActivity(),e.addx=Q("DeskParent").scrollLeft,e.addy=Q("DeskParent").scrollTop,!(xxdialogMode||null==desktop||!Q("DeskControl").checked||(null!=webRtcDesktop&&null!=webRtcDesktop.softdesktop?(webRtcDesktop.softdesktop.m.mousewheel(e),desktop.m.sendKeepAlive()):desktop.m.mousewheel&&desktop.m.mousewheel(e),haltEvent(e),0))}function drotate(e){xxdialogMode||null==desktop||(desktop.m.setRotation(desktop.m.rotation+e),deskAdjust(),deskAdjust())}function stopProcess(e,t){return setDialogMode(2,"进程控制",3,stopProcessEx,format('停止进程 #{0} "{1}"？',e,t),e),!1}function stopProcessEx(e,t){meshserver.send({action:"msg",type:"pskill",nodeid:currentNode._id,value:t}),setTimeout(refreshDeskTools,300)}function setupTerminal(){terminalNode!=currentNode&&null!=terminal&&terminalNode._id!=currentNode._id&&(terminal.Stop(),terminal=terminalNode=null),terminalNode=currentNode,updateTerminalButtons()}function updateTerminalButtons(){var e=null!=terminal&&0!=terminal.state,t=(3==terminalNode.mtype&&null!=terminalNode.agent&&4<terminalNode.agent.id&&512&features2&&(terminalNode.agent.caps=6),QV("disconnectbutton2span",1==e),QV("connectbutton2span",0==e&&null!=terminalNode.agent&&2&terminalNode.agent.caps&&3!=terminalNode.mtype),QV("connectbutton2sspan",512&features2&&0==e&&null!=terminalNode.agent&&2&terminalNode.agent.caps&&3!=terminalNode.agent.id&&0==(16777216&features2)),1==terminalNode.mtype?(QV("connectbutton2hspan",0==e&&null!=terminalNode.intelamt&&2==terminalNode.intelamt.state),QV("terminalSizeDropDown",0==e&&null!=terminalNode.intelamt&&2==terminalNode.intelamt.state)):(QV("connectbutton2hspan",0==e&&null!=terminalNode.intelamt&&2==terminalNode.intelamt.state&&null!=terminalNode.intelamt.ver),QV("terminalSizeDropDown",0==e&&null!=terminalNode.intelamt&&2==terminalNode.intelamt.state&&null!=terminalNode.intelamt.ver)),QV("termActionsBtn",3!=terminalNode.mtype),1==e&&3!=terminal.contype||null==terminalNode.agent||3==terminalNode.agent.id||4==terminalNode.agent.id?QH("terminalCustomUpperRight",""):QH("terminalCustomUpperRight","<a style=cursor:pointer onclick=cmsshportaction(1,event)>"+format("SSH 端口 {0}",terminalNode.sshport||22)+"</a>"),0!=(1&terminalNode.conn)||3==terminalNode.mtype),t=(QE("connectbutton2",t),QE("connectbutton2s",t),0!=(6&terminalNode.conn)),t=(QE("connectbutton2h",t),QE("ctrlcbutton",e),QE("ctrlxbutton",e),QE("escbutton",e),QE("bsbutton",e),QE("pastebutton",e),QE("specialkeylist",e),QE("specialkeylistinput",e),QV("terminalSettingsButtons",terminal&&2==terminal.contype),terminal&&(Q("id_ttypebutton").value=terminalEmulations[terminal.m.terminalEmulation],Q("id_tfxkeysbutton").value=fxEmulations[terminal.m.fxEmulation],Q("id_tcrbutton").value="\r\n"==terminal.m.lineFeed?"CR+LF":"如果"),!(0===args.xterm||null!=terminal&&null==xterm));QV("termarea3xdiv",t),QV("Term",!t),QV("bsbutton",!t),QV("pastebutton",!t),QV("devListToolbarViewIcons2",t),QE("termSizeList",null==terminal)}function onTerminalStateChange(e,t){if(terminal==e){var n=t,i=(3==n&&2==e.contype&&n++,StatusStrs[n]);switch(3==n&&(3==e.contype&&(i+=", SSH"),1==e.webRtcActive)&&(i+="，WebRTC"),QH("termstatus",i),t){case 0:if(QH("termtitle",""),QV("termRecordIcon",!1),null==xterm)try{e.m.TermResetScreen(),e.m.TermDraw()}catch(e){}else xterm.dispose(),xterm=xtermfit=null;null!=e&&(e.Stop(),terminal=null);break;case 3:e&&1==e.serverIsRecording&&QV("termRecordIcon",!0),e.startTime=new Date,null==updateSessionTimer&&(updateSessionTimer=setInterval(updateSessionTime,1e3)),null!=xterm&&xterm.focus()}updateTerminalButtons()}}var autoConnectTerminalTimer=null;function autoConnectTerminal(e){autoConnectTerminalTimer=null==autoConnectTerminalTimer?setInterval(connectTerminal,100):(clearInterval(autoConnectTerminalTimer),null)}function CreateRemoteTunnel(e,t){var n={protocol:1};return null!=t&&"number"==typeof t.protocol&&(n.protocol=t.protocol),n.onTunnelUpdate=e,n.xxStateChange=function(e){},n.ProcessBinaryData=function(e){n.onTunnelUpdate(e)},n.ProcessData=function(e){n.onTunnelUpdate(e)},n.terminalEmulation=1,n.fxEmulation=0,n.lineFeed="\r\n",n}function tunnelUpdate(e){null!=xterm&&(xterm.writeUtf8?"string"==typeof e?xterm.writeUtf8(e):xterm.writeUtf8(new Uint8Array(e)):"string"==typeof e?xterm.write(e):xterm.write(new Uint8Array(e)))}function sshTunnelAuthDialog(e,t){var n="";e.askkeypass?n+=addHtmlValue("验证","<select id=dp2authmethod style=width:230px onchange=sshAuthUpdate(event)><option value=3 selected>存储密钥</option><option value=1>用户名密码</option><option value=2>用户名和密钥</option></select>"):n+=addHtmlValue("验证","<select id=dp2authmethod style=width:230px onchange=sshAuthUpdate(event)><option value=1 selected>用户名密码</option><option value=2>用户名和密钥</option></select>"),n=(n=(n+="<div id=d2userauth style=display:none>")+addHtmlValue("用户名","<input id=dp2user style=width:230px maxlength=64 autocomplete=off onkeyup=sshAuthUpdate(event) />")+"</div><div id=d2passauth style=display:none>")+addHtmlValue("密码","<input type=password id=dp2pass style=width:230px maxlength=64 autocomplete=off onkeyup=sshAuthUpdate(event) />"),0==(4194304&features2)&&(n+=addHtmlValue("","<label><input id=dp2keep type=checkbox>记住凭据</label>")),n=(n=(n+="</div><div id=d2keyauth style=display:none>")+addHtmlValue("密钥文件","<input type=file id=dp2key style=width:230px maxlength=64 autocomplete=off onchange=sshAuthUpdate(event) /><div id=d2badkey style=font-size:x-small>密钥文件必须是 OpenSSH 格式。</div>"))+addHtmlValue("密钥密码","<input type=password id=dp2keypass style=width:230px maxlength=64 autocomplete=off onkeyup=sshAuthUpdate(event) />"),0==(4194304&features2)&&(n=(n+=addHtmlValue("","<label><input id=dp2keep1 type=checkbox onchange=sshAuthUpdate(event)>记住用户和密钥</label>"))+addHtmlValue("","<label><input id=dp2keep2 type=checkbox>记住密码</label>")),n+="</div>",setDialogMode(2,"验证",11,t,n=e.askkeypass?(n+="<div id=d2keyauth2 style=display:none>")+addHtmlValue("密码","<input type=password id=dp2keypass2 style=width:230px maxlength=64 autocomplete=off onkeyup=sshAuthUpdate(event) />")+"</div>":n,"ssh"),Q("dp2user").focus(),sshAuthUpdate(),setTimeout(sshAuthUpdate,50)}function sshTunnelUpdate(e){if("string"==typeof e)if("{"==e[0]){var t=JSON.parse(e);switch(t.action){case"sshauth":sshTunnelAuthDialog(t,sshConnectEx);break;case"sshautoauth":terminal.socket.send(JSON.stringify({action:"sshautoauth",cols:xterm.cols,rows:xterm.rows,width:Q("termarea3xdiv").offsetWidth,height:Q("termarea3xdiv").offsetHeight}));break;case"connectionerror":p12setConsoleMsg("连接错误",5e3);break;case"autherror":p12setConsoleMsg("授权错误",5e3);break;case"sessionerror":p12setConsoleMsg("会话已过期",5e3);break;case"sessiontimeout":p12setConsoleMsg("会话超时",5e3)}}else"~"==e[0]&&(xterm.writeUtf8?xterm.writeUtf8(e.substring(1)):xterm.write(e.substring(1)))}function sshAuthUpdate(e){var t;QV("d2userauth",3!=Q("dp2authmethod").value),QV("d2passauth",1==Q("dp2authmethod").value),QV("d2keyauth",2==Q("dp2authmethod").value),QV("d2keyauth2",3==Q("dp2authmethod").value),1==Q("dp2authmethod").value?QE("idx_dlgOkButton",0<Q("dp2user").value.length&&0<Q("dp2pass").value.length):3==Q("dp2authmethod").value?QE("idx_dlgOkButton",0<Q("dp2keypass2").value.length):(QE("idx_dlgOkButton",!1),0==(4194304&features2)&&QE("dp2keep2",Q("dp2keep1").checked),1==(0<Q("dp2user").value.length&&null!=Q("dp2key").files&&1==Q("dp2key").files.length&&Q("dp2key").files[0].size<8e3)&&((t=new FileReader).onload=function(e){e=0<=e.target.result.indexOf("-----BEGIN OPENSSH PRIVATE KEY-----")&&0<=e.target.result.indexOf("-----END OPENSSH PRIVATE KEY-----")||0<=e.target.result.indexOf("-----BEGIN RSA PRIVATE KEY-----")&&0<=e.target.result.indexOf("-----END RSA PRIVATE KEY-----");QE("idx_dlgOkButton",e),QS("d2badkey").color=e?"#000":"#F00"},t.readAsText(Q("dp2key").files[0]))),e&&13==e.keyCode&&e.target&&1==Q("dp2authmethod").value&&("dp2user"==e.target.id&&Q("dp2pass").focus(),"dp2pass"==e.target.id)&&dialogclose(1)}function sshConnectEx(e){var t,n,i;0==e?null!=terminal&&connectTerminal():(t=0,1==Q("dp2authmethod").value?(0==(4194304&features2)&&(t=Q("dp2keep").checked?1:0),terminal.socket.send(JSON.stringify({action:"sshauth",username:Q("dp2user").value,password:Q("dp2pass").value,keep:t,cols:xterm.cols,rows:xterm.rows,width:Q("termarea3xdiv").offsetWidth,height:Q("termarea3xdiv").offsetHeight}))):3==Q("dp2authmethod").value?terminal.socket.send(JSON.stringify({action:"sshkeyauth",keypass:Q("dp2keypass2").value,cols:xterm.cols,rows:xterm.rows,width:Q("termarea3xdiv").offsetWidth,height:Q("termarea3xdiv").offsetHeight})):(0==(4194304&features2)&&1==(t=Q("dp2keep1").checked?1:0)&&(t+=Q("dp2keep2").checked?1:0),e=new FileReader,n=Q("dp2user").value,i=Q("dp2keypass").value,e.onload=function(e){terminal.socket.send(JSON.stringify({action:"sshauth",username:n,keypass:i,key:e.target.result,keep:t,cols:xterm.cols,rows:xterm.rows,width:Q("termarea3xdiv").offsetWidth,height:Q("termarea3xdiv").offsetHeight}))},e.readAsText(Q("dp2key").files[0])))}function xTermSendResize(){(xtermResizeTimer=null)!=xterm&&null!=terminal&&null!=terminal.sendCtrlMsg&&("sshterminalrelay.ashx"==terminal.urlname?terminal.socket.send(JSON.stringify({action:"resize",cols:xterm.cols,rows:xterm.rows,width:Q("termarea3xdiv").offsetWidth,height:Q("termarea3xdiv").offsetHeight})):terminal.sendCtrlMsg(JSON.stringify({ctrlChannel:"102938",type:"termsize",cols:xterm.cols,rows:xterm.rows})))}function connectTerminal(e,t,n){if(p12clearConsoleMsg(),terminal)"ssh"==xxdialogTag&&setDialogMode(0),terminal.Stop(),terminal=null,fullscreen&&deskToggleFull();else if(2==t){if(null==terminalNode.intelamt.user||""==terminalNode.intelamt.user)return void editDeviceAmtSettings(terminalNode._id,connectTerminal,2);var i={};1==Q("termSizeList").value?(i.cols=80,i.rows=25):2==Q("termSizeList").value&&(i.cols=100,i.rows=30),fullscreen&&deskToggleFull(),QV("termarea3xdiv",!1),QV("Term",!0),(terminal=CreateAmtRedirect(CreateAmtRemoteTerminal("Term",i),authCookie)).debugmode=debugmode,terminal.m.debugmode=debugmode,terminal.m.onTitleChange=function(e,t){QH("termtitle"," - "+EscapeHtml(t))},terminal.onStateChanged=onTerminalStateChange,terminal.Start(terminalNode._id,16994,"*","*",0),terminal.contype=2,Q("id_ttypebutton").value=terminalEmulations[terminal.m.terminalEmulation]}else{i={protocol:null!=n&&"number"==typeof n.protocol?n.protocol:1};n&&n.requireLogin&&(i.requireLogin=!0),n&&n.consent&&(i.consent=n.consent),-1==[1,2,3,4,21,22].indexOf(currentNode.agent.id)&&(1==Q("termSizeList").value?(i.cols=80,i.rows=25,i.xterm=!0):2==Q("termSizeList").value?(i.cols=100,i.rows=30,i.xterm=!0):3==Q("termSizeList").value&&(i.cols=Math.floor((Q("column_l").clientWidth-60)/10),i.rows=Math.floor((Q("column_l").clientHeight-120)/20),i.xterm=!0)),e&&1==e.shiftKey&&(4<currentNode.agent.id?1==i.protocol&&(i.protocol=7):1==i.protocol&&(i.protocol=6)),null!=serverinfo.linuxshell&&4<currentNode.agent.id&&("root"==serverinfo.linuxshell&&(i.protocol=1,delete i.requireLogin),"user"==serverinfo.linuxshell&&(i.protocol=8,delete i.requireLogin),"login"==serverinfo.linuxshell)&&(i.protocol=1,i.requireLogin=!0),0!==args.xterm?(QV("termarea3xdiv",!0),QV("Term",!1),null!=xterm&&xterm.dispose(),xtermfit=new FitAddon.FitAddon,xterm=new Terminal,xtermfit&&xterm.loadAddon(xtermfit),xterm.open(Q("termarea3xdiv")),xterm.onData(function(e){null!=terminal&&("sshterminalrelay.ashx"==terminal.urlname?terminal.socket.send("~"+e):terminal.sendText(e))}),xtermfit&&xtermfit.fit(),xterm.onTitleChange(function(e){QH("termtitle"," - "+EscapeHtml(e))}),xterm.onResize(function(e){xtermResizeTimer&&clearTimeout(xtermResizeTimer),xtermResizeTimer=setTimeout(xTermSendResize,200)}),i.cols=xterm.cols,i.rows=xterm.rows,terminal=CreateAgentRedirect(meshserver,CreateRemoteTunnel(3==t?sshTunnelUpdate:tunnelUpdate,i),serverPublicNamePort,authCookie,authRelayCookie,domainUrl),3==t&&(terminal.urlname="sshterminalrelay.ashx"),terminal.debugmode=debugmode,terminal.m.debugmode=debugmode,(terminal.options=i).requireLogin&&(terminal.options.requireLogin=!0),terminal.Start(terminalNode._id),terminal.onStateChanged=onTerminalStateChange,terminal.contype=t,terminal.attemptWebRTC=!1,terminal.onConsoleMessageChange=function(){p12setConsoleMsg(terminal.consoleMessage?formatAgentConsoleMessage(terminal.consoleMessage,terminal.consoleMessageId,terminal.consoleMessageArgs):null,terminal.consoleMessageTimeout)}):(QV("termarea3xdiv",!1),QV("Term",!0),(terminal=CreateAgentRedirect(meshserver,CreateAmtRemoteTerminal("Term",i),serverPublicNamePort,authCookie,authRelayCookie,domainUrl)).options=i,terminal.debugmode=debugmode,terminal.m.debugmode=debugmode,terminal.m.onTitleChange=function(e,t){QH("termtitle"," - "+EscapeHtml(t))},terminal.m.lineFeed=0<=[1,2,3,4,21,22].indexOf(currentNode.agent.id)?"\r\n":"\r",terminal.attemptWebRTC=!1,terminal.onStateChanged=onTerminalStateChange,terminal.onConsoleMessageChange=function(){p12setConsoleMsg(terminal.consoleMessage?formatAgentConsoleMessage(terminal.consoleMessage,terminal.consoleMessageId,terminal.consoleMessageArgs):null,terminal.consoleMessageTimeout)},terminal.Start(terminalNode._id),terminal.contype=t,terminal.m.terminalEmulation=0,terminal.m.fxEmulation=0,Q("id_ttypebutton").value=terminalEmulations[0])}Q("connectbutton2").blur()}var terminalEmulations=["UTF8终端","扩充式ASCII","英特尔ASCII"];function termToggleType(){terminal&&!xxdialogMode&&(terminal.m.terminalEmulation=(terminal.m.terminalEmulation+1)%3,Q("id_ttypebutton").value=terminalEmulations[terminal.m.terminalEmulation],Q("id_ttypebutton").blur())}var filesNode,fxEmulations=["英特尔（F10 = ESC + [OM）","备用（F10 = ESC + 0）","VT100 +（F10 = ESC + [OY）"];function termToggleFx(){terminal&&!xxdialogMode&&(terminal.m.fxEmulation=(terminal.m.fxEmulation+1)%3,Q("id_tfxkeysbutton").value=fxEmulations[terminal.m.fxEmulation],Q("id_tfxkeysbutton").blur())}function termToggleCr(){terminal&&!xxdialogMode&&("\n"==terminal.m.lineFeed?terminal.m.lineFeed="\r\n":terminal.m.lineFeed="\n",Q("id_tcrbutton").value="\r\n"==terminal.m.lineFeed?"CR+LF":"如果")}function termSendKey(e,t){terminal&&!xxdialogMode&&(null!=xterm?("sshterminalrelay.ashx"==terminal.urlname?terminal.socket.send("~"+String.fromCharCode(e)):terminal.sendText?terminal.sendText(String.fromCharCode(e)):terminal.send(String.fromCharCode(e)),xterm.focus()):null!=terminal&&(terminal.m.TermSendKey(e),Q(t).blur()))}function showTermPasteDialog(){terminal&&!xxdialogMode&&(Q("pastebutton").blur(),setDialogMode(2,"粘贴",3,showTermPasteDialogEx,'<textarea id=d2pasteText style="width:100%;height:184px;resize:none"></textarea>'),Q("d2pasteText").focus())}function showTermPasteDialogEx(){terminal&&terminal.m.TermSendKeys(Q("d2pasteText").value)}function sendSpecialKey(){null!=xterm?("sshterminalrelay.ashx"==terminal.urlname?terminal.socket.send("~"+String.fromCharCode(Q("specialkeylist").value)):terminal.sendText(String.fromCharCode(Q("specialkeylist").value)),xterm.focus()):null!=terminal&&(terminal.m.TermSendKey(Q("specialkeylist").value),Q("specialkeylist").blur(),Q("specialkeylistinput").blur())}function setupFiles(){filesNode!=currentNode&&null!=files&&filesNode._id!=currentNode._id&&(files.Stop(),files=filesNode=null);var e=0!=(1&(filesNode=currentNode).conn)||3==filesNode.mtype;QE("p13Connect",e),QE("p13Connects",e),QV("p13Connect",null==files&&2==filesNode.mtype),QV("p13Connects",0!=(512&features2)&&null!=filesNode.agent&&3!=filesNode.agent.id&&4!=filesNode.agent.id&&0==(8388608&features2)),QV("p13Disconnect",null!=files),p13setActions()}function onFilesStateChange(e,t){setSessionActivity(),QV("p13Connect",0==t&&2==filesNode.mtype),QV("p13Connects",0==t&&512&features2&&null!=filesNode.agent&&3!=filesNode.agent.id&&4!=filesNode.agent.id&&0==(8388608&features2)),QV("p13Disconnect",0!=t);var n=StatusStrs[t];switch(3==t&&(2==files.contype&&(n+=", SFTP"),1==files.webRtcActive)&&(n+="，WebRTC"),Q("p13Status").textContent=n,t){case 0:QH("p13files",""),p13filetree=null,p13filetreelocation=[],QH("p13currentpath",""),QE("p13FolderUp",!1),QV("filesRecordIcon",!1),p13setActions(),null!=files&&(files.Stop(),files=null),"fileMsgDialog"==xxdialogTag&&setDialogMode(0),null!=uploadFile&&(p13uploadFileTransferDone(),uploadFile=null);break;case 3:if(p13filetreelocation=[],p13targetpath="",files){var i=[];try{i=JSON.parse(getstore("_devFilePaths","[]"))}catch(e){}for(var o=0;o<i.length;o++)i[o].n==currentNode._id&&(p13targetpath=i[o].p);p13filetreelocation=p13targetpath.split("/"),files.sendText({action:"ls",reqid:1,path:p13targetpath}),1==files.serverIsRecording&&QV("filesRecordIcon",!0)}}}function CreateRemoteFiles(e){var t={protocol:5};return t.onFileUpdate=e,t.xxStateChange=function(e){},t.ProcessData=function(e){t.onFileUpdate(e)},t}var autoConnectFilesTimer=null;function autoConnectFiles(e){autoConnectFilesTimer=null==autoConnectFilesTimer?setInterval(connectFiles,100):(clearInterval(autoConnectFilesTimer),null)}function connectFiles(e,t,n){p13clearConsoleMsg(),files?(files.Stop(),files=null):(files=CreateAgentRedirect(meshserver,CreateRemoteFiles(p13gotFiles),serverPublicNamePort,authCookie,authRelayCookie,domainUrl),2==t&&(files.urlname="sshfilesrelay.ashx"),files.contype=t,files.options={consent:n},files.attemptWebRTC=attemptWebRTC,files.webrtcconfig=webrtcconfiguration,files.onStateChanged=onFilesStateChange,files.onConsoleMessageChange=function(){files.consoleMessage?(Q("p13FilesConsoleMsg").innerHTML+=formatAgentConsoleMessage(files.consoleMessage,files.consoleMessageId,files.consoleMessageArgs),QV("p13FilesConsoleMsg",!0),null!=p13FilesConsoleMsgTimer&&clearTimeout(p13FilesConsoleMsgTimer),files.consoleMessageTimeout&&(p13FilesConsoleMsgTimer=setTimeout(p13clearConsoleMsg,1e3*files.consoleMessageTimeout))):p13clearConsoleMsg()},files.Start(filesNode._id)),p13clipboard=p13clipboardFolder=null,p13clipboardCut=0,p13updateClipview()}var p13sortorder,p13filetree=null,p13targetpath=null,p13filetreelocation=[];function p13fileOperationDialogEx(e){0==e&&null!=files&&files.sendText({action:"cancel"})}function p13gotFiles(t){if(0<t.length&&123!=t.charCodeAt(0))p13gotDownloadBinaryData(t);else{try{t=JSON.parse(decode_utf8(t))}catch(e){try{t=JSON.parse(t)}catch(e){return void console.log("Unable to parse: "+t)}}if("download"==t.action)p13gotDownloadCommand(t);else if("findfile"==t.action)xxdialogTag==t.reqid&&(null==t.r?(QE("d2findFilter",!0),QE("filefind_dlgOkButton",!0),xxdialogTag=null,""==Q("d2findResults").innerHTML&&QH("d2findResults","<div style=text-align:center;margin:10px><i>找不到文件</i></div>")):QA("d2findResults","<div style=white-space:nowrap>"+EscapeHtml(t.r)+"</div>"));else if(null!=t.action&&t.action.startsWith("upload"))p13gotUploadData(t);else{switch(t.action){case"sshauth":return void sshTunnelAuthDialog(t,p13sshConnectEx);case"autherror":return void p13setConsoleMsg("授权错误",5e3);case"connectionerror":return void p13setConsoleMsg("连接错误",5e3);case"sessionerror":return void p13setConsoleMsg("会话已过期",5e3);case"sessiontimeout":return void p13setConsoleMsg("会话超时",5e3)}if("dialogmessage"==t.action)null==t.msg&&"fileMsgDialog"==xxdialogTag?setDialogMode(0):"zipping"!=t.msg||xxdialogMode&&"fileMsgDialog"!=xxdialogTag?"unzipping"!=t.msg||xxdialogMode&&"fileMsgDialog"!=xxdialogTag?"unziperror"!=t.msg||xxdialogMode&&"fileMsgDialog"!=xxdialogTag?"zippingFile"!=t.msg||xxdialogMode&&"fileMsgDialog"!=xxdialogTag||setDialogMode(2,"档案操作",10,p13fileOperationDialogEx,"<div style=margin:10px>"+EscapeHtml(t.file)+"</div><br /><progress value="+EscapeHtml(t.progress)+" style=width:100% max=100 />","fileMsgDialog"):setDialogMode(2,"档案操作",10,null,"<div style=margin:10px>Unzipping Error</div><br />"+EscapeHtml(t.error),"fileMsgDialog"):setDialogMode(2,"档案操作",10,null,"<div style=margin:10px>Unzipping file...</div>","fileMsgDialog"):setDialogMode(2,"档案操作",10,p13fileOperationDialogEx,"<div style=margin:10px>压缩档案...</div>","fileMsgDialog");else if("refresh"==t.action)p13folderup(9999);else if(null!=t.path)if(null==t.dir)""!=p13targetpath&&p13folderup();else if(t.path=t.path.replace(/\//g,"\\"),null!=p13filetree&&t.path==p13filetree.path){var e=p13getCheckedNames();p13filetree=t,p13updateFiles(e)}else{for(var n=t.path.replace(/\//g,"\\"),i=p13targetpath.replace(/\//g,"\\");0<n.length&&"\\"==n[0];)n=n.substring(1);for(;0<i.length&&"\\"==i[0];)i=i.substring(1);(n==i||"\\"==t.path&&""==p13targetpath)&&(p13filetree=t,p13updateFiles())}}}}function p13sshConnectEx(e){var t,n,i;0==e?null!=files&&connectFiles():(t=0,1==Q("dp2authmethod").value?(0==(4194304&features2)&&(t=Q("dp2keep").checked?1:0),files.socket.send(JSON.stringify({action:"sshauth",username:Q("dp2user").value,password:Q("dp2pass").value,keep:t}))):3==Q("dp2authmethod").value?files.socket.send(JSON.stringify({action:"sshkeyauth",keypass:Q("dp2keypass2").value})):(0==(4194304&features2)&&1==(t=Q("dp2keep1").checked?1:0)&&(t+=Q("dp2keep2").checked?1:0),e=new FileReader,n=Q("dp2user").value,i=Q("dp2keypass").value,e.onload=function(e){files.socket.send(JSON.stringify({action:"sshauth",username:n,keypass:i,key:e.target.result,keep:t}))},e.readAsText(Q("dp2key").files[0])))}function p13getCheckedNames(){for(var e=[],t=document.getElementsByName("fd"),n=0;n<t.length;n++)t[n].checked&&e.push(p13filetree.dir[t[n].value].n);return e}function p13updateFiles(e){var t="",n="",i='<a href=# style=cursor:pointer onclick="return p13folderup(0)">根</a>';if(null!=p13filetree){var o=p13filetree.path.split("\\");for(h in p13filetreelocation=[],o)""!=o[h]&&p13filetreelocation.push(o[h]);for(h in p13filetreelocation)i+=' / <a href=# style=cursor:pointer onclick="return p13folderup('+(parseInt(h)+1)+')">'+EscapeHtml(p13filetreelocation[h])+"</a>";var s=p13filetreelocation.join("/"),a=p13sort_files(p13filetree.dir);for(h in a){var r=a[h],l=r.n,d=70<l.length?'<span title="'+EscapeHtml(l)+'">'+EscapeHtml(l.substring(0,70))+"...</span>":EscapeHtml(l),c="",u=(null!=r.d&&(u=new Date(r.d),c=printDateTime(u="number"==typeof r.d?new Date(1e3*r.d):u)+"&nbsp;"),"");if(null!=r.s){var p=["Bytes","KB","MB","GB","TB"];let e=parseInt(Math.floor(Math.log(Math.abs(r.s))/Math.log(1024)),10);var m=Q("p13sizedropdown").options[Q("p13sizedropdown").selectedIndex],u=0==Q("p13sizedropdown").value?0===r.s?"n/a":0===e?r.s+" "+p[e]:(r.s/1024**e).toFixed(2)+" "+p[e]:1==Q("p13sizedropdown").value?getFileSizeStr(r.s):(r.s/2**m.value).toFixed(2)+" "+m.title}p="";r.t<3?(p="<div class=filelist file=999>",p=(p+="<input file=999 style=float:left name=fd class=fcb type=checkbox onchange=p13setActions() value='"+r.nx+'\'>&nbsp;<span style=float:right title=""></span>')+"<span><div class=fileIcon"+("REMOVABLE"==r.dt?5:"CDROM"==r.dt?6:r.t)+' onclick=p13folderset("'+encodeURIComponentEx(r.nx)+'")></div><a href=# style=cursor:pointer onclick=\'return p13folderset("'+encodeURIComponentEx(r.nx)+"\")'>",isWindowsNode(currentNode)&&r.dt&&currentNode.volumes&&currentNode.volumes[d.charAt(0).toUpperCase()]&&currentNode.volumes[d.charAt(0).toUpperCase()].name?p+=currentNode.volumes[d.charAt(0).toUpperCase()].name+" ("+d+")":p+=d,p+="</a></span></div>"):(m=d,0<r.s&&(m=3==filesNode.mtype?"<a href=# style=cursor:pointer onclick=\"return p13downloadfile('"+encodeURIComponentEx(s+"/"+l)+"','"+encodeURIComponentEx(l)+"',"+r.s+')">'+d+"</a>":'<a onclick=downloadFile("devicefile.ashx?c='+authCookie+"&m="+currentNode.meshid.split("/")[2]+"&n="+currentNode._id.split("/")[2]+"&f="+encodeURIComponentEx(s+"/"+l)+'","'+encodeURIComponentEx(l)+'") style=cursor:pointer>'+d+"</a>"),p="<div id=fileEntry cmenu=filesContextMenu fileIndex="+h+" class=filelist file=3><input file=3 style=float:left name=fd class=fcb type=checkbox onchange=p13setActions() value='"+r.nx+"'>&nbsp;<span class=fsize>"+c+"</span><span style=float:right>"+EscapeHtml(u)+"</span><span><div class=fileIcon"+r.t+"></div>"+m+"</span></div>"),r.t<3?t+=p:n+=p}if(QH("p13files",t+n),QH("p13currentpath",i),QE("p13FolderUp",0!=p13filetreelocation.length),null!=e)for(var g=document.getElementsByName("fd"),h=0;h<g.length;h++)0<=e.indexOf(p13filetree.dir[g[h].value].n)&&(g[h].checked=!0);p13setActions()}}function p13openfilefolder(){setDialogMode(2,"Open File/Folder",3,p13openfilefolderEx,"Are you sure you want to open this file/folder on the remote devices desktop ?")}function p13openfilefolderEx(){for(var e="",t=document.getElementsByName("fd"),n=0;n<t.length;n++)t[n].checked&&(e=(isWindowsNode(currentNode)?"":"/")+p13filetreelocation.join(isWindowsNode(currentNode)?"\\":"/")+(isWindowsNode(currentNode)?"\\":"/")+p13filetree.dir[t[n].value].n);""!=e&&files.sendText({action:"open",reqid:1,path:e,dir:1==p13getFileSelDirCount()})}function p13gotofolder(){setDialogMode(2,"Go To Folder",3,p13gotofolderEx,'<input type=text id=p13folderinput style=width:100% placeholder="'+(isWindowsNode(currentNode)?"C:\\":"/var/www")+'" />'),focusTextBox("p13folderinput")}function p13gotofolderEx(){p13targetpath=Q("p13folderinput").value.split("\\").join("/"),files&&(p13storeCurrentPath(p13targetpath),files.sendText({action:"ls",reqid:1,path:p13targetpath}))}function p13folderset(e){p13targetpath=joinPaths(p13filetree.path,p13filetree.dir[e].n).split("\\").join("/"),files&&(p13storeCurrentPath(p13targetpath),files.sendText({action:"ls",reqid:1,path:p13targetpath}))}function p13folderup(e){if(null==e)p13filetreelocation.pop();else for(;p13filetreelocation.length>e;)p13filetreelocation.pop();return p13targetpath=p13filetreelocation.join("/"),files&&(p13storeCurrentPath(p13targetpath),files.sendText({action:"ls",reqid:1,path:p13targetpath})),!1}function p13storeCurrentPath(e){var t=[],n=-1;try{t=JSON.parse(getstore("_devFilePaths","[]"))}catch(e){}for(var i=0;i<t.length;i++)t[i].n==currentNode._id&&(n=i);for(0<=n&&t.splice(n,1),t.push({n:currentNode._id,p:e});40<t.length;)t.shift();putstore("_devFilePaths",JSON.stringify(t))}function p13findfile(){var e;xxdialogMode||(e=addHtmlValue("过滤",'<input id=d2findFilter style="width:230px" onkeyup=p13findfileValidate() onkeydown=p13findfileDown(event) placeholder="*.txt"></input>'),setDialogMode(2,"查找文件",0,null,e=(e+='<div id=d2findResults style="width:100%;height:184px;background-color:white;border:1px solid black;padding:3px;overflow:scroll;margin-top:8px"></div>')+"<div style=margin-top:8px><input id=filefind_dlgCancelButton type=button value=关 style=float:right;width:80px;margin-left:5px onclick=p13findfileCancel()>"+"<input id=filefind_dlgOkButton type=submit value=搜寻 style=float:right;width:80px onclick=p13findfileEx()><br /><br /></div>"),p13findfileValidate(),Q("d2findFilter").focus())}function p13findfileDown(e){"输入"==e.code&&p13findfileEx()}function p13findfileValidate(){QE("filefind_dlgOkButton",0<Q("d2findFilter").value.length)}function p13findfileCancel(){null!=xxdialogTag&&files.sendText({action:"cancelfindfile",reqid:xxdialogTag}),dialogclose(0)}function p13findfileEx(e,t){var n,i,o;0!=Q("d2findFilter").value.length&&(n=0<currentNode.agent.id&&currentNode.agent.id<5||14==currentNode.agent.id||34==currentNode.agent.id,o=p13filetreelocation.join(i=n?"\\":"/")+i,n||(o=i+o),xxdialogTag="find:"+Math.random(),files.sendText({action:"findfile",reqid:xxdialogTag,path:o,filter:Q("d2findFilter").value}),QH("d2findResults",""),QE("d2findFilter",!1),QE("filefind_dlgOkButton",!1))}function p13sort_filename(e,t){return e.ln>t.ln?+p13sortorder:e.ln<t.ln?-1*p13sortorder:0}function p13sort_timestamp(e,t){return e.d>t.d?+p13sortorder:e.d<t.d?-1*p13sortorder:0}function p13sort_bysize(e,t){return e.s==t.s?p13sort_filename(e,t):(e.s-t.s)*p13sortorder}function p13sort_files(e){var t,n=[],i=Q("p13sortdropdown").value;for(t in e)e[t].nx=t,null==e[t].s&&(e[t].s=0),null==e[t].n&&(e[t].n=t),e[t].ln=e[t].n.toLowerCase(),n.push(e[t]);return p13sortorder=1,3<i&&(p13sortorder=-1,i-=3),1==i?n.sort(p13sort_filename):2==i?n.sort(p13sort_bysize):3==i&&n.sort(p13sort_timestamp),n}function p13setActions(){var e,t,n,i,o=null!=currentNode.agent&&14!=currentNode.agent.id;null==p13filetree?(QE("p13DeleteFileButton",!1),QE("p13NewFolderButton",!1),QE("p13UploadButton",!1),QE("p13RenameFileButton",!1),QE("p13ViewFileButton",!1),QE("p13SelectAllButton",!1),Q("p13SelectAllButton").value="全选",QE("p13RefreshButton",!1),QE("p13FindButton",!1),QE("p13CutButton",!1),QE("p13CopyButton",!1),QE("p13ZipButton",!1),QE("p13UnZipButton",!1),QE("p13PasteButton",!1),QE("p13GoToFolderButton",!1),QE("p13DownloadButton",!1),QE("p13OpenButton",!1)):(e=p13getFileSelCount(),t=p13getFileCount(),n=p13getFileSelCount(!1),i=0<currentNode.agent.id&&currentNode.agent.id<5||14==currentNode.agent.id||34==currentNode.agent.id,QE("p13DeleteFileButton",0<e&&(0<p13filetreelocation.length||0==i)),QE("p13NewFolderButton",o&&(0<p13filetreelocation.length||0==i)),QE("p13UploadButton",0<p13filetreelocation.length||0==i||14==currentNode.agent.id),QE("p13RenameFileButton",o&&1==e&&(0<p13filetreelocation.length||0==i)),QE("p13ViewFileButton",o&&1==e&&1==n&&(0<p13filetreelocation.length||0==i)),QE("p13SelectAllButton",0<t),Q("p13SelectAllButton").value=0<e?"取消全选":"全选",QE("p13RefreshButton",!0),QE("p13FindButton",o&&(0<p13filetreelocation.length||0==i)),QE("p13CutButton",o&&0<e&&e==n&&(0<p13filetreelocation.length||0==i)),QE("p13CopyButton",o&&0<e&&e==n&&(0<p13filetreelocation.length||0==i)),QE("p13ZipButton",o&&0<e&&(0<p13filetreelocation.length||0==i)),QE("p13UnzipButton",o&&1==e&&1==n&&(0<p13filetreelocation.length||0==i)&&p13getFileSelAllowedExt(".zip")),QE("p13PasteButton",o&&(0<p13filetreelocation.length||0==i)&&null!=p13clipboard&&0<p13clipboard.length),QE("p13GoToFolderButton",o),QE("p13OpenButton",o&&1==e),QE("p13DownloadButton",0<e&&e==n&&(0<p13filetreelocation.length||0==i))),1==(null!=files&&0!=files.state)&&2!=files.contype||null==filesNode.agent||3==filesNode.agent.id||4==filesNode.agent.id?QH("filesCustomUpperRight",""):QH("filesCustomUpperRight","<a style=cursor:pointer onclick=cmsshportaction(1,event)>"+format("SSH 端口 {0}",filesNode.sshport||22)+"</a>"),QV("filesActionsBtn",3!=filesNode.mtype),QV("p13FindButton",3!=filesNode.mtype),QV("p13CutButton",3!=filesNode.mtype),QV("p13CopyButton",3!=filesNode.mtype),QV("p13ZipButton",3!=filesNode.mtype),QV("p13UnzipButton",3!=filesNode.mtype),QV("p13PasteButton",3!=filesNode.mtype)}function p13getFileSelCount(e){for(var t=0,n=document.getElementsByName("fd"),i=0;i<n.length;i++)!n[i].checked||0==e&&"3"!=n[i].attributes.file.value||t++;return t}function p13getFileSelDirCount(){for(var e=0,t=document.getElementsByName("fd"),n=0;n<t.length;n++)t[n].checked&&"999"==t[n].attributes.file.value&&e++;return e}function p13getFileCount(){return document.getElementsByName("fd").length}function p13getFileSelAllowedExt(e){for(var t=document.getElementsByName("fd"),n=0;n<t.length;n++)if(t[n].checked&&!p13filetree.dir[t[n].value].n.endsWith(e))return!1;return!0}function p13selectallfile(){for(var e=0==p13getFileSelCount(),t=document.getElementsByName("fd"),n=0;n<t.length;n++)t[n].checked=e;p13setActions()}function p13createfolder(){setDialogMode(2,"新建文件夹",3,p13createfolderEx,"<input type=text id=p13renameinput maxlength=64 onkeyup=p13fileNameCheck(event) style=width:100% />"),focusTextBox("p13renameinput"),p13fileNameCheck()}function p13createfolderEx(){files.sendText({action:"mkdir",reqid:1,path:p13filetreelocation.join("/")+"/"+Q("p13renameinput").value}),p13folderup(999)}function p13deletefile(){var e=p13getFileSelCount(),t=0<p13getFileSelDirCount()?"<br /><br /><label><input type=checkbox id=p13recdeleteinput>递归删除</label><br>":"<input type=checkbox id=p13recdeleteinput style='display:none'>";setDialogMode(2,"删除",3,p13deletefileEx,1<e?format("删除{0}个所选项目？",e)+t:"删除所选项目？"+t)}function p13deletefileEx(){for(var e=[],t=document.getElementsByName("fd"),n=0;n<t.length;n++)t[n].checked&&e.push(p13filetree.dir[t[n].value].n);files.sendText({action:"rm",reqid:1,path:p13filetreelocation.join("/"),delfiles:e,rec:Q("p13recdeleteinput").checked}),p13folderup(999)}function p13renamefile(){for(var e,t=document.getElementsByName("fd"),n=0;n<t.length;n++)t[n].checked&&(e=p13filetree.dir[t[n].value].n);setDialogMode(2,"改名",3,p13renamefileEx,'<input type=text id=p13renameinput maxlength=64 onkeyup=p13fileNameCheck(event) style=width:100% value="'+e+'" />',{action:"rename",path:p13filetreelocation.join("/"),oldname:e}),focusTextBox("p13renameinput"),p13fileNameCheck()}function p13renamefileEx(e,t){t.newname=Q("p13renameinput").value,files.sendText(t),p13folderup(999)}function p13fileNameCheck(e){var t=isFilenameValid(Q("p13renameinput").value);QE("idx_dlgOkButton",t),1==t&&null!=e&&13==e.keyCode&&dialogclose(1)}function p13uploadFile(){setDialogMode(2,"上传文件",3,p13uploadFileEx,"<input type=file name=files id=p13uploadinput style=width:100% multiple=multiple onchange=\"updateUploadDialogOk('p13uploadinput')\" />"),updateUploadDialogOk("p13uploadinput")}function updateUploadDialogOk(e){QE("idx_dlgOkButton",0<Q("p13uploadinput").files.length)}function p13uploadFileEx(){p13doUploadFiles(Q("p13uploadinput").files)}function p13viewfile(){for(var e=document.getElementsByName("fd"),t=0;t<e.length;t++)if(e[t].checked){p13filetree.dir[e[t].value].s<=204800?p13downloadfile(encodeURIComponentEx(p13filetreelocation.join("/")+"/"+p13filetree.dir[e[t].value].n),encodeURIComponentEx(p13filetree.dir[e[t].value].n),p13filetree.dir[e[t].value].s,"viewer"):messagebox("文件编辑器","只能编辑小于200k的文件。");break}}function p13unzipFile(){for(var e,t,n,i=document.getElementsByName("fd"),o=0;o<i.length;o++)i[o].checked&&(e=isWindowsNode(currentNode)?"\\":"/",t=(isWindowsNode(currentNode)?"":"/")+p13filetreelocation.join(e)+e+p13filetree.dir[i[o].value].n.split(".zip")[0]+e,n=(isWindowsNode(currentNode)?"":"/")+p13filetreelocation.join(e)+e+p13filetree.dir[i[o].value].n);setDialogMode(2,"Unzip To Folder",3,p13unzipFileEx,'<input type=text id=p13unzipfolderinput maxlength=64 style=width:100% value="'+t+'" />',{action:"unzip",input:n}),focusTextBox("p13unzipfolderinput")}function p13unzipFileEx(e,t){t.dest=Q("p13unzipfolderinput").value,files.sendText(t)}function p13zipFiles(){for(var e=[],t=document.getElementsByName("fd"),n=0;n<t.length;n++)t[n].checked&&e.push(p13filetree.dir[t[n].value].n);setDialogMode(2,"压缩文件名",3,p13zipFilesEx,'<input type=text id=p13renameinput maxlength=64 onkeyup=p13fileNameCheck(event) style=width:100% value="" />',{action:"zip",path:p13filetreelocation.join("/"),files:e}),focusTextBox("p13renameinput"),p13fileNameCheck()}function p13zipFilesEx(e,t){t.output=Q("p13renameinput").value,t.output.toLowerCase().endsWith(".zip")||(t.output+=".zip"),files.sendText(t)}var p13clipboard=null,p13clipboardFolder=null,p13clipboardCut=0;function p13copyFile(e){var t=document.getElementsByName("fd");p13clipboard=[],p13clipboardCut=e,p13clipboardFolder=p13targetpath;for(var n=0;n<t.length;n++)t[n].checked&&"3"==t[n].attributes.file.value&&p13clipboard.push(p13filetree.dir[t[n].value].n);p13updateClipview()}function p13pasteFile(){var e="";setDialogMode(2,"粘贴",3,p13pasteFileEx,e=null!=p13clipboard&&0<p13clipboard.length?0==p13clipboardCut?1<p13clipboard.length?format("确认{0}个条目的复制到此位置？",p13clipboard.length):format("确认将1个副本复制到此位置？"):1<p13clipboard.length?format("确认将{0}个条目移到此位置？",p13clipboard.length):format("确认将1个条目移动到此位置？"):e)}function p13pasteFileEx(){files.sendText({action:0==p13clipboardCut?"copy":"move",reqid:1,scpath:p13clipboardFolder,dspath:p13targetpath,names:p13clipboard}),p13folderup(999),1==p13clipboardCut&&(p13clipboardFolder=p13clipboard=null,p13clipboardCut=0,p13updateClipview())}function p13updateClipview(){var e="";null!=p13clipboard&&0<p13clipboard.length&&(e=0==p13clipboardCut?1<p13clipboard.length?format('保存{0}个条目进行复制, <a href=# onclick="return p13clearClip()" style=cursor:pointer>清除</a>.',p13clipboard.length):format('保存1个条目进行复制, <a href=# onclick="return p13clearClip()" style=cursor:pointer>清除</a>.'):1<p13clipboard.length?format('保存{0}个条目以进行移动, <a href=# onclick="return p13clearClip()" style=cursor:pointer>清除</a>.',p13clipboard.length):format('保存1个项目进行移动, <a href=# onclick="return p13clearClip()" style=cursor:pointer>清除</a>.')),QH("p13bottomstatus",e),p13setActions()}function p13clearClip(){return p13clipboardFolder=p13clipboard=null,p13clipboardCut=0,p13updateClipview(),!1}function p13fileDragDrop(e){if(haltEvent(e),QV("p13bigfail",!1),QV("p13bigok",!1),null!=e.dataTransfer&&0!=e.dataTransfer.files.length&&null!=p13filetree){var t,n=[];for(t in e.dataTransfer.files)null!=e.dataTransfer.files[t].size&&0!=e.dataTransfer.files[t].size&&n.push(e.dataTransfer.files[t]);0!=n.length&&p13doUploadFiles(n)}}var gdownloadFile,p13dragtimer=null;function p13fileDragOver(e){haltEvent(e),null!=p13dragtimer&&(clearTimeout(p13dragtimer),p13dragtimer=null);e=null!=p13filetree;QV("p13bigok",e),QV("p13bigfail",!e)}function p13fileDragLeave(e){haltEvent(e),"p13filetable"!=e.target.id?(QV("p13bigfail",!1),QV("p13bigok",!1)):p13dragtimer=setTimeout(function(){QV("p13bigfail",!1),QV("p13bigok",!1),p13dragtimer=null},10)}function p13downloadfile(e,t,n,i){!xxdialogMode&&files&&(gdownloadFile={path:decodeURIComponent(e),file:decodeURIComponent(t),size:n,tsize:0,data:"",state:0,id:Math.random(),tag:i},files.sendText({action:"download",sub:"start",id:gdownloadFile.id,path:gdownloadFile.path}),setDialogMode(2,"下载文件",10,p13downloadFileCancel,"<div>"+EscapeHtml(gdownloadFile.file)+"</div><br /><progress id=d2progressBar style=width:100% value=0 max="+n+" />"))}function p13downloadFileCancel(){setDialogMode(0),files.sendText({action:"download",sub:"cancel",id:gdownloadFile.id}),gdownloadFile=null}function p13gotDownloadCommand(e){null!=gdownloadFile&&e.id==gdownloadFile.id&&("start"==e.sub?(gdownloadFile.state=1,files.sendText({action:"download",sub:"startack",id:gdownloadFile.id})):"cancel"==e.sub&&(gdownloadFile=null,setDialogMode(0)))}function p13gotDownloadBinaryData(e){gdownloadFile&&0!=gdownloadFile.state&&(4<e.length&&(gdownloadFile.tsize+=e.length-4,gdownloadFile.data+=e.substring(4),Q("d2progressBar").value=gdownloadFile.tsize),0!=(1&ReadInt(e,0))?"viewer"==gdownloadFile.tag?(setDialogMode(4,EscapeHtml(gdownloadFile.file),3,p13editSaveBack,null,gdownloadFile.file),QV("d4EncodingButton",!0),QV("d4LineBreakButton",!0),QS("dialog").width="auto",QS("dialog").bottom="80px",QS("dialog").top=QS("dialog").left=QS("dialog").right="100px",Q("d4editorarea").value=1==d4EditEncodingVal?decode_utf8(gdownloadFile.data):gdownloadFile.data,gdownloadFile=null):(saveAs(data2blob(gdownloadFile.data),gdownloadFile.file),gdownloadFile=null,setDialogMode(0)):files.sendText({action:"download",sub:"ack",id:gdownloadFile.id}))}function p13downloadButton(){for(var e,t,n=document.getElementsByName("fd"),i=0;i<n.length;i++)n[i].checked&&(e=p13filetree.dir[n[i].value],t="devicefile.ashx?c="+authCookie,downloadFile(t=(t=(t+="&m="+currentNode.meshid.split("/")[2])+("&n="+currentNode._id.split("/")[2]))+("&f="+encodeURIComponentEx(p13filetreelocation.join("/")+"/"+e.n)),encodeURIComponentEx(e.n)))}var uploadFile,d4EditWrapVal=0,d4EditSizeVal=0,d4EditEncodingVal=0,d4EditLineBreakVal=0;function d4ToggleWrap(e){e||(d4EditWrapVal=++d4EditWrapVal%2),Q("d4WrapButton").value=["换行：开","换行：关"][d4EditWrapVal],QS("d4editorarea").overflow=0==d4EditWrapVal?"auto":"scroll",QS("d4editorarea")["white-space"]=0==d4EditWrapVal?null:"pre",putstore("editorWrap",d4EditWrapVal)}function d4ToggleSize(e){e||(d4EditSizeVal=++d4EditSizeVal%4),QS("d4editorarea")["font-size"]=["100%","125%","150%","200%"][d4EditSizeVal],Q("d4SizeButton").value=["缩放：100％","缩放：125％","缩放：150％","缩放：200％"][d4EditSizeVal],putstore("editorSize",d4EditSizeVal)}function d4ToggleEncoding(e){e||(d4EditEncodingVal=++d4EditEncodingVal%2,Q("d4editorarea").value=(1==d4EditEncodingVal?decode_utf8:encode_utf8)(Q("d4editorarea").value)),Q("d4EncodingButton").value=["编码：RAW","编码：UTF8"][d4EditEncodingVal],putstore("editorEncoding",d4EditEncodingVal)}function d4ToggleLineBreak(e){e||(d4EditLineBreakVal=++d4EditLineBreakVal%3),Q("d4LineBreakButton").value=["Line Break: Windows (CR LF)","Line Break: Linux (LF)","Line Break: Mac (CR)"][d4EditLineBreakVal],putstore("editorLineBreak",d4EditLineBreakVal)}function p13editSaveBack(e,t){var n=Q("d4editorarea").value,n=0===d4EditLineBreakVal?n.replace(/\r?\n|\r/g,"\r\n"):2===d4EditLineBreakVal?n.replace(/\r\n|\n/g,"\r"):n.replace(/\r\n|\r/g,"\n"),n=1==d4EditEncodingVal?(new TextEncoder).encode(n):(new TextEncoder).encode(decode_utf8(n));p13uploadFileContinue(1,[{name:t,size:n.byteLength,type:"text/plain",xdata:n}])}function p13doUploadFiles(e){if(!xxdialogMode){var t=0<currentNode.agent.id&&currentNode.agent.id<5||14==currentNode.agent.id||34==currentNode.agent.id,n=[],i=0;for(o in p13filetree.dir)n.push(t?p13filetree.dir[o].n.toLowerCase():p13filetree.dir[o].n);for(var o=0;o<e.length;o++)t?0<=n.indexOf(e[o].name.toLowerCase())&&i++:0<=n.indexOf(e[o].name)&&i++;0==i?p13uploadFileContinue(1,e):setDialogMode(2,"上传文件",3,p13uploadFileContinue,format(1==i?"上传将覆盖1个文件。继续？":"上传将覆盖{0}个文件。继续？",i),e)}}function p13uploadFileContinue(e,t){(uploadFile={}).xpath=p13filetreelocation.join("/"),uploadFile.xfiles=t,uploadFile.xfilePtr=-1,setDialogMode(2,"上传文件",10,p13uploadFileCancel,"<div id=p13dfileName>正在连线...</div><br /><progress id=d2progressBar style=width:100% value=0 max=0 />"),p13uploadNextFile()}let byteToHex=[];for(var n=0;n<=255;++n){var hexOctet=n.toString(16).padStart(2,"0");byteToHex.push(hexOctet)}function arrayBufferToHex(e){return Array.prototype.map.call(new Uint8Array(e),e=>byteToHex[e]).join("")}function performHash(e,t){window.crypto.subtle.digest("SHA-384",e).then(function(e){t(arrayBufferToHex(e))},function(){t(null)})}function performHashOnFile(e,t){var n=new FileReader;n.onerror=function(e){t(null)},n.onload=function(){window.crypto.subtle.digest("SHA-384",n.result).then(function(e){t(arrayBufferToHex(e))},function(){t(null)})},n.readAsArrayBuffer(e)}function p13uploadNextFile(){if(uploadFile.xfilePtr++,uploadFile.xfiles.length>uploadFile.xfilePtr){uploadFile.xptr=0;var t=uploadFile.xfiles[uploadFile.xfilePtr];if(QH("p13dfileName",EscapeHtml(t.name)),Q("d2progressBar").max=t.size,Q("d2progressBar").value=0,null==t.xdata){uploadFile.xfile=t;var e,n=null;for(e in p13filetree.dir)p13filetree.dir[e].n==t.name&&(n=p13filetree.dir[e]);null!=n&&n.s<=uploadFile.xfile.size?performHashOnFile(uploadFile.xfile,function(e){files.sendText(JSON.stringify({action:"uploadhash",reqid:uploadFile.xfilePtr,path:uploadFile.xpath,name:t.name,tag:{h:e.toUpperCase(),s:n.s,skip:n.s==uploadFile.xfile.size}}))}):files.sendText(JSON.stringify({action:"upload",reqid:uploadFile.xfilePtr,path:uploadFile.xpath,name:t.name,size:uploadFile.xfile.size}))}else uploadFile.xdata=t.xdata,files.sendText(JSON.stringify({action:"upload",reqid:uploadFile.xfilePtr,path:uploadFile.xpath,name:t.name,size:uploadFile.xdata.byteLength}))}else p13uploadFileTransferDone()}function p13uploadFileCancel(e,t){null!=uploadFile&&(files.sendText(JSON.stringify({action:"uploadcancel",reqid:uploadFile.xfilePtr})),uploadFile=null),p13uploadFileTransferDone()}function p13uploadFileTransferDone(){uploadFile=null,setDialogMode(0),p13folderup(9999)}function p13gotUploadData(e){if(null!=uploadFile&&parseInt(uploadFile.xfilePtr)==parseInt(e.reqid))switch(e.action){case"uploadstart":p13uploadNextPart(!(uploadFile.xdataPriming=8));break;case"uploadack":p13uploadNextPart(!1);break;case"uploaddone":(uploadFile.xfiles.length>uploadFile.xfilePtr+1?p13uploadNextFile:p13uploadFileTransferDone)();break;case"uploaderror":p13uploadFileCancel();break;case"uploadhash":var t=uploadFile.xfiles[uploadFile.xfilePtr];t&&(e.tag.h===e.hash?e.tag.skip?p13uploadNextFile():(uploadFile.xptr=e.tag.s,files.sendText(JSON.stringify({action:"upload",reqid:uploadFile.xfilePtr,path:uploadFile.xpath,name:t.name,size:uploadFile.xfile.size,append:!0}))):files.sendText(JSON.stringify({action:"upload",reqid:uploadFile.xfilePtr,path:uploadFile.xpath,name:t.name,size:uploadFile.xfile.size,append:!1})))}}function p13uploadNextPart(e){if(uploadFile.xdata){var t=uploadFile.xdata,n=uploadFile.xptr;if(n>=t.byteLength)files.sendText(JSON.stringify({action:"uploaddone",reqid:uploadFile.xfilePtr}));else{if((i=uploadFile.xptr+(attemptWebRTC?16384:65536))>t.byteLength){if(1==e)return;i=t.byteLength}t=new Uint8Array(t.slice(n,i));123==t[0]||0==t[0]?((n=new Uint8Array(i-n+1)).set(t,1),files.send(n)):files.send(t),uploadFile.xptr=i,Q("d2progressBar").value=i}}else if(uploadFile.xfile&&null==uploadFile.xreader&&!(uploadFile.xptr>=uploadFile.xfile.size)){var i;if((i=uploadFile.xptr+(attemptWebRTC?16384:65536))>uploadFile.xfile.size){if(1==e)return;i=uploadFile.xfile.size}uploadFile.xreader=new FileReader,uploadFile.xreader.onerror=function(e){console.log(e)},uploadFile.xreader.onload=function(){var e,t=uploadFile.xreader.result;delete uploadFile.xreader,null!=t&&(123==(e=new Uint8Array(t))[0]||0==e[0]?((t=new Uint8Array(t.byteLength+1)).set(e,1),files.send(t)):files.send(e),uploadFile.xptr=i,Q("d2progressBar").value=i,uploadFile.xptr>=uploadFile.xfile.size?files.sendText(JSON.stringify({action:"uploaddone",reqid:uploadFile.xfilePtr})):0<uploadFile.xdataPriming&&(uploadFile.xdataPriming--,p13uploadNextPart(!0)))},uploadFile.xreader.readAsArrayBuffer(uploadFile.xfile.slice(uploadFile.xptr,i))}}var currentDeviceEvents=null;function deviceEventsUpdate(){var e="",t=null;for(r in currentDeviceEvents){var n=currentDeviceEvents[r],i=new Date(n.time);if(n.msg){null==n.h&&(n.h=Math.random()),printDate(i)!=t&&(null!=t&&(e+="</table>"),e+="<table class=p3eventsTable cellpadding=0 cellspacing=0><tr><td colspan=4 class=DevSt>"+(t=printDate(i))+"</td></tr>");var o,s,a="si3";if("user"==n.etype&&(a="m2"),"server"==n.etype&&(a="si3"),null==n.msgid||null==eventsMessageId[n.msgid])o="string"==typeof n.msg?EscapeHtml(n.msg).split("(R)").join("&reg;"):"";else{for(var r in o=eventsMessageId[n.msgid],n.msgArgs){var l=n.msgArgs[r];"string"==typeof l&&0==l.indexOf("DATETIME:")&&(l=printFlexDateTime(new Date(parseInt(l.substring(9))))),o=o.split("{"+r+"}").join(l)}o=EscapeHtml(o).split("(R)").join("&reg;")}n.username&&(s="",n.guestname&&(s=' / <span title="这是嘉宾分享环节">'+EscapeHtml(n.guestname)+"</span>"),o=2&userinfo.siteadmin&&n.userid?"<a href=# onclick='gotoUser(\""+encodeURIComponentEx(n.userid)+"\");haltEvent(event);'>"+EscapeHtml(n.username)+"</a>"+s+" &rarr; "+o:EscapeHtml(n.username)+s+" &rarr; "+o),"relay"!=n.etype&&"relaylog"!=n.action||(a="relayIcon16"),e+="<tr onclick=showEventDetails("+n.h+",1) onmouseover=eventMouseHover(this,1) onmouseout=eventMouseHover(this,0) style=cursor:pointer><td style=width:18px><div class="+a+"></div></td><td class=g1>&nbsp;</td><td class=style10>"+printTime(i)+" - "+o+"</td><td class=g2>&nbsp;</td></tr><tr style=height:2px></tr>"}}null!=t&&(e+="</table>"),""==e&&(e="<br><i>找不到事件</i><br><br>"),QH("p16events",e)}function refreshDeviceEvents(){""!=p16filterevents.value?meshserver.send({action:"events",nodeid:currentNode._id,limit:parseInt(p16limitdropdown.value),filter:p16filterevents.value}):meshserver.send({action:"events",nodeid:currentNode._id,limit:parseInt(p16limitdropdown.value)})}function showEventDetails(e,t){if(xxdialogMode)return!1;var n,i;for(o in 1==t&&(n=currentDeviceEvents),2==t&&(n=events),n=3==t?currentUserEvents:n)if(n[o].h==e){i=n[o];break}if(i){var o,s="<div style=overflow-y:auto;max-height:300px>";for(o in i)"h"!=o&&"_id"!=o&&"ids"!=o&&"domain"!=o&&null!=i[o]&&("object"==typeof i[o]?s+=addHtmlValue3(EscapeHtml(o),EscapeHtml(JSON.stringify(i[o]))):s+=addHtmlValue3(EscapeHtml(o),EscapeHtml(i[o])));setDialogMode(2,"事件详情",9,null,s+="</div>")}}var deviceDetailsStats=null,deviceDetailsStatsTimer=null,deviceDetailsStatsData=[],deviceDetailsConfig={type:"line",data:{labels:[],datasets:[{label:"CPU",backgroundColor:"rgba(134, 16, 158, .5)",borderColor:"rgb(134, 16, 158)",data:[],fill:!0},{label:"内存",backgroundColor:"rgba(255, 99, 132, .5)",borderColor:"rgb(255, 99, 132)",data:[],fill:!0}]},options:{events:["click"],animation:!1,responsive:!0,maintainAspectRatio:!1,tooltips:{enabled:!1},elements:{line:{cubicInterpolationMode:"monotone"}},scales:{x:{type:"linear",display:!0,title:{display:!1,text:""},min:0,max:100,reverse:!0},y:{type:"linear",display:!0,title:{display:!1,text:""},min:0,max:100}}}};function deskToggleCpuGraph(){("none"==QS("p17graph").display?(QV("p17graph",!0),window.deviceDetailsStatsChart=new Chart(document.getElementById("deviceDetailsStats").getContext("2d"),deviceDetailsConfig),deviceDetailsStatsTimer=setInterval(deviceDetailsStatsTimerFunc,2e3),deviceDetailsStatsTimerFunc):deviceDetailsStatsClear)()}function deviceDetailsStatsClear(){QV("p17graph",!1),null!=window.deviceDetailsStatsChart&&(window.deviceDetailsStatsChart.destroy(),delete window.deviceDetailsStatsChart),null!=deviceDetailsStatsTimer&&(clearInterval(deviceDetailsStatsTimer),deviceDetailsStatsTimer=null),deviceDetailsStatsData=[],deviceDetailsStatsDraw(),QV("extraGraphValues",!1),QH("extraGraphValues","")}function deviceDetailsStatsTimerFunc(){null!=currentNode&&meshserver.send({action:"msg",type:"cpuinfo",nodeid:currentNode._id})}function deviceDetailsStatsDraw(e){for(var t=Date.now()/1e3-100;0<deviceDetailsStatsData.length&&deviceDetailsStatsData[0][0]<t-5;)deviceDetailsStatsData.shift();var n=[],i=[];for(s in deviceDetailsStatsData){var o=deviceDetailsStatsData[s];n.push({x:100-(o[0]-t),y:o[1]}),i.push({x:100-(o[0]-t),y:o[2]})}if(deviceDetailsConfig.data.datasets[0].data=n,deviceDetailsConfig.data.datasets[1].data=i,window.deviceDetailsStatsChart&&window.deviceDetailsStatsChart.update(),null!=e&&Array.isArray(e.thermals)&&0<e.thermals.length){var s,a="&nbsp;";for(s in e.thermals)a+='<div class=thermalSensor title="'+e.thermals[s].InstanceName+'">'+parseFloat(e.thermals[s].CurrentTemperature).toFixed(2)+"&deg;C / "+parseFloat(1.8*e.thermals[s].CurrentTemperature+32).toFixed(2)+"&deg;F</div>";QV("extraGraphValues",!0),QH("extraGraphValues",a)}}var consoleNode,DeviceDetailsHardware=null,DeviceDetailsNetwork=null,DeviceDetailsNodeId=null;function updateDeviceDetails(e,t,n){if(null!=currentNode&&(null==e&&(e=currentNode),currentNode._id==e._id)){DeviceDetailsNodeId!=e._id&&(DeviceDetailsNetwork=DeviceDetailsHardware=null,DeviceDetailsNodeId=e._id),null==(t=DeviceDetailsHardware=null!=t?t:DeviceDetailsHardware)&&(t={}),null==(n=DeviceDetailsNetwork=null!=n?n:DeviceDetailsNetwork)&&(n={});var i,o,s=[],a={},r="";if(e.rname&&(r+=addDetailItem("名称",EscapeHtml(e.rname),a)),t.windows&&t.windows.osinfo&&t.windows.osinfo.Description&&(r+=addDetailItem("描述",EscapeHtml(t.windows.osinfo.Description),a)),e.osdesc&&(r+=addDetailItem("版本",EscapeHtml(e.osdesc),a)),t.windows&&t.windows.osinfo&&((d=t.windows.osinfo).OSArchitecture&&(d.OSArchitecture.startsWith("32")?r+=addDetailItem("架构","32 位",a):d.OSArchitecture.startsWith("64")?r+=addDetailItem("架构","64 位",a):r+=addDetailItem("架构",EscapeHtml(d.OSArchitecture),a)),d.LastBootUpTime)&&(o={year:parseInt(d.LastBootUpTime.substring(0,4)),month:parseInt(d.LastBootUpTime.substring(4,6))-1,day:parseInt(d.LastBootUpTime.substring(6,8)),hours:parseInt(d.LastBootUpTime.substring(8,10)),minutes:parseInt(d.LastBootUpTime.substring(10,12)),seconds:parseInt(d.LastBootUpTime.substring(12,14))},r+=addDetailItem("Last Boot Up Time",printDateTime(new Date(o.year,o.month,o.day,o.hours,o.minutes,o.seconds)))),t.linux&&t.linux.LastBootUpTime&&(r+=addDetailItem("Last Boot Up Time",printDateTime(new Date(t.linux.LastBootUpTime)))),t.darwin&&t.darwin.LastBootUpTime&&(r+=addDetailItem("Last Boot Up Time",printDateTime(new Date(1e3*t.darwin.LastBootUpTime)))),""!=r&&s.push({name:"操作系统",html:r,img:"software64.png"}),e.agent&&(r="",null!=e.agent&&null!=e.agent.id&&null!=e.agent.ver&&(o="",o=e.agent.id<=agentsStr.length?agentsStr[e.agent.id]:agentsStr[0],0!=e.agent.ver&&(o+=" v"+e.agent.ver),r+=addDetailItem("Mesh代理",o=14==e.agent.id?e.agent.core:o)),0!=(1&e.conn)?r+=addDetailItem("上次代理连接","现在已连接"):e.lastconnect&&(r+=addDetailItem("上次代理连接",printDateTime(new Date(e.lastconnect)))),e.lastaddr&&(2<(o=e.lastaddr.split(":")).length?r+=addDetailItem("上次代理地址",e.lastaddr):isPrivateIP(e.lastaddr)?r+=addDetailItem("上次代理地址",o[0]):r+=addDetailItem("上次代理地址",'<a href="https://iplocation.com/?ip='+o[0]+'" rel="noreferrer noopener" target="MeshIPLoopup">'+o[0]+"</a>")),null!=t.agentvers&&t.agentvers.compileTime&&(o=Date.parse(t.agentvers.compileTime),r+=addDetailItem("编译时间",isNaN(o)?t.agentvers.compileTime:printDateTime(new Date(o)))),""!=r)&&s.push({name:"Mesh代理",html:r,img:"meshagent64.png"}),t.mobile&&(r="",t.mobile.brand&&t.mobile.model&&(r+=addDetailItem("模型",EscapeHtml(t.mobile.brand+", "+t.mobile.model),a)),t.mobile.device&&(r+=addDetailItem("设备",EscapeHtml(t.mobile.device),a)),t.mobile.bootloader&&(r+=addDetailItem("引导加载程序",EscapeHtml(t.mobile.bootloader),a)),t.mobile.id&&(r+=addDetailItem("识别码",EscapeHtml(t.mobile.id),a)),t.mobile.host&&(r+=addDetailItem("主机名",EscapeHtml(t.mobile.host),a)),t.mobile.androidapi&&t.mobile.androidrelease&&(r+=addDetailItem("Android Version",EscapeHtml(t.mobile.androidrelease+", API Level "+t.mobile.androidapi),a)),""!=r)&&s.push({name:"移动设备",html:r,img:"mobile64.png"}),null!=n.netif){var l={};for(v in n.netif)"string"==typeof(d=n.netif[v]).mac&&(null==l[d.mac]?(l[d.mac]=d,l[d.mac].ipv4layer=[{v4addr:d.v4addr,v4mask:d.v4mask,v4gateway:d.v4gateway}]):l[d.mac].ipv4layer.push({v4addr:d.v4addr,v4mask:d.v4mask,v4gateway:d.v4gateway}));var r="";for(v in r+="<table style=width:100%>",l){var d=l[v];for(p in r=(r+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>")+("<div style=margin-bottom:3px><b>"+EscapeHtml(d.name+(d.dnssuffix?", "+d.dnssuffix:""))+"</b></div>"),d.desc&&(r+=addDetailItem("描述",EscapeHtml(d.desc).split("(R)").join("&reg;"))),d.mac&&(d.gatewaymac?r+=addDetailItem("MAC层",format("MAC：{0}，网关：{1}",EscapeHtml(d.mac),EscapeHtml(d.gatewaymac))):d.mac&&(r+=addDetailItem("MAC层",format("MAC：{0}",EscapeHtml(d.mac))))),d.ipv4layer){var c=d.ipv4layer[p];c.v4gateway&&c.v4mask?r+=addDetailItem("IPv4层",format("IP：{0}，掩码：{1}，网关：{2}",EscapeHtml(c.v4addr),EscapeHtml(c.v4mask),EscapeHtml(c.v4gateway))):c.v4addr&&(r+=addDetailItem("IPv4层",format("IP：{0}",EscapeHtml(c.v4addr))))}r+="</div></td></tr>"}""!=(r+="</table>")&&s.push({name:"网络",html:r,img:"networking64.png"})}if(null!=n.netif2){var r="";for(v in r+="<table style=width:100%>",n.netif2){d=n.netif2[v];if(!(0==Array.isArray(d)||d.length<1||null==d[0]||"string"==typeof d[0].mac&&d[0].mac.startsWith("00:00:00:00"))){r+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>";var u="";null!=v&&(u+=v),null!=d[0].fqdn&&""!=d[0].fqdn&&(u+=", "+d[0].fqdn),0<u.length&&(r+="<div style=margin-bottom:3px><b>"+EscapeHtml(u)+"</b></div>"),d.desc&&(r+=addDetailItem("描述",EscapeHtml(d.desc).split("(R)").join("&reg;"))),"string"==typeof d[0].mac&&(d[0].gatewaymac?r+=addDetailItem("MAC层",format("MAC：{0}，网关：{1}",EscapeHtml(d[0].mac),EscapeHtml(d[0].gatewaymac))):r+=addDetailItem("MAC层",format("MAC：{0}",EscapeHtml(d[0].mac))));for(var p=0;p<d.length;p++){var m=d[p],g=[];m.address&&g.push(format("IP：{0}",EscapeHtml(m.address))),m.netmask&&g.push(format("掩码：{0}",EscapeHtml(m.netmask))),m.gateway&&g.push(format("网关：{0}",EscapeHtml(m.gateway))),0<g.length&&("IPv4"==m.family&&(r+=addDetailItem("IPv4层",g.join("，"))),"IPv6"==m.family)&&(r+=addDetailItem("IPv6层",g.join("，")))}r+="</div></td></tr>"}}t.network&&t.network.dns&&(r=(r+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>")+addDetailItem("<b>DNS Servers</b>",t.network.dns.join("，"))+"</div></td></tr>"),""!=(r+="</table>")&&s.push({name:"网络",html:r,img:"networking64.png"})}if(null!=e.intelamt&&(r="",r+=addDetailItem("版本",e.intelamt.ver?"v"+EscapeHtml(e.intelamt.ver):"<i>未知</i>",a),o=t.identifiers&&t.identifiers.product_uuid,r+=addDetailItem("识别码",e.intelamt.uuid?EscapeHtml(e.intelamt.uuid):o?EscapeHtml(o):"<i>未知</i>",a),o={0:nobreak("未激活"),1:nobreak("预激活"),2:nobreak("已激活")},i="",2==e.intelamt.state&&e.intelamt.flags&&(2&e.intelamt.flags?i=", 客户端控制模式（CCM）":4&e.intelamt.flags&&(i=", 管理员控制模式（ACM）")),""!=(r=(r=(r+=addDetailItem("配置状态",(e.intelamt.state?o[e.intelamt.state]:"<i>未知</i>")+i,a))+addDetailItem("安全",1==e.intelamt.tls?"已使用TLS保安":"未设置TLS",a))+addDetailItem("管理员凭证",null==e.intelamt.user||""==e.intelamt.user||null!=e.intelamt.warn&&0!=(9&e.intelamt.warn)?"未知":"已知的",a)))&&("number"==typeof e.intelamt.sku&&0!=(16&e.intelamt.sku)?s.push({name:"英特尔&reg; 标准可管理性（英特尔&reg; SM）",html:r,img:"amt64.png"}):s.push({name:"英特尔&reg;主动管理技术（英特尔&reg;AMT）",html:r,img:"amt64.png"})),t.identifiers){var r="",h=t.identifiers;if(h.bios_vendor&&(r+=addDetailItem("供应商",EscapeHtml(h.bios_vendor),a)),h.bios_version&&(r+=addDetailItem("版本",EscapeHtml(h.bios_version),a)),h.bios_serial&&(r+=addDetailItem("序列号",EscapeHtml(h.bios_serial),a)),h.bios_mode&&(r+=addDetailItem("Mode",EscapeHtml(h.bios_mode),a)),""!=r&&s.push({name:"的BIOS",html:r,img:"chip64.png"}),r="",h.board_vendor&&(r+=addDetailItem("供应商",EscapeHtml(h.board_vendor),a)),h.board_name&&(r+=addDetailItem("名称",EscapeHtml(h.board_name),a)),h.board_serial&&""!=h.board_serial&&(r+=addDetailItem("序列号",EscapeHtml(h.board_serial),a)),h.board_version&&(r+=addDetailItem("版本",EscapeHtml(h.board_version),a)),h.product_uuid&&(r+=addDetailItem("识别码",EscapeHtml(h.product_uuid),a)),h.cpu_name&&(r+=addDetailItem("CPU",EscapeHtml(h.cpu_name).split("(TM)").join("&trade;").split("(R)").join("&reg;"),a)),h.gpu_name)for(var v in h.gpu_name)r+=addDetailItem("GPU",EscapeHtml(h.gpu_name[v]).split("(TM)").join("&trade;").split("(R)").join("&reg;"),a);""!=r&&s.push({name:"母板",html:r,img:"motherboard64.png"})}if(t.tpm&&(r="",(o=t.tpm).SpecVersion&&(r+=addDetailItem("SpecVersion",parseFloat(EscapeHtml(o.SpecVersion)).toFixed(1),a)),o.ManufacturerId&&(r+=addDetailItem("ManufacturerId",EscapeHtml(o.ManufacturerId),a)),o.ManufacturerVersion&&(r+=addDetailItem("ManufacturerVersion",EscapeHtml(o.ManufacturerVersion),a)),null!=o.IsActivated&&(r+=addDetailItem("IsActivated",o.IsActivated?"Yes":"No",a)),null!=o.IsEnabled&&(r+=addDetailItem("IsEnabled",o.IsEnabled?"Yes":"No",a)),null!=o.IsOwned&&(r+=addDetailItem("IsOwned",o.IsOwned?"Yes":"No",a)),""!=r)&&s.push({name:"TPM",html:r,img:"tpm64.png"}),t.windows&&t.windows.memory&&0<t.windows.memory.length){r="";for(v in t.windows.memory.sort(function(e,t){return e.BankLabel>t.BankLabel?1:e.BankLabel<t.BankLabel?-1:0}),r+="<table style=width:100%>",t.windows.memory){d=t.windows.memory[v];r=(r+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>")+("<div style=margin-bottom:3px><b>"+EscapeHtml(d.BankLabel||d.DeviceLocator||"Unknown")+"</b></div>"),d.Capacity&&d.Speed?r+=addDetailItem("容量/速度",format("{0} Mb，{1} Mhz",d.Capacity/1024/1024,d.Speed),a):d.Capacity&&(r+=addDetailItem("容量",format("{0} Mb",d.Capacity/1024/1024),a)),d.PartNumber&&(r+=addDetailItem("零件号",EscapeHtml(d.Manufacturer&&"Undefined"!=d.Manufacturer?d.Manufacturer+", ":"")+EscapeHtml(d.PartNumber),a)),r+="</div>"}""!=(r+="</table>")&&s.push({name:"内存",html:r,img:"ram64.png"})}if(t.linux&&t.linux.memory&&0<t.linux.memory.Memory_Device.length){r="";for(v in t.linux.memory.Memory_Device.sort(function(e,t){return e.Locator>t.Locator?1:e.Locator<t.Locator?-1:0}),r+="<table style=width:100%>",t.linux.memory.Memory_Device)(d=t.linux.memory.Memory_Device[v]).Size&&"No Module Installed"==d.Size||(r=(r+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>")+"<div style=margin-bottom:3px><b>"+EscapeHtml(d.Locator||"Unknown")+"</b></div>",d.Size&&d.Speed?r+=addDetailItem("容量/速度",format("{0}, {1}",d.Size,d.Speed),a):d.Size&&(r+=addDetailItem("容量",format("{0}",d.Size),a)),d.PartNumber&&(r+=addDetailItem("零件号",EscapeHtml(d.Manufacturer&&"Undefined"!=d.Manufacturer?d.Manufacturer+", ":"")+EscapeHtml(d.PartNumber),a)),r+="</div>");""!=(r+="</table>")&&s.push({name:"内存",html:r,img:"ram64.png"})}if(t.darwin&&t.darwin.memory&&0<t.darwin.memory.length){r="";for(v in r+="<table style=width:100%>",t.darwin.memory)(d=t.darwin.memory[v]).Size&&"No Module Installed"==d.Size||(r=(r+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>")+"<div style=margin-bottom:3px><b>"+EscapeHtml(d.DeviceLocator||"Unknown")+"</b></div>",d.Size&&d.Speed?r+=addDetailItem("容量/速度",format("{0}, {1}",d.Size,d.Speed),a):d.Size&&(r+=addDetailItem("容量",format("{0}",d.Size),a)),d.PartNumber&&(r+=addDetailItem("零件号",EscapeHtml(d.Manufacturer&&""!=d.Manufacturer?d.Manufacturer+", ":"")+EscapeHtml(d.PartNumber),a)),r+="</div>");""!=(r+="</table>")&&s.push({name:"内存",html:r,img:"ram64.png"})}if(t.identifiers&&t.identifiers.storage_devices){var f,r="";for(v in h.storage_devices.sort(function(e,t){return e.Caption>t.Caption?1:e.Caption<t.Caption?-1:0}),r+="<table style=width:100%>",h.storage_devices)(d=h.storage_devices[v]).Size&&(r=(r+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>")+"<div style=margin-bottom:3px><b>"+EscapeHtml(d.Caption)+"</b></div>",d.Model&&d.Model!=d.Caption&&(r+=addDetailItem("模型",EscapeHtml(d.Model),a)),d.Size&&("string"==typeof d.Size&&parseInt(d.Size)==d.Size&&(d.Size=parseInt(d.Size)),"number"==typeof d.Size&&(r+=addDetailItem("容量",format("{0} Mb",Math.floor(d.Size/1024/1024)),a)),"string"==typeof d.Size)&&(r+=addDetailItem("容量",EscapeHtml(d.Size),a)),t.windows&&t.windows.drives&&d.Model&&(f=t.windows.drives.find(e=>e.Model===d.Model))&&f.Status&&(r+=addDetailItem("状况",EscapeHtml(f.Status),a)),r+="</div>");""!=(r+="</table>")&&s.push({name:"储存",html:r,img:"storage64.png"})}if(t.windows&&t.windows.volumes){var k,r="";for(v in t.windows.volumes)r=(r+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>")+("<div style=margin-bottom:3px><b>"+v+":"+(null==(d=t.windows.volumes[v]).name||""==d.name?"":" - "+EscapeHtml(d.name))+"</b></div>"),d.size&&(x=["Bytes","KB","MB","GB","TB"],y=0===(p=parseInt(Math.floor(Math.log(Math.abs(d.size))/Math.log(1024)),10))?d.size+" "+x[p]:(d.size/1024**p).toFixed(2)+" "+x[p],r+=addDetailItem("容量",EscapeHtml(y),a)),d.sizeremaining&&(x=["Bytes","KB","MB","GB","TB"],y=0===(p=parseInt(Math.floor(Math.log(Math.abs(d.sizeremaining))/Math.log(1024)),10))?d.sizeremaining+" "+x[p]:(d.sizeremaining/1024**p).toFixed(2)+" "+x[p],r+=addDetailItem("Capacity Remaining",EscapeHtml(y),a)),d.type&&(r+=addDetailItem("File System",(""!=(b=1==d.removable?"Removable":1==d.cdrom?"CD-ROM":"")?b+" / ":"")+("Unknown"==d.type?"未知":EscapeHtml(d.type)),a)),(d.protectionStatus||d.volumeStatus)&&(k=[],d.protectionStatus&&k.push("已启用"),d.volumeStatus&&"FullyDecrypted"==d.volumeStatus&&k.push("Fully Decrypted"),d.volumeStatus&&"EncryptionInProgress"==d.volumeStatus&&k.push("Encryption In Progress"),d.volumeStatus&&"FullyEncrypted"==d.volumeStatus&&k.push("Fully Encrypted"),k=k.join(" - "),d.recoveryPassword&&(k+=addKeyLink("",'deviceDetailsShowBitlockerInfo("'+encodeURIComponentEx(v)+'","'+encodeURIComponentEx(d.identifier)+'","'+encodeURIComponentEx(d.recoveryPassword)+'")')),r+=addDetailItem("BitLocker",k,a)),r+="</div>";""!=r&&s.push({name:"Storage Volumes",html:"<table style=width:100%>"+r+"</table>",img:"storage64.png"})}if(t.linux&&t.linux.volumes){var x,y,r="";for(v in t.linux.volumes)(d=t.linux.volumes[v]).mount_point.startsWith("/var/lib/docker/overlay2")||(r=(r+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>")+"<div style=margin-bottom:3px><b>"+d.mount_point+"</b></div>",d.size&&(x=["KB","MB","GB","TB"],y=0===(p=parseInt(Math.floor(Math.log(Math.abs(d.size))/Math.log(1024)),10))?d.size+" "+x[p]:(d.size/1024**p).toFixed(2)+" "+x[p],r+=addDetailItem("容量",EscapeHtml(y),a)),d.available&&(y=0==Math.abs(d.available)?"0 KB":(x=["KB","MB","GB","TB"],0===(p=parseInt(Math.floor(Math.log(Math.abs(d.available))/Math.log(1024)),10))?d.available+" "+x[p]:(d.available/1024**p).toFixed(2)+" "+x[p]),r+=addDetailItem("Capacity Remaining",EscapeHtml(y),a)),d.type&&(r+=addDetailItem("File System",(""!=(b=1==d.removable?"Removable":1==d.cdrom?"CD-ROM":"")?b+" / ":"")+("Unknown"==d.type?"未知":EscapeHtml(d.type)),a)),r+="</div>");""!=r&&s.push({name:"Storage Volumes",html:"<table style=width:100%>"+r+"</table>",img:"storage64.png"})}if(t.darwin&&t.darwin.volumes){var b,r="";for(v in t.darwin.volumes)(d=t.darwin.volumes[v]).mount_point.startsWith("/var/lib/docker/overlay2")||(r=(r+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>")+"<div style=margin-bottom:3px><b>"+d.mount_point+"</b></div>",d.size&&(r+=addDetailItem("容量",EscapeHtml(d.size),a)),d.available&&(r+=addDetailItem("Capacity Remaining",EscapeHtml(d.available),a)),d.type&&(r+=addDetailItem("File System",(""!=(b=1==d.removable?"Removable":1==d.cdrom?"CD-ROM":"")?b+" / ":"")+("Unknown"==d.type?"未知":EscapeHtml(d.type)),a)),r+="</div>");""!=r&&s.push({name:"Storage Volumes",html:"<table style=width:100%>"+r+"</table>",img:"storage64.png"})}r="";for(v in s)null==s[v].img?r+="<div class=DevSt style=margin-bottom:3px;margin-left:16px><b>"+s[v].name+"</b></div><div style=margin-bottom:10px;margin-left:16px>"+s[v].html+"</div>":r=(r=(r+="<table style=width:100%><tr>")+"<td style=width:64px;vertical-align:top><img src=images/details/"+s[v].img+" border=0 width=64 /></td>")+"<td><div class=DevSt style=margin-bottom:3px;margin-left:16px><b>"+s[v].name+"</b></div><div style=margin-bottom:10px;margin-left:16px>"+s[v].html+"</div></td></tr></table>";""==r?QH("p17info2","没有此设备的讯息。"):QH("p17info2",r)}}function deviceDetailsShowBitlockerInfo(e,t,n){if(xxdialogMode)return!1;t="<div><p>识别码</p><p style=user-select:text;font-weight:bold>"+(t?decodeURIComponent(t):"未知")+"</p>";t+="<p>Recovery Password</p><p style=user-select:text;font-weight:bold>"+(n?decodeURIComponent(n):"未知")+"</p></div>",setDialogMode(2,decodeURIComponent(e)+": BitLocker Information",1,null,t,"")}function agentConsoleHandleKeys(e){var t,n,i;return!(!e.ctrlKey&&!e.altKey)||(t=0,n=Q("p15consoleText"),e.key?13==e.keyCode&&0==consoleFocus?(p15consoleSend(e),t=1):8==e.keyCode&&0==consoleFocus?(i=n.value,n.value=i.substring(0,i.length-1),t=1):27==e.keyCode?(n.value="",t=1):38==e.keyCode||40==e.keyCode?(i=consoleHistory.indexOf(n.value),38==e.keyCode&&consoleHistory.length-1>i?n.value=consoleHistory[i+1]:40==e.keyCode&&0<i?n.value=consoleHistory[i-1]:40==e.keyCode&&0==i&&(n.value=""),t=1):1===e.key.length&&(insertTextAtCursor(n,e.key),t=1):0!=e.charCode&&0==consoleFocus&&(n.value=n.value+String.fromCharCode(e.charCode),t=1),0<t?haltEvent(e):void 0)}function insertTextAtCursor(e,t){var n,i;document.selection?(e.focus(),(sel=document.selection.createRange()).text=t):e.selectionStart||"0"==e.selectionStart?(n=e.selectionStart,i=e.selectionEnd,e.value=e.value.substring(0,n)+t+e.value.substring(i,e.value.length),e.setSelectionRange(i+1,i+1)):e.value+=myValue}var consoleServerText="";function setupConsole(){var e,t;115==xxcurrentView?(e="server"==consoleNode,consoleNode="server",QH("p15deviceName","我的服务器控制台"),QE("p15consoleText",!0),QH("p15statetext",""),QH("p15coreName",""),QV("p15outputselecttd",!1),0==e&&(QH("p15agentConsoleText",consoleServerText),Q("p15agentConsoleText").scrollTop=Q("p15agentConsoleText").scrollHeight)):(e=consoleNode==currentNode,meshes[(consoleNode=currentNode).meshid],0!=(16&GetNodeRights(currentNode))?(null==consoleNode.consoleText&&(consoleNode.consoleText=""),0==e&&(QH("p15agentConsoleText",consoleNode.consoleText),Q("p15agentConsoleText").scrollTop=Q("p15agentConsoleText").scrollHeight),0==(1&consoleNode.conn)&&consoleNode.conn,e=0!=(1&consoleNode.conn)?"代理在线":"代理离线",0!=(16&consoleNode.conn)&&(e+="，MQTT在线"),QH("p15statetext",e),QE("p15uploadCore",0!=(1&consoleNode.conn)),QV("p15outputselecttd",0!=(16&consoleNode.conn)||1==currentNode.pmt&&0!=(4&features2)),QV("p15outputselect2",0!=(16&consoleNode.conn)),QV("p15outputselect3",1==currentNode.pmt&&0!=(4&features2)),e=Q("p15outputselect").value,0==(16&consoleNode.conn)&&2==e&&(e=1,Q("p15outputselect").value=1),1==currentNode.pmt&&0!=(4&features2)||3!=e||(e=1,Q("p15outputselect").value=1),t=!1,0!=(1&consoleNode.conn)&&1==e&&(t=!0),0!=(16&consoleNode.conn)&&2==e&&(t=!0),1==currentNode.pmt&&0!=(4&features2)&&3==e&&(t=!0),QE("p15consoleText",t)):(QH("p15statetext","拒绝访问"),QE("p15consoleText",!1),QE("p15uploadCore",!1),QV("p15outputselecttd",!1)),QV("devListToolbarViewIcons3",0!=(1&consoleNode.conn)))}function p15consoleClear(){QH("p15agentConsoleText",""),Q("id_p15consoleClear").blur(),115==xxcurrentView?consoleServerText="":consoleNode.consoleText=""}var consoleHistory=[];function p15consoleSend(e){var t;e&&13!=e.keyCode||(e=Q("p15consoleText").value,t="<div style=color:green>&gt; "+EscapeHtml(e)+"<br/></div>",115==xxcurrentView?(consoleServerText+=t,meshserver.send({action:"serverconsole",value:e})):0!=(16&consoleNode.conn)&&2==Q("p15outputselect").value?(t="<div style=color:orange>MQTT&gt; "+EscapeHtml(e)+"<br/></div>",consoleNode.consoleText+=t,meshserver.send({action:"sendmqttmsg",topic:"console",nodeids:[consoleNode._id],msg:e})):1==consoleNode.pmt&&3==Q("p15outputselect").value&&0!=(4&features2)?(t="<div style=color:violet>推&gt; "+EscapeHtml(e)+"<br/></div>",consoleNode.consoleText+=t,meshserver.send({action:"pushconsole",nodeid:consoleNode._id,console:e})):0!=(1&consoleNode.conn)&&(consoleNode.consoleText+=t,meshserver.send({action:"msg",type:"console",nodeid:consoleNode._id,value:e})),Q("p15agentConsoleText").innerHTML+=t,Q("p15agentConsoleText").scrollTop=Q("p15agentConsoleText").scrollHeight,Q("p15consoleText").value="",0<e.length&&(0<=(t=consoleHistory.indexOf(e))&&consoleHistory.splice(t,1),consoleHistory.unshift(e),consoleHistory.splice(10)))}function p15consoleReceive(e,t,n){"serverconsole"===e?(t="<div>"+EscapeHtml(t)+"</div>",consoleServerText+=t,"server"==consoleNode&&(Q("p15agentConsoleText").innerHTML+=t,Q("p15agentConsoleText").scrollTop=Q("p15agentConsoleText").scrollHeight)):(t="MQTT"==n?"<div style=color:red>MQTT&gt; "+EscapeHtml(t)+"<br/></div>":"<div>"+EscapeHtml(t)+"</div>",null==e.consoleText?e.consoleText=t:e.consoleText+=t,consoleNode==e&&(Q("p15agentConsoleText").innerHTML+=t,Q("p15agentConsoleText").scrollTop=Q("p15agentConsoleText").scrollHeight))}function p15downloadConsoleText(){saveAs(new Blob([Q("p15agentConsoleText").innerText],{type:"application/octet-stream"}),"console.txt")}function p15uploadCore(e){xxdialogMode||(1==e.shiftKey?meshserver.send({action:"uploadagentcore",nodeids:[consoleNode._id],type:"default"}):1==e.altKey?meshserver.send({action:"uploadagentcore",nodeids:[consoleNode._id],type:"clear"}):1==e.ctrlKey?p15uploadCore2():setDialogMode(2,"执行代理指令",3,p15uploadCoreEx,addHtmlValue("指令","<select id=d3coreMode style=width:230px><option value=1>上载默认服务器核心</option><option value=2>清除核心</option><option value=6>上传恢复核心</option><option value=7>上传小核</option><option value=3>上载核心档案</option><option value=4>软断开代理</option><option value=5>强行断开代理</option><option value=8>Restart agent service</select>")))}function p15uploadCoreEx(){1==Q("d3coreMode").value?meshserver.send({action:"uploadagentcore",nodeids:[consoleNode._id],type:"default"}):2==Q("d3coreMode").value?meshserver.send({action:"uploadagentcore",nodeids:[consoleNode._id],type:"clear"}):3==Q("d3coreMode").value?p15uploadCore2():4==Q("d3coreMode").value?meshserver.send({action:"agentdisconnect",nodeid:consoleNode._id,disconnectMode:1}):5==Q("d3coreMode").value?meshserver.send({action:"agentdisconnect",nodeid:consoleNode._id,disconnectMode:2}):6==Q("d3coreMode").value?meshserver.send({action:"uploadagentcore",nodeids:[consoleNode._id],type:"recovery"}):7==Q("d3coreMode").value?meshserver.send({action:"uploadagentcore",nodeids:[consoleNode._id],type:"tiny"}):8==Q("d3coreMode").value&&meshserver.send({action:"msg",type:"console",nodeid:consoleNode._id,value:"service restart"})}function p15uploadCore2(){xxdialogMode||(Q("d3localmodeform").action="uploadmeshcorefile.ashx",Q("d3auth").value=authCookie,Q("d3filter").value=".js",Q("d3attrib").value=currentNode._id,setDialogMode(3,"上载Mesh代理核心",3,p15uploadCoreEx2),d3init())}function p15uploadCoreEx2(){var e;1==Q("d3uploadMode").value?Q("d3submit").click():1==(e=d3getFileSel()).length&&meshserver.send({action:"uploadagentcore",nodeids:[consoleNode._id],type:"custom",path:d3filetreelocation.join("/")+"/"+e[0]})}function account_viewPreviousLogins(){xxdialogMode||(setDialogMode(2,"以前的登录",1,null,"载入中...","previousLogins"),meshserver.send({action:"previousLogins"}))}function account_manageImage(e){var t,n,i,o;xxdialogMode||(setDialogMode(2,"管理帐户图片",7,account_manageImageEx2,'<input id=p2file type=file style=width:100% accept="image/*" onchange=account_manageImageEx()><div style=width:100%><canvas id=p2canvas width=256 height=256 style="width:256px;height:256px;margin-left:60px;margin-top:8px;border-radius:16px;box-shadow: 0px 0px 15px #000" onclick=account_canvasClick() /></div>',(t=0==e?userinfo:currentUser)._id),n=Q("p2canvas").getContext("2d"),null==t.accountImageRnd&&(t.accountImageRnd=Math.floor(9999999999*Math.random())),i="",1==e&&(i="&id="+t._id.split("/")[2]),(o=new Image).onload=function(){n.clearRect(0,0,256,256),n.drawImage(o,0,0)},o.src=null!=t.flags&&1&t.flags?"userimage.ashx?rnd="+t.accountImageRnd+i:"images/user-256.png",QE("idx_dlgDeleteButton",null!=t.flags&&1&t.flags),QE("idx_dlgOkButton",!1))}function account_canvasClick(){Q("p2file").click()}function account_manageImageEx(){var e=Q("p2file").files[0],o=new Image;o.onload=function(){var e=0,t=0,n=Math.min(o.width,o.height),i=(o.width>n&&(e=(o.width-n)/2),o.height>n&&(t=(o.height-n)/2),Q("p2canvas").getContext("2d"));i.imageSmoothingEnabled=!0,i.webkitImageSmoothingEnabled=!0,i.mozImageSmoothingEnabled=!0,i.clearRect(0,0,256,256),i.drawImage(o,e,t,n,n,0,0,256,256),QE("idx_dlgOkButton",!0)},o.src=URL.createObjectURL(e)}function account_manageImageEx2(e,t){meshserver.send({action:"updateUserImage",userid:t,image:2==e?0:Q("p2canvas").toDataURL(Q("p2file").files[0].type)})}function account_managePhone(){xxdialogMode||0==(33554432&features)||(null!=userinfo.phone?(setDialogMode(2,"电话通知",3,account_managePhoneRemove,'<table style=width:100%><tr><td style=width:56px><img src="images/phone80.png" style=padding:8px>'+("<td style=text-align:center><div style=padding:6px>验证电话号码</div><div style=font-size:20px>"+EscapeHtml(userinfo.phone)+"</div>")+"<div style=margin:10px><label><input id=d2delPhone type=checkbox onclick=account_managePhoneRemoveValidate() />删除电话号码</label></div>"),account_managePhoneRemoveValidate):(setDialogMode(2,"电话通知",3,account_managePhoneAdd,'<table style=width:100%><tr><td style=width:56px><img src="images/phone80.png" style=padding:8px>'+"<td>输入支持SMS的电话号码。验证后，该号码可用于登录验证和其他通知。"+'<br /><br /><div style=width:100%;text-align:center>电话号码： <input type=tel pattern="[0-9]" autocomplete="tel" inputmode="tel" maxlength=18 id=d2phoneinput onKeyUp=account_managePhoneValidate() onkeypress="if (event.key==\'Enter\') account_managePhoneValidate(1)"></div></table>',"verifyPhone"),Q("d2phoneinput").focus(),account_managePhoneValidate))()}function isPhoneNumber(e){var t=!0;e.startsWith("+")&&(e=e.substring(1));for(var n=0;n<e.length;n++){var i=e.charCodeAt(n);(i<48||57<i)&&32!=i&&45!=i&&46!=i&&(t=!1)}return t&&10<=e.length}function account_managePhoneValidate(e){var t=isPhoneNumber(Q("d2phoneinput").value);QE("idx_dlgOkButton",t),1==e&&t&&dialogclose(1)}function account_managePhoneCodeValidate(e){var t=6==Q("d2phoneCodeInput").value.length&&Q("d2phoneCodeInput").value.match(/[0-9]/);QE("idx_dlgOkButton",t),1==e&&t&&dialogclose(1)}function account_managePhoneConfirm(e,t){meshserver.send({action:"confirmPhone",code:Q("d2phoneCodeInput").value,cookie:t})}function account_managePhoneAdd(){0!=isPhoneNumber(Q("d2phoneinput").value)&&(QE("d2phoneinput",!1),meshserver.send({action:"verifyPhone",phone:Q("d2phoneinput").value}))}function account_managePhoneRemove(){Q("d2delPhone").checked&&meshserver.send({action:"removePhone"})}function account_managePhoneRemoveValidate(){QE("idx_dlgOkButton",Q("d2delPhone").checked)}function account_manageMessaging(){var e,t;xxdialogMode||0==(33554432&features2)||(null!=userinfo.msghandle?(setDialogMode(2,"Messaging Notifications",3,account_manageMessagingRemove,e=(e='<table style=width:100%><tr><td style=width:56px><img src="images/messaging40.png" style=padding:8px>')+("<td style=text-align:center><div style=padding:6px>Verified handle</div><div style=font-weight:bold>"+EscapeHtml(userinfo.msghandle)+"</div>")+"<div style=margin:10px><label><input id=d2delPhone type=checkbox onclick=account_managePhoneRemoveValidate() />Remove messaging</label></div>"),account_managePhoneRemoveValidate):(t="<select id=d2serviceselect style=width:160px;margin-left:8px onchange=account_manageMessagingValidate()>",0!=(1&serverinfo.userMsgProviders)&&(t+="<option value=1>Telegram</option>"),0!=(4&serverinfo.userMsgProviders)&&(t+="<option value=4>Discord</option>"),0!=(8&serverinfo.userMsgProviders)&&(t+="<option value=8>XMPP</option>"),0!=(16&serverinfo.userMsgProviders)&&(t+="<option value=16>CallMeBot</option>"),0!=(32&serverinfo.userMsgProviders)&&(t+="<option value=32>Pushover</option>"),0!=(64&serverinfo.userMsgProviders)&&(t+="<option value=64>ntfy</option>"),0!=(128&serverinfo.userMsgProviders)&&(t+="<option value=128>Zulip</option>"),0!=(256&serverinfo.userMsgProviders)&&(t+="<option value=256>Slack</option>"),e=(e='<table style=width:100%><tr><td style=width:56px;vertical-align:top><img src="images/messaging40.png" style=padding:8px>')+"<td>Enter your messaging service and handle. Once verified, this server can send you login verification and other notifications.<br /><br /><table><tr><td>Service<td>"+(t+="</select>")+"<tr><td>Handle<td><input maxlength=1024 style=width:160px;margin-left:8px id=d2handleinput onKeyUp=account_manageMessagingValidate() onkeypress=\"if (event.key=='Enter') account_manageMessagingValidate(1)\"></table>",serverinfo.discordUrl&&(e+="<div id=d2discordurl style=display:none><br /><a href="+serverinfo.discordUrl+' target="_discord">Join this Discord server to receive notifications.</a></div>'),e+='<div id=d2callmebotinfo style=display:none><br /><a href=https://www.callmebot.com/blog/free-api-signal-send-messages/ target="_callmebot">Signal</a>, <a href=https://www.callmebot.com/blog/free-api-whatsapp-messages/ target="_callmebot">Whatsapp</a>, <a href=https://www.callmebot.com/blog/free-api-facebook-messenger/ target="_callmebot">Facebook</a>, <a href=https://www.callmebot.com/blog/telegram-text-messages/ target="_callmebot">Telegram</a></div><div id=d2pushoverinfo style=display:none><br /><a href=https://pushover.net/ target="_pushover">Information at Pushover.net</a></div>',console.log(serverinfo.userMsgNftyUrl),setDialogMode(2,"Messaging Notifications",3,account_manageMessagingAdd,e=e+('<div id=d2ntfyinfo style=display:none><br /><a href="'+(serverinfo.userMsgNftyUrl||"https://ntfy.sh/")+'" target="_ntfy">Free service at ntfy.sh</a></div>')+'<div id=d2slackinfo style=display:none><br /><a href=https://api.slack.com/messaging/webhooks target="_slack">Slack Webhook Setup</a></div>',"verifyMessaging"),Q("d2handleinput").focus(),account_manageMessagingValidate))()}function account_manageMessagingValidate(e){serverinfo.discordUrl&&QV("d2discordurl",4==Q("d2serviceselect").value),QV("d2callmebotinfo",16==Q("d2serviceselect").value),QV("d2pushoverinfo",32==Q("d2serviceselect").value),QV("d2ntfyinfo",64==Q("d2serviceselect").value),QV("d2slackinfo",256==Q("d2serviceselect").value),4==Q("d2serviceselect").value?Q("d2handleinput").placeholder="Username:0000":8==Q("d2serviceselect").value?Q("d2handleinput").placeholder="username@server.com":16==Q("d2serviceselect").value?Q("d2handleinput").placeholder="https://api.callmebot.com/...":32==Q("d2serviceselect").value?Q("d2handleinput").placeholder="User key":64==Q("d2serviceselect").value?Q("d2handleinput").placeholder="主题":128==Q("d2serviceselect").value?Q("d2handleinput").placeholder="username@sample.com":256==Q("d2serviceselect").value?Q("d2handleinput").placeholder="https://hooks.slack.com/...":Q("d2handleinput").placeholder="用户名";var t=0<Q("d2handleinput").value.length;QE("idx_dlgOkButton",t),1==e&&t&&dialogclose(1)}function account_manageMessagingAdd(){0!=Q("d2handleinput").value.length&&(QE("d2handleinput",!1),meshserver.send({action:"verifyMessaging",service:Q("d2serviceselect").value,handle:Q("d2handleinput").value}))}function account_manageMessagingConfirm(e,t){meshserver.send({action:"confirmMessaging",code:Q("d2phoneCodeInput").value,cookie:t})}function account_manageMessagingRemove(){Q("d2delPhone").checked&&meshserver.send({action:"removeMessaging"})}function account_manageAuthEmail(){var e;xxdialogMode||0==(8388608&features)||setDialogMode(2,"邮件认证",1,function(){e!=Q("email2facheck").checked&&meshserver.send({action:"otpemail",enabled:Q("email2facheck").checked})},"启用后，每次登录时，您都可以选择向电邮帐户接收登录保安编码，以提高安全性。<br /><br /><label><input id=email2facheck type=checkbox "+((e=1==userinfo.otpekey&&null!=userinfo.email&&1==userinfo.emailVerified)?"checked":"")+"/>启用电邮两因素验证。</label>")}function account_manageAuthDuo(){xxdialogMode||0==(536870912&features2)||(0==(1==userinfo.otpduo)?setDialogMode(2,"Duo Authentication",3,function(){window.location.href="/add-duo?rurl="+encodeURIComponentEx(window.location.href)+(urlargs.key?"&key="+urlargs.key:"")},'Confirm enabling of Duo 2FA login security. Once enabled you will be given the option to use Duo at login for added security. Click ok to go thru the steps to enable Duo.<p style="text-align: center"><img src="images/duo-2fa-250.png"></p>'):(setDialogMode(2,"Duo Authentication",3,function(){meshserver.send({action:"otpduo",enabled:!1})},'<p><label><input id=duo2facheck type=checkbox onclick=account_manageAuthDuoConfirm() />Confirm disabling 2FA Duo login security.</label></p><p style="text-align: center"><img src="images/duo-2fa-250-disable.png"></p>'),QE("idx_dlgOkButton",!1)))}function account_manageAuthDuoConfirm(){QE("idx_dlgOkButton",Q("duo2facheck").checked)}function account_manageAuthApp(){if(!xxdialogMode&&0!=(4096&features))return(1==userinfo.otpsecret?account_removeOtp:account_addOtp)(),!1}function account_addOtp(){xxdialogMode||1==userinfo.otpsecret||0==(4096&features)||(setDialogMode(2,"认证软件",2,function(){meshserver.send({action:"otpauth-setup",secret:Q("d2optsecret").attributes.secret.value,token:Q("d2otpauthinput").value})},"<div id=d2optinfo>载入中...</div>","otpauth-request"),meshserver.send({action:"otpauth-request"}))}function account_addOtpCheck(e){var t=6==Q("d2otpauthinput").value.length;QE("idx_dlgOkButton",t),e&&13==e.keyCode&&t&&dialogclose(1)}function account_removeOtp(){xxdialogMode||1!=userinfo.otpsecret||0==(4096&features)||setDialogMode(2,"认证软件",3,function(){meshserver.send({action:"otpauth-clear"})},"确认删除身份验证软件两步登录？")}function account_manageOtp(e){return 2==xxdialogMode&&"otpauth-manage"==xxdialogTag&&dialogclose(0),xxdialogMode||0==(4096&features)||0<count2factoraAuths()&&meshserver.send({action:"otpauth-getpasswords",subaction:e}),!1}function account_managePushAuthDev(){if(!xxdialogMode&&0!=(64&features2)){if(1==userinfo.otpdev)setDialogMode(2,"认证设备",3,function(){meshserver.send({action:"otpdev-clear"})},"确认移除推送认证设备？");else{var e=[];for(n in nodes){var t=nodes[n];null!=t.agent&&14==t.agent.id&&1==t.pmt&&4294967295==GetNodeRights(t)&&e.push(t)}if(0==e.length)setDialogMode(2,"认证设备",1,null,"为了使用推送通知身份验证，必须在您的帐户中设置具有完全权限的移动设备。");else{var n,i="选择要注册推送通知身份验证的设备。选择后，设备将提示确认。<br /><br />",o="<select id=d2devselect style=width:240px>";for(n in e)o+='<option value="'+e[n]._id+'">'+EscapeHtml(e[n].name)+"</option>";setDialogMode(2,"认证设备",3,function(){meshserver.send({action:"otpdev-set",nodeid:Q("d2devselect").value})},i+=addHtmlValue("设备",o+="</select>"))}}return!1}}function account_manageHardwareOtp(){return 2==xxdialogMode&&"otpauth-hardware-manage"==xxdialogTag&&dialogclose(0),xxdialogMode||0==(4096&features)||meshserver.send({action:"otp-hkey-get"}),!1}function account_addhkey(e){var t;3==e?(t="输入要添加的密钥的名称。<br /><br />",t+=addHtmlValue("键名",'<input id=dp1keyname style=width:230px maxlength=20 autocomplete=off placeholder="我的密钥" onkeyup=account_addhkeyValidate(event,2) />')):2==e&&(t="输入密钥名称，选择OTP框，然后按YubiKey&trade;上的按钮。<br /><br />",t=(t+=addHtmlValue("键名",'<input id=dp1keyname style=width:230px maxlength=20 autocomplete=off placeholder="我的密钥" onkeyup=account_addhkeyValidate(event,1) />'))+addHtmlValue("YubiKey&trade; OTP","<input id=dp1key style=width:230px autocomplete=off onkeyup=account_addhkeyValidate(event,2) />")),setDialogMode(2,"添加安全密钥",3,account_addhkeyEx,t,e),Q("dp1keyname").focus()}function account_addhkeyValidate(e,t){null!=e&&13==e.keyCode&&(2==t?dialogclose(1):Q("dp1key").focus())}function account_addhkeyEx(e,t){var n=Q("dp1keyname").value;""==n&&(n="MyKey"),2==t?(meshserver.send({action:"otp-hkey-yubikey-add",name:n,otp:Q("dp1key").value}),setDialogMode(2,"添加安全密钥",0,null,"<br />检查...<br /><br /><br />","otpauth-hardware-manage")):3==t&&meshserver.send({action:"webauthn-startregister",name:n})}function account_removehkey(e){meshserver.send({action:"otp-hkey-remove",index:e}),meshserver.send({action:"otp-hkey-get"})}var currentMesh,filetreelinkpath,loclist={af:"南非文",sq:"阿尔巴尼亚文",ar:"阿拉伯文（标准）","ar-dz":"阿拉伯文（阿尔及利亚）","ar-bh":"阿拉伯文（巴林）","ar-eg":"阿拉伯文（埃及）","ar-iq":"阿拉伯文（伊拉克）","ar-jo":"阿拉伯文（约旦）","ar-kw":"阿拉伯文（科威特）","ar-lb":"阿拉伯文（黎巴嫩）","ar-ly":"阿拉伯文（利比亚）","ar-ma":"阿拉伯文（摩洛哥）","ar-om":"阿拉伯文（阿曼）","ar-qa":"阿拉伯文（卡塔尔）","ar-sa":"阿拉伯文（沙特阿拉伯）","ar-sy":"阿拉伯文（叙利亚）","ar-tn":"阿拉伯文（突尼斯）","ar-ae":"阿拉伯文（阿联酋）","ar-ye":"阿拉伯文（也门）",an:"阿拉贡文",hy:"亚美尼亚文",as:"阿萨姆文",ast:"阿斯图里亚斯文",az:"阿塞拜疆文",eu:"巴斯克",bg:"保加利亚文",be:"白俄罗斯文",bn:"孟加拉",bs:"波斯尼亚文",br:"布列塔尼",my:"缅甸文",ca:"加泰罗尼亚文",ch:"查莫罗",ce:"车臣",zh:"中文","zh-hk":"中文（香港）","zh-cn":"中文（中国）","zh-sg":"中文（新加坡）","zh-tw":"中文（台湾）",cv:"楚瓦什",co:"科西嘉文",cr:"克里语",hr:"克罗地亚文",cs:"捷克文",da:"丹麦文",nl:"荷兰文（标准）","nl-be":"荷兰文（比利时）",en:"英文","en-au":"英文（澳洲）","en-bz":"英文（伯利茲）","en-ca":"英文（加拿大）","en-ie":"英文（爱尔兰）","en-jm":"英文（牙买加）","en-nz":"英文（纽西兰）","en-ph":"英文（菲律宾）","en-za":"英语（南非）","en-tt":"英文（特立尼达和多巴哥）","en-gb":"英文（英国）","en-us":"美国英文","en-zw":"英文（津巴布韦）",eo:"世界文",et:"爱沙尼亚文",fo:"法罗语",fa:"波斯文（波斯文）",fj:"斐济",fi:"芬兰",fr:"法文（标准）","fr-be":"法文（比利时）","fr-ca":"法文（加拿大）","fr-fr":"法文（法国）","fr-lu":"法文（卢森堡）","fr-mc":"法文（摩纳哥）","fr-ch":"法文（瑞士）",fy:"弗里斯兰文",fur:"弗留利",gd:"盖尔文（苏格兰文）","gd-ie":"盖尔文（爱尔兰）",gl:"加拉契文",ka:"格鲁吉亚文",de:"德文（标准）","de-at":"德文（奥地利）","de-de":"德文（德国）","de-li":"德文（列支敦士登）","de-lu":"德文（卢森堡）","de-ch":"德文（瑞士）",el:"希腊文",gu:"古久拉提",ht:"海地文",he:"希伯来文",hi:"印地文",hu:"匈牙利文",is:"冰岛文",id:"印度尼西亚文",iu:"因纽特文",ga:"爱尔兰文",it:"意大利文（标准）","it-ch":"意大利文（瑞士）",ja:"日文",kn:"卡纳达文",ks:"克什米尔文",kk:"哈萨克文",km:"高棉文",ky:"吉尔吉斯",tlh:"克林贡",ko:"韩文","ko-kp":"韩文（朝鲜）","ko-kr":"韩文（韩国）",la:"拉丁文",lv:"拉脱维亚文",lt:"立陶宛文",lb:"卢森堡文",mk:"FYRO马其顿语",ms:"马来文",ml:"玛拉雅拉姆文",mt:"马耳他文",mi:"毛利文",mr:"马拉地文",mo:"摩尔达维亚文",nv:"纳瓦霍文",ng:"恩东加",ne:"尼泊尔文",no:"挪威文",nb:"挪威文（Bokmal）",nn:"挪威文（尼诺斯克）",oc:"欧舒丹",or:"奥里亚",om:"奥罗莫","fa-ir":"波斯/伊朗",pl:"波兰文",pt:"葡萄牙文","pt-br":"葡萄牙文（巴西）",pa:"旁遮普文","pa-in":"旁遮普（印度）","pa-pk":"旁遮普（巴基斯坦）",qu:"盖丘亚族",rm:"雷托-罗曼语",ro:"罗马尼亚文","ro-mo":"罗马尼亚文（摩尔达维亚）",ru:"俄文","ru-mo":"俄文（摩尔达维亚）",sz:"萨米（拉普兰）",sg:"三乡",sa:"梵文",sc:"撒丁岛",sd:"信地",si:"僧伽罗文",sr:"塞尔维亚",sk:"斯洛伐克文",sl:"斯洛文尼亞文",so:"索马尼",sb:"索比亚文",es:"西班牙文","es-ar":"西班牙文（阿根廷）","es-bo":"西班牙文（玻利维亚）","es-cl":"西班牙文（智利）","es-co":"西班牙文（哥伦比亚）","es-cr":"西班牙文（哥斯达黎加）","es-do":"西班牙文（多米尼加共和国）","es-ec":"西班牙文（厄瓜多尔）","es-sv":"西班牙文（萨尔瓦多）","es-gt":"西班牙文（危地马拉）","es-hn":"西班牙文（洪都拉斯）","es-mx":"西班牙文（墨西哥）","es-ni":"西班牙文（尼加拉瓜）","es-pa":"西班牙文（巴拿马）","es-py":"西班牙文（巴拉圭）","es-pe":"西班牙文（秘鲁）","es-pr":"西班牙文（波多黎各）","es-es":"西班牙文（西班牙）","es-uy":"西班牙文（乌拉圭）","es-ve":"西班牙文（委内瑞拉）",sx:"苏图",sw:"斯瓦希里文",sv:"瑞典文","sv-fi":"瑞典文（芬兰）","sv-sv":"瑞典文（瑞典）",ta:"泰米尔文",tt:"塔塔尔族",te:"泰卢加",th:"泰国",tig:"蒂格雷",ts:"特松加",tn:"茨瓦纳",tr:"土耳其",tk:"土库曼文",uk:"乌克兰",hsb:"上索布族",ur:"乌尔都文",ve:"文达",vi:"越南文",vo:"沃拉普克",wa:"瓦隆",cy:"威尔士文",xh:"科萨",ji:"意第绪文",zu:"祖鲁族"},loclistex={"zh-chs":"简体中文","zh-cht":"繁体中文"};function account_showLocalizationSettings(){if(!xxdialogMode){var e=getstore("loctag",0),t="",n='<select id=d2locselect style=width:240px><option value="*">用户浏览器值</option>';for(i in loclist)n+='<option value="'+i+'"'+(e==i?" selected":"")+">"+i+" - "+loclist[i]+"</option>";if(n+="</select>",serverinfo.languages&&0<serverinfo.languages.length){t+="更改语言将需要刷新页面。<br /><br />";var i,o='<select id=d2langselect style=width:240px><option value="*">用户浏览器值</option>';for(i in serverinfo.languages){var s=serverinfo.languages[i];o+='<option value="'+s+'"'+(userinfo.lang==s?" selected":"")+">"+s+" - "+(loclist[s]||loclistex[s])+"</option>"}t+=addHtmlValue("语言",o+="</select>")}t+=addHtmlValue("日期和时间",n),4294967295==userinfo.siteadmin&&""==domain&&(t+='<br /><a rel="noreferrer noopener" target="_blank" href="translator.htm">帮助翻译MeshCentral</a>'),setDialogMode(2,"本地化设置",3,account_showLocalizationSettingsEx,t)}return!1}function account_showLocalizationSettingsEx(){var e=Q("d2langselect").value,e=((e="*"==e&&null==userinfo.lang?userinfo.lang:e)!=userinfo.lang&&meshserver.send({action:"changelang",lang:e}),getstore("loctag",0)),t=Q("d2locselect").value;e!=t&&("*"!=t?args.locale=t:delete args.locale,putstore("loctag",args.locale),mainUpdate(4294967295))}function account_enableNotifications(){return Notification&&Notification.requestPermission().then(function(e){QV("accountEnableNotificationsSpan","granted"!=e),setupServiceWorker()}),!1}function account_createLoginToken(){if(xxdialogMode)return!1;var e,t="",n="创建一个临时用户名和密码，可用作您帐户的替代登录名。这对于允许工具或其他服务访问您的帐户非常有用。<br /><br />",i={0:"无限制",1:"1分钟",5:"5分钟",10:"10分钟",15:"15分钟",30:"30分钟",45:"45分钟",60:"60分钟",120:"2小时",240:"4个小时",480:"8小時",720:"12小时",960:"16小时",1440:"24小时",2880:"2天",5760:"4天",10080:"7天"};for(e in i)t+="<option value="+e+">"+i[e]+"</option>";setDialogMode(2,"创建登录令牌",3,account_createLoginTokenEx,(n+=addHtmlValue("token名称","<input class=boxsize id=d2tokenName style=width:250px maxlength=100 type=text onchange=account_createLoginTokenValidate() onkeyup=account_createLoginTokenValidate() />"))+addHtmlValue("到期时间","<select class=boxsize id=d2tokenExpire style=width:250px>"+t+"</select>")),QE("idx_dlgOkButton",!1),Q("d2tokenName").focus()}function account_createLoginTokenValidate(){QE("idx_dlgOkButton",0<Q("d2tokenName").value.length)}function account_createLoginTokenEx(){meshserver.send({action:"createLoginToken",name:Q("d2tokenName").value,expire:parseInt(Q("d2tokenExpire").value)})}function account_showAccountNotifySettings(){var e;return xxdialogMode||(setDialogMode(2,"通知设置",3,account_showAccountNotifySettingsEx,"<div><label><input id=p2notifyPlayNotifySound type=checkbox />通知音效</label></div><div><label><input id=p2notifyGroupName type=checkbox />显示设备组名称</label></div><div><label><input id=p2notifyIntelDeviceConnect type=checkbox />设备连接。</label></div><div><label><input id=p2notifyIntelDeviceDisconnect type=checkbox />设备断开连接。</label></div><div><label><input id=p2notifyIntelAmtKvmActions type=checkbox />英特尔&reg;AMT桌面和串行事件</label></div>"),e=getstore("notifications",0),Q("p2notifyPlayNotifySound").checked=1&e,Q("p2notifyIntelDeviceConnect").checked=2&e,Q("p2notifyIntelDeviceDisconnect").checked=4&e,Q("p2notifyIntelAmtKvmActions").checked=8&e,Q("p2notifyGroupName").checked=16&e),!1}function account_showAccountNotifySettingsEx(){var e=0;putstore("notifications",(e+=Q("p2notifyPlayNotifySound").checked?1:0)+(Q("p2notifyIntelDeviceConnect").checked?2:0)+(Q("p2notifyIntelDeviceDisconnect").checked?4:0)+(Q("p2notifyIntelAmtKvmActions").checked?8:0)+(Q("p2notifyGroupName").checked?16:0))}function account_showVerifyEmail(){return xxdialogMode||1==userinfo.emailVerified||1!=serverinfo.emailcheck||setDialogMode(2,"邮件验证",3,account_showVerifyEmailEx,"单击确定将验证邮件发送到：<br /><div style=padding:8px><b>"+EscapeHtml(userinfo.email)+"</b></div>请等待几分钟以接收验证。"),!1}function account_showVerifyEmailEx(){meshserver.send({action:"verifyemail",email:userinfo.email})}function account_showChangeEmail(){var e;return xxdialogMode||(e="更改您的邮件地址。<br /><br />",setDialogMode(2,"邮件地址变更",3,account_changeEmail,e+=addHtmlValue("Email","<input id=dp2email style=width:230px maxlength=256 onchange=account_validateEmail() onkeyup=account_validateEmail(event) />")),null!=userinfo.email&&(Q("dp2email").value=userinfo.email),account_validateEmail(),Q("dp2email").focus()),!1}function account_validateEmail(e,t){QE("idx_dlgOkButton",validateEmail(Q("dp2email").value)&&Q("dp2email").value!=userinfo.email),null!=e&&13==e.keyCode&&dialogclose(1)}function account_changeEmail(){meshserver.send({action:"changeemail",email:Q("dp2email").value})}function account_showDeleteAccount(){var e;return xxdialogMode||(e="要删除此帐户，请在下面的两个框中键入帐户密码，然后单击确定。<br /><br />",setDialogMode(2,"删除帐户",0,null,e=(e=(e=(e+="<form method=post><input type=hidden name=action value=deleteaccount /><input type=hidden name=authcookie value="+authCookie+" /><table style=margin-left:80px><tr>")+"<td align=right>密码：</td><td><input id=apassword1 type=password name=apassword1 autocomplete=off onchange=account_validateDeleteAccount() onkeyup=account_validateDeleteAccount() /></td>"+"</tr><tr><td align=right>密码：</td><td><input id=apassword2 type=password name=apassword2 autocomplete=off onchange=account_validateDeleteAccount() onkeyup=account_validateDeleteAccount() /></td>")+"</tr></table><br /><div style=padding:10px;margin-bottom:4px>"+"<input id=account_dlgCancelButton type=button value=Cancel style=float:right;width:80px;margin-left:5px onclick=dialogclose(0)>")+'<input id=account_dlgOkButton type=submit value=OK style="float:right;width:80px" onclick=dialogclose(1)>'+"</div><br /></form>"),account_validateDeleteAccount(),Q("apassword1").focus()),!1}function account_showChangePassword(){if(!xxdialogMode){var e=(e=(e=(e=(e="在下面的框中两次输入旧密码和新密码，以更改帐户密码。")+"<br /><br />"+"<table style=margin-left:60px>")+("<tr><td align=right>"+nobreak("旧密码：")+"</td><td><input id=apassword0 type=password name=apassword0 autocomplete=off onchange=account_validateNewPassword() onkeyup=account_validateNewPassword() onkeydown=account_validateNewPassword() /> <b></b></td></tr>"))+("<tr><td align=right>"+nobreak("新密码：")+"</td><td><input id=apassword1 type=password name=apassword1 autocomplete=off onchange=account_validateNewPassword() onkeyup=account_validateNewPassword() onkeydown=account_validateNewPassword() /> <b><span id=dxPassWarn></span></b></td></tr>"))+("<tr><td align=right>"+nobreak("新密码：")+"</td><td><input id=apassword2 type=password name=apassword2 autocomplete=off onchange=account_validateNewPassword() onkeyup=account_validateNewPassword() onkeydown=account_validateNewPassword() /></td></tr>");if(65536&features&&(e+="<tr><td align=right>密码提示：</td><td><input id=apasswordhint name=apasswordhint maxlength=250 type=text autocomplete=off onchange=account_validateNewPassword() onkeyup=account_validateNewPassword() onkeydown=account_validateNewPassword() /></td></tr>"),e+="</table>",passRequirements){var t,n=[],i=0;for(t in passRequirements)"reset"!=t&&"hint"!=t&&(n.push(t+":"+passRequirements[t]),i++);0<i&&(e+="<br /><span style=font-size:x-small>要求："+n.join(", ")+".</span>")}setDialogMode(2,"更改密码",3,account_showChangePasswordEx,e+="<br />"),Q("apassword0").focus(),account_validateNewPassword()}return!1}function account_showChangePasswordEx(){var e;Q("apassword1").value==Q("apassword2").value&&(e={action:"changepassword",oldpass:Q("apassword0").value,newpass:Q("apassword1").value},65536&features&&(e.hint=Q("apasswordhint").value),meshserver.send(e))}function account_createMesh(){if(!xxdialogMode)if(4294967295!=userinfo.siteadmin&&0!=(64&userinfo.siteadmin))setDialogMode(2,"新设备组",1,null,"此帐户无权创建新的设备组。");else if(!0!==userinfo.emailVerified&&1==serverinfo.emailcheck&&4294967295!=userinfo.siteadmin)setDialogMode(2,"账户安全",1,null,"在验证电子邮件地址之前，无法访问此功能。这是密码恢复所必需的。转到“我的帐户”标签以更改和验证电子邮件地址。");else if(262144&features&&0==count2factoraAuths())setDialogMode(2,"账户安全",1,null,"在启用两因素身份验证之前，无法访问此功能。这是额外的安全性所必需的。转到“我的帐户”标签，然后查看“帐户安全性”部分。");else{var e=[];if(0==(2&features))for(var t in nodes){var n=nodes[t];2==n.mtype&&null!=n.agent&&4294967295==GetNodeRights(n)&&e.push(n)}var i="使用以下选项创建一个新的设备组。<br /><br />",o="";if(i+=addHtmlValue("名称","<input id=dp2meshname style=width:230px maxlength=128 onchange=account_validateMeshCreate() onkeyup=account_validateMeshCreate(event,1) />"),0==(1&features)&&(o+="<option value=3>本地设备，无代理</option>"),0==(2&features)&&0<e.length&&(o+="<option value=103>没有代理设备通过代理中继</option>"),65536&features2&&(0==(1&features)&&(o+="<option value=4>IP-KVM / 电源设备</option>"),0==(2&features))&&0<e.length&&(o+="<option value=104>IP-KVM / 通过代理中继的电源设备</option>"),i+=addHtmlValue("类型","<div style=width:230px;margin:0;padding:0><select id=dp2meshtype style=width:100% onchange=account_validateMeshCreate() onkeyup=account_validateMeshCreate(event,2) ><option value=2>使用软件代理进行管理</option><option value=1>仅限英特尔&reg;AMT，无代理</option>"+o+"</select></div>"),0<e.length){i+="<div id=d2devrelaydiv style=display:none>",e.sort(nameSort);var s=[];for(t in e)s.push('<option value="'+e[t]._id+'">'+EscapeHtml(e[t].name)+"</option>");i=i+addHtmlValue("中继装置","<div style=width:230px;margin:0;padding:0><select id=d2devrelay style=width:100% onchange=account_validateMeshCreate() onkeyup=account_validateMeshCreate(event,2) >"+s.join("")+"</select></div>")+"</div>"}setDialogMode(2,"新设备组",3,account_createMeshEx,i=(i=(i=(i=(i=i+addHtmlValue("描述","<div style=width:230px;margin:0;padding:0><textarea id=dp2meshdesc maxlength=1024 style=width:100%;resize:none></textarea></div>")+"<div id=d2ipkvm style=display:none><hr />")+addHtmlValue("模型","<div style=width:230px;margin:0;padding:0><select id=dp2ipkvmmodel style=width:100% onchange=account_validateMeshCreate() onkeyup=account_validateMeshCreate(event,2) ><option value=1>力登 Dominion KX III</option><option value=2>网页电源开关 7</option></select></div>"))+addHtmlValue("主机名","<input id=dp2ipkvmhost style=width:230px maxlength=128 onchange=account_validateMeshCreate() onkeyup=account_validateMeshCreate(event,1) />"))+addHtmlValue("用户名","<input id=dp2ipkvmuser style=width:230px maxlength=128 onchange=account_validateMeshCreate() onkeyup=account_validateMeshCreate(event,1) />"))+addHtmlValue("密码","<input id=dp2ipkvmpass type=password style=width:230px maxlength=128 onchange=account_validateMeshCreate() onkeyup=account_validateMeshCreate(event,1) />")+"</div>"),account_validateMeshCreate(),Q("dp2meshname").focus()}return!1}function account_validateMeshCreate(e,t){var n=parseInt(Q("dp2meshtype").value),t=(1==t&&null!=e&&"输入"==e.key&&0<Q("dp2meshname").value.length&&Q("dp2meshtype").focus(),2==t&&null!=e&&"输入"==e.key&&Q("dp2meshdesc").focus(),0<Q("dp2meshname").value.length);QV("d2ipkvm",4==n||104==n);try{QV("d2devrelaydiv",100<n)}catch(e){}4==n&&0==Q("dp2ipkvmhost").value.length&&0==Q("dp2ipkvmuser").value.length&&0==Q("dp2ipkvmpass").value.length&&(t=!1),QE("idx_dlgOkButton",t)}function account_createMeshEx(e,t){var n=parseInt(Q("dp2meshtype").value),i={action:"createmesh",meshname:Q("dp2meshname").value,meshtype:n,desc:Q("dp2meshdesc").value};4!=n&&104!=n||(i.kvmmodel=parseInt(Q("dp2ipkvmmodel").value),i.kvmhost=Q("dp2ipkvmhost").value,i.kvmuser=Q("dp2ipkvmuser").value,i.kvmpass=Q("dp2ipkvmpass").value),100<n&&(i.meshtype=n-100,i.relayid=Q("d2devrelay").value),meshserver.send(i)}function account_validateDeleteAccount(){QE("account_dlgOkButton",0<Q("apassword1").value.length&&Q("apassword1").value==Q("apassword2").value)}function account_validateNewPassword(){var e,t="",n=0<Q("apassword0").value.length&&0<Q("apassword1").value.length&&Q("apassword1").value==Q("apassword2").value&&Q("apassword0").value!=Q("apassword1").value;65536&features&&Q("apasswordhint").value==Q("apassword1").value&&(n=!1),""!=Q("apassword1").value&&(null==passRequirements||""==passRequirements?t=80<=(e=checkPasswordStrength(Q("apassword1").value))?"<span style=color:green>强<span>":60<=e?"<span style=color:blue>好<span>":"<span style=color:red>弱<span>":0==checkPasswordRequirements(Q("apassword1").value,passRequirements)&&(n=!1,t="<span style=color:red>政策<span>")),QH("dxPassWarn",t),QE("idx_dlgOkButton",n)}function checkPasswordStrength(e){var t=0,n={},i=0,o={digits:/\d/.test(e),lower:/[a-z]/.test(e),upper:/[A-Z]/.test(e),nonWords:/\W/.test(e)};if(!e)return 0;for(var s,a=0;a<e.length;a++)n[e[a]]=(n[e[a]]||0)+1,t+=5/n[e[a]];for(s in o)i+=1==o[s]?1:0;return parseInt(t+10*(i-1))}function checkPasswordRequirements(e,t){if(null==t||""==t||"object"!=typeof t)return!0;if(t.min&&e.length<t.min)return!1;if(t.max&&e.length>t.max)return!1;for(var n=0,i=0,o=0,s=0,a=0;a<e.length;a++)/\d/.test(e[a])&&n++,/[a-z]/.test(e[a])&&i++,/[A-Z]/.test(e[a])&&o++,/\W/.test(e[a])&&s++;return!(t.numeric&&n<t.numeric||t.lower&&i<t.lower||t.upper&&o<t.upper||t.nonalpha&&s<t.nonalpha)}function updateMeshes(){var e="",t=0,n=0,o=[];for(i in meshes)o.push(meshes[i]);for(i in o.sort(nameSort),o){1<t&&(e+="</tr><tr>",t=0),t++,n++;var s=GetMeshRights(o[i]),a="部分权限";4294967295==s?a="完整管理员":0==s&&(a="沒有权限"),e+="<div onmouseover=devGrpMouseHover(this,1) onmouseout=devGrpMouseHover(this,0) style=display:inline-block;width:431px;height:50px;padding-top:1px;padding-bottom:1px;float:left><div style=float:left;width:30px;height:100%></div><div tabindex=0 style=height:100%;cursor:pointer onclick=gotoMesh('"+o[i]._id+"') onkeypress=\"if (event.key=='Enter') gotoMesh('"+o[i]._id+"')\"><div class=mi style=float:left;width:50px;height:50px></div><div style=height:100%><div class=g1></div><div class=e2 style=width:300px><div class=e1>"+EscapeHtml(o[i].name)+"</div><div>"+a+"</div></div><div class=g2 style=float:left></div></div></div></div>"}meshcount=n,QH("p2meshes",e),QV("p2noMeshFound",0==n)}function updateLoginTokens(){var e="",t=1;if(null!=loginTokens&&0<loginTokens.length){e+='<p><strong>活动登录令牌</strong> - <span id="p2createMeshLink1"> <a href=# onclick="return account_createLoginToken()" class="newMeshBtn"> 新</a></span></p><div style=margin-left:40px><table style="color:black;background-color:#EEE;border-color:#AAA;border-width:1px;border-style:solid;border-collapse:collapse" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col style=text-align:left;width:430px>名称</th><th scope=col style=text-align:left>用户名</th></tr>';for(var n=0;n<loginTokens.length;n++){var i=loginTokens[n],o="<a href=# onclick='return p2removeLoginToken(event,\""+encodeURIComponentEx(i.tokenUser)+'")\' title="删除登录令牌" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>',s="";0!=i.expire&&(s=EscapeHtml(format("过期{0}",printDateTime(new Date(i.expire))))+" "),e+="<tr "+(++t%2==0?"style=background-color:#DDD":"")+"><td style=width:30%><div class=m2></div><div>&nbsp;"+EscapeHtml(i.name)+"<div></div></div></td><td style=width:70%><div style=float:right>"+s+o+"</div><div>"+EscapeHtml(i.tokenUser)+"</div></td></tr>"}e+="</tbody></table></div><br />",QV("accountCreateLoginTokenSpan",!1)}else QV("accountCreateLoginTokenSpan",128&features2);QH("p2logintokens",e)}function p2removeLoginToken(e,t){if(t=decodeURIComponent(t),null!=loginTokens){for(var n,i=null,o=0;o<loginTokens.length;o++)loginTokens[o].tokenUser==t&&(i=loginTokens[o]);null!=i&&(n="确认删除此登录令牌？<br /><br />",setDialogMode(2,"删除登录令牌",3,function(e,t){meshserver.send({action:"loginTokens",remove:[t]})},n=(n+=addHtmlValue("名称",EscapeHtml(i.name)))+addHtmlValue("用户名",EscapeHtml(i.tokenUser)),t))}}function gotoMesh(e){return currentMesh=meshes[e],p20updateMesh(),go(20),!1}function server_setupGoogleDriveBackup(){if(xxdialogMode||null==miscState.googleDrive)return!1;var e,t=miscState.googleDrive;t.state<3?(e='<img style=float:right src="images/googledrive-48.png" /><div>将此服务器设置为自动将备份上传到Google云端硬盘。首先为您的帐户创建并输入Google Drive ClientID和ClientSecret。</div><br />',setDialogMode(2,"Google云端硬盘备份",3,server_setupGoogleDriveBackupEx,e=(e=(e+=addHtmlValue("证书",'<a href="https://console.developers.google.com/apis/api/drive.googleapis.com/credentials" rel="noreferrer noopener" target="_blank">Google云端硬盘控制台</a>'))+addHtmlValue("客户编号",'<input id=gdclientid style=width:240px placeholder="xxxxxxxx.apps.googleusercontent.com" onkeyup=server_setupGoogleDriveBackupCheck1()></input>'))+addHtmlValue("客户机密","<input id=gdclientsecret style=width:240px onkeyup=server_setupGoogleDriveBackupCheck1()></input>"),"gd1"),Q("gdclientid").focus(),QE("idx_dlgOkButton",!1)):3==t.state&&(e='<img style=float:right src="images/googledrive-48.png" /><div>Google云端硬盘备份当前处于活动状态。</div>',setDialogMode(2,"Google云端硬盘备份",3,server_setupGoogleDriveBackupEx,e+="<br /><label><input id=gdcheck type=checkbox onchange=server_setupGoogleDriveBackupCheck2() />删除配置</label>","gd0"),QE("idx_dlgOkButton",!1))}function server_setupGoogleDriveBackupCheck1(){QE("idx_dlgOkButton",0<Q("gdclientid").value.length&&0<Q("gdclientsecret").value.length)}function server_setupGoogleDriveBackupCheck2(){QE("idx_dlgOkButton",Q("gdcheck").checked)}function server_setupGoogleDriveBackupCheck3(){QE("idx_dlgOkButton",0<Q("gdcode").value.length)}function server_setupGoogleDriveBackupEx(e,t){"gd0"==t&&meshserver.send({action:"serverBackup",service:"googleDrive",state:0}),"gd1"==t&&meshserver.send({action:"serverBackup",service:"googleDrive",state:1,clientid:Q("gdclientid").value,clientsecret:Q("gdclientsecret").value}),"gd2"==t&&meshserver.send({action:"serverBackup",service:"googleDrive",state:2,code:Q("gdcode").value})}function server_showRestoreDlg(){var e;return xxdialogMode||(e="使用备份还原服务器， <span style=color:red>这将删除现有服务器数据。</span> 。仅当您知道自己在做什么时才这样做。<br /><br />",setDialogMode(2,"还原服务器",0,null,e=(e=(e=(e+='<form action="/restoreserver.ashx'+(urlargs.key?"?key="+urlargs.key:"")+'" enctype="multipart/form-data" method="post"><div>')+("<input type=hidden name=auth value="+authCookie+">"))+'<input id=account_dlgFileInput type=file name=datafile style=width:100% accept=".zip,application/octet-stream,application/zip,application/x-zip,application/x-zip-compressed" onchange=account_validateServerRestore()><br /><br />'+"<input id=account_dlgCancelButton type=button value=取消 style=float:right;width:80px;margin-left:5px onclick=dialogclose(0)>")+"<input id=account_dlgOkButton type=submit value=OK style=float:right;width:80px onclick=dialogclose(1)>"+"</div><br /><br /></form>"),account_validateServerRestore()),!1}function account_validateServerRestore(){QE("account_dlgOkButton",1==Q("account_dlgFileInput").files.length)}function server_showVersionDlg(){return xxdialogMode||(setDialogMode(2,"MeshCentral版本",1,null,"载入中...","MeshCentralServerUpdate"),meshserver.send({action:"serverversion"})),!1}function server_showVersionDlgUpdate(){var e=Q("d2updateCheck1").checked,t=Q("d2updateCheck2").checked;QE("d2updateCheck1","未知"!=xxdialogTag.stable&&xxdialogTag.current!=xxdialogTag.stable&&0==t),QE("d2updateCheck2","未知"!=xxdialogTag.latest&&xxdialogTag.current!=xxdialogTag.latest&&0==e),QE("idx_dlgOkButton",e&&!t||!e&&t)}function server_showVersionDlgEx(e,t){Q("d2updateCheck1").checked&&meshserver.send({action:"serverupdate",tag:"stable",version:t.stable}),Q("d2updateCheck2").checked&&meshserver.send({action:"serverupdate",tag:"latest",version:t.latest})}function server_showErrorsDlg(){return xxdialogMode||(setDialogMode(2,"Server Errors",1,null,"载入中...","MeshCentralServerErrors"),meshserver.send({action:"servererrors"})),!1}function server_showErrorsDlgUpdate(){QE("idx_dlgOkButton",Q("d2clearErrorsCheck").checked)}function server_showErrorsDlgEx(){meshserver.send({action:"serverclearerrorlog"})}function d2CopyServerErrorsToClip(){saveAs(new Blob([Q("d2ServerErrorsLogPre").innerText],{type:"application/octet-stream"}),"servererrors.txt")}function server_showConfigDlg(){return xxdialogMode||(setDialogMode(2,"Server Configuration",1,null,"载入中...","MeshCentralServerConfig"),meshserver.send({action:"serverconfig"})),!1}function d2CopyServerConfigToClip(){saveAs(new Blob([Q("d2ServerConfigPre").innerText],{type:"application/octet-stream"}),"config.json")}function p20updateMesh(){if(null!=currentMesh){var e,t,n=GetMeshRights(currentMesh),i=EscapeHtml(currentMesh.name),o=(0==i.length&&(i="<i>没有</i>"),0!=(1&n)&&(i='<span tabindex=0 title="单击此处编辑设备组名称" onclick=p20editmesh(1) onkeyup="if (event.key == \'Enter\') p20editmesh(1)" style=cursor:pointer>'+i+' <img class=hoverButton src="images/link5.png" /></span>'),QH("p20meshName",i),QV("MeshSummary",4!=currentMesh.mtype),format("未知＃{0}",currentMesh.mtype)),s=(1==currentMesh.mtype&&(o="仅限英特尔&reg;AMT，无代理"),2==currentMesh.mtype&&(o="使用软件代理进行管理"),3==currentMesh.mtype&&(o=null==currentMesh.relayid?"本地设备，无代理":"没有代理设备通过代理中继"),4==currentMesh.mtype&&(o=null==currentMesh.relayid?"IP-KVM 设备":"通过代理中继的 IP-KVM 设备",1==currentMesh.kvm.model)&&(o+=", Raritan KX III"),"");if(0!=(8&args.hide)&&(s+=addHtmlValue("名称",i)),s=(s+=addHtmlValue("描述",addLinkConditional(currentMesh.desc&&""!=currentMesh.desc?EscapeHtml(currentMesh.desc):"<i>没有</i>","p20editmesh(2)",0!=(1&n))))+addHtmlValue("类型",o),3!=currentMesh.mtype&&4!=currentMesh.mtype||null==currentMesh.relayid||(i="<i>未知</i>",s+=addHtmlValue("中继装置",addLinkConditional(i=null!=(o=getNodeFromId(currentMesh.relayid))?EscapeHtml(o.name):i,"p20editmeshrelay()",0!=(1&n)))),4==currentMesh.mtype&&(s=(s+=addHtmlValue("主机名",currentMesh.kvm.host))+addHtmlValue("用户名",currentMesh.kvm.user)),null!=currentMesh.creatorid&&null!=users&&null!=users[currentMesh.creatorid]?s+=addHtmlValue("创建者",'<a onclick=gotoUser("'+encodeURIComponentEx((o=users[currentMesh.creatorid])._id)+'",false,null)>'+EscapeHtml(o.name)+"</a>"):null!=currentMesh.creatorname&&(s+=addHtmlValue("创建者",EscapeHtml(currentMesh.creatorname))),null!=currentMesh.creation&&(s+=addHtmlValue("创建时间",printDateTime(new Date(currentMesh.creation)))),3!=currentMesh.mtype&&(e=[],currentMesh.flags&&(1&currentMesh.flags&&e.push("自动删除"),2&currentMesh.flags&&e.push(4==currentMesh.mtype?"端口名称同步":"主机名同步"),1==serverinfo.devGroupSessionRecording)&&4&currentMesh.flags&&e.push("记录会议"),"number"==typeof currentMesh.expireDevs&&0<currentMesh.expireDevs&&e.push("移除不活跃"),s+=addHtmlValue("功能",addLinkConditional(e=""==(e=e.join(", "))?"<i>没有</i>":e,"p20editmeshfeatures()",1&n))),2==currentMesh.mtype&&(e=[],i=0,currentMesh.consent&&(i=currentMesh.consent),serverinfo.consent&&(i|=serverinfo.consent),64&i&&8&i?e.push("桌面提示+工具栏"):64&i?e.push("桌面工具栏"):8&i?e.push("桌面提示"):1&i&&e.push("桌面通知"),16&i?e.push("终端提示"):2&i&&e.push("终端通知"),32&i?e.push("档案提示"):4&i&&e.push("档案通知"),7==i&&(e=["一直通知"]),s+=addHtmlValue("用户同意",addLinkConditional(e=""==(e=(e=56==(56&i)?["一直提示"]:e).join(", "))?"<i>没有</i>":e,"p20editmeshconsent(1)",1&n))),3==currentMesh.mtype||4294967295!=userinfo.siteadmin&&0!=(1024&userinfo.siteadmin)||(o=0,i=[],userinfo.links&&userinfo.links[currentMesh._id]&&userinfo.links[currentMesh._id].notify&&(o|=userinfo.links[currentMesh._id].notify),userinfo.notify&&userinfo.notify[currentMesh._id]&&(o|=userinfo.notify[currentMesh._id]),2&o&&i.push("连接"),4&o&&i.push("断线"),8&o&&i.push("英特尔&reg;AMT"),16384&features2&&userinfo.emailVerified&&(t=0,16&o&&t++,32&o&&t++,64&o&&t++,0<t)&&i.push(format("Email ({0})",t)),null!=userinfo.msghandle&&0!=(33554432&features2)&&(t=0,128&o&&t++,256&o&&t++,512&o&&t++,0<t)&&i.push(format("Messaging ({0})",t)),0==i.length&&i.push("<i>没有</i>"),s+=addHtmlValue("通知",addLink(i.join(", "),"p20editMeshNotify()"))),16777216&features&&2==currentMesh.mtype&&(o=!(e="<i>没有</i>"),null!=currentMesh.invite&&(o=!0,e=currentMesh.invite.codes.join(", ")),s+=addHtmlValue("邀请码",addLinkConditional(e,"p20editmeshInviteCode()",1&n||o))),currentMesh.mtype<3&&0!=(1&features2)&&(t="没有政策",currentMesh.amt&&(1==currentMesh.amt.type?t="停用":2==currentMesh.amt.type?(t="简单客户端控制模式（CCM）",2==currentMesh.amt.cirasetup&&(t+=" + CIRA")):3==currentMesh.amt.type?(t="简单管理员控制模式（ACM）",2==currentMesh.amt.cirasetup&&(t+=" + CIRA")):4==currentMesh.amt.type&&(t="全自动的")),s+=addHtmlValue("英特尔&reg;AMT",addLinkConditional(t,"p20editMeshAmt()",1&n))),1&n&&(s+='<br><input type=button value=笔记 title="查看有关此设备组的注释" onclick=showNotes(false,"'+encodeURIComponentEx(currentMesh._id)+'") />'),s+="<br style=clear:both><br>",2&n&&(s+='<a href=# onclick="return p20showAddMeshUserDialog()" style=cursor:pointer;margin-right:10px><img src=images/icon-addnew.png border=0 height=12 width=12> 添加用户</a>',null!=usergroups)){var a=0,r=!1;for(h in usergroups)null==usergroups[h].membershipType&&usergroups[h]._id.split("/")[1]==currentMesh._id.split("/")[1]&&(a++,null==currentMesh.links||null==currentMesh.links[h])&&(r=!0);0<a&&r&&(s+='<a href=# onclick="return p20showAddMeshUserDialog(2)" style=cursor:pointer;margin-right:10px><img src=images/icon-addnew.png border=0 height=12 width=12> 添加用户组</a>')}1==currentMesh.mtype&&(1&n&&(s+='<a href=# style=cursor:pointer;margin-right:10px title="Import Intel&reg; AMT devices." onclick=\'return showAmtImport("'+currentMesh._id+"\")'><img src=images/icon-installmesh.png border=0 height=12 width=12> Import</a>"),null!=currentMesh.amt)&&0<currentMesh.amt.type&&(s+='<a href=# style=cursor:pointer;margin-right:10px title="执行英特尔&reg;AMT激活和配置。" onclick=\'return showAmtSetup("'+currentMesh._id+"\")'><img src=images/icon-installmesh.png border=0 height=12 width=12> 设定</a>"),2!=currentMesh.mtype||4294967295!=userinfo.siteadmin&&0!=(4096&userinfo.siteadmin)||(s=(s+="<a href=# onclick='return addAgentToMesh(\""+currentMesh._id+'")\' style=cursor:pointer;margin-right:10px title="通过安装Mesh Agent将新计算机添加到该设备组。"><img src=images/icon-addnew.png border=0 height=12 width=12> 添加代理</a>')+"<a href=# onclick='return inviteAgentToMesh(\""+currentMesh._id+'")\' style=cursor:pointer;margin-right:10px title="邀请某人在该设备组上安装Mesh代理。"><img src=images/icon-addnew.png border=0 height=12 width=12> 邀请</a>'),3!=currentMesh.mtype||4294967295!=userinfo.siteadmin&&0!=(4096&userinfo.siteadmin)||(s+="<a href=# onclick='return addLocalDeviceToMesh(\""+currentMesh._id+'")\' style=cursor:pointer;margin-right:10px title="添加位于本地网络上的设备。"><img src=images/icon-addnew.png border=0 height=12 width=12> 添加设备</a>'),currentMesh.amt&&2<currentMesh.amt.type&&(4294967295==userinfo.siteadmin||0==(4096&userinfo.siteadmin))&&(s+="<a href=# style=cursor:pointer;font-size:small title=\"将英特尔AMT切换到管理员控制模式（ACM）。\" onclick='return showAmtAcmSetup()'><img src=images/icon-installmesh.png border=0 height=12 width=12> ACM</a>"),s+='<table style="color:black;background-color:#EEE;border-color:#AAA;border-width:1px;border-style:solid;border-collapse:collapse" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col style=text-align:left;width:430px>用户授权</th><th scope=col style=text-align:left></th></tr>';var l=1,d=[];for(h in currentMesh.links){var c=h.split("/")[2];currentMesh.links[h].name&&(c=currentMesh.links[h].name),h==userinfo._id&&(c=userinfo.name),null!=usergroups&&null!=usergroups[h]&&(c=usergroups[h].name),d.push({id:h,name:c,rights:currentMesh.links[h].rights})}for(h in d.sort(function(e,t){return e.name>t.name?1:e.name<t.name?-1:0}),d){var u="",p=makeDeviceGroupRightsString(d[h].rights),m=2,g=(d[h].id==userinfo._id||4294967295!=n&&0==(2&n)||(4294967295!=n&&4294967295==currentMesh.links[d[h].id].rights||(u="<a href=# onclick='return p20deleteUser(event,\""+encodeURIComponentEx(d[h].id)+'")\' title="删除此设备组的用户权限" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>'),p='<span tabindex=0 style=cursor:pointer onclick=p20viewuser("'+encodeURIComponentEx(d[h].id)+"\") onkeypress=\"if (event.key=='Enter') p20viewuser('"+encodeURIComponentEx(d[h].id)+"')\">"+p+" <img class=hoverButton style=cursor:pointer src=images/link5.png></span>"),d[h].id.startsWith("ugrp/")&&(m=4),EscapeHtml(decodeURIComponent(d[h].name)));null!=usergroups&&d[h].id.startsWith("ugrp/")&&(g="<a tabindex=0 href=# onclick='gotoUserGroup(\""+encodeURIComponentEx(d[h].id)+"\");haltEvent(event);'>"+g+"</a>"),s+="<tr style="+(l%2==0?";background-color:#DDD":"")+'><td style=width:30%><div title="用户" class=m'+m+"></div><div>&nbsp;"+(g=null!=users&&d[h].id.startsWith("user/")?"<a tabindex=0 href=# onclick='gotoUser(\""+encodeURIComponentEx(d[h].id)+"\");haltEvent(event);'>"+g+"</a>":g)+"<div></div></div></td><td style=width:70%><div style=float:right>"+u+"</div><div>"+p+"</div></td></tr>",++l}if(s+="</tbody></table>",null!=deviceShares&&deviceSharesNode==currentMesh._id&&0<deviceShares.length){s+='<p></p><table style="color:black;background-color:#EEE;border-color:#AAA;border-width:1px;border-style:solid;border-collapse:collapse" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col style=text-align:left;width:430px>主动设备共享</th><th scope=col style=text-align:left><th scope=col style=text-align:left></th></tr>';for(var l=1,h=0;h<deviceShares.length;h++){var v=deviceShares[h],u="",f=(null!=v.url&&(u+='<a href="'+v.url+'" rel="noreferrer noopener" target=_blank title="设备共享链接" style=cursor:pointer><img src=images/link2.png border=0 height=10 width=10></a> '),u+="<a href=# onclick='return p30removeDeviceSharing(event,\""+encodeURIComponentEx(v.nodeid)+'","'+encodeURIComponentEx(v.publicid)+'","'+encodeURIComponentEx(v.guestName)+'")\' title="删除设备共享" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>',""),k=(v.p<=7?f=["","终端","桌面","桌面 + 终端","档案","终端 + 文件","桌面 + 文件","桌面 + 终端 + 文件"][v.p]:8==v.p?f="HTTP/"+v.port:16==v.p&&(f="HTTPS/"+v.port),f),f=(null!=v.startTime&&null!=v.expireTime&&(k=format("{0}，{1}至{2}",f,printFlexDateTime(new Date(v.startTime)),printFlexDateTime(new Date(v.expireTime)))),null!=v.startTime&&null!=v.duration&&(k=(v.duration,format("{0}、{1} {2} 分钟",f,printFlexDateTime(new Date(v.startTime)),v.duration))),1==v.recurring&&(k+=", 每天重复"),2==v.recurring&&(k+=", 每周重复一次"),0!=(2&v.p)&&!0===v.viewOnly&&(k+=", 仅查看桌面"),null!=v.consent&&(0==v.consent?k+=", 不同意":(0!=(56&v.consent)&&(k+="，提示同意"),0!=(64&v.consent)&&(k+=", 工具栏"))),EscapeHtml(v.guestName));v.publicid.startsWith("AS:node/")&&(f="<i>代理自行共享</i>"),null!=(y=getNodeFromId(v.nodeid))&&(b=0<y.conn?"":" gray",s+="<tr "+(++l%2==0?"style=background-color:#DDD":"")+"><td style=width:30%>"+("<div onclick='gotoDevice(\""+y._id+'",10);haltEvent(event);\' style=float:left class="j'+y.icon+b+'"></div>&nbsp;<a onclick=\'gotoDevice("'+y._id+"\",10);haltEvent(event);'>"+EscapeHtml(y.name)+"</a>")+"<td style=width:30%><div class=m2></div><div>&nbsp;"+f+"<div></div></div></td><td style=width:70%><div style=float:right>"+u+"</div><div>"+k+"</div></td></tr>")}s+="</tbody></table>"}else deviceSharesNode!=currentMesh._id&&deviceSharesReq!=currentMesh._id&&(deviceSharesReq=currentMesh._id,meshserver.send({action:"deviceMeshShares",meshid:currentMesh._id}));l=0,nodes.sort(deviceSort);var i="",x=(1==currentMesh.mtype&&(i+='<a onclick=meshDownloadDeviceList()><img title="下载设备列表" src="images/link4.png" /></a>',0==(1&features))&&(i+=' <a onclick=meshImportDeviceList()><img title="导入设备列表" src="images/link6.png" /></a>'),'<table style="color:black;background-color:#EEE;border-color:#AAA;border-width:1px;border-style:solid;border-collapse:collapse" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col style=text-align:left;width:430px>设备</th><th scope=col style=text-align:right>'+i+"</th></tr>");for(h in nodes){var y,b=0<(y=nodes[h]).conn?"":" gray";currentMesh._id==y.meshid&&(x+="<tr style="+(l%2==0?";background-color:#DDD":"")+"><td style=width:30%><div onclick='gotoDevice(\""+y._id+'",10);haltEvent(event);\' style=float:left class="j'+y.icon+b+'"></div>&nbsp;<a onclick=\'gotoDevice("'+y._id+"\",10);haltEvent(event);'>"+EscapeHtml(y.name)+"</a></div></div></td><td style=width:70%><div style=float:right>"+PowerStateStr(y.pwr)+"&nbsp;</div><div>"+(y.osdesc?EscapeHtml(y.osdesc):"")+"</div></td></tr>",++l)}0==l&&(x+="<tr><td><i>没有</i></td></tr>"),x+="</tbody></table>",4294967295==n&&(x+="<div style=font-size:small;text-align:right><span><a href=# onclick=p20showDeleteMeshDialog() style=cursor:pointer>删除群组</a></span></div>"),QH("p20info",s),QH("p20info2",x);var w="";if(0==(268435456&features)&&20<=xxcurrentView&&xxcurrentView<=29&&null!=currentMesh){for(var h in w="?viewmode="+xxcurrentView+"&gotomesh="+currentMesh._id.split("/")[2],urlargs)w+="&"+h+"="+urlargs[h];try{window.history.replaceState({},document.title,window.location.pathname+w)}catch(e){}}}}function meshDownloadDeviceList(){if(!xxdialogMode){var e,t={webappversion:"0.9.0",computers:[]};for(e in nodes){var n,i=nodes[e];currentMesh._id==i.meshid&&null!=i.intelamt&&(n={name:i.name,host:i.host,user:i.intelamt.user,pass:"",tls:1==i.intelamt.tls?1:0,ver:i.intelamt.ver,pstate:i.intelamt.state},2==i.intelamt.state&&(n.pmode=1),i.intelamt.realm&&(n.digestrealm=i.intelamt.realm),i.intelamt.hash&&(n.tlscerthash=i.intelamt.hash),t.computers.push(n))}saveAs(stringToUtf8BlobNoHeader(JSON.stringify(t,null,2)),currentMesh.name+".json")}}function meshImportDeviceList(){xxdialogMode||(setDialogMode(2,"导入英特尔&reg; AMT 设备",3,meshImportDeviceListEx,'以 MeshCommander JSON 格式导入本地英特尔&reg; AMT 设备列表。<br /><br /><input style=width:370px type=file id=d4importFile accept=".json" onchange=meshImportDeviceListValidate() />'),QE("idx_dlgOkButton",!1))}function meshImportDeviceListValidate(){QE("idx_dlgOkButton",null!=Q("d4importFile").value)}function meshImportDeviceListEx(){var e=new FileReader;e.onload=function(e){var t=null;try{t=JSON.parse(e.target.result)}catch(e){return void setDialogMode(2,"导入英特尔&reg; AMT 设备",1,null,format("无效的JSON档案：{0}。",e))}if("object"==typeof t&&"string"==typeof t.webappversion&&"object"==typeof t.computers&&Array.isArray(t.computers)){var n,i=0;for(n in t.computers){var o,s=t.computers[n];"string"==typeof s.name&&"string"==typeof s.host&&"string"==typeof s.user&&"string"==typeof s.pass&&(o={action:"addamtdevice",meshid:currentMesh._id,devicename:s.name,hostname:s.host,amtusername:s.user,amtpassword:s.pass,amttls:1==s.tls?1:0},"string"==typeof s.ver&&(o.ver=s.ver),"number"==typeof s.pstate&&(o.state=s.pstate),"string"==typeof s.digestrealm&&(o.realm=s.digestrealm),"string"==typeof s.tlscerthash&&(o.hash=s.tlscerthash),meshserver.send(o),i++)}0==i&&setDialogMode(2,"用户帐户导入",1,null,"无法导入任何设备。")}else setDialogMode(2,"导入英特尔&reg; AMT 设备",1,null,"无效的JSON档案格式。")},e.readAsText(Q("d4importFile").files[0])}function p20editMeshAmt(){xxdialogMode||(setDialogMode(2,"英特尔&reg;AMT政策",3,p20editMeshAmtEx,""+addHtmlValue("类型","<select id=dp20amtpolicy style=width:230px onchange=p20editMeshAmtChange()><option value=0>没有政策</option><option value=1>停用</option><option value=2>简单客户端控制模式（CCM）</option>"+(0!=(1048576&features)?"<option value=3>简单管理员控制模式（ACM）</option>":"")+"<option value=4>全自动的</option></select>")+"<div id=dp20amtpolicydiv></div>"),currentMesh.amt&&(Q("dp20amtpolicy").value=currentMesh.amt.type),p20editMeshAmtChange(),!currentMesh.amt||2!=currentMesh.amt.type&&3!=currentMesh.amt.type||(Q("dp20amtpolicypass").value=currentMesh.amt.password,2!=currentMesh.amt.type&&3!=currentMesh.amt.type||(null!=currentMesh.amt.badpass&&(Q("dp20amtbadpass").value=currentMesh.amt.badpass),3==currentMesh.amt.type&&null!=currentMesh.amt.ccm&&(Q("dp20amtccmmode").value=currentMesh.amt.ccm)),0==(1024&features)&&(Q("dp20amtcira").value=currentMesh.amt.cirasetup)),dp20amtValidatePolicy())}function p20editMeshAmtChange(){var e=Q("dp20amtpolicy").value,t="";2!=e&&3!=e||(t=(t=(t=t+addHtmlValue("密码","<select id=dp20amtpass style=width:230px onchange=dp20amtValidatePolicy() onkeyup=dp20amtValidatePolicy()><option value=0>随机密码</option>"+(null!=currentMesh.amt&&1==currentMesh.amt.password?"<option value=1 selected>保留现有密码</option>":"")+"<option value=2>选择新密码</option></select>")+"<div id=dp20amtpassdiv style=display:none>")+addHtmlValue("新密码*","<input id=dp20amtpolicypass type=password style=width:230px maxlength=32 onchange=dp20amtValidatePolicy() onkeyup=dp20amtValidatePolicy() autocomplete=off />"))+addHtmlValue("新密码*","<input id=dp20amtpolicypass2 type=password style=width:230px maxlength=32 onchange=dp20amtValidatePolicy() onkeyup=dp20amtValidatePolicy() autocomplete=off />")+"</div>",3==e&&(t+=addHtmlValue("CCM模式","<select id=dp20amtccmmode style=width:230px onchange=dp20amtValidatePolicy() onkeyup=dp20amtValidatePolicy()><option value=0>请勿更改，如果设置请保留CCM</option><option value=1>如果设置停用CCM</option><option value=2>如果ACM失败，则激活到CCM</option></select>")),t=(t+="<div id=dp20amtbadpassdiv style=display:none>")+addHtmlValue("密码未知","<select id=dp20amtbadpass style=width:230px><option value=0>什么都不做</option><option value=1>如果在CCM中，请重新激活英特尔&reg;AMT</option></select>")+"</div>",0==(1024&features)&&(t+=addHtmlValue('<span title="客户端启动的远程访问">CIRA设置</span>',"<select id=dp20amtcira style=width:230px><option value=0>什么都不做</option><option value=1>不要连接到服务器</option><option value=2>连接到服务器</option></select>")),t+='<span id=dp10passNotify style="font-size:10px"> * 8-16个字符，1个大写，1个小写，1个数字，1个非字母数字。</span>',2==currentMesh.mtype&&2==e&&(t+='<span style="font-size:10px"> 此政策不会影响采用ACM模式的英特尔&reg;AMT的设备。</span>')),0==e&&(t="<table style=padding-top:4px><tr><td><img style=padding-right:8px src=images/rcheckbox60.png width=60 height=60><td>选择此策略时，此服务器不管理英特尔&reg;AMT。 仍然可以通过手动激活和配置Intel AMT来使用它。</table>"),1==e&&(t="<table style=padding-top:4px><tr><td><img style=padding-right:8px src=images/rcheckbox60.png width=60 height=60><td>选择此策略后，将禁用处于客户端控制模式（CCM）的所有英特尔&reg;AMT。 其他设备将清除CIRA，并且仍然可以手动进行管理。</table>"),4==e&&(t="<table style=padding-top:4px><tr><td><img style=padding-right:8px src=images/checkbox60.png width=60 height=60><td>这是推荐的策略。英特尔&reg;AMT激活和管理是完全自动化的，服务器将尝试最大程度地利用硬件管理。</table>"),QH("dp20amtpolicydiv",t),setTimeout(dp20amtValidatePolicy,500)}function dp20amtValidatePolicy(){var e,t=!0,n=Q("dp20amtpolicy").value;2!=n&&3!=n||2!=Q("dp20amtpass").value||(t=(e=Q("dp20amtpolicypass").value)===Q("dp20amtpolicypass2").value&&passwordcheck(e)),QE("idx_dlgOkButton",t),2!=n&&3!=n||QV("dp20amtpassdiv",2==Q("dp20amtpass").value),QV("dp10passNotify",(2==n||3==n)&&2==Q("dp20amtpass").value),QV("dp20amtbadpassdiv",2==n||3==n&&1!=Q("dp20amtccmmode").value)}function p20editMeshAmtEx(){var e=parseInt(Q("dp20amtpolicy").value),t={type:e},n=null;2!=e&&3!=e||(0==Q("dp20amtpass").value&&(n=""),1==Q("dp20amtpass").value&&(n=null),2==Q("dp20amtpass").value&&(n=Q("dp20amtpolicypass").value)),2==e?(t={type:e,password:n,badpass:parseInt(Q("dp20amtbadpass").value)}).cirasetup=0==(1024&features)?parseInt(Q("dp20amtcira").value):1:3==e?(t={type:e,password:n,badpass:parseInt(Q("dp20amtbadpass").value),ccm:parseInt(Q("dp20amtccmmode").value)}).cirasetup=0==(1024&features)?parseInt(Q("dp20amtcira").value):1:4==e&&(t={type:e}),meshserver.send({action:"meshamtpolicy",meshid:currentMesh._id,amtpolicy:t})}function p20showDeleteMeshDialog(){var e;return xxdialogMode||(e=format("你确定要删除组{0}吗？删除设备组还将删除该组中有关设备的所有信息。",EscapeHtml(currentMesh.name))+"<br /><br />",setDialogMode(2,"删除群组",3,p20showDeleteMeshDialogEx,e+="<label><input id=p20check type=checkbox onchange=p20validateDeleteMeshDialog() />确认</label>"),p20validateDeleteMeshDialog()),!1}function p20validateDeleteMeshDialog(){QE("idx_dlgOkButton",Q("p20check").checked)}function p20showDeleteMeshDialogEx(e,t){meshserver.send({action:"deletemesh",meshid:currentMesh._id,meshname:currentMesh.name})}function p20editmeshrelay(){if(!xxdialogMode){var e=[];if(0==(2&features))for(var t in nodes){var n=nodes[t];2==n.mtype&&null!=n.agent&&4294967295==GetNodeRights(n)&&e.push(n)}if(e.sort(nameSort),0==e.length)setDialogMode(2,"编辑设备组",1,null,"没有可用的中继设备。");else{var i=[];for(t in e)i.push('<option value="'+e[t]._id+'"'+(currentMesh.relayid==e[t]._id?" selected":"")+">"+EscapeHtml(e[t].name)+"</option>");setDialogMode(2,"编辑设备组",3,p20editmeshrelayEx,addHtmlValue("中继装置","<div style=width:230px;margin:0;padding:0><select id=d2devrelay style=width:100%>"+i.join("")+"</select></div>"))}}}function p20editmeshrelayEx(){meshserver.send({action:"editmesh",meshid:currentMesh._id,relayid:Q("d2devrelay").value})}function p20editmesh(e){var t;xxdialogMode||(t=addHtmlValue("名称","<input id=dp20meshname style=width:230px maxlength=128 onchange=p20editmeshValidate() onkeyup=p20editmeshValidate(event) />"),setDialogMode(2,"编辑设备组",3,p20editmeshEx,t+=addHtmlValue("描述","<div style=width:230px;margin:0;padding:0><textarea id=dp20meshdesc maxlength=1024 style=width:100%;resize:none></textarea></div>")),Q("dp20meshname").value=currentMesh.name,currentMesh.desc&&(Q("dp20meshdesc").value=currentMesh.desc),p20editmeshValidate(),(2==e?Q("dp20meshdesc"):Q("dp20meshname")).focus())}function p20editmeshEx(){meshserver.send({action:"editmesh",meshid:currentMesh._id,meshname:Q("dp20meshname").value,desc:Q("dp20meshdesc").value})}function p20editmeshValidate(e){QE("idx_dlgOkButton",0<Q("dp20meshname").value.length),e&&"Enter"==e.key&&Q("dp20meshdesc").focus()}function p20editmeshconsent(e){var t,n,i;xxdialogMode||(n=0,i=t="",1==e&&(n=currentMesh.consent||0,i="编辑设备组用户同意"),2==e&&(n=currentUser.consent||0,i="编辑用户同意"),3==e&&(n=currentNode.consent||0,i="编辑设备用户同意"),4==e&&(n=currentUserGroup.consent||0,i="编辑用户组用户同意"),setDialogMode(2,i,3,p20editmeshconsentEx,t=(t=(t=(t=(t=t+'<div style="width:100%;border-bottom:1px solid gray;margin-bottom:5px"><b>桌面</b></div>'+("<div><label><input type=checkbox id=d20flag1 "+(1&n?"checked":"")+">通知使用者</label></div>"))+("<div><label><input type=checkbox id=d20flag2 "+(8&n?"checked":"")+">用户同意提示</label></div>")+("<div><label><input type=checkbox id=d20flag7 "+(64&n?"checked":"")+">显示连接工具栏</label></div>"))+'<div style="width:100%;border-bottom:1px solid gray;margin-bottom:5px;margin-top:8px"><b>终端</b></div>'+("<div><label><input type=checkbox id=d20flag3 "+(2&n?"checked":"")+">通知使用者</label></div>"))+("<div><label><input type=checkbox id=d20flag4 "+(16&n?"checked":"")+">用户同意提示</label></div>")+'<div style="width:100%;border-bottom:1px solid gray;margin-bottom:5px;margin-top:8px"><b>档案</b></div>')+("<div><label><input type=checkbox id=d20flag5 "+(4&n?"checked":"")+">通知使用者</label></div>")+("<div><label><input type=checkbox id=d20flag6 "+(32&n?"checked":"")+">用户同意提示</label></div>"),e),serverinfo.consent&&(1&serverinfo.consent&&(Q("d20flag1").checked=!0),8&serverinfo.consent&&(Q("d20flag2").checked=!0),2&serverinfo.consent&&(Q("d20flag3").checked=!0),16&serverinfo.consent&&(Q("d20flag4").checked=!0),4&serverinfo.consent&&(Q("d20flag5").checked=!0),32&serverinfo.consent&&(Q("d20flag6").checked=!0),64&serverinfo.consent&&(Q("d20flag7").checked=!0),QE("d20flag1",!(1&serverinfo.consent)),QE("d20flag2",!(8&serverinfo.consent)),QE("d20flag3",!(2&serverinfo.consent)),QE("d20flag4",!(16&serverinfo.consent)),QE("d20flag5",!(4&serverinfo.consent)),QE("d20flag6",!(32&serverinfo.consent)),QE("d20flag7",!(64&serverinfo.consent))))}function p20editmeshconsentEx(e,t){var n=0;Q("d20flag1").checked&&(n+=1),Q("d20flag2").checked&&(n+=8),Q("d20flag3").checked&&(n+=2),Q("d20flag4").checked&&(n+=16),Q("d20flag5").checked&&(n+=4),Q("d20flag6").checked&&(n+=32),Q("d20flag7").checked&&(n+=64),1==t&&meshserver.send({action:"editmesh",meshid:currentMesh._id,consent:n}),2==t&&meshserver.send({action:"edituser",id:currentUser._id,consent:n}),3==t&&meshserver.send({action:"changedevice",nodeid:currentNode._id,consent:n}),4==t&&meshserver.send({action:"editusergroup",ugrpid:currentUserGroup._id,consent:n})}function p20editmeshfeatures(){var e,t,n;xxdialogMode||(e=currentMesh.flags||0,t="",n=0,"number"==typeof currentMesh.expireDevs&&0<currentMesh.expireDevs&&2e3<(n=currentMesh.expireDevs)&&(n=2e3),1==serverinfo.devGroupSessionRecording&&4!=currentMesh.mtype&&(t+="<div><label><input type=checkbox id=d20flag4 onchange=p20editmeshfeaturesValidate() "+(4&e?"checked":"")+">记录会议</label><br></div>"),t=(t=2!=currentMesh.mtype&&4!=currentMesh.mtype?t:t+("<div><label><input type=checkbox id=d20flag2 onchange=p20editmeshfeaturesValidate() "+(2&e?"checked":"")+">"+(4==currentMesh.mtype?"将服务器设备名称同步到端口名称":"将服务器设备名称同步到主机名称"))+"</label><br></div><div><label><input type=checkbox id=d20flag1 onchange=p20editmeshfeaturesValidate() "+(1&e?"checked":"")+">断开连接后移除设备</label><br></div>")+"<div><label><input type=checkbox id=d20expireDevice onchange=p20editmeshfeaturesValidate() "+(0<n?"checked":"")+'>自动移除非活动设备</label><br></div><div style=margin-left:20px id=d20expireDeviceDev>停用天数直到移除 <label><input type=number inputmode=numeric onchange=p20editmeshfeaturesValidate() onkeyup=p20editmeshfeaturesValidate() onpaste=p20editmeshfeaturesValidate() onkeydown=p20editmeshfeaturesValidate() maxlength=4 min=1 max=2000 style=width:80px value="'+(0==n?30:n)+'" id=d20expireDeviceDays></label><br></div>',serverinfo.autoremoveinactivedevices&&(1==serverinfo.autoremoveinactivedevices?t+=format("<span style=font-size:x-small;margin-left:6px>默认情况下，不活动的设备将在 1 天后移除。</span>",serverinfo.autoremoveinactivedevices):t+=format("<span style=font-size:x-small;margin-left:6px>默认情况下，非活动设备将在 {0} 天后移除。</span>",serverinfo.autoremoveinactivedevices)),setDialogMode(2,"编辑设备组功能",3,p20editmeshfeaturesEx,t),p20editmeshfeaturesValidate())}function p20editmeshfeaturesValidate(){var e=0,t=!0,e=(2!=currentMesh.mtype&&4!=currentMesh.mtype||!Q("d20flag1").checked||(e+=1),QE("d20expireDevice",0==(1&e)),0==(1&e)&&Q("d20expireDevice").checked);QV("d20expireDeviceDev",e),e&&(e=parseInt(Q("d20expireDeviceDays").value),isNaN(e)||e<1||2e3<e||e!=Q("d20expireDeviceDays").value)&&(t=!1),QE("idx_dlgOkButton",t)}function p20editmeshfeaturesEx(){var e=0,t=(2!=currentMesh.mtype&&4!=currentMesh.mtype||(Q("d20flag1").checked&&(e+=1),Q("d20flag2").checked&&(e+=2)),1==serverinfo.devGroupSessionRecording&&4!=currentMesh.mtype&&Q("d20flag4").checked&&(e+=4),0);0==(1&e)&&Q("d20expireDevice").checked&&(t=parseInt(Q("d20expireDeviceDays").value)),meshserver.send({action:"editmesh",meshid:currentMesh._id,flags:e,expireDevs:t})}function p20showAddMeshUserDialog(e,t){if(!xxdialogMode){var n="";if(null==e||5==e)null==t&&(n+=null==e?"允许用户管理此设备组和该组中的设备。":"允许用户管理此设备。",524288&features&&(n+=" 用户需要先登录到该服务器一次，然后才能将其添加到设备组。"),n+="<br /><br />"),n=(n+="<div style='position:relative'>")+addHtmlValue("用户标识符",'<input id=dp20username style=width:230px maxlength=256 onchange=p20validateAddMeshUserDialog() onkeyup=p20validateAddMeshUserDialog() placeholder="user1, user2, user3" />')+"<div id=dp20usersuggest class=suggestionBox style='top:30px;left:130px;display:none'></div></div><br>";else if(1==e){var i="";if(null==t)for(l in s=getOrderedList(meshes,"name"))null!=currentUser.links&&null!=currentUser.links[s[l]._id]||(i+="<option value="+encodeURIComponentEx(s[l]._id)+">"+EscapeHtml(s[l].name)+"</option>");else i+="<option value="+t+">"+EscapeHtml(meshes[decodeURIComponent(t)].name)+"</option>";n+=addHtmlValue("设备组","<div style=width:230px;margin:0;padding:0><select onchange=p20validateAddMeshUserDialog() id=dp2groupid style=width:100%"+(t?" disabled":"")+">"+i+"</select></div>")}else if(2==e){if(null==usergroups)return;i="";for(l in o=getOrderedList(usergroups,"name"))currentMesh._id.split("/")[1]!=o[l]._id.split("/")[1]||null!=currentMesh.links&&null!=currentMesh.links[o[l]._id]||(i+="<option value="+encodeURIComponentEx(o[l]._id)+">"+EscapeHtml(o[l].name)+"</option>");n+=addHtmlValue("用户组","<div style=width:230px;margin:0;padding:0><select onchange=p20validateAddMeshUserDialog() id=dp2groupid style=width:100%>"+i+"</select></div>")}else if(6==e){if(null==usergroups)return;var o,i="";if(null==t)for(l in o=getOrderedList(usergroups,"name"))null!=o[l].membershipType||currentNode._id.split("/")[1]!=o[l]._id.split("/")[1]||null!=currentNode.links&&null!=currentNode.links[o[l]._id]||(i+="<option value="+encodeURIComponentEx(o[l]._id)+">"+EscapeHtml(o[l].name)+"</option>");else i+="<option value="+t+">"+EscapeHtml(usergroups[decodeURIComponent(t)].name)+"</option>";n+=addHtmlValue("用户组","<div style=width:230px;margin:0;padding:0><select onchange=p20validateAddMeshUserDialog() id=dp2groupid style=width:100%"+(t?" disabled":"")+">"+i+"</select></div>")}else if(3==e){i="";for(l in t=t&&decodeURIComponent(t),s=getOrderedList(meshes,"name"))null==t&&null!=currentUserGroup.links&&null!=currentUserGroup.links[s[l]._id]||(i+="<option value="+encodeURIComponentEx(s[l]._id)+(t==s[l]._id?" selected":" ")+">"+EscapeHtml(s[l].name)+"</option>");n+=addHtmlValue("设备组","<div style=width:230px;margin:0;padding:0><select onchange=p20validateAddMeshUserDialog("+e+") id=dp2groupid style=width:100%>"+i+"</select></div>")}else if(4==e||7==e){var s,i="",a=null,r=null;for(l in null!=t&&null!=(r=getNodeFromId(decodeURIComponent(t)))&&(a=r.meshid),s=getOrderedList(meshes,"name"))null!=s[l].links[userinfo._id]&&7&s[l].links[userinfo._id].rights&&(null==a&&(a=s[l]._id),i+="<option value="+encodeURIComponentEx(s[l]._id)+(a==s[l]._id?" selected":" ")+">"+EscapeHtml(s[l].name)+"</option>");n+=addHtmlValue("设备组","<div style=width:230px;margin:0;padding:0><select onchange=p20changeMeshAddMeshUserDialog("+e+") id=dp2meshid style=width:100%>"+i+"</select></div>"),i="";var l,d=getOrderedList(nodes,"name");for(l in d)d[l].meshid==a&&(i+="<option value="+encodeURIComponentEx(d[l]._id)+(r==d[l]?" selected":" ")+">"+EscapeHtml(d[l].name)+"</option>");n+=addHtmlValue("设备","<div style=width:230px;margin:0;padding:0><select onchange=p20validateAddMeshUserDialog("+e+") id=dp2nodeid style=width:100%>"+i+"</select></div>")}else{var c=(e=decodeURIComponent(e)).split("/")[2];users&&users[e]&&(c=users[e].name),usergroups&&usergroups[e]&&(c=usergroups[e].name),userinfo._id==e&&(c=userinfo.name),e.startsWith("ugrp/")?n+=format("{0}的群组权限。",c)+"<br /><br />":n+=format("用户{0}的群组权限。",c)+"<br /><br />"}var c=-1,u=4!=e&&5!=e&&6!=e&&7!=e;n+='<div style="height:120px;overflow-y:scroll;border:1px solid gray;resize:vertical;">',u&&(n+="<label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20fulladmin>完整管理员</label><br><label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20editmesh>编辑设备组</label><br><label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20manageusers>管理设备组用户</label><br><label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20managecomputers>管理设备组计算机</label><br>"),n=(n+="<label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20remotecontrol>Remote Control & Relay</label><br>")+"<label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20remoteview style=margin-left:12px>仅远程查看</label><br>"+"<label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20remotelimitedinput style=margin-left:12px>仅有限输入</label><br>",!1!==serverinfo.guestdevicesharing&&(n+="<label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20guestshare style=margin-left:12px>嘉宾分享</label><br>"),n=(n=(n=(n=(n=(n=(n=(n=n+"<label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20nodesktop style=margin-left:12px>不能访问桌面</label><br>"+"<label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20noterminal style=margin-left:12px>不能访问终端</label><br>")+"<label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20nofiles style=margin-left:12px>不能存取档案</label><br>"+"<label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20noamt style=margin-left:12px>没有英特尔&reg;AMT</label><br>")+"<label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20meshagentconsole>Mesh代理控制台</label><br>"+"<label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20meshserverfiles>服务器档案</label><br>")+"<label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20wakedevices>唤醒设备</label><br>"+"<label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20editnotes>编辑设备笔记</label><br>")+"<label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20limitevents>只显示自己的事件</label><br>"+"<label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20chatnotify>聊天并通知</label><br>")+"<label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20uninstall>卸载代理/删除设备</label><br>"+"<label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20commands>远程命令</label><br>")+"<label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20resetoff>重置/关闭电源</label><br>"+"<label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20details>设备详情</label><br>")+"<label><input type=checkbox onchange=p20validateAddMeshUserDialog() id=p20relay>Use as Relay</label><br>"+"</div>",null==e?(setDialogMode(2,"将用户添加到设备组",3,p20showAddMeshUserDialogEx,n),QE("p20fulladmin",4294967295==GetMeshRights(currentMesh)),Q("dp20username").focus()):1===e?(setDialogMode(2,null==t?"添加设备组权限":"编辑设备组权限",t?7:3,p20showAddMeshUserDialogEx,n,e),4294967295==(c=null!=t?meshes[decodeURIComponent(t)].links[currentUser._id].rights:c)&&(Q("p20fulladmin").checked=!0,c=-1)):2===e?(setDialogMode(2,"添加用户组",3,p20showAddMeshUserDialogEx,n,e),QE("p20fulladmin",4294967295==GetMeshRights(currentMesh))):3===e?(setDialogMode(2,null==t?"添加设备组":"编辑设备组",t?7:3,p20showAddMeshUserDialogEx,n,e),QE("dp2groupid",null==t),4294967295==(c=null!=t?currentUserGroup.links[decodeURIComponent(t)].rights:c)&&(Q("p20fulladmin").checked=!0,c=-1)):4===e?(setDialogMode(2,null==t?"添加设备权限":"编辑设备权限",t?7:3,p20showAddMeshUserDialogEx,n,e),QE("dp2meshid",null==t),QE("dp2nodeid",null==t)):7===e?(setDialogMode(2,null==t?"添加设备权限":"编辑设备权限",t?7:3,p20showAddMeshUserDialogEx,n,e),QE("dp2meshid",null==t),QE("dp2nodeid",null==t),null!=t&&(c=currentUserGroup.links[decodeURIComponent(t)].rights,QE("dp20username",!1))):5===e?(setDialogMode(2,t?"编辑用户设备权限":"添加用户设备权限",t?7:3,p20showAddMeshUserDialogEx,n,e),null!=t&&(t=decodeURIComponent(t),null!=users&&null!=users[t]?Q("dp20username").value=users[t].name:Q("dp20username").value=t.split("/")[2],c=currentNode.links[t].rights,QE("dp20username",!1)),Q("dp20username").focus()):6===e?(setDialogMode(2,t?"编辑用户组设备权限":"添加用户组设备权限",t?7:3,p20showAddMeshUserDialogEx,n,e),null!=t&&(c=currentNode.links[decodeURIComponent(t)].rights)):(e.startsWith("ugrp/")?setDialogMode(2,"编辑设备组权限",7,p20showAddMeshUserDialogEx,n,e):setDialogMode(2,"编辑用户设备组权限",7,p20showAddMeshUserDialogEx,n,e),GetMeshRights(currentMesh),4294967295==(c=GetMeshRights(currentMesh,e))&&(Q("p20fulladmin").checked=!0,c=-1),QE("p20fulladmin",4294967295==GetMeshRights(currentMesh))),-1!=c&&(u&&(1&c&&(Q("p20editmesh").checked=!0),2&c&&(Q("p20manageusers").checked=!0),4&c)&&(Q("p20managecomputers").checked=!0),8&c&&(Q("p20remotecontrol").checked=!0,65536&c&&(Q("p20nodesktop").checked=!0),256&c&&(Q("p20remoteview").checked=!0),524288&c&&!1!==serverinfo.guestdevicesharing&&(Q("p20guestshare").checked=!0),512&c&&(Q("p20noterminal").checked=!0),1024&c&&(Q("p20nofiles").checked=!0),2048&c&&(Q("p20noamt").checked=!0),4096&c)&&(Q("p20remotelimitedinput").checked=!0),16&c&&(Q("p20meshagentconsole").checked=!0),32&c&&(Q("p20meshserverfiles").checked=!0),64&c&&(Q("p20wakedevices").checked=!0),128&c&&(Q("p20editnotes").checked=!0),8192&c&&(Q("p20limitevents").checked=!0),16384&c&&(Q("p20chatnotify").checked=!0),32768&c&&(Q("p20uninstall").checked=!0),131072&c&&(Q("p20commands").checked=!0),262144&c&&(Q("p20resetoff").checked=!0),524288&c&&!1!==serverinfo.guestdevicesharing&&(Q("p20guestshare").checked=!0),1048576&c&&(Q("p20details").checked=!0),2097152&c)&&(Q("p20relay").checked=!0),p20validateAddMeshUserDialog(e)}return!1}function p20changeMeshAddMeshUserDialog(e){var t,n="",i=decodeURIComponent(Q("dp2meshid").value);for(t in nodes)nodes[t].meshid==i&&(n+="<option value="+encodeURIComponentEx(nodes[t]._id)+">"+EscapeHtml(nodes[t].name)+"</option>");QH("dp2nodeid",n),p20validateAddMeshUserDialog(e)}function p20setname(e){e=decodeURIComponent(e);var t,n=Q("dp20username").value.split(",");for(t in n)n[t]=n[t].trim();return n[n.length-1]=e,Q("dp20username").value=n.join(", "),p20validateAddMeshUserDialog(),!1}function p20validateAddMeshUserDialog(e){var t,n,i=!0;if(4===e&&(e=0,""!=(t=decodeURIComponent(Q("dp2nodeid").value))&&null!=currentUser.links&&null!=currentUser.links[t]&&(e=currentUser.links[t].rights),Q("p20remotecontrol").checked=0!=(8&e),Q("p20meshagentconsole").checked=0!=(16&e),Q("p20meshserverfiles").checked=0!=(32&e),Q("p20wakedevices").checked=0!=(64&e),Q("p20editnotes").checked=0!=(128&e),Q("p20remoteview").checked=0!=(256&e),Q("p20noterminal").checked=0!=(512&e),Q("p20nofiles").checked=0!=(1024&e),Q("p20noamt").checked=0!=(2048&e),Q("p20remotelimitedinput").checked=0!=(4096&e),Q("p20limitevents").checked=0!=(8192&e),Q("p20chatnotify").checked=0!=(16384&e),Q("p20uninstall").checked=0!=(32768&e),Q("p20nodesktop").checked=0!=(65536&e),Q("p20commands").checked=0!=(131072&e),Q("p20resetoff").checked=0!=(262144&e),!1!==serverinfo.guestdevicesharing&&(Q("p20guestshare").checked=0!=(524288&e)),Q("p20details").checked=0!=(1048576&e),Q("p20relay").checked=0!=(2097152&e),i=""!=t),Q("dp20username")){var o=Q("dp20username").value.split(",");for(c in o){var s=o[c]=o[c].trim();(0==s.length||0<=s.indexOf('"'))&&(i=!1)}var e=!1,a=!1;if(null!=users){var r=o[o.length-1].trim(),l=r.toLowerCase(),d=[];if(0<r.length){for(var c in users){var u=users[c]._id.split("/");if((null==currentMesh||currentMesh.domain==u[1])&&(null==currentNode||currentNode.domain==u[1])){if(u[2]===l){a=!0;break}if(0<=users[c].name.toLowerCase().indexOf(l)&&(d.push([users[c]._id,users[c].name]),8<=d.length))break}}if(0==a&&0<d.length){var p="";for(c in d){var m=d[c][0],g=d[c][1];m.split("/")[2]==g.toLowerCase()?p+="<div class=suggestionBoxItem onclick='p20setname(\""+encodeURIComponentEx(m.split("/")[2])+"\")'>"+EscapeHtml(g)+"</div>":p+="<div class=suggestionBoxItem onclick='p20setname(\""+encodeURIComponentEx(m.split("/")[2])+"\")'><div>"+EscapeHtml(g)+"</div><div class=suggestionBoxSubItem>"+EscapeHtml(m.split("/")[2])+"</div></div>"}QH("dp20usersuggest",p),e=!0}}}QV("dp20usersuggest",e)}QE("idx_dlgOkButton",i),null!=Q("p20fulladmin")?(n=!Q("p20fulladmin").checked,QE("p20editmesh",n),QE("p20manageusers",n),QE("p20managecomputers",n)):n=""!=t,QE("p20remotecontrol",n),QE("p20meshagentconsole",n),QE("p20meshserverfiles",n),QE("p20wakedevices",n),QE("p20editnotes",n),QE("p20limitevents",n),QE("p20remoteview",n&&Q("p20remotecontrol").checked),!1!==serverinfo.guestdevicesharing&&QE("p20guestshare",n&&Q("p20remotecontrol").checked&&(Q("p20remoteview").checked||!Q("p20remotelimitedinput").checked)),QE("p20remotelimitedinput",n&&Q("p20remotecontrol").checked&&!Q("p20remoteview").checked),QE("p20nodesktop",n&&Q("p20remotecontrol").checked),QE("p20noterminal",n&&Q("p20remotecontrol").checked),QE("p20nofiles",n&&Q("p20remotecontrol").checked),QE("p20noamt",n&&Q("p20remotecontrol").checked),QE("p20chatnotify",n),QE("p20uninstall",n),QE("p20commands",n),QE("p20resetoff",n),QE("p20details",n),QE("p20relay",n)}function p20showAddMeshUserDialogEx(e,t){var n,i,o=0;if(null!=Q("p20fulladmin")&&1==Q("p20fulladmin").checked?o=4294967295:(null!=Q("p20fulladmin")&&(1==Q("p20editmesh").checked&&(o+=1),1==Q("p20manageusers").checked&&(o+=2),1==Q("p20managecomputers").checked)&&(o+=4),1==Q("p20remotecontrol").checked&&(o+=8),1==Q("p20meshagentconsole").checked&&(o+=16),1==Q("p20meshserverfiles").checked&&(o+=32),1==Q("p20wakedevices").checked&&(o+=64),1==Q("p20editnotes").checked&&(o+=128),1==Q("p20remoteview").checked&&(o+=256),1==Q("p20nodesktop").checked&&(o+=65536),1==Q("p20noterminal").checked&&(o+=512),1==Q("p20nofiles").checked&&(o+=1024),1==Q("p20noamt").checked&&(o+=2048),1!=Q("p20remotelimitedinput").checked||Q("p20remoteview").checked||(o+=4096),1==Q("p20limitevents").checked&&(o+=8192),1==Q("p20chatnotify").checked&&(o+=16384),1==Q("p20uninstall").checked&&(o+=32768),1==Q("p20commands").checked&&(o+=131072),1==Q("p20resetoff").checked&&(o+=262144),!1===serverinfo.guestdevicesharing||1!=Q("p20guestshare").checked||!Q("p20remoteview").checked&&(Q("p20remoteview").checked||Q("p20remotelimitedinput").checked)||(o+=524288),1==Q("p20details").checked&&(o+=1048576),1==Q("p20relay").checked&&(o+=2097152)),0==(8&o)&&(256&o&&(o-=256),512&o&&(o-=512),1024&o&&(o-=1024),2048&o&&(o-=2048),4096&o&&(o-=4096),65536&o)&&(o-=65536),1===t){var s=decodeURIComponent(Q("dp2groupid").value);null!=(r=meshes[s])&&meshserver.send({action:"addmeshuser",meshid:s,meshname:r.name,userids:[currentUser._id],meshadmin:o,remove:2==e})}else if(2===t){var a=decodeURIComponent(Q("dp2groupid").value);null!=(r=meshes[currentMesh._id])&&meshserver.send({action:"addmeshuser",meshid:currentMesh._id,meshname:currentMesh.name,userid:a,meshadmin:o,remove:2==e})}else if(3===t){var r,s=decodeURIComponent(Q("dp2groupid").value);null!=(r=meshes[s])&&meshserver.send({action:"addmeshuser",meshid:s,meshname:r.name,userids:[currentUserGroup._id],meshadmin:o,remove:2==e})}else if(4===t)null!=(i=getNodeFromId(n=decodeURIComponent(Q("dp2nodeid").value)))&&meshserver.send({action:"adddeviceuser",nodeid:n,nodename:i.name,userids:[currentUser._id],rights:o,remove:2==e});else if(5===t){var l=[];for(c in d=Q("dp20username").value.split(","))l.push(d[c].trim());meshserver.send({action:"adddeviceuser",nodeid:currentNode._id,nodename:currentNode.name,usernames:l,rights:o,remove:2==e})}else if(6===t){a=decodeURIComponent(Q("dp2groupid").value);null!=currentNode&&meshserver.send({action:"adddeviceuser",nodeid:currentNode._id,nodename:currentNode.name,userids:[a],rights:o,remove:2==e})}else if(7===t)null!=(i=getNodeFromId(n=decodeURIComponent(Q("dp2nodeid").value)))&&meshserver.send({action:"adddeviceuser",nodeid:n,nodename:i.name,userids:[currentUserGroup._id],rights:o,remove:2==e});else if(null==t){var d,c,l=[];for(c in d=Q("dp20username").value.split(","))l.push(d[c].trim());meshserver.send({action:"addmeshuser",meshid:currentMesh._id,meshname:currentMesh.name,usernames:l,meshadmin:o,remove:2==e})}else meshserver.send({action:"addmeshuser",meshid:currentMesh._id,meshname:currentMesh.name,userids:[t],meshadmin:o,remove:2==e})}function p20viewuser(e){var t,n,i,o,s,a;xxdialogMode||(t=decodeURIComponent(e),n=GetMeshRights(currentMesh),i=GetMeshRights(currentMesh,t),userinfo._id!=t&&(4294967295==n||0!=(2&n)&&4294967295!=i)?p20showAddMeshUserDialog(e):(e=[],4294967295==i?e.push("完整管理员（保留所有权利）"):(0!=(1&i)&&e.push("编辑设备组"),0!=(2&i)&&e.push("管理设备组用户"),0!=(4&i)&&e.push("管理设备组计算机"),0!=(8&i)&&e.push("遥控"),0!=(16&i)&&e.push("代理控制台"),0!=(32&i)&&e.push("服务器档案"),0!=(64&i)&&e.push("唤醒设备"),0!=(128&i)&&e.push("编辑笔记"),0!=(8&i)&&0!=(256&i)&&e.push("仅远程查看"),0!=(8&i)&&0!=(65536&i)&&e.push("没有桌面"),0!=(8&i)&&0!=(512&i)&&e.push("没有终端"),0!=(8&i)&&0!=(1024&i)&&e.push("没有文件"),0!=(8&i)&&0!=(2048&i)&&e.push("没有英特尔&reg;AMT"),0!=(8&i)&&0!=(4096&i)&&0==(256&i)&&e.push("有限输入"),0!=(8192&i)&&e.push("仅自我事件"),0!=(16384&i)&&e.push("聊天并通知"),0!=(32768&i)&&e.push("卸载"),0!=(131072&i)&&e.push("指令"),0!=(262144&i)&&e.push("重置/关闭"),0!=(524288&i)&&e.push("分享"),0!=(1048576&i)&&e.push("细节"),0!=(2097152&i)&&e.push("中继")),0==e.length&&e.push("沒有权限"),o=t.split("/")[2],users&&users[t]&&(o=users[t].name),userinfo._id==t&&(o=userinfo.name),s=1,a=addHtmlValue("用户名",EscapeHtml(decodeURIComponent(o))),t.split("/")[2]!=o&&(a+=addHtmlValue("用户识别码",EscapeHtml(t.split("/")[2]))),a+=addHtmlValue("权限",e.join("，")),userinfo._id!=t&&(4294967295==n||0!=(2&n)&&4294967295!=i)&&(s+=4),setDialogMode(2,"设备组用户",s,p20viewuserEx,a,t)))}function p20viewuserEx(e,t){2==e&&(e=t.split("/")[2],users&&users[t]&&(e=users[t].name),usergroups&&usergroups[t]&&(e=usergroups[t].name),userinfo._id==t&&(e=userinfo.name),t.startsWith("user/")&&setDialogMode(2,"删除用户权限",3,p20viewuserEx2,format("确认删除用户“ {0} ”的权限？",EscapeHtml(decodeURIComponent(e))),t),t.startsWith("ugrp/"))&&setDialogMode(2,"删除用户组权限",3,p20viewuserEx2,format("确认删除用户组“ {0} ”的权限？",EscapeHtml(decodeURIComponent(e))),t)}function p20deleteUser(e,t){return haltEvent(e),p20viewuserEx(2,decodeURIComponent(t)),!1}function p20viewuserEx2(e,t){meshserver.send({action:"removemeshuser",meshid:currentMesh._id,meshname:currentMesh.name,userid:t})}function p20editmeshInviteCode(){if(xxdialogMode)return!1;var e,t=GetMeshRights(currentMesh),n=serverinfo.name;-1!=n.indexOf(".")&&0==(2&features)||(n=window.location.hostname),n=1==serverinfo.https?"https://"+n+(443==serverinfo.port?"":":"+serverinfo.port)+domainUrl+"invite"+(urlargs.key?"?key="+urlargs.key:""):"http://"+n+(80==serverinfo.port?"":":"+serverinfo.port)+domainUrl+"invite"+(urlargs.key?"?key="+urlargs.key:""),1&t?(setDialogMode(2,"邀请码",3,p20editmeshInviteCodeEx,e=(e=(e=(e=(e="启用后，任何人都可以使用邀请代码通过以下公共连结将设备加入该设备组：<br /><br />")+('<div style=width:100%;text-align:center><a rel="noreferrer noopener" target=_blank href="'+n+'">'+n+"</a></div><br />")+"<div style=margin-bottom:5px><label><input id=agentJoinCheck type=checkbox onclick=p20editmeshInviteCodeValidate() />启用邀请代码</label></div>")+addHtmlValue("邀请码",'<input id=agentInviteCode style=width:236px onkeyup=p20editmeshInviteCodeValidate() placeholder="code1, code2, code3" />'))+addHtmlValue("代理","<select id=agentType style=width:236px onchange=p20editmeshInviteCodeValidate()><option value=0>所有可用的代理</option><option value=1>Windows MeshAgent</option><option value=2>Linux MeshAgent</option><option value=4>MacOS MeshAgent</option><option value=8>MeshCentral 助手</option></select>")+"<div id=d2agentInstallTypeDiv>")+addHtmlValue("安装类型","<select id=agentInviteType style=width:236px><option value=0>后台运行与交互式运行</option><option value=2>仅后台运行</option><option value=1>仅交互式运行</option></select>")+"</div>"),null!=currentMesh.invite&&(Q("agentJoinCheck").checked=!0,Q("agentInviteCode").value=currentMesh.invite.codes.join(", "),currentMesh.invite.ag&&(Q("agentType").value=currentMesh.invite.ag),Q("agentInviteType").value=3&currentMesh.invite.flags),p20editmeshInviteCodeValidate()):(e="任何人都可以使用邀请代码通过以下公共连接将设备加入该设备组：<br /><br />",setDialogMode(2,"邀请码",1,null,e=(e=(e+='<div style=width:100%;text-align:center><a rel="noreferrer noopener" target=_blank href="'+n+'">'+n+"</a></div><br />")+addHtmlValue("邀请码",currentMesh.invite.codes.join(", ")))+addHtmlValue("安装类型",["后台运行与交互式运行","仅交互式运行","仅后台运行"][3&currentMesh.invite.flags])))}function p20editmeshInviteCodeValidate(){var e,t=!0,n=Q("agentInviteCode").value.split(",");for(e in n)n[e]=n[e].trim(),""==n[e]&&(t=!1);QE("agentInviteCode",Q("agentJoinCheck").checked),QE("agentType",Q("agentJoinCheck").checked),QE("agentInviteType",Q("agentJoinCheck").checked),QE("idx_dlgOkButton",0==Q("agentJoinCheck").checked||t),QV("d2agentInstallTypeDiv",parseInt(Q("agentType").value)<2)}function p20editmeshInviteCodeEx(){if(1==Q("agentJoinCheck").checked){var e,t=Q("agentInviteCode").value.split(",");for(e in t)t[e]=t[e].trim();meshserver.send({action:"editmesh",meshid:currentMesh._id,invite:{codes:t,flags:parseInt(Q("agentInviteType").value),ag:parseInt(Q("agentType").value)}})}else meshserver.send({action:"editmesh",meshid:currentMesh._id,invite:"*"})}function p20editMeshNotify(){var e,t,n;return xxdialogMode||(e=0,t=16384&features2&&userinfo.emailVerified,userinfo.links&&userinfo.links[currentMesh._id]&&userinfo.links[currentMesh._id].notify&&(e|=userinfo.links[currentMesh._id].notify),userinfo.notify&&userinfo.notify[currentMesh._id]&&(e|=userinfo.notify[currentMesh._id]),n='<div style="border-bottom: 1px solid #888;margin-bottom:3px">网页通知</div><div><label><input id=p20notifyIntelDeviceConnect type=checkbox />设备连接。</label></div><div><label><input id=p20notifyIntelDeviceDisconnect type=checkbox />设备断开连接。</label></div>',currentMesh.mtype<3&&(n+="<div><label><input id=p20notifyIntelAmtKvmActions type=checkbox />英特尔&reg;AMT桌面和串行事件</label></div>"),t&&(n+='<br /><div style="border-bottom: 1px solid #888;margin-bottom:3px">电子邮件通知</div><div><label><input id=p20enotifyIntelDeviceConnect type=checkbox />设备连接。</label></div><div><label><input id=p20enotifyIntelDeviceDisconnect type=checkbox />设备断开连接。</label></div><div><label><input id=p20enotifyIntelDeviceHelp type=checkbox />Help requests</label></div>'),null!=userinfo.msghandle&&0!=(33554432&features2)&&(n+='<br /><div style="border-bottom: 1px solid #888;margin-bottom:3px">Messaging Notifications</div><div><label><input id=p20emsgDeviceConnect type=checkbox />设备连接。</label></div><div><label><input id=p20emsgDeviceDisconnect type=checkbox />设备断开连接。</label></div><div><label><input id=p20emsgDeviceHelp type=checkbox />Help requests</label></div>'),setDialogMode(2,"通知设置",3,p20editMeshNotifyEx,n,t),Q("p20notifyIntelDeviceConnect").checked=2&e,Q("p20notifyIntelDeviceDisconnect").checked=4&e,currentMesh.mtype<3&&(Q("p20notifyIntelAmtKvmActions").checked=8&e),t&&(Q("p20enotifyIntelDeviceConnect").checked=16&e,Q("p20enotifyIntelDeviceDisconnect").checked=32&e,Q("p20enotifyIntelDeviceHelp").checked=64&e),null!=userinfo.msghandle&&0!=(33554432&features2)&&(Q("p20emsgDeviceConnect").checked=128&e,Q("p20emsgDeviceDisconnect").checked=256&e,Q("p20emsgDeviceHelp").checked=512&e)),!1}function p20editMeshNotifyEx(e,t){var n=0,n=(n+=Q("p20notifyIntelDeviceConnect").checked?2:0)+(Q("p20notifyIntelDeviceDisconnect").checked?4:0);currentMesh.mtype<3&&(n+=Q("p20notifyIntelAmtKvmActions").checked?8:0),t&&(n=(n=(n+=Q("p20enotifyIntelDeviceConnect").checked?16:0)+(Q("p20enotifyIntelDeviceDisconnect").checked?32:0))+(Q("p20enotifyIntelDeviceHelp").checked?64:0)),null!=userinfo.msghandle&&0!=(33554432&features2)&&(n=(n=(n+=Q("p20emsgDeviceConnect").checked?128:0)+(Q("p20emsgDeviceDisconnect").checked?256:0))+(Q("p20emsgDeviceHelp").checked?512:0)),meshserver.send({action:"changemeshnotify",meshid:currentMesh._id,notify:n})}function setupMeshSummaryStats(){window.meshPowerChart=new Chart(document.getElementById("meshPowerChart").getContext("2d"),{type:"doughnut",data:{datasets:[{data:[0,0],backgroundColor:["#20F","#40D","#60B","#809","#A07","#C05"]}]},options:{shadowColor:"blue",responsive:!0,plugins:{legend:{display:!1}},animation:{animateScale:!0,animateRotate:!0},layout:{padding:{left:10,right:10,top:10,bottom:10}}}}),window.meshOsChart=new Chart(document.getElementById("meshOsChart").getContext("2d"),{type:"doughnut",data:{datasets:[{data:[0,0],backgroundColor:["#20F","#30E","#40D","#50C","#60B","#70A","#809","#908","#A07","#B06","#C05"]}]},options:{responsive:!0,plugins:{legend:{display:!1}},animation:{animateScale:!0,animateRotate:!0},layout:{padding:{left:10,right:10,top:10,bottom:10}}}}),window.meshConnChart=new Chart(document.getElementById("meshConnChart").getContext("2d"),{type:"doughnut",data:{datasets:[{data:[0,0],backgroundColor:["#20F","#40D","#60B","#809","#A07","#C05"]}],labels:["未连接","代理","英特尔&reg;AMT","代理+英特尔AMT"]},options:{responsive:!0,plugins:{legend:{display:!1}},animation:{animateScale:!0,animateRotate:!0},layout:{padding:{left:10,right:10,top:10,bottom:10}}}}),window.meshSecurityChart=new Chart(document.getElementById("meshSecurityChart").getContext("2d"),{type:"doughnut",data:{datasets:[{data:[0,0],backgroundColor:["#20F","#40D","#60B","#809","#A07","#C05"]}],labels:["OK","杀毒软件未激活","没有自动更新","防火墙未激活","多个问题"]},options:{responsive:!0,plugins:{legend:{display:!1}},animation:{animateScale:!0,animateRotate:!0},layout:{padding:{left:10,right:10,top:10,bottom:10}}}})}function p21updateMesh(){if(null!=currentMesh){var e,t=GetMeshRights(currentMesh),n=EscapeHtml(currentMesh.name),i=(0==n.length&&(n="<i>没有</i>"),0!=(1&t)&&(n='<span tabindex=0 title="单击此处编辑设备组名称" onclick=p20editmesh(1) onkeyup="if (event.key == \'Enter\') p20editmesh(1)" style=cursor:pointer>'+n+' <img class=hoverButton src="images/link5.png" /></span>'),QH("p21meshName",n),{}),o={},s=[0,0,0,0],a=[0,0,0,0,0],r=!1,l=!1,d=!1,c=!1;for(b in nodes)nodes[b].meshid==currentMesh._id&&(nodes[b].agent&&(r=!0,null==i[nodes[b].agent.id]?i[nodes[b].agent.id]=1:i[nodes[b].agent.id]++),nodes[b].pwr&&(l=!0,null==o[nodes[b].pwr]?o[nodes[b].pwr]=1:o[nodes[b].pwr]++),0==nodes[b].conn?(d=!0,s[0]++):0!=(6&nodes[b].conn)?(d=!0,0!=(1&nodes[b].conn)?s[3]++:s[2]++):0!=(1&nodes[b].conn)&&(d=!0,s[1]++),nodes[b].wsc)&&(c=!0,e=0,"OK"==nodes[b].wsc.antiVirus&&e++,"OK"==nodes[b].wsc.autoUpdate&&e++,"OK"==nodes[b].wsc.firewall&&e++,3==e?a[0]++:e<2?a[4]++:"OK"!=nodes[b].wsc.antiVirus?a[1]++:"OK"!=nodes[b].wsc.autoUpdate?a[2]++:"OK"!=nodes[b].wsc.firewall&&a[3]++);var u=[],p=[],m=[],g=[],h=3==currentMesh.mtype?agentsStrNoAgent:agentsStr;for(b in i)u.push(i[b]),p.push(h[b]);for(b in o)m.push(o[b]),g.push(powerStatetable[b]);window.meshPowerChart.config.data.datasets[0].data=m,window.meshPowerChart.config.data.labels=g,window.meshPowerChart.update(),2<=currentMesh.mtype&&(window.meshOsChart.config.data.datasets[0].data=u,window.meshOsChart.config.data.labels=p,window.meshOsChart.update()),window.meshConnChart.config.data.datasets[0].data=s,window.meshConnChart.update(),window.meshSecurityChart.config.data.datasets[0].data=a,window.meshSecurityChart.update();var v="",f=0;if(0<m.length){var k=[];for(b in o)k.push([powerStatetable[b],o[b]]);for(b in k.sort(function(e,t){return-(e[1]-t[1])}),v+='<table style="margin-top:10px;color:black;background-color:#EEE;border-color:#AAA;border-width:1px;border-style:solid;border-collapse:collapse" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col colspan=2 style=text-align:left;width:430px>电源状态</th></tr>',k)v+="<tr style="+(++f%2==0?"background-color:#DDD":"")+"><td style=text-align:right;width:60px>"+k[b][1]+" <td> "+k[b][0]+"</tr>";v+="</tbody></table>"}if(0<u.length&&2<=currentMesh.mtype){var f=0,x=[];for(b in i)x.push([h[b],i[b]]);for(b in x.sort(function(e,t){return-(e[1]-t[1])}),v+='<table style="margin-top:10px;color:black;background-color:#EEE;border-color:#AAA;border-width:1px;border-style:solid;border-collapse:collapse" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col colspan=2 style=text-align:left;width:430px>代理类型</th></tr>',x)v+="<tr style="+(++f%2==0?"background-color:#DDD":"")+"><td style=text-align:right;width:60px>"+x[b][1]+"<td> "+x[b][0]+"</tr>";v+="</tbody></table>"}if(d){for(var y=[],b=f=0;b<4;b++)y.push([["未连接","代理","英特尔&reg;AMT","代理+英特尔AMT"][b],s[b]]);y.sort(function(e,t){return-(e[1]-t[1])}),v+='<table style="margin-top:10px;color:black;background-color:#EEE;border-color:#AAA;border-width:1px;border-style:solid;border-collapse:collapse" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col colspan=2 style=text-align:left;width:430px>连接性</th></tr>';for(b=0;b<4;b++)0<y[b][1]&&(v+="<tr style="+(++f%2==0?"background-color:#DDD":"")+"><td style=text-align:right;width:60px>"+y[b][1]+"<td> "+y[b][0]+"</tr>");v+="</tbody></table>"}if(c){for(var w=[],b=f=0;b<4;b++)w.push([['<img src="images/link2.png" style=cursor:pointer onclick=\'return p21setDevicesFilter("wsc:ok")\' width=10 height=10 /> OK','<img src="images/link2.png" style=cursor:pointer onclick=\'return p21setDevicesFilter("wsc:noav")\' width=10 height=10 /> 杀毒软件未激活','<img src="images/link2.png" style=cursor:pointer onclick=\'return p21setDevicesFilter("wsc:noupdate")\' width=10 height=10 /> 没有自动更新','<img src="images/link2.png" style=cursor:pointer onclick=\'return p21setDevicesFilter("wsc:nofirewall")\' width=10 height=10 /> 防火墙未激活','<img src="images/link2.png" style=cursor:pointer onclick=\'return p21setDevicesFilter("wsc:any")\' width=10 height=10 /> 多个问题'][b],a[b]]);w.sort(function(e,t){return-(e[1]-t[1])}),v+='<table style="margin-top:10px;color:black;background-color:#EEE;border-color:#AAA;border-width:1px;border-style:solid;border-collapse:collapse" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col colspan=2 style=text-align:left;width:430px>安全</th></tr>';for(b=0;b<4;b++)0<w[b][1]&&(v+="<tr style="+(++f%2==0?"background-color:#DDD":"")+"><td style=text-align:right;width:60px>"+w[b][1]+"<td> "+w[b][0]+"</tr>");v+="</tbody></table>"}""==v&&(v="<i>该设备组中没有设备。</i>"),QH("p21info",v);t=(l?1:0)+(2<=currentMesh.mtype&&r?1:0)+(d?1:0)+(c?1:0);QS("meshPowerChartDiv").display=l?"inline-block":"none",QS("meshOsChartDiv").display=2<=currentMesh.mtype&&r?"inline-block":"none",QS("meshConnChartDiv").display=d?"inline-block":"none",QS("meshSecurityChartDiv").display=c?"inline-block":"none",QS("meshPowerChartDiv").width=3<t?"23%":"31%",QS("meshOsChartDiv").width=3<t?"23%":"31%",QS("meshConnChartDiv").width=3<t?"23%":"31%",QS("meshSecurityChartDiv").width=3<t?"23%":"31%"}}function p21setDevicesFilter(e){go(1),Q("KvmSearchInput").value=Q("SearchInput").value=e,mainUpdate(5)}var sortorder,filetreelocation=[];function updateFiles(){if(QV("MainMenuMyFiles",0==(8&features)),0==(8&features)){for(var e,t,n="",i="",o='<a href=# style=cursor:pointer onclick="return p5folderup(0)">根</a>',s="Root",a=filetree,r=1,l=[],d=filetreelinkpath,c=[],u=document.getElementsByName("fc"),p=0;p<u.length;p++)u[p].checked&&c.push(u[p].value);for(p in filetreelinkpath="",filetreelocation){if(null==a.f||null==a.f[filetreelocation[p]])break;l.push(filetreelocation[p]),s+=" / "+filetreelocation[p],1==r?(e=filetreelocation[p].split("/"),t=window.location.origin+domainUrl+e[0]+"files/"+e[2],filetreelinkpath+=filetreelocation[p]):""!=filetreelinkpath&&(filetreelinkpath+="/"+filetreelocation[p],2<r)&&(t+="/"+filetreelocation[p]),a=a.f[filetreelocation[p]],o+=' / <a href=# style=cursor:pointer onclick="return p5folderup('+r+')">'+EscapeHtml(null!=a.n?a.n:filetreelocation[p])+"</a>",r++}filetreelocation=l;var m=s.toLowerCase().startsWith("root / "+userinfo._id+" / public"),g=p5sort_files(a.f);for(p in g){var h,v,f=g[p],k=f.n,x=70<k.length?'<span title="'+EscapeHtml(k)+'">'+EscapeHtml(k.substring(0,70))+"...</span>":EscapeHtml(k),y="",b=(null!=f.d&&(y=printDateTime(new Date(f.d))+"&nbsp;"),""),w=(null!=f.s&&(b=getFileSizeStr(f.s)),"");w=f.t<3||4==f.t?(h=1==f.t||4==f.t?p5getQuotabar(f):"",'<div class=filelist file=999><input file=999 style=float:left name=fc class=fcb type=checkbox onchange=p5setActions() value="'+EscapeHtml(k)+'">&nbsp;<span style=float:right title="">'+h+"</span><span><div class=fileIcon"+f.t+' onclick=p5folderset("'+encodeURIComponentEx(f.nx)+'")></div><a href=# style=cursor:pointer onclick=\'return p5folderset("'+encodeURIComponentEx(f.nx)+"\")'>"+x+"</a></span></div>"):(k=x,h="",v=urlargs.key?"&key="+urlargs.key:"",m&&(h='<img src="images/link2.png" style=cursor:pointer title="显示公共连结" onclick=\'return p5showPublicLink("'+t+"/"+encodeURIComponentEx(f.nx)+"?download=1"+v+'")\' width=10 height=10 /> <img src="images/link4.png" title="复制连结到剪贴板" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(t+"/"+encodeURIComponentEx(f.nx)+"?download=1"+v)+'") width=10 height=10>'),0<f.s&&(k=h+'<a onclick=downloadFile("downloadfile.ashx?link='+encodeURIComponentEx(filetreelinkpath+"/"+f.nx)+'")>'+x+"</a>"),'<div class=filelist file=3><input file=3 style=float:left name=fc class=fcb type=checkbox onchange=p5setActions() value="'+f.nx+'">&nbsp;<span class=fsize>'+y+"</span><span style=float:right>"+b+"</span><span><div class=fileIcon"+f.t+"></div>"+k+"</span></div>"),f.t<3?n+=w:i+=w}if(QH("p5rightOfButtons",p5getQuotabar(a)),QH("p5files",n+i),QH("p5currentpath",o),QE("p5FolderUp",0!=filetreelocation.length),QV("p5PublicShare",m),d==filetreelinkpath)for(u=document.getElementsByName("fc"),p=0;p<u.length;p++)u[p].checked=0<=c.indexOf(u[p].value);p5setActions()}}function getNiceSize(e){return e<=0?"超出储存空间":e<2048?format("剩余{0}个字节",e):e<2097152?format("剩余{0}千字节",Math.round(e/1024)):e<2147483648?format("剩余{0}兆字节",Math.round(e/1024/1024)):format("剩余{0} GB",Math.round(e/1024/1024/1024))}function getNiceSize2(e){return e<=0?"没有":e<2048?format("{0} b",e):e<2097152?format("{0} Kb",Math.round(e/1024)):e<2147483648?format("{0} Mb",Math.round(e/1024/1024)):format("{0} Gb",Math.round(e/1024/1024/1024))}function getNiceSize3(e){return e<=0?"没有":e<2048?format("{0} b",e):e<2097152?format("{0} Kb",round(e/1024,1)):e<2147483648?format("{0} Mb",round(e/1024/1024,1)):format("{0} Gb",round(e/1024/1024/1024,1))}function p5getQuotabar(e){for(;1<e.t&&4!=e.t;)e=e.parent;var t,n;return 1!=e.t&&4!=e.t||null==e.maxbytes?"":(t=Math.floor(e.s/1024),n=e.maxbytes-e.s,'<span title="'+(1<e.c?format("{1}k在{0}个文件中。最多{2}k",t,e.c,Math.floor(e.maxbytes/1024/1024)):format("{0}k在1档案内。最多{1}k",t,Math.floor(e.maxbytes/1024/1024)))+'">'+getNiceSize(n)+" <progress style=height:10px;width:100px value="+e.s+" max="+e.maxbytes+" /></span>")}function p5showPublicLink(e){return setDialogMode(2,"公开连结",1,null,'<input type=text style=width:350px value="'+e+'" readonly /> <img src="images/link4.png" title="复制连结到剪贴板" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(e)+'") width=10 height=10>'),!1}function p5sort_filename(e,t){return e.ln>t.ln?+sortorder:e.ln<t.ln?-1*sortorder:0}function p5sort_timestamp(e,t){return e.d>t.d?+sortorder:e.d<t.d?-1*sortorder:0}function p5sort_bysize(e,t){return e.s==t.s?p5sort_filename(e,t):(e.s-t.s)*sortorder}function p5sort_files(e){var t,n=[],i=Q("p5sortdropdown").value;for(t in e)e[t].nx=t,null==e[t].n&&(e[t].n=t),e[t].ln=e[t].n.toLowerCase(),n.push(e[t]);return sortorder=1,3<i&&(sortorder=-1,i-=3),1==i?n.sort(p5sort_filename):2==i?n.sort(p5sort_bysize):3==i&&n.sort(p5sort_timestamp),n}function p5setActions(){var e=getFileSelCount(),t=getFileCount(),n=getFileSelCount(!1);QE("p5DeleteFileButton",0<e&&0<filetreelocation.length),QE("p5ViewFileButton",1==e&&1==n&&0<filetreelocation.length),QE("p5NewFolderButton",0<filetreelocation.length),QE("p5UploadButton",0<filetreelocation.length),QE("p5DownloadButton",0<e&&e==n&&0<filetreelocation.length),QE("p5RenameFileButton",1==e&&0<filetreelocation.length),QE("p5SelectAllButton",0<t),Q("p5SelectAllButton").value=0<e?"取消全选":"全选",QE("p5CutButton",0<n&&e==n),QE("p5CopyButton",0<n&&e==n),QE("p5PasteButton",null!=p5clipboard&&0<p5clipboard.length&&0<filetreelocation.length)}function getFileSelCount(e){for(var t=0,n=document.getElementsByName("fc"),i=0;i<n.length;i++)!n[i].checked||0==e&&"3"!=n[i].attributes.file.value||t++;return t}function getFileSelDirCount(){for(var e=0,t=document.getElementsByName("fc"),n=0;n<t.length;n++)t[n].checked&&"999"==t[n].attributes.file.value&&e++;return e}function getFileCount(){return document.getElementsByName("fc").length}function p5selectallfile(){for(var e=0==getFileSelCount(),t=document.getElementsByName("fc"),n=0;n<t.length;n++)t[n].checked=e;p5setActions()}function setupBackPointers(e){if(null!=e.f){var t,n=0,i=0;for(t in e.f)setupBackPointers(e.f[t]),(e.f[t].parent=e).f[t].s&&(n+=e.f[t].s),e.f[t].c&&(i+=e.f[t].c),3==e.f[t].t&&i++;e.s=n,e.c=i}return e}function getFileSizeStr(e){return 1==(e="number"!=typeof e?0:e)?"1个字节":format("{0}个字节",e)}function p5folderup(e){if(null==e)filetreelocation.pop();else for(;filetreelocation.length>e;)filetreelocation.pop();return updateFiles(),!1}function p5folderset(e){return filetreelocation.push(decodeURIComponent(e)),updateFiles(),!1}function p5createfolder(){setDialogMode(2,"新建文件夹",3,p5createfolderEx,"<input type=text id=p5renameinput maxlength=64 onkeyup=p5fileNameCheck(event) style=width:100% />"),focusTextBox("p5renameinput"),p5fileNameCheck()}function p5createfolderEx(){meshserver.send({action:"fileoperation",fileop:"createfolder",path:filetreelocation,newfolder:Q("p5renameinput").value})}function p5deletefile(){var e=getFileSelCount(),t=0<getFileSelDirCount()?"<br /><br /><label><input type=checkbox id=p5recdeleteinput>递归删除</label><br>":"<input type=checkbox id=p5recdeleteinput style='display:none'>";setDialogMode(2,"删除",3,p5deletefileEx,1<e?format("删除{0}个所选项目？",e)+t:"删除所选项目？"+t)}function p5deletefileEx(){for(var e=[],t=document.getElementsByName("fc"),n=0;n<t.length;n++)t[n].checked&&e.push(t[n].value);meshserver.send({action:"fileoperation",fileop:"delete",path:filetreelocation,delfiles:e,rec:Q("p5recdeleteinput").checked})}function p5renamefile(){for(var e,t=document.getElementsByName("fc"),n=0;n<t.length;n++)t[n].checked&&(e=t[n].value);setDialogMode(2,"改名",3,p5renamefileEx,'<input type=text id=p5renameinput maxlength=64 onkeyup=p5fileNameCheck(event) style=width:100% value="'+e+'" />',{action:"fileoperation",fileop:"rename",path:filetreelocation,oldname:e}),focusTextBox("p5renameinput"),p5fileNameCheck()}function p5renamefileEx(e,t){t.newname=Q("p5renameinput").value,meshserver.send(t)}function p5fileNameCheck(e){var t=isFilenameValid(Q("p5renameinput").value);QE("idx_dlgOkButton",t),1==t&&e&&13==e.keyCode&&dialogclose(1)}var isFilenameValid=(()=>{var t=/^[^\\/:\*\?"<>\|]+$/,n=/^\./,i=/^(nul|prn|con|lpt[0-9]|com[0-9])(\.|$)/i;return function(e){return t.test(e)&&!n.test(e)&&!i.test(e)&&"."!=e[0]}})();function p5uploadFile(){setDialogMode(2,"上传文件",3,p5uploadFileEx,'<form method=post enctype=multipart/form-data action=uploadfile.ashx target=fileUploadFrame><input type=text name=link style=display:none id=p5uploadpath value="'+encodeURIComponentEx(filetreelinkpath)+'" /><input type=file name=files id=p5uploadinput style=width:100% multiple=multiple onchange="p5updateUploadDialogOk(\'p5uploadinput\')" /><input type=hidden name=authCookie value='+authCookie+" /><input type=submit id=p5loginSubmit style=display:none /><span id=p5confirmOverwriteSpan style=display:none><br /><label><input type=checkbox id=p5confirmOverwrite onchange=\"p5updateUploadDialogOk('p5uploadinput')\" />确认覆盖？</label></span></form>"),p5updateUploadDialogOk("p5uploadinput")}function p5uploadFileEx(){Q("p5loginSubmit").click()}function p5GetFileInfo(e){var t,n=filetree;for(t in filetreelocation)null!=n.f&&null!=n.f[filetreelocation[t]]&&(n=n.f[filetreelocation[t]]);return n.f[e]}function p5updateUploadDialogOk(){var e=Q("p5uploadinput").files,t=[];for(s in e)null!=e[s].size&&0!=e[s].size&&t.push(e[s]);var n=filetree,i=[],o=0;for(s in filetreelocation)null!=n.f&&null!=n.f[filetreelocation[s]]&&(n=n.f[filetreelocation[s]]);if(QE("idx_dlgOkButton",0<e.length),0<e.length){if(null!=n.f){for(var s in n.f)i.push(s);for(s=0;s<e.length;s++)0<=i.indexOf(e[s].name)&&o++}QV("p5confirmOverwriteSpan",0<o),0<o?QE("idx_dlgOkButton",Q("p5confirmOverwrite").checked):(Q("p5confirmOverwrite").checked=!1,QE("idx_dlgOkButton",!0))}}function p5viewfile(){for(var e,t=document.getElementsByName("fc"),n=0;n<t.length;n++)if(t[n].checked)return null==(e=p5GetFileInfo(t[n].value))?void 0:void(e.s<=204800?meshserver.send({action:"fileoperation",fileop:"get",path:filetreelocation,file:t[n].value,tag:"edit"}):messagebox("文件编辑器","只能编辑小于200k的文件。"))}var p5clipboard=null,p5clipboardFolder=null,p5clipboardCut=0;function p5copyFile(e){var t=document.getElementsByName("fc");p5clipboard=[],p5clipboardCut=e,p5clipboardFolder=Clone(filetreelocation);for(var n=0;n<t.length;n++)t[n].checked&&"3"==t[n].attributes.file.value&&p5clipboard.push(t[n].value);p5updateClipview()}function p5pasteFile(){var e="";setDialogMode(2,"粘贴",3,p5pasteFileEx,e=null!=p5clipboard&&0<p5clipboard.length?format("将{1}入口{2}中的{0}限制到此位置？",0==p5clipboardCut?"copy":"move",p5clipboard.length,1<p5clipboard.length?"s":""):e)}function p5pasteFileEx(){meshserver.send({action:"fileoperation",fileop:0==p5clipboardCut?"copy":"move",scpath:p5clipboardFolder,path:filetreelocation,names:p5clipboard}),p5folderup(999),1==p5clipboardCut&&(p5clipboardFolder=p5clipboard=null,p5clipboardCut=0,p5updateClipview())}function p5updateClipview(){var e="";null!=p5clipboard&&0<p5clipboard.length&&(e=format("保存{0}条目{1}给{2}",p5clipboard.length,1<p5clipboard.length?"s":"",0==p5clipboardCut?"复制":"移动")+', <a href=# onclick="return p5clearClip()" style=cursor:pointer>清除</a>.'),QH("p5bottomstatus",e),p5setActions()}function p5clearClip(){return p5clipboardFolder=p5clipboard=null,p5clipboardCut=0,p5updateClipview(),!1}function p5fileDragDrop(e){if(!xxdialogMode&&(haltEvent(e),QV("bigfail",!1),QV("bigok",!1),null!=e.dataTransfer)){var t=[];for(s in e.dataTransfer.files)null!=e.dataTransfer.files[s].size&&0!=e.dataTransfer.files[s].size&&t.push(e.dataTransfer.files[s]);if(0!=t.length){var n=filetree,i=[],o=0;for(s in filetreelocation)null!=n.f&&null!=n.f[filetreelocation[s]]&&(n=n.f[filetreelocation[s]]);if(null!=n.f){for(var s in n.f)i.push(s);for(s=0;s<e.dataTransfer.files.length;s++)0<=i.indexOf(e.dataTransfer.files[s].name)&&o++}0==o?p5PerformUpload(1,e.dataTransfer.files):setDialogMode(2,"上传文件",3,p5PerformUpload,format(1==o?"上传将覆盖1个文件。继续？":"上传将覆盖{0}个文件。继续？",o),e.dataTransfer.files)}}}function p5PerformUpload(e,t){var n=0;p5uploadFile();try{Q("p5uploadinput").files=t}catch(e){n=1}if(0==n&&p5uploadFileEx(),setDialogMode(0),1==n&&0!=filetreelocation.length){for(var i=[],o=[],s=[],a=[],r=t.length,l=0,d=0;d<t.length;d++)l+=t[d].size;if(13e5<l)p5uploadFile();else for(d=0;d<t.length;d++){var c=new FileReader,u=t[d];i.push(u.name),o.push(u.size),s.push(u.type),c.onload=function(e){a.push(e.target.result),0==--r&&(Q("p5fileDragName").value=i.join("*"),Q("p5fileDragSize").value=o.join("*"),Q("p5fileDragType").value=s.join("*"),Q("p5fileDragData").value=a.join("*"),Q("p5fileDragLink").value=encodeURIComponentEx(filetreelinkpath),Q("p5fileDragAuthCookie").value=authCookie,Q("p5loginSubmit2").click())},c.readAsDataURL(u)}}}var p5dragtimer=null;function p5fileDragOver(e){xxdialogMode||(haltEvent(e),null!=p5dragtimer&&(clearTimeout(p5dragtimer),p5dragtimer=null),e=!0,0==filetreelocation.length&&(e=!1),QV("bigok",e),QV("bigfail",!e))}function p5fileDragLeave(e){xxdialogMode||(haltEvent(e),"p5filetable"!=e.target.id?(QV("bigfail",!1),QV("bigok",!1)):p5dragtimer=setTimeout(function(){QV("bigfail",!1),QV("bigok",!1),p5dragtimer=null},10))}function p5downloadButton(){for(var e=document.getElementsByName("fc"),t=0;t<e.length;t++)e[t].checked&&downloadFile("downloadfile.ashx?link="+encodeURIComponentEx(filetreelinkpath+"/"+e[t].value))}var eventsMessageId={1:"帐号登录",2:"帐户登出",3:"语言从{1}更改为{2}",4:"已加入桌面Multiplex会话",5:"离开桌面多路复用会话",6:"开始桌面多重会话",7:"录制会话已完成，{0}秒",8:"封闭式桌面多路复用会话，{0}秒",9:"从{1}到{2}，{3}秒结束了中继会话“{0}”",10:"从{1}到{2}，{3}秒结束了终端会话“{0}”",11:"从{1}到{2}，{3}秒结束了桌面会话“{0}”",12:"从{1}到{2}，{3}秒结束了文件管理会话“{0}”",13:"从{1}到{2}开始中继会话“{0}”",14:"从{1}到{2}开始了终端会话“{0}”",15:"从{1}到{2}开始了桌面会话“{0}”",16:"从{1}到{2}开始文件管理会话“{0}”",17:"处理控制台命令：“{0}”",18:"显示消息框，标题= “{0}”，消息= “{1}”",19:"杀死进程{0}",20:"开头：{0}",21:"正在获取剪贴板内容，{0}个字节",22:"设置剪贴板内容，{0}个字节",23:"尝试激活英特尔（R）AMT ACM模式",24:"运行命令",25:"执行电源操作= {0}，强制执行= {1}",26:"显示吐司消息，标题= “{0}”，消息= “{1}”",27:"本地用户接受的远程终端请求",28:"本地用户拒绝了远程终端请求",29:"本地用户强行关闭了远程桌面连接",30:"接受本地用户后启动远程桌面",31:"远程桌面连接栏已激活/更新",32:"远程桌面连接栏失败或不受支持",33:"本地用户强行关闭了远程桌面连接",34:"本地用户拒绝后无法启动远程桌面",35:"使用Toast通知启动远程桌面",36:"启动远程桌面，而无需通知",37:"远程桌面连接栏已激活/更新",38:"远程桌面连接栏失败或不受支持",39:"本地用户强行关闭了远程桌面连接",40:"本地用户接受后启动远程文件",41:"本地用户拒绝后无法启动远程文件",42:"启动带有Toast通知的远程文件",43:"已启动的远程文件，恕不另行通知",44:"创建文件夹：“{0}”",45:"删除：“{0}”",46:"递归删除：“{0}”，{1}个元素已删除",47:"删除：“{0}”，{1}个元素已删除",48:"重命名：“{0}”为“{1}”",49:"下载：“{0}”",50:"上传：“{0}”",51:"复制：“{0}”到“{1}”",52:"移动：“{0}”到“{1}”",53:"将远程用户锁定在桌面之外",54:"代理关闭了与服务器压缩的{0}％代理会话。已发送：{1}，已压缩：{2}",55:"创建的设备组：{0}",56:"未删除的设备组：{0}",57:"已将设备{0}添加到设备组{1}",58:"设备请求激活Intel（R）AMT ACM，FQDN：{0}",59:"{1}组中的设备{0}已更改：{2}",60:"删除了{0}的用户设备权限",61:"已更改{0}的用户设备权限",62:"从用户组{1}中删除了用户{0}",63:"帐户已删除",64:"创建帐户，用户名是{0}",65:"创建帐户，电子邮件为{0}",66:"帐户已更改：{0}",67:"用户组成员身份已更改：{0}",68:"已将用户组{0}添加到设备组{1}",69:"已创建用户组：{0}",70:"从设备组{1}中删除了用户组{0}",71:"已将用户{0}添加到用户组{1}",72:"从用户组{1}中删除了用户{0}",73:"设备组通知已更改",74:"帐户密码已更改：{0}",75:"更改帐户凭据",76:"创建的设备组：{0}",77:"设备组已删除：{0}",78:"设备组成员身份已更改：{0}",79:"用户组已更改：{0}",80:"已将用户{0}添加到用户组{1}",81:"删除了{0}的用户设备权限",82:"已更改{0}的用户设备权限",83:"从设备组{1}中删除了用户{0}",84:"已将设备{0}添加到设备组{1}",85:"将设备{0}移动到组{1}",86:"删除了{0}的用户设备权限",87:"从设备组{1}中删除了设备{0}",88:"启用电子邮件两因素身份验证",89:"禁用的电子邮件两因素身份验证",90:"添加了身份验证应用程序",91:"删除身份验证应用程序",92:"生成新的2FA备份代码",93:"2FA备份代码已清除",94:"移除安全密钥",95:"添加了安全密钥",96:"用户{0}的已验证电话号码",97:"已删除用户{0}的电话号码",98:"已请求帮助，用户：{0}，详细信息：{1}",99:"以用户身份运行命令",100:"如果可能，以用户身份运行命令",101:"已将设备共享{0}从{1}添加到{2}",102:"删除的设备共享{0}",103:"将{0}个文件批量上传到文件夹{1}",104:"自动下载代理程序核心转储文件：“{0}”",105:'上传："{0}"，大小：{1}',106:'下载："{0}"，大小：{1}',107:"来自 {0}、{1}、{2} 的帐户登录",108:"来自 {0}、{1}、{2} 的第二个因素不正确的用户登录尝试",109:"来自 {0}、{1}、{2} 的锁定帐户的用户登录尝试",110:"来自 {0}、{1}、{2} 的无效用户登录尝试",111:"设备请求 Intel(R) AMT ACM TLS 激活，FQDN：{0}",112:'从 {1} 到 {2}，{3} 秒结束了 Messenger 会话 "{0}"',113:"新增推送通知认证装置",114:"删除了推送通知身份验证设备",115:"添加登录令牌",116:"删除了登录令牌",117:"这是一个旧的代理版本，考虑更新。",118:"此代理具有过时的证书验证机制，请考虑更新。",119:"此代理正在使用不安全的隧道，请考虑更新。",120:'已启动本地中继会话 "{0}"，协议 {1} 到 {2}',121:'结束本地中继会话"{0}"，协议 {1} 到 {2}，{3} 秒',122:"{0} 秒后离开桌面多路复用会话。",123:'{0} 秒后离开 Web-SSH 会话 "{1}"。',124:'{0} 秒后离开 Web-SFTP 会话 "{1}"。',125:'{0} 秒后离开 Web-RDP 会话 "{1}"。',126:"{0} 秒后离开 Web-VNC 会话。",127:"将帐户显示名称更改为 {0}。",128:"已创建帐户，名称为 {0}。",129:"删除了帐户显示名称。",130:"用户通知已更改",131:"添加了无限时间的设备共享 {0}。",132:"打开。",133:"关掉。",134:"强行断开用户 {0} 的桌面会话",135:"强制断开用户 {0} 的终端会话",136:"强制断开用户 {0} 的文件会话",137:"强制断开用户 {0} 的路由会话",138:"添加了每天重复的设备共享 {0}。",139:"添加了每周重复的设备共享 {0}。",140:"{1}组中的设备{0}已更改：{2}",141:"英特尔(r) AMT 政策变更",142:"设备组 {0} 已更改：{1}",143:'已加入桌面多路复用会话 "{0}"',144:'{1} 秒后离开桌面多路复用会话 "{0}"。',145:'已启动桌面多路复用会话 "{0}"',146:'已完成录制会话 "{0}"，{1} 秒',147:'已关闭桌面多路复用会话 "{0}"，{1} 秒',148:'已启动 Web-SSH 会话 "{0}"。',149:'已启动 Web-SFTP 会话 "{0}"。',150:'已启动 Web-RDP 会话 "{0}"。',151:'已启动 Web-VNC 会话 "{0}"。',152:"不再是“{0}”的中继。",153:'是 "{0}" 的中继。',154:"Account changed to sync with LDAP data.",155:"Denied user login from {0}, {1}, {2}",156:"Verified messaging account of user {0}",157:"Removed messaging account of user {0}",158:'Displaying alert box, title="{0}", message="{1}"',159:"Device Powered On",160:"Enabled Duo two-factor authentication",161:"Disabled Duo two-factor authentication"},eventsShortMessageId={1:"团队名字",2:"描述",3:"标志",4:"同意",5:"自动删除",6:"邀请代码",7:"继电器装置"};function eventMouseHover(e,t){e.children[1].classList.remove("g1s"),e.children[2].classList.remove("style10s"),e.children[3].classList.remove("g2s"),1==t&&(e.children[1].classList.add("g1s"),e.children[2].classList.add("style10s"),e.children[3].classList.add("g2s"))}function eventsUpdate(){var e="",t=null;for(r in events){var n=events[r],i=new Date(n.time);if(n.msg){null==n.h&&(n.h=Math.random()),printDate(i)!=t&&(null!=t&&(e+="</table>"),e+="<table class=p3eventsTable cellpadding=0 cellspacing=0><tr><td colspan=4 class=DevSt>"+(t=printDate(i))+"</td></tr>");var o,s,a="si3";if("ugrp"==n.etype&&(a="m4"),"user"==n.etype&&(a="m2"),"server"==n.etype&&(a="si3"),null==n.msgid||null==eventsMessageId[n.msgid])o="string"==typeof n.msg?EscapeHtml(n.msg).split("(R)").join("&reg;"):"";else{if(o=eventsMessageId[n.msgid],null!=n.msgArgs)for(var r in n.msgArgs){var l=n.msgArgs[r];if(Array.isArray(l)){var d,c=[];for(d in l)"number"==typeof l[d]&&eventsShortMessageId[l[d]]?c.push(eventsShortMessageId[l[d]]):c.push(l[d]);l=c.join("，")}else"string"==typeof l&&0==l.indexOf("DATETIME:")&&(l=printFlexDateTime(new Date(parseInt(l.substring(9)))));o=o.split("{"+r+"}").join(l)}o=EscapeHtml(o).split("(R)").join("&reg;")}n.nodeid&&null!=(s=getNodeFromId(n.nodeid))&&(a="si"+s.icon,o="<a href=# onclick='gotoDevice(\""+n.nodeid+"\",10);haltEvent(event);'>"+EscapeHtml(s.name)+"</a> &rarr; "+o),n.username&&(s="",n.guestname&&(s=' / <span title="这是嘉宾分享环节">'+EscapeHtml(n.guestname)+"</span>"),o=2&userinfo.siteadmin&&n.userid?"<a href=# onclick='gotoUser(\""+encodeURIComponentEx(n.userid)+"\");haltEvent(event);'>"+EscapeHtml(n.username)+"</a>"+s+" &rarr; "+o:EscapeHtml(n.username)+s+" &rarr; "+o),n.remoteaddr&&(o+=" ("+n.remoteaddr+")"),"relay"!=n.etype&&"relaylog"!=n.action||(a="relayIcon16"),e+="<tr onclick=showEventDetails("+n.h+",2)  onmouseover=eventMouseHover(this,1) onmouseout=eventMouseHover(this,0) style=cursor:pointer><td style=width:18px><div class="+a+"></div></td><td class=g1>&nbsp;</td><td class=style10>"+printTime(i)+" - "+o+"</td><td class=g2>&nbsp;</td></tr><tr style=height:2px></tr>"}}null!=t&&(e+="</table>"),""==e&&(e="<br><i>找不到事件</i><br><br>"),QH("p3events",e)}function refreshEvents(){""!=p3filterevents.value?meshserver.send({action:"events",limit:parseInt(p3limitdropdown.value),filter:p3filterevents.value}):meshserver.send({action:"events",limit:parseInt(p3limitdropdown.value)})}function p3showReportDialog(){var e;xxdialogMode||(e="<div style=float:right><img src='images/report60.png' height=74 width=60 style=padding-top:2px /></div><div>",setDialogMode(2,"下载报告",3,null,e=(e=(e=(e=(e+=addHtmlValue("报告类型","<select id=d2reportType style=width:160px onchange=p3showReportValidation()><option value=1>所有事件</option>"))+addHtmlValue("时间跨度","<select id=d2reportSpan style=width:160px onchange=p3showReportValidation()><option value=1>全部可用</option><option value=2>一天</option></select>"))+("<div id=d2daySelector>"+addHtmlValue("报告日","<input type=date id=d2reportDay style=width:160px onchange=p3showReportValidation()></input>")+"</div>"))+addHtmlValue("通过...分组","<select id=d2reportGroupBy style=width:160px onchange=p3showReportValidation()><option value=1>没有</option><option value=2>设备组</option><option value=3>用户</option>"))+addHtmlValue("格式化","<select id=d2reportFormat style=width:160px onchange=p3showReportValidation()><option value=1>CSV</option><option value=2>JSON</option>")+"</div>"),p3showReportValidation(),Q("d2reportType").focus())}function p3showReportValidation(){Q("d2reportType").value;var e=Q("d2reportSpan").value,t=Q("d2reportDay").value,n=(Q("d2reportGroupBy").value,Q("d2reportFormat").value,QV("d2daySelector",2==e),!0);2==e&&""==t&&(n=!1),QE("idx_dlgOkButton",n)}function p3showDownloadEventsDialog(e){var t;xxdialogMode||(t="使用以下一种档案格式下载事件列表。<br /><br />",setDialogMode(2,"事件列表输出",1,null,t=(t+=addHtmlValue("CSV格式",'<a href=# style=cursor:pointer onclick="return p3downloadEventsDialogCSV('+e+')">eventslist.csv</a>'))+addHtmlValue("JSON格式",'<a href=# style=cursor:pointer onclick="return p3downloadEventsDialogJSON('+e+')">eventslist.json</a>'),e))}function p3downloadEventsDialogCSV(e){var t,n,i;for(i in 1==e&&(n=currentDeviceEvents),2==e&&(n=events),t="utc，时间，打字，指令，用户，设备，消息\r\n",n=3==e?currentUserEvents:n){var o,s="";n[i].nodeid&&(o=getNodeFromId(n[i].nodeid))&&o.name&&(s=o.name),t+='"'+n[i].time+'","'+printDateTime(new Date(n[i].time))+'","'+n[i].etype+'","'+(null!=n[i].action?n[i].action:"")+'","'+(null!=n[i].username?n[i].username:"")+'","'+EscapeHtml(s)+'","'+(null!=n[i].msg?n[i].msg:"").split(",").join(" -")+'"\r\n'}return saveAs(stringToUtf8Blob(t),"eventslist.csv"),!1}function p3downloadEventsDialogJSON(e){var t,n,i=[];for(n in 1==e&&(t=currentDeviceEvents),2==e&&(t=events),t=3==e?currentUserEvents:t)i.push(events[n]);return saveAs(new Blob([JSON.stringify(i,null,2)],{type:"application/octet-stream"}),"eventslist.json"),!1}function updateUsers(){if(QV("UserNewAccountButton",0==(4&features)&&0==serverinfo.domainauth),null==users||0!=(4&features))QH("p3users","");else{var e=null!=userViewSettings&&userViewSettings.noViewLimit?1e5:100,t=[],n=e,i=0;for(c in users)t.push(users[c]);t.sort(nameSort);for(var o=Q("UserSearchInput").value.toLowerCase(),s=o,a=(o.startsWith("email:")?(o=null,s=s.substring(6)):o.startsWith("name:")?(s=null,o=o.substring(5)):o.startsWith("e:")?(o=null,s=s.substring(2)):o.startsWith("n:")&&(s=null,o=o.substring(2)),"<table class=p3usersTable cellpadding=0 cellspacing=0>"),r=!0,l=(a+="<th>名称<th style=width:80px>设备组<th style=width:120px>"+nobreak("最后访问")+"<th style=width:120px>权限",[]),d=document.getElementsByClassName("UserCheckbox"),c=0;c<d.length;c++)d[c].checked&&l.push(d[c].value);for(c in t){var u=t[c],p=null;null!=(p=null!=wssessions?wssessions[u._id]:p)&&(null!=o&&(""==o||0<=u.name.toLowerCase().indexOf(o))||null!=s&&null!=u.email&&0<=u.email.toLowerCase().indexOf(s))&&(0<n?(r&&(a+="<tr><td class=userTableHeader colspan=4>在线用户",r=!1),a+=addUserHtml(u,p),n--):i++)}for(c in r=!0,t){u=t[c],p=null;null==(p=null!=wssessions?wssessions[u._id]:p)&&(null!=o&&(""==o||0<=u.name.toLowerCase().indexOf(o))||null!=s&&null!=u.email&&0<=u.email.toLowerCase().indexOf(s))&&(0<n?(r&&(a+="<tr><td class=userTableHeader colspan=4>离线用户",r=!1),a+=addUserHtml(u,p),n--):i++)}a+="</table>",1==i?a+="<br />有1个用户没有显示，请使用搜索框查找用户...<br />":1<i&&(a+="<br />"+format("{0}未显示更多用户，请使用搜索框查找用户...",i)+"<br />"),n==e&&(a+="<br />未找到相应的用户。<br />"),QH("p3users",a);for(var d=document.getElementsByClassName("UserCheckbox"),m=encodeURIComponentEx(userinfo._id),c=0;c<d.length;c++)d[c].checked=0<=l.indexOf(d[c].value)&&d[c].value!=m;p3updateInfo(),null!=currentUser&&30==xxcurrentView&&gotoUser(encodeURIComponentEx(currentUser._id),!0)}}function addUserHtml(e,t){var n="",i=" gray",o="",s=e._id!=userinfo._id,a="",r="",t=(null!=t?(i="",s&&(o='<span style=float:right;margin-top:1px;margin-right:4px title=聊天><a href=# onclick=userChat(event,"'+encodeURIComponentEx(e._id)+'","'+encodeURIComponentEx(e.name)+"\")><img src='images/icon-chat.png' height=16 width=16 style=padding-top:2px /></a></span>",o+="<span style=float:right;margin-top:1px;margin-left:4px;margin-right:4px title=Notify><a href=# onclick='return showUserAlertDialog(event,\""+encodeURIComponentEx(e._id)+"\")'><img src='images/icon-notify.png' height=16 width=16 style=padding-top:2px /></a></span>"),a+=nobreak(1==t?"1节":format("{0}节",t))):e.access?a+='<span title="'+format("上次访问：{0}",printDateTime(new Date(1e3*e.access)))+'">'+printDate(new Date(1e3*e.access))+"</span>":e.login&&(a+='<span title="'+format("上次登录：{0}",printDateTime(new Date(1e3*e.login)))+'">'+printDate(new Date(1e3*e.login))+"</span>"),s&&(r+="<a href=# style=cursor:pointer onclick='return showUserAdminDialog(event,\""+encodeURIComponentEx(e._id)+"\")'>"),null!=e.siteadmin&&0!=(32&e.siteadmin)&&4294967295!=e.siteadmin&&(r+="已锁定,&nbsp;"),r+="<span title='服务器权限'>",4294966047&e.siteadmin),l=(null==e.siteadmin||0==t?r+="用户":8==t?r+="用户+档案":4294967295==e.siteadmin?r+="管理员":r+=0!=(2&t)?"经理":"部分的",null!=e.siteadmin&&4294967295!=e.siteadmin&&0!=(1216&e.siteadmin)&&(r+="*"),r+="</span>",s&&(r+="</a>"),0);if(e.links)for(var d in e.links)d.startsWith("mesh/")&&l++;var t=EscapeHtml(e.name),s="";return 1==serverinfo.emailcheck&&(s=1!=e.emailVerified?' <b style=color:red title="邮箱未验证">&#x2717;</b>':' <b style=color:green title="电子邮件已验证">&#x2713</b>'),null!=e.email&&(0==(2097152&features)||e.email.toLowerCase()!=e.name.toLowerCase()?t+=', <a href="mailto:'+EscapeHtml(e.email)+"\" '>"+EscapeHtml(e.email)+"</a>"+s:t+=' <a href="mailto:'+EscapeHtml(e.email)+'" \'><img src="images/mail12.png" height=9 width=12 title="发送电邮给用户" style="margin-top:2px" /></a>'+s),null!=serverinfo.crossDomain&&""!=(s=e._id.split("/")[1])&&(t+=", <span style=color:#26F>"+s+"</span>"),(0<e.otpsecret||0<e.otphkeys||1==e.otpekey&&8388608&features||1==e.otpduo||null!=e.phone&&67108864&features)&&(t+=' <img src="images/key12.png" height=12 width=11 title="启用第二因素身份验证" style="margin-top:2px" />'),null!=e.phone&&(t+=' <img src="images/phone12.png" height=12 width=7 title="验证电话号码" style="margin-top:2px" />'),null!=e.siteadmin&&0!=(32&e.siteadmin)&&4294967295!=e.siteadmin&&(t+=' <img src="images/padlock12.png" height=12 width=8 title="帐户已被锁定" style="margin-top:2px" />'),null!=e.msghandle&&33554432&features2&&(t+=' <img src="images/messaging12.png" height=12 width=12 title="Verified messaging account" style="margin-top:2px" />'),n+("<tr tabindex=0 onmouseover=userMouseHover(this,1) onmouseout=userMouseHover(this,0) onkeypress=\"if (event.key=='Enter') gotoUser('"+encodeURIComponentEx(e._id)+"')\"><td>")+"<div class=bar>"+("<div class=baricon><input class=UserCheckbox value="+encodeURIComponentEx(e._id)+" onclick=p3updateInfo() type=checkbox"+(e._id==userinfo._id?" disabled":"")+'></div><div style=cursor:pointer onclick=gotoUser("'+encodeURIComponentEx(e._id)+'",false,event)>')+('<div class=baricon><div class="m2'+i+'"></div></div>')+"<div class=g1></div><div class=g2></div><div>"+("<div><span style=line-height:24px>"+t+"</span>"+o+"</div></div><td style=text-align:center>"+l+"<td style=text-align:center>"+a+"<td style=text-align:center>"+r)}function p3updateInfo(){for(var e=document.getElementsByClassName("UserCheckbox"),t=0,n=0;n<e.length;n++)!0===e[n].checked&&t++;QE("UsersGroupActionButton",0<t),Q("UsersSelectAllButton").value=0<t?"取消全选":"全选"}function p3usersSelectallButtonFunction(){for(var e=encodeURIComponentEx(userinfo._id),t=document.getElementsByClassName("UserCheckbox"),n=0,i=0;i<t.length;i++)!0===t[i].checked&&n++;for(i=0;i<t.length;i++)t[i].checked=0==n&&t[i].value!=e;p3updateInfo()}function p3usersGroupActionFunction(){for(var e,t,n=document.getElementsByClassName("UserCheckbox"),i=0,o=0;o<n.length;o++)!0===n[o].checked&&i++;0!=i&&(e="",serverinfo.emailcheck&&(e+="<option value=4>验证电邮</option><option value=5>使电邮无效</option>"),t="选择要对所有选定用户执行的操作。<br /><br />",setDialogMode(2,"集体指令",3,p3usersGroupActionFunctionEx,t+=addHtmlValue("运作","<select style=width:240px id=d3groupop><option value=1>锁定账户</option><option value=2>解锁帐户</option>"+e+"<option value=3>删除帐户</option></select>")))}function p3usersGroupActionFunctionEx(){for(var e=document.getElementsByClassName("UserCheckbox"),t=[],n=0;n<e.length;n++)!0===e[n].checked&&t.push(decodeURIComponent(e[n].value));var i,o,s=Q("d3groupop").value;if(1==s)for(var n in t)0==(32&(i=null==(o=users[t[n]]).siteadmin?0:o.siteadmin))&&(i+=32,meshserver.send({action:"edituser",id:o._id,siteadmin:i}));else if(2==s)for(var n in t)0!=(32&(i=null==(o=users[t[n]]).siteadmin?0:o.siteadmin))&&(i-=32,meshserver.send({action:"edituser",id:o._id,siteadmin:i}));else if(3==s)setDialogMode(2,"删除帐户",3,p3groupActionFunctionDelExec,"确认删除选定的帐户？<br /><br /><label><input id=d3check type=checkbox onchange=p3usersGroupActionFunctionDelCheck() />确认</label>"),QE("idx_dlgOkButton",!1);else if(4==s)for(var n in t)!0!==(o=users[t[n]]).emailVerified&&meshserver.send({action:"edituser",id:o._id,emailVerified:!0});else if(5==s)for(var n in t)!0===(o=users[t[n]]).emailVerified&&meshserver.send({action:"edituser",id:o._id,emailVerified:!1})}function p3usersGroupActionFunctionDelCheck(){QE("idx_dlgOkButton",Q("d3check").checked)}function p3groupActionFunctionDelExec(e){for(var t=document.getElementsByClassName("UserCheckbox"),n=[],i=0;i<t.length;i++)!0===t[i].checked&&n.push(decodeURIComponent(t[i].value));for(i in n){var o=users[n[i]];meshserver.send({action:"deleteuser",userid:o._id,username:o.name})}}function userMouseHover(e,t){var n=e.children[0].children[0].children[1];n.children[1].classList.remove("g1s"),n.children[2].classList.remove("g2s"),e.children[0].children[0].classList.remove("sbar"),1==t&&(n.children[1].classList.add("g1s"),n.children[2].classList.add("g2s"),e.children[0].children[0].classList.add("sbar"))}function userMouseHover2(e,t){var n=e.children[0].children[0];n.children[2].classList.remove("g1s"),n.children[3].classList.remove("g2s"),e.children[0].children[0].classList.remove("sbar"),1==t&&(n.children[2].classList.add("g1s"),n.children[3].classList.add("g2s"),e.children[0].children[0].classList.add("sbar"))}function userChat(e,t,n){if(!xxdialogMode)return haltEvent(e),e="/messenger?id=meshmessenger/"+t+"/"+encodeURIComponentEx(userinfo._id)+"&title="+n,null!=authCookie&&""!=authCookie&&(e+="&auth="+authCookie),urlargs.key&&(e+="&key="+urlargs.key),safeNewWindow(e,"meshmessenger:"+t),meshserver.send({action:"meshmessenger",userid:decodeURIComponent(t)}),!1}function altUserChat(e,t,n,i){var o,s,a,r,l;if(!xxdialogMode)return haltEvent(e),e=serverinfo.altmessenging[i].url,a=o=encodeURIComponentEx((l=decodeURIComponent(t)).split("/")[2]),r=s=encodeURIComponentEx(l.split("/").join("-")),null!=(l=users[l])&&null!=l.realname&&(a=encodeURIComponentEx(l.realname.split(" ").join("")),r=encodeURIComponentEx(l.realname.split(" ").join("-"))),e=e.split("{0}").join(o).split("{1}").join(s).split("{2}").join(a).split("{3}").join(r),urlargs.key&&(e+="&key="+urlargs.key),safeNewWindow(e,"altmessenger:"+t),meshserver.send({action:"notifyuser",userid:decodeURIComponent(t),msg:serverinfo.altmessenging[i].name,msgid:11,url:e}),!1}function showSendSMS(e){xxdialogMode||(setDialogMode(2,"发送短信",3,showSendSMSEx,"<textarea id=d2smsText maxlength=160 style=background-color:#fcf3cf;width:100%;height:100px;resize:none onKeyUp=showSendSMSValidate()></textarea><span style=font-size:10px><span>",e),Q("d2smsText").focus(),showSendSMSValidate())}function showSendSMSValidate(){QE("idx_dlgOkButton",0<Q("d2smsText").value.length)}function showSendSMSEx(e,t){0<Q("d2smsText").value.length&&meshserver.send({action:"smsuser",userid:decodeURIComponent(t),msg:Q("d2smsText").value})}function showSendMessage(e){xxdialogMode||(setDialogMode(2,"Send Message",3,showSendMessageEx,"<textarea id=d2smsText maxlength=160 style=background-color:#fcf3cf;width:100%;height:100px;resize:none onKeyUp=showSendSMSValidate()></textarea><span style=font-size:10px><span>",e),Q("d2smsText").focus(),showSendSMSValidate())}function showSendMessageEx(e,t){0<Q("d2smsText").value.length&&meshserver.send({action:"msguser",userid:decodeURIComponent(t),msg:Q("d2smsText").value})}function showSendEmail(e){xxdialogMode||(setDialogMode(2,"发电邮",3,showSendEmailEx,'<input id=d2emailSubject style=background-color:#fcf3cf;width:100% placeholder="主题"></input><textarea id=d2emailText maxlength=10000 style="background-color:#fcf3cf;width:100%;height:200px;resize:none;overflow-y:auto" onKeyUp=showSendEmailValidate()></textarea>',e),Q("d2emailSubject").focus(),showSendEmailValidate())}function showSendEmailValidate(){QE("idx_dlgOkButton",0<Q("d2emailSubject").value.length&&0<Q("d2emailText").value.length)}function showSendEmailEx(e,t){0<Q("d2emailText").value.length&&meshserver.send({action:"emailuser",userid:decodeURIComponent(t),subject:Q("d2emailSubject").value,msg:Q("d2emailText").value})}function showUserAlertDialog(e,t){if(!xxdialogMode)return haltEvent(e),setDialogMode(2,format("通知{0}",EscapeHtml(users[decodeURIComponent(t)].name)),3,showUserAlertDialogEx,'<div style=margin-bottom:6px>向该用户发送文本通知。</div><textarea id=d2notifyText maxlength=2048 style="width:100%;height:184px;resize:none;background-color:#fcf3cf"></textarea><select style=width:100% id=broadcastMessageMaxTime><option value=0>显示消息，直到被用户拒绝</option><option value=10>显示10秒</option><option value=60>显示1分钟</option><option value=300>显示5分钟</option></select>',t),Q("d2notifyText").focus(),!1}function showUserAlertDialogEx(e,t){meshserver.send({action:"notifyuser",userid:decodeURIComponent(t),msg:Q("d2notifyText").value,maxtime:parseInt(Q("broadcastMessageMaxTime").value)})}function onUsersViewSettings(){var e;xxdialogMode||(e="",setDialogMode(2,"用户视图",3,onUsersViewSettingsEx,e+="<label><input id=d2c1 type=checkbox"+((userViewSettings=null==userViewSettings?{}:userViewSettings).noViewLimit?"":" checked")+">只显示前 100 个用户</label><br />"))}function onUsersViewSettingsEx(){userViewSettings.noViewLimit=!Q("d2c1").checked,putstore("_usersViewSettings",JSON.stringify(userViewSettings)),mainUpdate(16384)}function p4batchAccountCreate(){xxdialogMode||(setDialogMode(2,"用户帐户导入",3,p4batchAccountCreateEx,'Create many accounts at once by importing a JSON or CSV file<br /><br />JSON file format is as follows:<br /><pre>[\r\n {"user":"x1","pass":"x","email":"x1@x"},\r\n {"user":"x2","pass":"x","resetNextLogin":true}\r\n]</pre><br />CSV file format is as follows:<br /><pre>user,pass,email,resetNextLogin\r\nx1,x,x1@x,\r\nx2,x,,true\r\n</pre><br /><input style=width:370px type=file id=d4importFile accept=".json,.csv" onchange=p4batchAccountCreateValidate() />'),QE("idx_dlgOkButton",!1))}function p4batchAccountCreateValidate(){QE("idx_dlgOkButton",null!=Q("d4importFile").value)}function p4batchAccountCreateEx(){var e=new FileReader;e.onload=function(e){var t=null;if(Q("d4importFile").value.endsWith(".csv")){var n=e.target.result.split("\n"),i=n[0].trim().split(","),o=[];for(let e=1;e<n.length;e++){var s=n[e].trim();if(""!==s){var a=s.split(",");let t=!1;for(let e=0;e<a.length;e++)if(""!==a[e].trim()){t=!0;break}if(t){var r={};for(let e=0;e<i.length;e++){var l=a[e].trim();""!==i[e].trim()&&""!==l&&(r[i[e]]="true"===l.toLowerCase()||l)}o.push(r)}}}if(null!=(t=o)&&Array.isArray(t)){var d=!0;for(c in t)("string"!=typeof t[c].user||t[c].user.length<1||64<t[c].user.length)&&(d=!1),("string"!=typeof t[c].pass||t[c].pass.length<1||256<t[c].pass.length)&&(d=!1),0==checkPasswordRequirements(t[c].pass,passRequirements)&&(d=!1),null!=t[c].email&&("string"!=typeof t[c].email||t[c].email.length<1||128<t[c].email.length)&&(d=!1);0==d?setDialogMode(2,"用户帐户导入",1,null,"Invalid CSV file format."):meshserver.send({action:"adduserbatch",users:t})}else setDialogMode(2,"用户帐户导入",1,null,"Invalid CSV file format.")}else{try{t=JSON.parse(e.target.result)}catch(e){return void setDialogMode(2,"用户帐户导入",1,null,format("无效的JSON档案：{0}。",e))}if(null!=t&&Array.isArray(t)){var c,d=!0;for(c in t)("string"!=typeof t[c].user||t[c].user.length<1||64<t[c].user.length)&&(d=!1),("string"!=typeof t[c].pass||t[c].pass.length<1||256<t[c].pass.length)&&(d=!1),0==checkPasswordRequirements(t[c].pass,passRequirements)&&(d=!1),null!=t[c].email&&("string"!=typeof t[c].email||t[c].email.length<1||128<t[c].email.length)&&(d=!1);0==d?setDialogMode(2,"用户帐户导入",1,null,"无效的JSON档案格式。"):meshserver.send({action:"adduserbatch",users:t})}else setDialogMode(2,"用户帐户导入",1,null,"无效的JSON档案格式。")}},e.readAsText(Q("d4importFile").files[0])}function p4downloadUserInfo(){var e;xxdialogMode||(e="使用以下一种档案格式下载用户列表。<br /><br />",setDialogMode(2,"用户列表输出",1,null,e=(e+=addHtmlValue("CSV格式","<a href=# style=cursor:pointer onclick='return p4downloadUserInfoCSV()'>userlist.csv</a>"))+addHtmlValue("JSON格式","<a href=# style=cursor:pointer onclick='return p4downloadUserInfoJSON()'>userlist.json</a>")))}function p4downloadUserInfoCSV(){var e,t="ID、姓名、电子邮件、创建、lastlogin、组、authfactors、siteadmin、useradmin、锁定\r\n";for(e in users){var n=!1,i=[];(0<users[e].otpsecret||0<users[e].otphkeys)&&(n=!0,0<users[e].otpsecret&&i.push("AuthApp"),0<users[e].otphkeys&&i.push("SecurityKey"),0<users[e].otpkeys)&&i.push("BackupCodes"),t=(t=(t=(t+='"'+users[e]._id+'","'+users[e].name+'","'+(users[e].email||"")+'","'+(users[e].creation?new Date(1e3*users[e].creation):"")+'","'+(users[e].login?new Date(1e3*users[e].login):"")+'","'+(users[e].groups?users[e].groups.join(","):"")+'","'+(n?i.join(","):"")+'"')+(","+(4294967295==users[e].siteadmin?"1":"0")))+(","+(0!=(2&users[e].siteadmin)?"1":"0")))+(","+(0!=(32&users[e].siteadmin)?"1":"0"))+"\r\n"}return saveAs(stringToUtf8Blob(t),"userlist.csv"),!1}function p4downloadUserInfoJSON(){var e,t=[];for(e in users)t.push(users[e]);return saveAs(new Blob([JSON.stringify(t,null,2)],{type:"application/octet-stream"}),"userlist.json"),!1}function showUserBroadcastDialog(e){xxdialogMode||(setDialogMode(2,"广播消息",3,showUserBroadcastDialogEx,'<div style=margin-bottom:6px>向所有连接的用户广播消息。</div><textarea id=broadcastMessage style="width:100%;height:184px;resize:none;background-color:#fcf3cf" value="" maxlength=2048 /></textarea><select style=width:100% id=broadcastMessageMaxTime><option value=0>显示消息，直到被用户拒绝</option><option value=10>显示10秒</option><option value=60>显示1分钟</option><option value=300>显示5分钟</option></select>',e?decodeURIComponent(e):null),Q("broadcastMessage").focus())}function showUserBroadcastDialogEx(e,t){meshserver.send({action:"userbroadcast",msg:Q("broadcastMessage").value,target:t,maxtime:parseInt(Q("broadcastMessageMaxTime").value)})}function showCreateNewAccountDialog(){if(!xxdialogMode){var e="";if(serverinfo.crossDomain){var t="<select style=width:240px id=p4domain>";for(n in serverinfo.crossDomain)t+="<option value="+n+">"+(""==serverinfo.crossDomain[n]?"默认":EscapeHtml(serverinfo.crossDomain[n]))+"</option>";e+=addHtmlValue("域",t+="</select>")}if(0==(2097152&features)&&(e+=addHtmlValue("<span id=p4hname>用户名</span>","<input id=p4name maxlength=64 autocomplete=username onchange=showCreateNewAccountDialogValidate() onkeyup=showCreateNewAccountDialogValidate() />")),e=(e=(e=(e+=addHtmlValue("<span id=p4hemail>电邮</span>",'<input id=p4email type=email maxlength=256 autocomplete="email" inputmode="email" onchange=showCreateNewAccountDialogValidate() onkeyup=showCreateNewAccountDialogValidate() />'))+addHtmlValue("<span id=p4hp1>密码</span>",'<input id=p4pass1 type=password maxlength=256 autocomplete="new-password" onchange=showCreateNewAccountDialogValidate() onkeyup=showCreateNewAccountDialogValidate() />'))+addHtmlValue("<span id=p4hp2>密码</span>",'<input id=p4pass2 type=password maxlength=256 autocomplete="new-password" onchange=showCreateNewAccountDialogValidate() onkeyup=showCreateNewAccountDialogValidate() />')+"<div><label><input id=p4randomPassword onchange=showCreateNewAccountDialogValidate() type=checkbox />随机密码。</label></div>")+"<div><label><input id=p4removeEvents onchange=showCreateNewAccountDialogValidate() type=checkbox />删除此用户标识的所有先前事件。</label></div>"+"<div><label><input id=p4resetNextLogin onchange=showCreateNewAccountDialogValidate() type=checkbox />下次登录时强制重置密码。</label></div>",serverinfo.emailcheck&&(e+="<div><label><input id=p4verifiedEmail onchange=showCreateNewAccountDialogValidate() type=checkbox />邮箱已验证。</label></div><div><label><input id=p4invitationEmail type=checkbox title=已通过电邮验证，并且需要重置密码。 />发送邀请邮件。</label></div>"),passRequirements){var n,i=[],o=0;for(n in passRequirements)"reset"!=n&&"hint"!=n&&(i.push(n+":"+passRequirements[n]),o++);0<o&&(e+="<div style=font-size:x-small;padding:6px>"+format("要求：{0}。",i.join(", "))+"</div>")}setDialogMode(2,"创建帐号",3,showCreateNewAccountDialogEx,e),showCreateNewAccountDialogValidate(),(0==(2097152&features)?Q("p4name"):Q("p4email")).focus()}}function showCreateNewAccountDialogValidate(){var e=validateEmail(Q("p4email").value),t=!0,n=0<Q("p4pass1").value.length&&Q("p4pass1").value==Q("p4pass2").value&&checkPasswordRequirements(Q("p4pass1").value,passRequirements),t=(0==(2097152&features)&&(t=!Q("p4name")||0<Q("p4name").value.length&&-1==Q("p4name").value.indexOf(" "),QS("p4hname").color=t?"black":"#7b241c"),QS("p4hemail").color=e?"black":"#7b241c",serverinfo.emailcheck&&(QE("p4verifiedEmail",e),QE("p4invitationEmail",e&&Q("p4resetNextLogin").checked&&Q("p4verifiedEmail").checked),0==e&&(Q("p4verifiedEmail").checked=!1),0!=Q("p4resetNextLogin").checked&&0!=Q("p4verifiedEmail").checked||(Q("p4invitationEmail").checked=!1)),QE("p4pass1",!Q("p4randomPassword").checked),QE("p4pass2",!Q("p4randomPassword").checked),QS("p4hp1").color=n||Q("p4randomPassword").checked?"black":"#7b241c",QS("p4hp2").color=n||Q("p4randomPassword").checked?"black":"#7b241c",t&e);0==Q("p4randomPassword").checked&&(t&=n),QE("idx_dlgOkButton",t)}function showCreateNewAccountDialogEx(){var e={action:"adduser",username:(0==(2097152&features)?Q("p4name"):Q("p4email")).value,email:Q("p4email").value,pass:Q("p4pass1").value,resetNextLogin:Q("p4resetNextLogin").checked,randomPassword:Q("p4randomPassword").checked,removeEvents:Q("p4removeEvents").checked};serverinfo.emailcheck&&(e.emailVerified=Q("p4verifiedEmail").checked,e.emailInvitation=Q("p4invitationEmail").checked),serverinfo.crossDomain&&(e.domain=serverinfo.crossDomain[parseInt(Q("p4domain").value)]),meshserver.send(e)}function showUserGroupDialog(e,t){var n;if(!xxdialogMode)return haltEvent(e),t=decodeURIComponent(t),e="",n="输入管理领域名称的逗号分隔列表。<br /><br />",setDialogMode(2,"管理领域",3,showUserGroupDialogEx,n+=addHtmlValue("境界",'<input id=dp4usergroups style=width:230px value="'+(e=null!=(t=users[t.toLowerCase()]).groups?t.groups.join(", "):e)+'" placeholder="名称1，名称2，名称3" maxlength=256 onchange=p4validateUserGroups() onkeyup=p4validateUserGroups() />'),t),focusTextBox("dp4usergroups"),p4validateUserGroups(),!1}function p4validateUserGroups(){var e,t=Q("dp4usergroups").value,n=0,i=t.indexOf('"')+t.indexOf("/")+t.indexOf(">")+t.indexOf("<")+t.indexOf("'"),o=t.split(",");for(e in o)0==o[e].trim().length&&n++;QE("idx_dlgOkButton",""==t||-5==i&&n<1)}function showUserGroupDialogEx(e,t){var n,i=Q("dp4usergroups").value.split(","),o=[];for(n in i){var s=i[n].trim();0<s.length&&o.push(s)}meshserver.send({action:"edituser",id:t._id,groups:o})}function showUserAdminDialog(e,t){if(!xxdialogMode){haltEvent(e),t=decodeURIComponent(t);var n,e=users[t];if(null!=e)return(t="")!=(t=(t=(t=(t=(t+="<label><input type=checkbox onchange=showUserAdminDialogValidate() id=ua_fileaccess>服务器档案</label>, <input type=number onchange=showUserAdminDialogValidate() maxlength=10 id=ua_fileaccessquota>k max，默认为空白<br><hr/>")+"<label><input type=checkbox onchange=showUserAdminDialogValidate() id=ua_fulladmin>完整管理员</label><br>"+"<label><input type=checkbox onchange=showUserAdminDialogValidate() id=ua_serverbackup>服务器备份</label><br>")+"<label><input type=checkbox onchange=showUserAdminDialogValidate() id=ua_serverrestore>服务器还原</label><br>"+"<label><input type=checkbox onchange=showUserAdminDialogValidate() id=ua_serverupdate>服务器更新</label><br></div>")+"<div id=d2MngUsr><label><input type=checkbox onchange=showUserAdminDialogValidate() id=ua_manageusers>管理用户</label><br></div>"+"<div id=d2MngGrp><label><input type=checkbox onchange=showUserAdminDialogValidate() id=ua_manageusergroups>管理用户组</label><br></div>")+"<div id=d2MngRec><label><input type=checkbox onchange=showUserAdminDialogValidate() id=ua_managerecordings>管理录音</label><br></div>"+"<div id=d2AllEvnt><label><input type=checkbox onchange=showUserAdminDialogValidate() id=ua_allevents>查看所有事件</label><br></div>")&&(t+="<hr/>"),setDialogMode(2,"服务器权限",2+((n=userinfo._id==e._id)?0:1),showUserAdminDialogEx,t=(t=(t=(t="<div><div id=d2AdminPermissions>"+t)+"<label><input type=checkbox onchange=showUserAdminDialogValidate() id=ua_lockedaccount>锁定账户</label><br>"+"<label><input type=checkbox onchange=showUserAdminDialogValidate() id=ua_nonewgroups>没有新的设备组</label><br>")+"<label><input type=checkbox onchange=showUserAdminDialogValidate() id=ua_nonewdevices>没有新设备</label><br>"+"<label><input type=checkbox onchange=showUserAdminDialogValidate() id=ua_nomeshcmd>没有工具（MeshCmd /路由器）</label><br>")+"<label><input type=checkbox onchange=showUserAdminDialogValidate() id=ua_locksettings>锁定帐户设置</label><br>"+"</div>",e),e.siteadmin&&0!=e.siteadmin&&(Q("ua_fulladmin").checked=4294967295==e.siteadmin,Q("ua_serverbackup").checked=4294967295!=e.siteadmin&&0!=(1&e.siteadmin),Q("ua_serverrestore").checked=4294967295!=e.siteadmin&&0!=(4&e.siteadmin),Q("ua_fileaccess").checked=4294967295!=e.siteadmin&&0!=(8&e.siteadmin),Q("ua_serverupdate").checked=4294967295!=e.siteadmin&&0!=(16&e.siteadmin),Q("ua_lockedaccount").checked=4294967295!=e.siteadmin&&0!=(32&e.siteadmin),Q("ua_nonewgroups").checked=4294967295!=e.siteadmin&&0!=(64&e.siteadmin),Q("ua_nomeshcmd").checked=4294967295!=e.siteadmin&&0!=(128&e.siteadmin),Q("ua_locksettings").checked=4294967295!=e.siteadmin&&0!=(1024&e.siteadmin),Q("ua_nonewdevices").checked=4294967295!=e.siteadmin&&0!=(4096&e.siteadmin)),0!=(2&userinfo.siteadmin)&&(Q("ua_manageusers").checked=4294967295!=e.siteadmin&&0!=(2&e.siteadmin),QE("ua_manageusers",!n&&2&userinfo.siteadmin)),0!=(256&userinfo.siteadmin)&&(Q("ua_manageusergroups").checked=4294967295!=e.siteadmin&&0!=(256&e.siteadmin),QE("ua_manageusergroups",!n&&256&userinfo.siteadmin)),0!=(512&userinfo.siteadmin)&&(Q("ua_managerecordings").checked=4294967295!=e.siteadmin&&0!=(512&e.siteadmin),QE("ua_managerecordings",!n&&512&userinfo.siteadmin)),0!=(2048&userinfo.siteadmin)&&(Q("ua_allevents").checked=4294967295!=e.siteadmin&&0!=(2048&e.siteadmin),QE("ua_allevents",!n&&2048&userinfo.siteadmin)),QE("ua_fulladmin",!n&&4294967295==userinfo.siteadmin),QE("ua_serverbackup",!n&&4294967295==userinfo.siteadmin),QE("ua_serverrestore",!n&&4294967295==userinfo.siteadmin),QE("ua_fileaccess",!n&&4294967295==userinfo.siteadmin),QE("ua_fileaccessquota",!n&&4294967295==userinfo.siteadmin),QE("ua_serverupdate",!n&&4294967295==userinfo.siteadmin),QV("d2AdminPermissions",4294967295==userinfo.siteadmin),QV("d2MngUsr",0!=(2&userinfo.siteadmin)),QV("d2MngGrp",0!=(256&userinfo.siteadmin)),QV("d2MngRec",0!=(512&userinfo.siteadmin)),QE("ua_lockedaccount",!n&&2&userinfo.siteadmin&&4294967295!=e.siteadmin&&userinfo._id!=e._id),QE("ua_nonewgroups",!n&&2&userinfo.siteadmin&&4294967295!=e.siteadmin&&userinfo._id!=e._id),QE("ua_nomeshcmd",!n&&2&userinfo.siteadmin&&4294967295!=e.siteadmin&&userinfo._id!=e._id),QE("ua_nonewdevices",!n&&2&userinfo.siteadmin&&4294967295!=e.siteadmin&&userinfo._id!=e._id),QE("ua_locksettings",!n&&2&userinfo.siteadmin&&4294967295!=e.siteadmin&&userinfo._id!=e._id),Q("ua_fileaccessquota").value=null!=e.quota?e.quota/1024:"",showUserAdminDialogValidate(),!1}}function showUserAdminDialogValidate(){4294967295==userinfo.siteadmin&&(QE("ua_serverbackup",!Q("ua_fulladmin").checked),QE("ua_manageusers",!Q("ua_fulladmin").checked),QE("ua_serverrestore",!Q("ua_fulladmin").checked),QE("ua_fileaccess",!Q("ua_fulladmin").checked),QE("ua_serverupdate",!Q("ua_fulladmin").checked),QE("ua_lockedaccount",!Q("ua_fulladmin").checked),QE("ua_nonewgroups",!Q("ua_fulladmin").checked),QE("ua_nomeshcmd",!Q("ua_fulladmin").checked),QE("ua_nonewdevices",!Q("ua_fulladmin").checked),QE("ua_manageusergroups",!Q("ua_fulladmin").checked),QE("ua_managerecordings",!Q("ua_fulladmin").checked),QE("ua_allevents",!Q("ua_fulladmin").checked),QE("ua_locksettings",!Q("ua_fulladmin").checked),QE("ua_fileaccessquota",Q("ua_fileaccess").checked&&!Q("ua_fulladmin").checked))}function showUserAdminDialogEx(e,t){var n=0,i=parseInt(Q("ua_fileaccessquota").value),t=(1==Q("ua_fulladmin").checked?n=4294967295:(1==Q("ua_serverbackup").checked&&(n+=1),1==Q("ua_manageusers").checked&&(n+=2),1==Q("ua_serverrestore").checked&&(n+=4),1==Q("ua_fileaccess").checked&&(n+=8),1==Q("ua_serverupdate").checked&&(n+=16),1==Q("ua_lockedaccount").checked&&(n+=32),1==Q("ua_nonewgroups").checked&&(n+=64),1==Q("ua_nomeshcmd").checked&&(n+=128),1==Q("ua_manageusergroups").checked&&(n+=256),1==Q("ua_managerecordings").checked&&(n+=512),1==Q("ua_locksettings").checked&&(n+=1024),1==Q("ua_allevents").checked&&(n+=2048),1==Q("ua_nonewdevices").checked&&(n+=4096)),{action:"edituser",id:t._id,siteadmin:n});0==isNaN(i)&&(t.quota=1024*i),meshserver.send(t)}function onUserSearchInputChanged(){mainUpdate(16384)}function updateUserGroups(){QV("p50userGroupOps",0!=(256&userinfo.siteadmin));var e=[],t="";if(usergroups)for(var n in usergroups)e.push(usergroups[n]);e.sort(nameSort);for(var i=[],o=document.getElementsByClassName("UserGroupCheckbox"),n=0;n<o.length;n++)o[n].checked&&i.push(o[n].value);if(0==e.length)t+="<br />找不到群组。<br />",QV("DuplicateUserGroupButton",!1);else{for(var n in t=t+"<table class=p3usersTable cellpadding=0 cellspacing=0>"+"<th>名称<th style=width:80px>用户<th style=width:80px>设备组<th style=width:80px>设备",e)t+=addUserGroupHtml(e[n]);t+="</table>",QV("DuplicateUserGroupButton",!0)}QH("p50groups",t);for(o=document.getElementsByClassName("UserGroupCheckbox"),n=0;n<o.length;n++)o[n].checked=0<=i.indexOf(o[n].value);p50updateInfo(),null!=currentUserGroup&&51==xxcurrentView&&gotoUserGroup(encodeURIComponentEx(currentUserGroup._id),!0)}function addUserGroupHtml(e){var t=0,n=0,i=0;if(e.links)for(var o in e.links)o.startsWith("user/")&&t++,o.startsWith("mesh/")&&n++,o.startsWith("node/")&&i++;var s=EscapeHtml(e.name),a=(null!=serverinfo.crossDomain&&""!=(a=e._id.split("/")[1])&&(s+=", <span style=color:#26F>"+EscapeHtml(a)+"</span>"),"<tr tabindex=0 onmouseover=userMouseHover2(this,1) onmouseout=userMouseHover2(this,0) onkeypress=\"if (event.key=='Enter') gotoUserGroup('"+encodeURIComponentEx(e._id)+"')\"><td style=cursor:pointer>");return(a+="<div class=bar style=width:100%>")+("<div class=baricon><input class=UserGroupCheckbox value="+encodeURIComponentEx(e._id)+" onclick=p50updateInfo() type=checkbox></div>")+('<div class=baricon onclick=gotoUserGroup("'+encodeURIComponentEx(e._id)+'")><div class=m4></div></div>')+('<div class=g1 onclick=gotoUserGroup("'+encodeURIComponentEx(e._id)+'")></div><div class=g2 onclick=gotoUserGroup("'+encodeURIComponentEx(e._id)+'")></div>')+('<div style=line-height:24px onclick=gotoUserGroup("'+encodeURIComponentEx(e._id)+'")><span style=font-size:16px>'+s+"</span></div></div><td style=text-align:center>"+t+"<td style=text-align:center>"+n+"<td style=text-align:center>"+i)}function p50updateInfo(){for(var e=document.getElementsByClassName("UserGroupCheckbox"),t=0,n=0;n<e.length;n++)!0===e[n].checked&&t++;QE("UsersGroupsGroupActionButton",0<t),Q("UsersGroupsSelectAllButton").value=0<t?"取消全选":"全选"}function p50usersSelectallButtonFunction(){for(var e=encodeURIComponentEx(userinfo._id),t=document.getElementsByClassName("UserGroupCheckbox"),n=0,i=0;i<t.length;i++)!0===t[i].checked&&n++;for(i=0;i<t.length;i++)t[i].checked=0==n&&t[i].value!=e;p50updateInfo()}function p50usersGroupActionFunction(){for(var e,t=document.getElementsByClassName("UserGroupCheckbox"),n=0,i=0;i<t.length;i++)!0===t[i].checked&&n++;0!=n&&(e="选择要对所有选定用户执行的操作。<br /><br />",setDialogMode(2,"集体指令",3,p50usersGroupActionFunctionEx,e+=addHtmlValue("运作","<select style=width:240px id=d50groupop><option value=1>删除群组</option></select>")))}function p50usersGroupActionFunctionEx(){for(var e=document.getElementsByClassName("UserGroupCheckbox"),t=[],n=0;n<e.length;n++)!0===e[n].checked&&t.push(decodeURIComponent(e[n].value));1==Q("d50groupop").value&&(setDialogMode(2,"删除用户群组",3,p50groupActionFunctionDelExec,"确认删除选定的用户组？<br /><br /><label><input id=d3check type=checkbox onchange=p50usersGroupActionFunctionDelCheck() />确认</label>"),QE("idx_dlgOkButton",!1))}function p50usersGroupActionFunctionDelCheck(){QE("idx_dlgOkButton",Q("d3check").checked)}function p50groupActionFunctionDelExec(e){for(var t=document.getElementsByClassName("UserGroupCheckbox"),n=0;n<t.length;n++)!0===t[n].checked&&meshserver.send({action:"deleteusergroup",ugrpid:decodeURIComponent(t[n].value)})}function showCreateUserGroupDialog(e){if(!xxdialogMode){var t="",n="";if(2==e){if(usergroups)for(var i in usergroups)n+="<option value="+encodeURIComponentEx(i)+">"+EscapeHtml(usergroups[i].name)+"</option>";t+=addHtmlValue("用户组","<div style=width:230px;margin:0;padding:0><select id=dp4groupid style=width:100%>"+n+"</select></div>")}if(1==e&&serverinfo.crossDomain){n="<select style=width:240px id=p4domain>";for(i in serverinfo.crossDomain)n+="<option value="+i+">"+(""==serverinfo.crossDomain[i]?"默认":EscapeHtml(serverinfo.crossDomain[i]))+"</option>";t+=addHtmlValue("域",n+="</select>")}setDialogMode(2,1==e?"创建用户组":"复制用户组",3,showCreateUserGroupDialogEx,t=(t+=addHtmlValue("名称","<input id=p4name maxlength=64 onchange=showCreateUserGroupDialogValidate() onkeyup=showCreateUserGroupDialogValidate() />"))+addHtmlValue("描述",'<textarea id=p4desc value="" style=width:230px;height:60px;resize:none maxlength=1024 /></textarea>'),e),showCreateUserGroupDialogValidate(),Q("p4name").focus()}}function showCreateUserGroupDialogValidate(){QE("idx_dlgOkButton",0<Q("p4name").value.length)}function showCreateUserGroupDialogEx(e,t){var n={action:"createusergroup",name:Q("p4name").value,desc:Q("p4desc").value};2==t&&(n.clone=decodeURIComponent(Q("dp4groupid").value)),1==t&&serverinfo.crossDomain&&(n.domain=serverinfo.crossDomain[parseInt(Q("p4domain").value)]),meshserver.send(n)}var currentUserGroup=null;function gotoUserGroup(e,t){if(!xxdialogMode||t){t=currentUserGroup=usergroups?usergroups[decodeURIComponent(e)]:null;if(null==t)51==xxcurrentView&&(setDialogMode(0),go(50));else{var e=EscapeHtml(t.name),n=(0==e.length&&(e="<i>没有</i>"),null==currentUserGroup.membershipType&&0!=(256&userinfo.siteadmin)&&(e='<span tabindex=0 title="单击此处编辑用户组名称" onclick=p51editgroup(1) onkeyup="if (event.key == \'Enter\') p51editgroup(1)" style=cursor:pointer>'+e+' <img class=hoverButton src="images/link5.png" /></span>'),QH("p51groupName",e),0),i=0,o=0;if(t.links)for(var s in t.links)s.startsWith("user/")&&n++,s.startsWith("mesh/")&&i++,s.startsWith("node/")&&o++;var a,r=null==(r=t.desc)||""==r?"<i>没有<i>":EscapeHtml(r),l="<div style=min-height:80px><table style=width:100%>",r=(0!=(8&args.hide)&&(l+="<br />"+addDeviceAttribute("名称",e)),null==serverinfo.crossDomain&&0==debugmode||(l=(l+=addDeviceAttribute("域",""!=(e=t._id.split("/")[1])?EscapeHtml(e):"<i>默认</i>"))+addDeviceAttribute("组标识符",EscapeHtml(t._id))),null!=currentUserGroup.membershipType&&(l+=addDeviceAttribute("Group Type",EscapeHtml(currentUserGroup.membershipType))),0!=(256&userinfo.siteadmin)?l+=addDeviceAttribute("描述","<span onclick=p51editgroup(2,"+(null!=currentUserGroup.membershipType)+") style=cursor:pointer>"+r+' <img class=hoverButton src="images/link5.png" /></span>'):l+=addDeviceAttribute("描述",r),1==serverinfo.userGroupsSessionRecording&&(e=[],t.flags&&2&t.flags&&e.push("记录会议"),l+=addDeviceAttribute("功能",addLink(e=""==(e=e.join(", "))?"<i>没有</i>":e,"p51edituserGroupFeatures()"))),[]),e=0,d=(t.consent&&(e=t.consent),serverinfo.consent&&(e|=serverinfo.consent),64&e&&8&e?r.push("桌面提示+工具栏"):64&e?r.push("桌面工具栏"):8&e?r.push("桌面提示"):1&e&&r.push("桌面通知"),16&e?r.push("终端提示"):2&e&&r.push("终端通知"),32&e?r.push("档案提示"):4&e&&r.push("档案通知"),7==e&&(r=["一直通知"]),l=(l=(l=(l+=addDeviceAttribute("用户同意",addLinkConditional(r=""==(r=(r=56==(56&e)?["一直提示"]:r).join(", "))?"<i>没有</i>":r,"p20editmeshconsent(4)",!0)))+addDeviceAttribute("用户",n))+addDeviceAttribute("设备组",i))+addDeviceAttribute("设备",o)+"</table></div><br />",0!=(256&userinfo.siteadmin)&&(l+='<input type=button value="广播" title="向该组中的所有用户发送通知。" onclick=showUserBroadcastDialog("'+encodeURIComponentEx(t._id)+'") />'),QH("p51group",l),l="<br />",null==currentUserGroup.membershipType&&0!=(256&userinfo.siteadmin)&&(l+='<a href=# onclick="return p51showAddUserDialog()" style=cursor:pointer;margin-right:10px><img src=images/icon-addnew.png border=0 height=12 width=12> 添加用户</a>'),l+='<table style="color:black;background-color:#EEE;border-color:#AAA;border-width:1px;border-style:solid;border-collapse:collapse" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col style=text-align:left;width:430px>群组成员</th><th scope=col style=text-align:left></th></tr>',1),c=[];for(s in currentUserGroup.links)0!=s.startsWith("user/")&&(a=s.split("/")[2],currentUserGroup.links[s].name&&(a=currentUserGroup.links[s].name),s==userinfo._id&&(a=userinfo.name),c.push({id:s,name:a,rights:currentUserGroup.links[s].rights}));for(s in c.sort(function(e,t){return e.name>t.name?1:e.name<t.name?-1:0}),c){var u="",p=(null==currentUserGroup.membershipType&&(u="<a href=# onclick='return p51deleteUser(event,\""+encodeURIComponentEx(c[s].id)+'")\' title="删除此设备组的用户权限" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>'),EscapeHtml(decodeURIComponent(c[s].name)));l+="<tr "+(d%2==0?"style=background-color:#DDD":"")+'><td><div title="用户" class=m2></div><div>&nbsp;'+(p=null!=users?"<a href=# onclick='gotoUser(\""+encodeURIComponentEx(c[s].id)+"\");haltEvent(event);'>"+p+"</a>":p)+"<div></div></div></td><td><div style=float:right>"+u+"</div></td></tr>",++d}1==d&&(l+="<tr><td><div style=padding:6px>&nbsp;<i>没有成员</i><div></div></div></td><td></td></tr>"),l+="</tbody></table><br />";var d=1,m=0,g=!1;for(s in meshes)currentUserGroup._id.split("/")[1]==meshes[s]._id.split("/")[1]&&(m++,null==currentUserGroup.links||null==currentUserGroup.links[s])&&(g=!0);if(0<m&&g&&(l+='<a href=# onclick="return p20showAddMeshUserDialog(3)" style=cursor:pointer;margin-right:10px><img src=images/icon-addnew.png border=0 height=12 width=12> 添加设备组</a>'),l+='<table style="color:black;background-color:#EEE;border-color:#AAA;border-width:1px;border-style:solid;border-collapse:collapse" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col style=text-align:left;width:430px>通用设备组</th><th scope=col style=text-align:left></th></tr>',currentUserGroup.links){var h=[];for(s in currentUserGroup.links)s.startsWith("mesh/")&&null!=meshes[s]&&h.push(meshes[s]);for(s in h=getOrderedList(h,"name")){var v=0,f=h[s],u="",k=makeDeviceGroupRightsString(currentUserGroup.links[f._id].rights),x=(userinfo.links&&null!=userinfo.links[f._id]&&null!=userinfo.links[f._id].rights&&(v=userinfo.links[f._id].rights),"<i>未知设备组</i>");f&&(x="<a href=# onclick='gotoMesh(\""+f._id+"\");haltEvent(event);'>"+f.name+"</a>"),0!=(2&v)&&(u="<a href=# onclick='return p51removeMeshFromUserGroup(event,\""+encodeURIComponentEx(f._id)+'")\' title="删除此设备组的用户组权限" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>',k='<span style=cursor:pointer onclick=p20showAddMeshUserDialog(3,"'+encodeURIComponentEx(f._id)+'")>'+k+" <img class=hoverButton style=cursor:pointer src=images/link5.png></span>"),l+="<tr "+(++d%2==0?"style=background-color:#DDD":"")+'><td style=width:30%><div title="设备组" class=m99></div><div>&nbsp;'+x+"<div></div></div></td><td style=width:70%><div style=float:right>"+u+"</div><div>"+k+"</div></td></tr>"}}if(1==d&&(l+="<tr><td><div style=padding:6px>&nbsp;<i>没有共同的设备组</i><div></div></div></td><td></td></tr>"),d=1,l=l+"</tbody></table>"+"<br />",currentUserGroup._id.split("/")[1]==userinfo._id.split("/")[1]&&(l+='<a href=# onclick="return p20showAddMeshUserDialog(7)" style=cursor:pointer;margin-right:10px><img src=images/icon-addnew.png border=0 height=12 width=12> 添加设备</a>'),l+='<table style="color:black;background-color:#EEE;border-color:#AAA;border-width:1px;border-style:solid;border-collapse:collapse" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col style=text-align:left;width:430px>通用设备</th><th scope=col style=text-align:left></th></tr>',currentUserGroup.links){var y=[];for(s in currentUserGroup.links)s.startsWith("node/")&&null!=(b=getNodeFromId(s))&&y.push(b);for(s in y=getOrderedList(y,"name")){var b=y[s],u="",k=makeUserDeviceRightsString(currentUserGroup.links[b._id].rights),v=GetNodeRights(b),w="<i>未知设备</i>";b&&(w="<a href=# onclick='gotoDevice(\""+b._id+"\");haltEvent(event);'>"+b.name+"</a>"),0!=(2&v)&&(u="<a href=# onclick='return p51removeDeviceFromUserGroup(event,\""+encodeURIComponentEx(b._id)+'")\' title="删除此设备的用户组权限" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>',k='<span style=cursor:pointer onclick=p20showAddMeshUserDialog(7,"'+encodeURIComponentEx(b._id)+'")>'+k+" <img class=hoverButton style=cursor:pointer src=images/link5.png></span>"),l+="<tr "+(++d%2==0?"style=background-color:#DDD":"")+'><td style=width:30%><div title="设备组" class=m99></div><div>&nbsp;'+w+"<div></div></div></td><td style=width:70%><div style=float:right>"+u+"</div><div>"+k+"</div></td></tr>"}}1==d&&(l+="<tr><td><div style=padding:6px>&nbsp;<i>没有共同的设备</i><div></div></div></td><td></td></tr>"),l+="</tbody></table>",null!=currentUserGroup.membershipType&&0!=n||0==(256&userinfo.siteadmin)||(l+="<div style=font-size:small;text-align:right><span><a href=# onclick=p51showDeleteUserGroupDialog() style=cursor:pointer>删除用户群组</a></span></div>"),QH("p51group2",l),go(51);var S="";if(0==(268435456&features)&&51<=xxcurrentView&&xxcurrentView<=59&&null!=currentUserGroup){for(var s in S="?viewmode="+xxcurrentView+"&gotougrp="+(serverinfo.crossDomain?currentUserGroup._id:currentUserGroup._id.split("/")[2]),urlargs)S+="&"+s+"="+urlargs[s];try{window.history.replaceState({},document.title,window.location.pathname+S)}catch(e){}}}}}function p51edituserGroupFeatures(){var e,t;xxdialogMode||(e=currentUserGroup.flags||0,t="",1==serverinfo.userGroupsSessionRecording&&(t+="<div><label><input type=checkbox id=d51flag1 "+(2&e?"checked":"")+">记录会议</label><br></div>"),setDialogMode(2,"编辑用户组功能",3,p51edituserGroupFeaturesEx,t))}function p51edituserGroupFeaturesEx(){var e=0;1==serverinfo.userGroupsSessionRecording&&Q("d51flag1").checked&&(e+=2),meshserver.send({action:"editusergroup",ugrpid:currentUserGroup._id,flags:e})}function p51removeDeviceFromUserGroup(e,t){xxdialogMode||null!=(t=getNodeFromId(decodeURIComponent(t)))&&setDialogMode(2,"删除设备权限",3,p51removeDeviceFromUserGroupEx,format("确认删除设备“ {0} ”的访问权限？",t.name),t._id)}function p51removeDeviceFromUserGroupEx(e,t){meshserver.send({action:"adddeviceuser",nodeid:t,userids:[currentUserGroup._id],rights:0,remove:!0})}function p51removeMeshFromUserGroup(e,t){xxdialogMode||null!=(t=meshes[decodeURIComponent(t)])&&setDialogMode(2,"删除设备组权限",3,p51removeMeshFromUserGroupEx,format("确认删除设备组“ {0} ”的访问权限？",t.name),t._id)}function p51removeMeshFromUserGroupEx(e,t){meshserver.send({action:"removemeshuser",meshid:t,userid:currentUserGroup._id})}function p51editgroup(e,t){xxdialogMode||(t=addHtmlValue("名称","<input id=dp51name style=width:230px maxlength=32 onchange=p51editgroupValidate() onkeyup=p51editgroupValidate(event) "+(t?"readonly disabled":"")+"/>"),setDialogMode(2,"编辑用户组",3,p51editgroupEx,t+=addHtmlValue("描述","<div style=width:230px;margin:0;padding:0><textarea id=dp51desc maxlength=1024 style=width:100%;resize:none></textarea></div>")),Q("dp51name").value=currentUserGroup.name,currentUserGroup.desc&&(Q("dp51desc").value=currentUserGroup.desc),p51editgroupValidate(),(2==e?Q("dp51desc"):Q("dp51name")).focus())}function p51editgroupEx(){meshserver.send({action:"editusergroup",ugrpid:currentUserGroup._id,name:Q("dp51name").value,desc:Q("dp51desc").value})}function p51editgroupValidate(e){QE("idx_dlgOkButton",0<Q("dp51name").value.length),e&&"Enter"==e.key&&Q("dp51desc").focus()}function p51showDeleteUserGroupDialog(){var e;return xxdialogMode||(e=format("删除用户群组{0}？",EscapeHtml(currentUserGroup.name))+"<br /><br />",setDialogMode(2,"删除用户群组",3,p51showDeleteUserGroupDialogEx,e+="<label><input id=p51check type=checkbox onchange=p51validateDeleteGroupDialog() />确认</label>"),p51validateDeleteGroupDialog()),!1}function p51validateDeleteGroupDialog(){QE("idx_dlgOkButton",Q("p51check").checked)}function p51showDeleteUserGroupDialogEx(e,t){meshserver.send({action:"deleteusergroup",ugrpid:currentUserGroup._id})}function p51deleteUser(e,t){return haltEvent(e),p51viewuserEx(2,decodeURIComponent(t)),!1}function p51viewuserEx(e,t){2==e&&(e=t.split("/")[2],users&&users[t]&&(e=users[t].name),userinfo._id==t&&(e=userinfo.name),setDialogMode(2,"删除用户成员资格",3,p51viewuserEx2,format("确认删除用户“ {0} ”的成员身份？",EscapeHtml(decodeURIComponent(e))),t))}function p51viewuserEx2(e,t){meshserver.send({action:"removeuserfromusergroup",ugrpid:currentUserGroup._id,userid:t})}function p51showAddUserDialog(){var e;return xxdialogMode||(e="允许用户管理此设备组和该组中的设备。",524288&features&&(e+=" 用户需要先登录到该服务器一次，然后才能将其添加到设备组。"),setDialogMode(2,"将用户添加到用户组",3,p51showAddUserDialogEx,e=(e=(e+="<br /><br /><div style='position:relative'>")+addHtmlValue("用户标识符",'<input id=dp51username style=width:230px maxlength=32 onchange=p51validateAddUserDialog() onkeyup=p51validateAddUserDialog() placeholder="user1, user2, user3" />'))+"<div id=dp51usersuggest class=suggestionBox style='top:30px;left:130px;display:none'></div>"+"</div><br>"),Q("dp51username").focus(),p51validateAddUserDialog()),!1}function p51setname(e){e=decodeURIComponent(e);var t,n=Q("dp51username").value.split(",");for(t in n)n[t]=n[t].trim();return n[n.length-1]=e,Q("dp51username").value=n.join(", "),p51validateAddUserDialog(),!1}function p51validateAddUserDialog(){var e=!0;if(Q("dp51username")){var t=Q("dp51username").value.split(",");for(l in t){var n=t[l]=t[l].trim();(0==n.length||0<=n.indexOf('"'))&&(e=!1)}var i=!1,o=!1;if(null!=users){var s=t[t.length-1].trim(),a=s.toLowerCase(),r=[];if(0<s.length){for(var l in users){var d=users[l]._id.split("/");if(currentUserGroup.domain==d[1]&&d[2]===a){o=!0;break}if(0<=users[l].name.toLowerCase().indexOf(a)&&currentUserGroup.domain==d[1]&&(r.push([users[l]._id,users[l].name]),8<=r.length))break}if(0==o&&0<r.length){var c="";for(l in r){var u=r[l][0],p=r[l][1];u.split("/")[2]==p.toLowerCase()?c+="<div class=suggestionBoxItem onclick='p51setname(\""+encodeURIComponentEx(u.split("/")[2])+"\")'>"+EscapeHtml(p)+"</div>":c+="<div class=suggestionBoxItem onclick='p51setname(\""+encodeURIComponentEx(u.split("/")[2])+"\")'><div>"+EscapeHtml(p)+"</div><div class=suggestionBoxSubItem>"+EscapeHtml(u.split("/")[2])+"</div></div>"}QH("dp51usersuggest",c),i=!0}}}QV("dp51usersuggest",i)}QE("idx_dlgOkButton",e)}function p51showAddUserDialogEx(e,t){if(null==t){var n,i=Q("dp51username").value.split(","),o=[];for(n in i)o.push(i[n].trim());meshserver.send({action:"addusertousergroup",ugrpid:currentUserGroup._id,usernames:o})}else meshserver.send({action:"addusertousergroup",ugrpid:currentUserGroup._id,usernames:[t.split("/")[2]]})}var currentUser=null;function gotoUser(e,t,n){if((!xxdialogMode||t)&&(null==n||null==n.originalTarget||null==n.originalTarget.href)){var i=currentUser=users[decodeURIComponent(e)];if(null==i)setDialogMode(0),go(4);else{QH("p30userName",EscapeHtml(i.name)),QH("p31userName",EscapeHtml(i.name));var t=i._id==userinfo._id,n=0,e=(null!=wssessions&&wssessions[i._id]&&(n=wssessions[i._id]),null!=i.flags&&1&i.flags?(QV("MainUserImage",!1),QV("MainUserImageEx",!0),null==i.accountImageRnd&&(i.accountImageRnd=Math.floor(9999999999*Math.random())),Q("MainUserImageEx").src="userimage.ashx?id="+i._id.split("/")[2]+"&rnd="+i.accountImageRnd):(Q("MainUserImage").classList.remove("gray"),0==n&&Q("MainUserImage").classList.add("gray"),QV("MainUserImage",!0),QV("MainUserImageEx",!1)),i._id.split("/")[2]),e=(e.startsWith("~twitter:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/twitter64.png"):e.startsWith("~google:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/google64.png"):e.startsWith("~github:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/github64.png"):e.startsWith("~azure:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/azure64.png"):e.startsWith("~oidc:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/oidc64.png"):e.startsWith("~jumpcloud:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/jumpcloud64.png"):e.startsWith("~intel:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/intel64.png"):e.startsWith("~:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/generic64.png"):QV("p30userAuthServiceLogo",!1),[]),o="",s=(null!=i.siteadmin&&0!=(32&i.siteadmin)&&4294967295!=i.siteadmin&&(o='<img src="images/padlock12.png" height=12 width=8 title="帐户已被锁定" style="margin-top:2px" /> ',e.push("被锁定账户")),null==i.siteadmin||0==(4294966047&i.siteadmin)?e.push("没有服务器权限"):8==i.siteadmin?e.push("访问服务器档案"):4294967295==i.siteadmin?e.push("完整管理员"):e.push("部分权限"),null!=i.siteadmin&&4294967295!=i.siteadmin&&0!=(1216&i.siteadmin)&&e.push("限制条件"),"<div style=min-height:80px><table style=width:100%>"),a=(0!=(8&args.hide)&&(s+="<br />"+addDeviceAttribute("名称",i.name)),i.email?EscapeHtml(i.email):"<i>没有设置</i>"),r="",l=i.realname?EscapeHtml(i.realname):"<i>没有设置</i>",d=(serverinfo.emailcheck&&(r=1==i.emailVerified?'<b style=color:green;cursor:pointer title="电子邮件已验证">&#x2713</b> ':'<b style=color:red;cursor:pointer title="邮箱未验证">&#x2717;</b> '),serverinfo.crossDomain||0!=debugmode?s=(s+=addDeviceAttribute("域",""!=(d=i._id.split("/")[1])?EscapeHtml(d):"<i>默认</i>"))+addDeviceAttribute("用户识别码",EscapeHtml(i._id)):i.name.toLowerCase()!=i._id.split("/")[2]&&(s+=addDeviceAttribute("用户识别码",EscapeHtml(i._id.split("/")[2]))),""),r=(i.email&&(d=' <a href="mailto:'+EscapeHtml(i.email)+'" \'><img class=hoverButton src="images/link1.png" /></a>'),s=4294967295!=i.siteadmin||4294967295==userinfo.siteadmin?(s+=addDeviceAttribute("电邮",'<span style=cursor:pointer onclick=p30showUserEmailChangeDialog(event,"'+encodeURIComponentEx(i._id)+'")>'+r+a+d+' <img class=hoverButton style=cursor:pointer src="images/link5.png" /></span>'))+addDeviceAttribute("真正的名字",'<span style=cursor:pointer onclick=p30showUserRealNameChangeDialog(event,"'+encodeURIComponentEx(i._id)+'")>'+l+' <img class=hoverButton style=cursor:pointer src="images/link5.png" /></span>'):(s+=addDeviceAttribute("电邮",r+a+d))+addDeviceAttribute("真正的名字",l),(33554432&features||null!=i.phone)&&(s+=addDeviceAttribute("电话号码","<span style=cursor:pointer onclick=p30editPhone()>"+(i.phone||"<i>没有</i>")+' <img class=hoverButton style=cursor:pointer src="images/link5.png" /></span>')),(33554432&features2||null!=i.msghandle)&&(s+=addDeviceAttribute("Messaging",'<span style=cursor:pointer onclick=p30editMessaging()><img src="images/messaging12.png" height=12 width=12 title="Messaging enabled" style="margin-top:2px" /> '+(i.msghandle||"<i>没有</i>")+' <img class=hoverButton style=cursor:pointer src="images/link5.png" /></span>')),[]),c=(1==serverinfo.usersSessionRecording&&i.flags&&2&i.flags&&r.push("记录会议"),i.removeRights&&(0!=(8&i.removeRights)?r.push("没有遥控器"):(0!=(65536&i.removeRights)?r.push("没有桌面"):0!=(256&i.removeRights)&&r.push("仅桌面视图"),0!=(512&i.removeRights)&&r.push("没有终端"),0!=(1024&i.removeRights)&&r.push("没有文件")),0!=(16&i.removeRights)&&r.push("没有控制台"),0!=(32768&i.removeRights)&&r.push("无卸载"),0!=(131072&i.removeRights)&&r.push("没有遥控器"),0!=(64&i.removeRights)&&r.push("没有唤醒"),0!=(262144&i.removeRights))&&r.push("无重置/关闭"),s=(s+=addDeviceAttribute("功能",addLink(r=""==(r=r.join(", "))?"<i>没有</i>":r,"p20edituserfeatures()")))+addDeviceAttribute("服务器权限","<span style=cursor:pointer onclick='return showUserAdminDialog(event,\""+encodeURIComponentEx(i._id)+"\")'>"+o+e.join(", ")+' <img style=cursor:pointer class=hoverButton src="images/link5.png" /></span>'),i.quota&&(s+=addDeviceAttribute("服务器配额",EscapeHtml(parseInt(i.quota)/1024)+" k")),s+=addDeviceAttribute("创建",printDateTime(new Date(1e3*i.creation))),i.login&&(s+=addDeviceAttribute("上次登录",printDateTime(new Date(1e3*i.login)))),-1==i.passchange?s+=addDeviceAttribute("密码","下次登录时将更改。"):i.passchange&&(s+=addDeviceAttribute("密码",format("上次更改：{0}",printDateTime(new Date(1e3*i.passchange))))),0),a="<i>没有<i>";if(i.links){for(var u in i.links)u.startsWith("mesh/")&&c++;1==c?a="1组":1<c&&(a=format("{0}个群组",c))}if(s+=addDeviceAttribute("设备组",a),4294967295==userinfo.siteadmin||2&userinfo.siteadmin){var p="<i>没有</i>";if(i.groups)for(var u in p="",i.groups)p+='<span class="tagSpan">'+EscapeHtml(i.groups[u])+"</span>";s+=addDeviceAttribute("管理领域",addLinkConditional(p,'showUserGroupDialog(event,"'+encodeURIComponentEx(i._id)+'")',4294967295==userinfo.siteadmin||null==userinfo.groups&&userinfo._id!=i._id&&4294967295!=i.siteadmin))}d=[],l=0,r=(i.consent&&(l=i.consent),serverinfo.consent&&(l|=serverinfo.consent),64&l&&8&l?d.push("桌面提示+工具栏"):64&l?d.push("桌面工具栏"):8&l?d.push("桌面提示"):1&l&&d.push("桌面通知"),16&l?d.push("终端提示"):2&l&&d.push("终端通知"),32&l?d.push("档案提示"):4&l&&d.push("档案通知"),7==l&&(d=["一直通知"]),s+=addDeviceAttribute("用户同意",addLinkConditional(d=""==(d=(d=56==(56&l)?["一直提示"]:d).join(", "))?"<i>没有</i>":d,"p20editmeshconsent(2)",!0)),0);if((0<i.otpsecret||0<i.otphkeys||0<i.otpekey||0<i.otpduo)&&(r=1,o=[],0<i.otpsecret&&o.push("认证软件"),0<i.otphkeys&&o.push("安全密钥"),0<i.otpekey&&o.push("电邮"),0<i.otpduo&&o.push("Duo"),0<i.otpkeys&&o.push("备用码"),0<i.otpdev&&o.push("设备推送"),null!=i.phone&&67108864&features&&o.push("短信"),null!=i.msghandle&&67108864&features2&&o.push("Messaging"),s+=addDeviceAttribute("安全",'<img src="images/key12.png" height=12 width=11 title="启用第二因素身份验证" style="margin-top:2px" /> '+o.join(", "))),s=(s+="</table></div><br />")+('<input type=button value="笔记" title="查看有关此用户的注释" onclick=showNotes(false,"'+encodeURIComponentEx(i._id)+'") />'),i.phone&&33554432&features&&(s+='<input type=button value="短信" title="发送短信给该用户" onclick=showSendSMS("'+encodeURIComponentEx(i._id)+'") />'),i.msghandle&&33554432&features2&&(s+='<input type=button value="消息" title="Send a message to this user" onclick=showSendMessage("'+encodeURIComponentEx(i._id)+'") />'),"string"==typeof i.email&&!0===i.emailVerified&&64&features&&(s+='<input type=button value="电邮" title="发送电邮给该用户" onclick=showSendEmail("'+encodeURIComponentEx(i._id)+'") />'),!t&&(0<n||8&features2&&i.webpush)&&(s=(s+='<input type=button value="通知" title="发送用户通知" onclick=showUserAlertDialog(event,"'+encodeURIComponentEx(i._id)+'") />')+'<input type=button value="聊天" title="聊天" onclick=userChat(event,"'+encodeURIComponentEx(i._id)+'","'+encodeURIComponentEx(i.name)+'") />',0<n)&&null!=serverinfo&&null!=serverinfo.altmessenging)for(var u in serverinfo.altmessenging){var m=serverinfo.altmessenging[u];null!=m.type&&"user"!=m.type||(s+='<input type=button value="'+EscapeHtml(m.name)+'" onclick=altUserChat(event,"'+encodeURIComponentEx(i._id)+'","'+encodeURIComponentEx(i.name)+'",'+u+") />")}QH("p30html",s),drawUserPermissions();var e=null!=userinfo.siteadmin&&2&userinfo.siteadmin&&4294967295!=i.siteadmin||4294967295==userinfo.siteadmin,g=(s="<div style=float:right;font-size:small>",e&&userinfo._id!=i._id&&(s+="<a href=# style=cursor:pointer onclick='return p30showDeleteUserDialog()' title=\"删除此用户\">删除用户</a>"),s+="</div><div style=font-size:small>",e&&0==(524288&features)&&"~"!=i._id.split("/")[2][0]&&(s=s+"<a href=# style=cursor:pointer onclick='return p30showUserChangePassDialog("+r+')\' title="更改该用户的密码">更改密码</a> <a href=# style=cursor:pointer onclick=\'return p30viewPreviousLogins()\' title="查看此用户以前的登录">以前的登录</a>'),s+="</div><br>",QH("p30html3",s),s="",1==n?s="1个活跃时段":1<n&&(s=format("{0}个活跃会话",n)),QH("MainUserState",s),go(30),QH("p31events",""),refreshUsersEvents(),"");if(0==(268435456&features)&&30<=xxcurrentView&&xxcurrentView<=39&&null!=currentUser){for(var u in g="?viewmode="+xxcurrentView+"&gotouser="+(serverinfo.crossDomain?currentUser._id:currentUser._id.split("/")[2]),urlargs)g+="&"+u+"="+urlargs[u];try{window.history.replaceState({},document.title,window.location.pathname+g)}catch(e){}}}}}function p30editPhone(){xxdialogMode||(setDialogMode(2,"电话通知",3,p30editPhoneEx,'<table style=width:100%><tr><td style=width:56px><img src="images/phone80.png" style=padding:8px>'+"<td style=width:100%;text-align:center>此用户的短信功能电话号码。<br />如没有请留空。"+('<br /><br /><div style=width:100%;text-align:center>电话号码： <input type=tel pattern="[0-9]" autocomplete="tel" value="'+(currentUser.phone||"")+'" inputmode="tel" maxlength=18 id=d2phoneinput onKeyUp=p30editPhoneValidate() onkeypress="if (event.key==\'Enter\') p30editPhoneValidate(1)"></div></table>'),"verifyPhone"),Q("d2phoneinput").focus(),p30editPhoneValidate())}function p30editMessaging(){var e,t;xxdialogMode||(t="<select id=d2serviceselect style=width:160px;margin-left:8px onchange=p30editMessagingValidate()><option value=0>没有</option>",0!=(1&serverinfo.userMsgProviders)&&(t+="<option value=1>Telegram</option>"),0!=(4&serverinfo.userMsgProviders)&&(t+="<option value=4>Discord</option>"),0!=(8&serverinfo.userMsgProviders)&&(t+="<option value=8>XMPP</option>"),0!=(16&serverinfo.userMsgProviders)&&(t+="<option value=16>CallMeBot</option>"),0!=(32&serverinfo.userMsgProviders)&&(t+="<option value=32>Pushover</option>"),0!=(64&serverinfo.userMsgProviders)&&(t+="<option value=64>ntfy</option>"),0!=(128&serverinfo.userMsgProviders)&&(t+="<option value=128>Zulip</option>"),0!=(256&serverinfo.userMsgProviders)&&(t+="<option value=256>Slack</option>"),e=(e='<table style=width:100%><tr><td style=width:56px;vertical-align:top><img src="images/messaging40.png" style=padding:8px>')+"<td style=width:100%>Messaging account for this user.<table style=margin-top:12px><tr><td>Service<td>"+(t+="</select>")+"<tr><td>Handle<td><input maxlength=1024 style=width:160px;margin-left:8px id=d2handleinput onKeyUp=p30editMessagingValidate() onkeypress=\"if (event.key=='Enter') p30editMessagingValidate(1)\"></table>",serverinfo.discordUrl&&(e+="<div id=d2discordurl style=display:none><br /><a href="+serverinfo.discordUrl+' target="_discord">Join this Discord server to receive notifications.</a></div>'),setDialogMode(2,"Messaging Notifications",3,p30editMessagingEx,e=(e=e+'<div id=d2callmebotinfo style=display:none><br /><a href=https://www.callmebot.com/blog/free-api-signal-send-messages/ target="_callmebot">Signal</a>, <a href=https://www.callmebot.com/blog/free-api-whatsapp-messages/ target="_callmebot">Whatsapp</a>, <a href=https://www.callmebot.com/blog/free-api-facebook-messenger/ target="_callmebot">Facebook</a>, <a href=https://www.callmebot.com/blog/telegram-text-messages/ target="_callmebot">Telegram</a></div>'+'<div id=d2pushoverinfo style=display:none><br /><a href=https://pushover.net/ target="_pushover">Information at Pushover.net</a></div>')+('<div id=d2ntfyinfo style=display:none><br /><a href="'+(serverinfo.userMsgNftyUrl||"https://ntfy.sh/")+'" target="_ntfy">Free service at ntfy.sh</a></div>')+'<div id=d2slackinfo style=display:none><br /><a href=https://api.slack.com/messaging/webhooks target="_slack">Slack Webhook Setup</a></div>',"verifyMessaging"),Q("d2handleinput").focus(),currentUser.msghandle&&(currentUser.msghandle.startsWith("telegram:")&&0!=(1&serverinfo.userMsgProviders)&&(Q("d2serviceselect").value=1,Q("d2handleinput").value=currentUser.msghandle.substring(10)),currentUser.msghandle.startsWith("discord:")&&0!=(4&serverinfo.userMsgProviders)&&(Q("d2serviceselect").value=4,Q("d2handleinput").value=currentUser.msghandle.substring(8)),currentUser.msghandle.startsWith("xmpp:")&&0!=(8&serverinfo.userMsgProviders)&&(Q("d2serviceselect").value=8,Q("d2handleinput").value=currentUser.msghandle.substring(5)),currentUser.msghandle.startsWith("callmebot:")&&0!=(16&serverinfo.userMsgProviders)&&(Q("d2serviceselect").value=16,"signal"==(t=currentUser.msghandle.substring(10).split("|"))[0]&&3==t.length&&(Q("d2handleinput").value="https://api.callmebot.com/signal/send.php?phone="+decodeURIComponent(t[1])+"&apikey="+decodeURIComponent(t[2])),"whatsapp"==t[0]&&3==t.length&&(Q("d2handleinput").value="https://api.callmebot.com/whatsapp.php?phone="+decodeURIComponent(t[1])+"&apikey="+decodeURIComponent(t[2])),"facebook"==t[0])&&2==t.length&&(Q("d2handleinput").value="https://api.callmebot.com/facebook/send.php?apikey="+decodeURIComponent(t[1])),currentUser.msghandle.startsWith("pushover:")&&0!=(32&serverinfo.userMsgProviders)&&(Q("d2serviceselect").value=32,Q("d2handleinput").value=currentUser.msghandle.substring(9)),currentUser.msghandle.startsWith("ntfy:")&&0!=(64&serverinfo.userMsgProviders)&&(Q("d2serviceselect").value=64,Q("d2handleinput").value=currentUser.msghandle.substring(5)),currentUser.msghandle.startsWith("zulip:")&&0!=(128&serverinfo.userMsgProviders)&&(Q("d2serviceselect").value=128,Q("d2handleinput").value=currentUser.msghandle.substring(6)),currentUser.msghandle.startsWith("slack:"))&&0!=(256&serverinfo.userMsgProviders)&&(Q("d2serviceselect").value=256,Q("d2handleinput").value=currentUser.msghandle.substring(6)),p30editMessagingValidate())}function p30editMessagingValidate(e){QE("d2handleinput",0!=Q("d2serviceselect").value),serverinfo.discordUrl&&QV("d2discordurl",4==Q("d2serviceselect").value),QV("d2callmebotinfo",16==Q("d2serviceselect").value),QV("d2pushoverinfo",32==Q("d2serviceselect").value),QV("d2ntfyinfo",64==Q("d2serviceselect").value),QV("d2slackinfo",256==Q("d2serviceselect").value),0==Q("d2serviceselect").value?Q("d2handleinput").placeholder="":4==Q("d2serviceselect").value?Q("d2handleinput").placeholder="Username:0000":8==Q("d2serviceselect").value?Q("d2handleinput").placeholder="username@server.com":16==Q("d2serviceselect").value?Q("d2handleinput").placeholder="https://api.callmebot.com/...":32==Q("d2serviceselect").value?Q("d2handleinput").placeholder="User key":64==Q("d2serviceselect").value?Q("d2handleinput").placeholder="主题":128==Q("d2serviceselect").value?Q("d2handleinput").placeholder="username@sample.com":256==Q("d2serviceselect").value?Q("d2handleinput").placeholder="https://hooks.slack.com/...":Q("d2handleinput").placeholder="用户名",1==e&&dialogclose(1)}function p30editMessagingEx(){var e=null;""==Q("d2handleinput").value||0==Q("d2serviceselect").value?e="":1==Q("d2serviceselect").value?e="telegram:@"+Q("d2handleinput").value:4==Q("d2serviceselect").value?e="discord:"+Q("d2handleinput").value:8==Q("d2serviceselect").value?e="xmpp:"+Q("d2handleinput").value:16==Q("d2serviceselect").value?e="callmebot:"+Q("d2handleinput").value:32==Q("d2serviceselect").value?e="pushover:"+Q("d2handleinput").value:64==Q("d2serviceselect").value?e="ntfy:"+Q("d2handleinput").value:128==Q("d2serviceselect").value?e="zulip:"+Q("d2handleinput").value:256==Q("d2serviceselect").value&&(e="slack:"+Q("d2handleinput").value),null!=e&&meshserver.send({action:"edituser",id:currentUser._id,msghandle:e})}function p20edituserfeatures(){var e,t,n;xxdialogMode||(e=currentUser.flags||0,t=currentUser.removeRights||0,n=n="",1==serverinfo.usersSessionRecording&&(n+="<div><label><input type=checkbox id=d20flag1 onchange=p20edituserfeaturesValidate() "+(2&e?"checked":"")+">记录会议</label><br></div>"),setDialogMode(2,"编辑用户特征",3,p20edituserfeaturesEx,n=(n=(n=(n=(n=n+("<div><label><input type=checkbox id=d20flag7 onchange=p20edituserfeaturesValidate() "+(8&t?"checked":"")+">没有遥控器</label><br></div>")+("<div style=margin-left:8px><label><input type=checkbox id=d20flag2 onchange=p20edituserfeaturesValidate() "+(65536&t?"checked":"")+">不能访问桌面</label><br></div>"))+("<div style=margin-left:16px><label><input type=checkbox id=d20flag3 onchange=p20edituserfeaturesValidate() "+(256&t?"checked":"")+">仅远程查看</label><br></div>")+("<div style=margin-left:8px><label><input type=checkbox id=d20flag4 onchange=p20edituserfeaturesValidate() "+(512&t?"checked":"")+">不能访问终端</label><br></div>"))+("<div style=margin-left:8px><label><input type=checkbox id=d20flag5 onchange=p20edituserfeaturesValidate() "+(1024&t?"checked":"")+">不能存取档案</label><br></div>")+("<div><label><input type=checkbox id=d20flag6 onchange=p20edituserfeaturesValidate() "+(16&t?"checked":"")+">无座席控制台</label><br></div>"))+("<div><label><input type=checkbox id=d20flag8 onchange=p20edituserfeaturesValidate() "+(32768&t?"checked":"")+">无卸载</label><br></div>")+("<div><label><input type=checkbox id=d20flag9 onchange=p20edituserfeaturesValidate() "+(131072&t?"checked":"")+">没有遥控器</label><br></div>"))+("<div><label><input type=checkbox id=d20flag10 onchange=p20edituserfeaturesValidate() "+(64&t?"checked":"")+">没有唤醒</label><br></div>")+("<div><label><input type=checkbox id=d20flag11 onchange=p20edituserfeaturesValidate() "+(262144&t?"checked":"")+">无重置/关闭</label><br></div>")),p20edituserfeaturesValidate())}function p20edituserfeaturesValidate(){QE("d20flag2",!Q("d20flag7").checked),QE("d20flag3",!Q("d20flag7").checked&&!Q("d20flag2").checked),QE("d20flag4",!Q("d20flag7").checked),QE("d20flag5",!Q("d20flag7").checked)}function p20edituserfeaturesEx(){var e=1&(currentUser.flags||0),t=(1==serverinfo.usersSessionRecording&&Q("d20flag1").checked&&(e+=2),0);Q("d20flag7").checked?t+=8:(Q("d20flag2").checked?t+=65536:Q("d20flag3").checked&&(t+=256),Q("d20flag4").checked&&(t+=512),Q("d20flag5").checked&&(t+=1024)),Q("d20flag6").checked&&(t+=16),Q("d20flag8").checked&&(t+=32768),Q("d20flag9").checked&&(t+=131072),Q("d20flag10").checked&&(t+=64),Q("d20flag11").checked&&(t+=262144),meshserver.send({action:"edituser",id:currentUser._id,flags:e,removeRights:t})}function p30editPhoneValidate(e){var t=""==Q("d2phoneinput").value||isPhoneNumber(Q("d2phoneinput").value);QE("idx_dlgOkButton",t),1==e&&t&&dialogclose(1)}function p30editPhoneEx(){meshserver.send({action:"edituser",id:currentUser._id,phone:Q("d2phoneinput").value})}function p30showUserRealNameChangeDialog(e){var t;return xxdialogMode||(t="",t+=addHtmlValue("真正的名字","<input id=dp30realname style=width:230px maxlength=256 />"),setDialogMode(2,format("更改{0}的真实名称",EscapeHtml(currentUser.name)),3,p30showUserRealNameChangeDialogEx,t),Q("dp30realname").focus(),Q("dp30realname").value=currentUser.realname||""),!1}function p30showUserRealNameChangeDialogEx(){meshserver.send({action:"edituser",id:currentUser._id,realname:Q("dp30realname").value})}function p30showUserEmailChangeDialog(e){var t;return xxdialogMode||(t="",t+=addHtmlValue("电邮","<input id=dp30email style=width:230px maxlength=32 onchange=p30validateEmail() onkeyup=p30validateEmail() />"),serverinfo.emailcheck&&(t+=addHtmlValue("状况","<select id=dp30verified style=width:230px onchange=p30validateEmail()><option value=0>未经审核的</option><option value=1>已验证</option></select>")),setDialogMode(2,format("更改{0}的邮箱",EscapeHtml(currentUser.name)),3,p30showUserEmailChangeDialogEx,t),Q("dp30email").focus(),Q("dp30email").value=currentUser.email||"",serverinfo.emailcheck&&(Q("dp30verified").value=currentUser.emailVerified?1:0),p30validateEmail()),!1}function p30validateEmail(){var e=Q("dp30email").value,t=e.split("@"),t=0==e.length||2==t.length&&0<t[0].length&&1<t[1].split(".").length&&2<t[1].length&&e.length<1024&&(e!=userinfo.email||1==serverinfo.emailcheck&&Q("dp30verified").value!=(userinfo.emailVerified?1:0));QE("idx_dlgOkButton",t)}function p30showUserEmailChangeDialogEx(){var e={action:"edituser",id:currentUser._id,email:Q("dp30email").value};serverinfo.emailcheck&&(e.emailVerified=1==Q("dp30verified").value),meshserver.send(e)}function p30viewPreviousLogins(){xxdialogMode||(setDialogMode(2,"以前的登录",1,null,"载入中...","previousLogins:"+currentUser._id),meshserver.send({action:"previousLogins",userid:currentUser._id}))}function p30showUserChangePassDialog(e){if(!xxdialogMode){var t="",t=(t+=addHtmlValue("密码","<input id=p4pass1 type=password style=width:230px maxlength=256 onchange=p30showUserChangePassDialogValidate(1) onkeyup=p30showUserChangePassDialogValidate(1)></input>"))+addHtmlValue("密码","<input id=p4pass2 type=password style=width:230px maxlength=256 onchange=p30showUserChangePassDialogValidate(1) onkeyup=p30showUserChangePassDialogValidate(1)></input>");if(65536&features&&(t+=addHtmlValue("密码提示","<input id=p4hint type=text style=width:230px maxlength=256></input>")),passRequirements){var n,i=[],o=0;for(n in passRequirements)"reset"!=n&&"hint"!=n&&(i.push(n+":"+passRequirements[n]),o++);0<o&&(t+="<div style=font-size:x-small;padding:6px>"+format("要求：{0}。",i.join(", "))+"</div>")}t+="<div><label><input id=p4resetNextLogin type=checkbox />下次登录时强制重置密码。</label></div>",1==e&&(t+="<div><label><input id=p4twoFactorRemove type=checkbox />删除所有两因素认证。</label></div>"),setDialogMode(2,format("更改{0}的密码",EscapeHtml(currentUser.name)),3,p30showUserChangePassDialogEx,t,e),p30showUserChangePassDialogValidate(),Q("p4pass1").focus(),-1==currentUser.passchange&&(Q("p4resetNextLogin").checked=!0)}}function p30showUserChangePassDialogValidate(){var e=!0;""==Q("p4pass1").value&&""==Q("p4pass2").value||(Q("p4pass1").value!=Q("p4pass2").value||passRequirements&&0==checkPasswordRequirements(Q("p4pass1").value,passRequirements))&&(e=!1),QE("idx_dlgOkButton",e)}function p30showUserChangePassDialogEx(e,t){var n=!1;1==t&&1==Q("p4twoFactorRemove").checked&&(n=!0),Q("p4pass1").value==Q("p4pass2").value&&(t={action:"changeuserpass",userid:currentUser._id,pass:Q("p4pass1").value,removeMultiFactor:n,resetNextLogin:Q("p4resetNextLogin").checked},65536&features&&(t.hint=Q("p4hint").value),meshserver.send(t))}function p30showDeleteUserDialog(){xxdialogMode||(setDialogMode(2,format("删除用户{0}",EscapeHtml(currentUser.name)),3,p30showDeleteUserDialogEx,format("确认删除用户{0}？",EscapeHtml(currentUser.name))+"<br /><br /><label><input id=p10check type=checkbox onchange=p10validateDeleteNodeDialog() />确认</label>"),p10validateDeleteNodeDialog())}function p30showDeleteUserDialogEx(){meshserver.send({action:"deleteuser",userid:currentUser._id,username:currentUser.name})}function drawUserPermissions(){var e=1,t="",n=0,i=!1;for(v in meshes)meshes[v]._id.split("/")[1]==currentUser._id.split("/")[1]&&(n++,null==currentUser.links||null==currentUser.links[v])&&(i=!0);if(0<n&&i&&(t+='<a href=# onclick="return p20showAddMeshUserDialog(1)" style=cursor:pointer;margin-right:10px><img src=images/icon-addnew.png border=0 height=12 width=12> 添加设备组</a>'),t+='<table style="color:black;background-color:#EEE;border-color:#AAA;border-width:1px;border-style:solid;border-collapse:collapse" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col style=text-align:left;width:430px>通用设备组</th><th scope=col style=text-align:left></th></tr>',currentUser.links){var o=[];for(v in currentUser.links)v.startsWith("mesh/")&&null!=meshes[v]&&o.push(meshes[v]);for(v in o=getOrderedList(o,"name")){var s,a=0,r=o[v],l="",d=makeDeviceGroupRightsString(g=currentUser.links[r._id].rights);null!=r&&(userinfo.links&&null!=userinfo.links[r._id]&&null!=userinfo.links[r._id].rights&&(a=userinfo.links[r._id].rights),s="<i>未知设备组</i>",r&&(s="<a href=# onclick='gotoMesh(\""+r._id+"\");haltEvent(event);'>"+EscapeHtml(r.name)+"</a>"),currentUser._id!=userinfo._id&&0!=(2&a)&&(l="<a href=# onclick='return p30removeMeshFromUser(event,\""+encodeURIComponentEx(r._id)+'")\' title="删除此设备组的用户权限" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>',d='<span style=cursor:pointer onclick=p20showAddMeshUserDialog(1,"'+encodeURIComponentEx(r._id)+'")>'+d+" <img class=hoverButton style=cursor:pointer src=images/link5.png></span>"),t+="<tr "+(++e%2==0?"style=background-color:#DDD":"")+'><td style=width:30%><div title="设备组" class=m99></div><div>&nbsp;'+s+"<div></div></div></td><td style=width:70%><div style=float:right>"+l+"</div><div>"+d+"</div></td></tr>")}}if(1==e&&(t+="<tr><td><div style=padding:6px>&nbsp;<i>没有共同的设备组</i><div></div></div></td><td></td></tr>"),t+="</tbody></table>",null!=usergroups){if(e=1,t+="<br />",0!=(256&userinfo.siteadmin)){var c=0,u=!1;for(v in usergroups)null==usergroups[v].membershipType&&usergroups[v]._id.split("/")[1]==currentUser._id.split("/")[1]&&(c++,null==currentUser.links||null==currentUser.links[v])&&(u=!0);0<c&&u&&(t+='<a href=# onclick="return p30showAddUserGroupDialog()" style=cursor:pointer;margin-right:10px><img src=images/icon-addnew.png border=0 height=12 width=12> 添加用户组</a>')}if(t+='<table style="color:black;background-color:#EEE;border-color:#AAA;border-width:1px;border-style:solid;border-collapse:collapse" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col style=text-align:left;width:430px>用户组成员</th><th scope=col style=text-align:left></th></tr>',currentUser.links){var p=[];for(v in currentUser.links)v.startsWith("ugrp/")&&null!=usergroups[v]&&p.push(usergroups[v]);for(v in p=getOrderedList(p,"name")){var m=p[v],g=currentUser.links[p[v]._id].rights,l="",h="<i>未知用户组</i>";t+="<tr "+(++e%2==0?"style=background-color:#DDD":"")+'><td><div title="用户组" class=m4></div><div>&nbsp;'+(h=null!=m&&(h=EscapeHtml(m.name),null!=usergroups)?"<a href=# onclick='gotoUserGroup(\""+encodeURIComponentEx(p[v]._id)+"\");haltEvent(event);'>"+h+"</a>":h)+"<div></div></div></td><td><div style=float:right>"+(l=null==m.membershipType&&0!=(256&userinfo.siteadmin)?"<a href=# onclick='return p30RemoveUserGroup(event,\""+encodeURIComponentEx(p[v]._id)+'")\' title="删除用户组成员身份" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>':l)+"</div></td></tr>"}}1==e&&(t+="<tr><td><div style=padding:6px>&nbsp;<i>没有用户组成员身份</i><div></div></div></td><td></td></tr>"),t+="</tbody></table>"}if(e=1,t+="<br />",currentUser._id.split("/")[1]==userinfo._id.split("/")[1]&&(t+='<a href=# onclick="return p20showAddMeshUserDialog(4)" style=cursor:pointer;margin-right:10px><img src=images/icon-addnew.png border=0 height=12 width=12> 添加设备</a>'),t+='<table style="color:black;background-color:#EEE;border-color:#AAA;border-width:1px;border-style:solid;border-collapse:collapse" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col style=text-align:left;width:430px>通用设备</th><th scope=col style=text-align:left></th></tr>',currentUser.links){var v,f=[];for(v in currentUser.links)v.startsWith("node/")&&null!=(k=getNodeFromId(v))&&f.push(k);for(v in f.sort(nameSort),f){var k=f[v],g=currentUser.links[k._id].rights,l="",a=GetNodeRights(k),x=(userinfo.links&&null!=userinfo.links[v]&&null!=userinfo.links[v].rights&&(a=userinfo.links[v].rights),k?EscapeHtml(k.name):"<i>未知设备</i>");0!=(2&a)&&(l="<a href=# onclick='return p30removeNodeFromUser(event,\""+encodeURIComponentEx(k._id)+'")\' title="删除此设备组的用户权限" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>',d='<span style=cursor:pointer onclick=p20showAddMeshUserDialog(4,"'+encodeURIComponentEx(k._id)+'")>'+makeUserDeviceRightsString(g)+" <img class=hoverButton style=cursor:pointer src=images/link5.png></span>"),x="<a href=# onclick='gotoDevice(\""+k._id+"\",10);haltEvent(event);'>"+x+"</a>",t+="<tr "+(++e%2==0?"style=background-color:#DDD":"")+'><td style=width:30%><div title="设备" class=si'+k.icon+"></div><div>&nbsp;"+x+"<div></div></div></td><td style=width:70%><div style=float:right>"+l+"</div><div>"+d+"</div></td></tr>"}}1==e&&(t+="<tr><td><div style=padding:6px>&nbsp;<i>没有共同的设备</i><div></div></div></td><td></td></tr>"),t+="</tbody></table>",QH("p30html2",t)}function p30removeDeviceSharing(e,t,n,i){xxdialogMode||setDialogMode(2,"删除设备共享",3,function(e,t){meshserver.send({action:"removeDeviceShare",nodeid:t[0],publicid:t[1]})},format("确认删除设备共享“{0}”？",decodeURIComponent(i)),[decodeURIComponent(t),decodeURIComponent(n)])}function p30removeNodeFromUser(e,t){xxdialogMode||setDialogMode(2,"删除设备权限",3,function(e,t){meshserver.send({action:"adddeviceuser",nodeid:t._id,nodename:t.name,userids:[currentUser._id],rights:0,remove:!0})},format("确认删除设备“ {0} ”的访问权限？",(t=getNodeFromId(decodeURIComponent(t))).name),t)}function p30removeUserFromNode(e,n){var t,i;xxdialogMode||(t=null,i="",(n=decodeURIComponent(n)).startsWith("user/")?setDialogMode(2,"删除用户权限",3,function(e,t){meshserver.send({action:"adddeviceuser",nodeid:currentNode._id,nodename:currentNode.name,userids:[n],rights:0,remove:!0})},(i=users&&null!=(t=users[n])?t.name:i)?format("确认删除用户“ {0} ”的访问权限？",i):"确认删除访问权限？",t):n.startsWith("ugrp/")&&setDialogMode(2,"删除用户组权限",3,function(e,t){meshserver.send({action:"adddeviceuser",nodeid:currentNode._id,nodename:currentNode.name,userids:[n],rights:0,remove:!0})},(i=usergroups&&null!=(t=usergroups[n])?t.name:i)?format("确认删除用户组“ {0} ”的访问权限？",i):"确认删除访问权限？",t))}function p30RemoveUserGroup(e,t){var n;xxdialogMode||null==usergroups||(t=decodeURIComponent(t),setDialogMode(2,"删除用户组成员身份",3,p30RemoveUserGroupEx,format("确认删除用户组“ {0} ”的成员身份？",null!=(n=usergroups[t])?EscapeHtml(n.name):"<i>未知</i>"),t))}function p30RemoveUserGroupEx(e,t){meshserver.send({action:"removeuserfromusergroup",ugrpid:t,userid:currentUser._id})}function p30showAddUserGroupDialog(){if(!xxdialogMode&&null!=usergroups){var e,t="";for(e in usergroups)null!=usergroups[e].membershipType||usergroups[e]._id.split("/")[1]!=currentUser._id.split("/")[1]||null!=currentUser.links&&null!=currentUser.links[e]||(t+="<option value="+encodeURIComponentEx(e)+">"+EscapeHtml(usergroups[e].name)+"</option>");return setDialogMode(2,"添加成员身份",3,p30showAddUserGroupDialogEx,addHtmlValue("用户组","<div style=width:230px;margin:0;padding:0><select id=dp2groupid style=width:100%>"+t+"</select></div>")),Q("dp2groupid").focus(),!1}}function p30showAddUserGroupDialogEx(){meshserver.send({action:"addusertousergroup",ugrpid:decodeURIComponent(Q("dp2groupid").value),usernames:[currentUser._id.split("/")[2]]})}function p30removeMeshFromUser(e,t){xxdialogMode||null!=(t=meshes[decodeURIComponent(t)])&&setDialogMode(2,"删除设备组权限",3,p30removeMeshFromUserEx,format("确认删除设备组“ {0} ”的访问权限？",t.name),t._id)}function p30removeMeshFromUserEx(e,t){meshserver.send({action:"removemeshuser",meshid:t,userid:currentUser._id})}var currentUserEvents=null;function userEventsUpdate(){if(null!=currentUser){var e="",t=null;for(r in currentUserEvents){var n=currentUserEvents[r],i=new Date(n.time);if(n.msg){null==n.h&&(n.h=Math.random()),printDate(i)!=t&&(null!=t&&(e+="</table>"),e+="<table class=p3eventsTable cellpadding=0 cellspacing=0><tr><td colspan=4 class=DevSt>"+(t=printDate(i))+"</td></tr>");var o,s,a="si3";if("user"==n.etype&&(a="m2"),"server"==n.etype&&(a="si3"),null==n.msgid||null==eventsMessageId[n.msgid])o="string"==typeof n.msg?EscapeHtml(n.msg).split("(R)").join("&reg;"):"";else{for(var r in o=eventsMessageId[n.msgid],n.msgArgs){var l=n.msgArgs[r];"string"==typeof l&&0==l.indexOf("DATETIME:")&&(l=printFlexDateTime(new Date(parseInt(l.substring(9))))),o=o.split("{"+r+"}").join(l)}o=EscapeHtml(o).split("(R)").join("&reg;")}n.nodeid&&null!=(s=getNodeFromId(n.nodeid))&&(a="si"+s.icon,o="<a href=# onclick='gotoDevice(\""+n.nodeid+"\",10);haltEvent(event);'>"+EscapeHtml(s.name)+"</a> &rarr; "+o),n.username&&n.username!=currentUser.name?(s="",n.guestname&&(s=' / <span title="这是嘉宾分享环节">'+EscapeHtml(n.guestname)+"</span>"),o=2&userinfo.siteadmin&&n.userid?"<a href=# onclick='gotoUser(\""+encodeURIComponentEx(n.userid)+"\");haltEvent(event);'>"+EscapeHtml(n.username)+"</a>"+s+" &rarr; "+o:EscapeHtml(n.guestname)+" &rarr; "+o):n.guestname&&(o='<span title="这是嘉宾分享环节">'+EscapeHtml(n.guestname)+"</span> &rarr; "+o),"relay"!=n.etype&&"relaylog"!=n.action||(a="relayIcon16"),e+="<tr onclick=showEventDetails("+n.h+",3)  onmouseover=eventMouseHover(this,1) onmouseout=eventMouseHover(this,0) style=cursor:pointer><td style=width:18px><div class="+a+"></div></td><td class=g1>&nbsp;</td><td class=style10>"+printTime(i)+" - "+o+"</td><td class=g2>&nbsp;</td></tr><tr style=height:2px></tr>"}}null!=t&&(e+="</table>"),""==e&&(e="<br><i>找不到事件</i><br><br>"),QH("p31events",e)}}function refreshUsersEvents(){""!=p31filterevents.value?meshserver.send({action:"events",limit:parseInt(p31limitdropdown.value),userid:currentUser._id,filter:p31filterevents.value}):meshserver.send({action:"events",limit:parseInt(p31limitdropdown.value),userid:currentUser._id})}var d3filetreelinkpath,p52recordings=null;function updateRecordings(){for(var e=[],t=document.getElementsByClassName("RecordingCheckbox"),n="",i=0;i<t.length;i++)t[i].checked&&e.push(t[i].value);if(null==p52recordings)n+="<div style=width:100%;text-align:center;margin-top:20px><i>载入中...</i></div>";else if("number"==typeof p52recordings)n+=1==p52recordings?"<div style=width:100%;text-align:center;margin-top:20px><i>Server is unable to read from the recordings folder.</i></div>":2==p52recordings?"<div style=width:100%;text-align:center;margin-top:20px><i>Server is unable to get recordings from the database.</i></div>":"<div style=width:100%;text-align:center;margin-top:20px><i>An unknown error occured.</i></div>";else if(0==p52recordings.length)n+="<div style=width:100%;text-align:center;margin-top:20px><i>没有录音。</i></div>";else{if(n=(n+="<table class=p3usersTable cellpadding=0 cellspacing=0>")+("<th>会话<th style=width:110px>"+nobreak("开始时间")+"<th style=width:110px>持续时间<th style=width:110px>尺寸"),null!=p52recordings){var o=null;for(i in p52recordings){var s=p52recordings[i],a=printDate(new Date(s.time));a!=o&&(n+="<tr><td class=userTableHeader colspan=4>"+(o=a)),n+=addRecordingHtml(i,s)}}n+="</table>"}QH("p52recordings",n);for(t=document.getElementsByClassName("RecordingCheckbox"),i=0;i<t.length;i++)t[i].checked=0<=e.indexOf(t[i].value);p52updateInfo()}function addRecordingHtml(e,t){var n="",i=(t.lengthTime&&(n=pad2(Math.floor(t.lengthTime/3600))+":"+pad2(Math.floor(t.lengthTime%3600/60))+":"+pad2(Math.floor(t.lengthTime%60))),printTime(new Date(t.time))),o=(t.sessionStart&&(i=printTime(new Date(t.sessionStart))),""),s=(t.size&&(o=format("{0} Kb",Math.round(t.size/1024))),"<i>未知</i>"),a=(t.name&&t.meshname&&(s=null!=meshes[t.meshid]?"<a href=# onclick='gotoMesh(\""+t.meshid+"\")'>"+EscapeHtml(t.meshname)+"</a> - <a href=# onclick='gotoDevice(\""+t.nodeid+"\",10)'>"+EscapeHtml(t.name)+"</a>":EscapeHtml(t.meshname)+" - "+EscapeHtml(t.name)),null!=t.userids&&0<t.userids.length&&(1<t.userids.length?s+=" - "+format("{0} users",t.userids.length):s+=(a=null)!=(a=null!=users?users[t.userids[0]]:a)?" - <a href=# onclick='gotoUser(\""+encodeURIComponentEx(t.userids[0])+"\")'>"+EscapeHtml(a.name)+"</a>":" - "+EscapeHtml(t.userids[0].split("/")[2])),1==t.protocol&&(s+=" - 终端会话"),2==t.protocol&&(s+=" - 桌面会话"),5==t.protocol&&(s+=" - 文件传输"),100==t.protocol&&(s+=" - 英特尔&reg;AMT WSMAN"),101==t.protocol&&(s+=" - 英特尔&reg;AMT重定向"),200==t.protocol&&(s+=" - 信使"),""),r="m0",t=(1==t.present&&(r="m1",a='<div style=cursor:pointer;float:right><a onclick=downloadFile("recordings.ashx?file='+encodeURIComponentEx(t.filename)+'")><img src=images/link4.png height=10 width=10 title="Download Recording"></a>&nbsp;</div>',a+='<div style=cursor:pointer;float:right><a href="player.htm?stream='+encodeURIComponentEx(t.filename)+'") rel="noreferrer noopener" target="mcplay-'+encodeURIComponentEx(t.filename)+'"><img src=images/link7.png height=10 width=10 title="Play Recording"></a>&nbsp;</div>'),"<tr tabindex=0 onmouseover=userMouseHover2(this,1) onmouseout=userMouseHover2(this,0) onkeypress=\"if (event.key=='Enter') showRecordingDialog(event,'"+e+"')\"><td style=cursor:pointer>");return(t+="<div class=bar style=width:100%>")+"<div></div>"+('<div class=baricon onclick=showRecordingDialog(event,"'+e+'")><div class='+r+"></div></div>")+('<div class=g1 onclick=showRecordingDialog(event,"'+e+'")></div><div class=g2 onclick=showRecordingDialog("'+e+'")></div>')+('<div style=line-height:24px onclick=showRecordingDialog(event,"'+e+'")>'+a+"<div style=font-size:16px>"+s+"</div></div></div><td style=text-align:center>"+i+"<td style=text-align:center>"+n+"<td style=text-align:center>"+o)}function showRecordingDialog(e,t){if(!xxdialogMode&&"IMG"!=e.target.tagName&&"A"!=e.target.tagName){var n=p52recordings[t],i="";if(n.protocol&&(e="未知",1==n.protocol&&(e="终端"),2==n.protocol&&(e="桌面"),5==n.protocol&&(e="档案"),100==n.protocol&&(e="英特尔&reg;AMT WSMAN"),i+=addHtmlValue4("协议",e=101==n.protocol?"英特尔&reg;AMT重定向":e)),i+=addHtmlValue4("状况",1==n.present?"存在于服务器上":"不在服务器上"),n.name&&(i+=addHtmlValue4("设备名称",EscapeHtml(n.name))),n.meshname&&(i+=addHtmlValue4("设备组",EscapeHtml(n.meshname))),n.size&&(i+=addHtmlValue4("尺寸",format("{0}个字节",n.size))),n.startTime&&(i+=addHtmlValue4("开始时间",printTime(new Date(n.startTime)))),n.time&&(i+=addHtmlValue4("时间结束",printTime(new Date(n.time)))),n.lengthTime&&(i+=addHtmlValue4("持续时间",pad2(Math.floor(n.lengthTime/3600))+":"+pad2(Math.floor(n.lengthTime%3600/60))+":"+pad2(Math.floor(n.lengthTime%60)))),1==n.multiplex&&(i+=addHtmlValue4("多路复用器","已启用")),n.userids)for(var t in n.userids)i+=addHtmlValue4("用户",n.userids[t].split("/")[2]);setDialogMode(2,"记录细节",9,null,i)}}function refreshRecodings(){meshserver.send({action:"recordings",limit:1e3})}function openRecodringPlayer(){xxdialogMode||safeNewWindow(window.location.origin+"{{{domainurl}}}player.htm","meshcentral-deskplayer")}function p52updateInfo(){for(var e=document.getElementsByClassName("RecordingCheckbox"),t=0;t<e.length;t++)!0===e[t].checked&&0}function d3init(){d3fileoptions={dialog:1,filter:"d3filter",files:"d3serverfiles",folderup:"p3FolderUp",currentFolder:"p3CurrentFolder",func:d3setActions},Q("d3localFile").value="",Q("d3localFile").accept=Q("d3filter").value,d3modechange()}function d3modechange(){var e=Q("d3uploadMode").value;QV("d3localmode",1==e),QV("d3servermode",2==e),(1==e?d3setActions:d3updatefiles)()}var d3filetreelocation=[],d3fileoptions=null;function d3updatefiles(){if(null!=d3fileoptions&&("d3filter"!=d3fileoptions.filter||1!=Q("d3uploadMode").value)){for(var e,t="",n="",i=filetree,o=1,s="",a=[],r=[],l=document.getElementsByName("fc"),d=0;d<l.length;d++)l[d].checked&&r.push(l[d].value);for(d in d3filetreelinkpath="",d3filetreelocation){if(null==i.f||null==i.f[d3filetreelocation[d]])break;a.push(d3filetreelocation[d]),1==o?(e=d3filetreelocation[d].split("/"),window.location.origin,e[0],d3filetreelocation[d]===userinfo._id?d3filetreelinkpath+="self":d3filetreelinkpath+=e[0]+"/"+e[2]):""!=d3filetreelinkpath&&(d3filetreelinkpath+="/"+d3filetreelocation[d],2<o)&&d3filetreelocation[d],s=(i=i.f[d3filetreelocation[d]]).n,o++}d3filetreelocation=a;var c=p5sort_files(i.f),u="";for(d in d3fileoptions.filter&&(u=Q(d3fileoptions.filter).value),c){var p,m,g=c[d],h=g.n;3==g.t&&""!=u&&0==g.nx.toLowerCase().endsWith(u)||(h=70<h.length?'<span title="'+EscapeHtml(h)+'">'+EscapeHtml(h.substring(0,70))+"...</span>":EscapeHtml(h),p="",null!=g.s&&(p=getFileSizeStr(g.s)),m="",m=3!=g.t?'<div class=filelist file=999><span style=float:right title=""></span><span><div class=fileIcon'+g.t+' onclick=d3folderset("'+encodeURIComponentEx(g.nx)+'")></div>&nbsp;<a href=# style=cursor:pointer onclick=\'return d3folderset("'+encodeURIComponentEx(g.nx)+"\")'>"+h+"</a></span></div>":(h=h,'<div class=filelist file=3><input style=float:left name=fcx class=fcb type=checkbox onchange=d3setActions() value="'+g.nx+'">&nbsp;<span style=float:right>'+EscapeHtml(p)+"</span><span><div class=fileIcon"+g.t+"></div>"+h+"</span></div>"),g.t<3?t+=m:n+=m)}d3fileoptions.currentFolder&&QH(d3fileoptions.currentFolder,s),QH(d3fileoptions.files,t+n),QE(d3fileoptions.folderup,0<d3filetreelocation.length),d3fileoptions.func&&d3fileoptions.func()}}function d3folderset(e){return d3filetreelocation.push(decodeURIComponent(e)),d3updatefiles(),!1}function d3folderup(e){if(null==e)d3filetreelocation.pop();else for(;d3filetreelocation.length>e;)d3filetreelocation.pop();d3updatefiles()}function d3getFileSel(){for(var e=[],t=document.getElementsByName("fcx"),n=0;n<t.length;n++)t[n].checked&&e.push(t[n].value);return e}function d3setActions(){1==d3fileoptions.dialog?1==Q("d3uploadMode").value?QE("idx_dlgOkButton",0<Q("d3localFile").value.length):QE("idx_dlgOkButton",1==d3getFileSel().length):2==d3fileoptions.dialog&&QE("idx_dlgOkButton",1==d3getFileSel().length)}var reportCSV=null;function generateReportDialog(){if(!xxdialogMode){var e="",t="",n=JSON.parse(getstore("_ReportSettings","{}")),i={1:"远程会话",2:"用户流量使用",3:"用户登录"};for(o in 4294967295==userinfo.siteadmin&&(i[4]="Database Records"),i)e+="<option value="+o+(n.type==o?" selected":"")+">"+i[o]+"</option>";t=t+addHtmlValue("类型","<select id=d2reportType style=float:right;width:250px onchange=generateReportDialogValidate()>"+e+"</select>")+"<div id=d2GroupByDiv style=display:none>",e="";for(o in i={1:"用户",2:"设备",3:"天"})e+="<option value="+o+(n.groupBy==o?" selected":"")+">"+i[o]+"</option>";for(o in t=(t+=addHtmlValue("通过...分组","<select id=d2groupBy style=float:right;width:250px onchange=generateReportDialogValidate()>"+e+"</select>"))+"</div>"+"<div id=d2GroupByDiv2 style=display:none>",e="",i={1:"用户",3:"天"})e+="<option value="+o+(n.groupBy2==o?" selected":"")+">"+i[o]+"</option>";t=(t+=addHtmlValue("通过...分组","<select id=d2groupBy2 style=float:right;width:250px onchange=generateReportDialogValidate()>"+e+"</select>"))+"</div>"+"<div id=d2DeviceGroupDiv style=display:none>",e="<option value=0"+(0==n.devGroup?" selected":"")+">所有</option>";var o,s=getOrderedList(meshes,"name");for(o in s)e+="<option value="+encodeURIComponentEx(s[o]._id)+(n.devGroup==s[o]._id?" selected":"")+">"+EscapeHtml(s[o].name)+"</option>";for(o in t=(t+=addHtmlValue("设备组","<select onchange=generateReportDialogValidate() id=d2groupId style=float:right;width:250px>"+e+"</select>"))+"</div>"+"<div id=d2timeBackDiv style=display:none>",e="",null==n.timeRange&&(n.timeRange=1),i={1:"最后一天",7:"过去 7 天",30:"过去30天",0:"时间范围"})e+="<option value="+o+(n.timeRange==o?" selected":"")+">"+i[o]+"</option>";setDialogMode(2,"生成报告",3,generateReportDialogEx,t=(t=(t=(t=(t+=addHtmlValue("时间","<select id=d2timeRange style=float:right;width:250px onchange=generateReportDialogValidate()>"+e+"</select>"))+"</div>"+"<div id=d2timeRangeDiv style=display:none>")+addHtmlValue("时间范围",'<input id=d2timeRangeSelector style=float:right;width:250px class=flatpickr type="text" placeholder="选择日期和时间..." data-id="altinput">'))+"</div>"+"<div id=d2showTrafficDiv style=display:none>")+addHtmlValue("","<div style=width:250px><label><input type=checkbox id=d2showTraffic "+(n.showTraffic?"checked":"")+">显示流量</label><div>")+"</div>"),generateReportDialogValidate();t=new Date,t=(t.setDate(t.getDate()-7),flatpickr("#d2timeRangeSelector",{mode:"range",enableTime:!0,maxDate:new Date,defaultDate:[t,new Date],minuteIncrement:1}));xxdialogTag=t}}function generateReportDialogValidate(){QV("d2timeRangeDiv",0==Q("d2timeRange").value),QV("d2timeBackDiv",4!=Q("d2reportType").value),QV("d2GroupByDiv",1==Q("d2reportType").value),QV("d2GroupByDiv2",3==Q("d2reportType").value),QV("d2DeviceGroupDiv",1==Q("d2reportType").value),QV("d2showTrafficDiv",1==Q("d2reportType").value)}function generateReportDialogEx(e,t){var n,i=0==Q("d2timeRange").value?(n=Math.floor(t.selectedDates[1].getTime()/1e3),Math.floor(t.selectedDates[0].getTime()/1e3)):(n=Math.floor(new Date/1e3),i=new Date,Math.floor(i.setDate(i.getDate()-Q("d2timeRange").value)/1e3)),t=null;try{t=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(e){}var o=decodeURIComponent(Q("d2groupId").value),s=(0==o&&(o=null),putstore("_ReportSettings",JSON.stringify({type:parseInt(Q("d2reportType").value),groupBy:parseInt(Q("d2groupBy").value),groupBy2:parseInt(Q("d2groupBy2").value),timeRange:parseInt(Q("d2timeRange").value),devGroup:o,showTraffic:Q("d2showTraffic").checked})),parseInt(Q("d2groupBy").value));3==Q("d2reportType").value&&(s=parseInt(Q("d2groupBy2").value)),meshserver.send({action:"report",type:parseInt(Q("d2reportType").value),groupBy:s,start:i,end:n,tz:t,tf:(new Date).getTimezoneOffset(),l:getLang(),devGroup:o,showTraffic:Q("d2showTraffic").checked})}function renderReport(e){var t={time:"时间",device:"设备",session:"会话",user:"用户",devgroup:"设备组",guest:"来宾",length:"长度",bytesin:"字节输入",bytesout:"字节输出",os:"操作系统",ip:"IP地址",browser:"浏览器",msg:"消息",twofactor:"第二个因素"},n="<table style=width:100%>",i=null,o=[];if(0==Object.keys(e.groups).length)reportCSV=null,QV("p60downloadReportDiv",!1),n+="<tr><td style=text-align:center;padding-top:32px>报告未返回任何内容。</tr></td>";else{for(var s in reportCSV='"组"',n+="<tr>",e.columns){var a=null!=t[e.columns[s].title]?t[e.columns[s].title]:EscapeHtml(e.columns[s].title),r="";e.columns[s].align?r+=";text-align:"+EscapeHtml(e.columns[s].align):r+=";text-align:left",0!=s||"datetime"!=e.columns[s].format&&"time"!=e.columns[s].format||(r+=";width:1%"),n+="<th style="+r+">"+a+"</th>",reportCSV+=',"'+csvClean(a)+'"'}for(var s in n+="</tr>",reportCSV+="\r\n",e.groups)for(var l in n=(n+="<tr style=height:8px></tr>")+("<tr><td colspan="+e.columns.length+' style="border-bottom:1pt solid black"><b>'),0!=s&&(n+=renderReportFormat(s,e.groupFormat)),n+="</b></td></tr>",e.groups[s].entries){var d,c=e.groups[s].entries[l];for(d in n+="<tr>",reportCSV+=0!=s?'"'+csvClean(renderReportFormatCSV(s,e.groupFormat))+'"':'""',e.columns){var u,p,r="";null!=e.columns[d].format&&(r="white-space:nowrap;"),e.columns[d].align&&(r="text-align:"+EscapeHtml(e.columns[d].align)),null!=c[e.columns[d].id]?(n+='<td style="'+r+'">'+renderReportFormat(c[e.columns[d].id],e.columns[d].format)+"</td>",reportCSV+=',"'+csvClean(renderReportFormatCSV(c[e.columns[d].id],e.columns[d].format))+'"'):(n+="<td></td>",reportCSV+=","),null!=e.columns[d].sumBy&&(u=c[e.columns[d].sumBy],!0===e.columns[d].sumBy&&(u=!0),p=c[e.columns[d].id],i=e.columns[d].sumBy,null!=p)&&(-1==o.indexOf(u)&&o.push(u),null==e.columns[d].subtotals&&(e.columns[d].subtotals={},e.columns[d].totals={}),null==e.columns[d].subtotals[u]?e.columns[d].subtotals[u]=p:e.columns[d].subtotals[u]+=p,null==e.columns[d].totals[u]?e.columns[d].totals[u]=p:e.columns[d].totals[u]+=p)}n+="</tr>",reportCSV+="\r\n"}if(null!=i){var m=-1;if(!0===i)m=99999;else for(var s in e.columns)e.columns[s].id==i&&(m=s);if(0<=m){o.sort();var g=!0;for(l in n+="<tr style=height:8px></tr>",o){for(var s in n+="<tr>",e.columns)s==m?(r="",e.columns[d].align&&(r+=";text-align:"+EscapeHtml(e.columns[d].align)),g&&(r+=";border-top:1pt solid #777"),n+='<td style="color:#777'+r+'">'+renderReportFormat(o[l],e.columns[s].format)):null!=e.columns[s].totals?(r="",e.columns[d].align&&(r+=";text-align:"+EscapeHtml(e.columns[d].align)),g&&(r+=";border-top:1pt solid #777"),n+='<td style="color:#777'+r+'">'+renderReportFormat(e.columns[s].totals[o[l]],e.columns[s].format)):n+="<td></td>";n+="</tr>",g=!1}}}QV("p60downloadReportDiv",!0)}n+="</table>",QH("p60report",n)}function renderReportFormat(e,t){if(null==e)return"";if("datetime"==t)return printDateTime(new Date(e));if("time"==t)return printTime(new Date(e));if("protocol"==t)return 1==e?"终端":2==e?"桌面":5==e?"档案":100==e?"AMT-WSMAN":101==e?"AMT-Redir":200==e?"信使":201==e?"网络RDP":202==e?"网络SSH":203==e?"网络SFTP":204==e?"网络VNC":"未知 ("+e+")";if("seconds"==t)return a=e%60,s=60&Math.floor(e/60),o=Math.floor(e/3600),zeroPad(o,2)+":"+zeroPad(s,2)+":"+zeroPad(a,2);if("node"==t)return null!=(i=getNodeFromId(e))?"<div onclick='gotoDevice(\""+i._id+'",10);haltEvent(event);\' style=float:left;margin-right:4px class="j'+i.icon+'"></div>'+EscapeHtml(i.name):"<i>未知</i>";if("mesh"==t)return null!=(n=meshes[e])?"<div onclick='gotoMesh(\""+n._id+'",10);haltEvent(event);\' style=float:left;margin-right:4px;cursor:pointer class="m99"></div>'+EscapeHtml(n.name):"<i>未知</i>";if("nodemesh"==t){var n,i,o=null,s=null,a=e.split("/"),r="<table><tr>";if(3<=a.length&&(o=a[0]+"/"+a[1]+"/"+a[2]),null!=(s=6<=a.length?a[3]+"/"+a[4]+"/"+a[5]:s)){if(null==(n=meshes[s]))return"<i>未知</i>";r+="<td><div onclick='gotoMesh(\""+n._id+'",10);haltEvent(event);\' style=float:left;margin-right:4px;cursor:pointer class="m99"></div>'+EscapeHtml(n.name)+"&nbsp;&nbsp;&nbsp;</td>"}return null==(i=getNodeFromId(o))?"<i>未知</i>":r=r+("<td><div onclick='gotoDevice(\""+i._id+'",10);haltEvent(event);\' style=float:left;margin-right:4px class="j'+i.icon+'"></div>'+EscapeHtml(i.name)+"</td>")+"</tr></table>"}if("user"==t)return a=null,e==userinfo._id?a=userinfo:null!=users&&(a=users[e]),null!=a?(s=a.name,null!=a.realname&&(s+=", "+a.realname),"<div onclick='gotoUser(\""+a._id+'",10);haltEvent(event);\' style=float:left;margin-right:4px;cursor:pointer class="m2"></div>'+EscapeHtml(s)):"<i>未知用户</i>";if("msg"==t){if(107==e)return'<div style=float:left;margin-right:4px;cursor:pointer class="NotifyIconTiny1"></div>成功登录';if(108==e)return'<div style=float:left;margin-right:4px;cursor:pointer class="NotifyIconTiny2"></div>第二个因素不正确';if(109==e)return'<div style=float:left;margin-right:4px;cursor:pointer class="NotifyIconTiny4"></div>被锁定账户';if(110==e)return'<div style=float:left;margin-right:4px;cursor:pointer class="NotifyIconTiny3"></div>无效的登录尝试'}if("2fa"==t){if(""==e)return"没有";if("backup"==e)return"备用码";if("fido"==e)return"FIDO 密钥";if("sms"==e)return"短信";if("hwotp"==e)return"硬件一次性密码";if("messenger"==e)return"Messenging";if("push"==e)return"推送通知";if("otp"==e)return"一次性密码";if("cookie"==e)return"记住设备";if("tokenlogin"==e)return"登录令牌";if("ipaddr"==e)return"IP地址";if("sso"==e)return"单点登录"}return"records"==t?null!=(n={node:"Device record",mesh:"Device group record",user:"User records",sysinfo:"Device information records",iploc:"IP location information records",note:"Text notes records",ifinfo:"Network interface information records",cfile:"Configuration file records",lastconnect:"Last connection time records",power:"Device power transition records",events:"Event records",serverstats:"Server statistics records",ugrp:"User group records",deviceshare:"Device sharing records",logintoken:"Account login token records",smbios:"Device SMBIOS record",pmt:"Device Push Notification Record",meshcentral:"Device, users, groups and other records"})[e]?n[e]:e:EscapeHtml(e)}function renderReportFormatCSV(e,t){if("datetime"==t)return printDateTime(new Date(e));if("time"==t)return printTime(new Date(e));if("protocol"==t)return 1==e?"终端":2==e?"桌面":5==e?"档案":"未知";if("node"==t){var n=getNodeFromId(e);if(null!=n)return n.name}if("mesh"==t){n=meshes[e];if(null!=n)return n.name}var i;if("user"==t)return n=null,e==userinfo._id?n=userinfo:null!=users&&(n=users[e]),null!=n?(i=n.name,null!=n.realname&&(i+=" - "+n.realname),i):"未知用户";if("msg"==t){if(107==e)return"成功登录";if(108==e)return"第二个因素不正确";if(109==e)return"被锁定账户";if(110==e)return"无效的登录尝试"}return"records"==t?renderReportFormat(e,t):""+e}function p60downloadReport(){xxdialogMode||null==reportCSV||saveAs(stringToUtf8Blob(reportCSV),"报告.csv")}var notifications=[];function clickNotificationIcon(e){1==e?QV("notifiyBox",!0):0==e?QV("notifiyBox",!1):QV("notifiyBox","none"==QS("notifiyBox").display),drawNotifications()}function setNotificationCount(e){parseInt(Q("notificationCount").innerHTML)!=e&&(QH("notificationCount",e),QS("notificationCount")["background-color"]=0==e?"lightblue":"orange",QV("notificationCount",0<e))}function drawNotifications(){var e=getstore("notifications",0),t="";if(0==notifications.length)t="<div style=margin:5px>目前没有任何通知</div>";else for(var n in notifications){var i,n=notifications[n],o="",s=new Date(n.time),a=0;null!=n.title&&(o="<b>"+EscapeHtml(n.title)+"</b>: "),null!=n.nodeid&&null!=(i=getNodeFromId(n.nodeid))&&(a=i.icon,o=16&e?"<b>"+EscapeHtml(meshes[i.meshid].name)+" / "+EscapeHtml(i.name)+"</b>: ":"<b>"+EscapeHtml(i.name)+"</b>: "),t+='<div title="'+format("发生在{0}",printDateTime(s))+'" id="notifyx'+n.id+'" class=notification style="cursor:pointer;border-top:1px solid '+(""==t?"transparent":"orange")+'">',a&&(t+="<div class=j"+a+' onclick="notificationSelected('+n.id+')" style=margin:5px;float:left></div>'),t+='<div onclick="notificationDelete('+n.id+')" class=unselectable title="清除此通知" style=margin:5px;float:right;color:orange><b>X</b></div><div onclick="notificationSelected('+n.id+')" style=margin:5px>'+o+EscapeHtml(n.text)+"</div><div style=margin-left:5px;margin-bottom:5px;color:gray;font-size:10px>"+printDateTime(s)+"</div></div>"}var r="";1<notifications.length&&(r='<div id="notifyRemoveAll" onclick="deleteAllNotifications()" style="cursor:pointer;border-top:1px solid orange;margin:5px;color:orange;text-align:right;padding-right:3px">全部清除</div>'),QH("notifiyBox",'<div class=customScroll style="max-height:170px;overflow-y:auto;margin:5px">'+t+r+"</div>")}function notificationSelected(e,t){var n,i=-1;for(n in notifications)notifications[n].id==e&&(i=n);-1!=i&&(notificationSelectedEx(notifications[i],e),t)&&notifications[i]&&(notifications[i].notification&&(notifications[i].notification.close(),delete notifications[i].notification),notificationDelete(e))}function notificationSelectedEx(e,t){null!=e.nodeid?"desktop"==e.tag?gotoDevice(e.nodeid,12):"terminal"==e.tag?gotoDevice(e.nodeid,11):"files"==e.tag?gotoDevice(e.nodeid,13):"intelamt"==e.tag?gotoDevice(e.nodeid,14):"console"==e.tag?gotoDevice(e.nodeid,15):gotoDevice(e.nodeid,10):"backupcodes"!=e.tag||xxdialogMode?null!=e.tag&&e.tag.startsWith("meshmessenger/")?(safeNewWindow("/messenger?id="+e.tag+"&title="+encodeURIComponentEx(e.username),e.tag.split("/")[2]),notificationDelete(t)):null!=e.url&&(safeNewWindow(e.url),notificationDelete(t)):(go(2),account_manageOtp(0),notificationDelete(t))}function notificationDelete(e){var t=-1,n=Q("notifyx"+e);if(null!=n){for(var i in notifications)notifications[i].id==e&&(t=i);-1!=t&&(meshserver.send({action:"intersession",subaction:"removeNotify",id:e}),notifications[t].notification&&(notifications[t].notification.close(),delete notifications[t].notification),notifications.splice(t,1),n.parentNode.removeChild(n),setNotificationCount(notifications.length),0==notifications.length&&QV("notifiyBox",!1),1==notifications.length&&QV("notifyRemoveAll",!1),0<notifications.length)&&0==t&&(n=notifications[0],QS("notifyx"+n.id)["border-top"]="1px solid transparent")}}function addNotification(e){if("number"==typeof e.titleid)try{e.title=[null,"新账户","服务器限制","安全警告","帐号设定","设备组","邀请码"][e.titleid]}catch(e){}if("number"==typeof e.msgid)try{e.text=[null,"没有权限","无效的用户名","无效的密码","不合规电邮","无效域","网站权限无效","用户已存在","无法在此模式下添加用户","验证异常","达到帐户限制。","聊天请求，点击这里接受。","自上次登录以来，此帐户已有 {0} 次登录尝试失败。","无法更改电子邮件地址，另一个帐户已在使用：{0}。","邮件已发送。","未找到用户 {0}。","未找到用户 {0}。","错误，无法更改为以前使用的密码。","错误，无法更改为常用密码。","错误，密码未更改。","密码已更改。","当前密码不正确。",'错误，邀请码 "{0}" 已被使用。',"短信网关未启用","无用户管理权限","无效的短信","此用户没有电话号码","SMS succesfully sent.","短信错误","短信错误：{0}",'不允许使用电子邮件域 "{0}"。只允许 ({1})',"Invalid message","Message succesfully sent.","Message error","Message error: {0}"][e.msgid],Array.isArray(e.args)&&(e.text=format(e.text,e.args[0],e.args[1],e.args[2],e.args[3],e.args[4],e.args[5]))}catch(e){}null==e.time&&(e.time=Date.now()),null==e.id&&(e.id=Math.random()),notifications.unshift(e),setNotificationCount(notifications.length),clickNotificationIcon(!0);var t,n,i=getstore("notifications",0),o=(1&i&&Q("chimes").play(),null);Notification&&"granted"==Notification.permission&&(t=e.text.split("&reg;").join("").split("<b>").join("").split("</b>").join("").split("<br />").join("\r\n"),e.nodeid?(n=getNodeFromId(e.nodeid))&&(o=16&i?new Notification(decodeURIComponent("{{{extitle}}}")+" - "+meshes[n.meshid].name+" - "+n.name,{tag:e.tag,body:t,icon:"/images/notify/icons128-"+n.icon+".png"}):new Notification(decodeURIComponent("{{{extitle}}}")+" - "+n.name,{tag:e.tag,body:t,icon:"/images/notify/icons128-"+n.icon+".png"})):(null==e.icon&&(e.icon=0),i=null==(i=e.title)?"":" - "+e.title,o=new Notification(decodeURIComponent("{{{extitle}}}")+i,{tag:e.tag,body:t,icon:"/images/notify/icons128-"+e.icon+".png"})),o.id=e.id,o.xtag=e.tag,o.url=e.url,o.nodeid=e.nodeid,o.username=e.username,o.onclick=function(e){notificationSelected(e.target.id,!0)},e.notification=o),"number"==typeof e.maxtime&&0<e.maxtime&&((n=function e(){notificationDelete(e.xid)}).xid=e.id,setTimeout(n,1e3*e.maxtime))}function deleteAllNotifications(){notifications=[],setNotificationCount(0),drawNotifications(),QV("notifiyBox",!1)}function setupGeneralServerStats(){window.serverStatCpu=new Chart(document.getElementById("serverCpuChart").getContext("2d"),{type:"doughnut",data:{datasets:[{data:[0,0],backgroundColor:["#AAAAAA","#00AA00"]}],labels:["用过的","自由"]},options:{events:[],responsive:!0,plugins:{legend:{display:!1}},animation:{animateScale:!0,animateRotate:!0},width:"40px"}}),window.serverStatMemory=new Chart(document.getElementById("serverMemoryChart").getContext("2d"),{type:"doughnut",data:{datasets:[{data:[0,0],backgroundColor:["#AAAAAA","#00AA00"]}],labels:["用过的","自由"]},options:{events:[],responsive:!0,plugins:{legend:{display:!1}},animation:{animateScale:!0,animateRotate:!0},width:"40px"}})}var lastServerStats=null;function updateGeneralServerStats(e){if(null!=e?lastServerStats=e:e=lastServerStats,null!=e){var t,n={ServerState:"服务器状态",AgentErrorCounters:"代理错误计数器",UnknownGroup:"未知群组",InvalidPKCSsignature:"无效的PKCS签名",InvalidRSAsignature:"無效的RSA密碼",InvalidJSON:"无效的JSON",UnknownAction:"未知动作",BadWebCertificate:"错误的网络证书",BadSignature:"错误的签名",MaxSessionsReached:"达到连接数量上限",UnknownDeviceGroup:"未知设备组",InvalidDeviceGroupType:"无效的设备组类型",DuplicateAgent:"代理重复",ConnectedIntelAMT:"已连接的英特尔&reg;AMT",RelayErrors:"中继错误",UserAccounts:"用户帐户",DeviceGroups:"设备组",AgentSessions:"代理会话",ConnectedUsers:"已连接的用户",UsersSessions:"用户会话",RelaySessions:"中继连接",RelayCount:"中继数量"},i=("object"==typeof e.cpuavg&&(t=Math.min(e.cpuavg[0],1),window.serverStatCpu.config.data.datasets[0].data=[t,1-t],QH("serverCpuChartText",'<div style=margin-bottom:5px>CPU负载</div><div><b title="最近一分钟的CPU负载">'+Math.round(100*e.cpuavg[0])/100+'</b>, <b title="最近5分钟的CPU负载">'+Math.round(100*e.cpuavg[1])/100+'</b>, <b title="最近15分钟的CPU负载">'+Math.round(100*e.cpuavg[2])/100+"</b></div>"),QS("serverCpuChartView").display="inline-block",window.serverStatCpu.update()),"number"==typeof e.totalmem&&"number"==typeof e.availablemem?(window.serverStatMemory.config.data.datasets[0].data=[e.totalmem-e.availablemem,e.availablemem],QH("serverMemoryChartText","<div style=margin-bottom:5px>可用內存</div><div><b>"+getNiceSize3(e.availablemem)+"</b> 空闲, <b>"+getNiceSize3(e.totalmem)+"</b> 总计</div>"),QS("serverMemoryChartView").display="inline-block",window.serverStatMemory.update()):"number"==typeof e.totalmem&&"number"==typeof e.freemem&&(window.serverStatMemory.config.data.datasets[0].data=[e.totalmem-e.freemem,e.freemem],QH("serverMemoryChartText","<div style=margin-bottom:5px>内存</div><div><b>"+getNiceSize3(e.freemem)+"</b> 空闲, <b>"+getNiceSize3(e.totalmem)+"</b> 总计</div>"),QS("serverMemoryChartView").display="inline-block",window.serverStatMemory.update()),"<div style=width:100% cellpadding=0 cellspacing=0>");if("object"==typeof e.values)for(var o in e.values)for(var s in i+="<div class=userTableHeader style=margin-bottom:4px;width:200px>"+(n[o]||o)+"</div>",e.values[o])i+="<div style=display:inline-block><table class=serverStateTableCell><tr><td class=h1></td><td><span>"+(n[s]||s)+"</span><span style=float:right>"+e.values[o][s]+"</span></td><td class=h2></td></tr></table></div>";i+="</div>",QH("serverStatsTable",i)}}var serverTimelineStats=null,serverTimelineConfig={type:"line",data:{labels:[],datasets:[{label:"",backgroundColor:"rgba(255, 99, 132, .5)",borderColor:"rgb(255, 99, 132)",data:[],fill:!0}]},options:{animation:!1,responsive:!0,maintainAspectRatio:!1,elements:{line:{cubicInterpolationMode:"monotone"}},scales:{x:{type:"time",time:{tooltipFormat:"ll HH:mm"},display:!0,title:{display:!1,text:""}},y:{type:"linear",display:!0,title:{display:!0,text:""},stacked:!0}}}};function refreshServerTimelineStats(e){null!=meshserver&&2==meshserver.State&&meshserver.send({action:"servertimelinestats",hours:720})}function pastDate(e){var t=new Date;return t.setTime(t.getTime()-36e5*e),t}function setServerTimelineStats(e){serverTimelineStats=e,updateServerTimelineStats()}function addServerTimelineStats(e){var t;null!=serverTimelineStats&&((t=null)!=Q("p40server").value&&""==(t=decodeURIComponent(Q("p40server").value))&&(t=null),e.s==t)&&(serverTimelineStats.push(e),0==(t=Q("p40type").value)?(serverTimelineConfig.data.datasets[0].data.push({x:e.time,y:e.conn.ca}),serverTimelineConfig.data.datasets[1].data.push({x:e.time,y:e.conn.cu}),serverTimelineConfig.data.datasets[2].data.push({x:e.time,y:e.conn.us}),serverTimelineConfig.data.datasets[3].data.push({x:e.time,y:e.conn.rs}),null!=e.conn.am&&serverTimelineConfig.data.datasets[4].data.push({x:e.time,y:e.conn.am})):1==t?(serverTimelineConfig.data.datasets[0].data.push({x:e.time,y:e.mem.external/1048576}),serverTimelineConfig.data.datasets[1].data.push({x:e.time,y:e.mem.heapUsed/1048576}),serverTimelineConfig.data.datasets[2].data.push({x:e.time,y:e.mem.heapTotal/1048576}),serverTimelineConfig.data.datasets[3].data.push({x:e.time,y:e.mem.rss/1048576})):3==t||4==t?updateServerTimelineStats():5==t&&"object"==typeof e.cpu&&"number"==typeof e.cpu[0]&&serverTimelineConfig.data.datasets[0].data.push({x:e.time,y:e.cpu[0]}),updateServerTimelineHours())}function updateServerTimelineHours(){serverTimelineConfig.options.scales.y.type=Q("p40log").checked?"logarithmic":"linear",serverTimelineConfig.options.scales.x.min=pastDate(Q("p40time").value),window.serverMainStats.update()}function setupServerTimelineStats(){window.serverMainStats=new Chart(document.getElementById("serverMainStats").getContext("2d"),serverTimelineConfig)}let trafficSeriesNames=["代理","CIRA","操作系统","HTTP","中继","终端","桌面","档案","网络RDP","网络SSH","网络VNC","桌面复用"],seriesColors=[[158,151,16],[16,84,158],[255,99,132],[39,158,16],[134,16,158],[0,148,255],[255,216,0],[255,127,237],[109,213,255],[89,94,255],[179,104,255],[179,104,255]];function seriesColor1(e){return"rgba("+(seriesColors[e][0]+(255-seriesColors[e][0])/1.5)+","+(seriesColors[e][1]+(255-seriesColors[e][1])/1.5)+","+(seriesColors[e][2]+(255-seriesColors[e][2])/1.5)+")"}function seriesColor2(e){return"rgba("+seriesColors[e][0]+","+seriesColors[e][1]+","+seriesColors[e][2]+")"}function updateServerTimelineStats(){if(null!=serverTimelineStats){var e=Q("p40type").value,t=pastDate(Q("p40time").value),n=[],i=null,o=!1,s=!0;if(null!=Q("p40server").value&&(""==(i=decodeURIComponent(Q("p40server").value))&&(i=null),s=!1),serverTimelineConfig.options.scales.x.min=t,serverTimelineConfig.options.scales.y.stacked=3==e||4==e,0==e){serverTimelineConfig.options.scales.y.title.text="连接数量";for(var a={labels:[pastDate(0),t],datasets:[{label:"代理",data:[],backgroundColor:"rgba(158, 151, 16, .1)",borderColor:"rgb(158, 151, 16)",fill:!0},{label:"用户",data:[],backgroundColor:"rgba(16, 84, 158, .1)",borderColor:"rgb(16, 84, 158)",fill:!0},{label:"用户会话",data:[],backgroundColor:"rgba(255, 99, 132, .1)",borderColor:"rgb(255, 99, 132)",fill:!0},{label:"中继连接",data:[],backgroundColor:"rgba(39, 158, 16, .1)",borderColor:"rgb(39, 158, 16)",fill:!0},{label:"英特尔AMT",data:[],backgroundColor:"rgba(134, 16, 158, .1)",borderColor:"rgb(134, 16, 158)",fill:!0}]},r=0;r<serverTimelineStats.length;r++){new Date(serverTimelineStats[r].time);null!=serverTimelineStats[r].s&&-1==n.indexOf(serverTimelineStats[r].s)&&(n.push(serverTimelineStats[r].s),s)&&(i=serverTimelineStats[r].s,s=!1),null==serverTimelineStats[r].s&&(o=!0),serverTimelineStats[r].s==i&&(1==serverTimelineStats[r].first&&(a.datasets[0].data.push({x:serverTimelineStats[r].time-1,y:NaN}),a.datasets[1].data.push({x:serverTimelineStats[r].time-1,y:NaN}),a.datasets[2].data.push({x:serverTimelineStats[r].time-1,y:NaN}),a.datasets[3].data.push({x:serverTimelineStats[r].time-1,y:NaN}),a.datasets[4].data.push({x:serverTimelineStats[r].time-1,y:NaN})),serverTimelineStats[r].conn&&(a.datasets[0].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].conn.ca}),a.datasets[1].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].conn.cu}),a.datasets[2].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].conn.us}),a.datasets[3].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].conn.rs}),null!=serverTimelineStats[r].conn.am))&&a.datasets[4].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].conn.am})}}else if(1==e){serverTimelineConfig.options.scales.y.title.text="Megabyte",a={labels:[pastDate(0),t],datasets:[{label:"外部",data:[],backgroundColor:"rgba(158, 151, 16, .1)",borderColor:"rgb(158, 151, 16)",fill:!0},{label:"堆使用",data:[],backgroundColor:"rgba(16, 84, 158, .1)",borderColor:"rgb(16, 84, 158)",fill:!0},{label:"堆总数",data:[],backgroundColor:"rgba(255, 99, 132, .1)",borderColor:"rgb(255, 99, 132)",fill:!0},{label:"RSS",data:[],backgroundColor:"rgba(39, 158, 16, .1)",borderColor:"rgb(39, 158, 16)",fill:!0}]};for(r=0;r<serverTimelineStats.length;r++)null!=serverTimelineStats[r].s&&-1==n.indexOf(serverTimelineStats[r].s)&&(n.push(serverTimelineStats[r].s),s)&&(i=serverTimelineStats[r].s,s=!1),null==serverTimelineStats[r].s&&(o=!0),serverTimelineStats[r].s==i&&(1==serverTimelineStats[r].first&&(a.datasets[0].data.push({x:serverTimelineStats[r].time-1,y:NaN}),a.datasets[1].data.push({x:serverTimelineStats[r].time-1,y:NaN}),a.datasets[2].data.push({x:serverTimelineStats[r].time-1,y:NaN}),a.datasets[3].data.push({x:serverTimelineStats[r].time-1,y:NaN})),a.datasets[0].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].mem.external/1048576}),a.datasets[1].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].mem.heapUsed/1048576}),a.datasets[2].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].mem.heapTotal/1048576}),a.datasets[3].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].mem.rss/1048576}))}else if(3==e||4==e){serverTimelineConfig.options.scales.y.title.text="Megabyte",a={labels:[pastDate(0),t],datasets:[]};for(var l=0,r=0;r<serverTimelineStats.length;r++)null!=serverTimelineStats[r].traffic&&(null!=serverTimelineStats[r].s&&-1==n.indexOf(serverTimelineStats[r].s)&&(n.push(serverTimelineStats[r].s),s)&&(i=serverTimelineStats[r].s,s=!1),null==serverTimelineStats[r].s&&(o=!0),serverTimelineStats[r].s==i)&&serverTimelineStats[r].traffic&&(0<serverTimelineStats[r].traffic.AgentCtrlIn&&(l|=1),0<serverTimelineStats[r].traffic.CIRAIn&&(l|=2),0<serverTimelineStats[r].traffic.LMSIn&&(l|=4),0<serverTimelineStats[r].traffic.httpIn&&(l|=8),serverTimelineStats[r].traffic.relayIn&&(0<serverTimelineStats[r].traffic.relayIn[0]&&(l|=16),0<serverTimelineStats[r].traffic.relayIn[1]&&(l|=32),0<serverTimelineStats[r].traffic.relayIn[2]&&(l|=64),0<serverTimelineStats[r].traffic.relayIn[5]&&(l|=128),0<serverTimelineStats[r].traffic.relayIn[10]&&(l|=256),0<serverTimelineStats[r].traffic.relayIn[11]&&(l|=512),0<serverTimelineStats[r].traffic.relayIn[12])&&(l|=1024),serverTimelineStats[r].traffic.desktopMultiplex)&&0<serverTimelineStats[r].traffic.desktopMultiplex.in&&(l|=2048);for(r=0;r<13;r++)l&1<<r&&a.datasets.push({label:trafficSeriesNames[r],data:[],backgroundColor:seriesColor1(r),borderColor:seriesColor2(r),fill:!0,steppedLine:!0});for(r=0;r<serverTimelineStats.length;r++)if(null!=serverTimelineStats[r].traffic&&(null!=serverTimelineStats[r].s&&-1==n.indexOf(serverTimelineStats[r].s)&&(n.push(serverTimelineStats[r].s),s)&&(i=serverTimelineStats[r].s,s=!1),null==serverTimelineStats[r].s&&(o=!0),serverTimelineStats[r].s==i)){if(1==serverTimelineStats[r].first)for(var d=1;d<61440;d<<=1)l&d&&a.datasets[0].data.push({x:serverTimelineStats[r].time-1,y:NaN});var c=0;3==e?(1&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.AgentCtrlIn?serverTimelineStats[r].traffic.AgentCtrlIn/1048576:0}),2&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.CIRAIn?serverTimelineStats[r].traffic.CIRAIn/1048576:0}),4&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.LMSIn?serverTimelineStats[r].traffic.LMSIn/1048576:0}),8&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.httpIn?serverTimelineStats[r].traffic.httpIn/1048576:0}),16&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayIn&&serverTimelineStats[r].traffic.relayIn[0]?serverTimelineStats[r].traffic.relayIn[0]/1048576:0}),32&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayIn&&serverTimelineStats[r].traffic.relayIn[1]?serverTimelineStats[r].traffic.relayIn[1]/1048576:0}),64&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayIn&&serverTimelineStats[r].traffic.relayIn[2]?serverTimelineStats[r].traffic.relayIn[2]/1048576:0}),128&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayIn&&serverTimelineStats[r].traffic.relayIn[5]?serverTimelineStats[r].traffic.relayIn[5]/1048576:0}),256&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayIn&&serverTimelineStats[r].traffic.relayIn[10]?serverTimelineStats[r].traffic.relayIn[10]/1048576:0}),512&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayIn&&serverTimelineStats[r].traffic.relayIn[11]?serverTimelineStats[r].traffic.relayIn[11]/1048576:0}),1024&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayIn&&serverTimelineStats[r].traffic.relayIn[12]?serverTimelineStats[r].traffic.relayIn[12]/1048576:0}),2048&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.desktopMultiplex&&serverTimelineStats[r].traffic.desktopMultiplex.in?serverTimelineStats[r].traffic.desktopMultiplex.in/1048576:0})):4==e&&(1&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.AgentCtrlOut?serverTimelineStats[r].traffic.AgentCtrlOut/1048576:0}),2&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.CIRAOut?serverTimelineStats[r].traffic.CIRAOut/1048576:0}),4&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.LMSOut?serverTimelineStats[r].traffic.LMSOut/1048576:0}),8&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.httpOut?serverTimelineStats[r].traffic.httpOut/1048576:0}),16&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayOut&&serverTimelineStats[r].traffic.relayOut[0]?serverTimelineStats[r].traffic.relayOut[0]/1048576:0}),32&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayOut&&serverTimelineStats[r].traffic.relayOut[1]?serverTimelineStats[r].traffic.relayOut[1]/1048576:0}),64&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayOut&&serverTimelineStats[r].traffic.relayOut[2]?serverTimelineStats[r].traffic.relayOut[2]/1048576:0}),128&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayOut&&serverTimelineStats[r].traffic.relayOut[5]?serverTimelineStats[r].traffic.relayOut[5]/1048576:0}),256&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayOut&&serverTimelineStats[r].traffic.relayOut[10]?serverTimelineStats[r].traffic.relayOut[10]/1048576:0}),512&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayOut&&serverTimelineStats[r].traffic.relayOut[11]?serverTimelineStats[r].traffic.relayOut[11]/1048576:0}),1024&l&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayOut&&serverTimelineStats[r].traffic.relayOut[12]?serverTimelineStats[r].traffic.relayOut[12]/1048576:0}),2048&l)&&a.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.desktopMultiplex&&serverTimelineStats[r].traffic.desktopMultiplex.out?serverTimelineStats[r].traffic.desktopMultiplex.out/1048576:0})}}else if(5==e){serverTimelineConfig.options.scales.y.title.text="用法",a={labels:[pastDate(0),t],datasets:[{label:"CPU",data:[],backgroundColor:"rgba(158, 151, 16, .1)",borderColor:"rgb(158, 151, 16)",fill:!0}]};for(r=0;r<serverTimelineStats.length;r++)"object"==typeof serverTimelineStats[r].cpu&&"number"==typeof serverTimelineStats[r].cpu[0]&&(null!=serverTimelineStats[r].s&&-1==n.indexOf(serverTimelineStats[r].s)&&(n.push(serverTimelineStats[r].s),s)&&(i=serverTimelineStats[r].s,s=!1),null==serverTimelineStats[r].s&&(o=!0),serverTimelineStats[r].s==i)&&(1==serverTimelineStats[r].first&&a.datasets[0].data.push({x:serverTimelineStats[r].time-1,y:NaN}),a.datasets[0].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].cpu[0]}))}if(serverTimelineConfig.data=a,window.serverMainStats.update(),0<n.length){for(var u="",r=0;r<n.length;r++)u+='<option value="'+encodeURIComponentEx(n[r])+'"'+(i==n[r]?" selected":"")+">"+EscapeHtml(n[r])+"</option>";o&&(u+='<option value=""'+(null==i?" selected":"")+">空值</option>"),QH("p40server",u)}QV("p40server",0<n.length)}}function p40downloadEvents(){for(var e="time, conn.agent, conn.users, conn.usersessions, conn.relaysession, conn.intelamt, mem.external, mem.heapused, mem.heaptotal, mem.rss\r\n",t=0;t<serverTimelineStats.length;t++)serverTimelineStats[t].conn&&serverTimelineStats[t].mem&&(e+=new Date(serverTimelineStats[t].time)+", "+serverTimelineStats[t].conn.ca+", "+serverTimelineStats[t].conn.cu+", "+serverTimelineStats[t].conn.us+", "+serverTimelineStats[t].conn.rs+", "+(serverTimelineStats[t].conn.am||"")+", "+serverTimelineStats[t].mem.external+", "+serverTimelineStats[t].mem.heapUsed+", "+serverTimelineStats[t].mem.heapTotal+", "+serverTimelineStats[t].mem.rss+"\r\n");saveAs(stringToUtf8Blob(e),"ServerStats.csv")}var xxdialogMode,xxdialogFunc,xxdialogButtons,xxdialogTag,serverTrace=[],serverTraceSources=[];function displayServerTrace(){var e,t="",n=parseInt(Q("p41limitdropdown").value);for(e in serverTrace.length>n&&serverTrace.splice(n),serverTrace){var i,o=[];for(i in serverTrace[e].args)"object"==typeof serverTrace[e].args[i]?o.push(JSON.stringify(serverTrace[e].args[i])):o.push(serverTrace[e].args[i]);t+="<div class=traceEvent onclick=showTraceEvent("+e+")>"+EscapeHtml(new Date(serverTrace[e].time).toLocaleTimeString())+" - <b>"+EscapeHtml(serverTrace[e].source.toUpperCase())+"</b>: "+EscapeHtml(o.join(", "))+"</div>"}QH("p41events",t)}function showTraceEvent(e){var t=serverTrace[e],n="";if(!xxdialogMode&&null!=t){for(var e in t.args)"object"==typeof t.args[e]?n+=EscapeHtml(JSON.stringify(t.args[e]))+"<br /><br />":n+=EscapeHtml(t.args[e])+"<br /><br />";setDialogMode(2,"服务器跟踪事件",1,null,"<div class=selecttext style=max-height:300px;overflow-y:auto>"+n+"</div>")}}function clearServerTracing(){serverTrace=[],displayServerTrace()}function setServerTracing(){var e='<div style="max-height:200px;overflow-y:auto">';setDialogMode(2,"服务器跟踪",7,setServerTracingEx,(e+='<div style="width:100%;border-bottom:1px solid gray;margin-bottom:5px;margin-top:5px"><b>核心服务器</b></div>')+("<div><label><input type=checkbox id=p41c1 "+(0<=serverTraceSources.indexOf("cookie")?"checked":"")+">Cookie编码器</label></div>")+("<div><label><input type=checkbox id=p41c2 "+(0<=serverTraceSources.indexOf("dispatch")?"checked":"")+">消息调度器</label></div>")+("<div><label><input type=checkbox id=p41c3 "+(0<=serverTraceSources.indexOf("main")?"checked":"")+">主服务器信息</label></div>")+("<div><label><input type=checkbox id=p41c4 "+(0<=serverTraceSources.indexOf("peer")?"checked":"")+">MeshCentral服务器同级化</label></div>")+("<div><label><input type=checkbox id=p41c15 "+(0<=serverTraceSources.indexOf("agent")?"checked":"")+">MeshAgent流量</label></div>")+("<div><label><input type=checkbox id=p41c14 "+(0<=serverTraceSources.indexOf("agentupdate")?"checked":"")+">MeshAgent更新</label></div>")+("<div><label><input type=checkbox id=p41c16 "+(0<=serverTraceSources.indexOf("cert")?"checked":"")+">服务器证书</label></div>")+("<div><label><input type=checkbox id=p41c17 "+(0<=serverTraceSources.indexOf("db")?"checked":"")+">服务器数据库</label></div>")+("<div><label><input type=checkbox id=p41c18 "+(0<=serverTraceSources.indexOf("email")?"checked":"")+">电子邮件/短信/推送流量</label></div>")+'<div style="width:100%;border-bottom:1px solid gray;margin-bottom:5px;margin-top:5px"><b>网络服务器</b></div>'+("<div><label><input type=checkbox id=p41c5 "+(0<=serverTraceSources.indexOf("web")?"checked":"")+">网络服务器</label></div>")+("<div><label><input type=checkbox id=p41c6 "+(0<=serverTraceSources.indexOf("webrequest")?"checked":"")+">Web服务器请求</label></div>")+("<div><label><input type=checkbox id=p41c7 "+(0<=serverTraceSources.indexOf("relay")?"checked":"")+">Web套接字中继</label></div>")+("<div><label><input type=checkbox id=p41c20 "+(0<=serverTraceSources.indexOf("httpheaders")?"checked":"")+">Web 服务器 HTTP 标头</label></div>")+("<div><label><input type=checkbox id=p41c21 "+(0<=serverTraceSources.indexOf("authlog")?"checked":"")+">User Authentication Log</label></div>")+'<div style="width:100%;border-bottom:1px solid gray;margin-bottom:5px;margin-top:5px"><b>英特尔&reg;AMT</b></div>'+("<div><label><input type=checkbox id=p41c19 "+(0<=serverTraceSources.indexOf("amt")?"checked":"")+">英特尔 AMT 经理</label></div>")+("<div><label><input type=checkbox id=p41c9 "+(0<=serverTraceSources.indexOf("webrelay")?"checked":"")+">连接转发器</label></div>")+("<div><label><input type=checkbox id=p41c10 "+(0<=serverTraceSources.indexOf("mps")?"checked":"")+">CIRA服务器</label></div>")+("<div><label><input type=checkbox id=p41c11 "+(0<=serverTraceSources.indexOf("mpscmd")?"checked":"")+">CIRA服务器命令</label></div>")+"</div>")}function setServerTracingEx(e){var t=[],n=["cookie","dispatch","main","peer","web","webrequest","relay","webrelaydata","webrelay","mps","mpscmd","swarm","swarmcmd","agentupdate","agent","cert","db","email","amt","httpheaders","authlog"];if(1==e)for(var i=1;i<22;i++)try{Q("p41c"+i).checked&&t.push(n[i-1])}catch(e){}meshserver.send({action:"traceinfo",traceSources:t})}function p41downloadServerTrace(){var e,t="时间，来源，信息\r\n";for(e in serverTrace)t+='"'+new Date(serverTrace[e].time).toLocaleTimeString()+'","'+serverTrace[e].source+'","'+serverTrace[e].args.join(", ")+'"\r\n';return saveAs(stringToUtf8Blob(t),"servertrace.csv"),!1}function setupServiceWorker(){0!=(8&features2)&&"string"==typeof serverinfo.vapidpublickey&&null!=Notification&&"granted"==Notification.permission&&"serviceWorker"in navigator&&navigator.serviceWorker.register("serviceworker.js").then(function(e){navigator.serviceWorker.ready.then(function(e){e.pushManager.subscribe({applicationServerKey:urlBase64ToUint8Array(serverinfo.vapidpublickey),userVisibleOnly:!0}).then(function(e){meshserver.send({action:"webpush",sub:e})}).catch(function(e){console.error("Worker: Unable to subscribe to push",e)})})}).catch(function(e){console.log("Worker: Registration failed",e)})}var xxcurrentView=-1;function setDialogMode(e,t,n,i,o,s){setSessionActivity(),QV("uiMenu",!1),xxdialogMode=e,xxdialogFunc=i,xxdialogButtons=n,xxdialogTag=s,QS("dialog").width=QS("dialog").top=QS("dialog").left=QS("dialog").right=QS("dialog").bottom=null,QE("idx_dlgOkButton",!0),QV("idx_dlgOkButton",1&n),QV("idx_dlgCancelButton",2&n),Q("idx_dlgCancelButton").value=2==n?"关":"取消",QV("id_dialogclose",2&n||8&n),QV("idx_dlgDeleteButton",4&n),QV("idx_dlgButtonBar",7&n),QV("idx_dlgMoreButtons",16&n),t&&QH("id_dialogtitle",t);for(var a=1;a<24;a++)QV("dialog"+a,a==e);QV("dialog",e),o&&(2==e?QH("id_dialogOptions",o):QH("id_dialogMessage",o)),MoreToggle(!1)}function dialogclose(e){setSessionActivity();var t=xxdialogFunc,n=xxdialogButtons,i=xxdialogTag;setDialogMode(),(8&n||e)&&t&&t(e,i)}function center(){setSessionActivity(),11==xxcurrentView?deskAdjust():10==xxcurrentView?mainUpdate(256):1==xxcurrentView&&mainUpdate(4)}function messagebox(e,t){setSessionActivity(),QH("id_dialogMessage",t),setDialogMode(1,e,1)}function statusbox(e,t){setSessionActivity(),QH("id_dialogMessage",t),setDialogMode(1,e)}function goBack(){setSessionActivity(),xxdialogMode||0==goBackStack.length||(fullscreen&&deskToggleFull(),go(goBackStack.pop()),goBackStack.pop())}function go(e,t){if((!t||3!=t.which&&2!=t.button)&&(262144&features&&0==count2factoraAuths()&&2<e&&setDialogMode(e=2,"账户安全",1,null,"在启用两因素身份验证之前，无法访问此功能。这是额外的安全性所必需的。转到“我的帐户”标签，然后查看“帐户安全性”部分。"),null!=pluginHandler&&pluginHandler.callHook("goPageStart",e,t),setSessionActivity(),!xxdialogMode))if(QV("uiMenu",!1),!t||1!=t.shiftKey&&2!=t.which&&1!=t.button||15==e||""!="{{{currentNode}}}".toLowerCase()){if(xxcurrentView!=e){xxcurrentView<0||e<10?goBackStack=[]:50!=xxcurrentView&&Math.floor(xxcurrentView/10)==Math.floor(e/10)||goBackStack.push(xxcurrentView),11==xxcurrentView&&null!=desktop&&null!=desktop.m.recordedData&&deskRecordSession(),(4==e&&null!=userinfo&&0==(2&userinfo.siteadmin)||0!=(4&features))&&(e=52),17==xxcurrentView&&deviceDetailsStatsClear();for(var n=0;n<61;n++)QV("p"+n,n==e);if(xxcurrentView=e,fullscreen&&deskToggleFull(),0==(268435456&features)&&0<xxcurrentView){var i="";for(n in 10<=xxcurrentView&&xxcurrentView<=19?null!=currentNode&&(i="?viewmode="+xxcurrentView+"&gotonode="+currentNode._id.split("/")[2]):20<=xxcurrentView&&xxcurrentView<=29?null!=currentMesh&&(i="?viewmode="+xxcurrentView+"&gotomesh="+currentMesh._id.split("/")[2]):30<=xxcurrentView&&xxcurrentView<=39?null!=currentUser&&(i="?viewmode="+xxcurrentView+"&gotouser="+(serverinfo.crossDomain?currentUser._id:currentUser._id.split("/")[2])):51<=xxcurrentView&&xxcurrentView<=51?null!=currentUserGroup&&null!=currentUserGroup._id&&(i="?viewmode="+xxcurrentView+"&gotougrp="+(serverinfo.crossDomain?currentUserGroup._id:currentUserGroup._id.split("/")[2])):1<xxcurrentView&&(i="?viewmode="+xxcurrentView),urlargs)i+=(""==i?"?":"&")+n+"="+urlargs[n];try{window.history.replaceState({},document.title,window.location.pathname+i)}catch(e){}}var o=["MainMenuMyDevices","MainMenuMyAccount","MainMenuMyEvents","MainMenuMyFiles","MainMenuMyUsers","MainMenuMyServer"];for(n in o)QC(o[n]).remove("fullselect"),QC(o[n]).remove("semiselect");var s=["LeftMenuMyDevices","LeftMenuMyAccount","LeftMenuMyEvents","LeftMenuMyFiles","LeftMenuMyUsers","LeftMenuMyServer"];for(n in s)QC(s[n]).remove("lbbuttonsel"),QC(s[n]).remove("lbbuttonsel2");var a=e<9?"fullselect":"semiselect",r=e<9||115==e||40==e||41==e||42==e?"lbbuttonsel2":"lbbuttonsel",l=0,d=(0<goBackStack.length&&(l=goBackStack[goBackStack.length-1]),1==e||1==l||0==l&&10<=e&&e<20?(QC("MainMenuMyDevices").add(a),QC("LeftMenuMyDevices").add(r)):2==e||2==l||0==l&&20<=e&&e<30?(QC("MainMenuMyAccount").add(a),QC("LeftMenuMyAccount").add(r)):3==e||60==e?(QC("MainMenuMyEvents").add(a),QC("LeftMenuMyEvents").add(r)):4==e||30<=e&&e<40||50==e||51==e||52==e?(QC("MainMenuMyUsers").add(a),QC("LeftMenuMyUsers").add(r)):5==e?(QC("MainMenuMyFiles").add(a),QC("LeftMenuMyFiles").add(r)):(6==e||115==e||40<=e&&e<50)&&(QC("MainMenuMyServer").add(a),QC("LeftMenuMyServer").add(r)),QV("ServerPlugins",null!=pluginHandler),webPageStackMenu&&10<=e?QC("column_l").add("room4submenu"):QC("column_l").remove("room4submenu"),QV("topbar",0!=e),0==e&&webPageFullScreen&&QC("body").add("arg_hide"),QV("MainSubMenuSpan",10<=e&&e<20),QV("UserDummyMenuSpan",51==e||e<10&&6!=e&&webPageFullScreen),QV("MeshSubMenuSpan",20<=e&&e<30),QV("UserSubMenuSpan",30<=e&&e<40),QV("ServerSubMenuSpan",6==e||115==e||40==e||41==e||42==e||43==e),QV("UsersSubMenuSpan",4==e||50==e||52==e),QV("EventsSubMenuSpan",3==e||60==e),{3:"EventsLive",4:"UsersGeneral",10:"MainDev",11:"MainDevDesktop",12:"MainDevTerminal",13:"MainDevFiles",14:"MainDevAmt",15:"MainDevConsole",16:"MainDevEvents",17:"MainDevInfo",19:"MainDevPlugins",20:"MeshGeneral",21:"MeshSummary",30:"UserGeneral",31:"UserEvents",6:"ServerGeneral",40:"ServerStats",41:"ServerTrace",42:"ServerPlugins",50:"UsersGroups",52:"UsersRecordings",60:"EventsReport",115:"ServerConsole"});for(n in d)QC(d[n]).remove("style3x"),QC(d[n]).remove("style3sel"),QC(d[n]).add(e==n?"style3sel":"style3x");11==e&&deskAdjust(),115==e&&QV("p15",!0),QV("p15uploadCore",115!=e),QV("p15BackButton",115!=e&&0==(32&args.hide)&&""=="{{currentNode}}".toLowerCase()),15!=e&&115!=e||setupConsole(),1==e&&mainUpdate(4),2==e&&Notification&&QV("accountEnableNotificationsSpan","granted"!=Notification.permission),40==e&&null==serverTimelineStats&&refreshServerTimelineStats(),42==e&&refreshPluginLatest(),21==e&&p21updateMesh(),52==e&&(null==p52recordings&&refreshRecodings(),updateRecordings()),12==e&&null!=xtermfit&&(xtermfit.fit(),xterm.focus()),document.title=currentNode&&10<=e&&e<20?currentNode.name+(meshes[currentNode.meshid]?" - "+meshes[currentNode.meshid].name:"")+" - "+decodeURIComponent("{{{extitle}}}"):decodeURIComponent("{{{extitle}}}"),null!=pluginHandler&&pluginHandler.callHook("goPageEnd",e,t),QS("column_l").overflow=0<=[11,12].indexOf(e)?"hidden":null}}else 10<=e&&e<=19?currentNode&&safeNewWindow(window.location.origin+"{{{domainurl}}}?gotonode="+currentNode._id.split("/")[2]+"&viewmode="+e+"&hide=16"+(urlargs.key?"&key="+urlargs.key:""),"meshcentral:"+currentNode._id):20<=e&&e<=29?currentMesh&&safeNewWindow(window.location.origin+"{{{domainurl}}}?gotomesh="+currentMesh._id.split("/")[2]+"&viewmode="+e+"&hide=16"+(urlargs.key?"&key="+urlargs.key:""),"meshcentral:"+currentMesh._id):30<=e&&e<=39?currentUser&&safeNewWindow(window.location.origin+"{{{domainurl}}}?gotouser="+(serverinfo.crossDomain?currentUser._id:currentUser._id.split("/")[2])+"&viewmode="+e+"&hide=16"+(urlargs.key?"&key="+urlargs.key:""),"meshcentral:"+currentUser._id):50<=e&&e<=59?currentUserGroup&&safeNewWindow(window.location.origin+"{{{domainurl}}}?gotougrp="+(serverinfo.crossDomain?currentUserGroup._id:currentUserGroup._id.split("/")[2])+"&viewmode="+e+"&hide=16"+(urlargs.key?"&key="+urlargs.key:""),"meshcentral:"+currentUserGroup._id):safeNewWindow(window.location.origin+"{{{domainurl}}}?viewmode="+e+"&hide=0"+(urlargs.key?"&key="+urlargs.key:""),"meshcentral:"+e)}function updatePluginList(e){if(null!=pluginHandler){if(Array.isArray(e)&&e.forEach(function(e){updatePluginList(e)}),QV("pluginNoneNotice",0==installedPluginList.length),installedPluginList.length){if(null!=e&&(null==installedPluginList.version_info&&(installedPluginList.version_info=[]),installedPluginList.version_info[e.id]=e),(n=Q("p42tbl").querySelectorAll(".p42tblRow")).length)for(var t in Object.values(n))n[t].parentNode.removeChild(n[t]);var a={0:{text:"Disabled",color:"858483"},1:{text:"Installed",color:"00aa00"}},r={0:{install:"Install",delete:"Delete"},1:{disable:"Disable",upgrade:"Upgrade"}},l=Q("p42tbl");installedPluginList.forEach(function(e){var t,n=[],i=(1==e.hasAdminPanel&&e.status?e.nameHtml="<a onclick=\"return goPlugin('"+e.shortName+"', '"+e.name.replace(/'/g,"\\'")+"');\">"+EscapeHtml(e.name)+"</a>":e.nameHtml=EscapeHtml(e.name),e.statusText=a[e.status].text,e.statusColor=a[e.status].color,null==e.versionHistoryUrl&&n.push("downgrade"),e.status||(e.version=" - "),e.upgradeAvail="检查...",null!=installedPluginList.version_info&&null!=installedPluginList.version_info[e._id]&&(!(o=installedPluginList.version_info[e._id]).hasUpdate&&(n.push("upgrade"),e.status)?e.upgradeAvail="最新":e.upgradeAvail='<a title="查看变更日志" rel="noreferrer noopener" target="_blank" href="'+o.changelogUrl+'">'+o.version+"</a>",o.meshCentralCompat||(e.upgradeAvail+=' [ <span onclick="return setDialogMode(2, \'Compatibility Issue\', 1, null, \'This plugin version is not compatible with your MeshCentral installation, please upgrade MeshCentral first.\');" title="版本不兼容，请先升级您的MeshCentral" style="cursor: pointer; color:red;"> ! </span> ]',n.push("install"),n.push("upgrade"))),e.actions="<select onchange=\"return pluginAction(this,'"+e._id+'\');"><option value=""> --</option>',Object.entries(r[e.status]));for(t in i)-1===n.indexOf(i[t][0])&&(e.actions+='<option value="'+i[t][0]+'">'+i[t][1]+"</option>");e.actions+="</select>";var o="<td><img style=margin-top:3px src=images/plugin24.png></td><td class=gradTable1>&nbsp;</td><td class=gradTable2>"+e.nameHtml+"</td><td class=gradTable2>"+EscapeHtml(e.description)+'</td><td class=gradTable2 style=text-align:center><a href="'+EscapeHtml(e.homepage)+'" rel="noreferrer noopener" target="_blank">Home</a></td><td class=gradTable2 style=text-align:center>'+EscapeHtml(e.version)+'</td><td style=text-align:center class="pluginUpgradeAvailable gradTable2">'+e.upgradeAvail+'</td><td class=gradTable2 style="text-align:center;color:#'+e.statusColor+'">'+e.statusText+'</td><td class="pluginAction gradTable2" style=text-align:center>'+e.actions+"</td><td class=gradTable3>&nbsp;</td>",s=l.insertRow(-1);s.innerHTML=o,s.classList.add("p42tblRow"),s.setAttribute("data-id",e._id),s.setAttribute("id","pluginRow-"+e._id)})}else{var n=Q("p42tbl").querySelectorAll(".p42tblRow");for(t in Object.values(n))n[t].parentNode.removeChild(n[t])}null==e&&refreshPluginLatest()}}function refreshPluginLatest(){null!=pluginHandler&&meshserver.send({action:"pluginLatestCheck"})}function distributeCore(){null!=pluginHandler&&(meshserver.send({action:"distributeCore",nodes:nodes}),QV("pluginRestartNotice",!1))}function pluginActionEx(){if(null!=pluginHandler){var e=Q("lastPluginAct").value,t=Q("lastPluginId").value,n=Q("lastPluginVersion").value;switch(e){case"upgrade":case"install":meshserver.send({action:"installplugin",id:t,version_only:!1});break;case"downgrade":Q("lastPluginVersion").querySelectorAll("option").forEach(function(e){e.value==n&&(pVers=e.text)}),meshserver.send({action:"installplugin",id:t,version_only:{name:pVers,url:n}});break;case"delete":meshserver.send({action:"removeplugin",id:t});break;case"disable":meshserver.send({action:"disableplugin",id:t})}QV("pluginRestartNotice",!0)}}function pluginAction(e,t){if(null!=pluginHandler){if("downgrade"==e.value)meshserver.send({action:"getpluginversions",id:t});else{var n,i=null;for(n in installedPluginList)installedPluginList[n]._id==t&&(i=installedPluginList[n]);setDialogMode(2,"插件指令",3,pluginActionEx,format("您确定要{0}插件吗：{1}",e.value,i.name)+'<input id="lastPluginAct" type="hidden" value="'+e.value+'" /><input id="lastPluginId" type="hidden" value="'+t+'" /><input id="lastPluginVersion" type="hidden" value="" />')}e.value=""}}function goPlugin(e,t){null!=pluginHandler&&(null==e?Q("p43iframe").src="":(QH("p43title",t),Q("p43iframe").src="/pluginadmin.ashx?pin="+e,go(43)))}function removeUserRights(e,t){var n;return t==userinfo._id&&null!=userinfo.removeRights&&((n=t=0)!=(8&userinfo.removeRights)&&(n+=8),0!=(65536&userinfo.removeRights)&&(t+=65536),0!=(256&userinfo.removeRights)&&(t+=256),0!=(512&userinfo.removeRights)&&(t+=512),0!=(1024&userinfo.removeRights)&&(t+=1024),0!=(16&userinfo.removeRights)&&(n+=16),0!=(32768&userinfo.removeRights)&&(n+=32768),0!=(131072&userinfo.removeRights)&&(n+=131072),0!=(64&userinfo.removeRights)&&(n+=64),0!=(262144&userinfo.removeRights)&&(n+=262144),e=4294967295!=e?(e|t)&4294967295-n:((e=2015471)|t)&4294967295-n),e}function GetMeshRights(e,t){if(null==e)return 0;if(null==t&&(t=userinfo._id),null==(e="string"==typeof e?meshes[e]:e)||null==e.links)return 0;if(serverinfo.manageAllDeviceGroups&&t==userinfo._id)return removeUserRights(4294967295,t);var n=0,i=e.links[t];if(null!=i){if(4294967295==i.rights)return removeUserRights(4294967295,t);n=i.rights}var o=null;if(t==userinfo._id?o=userinfo:null!=users&&(o=users[t]),null!=o)for(var s in o.links)if(s.startsWith("ugrp/")&&null!=(i=e.links[s])){if(4294967295==i.rights)return removeUserRights(4294967295,t);n|=i.rights}return removeUserRights(n,t)}function IsMeshViewable(e,t){if(null!=e&&(null==t&&(t=userinfo._id),null!=(e="string"==typeof e?meshes[e]:e))&&null!=e.links){if(null!=e.links[t])return!0;if(serverinfo.manageAllDeviceGroups&&t==userinfo._id)return!0;var n=null;if(t==userinfo._id?n=userinfo:null!=users&&(n=users[t]),null!=n)for(var i in n.links)if(i.startsWith("ugrp/")&&null!=e.links[i])return!0}return!1}function GetNodeRights(e,t){if(null==e)return 0;if(null==t&&(t=userinfo._id),"string"==typeof e&&null==(e=getNodeFromId(e)))return 0;var n=GetMeshRights(e.meshid,t);if(4294967295!=n&&(null!=e.links&&null!=e.links[t]&&(n|=e.links[t].rights),null!=e.links)&&null!=userinfo.links)for(var i in e.links)i.startsWith("ugrp/")&&null!=userinfo.links[i]&&null!=e.links[i].rights&&(n|=e.links[i].rights);return removeUserRights(n,t)}function IsNodeViewable(e,t){if(null!=e&&(null==t&&(t=userinfo._id),"string"!=typeof e||null!=(e=getNodeFromId(e)))){if(IsMeshViewable(e.meshid,t))return!0;if(null!=e.links&&null!=e.links[t])return!0;if(null!=e.links&&null!=userinfo.links)for(var n in e.links)if(n.startsWith("ugrp/")&&null!=userinfo.links[n]&&null!=e.links[n].rights)return!0}return!1}if("undefined"==typeof TextEncoder){window.TextEncoder=function(){},TextEncoder.prototype.encode=function(e){for(var t,n=e.length,i=-1,o="undefined"==typeof Uint8Array?new Array(1.5*n):new Uint8Array(3*n),s=0,a=0;a!==n;){if(s=e.charCodeAt(a),a+=1,55296<=s&&s<=56319){if(a===n){o[i+=1]=239,o[i+=1]=191,o[i+=1]=189;break}if(!(56320<=(t=e.charCodeAt(a))&&t<=57343)){o[i+=1]=239,o[i+=1]=191,o[i+=1]=189;continue}if(a+=1,65535<(s=1024*(s-55296)+t-56320+65536)){o[i+=1]=240|s>>>18,o[i+=1]=128|s>>>12&63,o[i+=1]=128|s>>>6&63,o[i+=1]=128|63&s;continue}}s<=127?o[i+=1]=0|s:(s<=2047?o[i+=1]=192|s>>>6:(o[i+=1]=224|s>>>12,o[i+=1]=128|s>>>6&63),o[i+=1]=128|63&s)}return"undefined"!=typeof Uint8Array?o.subarray(0,i+1):(o.length=i+1,o)},TextEncoder.prototype.toString=function(){return"[object TextEncoder]"};try{Object.defineProperty(TextEncoder.prototype,"encoding",{get:function(){if(TextEncoder.prototype.isPrototypeOf(this))return"utf-8";throw TypeError("Illegal invocation")}})}catch(e){TextEncoder.prototype.encoding="utf-8"}"undefined"!=typeof Symbol&&(TextEncoder.prototype[Symbol.toStringTag]="TextEncoder")}function urlBase64ToUint8Array(e){for(var e=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),t=atob(e),n=new Uint8Array(t.length),i=0;i<t.length;++i)n[i]=t.charCodeAt(i);return n}function joinPaths(){var e,t=[];for(e in arguments){var n=arguments[e];if(null!=n&&""!=n){for(;n.endsWith("/")||n.endsWith("\\");)n=n.substring(0,n.length-1);for(;n.startsWith("/")||n.startsWith("\\");)n=n.substring(1);t.push(n)}}return t.join("/")}function putstore(e,t){try{if("undefined"==typeof localStorage||localStorage.getItem(e)==t)return;null==t?localStorage.removeItem(e):localStorage.setItem(e,t)}catch(e){}if("_"!=e[0]){var n={};try{for(var i=0,o=localStorage.length;i<o;++i){var s=localStorage.key(i);"_"!=s[0]&&(n[s]=localStorage.getItem(s),"desktopsettings"!=s)&&"stars"!=s&&"deskKeyShortcuts"!=s&&"deskStrings"!=s&&"cmdopt"!=s&&"string"==typeof n[s]&&64<n[s].length&&delete n[s]}}catch(e){}meshserver.send({action:"userWebState",state:JSON.stringify(n)})}}function stringToUtf8Blob(e){var t=(new TextEncoder).encode(e),n=new Uint8Array(3+t.length);n[0]=239,n[1]=187,n[2]=191;for(var i=0;i<t.length;i++)n[i+3]=t[i];return new Blob([n],{type:"application/octet-stream"})}function stringToUtf8BlobNoHeader(e){return new Blob([(new TextEncoder).encode(e)],{type:"application/octet-stream"})}function multiTranslate(e){var t=e.indexOf("]|");return e.substring(t+2)}function getLang(){return null!=navigator.languages?navigator.languages[0]:navigator.language}function getNodeAmtVersion(e){return null==e||null==e.intelamt||"string"!=typeof e.intelamt.ver||(e=e.intelamt.ver.split(".")).length<2?0:parseInt(e[0])+parseInt(e[1])/100}function getstore(e,t){try{var n;return"undefined"==typeof localStorage?t:null==(n=localStorage.getItem(e))?t:n}catch(e){return t}}function addLink(e,t){return"<span tabindex=0 style=cursor:pointer;text-decoration:none onclick='"+t+"' onkeypress=\"if (event.key=='Enter') {"+t+'} ">'+e+" <img class=hoverButton src=images/link5.png></span>"}function addLinkConditional(e,t,n){return n?addLink(e,t):e}function addKeyLink(e,t){return"<span tabindex=0 style=cursor:pointer;text-decoration:none onclick="+t+" onkeypress=\"if (event.key=='Enter') { "+t+' } ">'+e+" <img class=hoverButton src=images/key16.png></span>"}function addKeyLinkConditional(e,t,n){return n?"<span title='"+t+"'>"+e+" <img class=hoverButton src=images/key16.png></span>":e}function haltEvent(e){return e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),!1}function addOption(e,t,n){var i=document.createElement("option");i.text=t,i.value=n,Q(e).add(i)}function passwordcheck(e){return 7<e.length&&/\d/.test(e)&&/[a-z]/.test(e)&&/[A-Z]/.test(e)&&/\W/.test(e)}function methodcheck(e){return!(!e||null==e||!e.Body||"SUCCESS"==e.Body.ReturnValueStr||(messagebox("呼叫错误",e.Header.Method+": "+e.Body.ReturnValueStr.replace("_"," ")),0))}function TableStart(){return"<table cellpadding=0 cellspacing=0 style=width:100%;border-radius:8px><tr><td width=200px><p><td>"}function TableStart2(){return"<table cellpadding=0 cellspacing=0 style=width:100%;border-radius:8px><tr><td><p><td>"}function TableEntry(e,t){return"<tr><td><p>"+e+"<td>"+t}function FullTable(e,t){var n=TableStart();for(i in e)i&&e[i]&&(n+=TableEntry(i,e[i]));return n+TableEnd(t)}function TableEnd(e){return"<tr><td colspan=2><p>"+(e||"")+"</table>"}function AddButton(e,t){return'<input type=button value="'+e+'" onclick="'+t+'" style=margin:4px>'}function AddButton2(e,t){return'<input type=button value="'+e+'" onclick="'+t+'">'}function AddRefreshButton(e){return'<input type=button name=refreshbtn value=Refresh onclick="refreshButtons(false);'+e+'" style=margin:4px '+(0==refreshButtonsState?"disabled":"")+">"}function MoreStart(){return"<div id=idx_dlgMoreButtons3 style=display:none><hr>"}function MoreEnd(){return"</div>"}function MoreToggle(e){QV("idx_dlgMoreButtons1",!e),QV("idx_dlgMoreButtons2",e),QV("idx_dlgMoreButtons3",e)}function getSelectedOptions(e){for(var t,n=[],i=0,o=e.options.length;i<o;i++)(t=e.options[i]).selected&&n.push(t.value);return n}function getInstance(e,t){for(var n in e)if(e[n].InstanceID==t)return e[n];return null}function getItem(e,t,n){for(var i in e)if(e[i][t]==n)return e[i];return null}function guidToStr(e){return e.substring(6,8)+e.substring(4,6)+e.substring(2,4)+e.substring(0,2)+"-"+e.substring(10,12)+e.substring(8,10)+"-"+e.substring(14,16)+e.substring(12,14)+"-"+e.substring(16,20)+"-"+e.substring(20)}function getUrlVars(){for(var e,t=[],n=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),i=0;i<n.length;i++)0<(e=n[i].indexOf("="))&&(t[n[i].substring(0,e)]=n[i].substring(e+1,n[i].length));return t}function addHtmlValue(e,t){return"<table><td style=width:120px>"+e+"<td><b>"+t+"</b></table>"}function addHtmlValue2(e,t){return"<div><div style=display:inline-block;float:right>"+t+"</div><div style=display:inline-block>"+e+"</div></div>"}function addHtmlValue3(e,t){return"<div><b>"+e+"</b></div><div style=margin-left:16px>"+t+"</div>"}function addHtmlValue4(e,t){return"<table style=width:100%><td style=width:120px>"+e+"<td style=text-align:right><b>"+t+"</b></table>"}function addHtmlValue5(e,t){return"<div style=padding:4px><div style=display:inline-block;float:right><b>"+t+"</b></div><div style=display:inline-block>"+e+"</div></div>"}function focusTextBox(e){setTimeout(function(){Q(e).selectionStart=Q(e).selectionEnd=65535,Q(e).focus()},0)}function validateEmail(e){return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(e)}function isPrivateIP(e){return e.startsWith("10.")||e.startsWith("172.16.")||e.startsWith("192.168.")}function u2fSupported(){return window.u2f&&(0<navigator.userAgent.indexOf("Chrome/")||0<navigator.userAgent.indexOf("Firefox/")||0<navigator.userAgent.indexOf("Opera/")||0<navigator.userAgent.indexOf("Safari/"))}function findOne(t,e){return null!=t&&null!=e&&e.some(function(e){return 0<=t.indexOf(e)})}function copyTextToClip(e){var t,n=document.createElement("DIV");n.textContent=e,document.body.appendChild(n),e=n,document.selection?((t=document.body.createTextRange()).moveToElementText(e),t.select()):window.getSelection&&((t=document.createRange()).selectNode(e),window.getSelection().removeAllRanges(),window.getSelection().addRange(t)),document.execCommand("copy"),n.remove()}function copyTextToClip2(e){var t,n=document.createElement("DIV");n.textContent=decodeURIComponent(e),document.body.appendChild(n),e=n,document.selection?((t=document.body.createTextRange()).moveToElementText(e),t.select()):window.getSelection&&((t=document.createRange()).selectNode(e),window.getSelection().removeAllRanges(),window.getSelection().addRange(t)),document.execCommand("copy"),n.remove()}function capitalizeFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1)}function printDate(e){return e.toLocaleDateString(args.locale)}function printTime(e){return e.toLocaleTimeString(args.locale)}function printDateTime(e){return e.toLocaleString(args.locale)}function printFlexDateTime(e){return(printDate(new Date)==printDate(e)?printTime:printDateTime)(e)}function addDetailItem(e,t,n){return"<table style=width:100%><td>"+nobreak(e)+"<td style=text-align:right>"+t+"</table>"}function format(e){var n=Array.prototype.slice.call(arguments,1);return e.replace(/{(\d+)}/g,function(e,t){return void 0!==n[t]?n[t]:e})}function addTextLink(e,t,n){var i=t.toLowerCase().indexOf(e.toLowerCase());return-1==i?t:t.substring(0,i)+'<a href="'+n+'">'+e+"</a>"+t.substring(i+e.length)}function getOrderedList(e,n){var t,i=[];for(t in e)i.push(e[t]);return i.sort(function(e,t){e=e[n].toLowerCase(),t=t[n].toLowerCase();return t<e?1:e<t?-1:0}),i}function capitalizeFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1)}function nobreak(e){return e.split(" ").join("&nbsp;")}function pad2(e){e="00"+e;return e.substr(e.length-2)}function encodeURIComponentEx(e){return encodeURIComponent(e).replace(/'/g,"%27")}function getUserName(e){var t=e.split("/"),n=t[0]+"/"+t[1]+"/"+t[2],i="";if(4==t.length&&t[3].startsWith("guest:")&&(i=" - "+decode_utf8(atob(t[3].substring(6)))),users&&null!=users[n])return null!=users[n].realname?users[n].realname+i:users[n].name+i;if(currentNode&&currentNode.links&&currentNode.links[e]&&null!=currentNode.links[e].name)return currentNode.links[e].name+i;if(e==userinfo._id)return userinfo.name+i;if(nodes)for(var o in nodes)if(nodes[o].links)for(var s in nodes[o].links)if(nodes[o].links[s].name&&s==e)return nodes[o].links[s].name+i;return t[2]+i}function round(e,t){t=Math.pow(10,t||0);return Math.round(e*t)/t}function safeNewWindow(e,t){e=window.open(e,t,"noopener,noreferrer");e&&(e.opener=null)}function isWindowsNode(e){return 2==e.mtype&&null!=e.agent&&null!=e.agent.id&&0<=[1,2,3,4,21,22,34,42,43].indexOf(e.agent.id)}function isMacNode(e){return 2==e.mtype&&null!=e.agent&&null!=e.agent.id&&0<=[11,16,29].indexOf(e.agent.id)}function downloadFile(e,t,n){var i=document.createElement("a");i.setAttribute("href",e),i.setAttribute("rel","noreferrer noopener"),i.setAttribute("target","fileDownloadFrame"),i.setAttribute("download",decodeURIComponent(t||"")),document.body.appendChild(i),i.click(),document.body.removeChild(i),n&&setDialogMode(0)}function dialogBoxDrag(){var t=Q("dialog"),n=0,i=0,o=0,s=0;function a(e){(e=e||window.event).preventDefault(),n=o-e.clientX,i=s-e.clientY,o=e.clientX,s=e.clientY,t.style.top=t.offsetTop-i+"px",t.style.left=t.offsetLeft-n+"px"}function r(){document.onmouseup=null,document.onmousemove=null}Q("dialogHeader").onmousedown=function(e){(e=e||window.event).preventDefault(),o=e.clientX,s=e.clientY,document.onmouseup=r,document.onmousemove=a}}window.addEventListener("beforeunload",function(e){(null!=desktop&&11==xxcurrentView||null!=terminal&&12==xxcurrentView)&&(e.preventDefault(),e.returnValue="")})</script>