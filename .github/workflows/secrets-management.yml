name: Secrets Management

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - validate
          - rotate-reminder
      
  schedule:
    # Run monthly secret rotation reminder
    - cron: '0 0 1 * *'

jobs:
  validate-secrets:
    name: Validate Required Secrets
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'validate' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate required secrets exist
        run: |
          echo "Validating required secrets configuration..."
          
          EXIT_CODE=0
          
          # Check required secrets
          if [ -z "${{ secrets.HOSTNAME }}" ]; then
            echo "‚ùå HOSTNAME secret is not set"
            EXIT_CODE=1
          else
            echo "‚úì HOSTNAME secret is configured"
          fi
          
          if [ -z "${{ secrets.LETSENCRYPT_EMAIL }}" ]; then
            echo "‚ùå LETSENCRYPT_EMAIL secret is not set"
            EXIT_CODE=1
          else
            echo "‚úì LETSENCRYPT_EMAIL secret is configured"
          fi
          
          # Check optional secrets
          if [ -z "${{ secrets.RAILWAY_TOKEN }}" ]; then
            echo "‚ö† RAILWAY_TOKEN secret is not set (optional for Railway deployment)"
          else
            echo "‚úì RAILWAY_TOKEN secret is configured"
          fi
          
          if [ -z "${{ secrets.DEPLOY_HOST }}" ]; then
            echo "‚ö† DEPLOY_HOST secret is not set (optional for SSH deployment)"
          else
            echo "‚úì DEPLOY_HOST secret is configured"
          fi
          
          if [ -z "${{ secrets.DEPLOY_USER }}" ]; then
            echo "‚ö† DEPLOY_USER secret is not set (optional for SSH deployment)"
          else
            echo "‚úì DEPLOY_USER secret is configured"
          fi
          
          if [ -z "${{ secrets.DEPLOY_SSH_KEY }}" ]; then
            echo "‚ö† DEPLOY_SSH_KEY secret is not set (optional for SSH deployment)"
          else
            echo "‚úì DEPLOY_SSH_KEY secret is configured"
          fi
          
          echo ""
          if [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ All required secrets are configured!"
          else
            echo "‚ùå Some required secrets are missing. Please configure them in GitHub Settings."
            echo ""
            echo "Required secrets:"
            echo "  - HOSTNAME: Your deployment domain"
            echo "  - LETSENCRYPT_EMAIL: Email for SSL certificate registration"
            echo ""
            echo "Optional secrets (for specific deployment methods):"
            echo "  - RAILWAY_TOKEN: For Railway deployment"
            echo "  - DEPLOY_HOST: For SSH deployment"
            echo "  - DEPLOY_USER: For SSH deployment"
            echo "  - DEPLOY_SSH_KEY: For SSH deployment"
            echo "  - DEPLOY_PATH: For SSH deployment (default: /opt/treetee)"
          fi
          
          exit $EXIT_CODE
      
      - name: Generate validation report
        if: always()
        run: |
          echo "## Secrets Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Generate summary based on secret existence
          if [ -n "${{ secrets.HOSTNAME }}" ] && [ -n "${{ secrets.LETSENCRYPT_EMAIL }}" ]; then
            echo "‚úÖ All required secrets are configured" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Some required secrets are missing" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Required Secrets Status" >> $GITHUB_STEP_SUMMARY
          
          [ -n "${{ secrets.HOSTNAME }}" ] && echo "- ‚úÖ HOSTNAME" >> $GITHUB_STEP_SUMMARY || echo "- ‚ùå HOSTNAME" >> $GITHUB_STEP_SUMMARY
          [ -n "${{ secrets.LETSENCRYPT_EMAIL }}" ] && echo "- ‚úÖ LETSENCRYPT_EMAIL" >> $GITHUB_STEP_SUMMARY || echo "- ‚ùå LETSENCRYPT_EMAIL" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Optional Secrets Status" >> $GITHUB_STEP_SUMMARY
          
          [ -n "${{ secrets.RAILWAY_TOKEN }}" ] && echo "- ‚úÖ RAILWAY_TOKEN" >> $GITHUB_STEP_SUMMARY || echo "- ‚ö†Ô∏è  RAILWAY_TOKEN (not set)" >> $GITHUB_STEP_SUMMARY
          [ -n "${{ secrets.DEPLOY_HOST }}" ] && echo "- ‚úÖ DEPLOY_HOST" >> $GITHUB_STEP_SUMMARY || echo "- ‚ö†Ô∏è  DEPLOY_HOST (not set)" >> $GITHUB_STEP_SUMMARY
          [ -n "${{ secrets.DEPLOY_USER }}" ] && echo "- ‚úÖ DEPLOY_USER" >> $GITHUB_STEP_SUMMARY || echo "- ‚ö†Ô∏è  DEPLOY_USER (not set)" >> $GITHUB_STEP_SUMMARY
          [ -n "${{ secrets.DEPLOY_SSH_KEY }}" ] && echo "- ‚úÖ DEPLOY_SSH_KEY" >> $GITHUB_STEP_SUMMARY || echo "- ‚ö†Ô∏è  DEPLOY_SSH_KEY (not set)" >> $GITHUB_STEP_SUMMARY

  rotation-reminder:
    name: Secret Rotation Reminder
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'rotate-reminder' || github.event.schedule == '0 0 1 * *'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate rotation reminder
        run: |
          echo "## üîê Monthly Secret Rotation Reminder" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "It's time to review and rotate your secrets for security best practices!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Secrets to Review:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **SSL/TLS Certificates**" >> $GITHUB_STEP_SUMMARY
          echo "   - Check expiration dates" >> $GITHUB_STEP_SUMMARY
          echo "   - Renew if necessary (Let's Encrypt auto-renews)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **MeshCentral Admin Credentials**" >> $GITHUB_STEP_SUMMARY
          echo "   - Review admin accounts" >> $GITHUB_STEP_SUMMARY
          echo "   - Rotate passwords" >> $GITHUB_STEP_SUMMARY
          echo "   - Verify 2FA is enabled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "3. **API Tokens & Access Keys**" >> $GITHUB_STEP_SUMMARY
          echo "   - RAILWAY_TOKEN (if using Railway)" >> $GITHUB_STEP_SUMMARY
          echo "   - SSH keys (if using SSH deployment)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "4. **Review Access Logs**" >> $GITHUB_STEP_SUMMARY
          echo "   - Check for unauthorized access attempts" >> $GITHUB_STEP_SUMMARY
          echo "   - Review active sessions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Security Policy](SECURITY.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Migration Guide](MIGRATION.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Setup Guide](.github/SECURITY_QUICKSTART.md)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next rotation reminder:** $(date -u -d '+1 month' '+%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
      
      - name: Create reminder issue (optional)
        if: false  # Set to true if you want to create issues
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üîê Monthly Secret Rotation Reminder',
              body: `## Secret Rotation Reminder
              
              It's time to review and rotate secrets for security best practices.
              
              ### Action Items:
              
              - [ ] Review SSL/TLS certificate expiration
              - [ ] Rotate MeshCentral admin passwords
              - [ ] Review and rotate API tokens
              - [ ] Review access logs for anomalies
              - [ ] Verify 2FA is enabled for all admin accounts
              
              ### Resources:
              
              - [Security Policy](SECURITY.md)
              - [Migration Guide](MIGRATION.md)
              - [Setup Guide](.github/SECURITY_QUICKSTART.md)
              
              This is an automated monthly reminder. Close this issue once rotation is complete.`,
              labels: ['security', 'maintenance']
            });
            
            console.log('Created issue #' + issue.data.number);
