# Example GitHub Actions workflow for secure deployment
# Copy this file to deploy.yml and configure your secrets in GitHub

name: Deploy DaisyChain

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Create environment file
        run: |
          cat > .env << EOF
          NODE_ENV=production
          HOSTNAME=${{ secrets.HOSTNAME }}
          PORT=443
          REDIRECT_PORT=80
          MESHCENTRAL_CERT_NAME=${{ secrets.HOSTNAME }}
          MESHCENTRAL_PORT=443
          MESHCENTRAL_REDIRECT_PORT=80
          LETSENCRYPT_EMAIL=${{ secrets.LETSENCRYPT_EMAIL }}
          LETSENCRYPT_DOMAIN=${{ secrets.HOSTNAME }}
          LETSENCRYPT_PRODUCTION=true
          ALLOW_NEW_ACCOUNTS=false
          ENABLE_IPKVM=false
          ALLOW_LOGIN_TOKEN=true
          WAN_ONLY=true
          PYTHONUNBUFFERED=1
          EOF
      
      - name: Generate configuration
        run: |
          chmod +x generate-config.sh
          ./generate-config.sh
      
      - name: Deploy to Railway (if using Railway)
        if: github.ref == 'refs/heads/main'
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          npm install -g @railway/cli
          railway up
      
      # Alternative: Deploy to your own infrastructure
      # - name: Deploy via SSH
      #   uses: appleboy/ssh-action@master
      #   with:
      #     host: ${{ secrets.DEPLOY_HOST }}
      #     username: ${{ secrets.DEPLOY_USER }}
      #     key: ${{ secrets.DEPLOY_SSH_KEY }}
      #     script: |
      #       cd /path/to/app
      #       git pull
      #       ./generate-config.sh
      #       docker-compose up -d --build

  security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Run security audit
        run: |
          npm audit --audit-level=moderate
      
      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
