# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

TreeTee is an AI agent monitoring and control platform that bridges AI agents, virtual machines, and human control. It enables AI agents to control computers via VNC/RDP while providing secure monitoring in Trusted Execution Environments (TEEs).

**Core Components:**
- MeshCentral-based remote device management server (npm package v1.1.42)
- Node.js process spawner (index.js) that launches MeshCentral
- Python utilities for certificate and connection validation
- Docker containerized deployment with two-tier configuration (base + production overlay)

## Development Commands

### Build and Run

```bash
# Development deployment
docker-compose up -d

# Production deployment (restricted volume mounts)
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# View logs
docker-compose logs -f

# Stop services
docker-compose down

# Rebuild containers
docker-compose build --no-cache
```

### Configuration Management

```bash
# Generate config.json from environment variables and template
./generate-config.sh

# Verify Docker compose configuration
docker-compose config
```

### Testing and Validation

```bash
# Check SSL certificates
python3 check_cert.py

# Verify nginx configuration
python3 check_nginx.py

# Test redirects
python3 check_redirects.py

# Audit npm dependencies
npm audit --audit-level=high
```

### Pre-commit Hook

Install the security pre-commit hook to prevent committing secrets:
```bash
cp .github/pre-commit-hook.sh .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit
```

## Architecture

### Configuration System

TreeTee uses a two-stage configuration approach:

1. **Template-based generation**: `meshcentral-data/config.json.template` contains MeshCentral config with environment variable placeholders
2. **Environment substitution**: `generate-config.sh` or `docker-entrypoint.sh` uses `envsubst` to replace placeholders with actual values from `.env`
3. **Runtime**: Generated `config.json` is used by MeshCentral at startup

Key environment variables:
- `HOSTNAME`: Deployment domain (required)
- `LETSENCRYPT_EMAIL`: Email for SSL certificate registration (required)
- `NODE_ENV`: Environment mode (production/development)
- `MESHCENTRAL_PORT`: HTTPS port (default: 443)
- `ALLOW_NEW_ACCOUNTS`: Enable/disable user registration (default: false)
- `LETSENCRYPT_PRODUCTION`: Use production Let's Encrypt certs (default: false for local dev)

### Deployment Architecture

**Container Layers:**
1. **Dockerfile**: Node 18-slim base with Python 3 utilities
2. **docker-compose.yml**: Base configuration with full repository mount for development
3. **docker-compose.prod.yml**: Production overlay that restricts volumes to only necessary files (read-only where possible)
4. **docker-entrypoint.sh**: Entrypoint script that generates config and starts MeshCentral

**Process Flow:**
1. Container starts â†’ `docker-entrypoint.sh` runs
2. Script sets default environment variables
3. Runs `envsubst` on config template to generate `config.json`
4. Executes `node ./node_modules/meshcentral` to start server

### Security Model

This repository enforces strict security practices through multiple layers:

**Pre-commit Protection:**
- Git hook scans for `.env` files, certificates (`.pem`, `.key`, `.crt`), private keys
- Pattern matching for hardcoded secrets in staged content
- Interactive warnings for potential sensitive data

**CI/CD Security Scans:**
- TruffleHog: Secret detection in git history
- npm audit: Dependency vulnerability scanning
- CodeQL: Static code analysis for JavaScript and Python
- File scanner: Checks for committed certificates and `.env` files

**Secrets Management:**
- All sensitive data via environment variables (never hardcoded)
- Certificates stored outside repository or auto-generated by Let's Encrypt
- GitHub Secrets for CI/CD pipelines
- `.env` file never committed (template `.env.example` provided)

### Directory Structure

```
trifecta/
  meshcentral-data/              # MeshCentral runtime data
    config.json.template         # Configuration template with ${VAR} placeholders
    config.json                  # Generated config (gitignored)
  .github/
    workflows/
      security-scan.yml          # CI/CD security automation
    pre-commit-hook.sh           # Git hook for secret prevention
  check_cert.py                  # SSL certificate validation utility
  check_nginx.py                 # Nginx configuration validator
  check_redirects.py             # Redirect testing utility
  generate-config.sh             # Standalone config generation script
  docker-entrypoint.sh           # Container entrypoint (generates config + starts MeshCentral)
  Dockerfile                     # Container definition
  docker-compose.yml             # Base orchestration (development)
  docker-compose.prod.yml        # Production overlay (restricted mounts)
  index.js                       # Node.js process spawner for MeshCentral
  .env.example                   # Environment variable template
```

## Important Files

- **SECURITY.md**: Security policies, secrets management, SSL/TLS configuration, and audit checklist
- **MIGRATION.md**: Step-by-step guide for migrating from hardcoded secrets to environment-based configuration
- **.env.example**: Template for environment configuration with all available variables
- **railway.json**: Railway deployment configuration (healthcheck timeout: 800s, restart policy: ON_FAILURE)

## Key Principles

1. **Security First**: Never commit secrets, certificates, or `.env` files
2. **Template-based Config**: Use `config.json.template` + environment variables for all configuration
3. **Two-tier Deployment**: Use `docker-compose.prod.yml` for production with minimal, read-only volume mounts
4. **Certificate Management**: Prefer Let's Encrypt auto-renewal; store custom certs outside repository
5. **Validation Before Deploy**: Run Python check scripts (`check_cert.py`, etc.) before deploying configuration changes

## Railway Deployment

Configuration in `railway.json`:
- Builder: Dockerfile
- Healthcheck timeout: 800s (MeshCentral needs time to initialize)
- Restart policy: ON_FAILURE with max 10 retries
- Environment variables set in Railway dashboard (not in code)

## Integration Points

- **MeshCentral**: Core remote management platform (npm package, not custom fork)
- **Tailscale**: VPN network for team connectivity
- **Fast API**: Preferred HTTP stack for Python services
- **Ollama**: AI model endpoint at `hugo:11434`
