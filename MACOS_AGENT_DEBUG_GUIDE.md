# macOS MeshCentral Agent Installation & Debug Guide

## macOS Agent Support

DaisyChain/MeshCentral provides **three macOS agent binaries**:

| Binary | Size | Architecture | Use Case |
|--------|------|--------------|----------|
| `meshagent_osx-arm-64` | 3.8MB | Apple Silicon (M1/M2/M3) | ARM-based Macs only |
| `meshagent_osx-x86-64` | 4.5MB | Intel x86_64 | Intel Macs only |
| `meshagent_osx-universal-64` | 8.3MB | Universal | Both Intel & Apple Silicon |

**Universal binary is recommended** - it works on all modern Macs.

## Installation Methods

### Method 1: Web UI Installation (Recommended)

1. **Get Installation Command**:
   - Go to https://tee.up.railway.app
   - Login to your account
   - Navigate to **My Account** → **Device Groups**
   - Click **"Install"** or **"Add Agent"** next to your device group
   - Select the **"Apple macOS"** tab
   - You'll see download options:
     - **Assistant** - Interactive installer (recommended for non-technical users)
     - **Download .pkg** - Direct download for manual installation
     - **Terminal Command** - Command-line installation

2. **For Terminal Installation**:
   ```bash
   # The command will look like this (generated by web UI):
   curl -o meshagent.pkg 'https://tee.up.railway.app/meshagents?id=16&meshid=MESH_ID_HERE'
   sudo installer -pkg meshagent.pkg -target /
   ```

### Method 2: Manual Download and Install

```bash
# 1. Download the agent package
curl -o meshagent.pkg 'https://tee.up.railway.app/meshagents?id=16&meshid=YOUR_MESH_ID_HERE'

# 2. Install using macOS installer
sudo installer -pkg meshagent.pkg -target /

# 3. Verify installation
sudo launchctl list | grep mesh
```

## Architecture Detection

### Check Your Mac's Architecture

```bash
# Method 1: Quick check
uname -m

# Output:
# arm64    = Apple Silicon (M1/M2/M3)
# x86_64   = Intel processor

# Method 2: Detailed system info
sysctl machdep.cpu.brand_string

# Method 3: Architecture with model
system_profiler SPHardwareDataType | grep -E "Chip|Processor"
```

### MeshCentral Agent ID Mapping

| Agent ID | Architecture | Binary Used |
|----------|--------------|-------------|
| 16 | Universal (recommended) | `meshagent_osx-universal-64` |
| 3 | Intel x86_64 | `meshagent_osx-x86-64` |
| 29 | Apple Silicon ARM64 | `meshagent_osx-arm-64` |

**Note**: Use Agent ID 16 (Universal) unless you have a specific reason to use architecture-specific binaries.

## macOS Detection Script

Save this as `detect-mac-mesh-agent.sh`:

```bash
#!/bin/bash

echo "=== macOS MeshCentral Agent Detection ==="
echo ""

# Detect architecture
ARCH=$(uname -m)
echo "Architecture: $ARCH"

# Detect macOS version
MACOS_VERSION=$(sw_vers -productVersion)
echo "macOS Version: $MACOS_VERSION"

# Get detailed CPU info
CPU_BRAND=$(sysctl -n machdep.cpu.brand_string)
echo "CPU: $CPU_BRAND"

# Detect chip type
if [ "$ARCH" == "arm64" ]; then
    CHIP_TYPE="Apple Silicon"
    RECOMMENDED_ID="16 (Universal) or 29 (ARM-specific)"
else
    CHIP_TYPE="Intel"
    RECOMMENDED_ID="16 (Universal) or 3 (Intel-specific)"
fi

echo "Chip Type: $CHIP_TYPE"
echo ""
echo "=== Recommended Agent ==="
echo "Agent ID: $RECOMMENDED_ID"
echo "Binary: meshagent_osx-universal-64 (works on both architectures)"
echo ""

# Check if agent is already installed
echo "=== Installation Status ==="
if [ -d "/usr/local/mesh_services/meshagent" ] || [ -d "/Library/Mesh Agent" ]; then
    echo "✓ MeshAgent appears to be installed"

    # Check if service is running
    if sudo launchctl list | grep -q mesh; then
        echo "✓ MeshAgent service is running"
    else
        echo "✗ MeshAgent service is not running"
    fi
else
    echo "✗ MeshAgent is not installed"
fi

echo ""
echo "=== System Requirements Check ==="

# Check macOS version (MeshAgent requires 10.9+)
MACOS_MAJOR=$(echo $MACOS_VERSION | cut -d. -f1)
MACOS_MINOR=$(echo $MACOS_VERSION | cut -d. -f2)

if [ "$MACOS_MAJOR" -ge 11 ] || ([ "$MACOS_MAJOR" -eq 10 ] && [ "$MACOS_MINOR" -ge 9 ]); then
    echo "✓ macOS version is compatible (requires 10.9+)"
else
    echo "✗ macOS version too old (requires 10.9+)"
fi

# Check for curl
if command -v curl &> /dev/null; then
    echo "✓ curl is installed"
else
    echo "✗ curl not found"
fi

# Check internet connectivity
if ping -c 1 8.8.8.8 &> /dev/null; then
    echo "✓ Internet connectivity available"
else
    echo "✗ No internet connectivity"
fi

# Check if server is reachable
if curl -s -I https://tee.up.railway.app &> /dev/null; then
    echo "✓ MeshCentral server is reachable"
else
    echo "✗ Cannot reach MeshCentral server"
fi

echo ""
echo "=== Next Steps ==="
echo "1. Go to https://tee.up.railway.app"
echo "2. Login and navigate to My Account → Device Groups"
echo "3. Click 'Install' next to your device group"
echo "4. Select 'Apple macOS' tab"
echo "5. Download the .pkg file or copy the terminal command"
echo "6. Run: sudo installer -pkg meshagent.pkg -target /"
```

## Installation Troubleshooting

### Issue 1: "meshagent.pkg" can't be opened because it is from an unidentified developer

**Cause**: macOS Gatekeeper blocking the installer

**Solutions**:

**Option A: Right-click method**
1. Right-click (or Control+click) on `meshagent.pkg`
2. Select "Open"
3. Click "Open" in the dialog
4. Enter your password when prompted

**Option B: System Preferences**
1. Go to **System Preferences** → **Security & Privacy**
2. On the **General** tab, click "Open Anyway" next to the blocked app message
3. Confirm by clicking "Open"

**Option C: Command line**
```bash
# Remove quarantine attribute
xattr -d com.apple.quarantine meshagent.pkg

# Then install normally
sudo installer -pkg meshagent.pkg -target /
```

### Issue 2: Agent installed but not connecting

**Check agent status**:
```bash
# Check if the service is loaded
sudo launchctl list | grep mesh

# Check agent logs
sudo cat /Library/Logs/MeshAgent-Install.log

# Check running processes
ps aux | grep -i mesh | grep -v grep
```

**Restart the agent**:
```bash
# Unload the service
sudo launchctl unload /Library/LaunchDaemons/meshagent_osx64LaunchDaemon.plist

# Reload the service
sudo launchctl load /Library/LaunchDaemons/meshagent_osx64LaunchDaemon.plist
```

### Issue 3: Permission denied errors

**Cause**: macOS security restrictions

**Solution**: Grant necessary permissions
1. Go to **System Preferences** → **Security & Privacy** → **Privacy**
2. Select **Full Disk Access** from the left sidebar
3. Click the lock icon and authenticate
4. Click **+** and navigate to `/Library/Mesh Agent/` or `/usr/local/mesh_services/meshagent/`
5. Add the MeshAgent binary
6. Restart the agent

### Issue 4: Agent downloads but installation fails

**Check installation logs**:
```bash
# View installer log
cat /var/log/install.log | grep -i mesh

# Check system log
log show --predicate 'process == "installer"' --last 1h | grep -i mesh
```

**Manual verification**:
```bash
# Check if package is valid
pkgutil --check-signature meshagent.pkg

# List package contents
pkgutil --payload-files meshagent.pkg
```

### Issue 5: Network connectivity issues

**Test connection to server**:
```bash
# Test HTTPS
curl -I https://tee.up.railway.app

# Test websocket port (443)
nc -zv tee.up.railway.app 443

# Check DNS resolution
nslookup tee.up.railway.app

# Trace route
traceroute tee.up.railway.app
```

**Check firewall**:
```bash
# Check if Application Firewall is enabled
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate

# List firewall rules
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --listapps
```

## Uninstalling MeshAgent

If you need to completely remove and reinstall:

```bash
# Method 1: Using the uninstaller (if available)
sudo /Library/Mesh\ Agent/meshagent -uninstall

# Method 2: Manual removal
sudo launchctl unload /Library/LaunchDaemons/meshagent_osx64LaunchDaemon.plist
sudo rm -rf /Library/Mesh\ Agent
sudo rm -rf /Library/LaunchDaemons/meshagent_osx64LaunchDaemon.plist
sudo rm -rf /usr/local/mesh_services
sudo pkgutil --forget com.meshcentral.meshagent

# Method 3: If installed in different location
sudo launchctl unload /Library/LaunchDaemons/meshagent.plist
sudo rm -rf /usr/local/mesh
sudo rm -rf /Library/LaunchDaemons/meshagent.plist
```

## Advanced Debugging

### Get detailed agent information

```bash
# Check agent version and status
sudo /Library/Mesh\ Agent/meshagent -version
sudo /Library/Mesh\ Agent/meshagent -info

# View agent configuration
sudo cat /Library/Mesh\ Agent/meshagent.msh

# Check LaunchDaemon configuration
cat /Library/LaunchDaemons/meshagent_osx64LaunchDaemon.plist
```

### Monitor agent in real-time

```bash
# Watch log file (if it exists)
tail -f /Library/Logs/MeshAgent-Install.log

# Monitor system log for mesh-related entries
log stream --predicate 'processImagePath CONTAINS "mesh"'

# Check network connections
sudo lsof -i -P | grep -i mesh
```

### Test manual connection

```bash
# Download agent config manually
curl -o test.msh 'https://tee.up.railway.app/meshsettings?id=YOUR_MESH_ID_HERE'

# View config content
cat test.msh

# Check if it contains valid server info
grep -i "MeshServer" test.msh
```

## macOS-Specific Considerations

### Apple Silicon (M1/M2/M3) Notes

1. **Rosetta 2**: The universal binary runs natively on Apple Silicon, no need for Rosetta 2
2. **Performance**: Native ARM version may have better performance than universal
3. **Compatibility**: Use universal binary (ID 16) for best compatibility

### macOS Versions

- **macOS 13 (Ventura)** and newer: Fully supported
- **macOS 12 (Monterey)**: Fully supported
- **macOS 11 (Big Sur)**: Fully supported
- **macOS 10.15 (Catalina)**: Supported with additional security approvals
- **macOS 10.14 (Mojave)** and older: May require manual security permissions

### Security Features to Consider

1. **System Integrity Protection (SIP)**: May prevent some remote operations
2. **Gatekeeper**: Blocks unsigned applications
3. **Full Disk Access**: Required for complete system access
4. **Screen Recording Permission**: Required for remote desktop
5. **Accessibility Permission**: Required for keyboard/mouse control

## Expected Behavior

### Successful Installation

```
✓ Package downloaded successfully
✓ Installer runs without errors
✓ LaunchDaemon created at /Library/LaunchDaemons/
✓ Agent binary installed at /Library/Mesh Agent/
✓ Service starts automatically
✓ Device appears in MeshCentral web UI within 30 seconds
```

### Installation Locations

Different versions may install to different locations:

```
/Library/Mesh Agent/              # Newer installations
/usr/local/mesh_services/meshagent/   # Older installations
/usr/local/mesh/                  # Alternative location
```

### LaunchDaemon Locations

```
/Library/LaunchDaemons/meshagent_osx64LaunchDaemon.plist  # Primary
/Library/LaunchDaemons/meshagent.plist                    # Alternative
```

## Quick Reference Commands

```bash
# Check if installed
ls -la /Library/Mesh\ Agent/

# Check service status
sudo launchctl list | grep mesh

# View logs
sudo cat /Library/Logs/MeshAgent-Install.log

# Restart service
sudo launchctl unload /Library/LaunchDaemons/meshagent_osx64LaunchDaemon.plist
sudo launchctl load /Library/LaunchDaemons/meshagent_osx64LaunchDaemon.plist

# Test connectivity
curl -I https://tee.up.railway.app

# Check architecture
uname -m

# Get macOS version
sw_vers -productVersion
```

## Getting Help

If the agent still doesn't connect after following this guide:

1. **Check web UI**: Verify device group has correct settings
2. **Server logs**: Check Railway logs for connection attempts
3. **Agent logs**: Review `/Library/Logs/MeshAgent-Install.log`
4. **Permissions**: Ensure all macOS security permissions are granted
5. **Network**: Verify no firewall/VPN is blocking WebSocket connections on port 443

## References

- **MeshCentral Docs**: https://ylianst.github.io/MeshCentral/
- **Apple Silicon Support**: https://meshcentral2.blogspot.com/2020/12/meshcentral-apple-silicon-big-sur-high.html
- **macOS Security**: https://support.apple.com/guide/security/welcome/web
