# Where Secrets Are Stored

## Quick Reference

### Local Development

**Location:** `.env` file in project root
**Example:** `C:\Users\jpalo\code\trifecta\.env`

```bash
# Create from template
cp .env.example .env

# Edit with your values
nano .env
```

**Contains:**
- `HOSTNAME=your-domain.com`
- `LETSENCRYPT_EMAIL=your-email@example.com`
- SSL certificate paths (if using custom certs)
- MeshCentral settings

**Security:**
- ✅ Listed in `.gitignore` - NEVER committed to git
- ✅ Only exists on your local machine
- ✅ Each developer has their own `.env` with their values

### Production (Railway)

**Location:** Railway Dashboard → Variables

**How to set:**
1. Go to https://railway.app
2. Select your project
3. Click "Variables" tab
4. Add each variable from `.env.example`

**Contains:**
- All the same variables as local `.env`
- Railway will inject these at runtime
- Never stored in git

### CI/CD (GitHub Actions)

**Location:** GitHub → Settings → Secrets and variables → Actions

**How to set:**
1. Go to your GitHub repository
2. Settings → Secrets and variables → Actions
3. Click "New repository secret"
4. Add each secret

**Common secrets:**
- `HOSTNAME`
- `LETSENCRYPT_EMAIL`
- `RAILWAY_TOKEN` (for deployment)
- `SSL_CERTIFICATE` (base64 encoded, if using custom certs)
- `SSL_PRIVATE_KEY` (base64 encoded, if using custom certs)

### SSL/TLS Certificates

**Option 1: Let's Encrypt (Recommended)**

**Location:** Auto-generated by MeshCentral
**Storage:** `meshcentral-data/` directory (gitignored)

```bash
# In .env:
LETSENCRYPT_EMAIL=your-email@example.com
LETSENCRYPT_DOMAIN=your-domain.com
LETSENCRYPT_PRODUCTION=true
```

MeshCentral automatically:
- Obtains certificates from Let's Encrypt
- Stores them in meshcentral-data/
- Renews them before expiry
- Never commits them to git

**Option 2: Custom Certificates**

**Location:** External directory (outside repository)
**Example:** `~/trifecta-certs/` or `C:\certs\trifecta\`

```bash
# Create secure directory
mkdir -p ~/trifecta-certs
chmod 700 ~/trifecta-certs

# Store certificates
cp your-cert.pem ~/trifecta-certs/cert.pem
cp your-key.pem ~/trifecta-certs/key.pem
chmod 600 ~/trifecta-certs/key.pem
chmod 644 ~/trifecta-certs/cert.pem

# Reference in .env:
SSL_CERT_PATH=/home/username/trifecta-certs/cert.pem
SSL_KEY_PATH=/home/username/trifecta-certs/key.pem
```

### MeshCentral Generated Secrets

**Location:** `meshcentral-data/` directory
**Gitignored:** Yes - never committed

MeshCentral automatically generates:
- Server certificates (`*-cert-public.crt`)
- Private keys (`*-cert-private.key`)
- Code signing certificates
- Agent server certificates

```bash
meshcentral-data/
  ├── root-cert-private.key          # ❌ NEVER commit
  ├── webserver-cert-private.key     # ❌ NEVER commit
  ├── mpsserver-cert-private.key     # ❌ NEVER commit
  ├── agentserver-cert-private.key   # ❌ NEVER commit
  ├── codesign-cert-private.key      # ❌ NEVER commit
  └── config.json                    # ❌ NEVER commit (generated from template)
```

## What Gets Committed to Git

**✅ Safe to commit:**
- `.env.example` - Template with placeholders
- `meshcentral-data/config.json.template` - Config template
- `docker-compose.yml` - Uses ${VARIABLES}
- Documentation (*.md files)
- Source code
- `.gitignore` - Protects secrets

**❌ NEVER commit:**
- `.env` - Contains real secrets
- `*.pem`, `*.key`, `*.crt` - Certificates
- `meshcentral-data/config.json` - Generated config with email/domain
- `meshcentral-data/*.key` - Generated private keys

## Secret Generation Flow

```
Developer Flow:
1. Clone repository (no secrets included)
2. Copy .env.example → .env
3. Fill in .env with your values
4. Run ./generate-config.sh
5. Config generated from template + .env
6. Docker uses .env variables
7. MeshCentral generates its own certs

Production Flow:
1. Set environment variables in Railway
2. Railway builds Docker image
3. generate-config.sh runs with Railway env vars
4. MeshCentral obtains Let's Encrypt certs
5. Application runs with all secrets from environment
```

## Verification

Check that secrets are properly stored:

```bash
# Verify .env is NOT in git
git ls-files .env
# Should output: nothing (file not tracked)

# Verify .env exists locally (for development)
ls .env
# Should output: .env

# Verify .gitignore protects .env
cat .gitignore | grep "^\.env$"
# Should output: .env

# Verify no secrets in current git tree
git ls-files | grep -E '\.(pem|key|crt)$'
# Should output: nothing

# Verify config.json is generated (not tracked)
git ls-files meshcentral-data/config.json
# Should output: nothing
```

## Quick Start for New Developers

```bash
# 1. Clone the repository
git clone <repo-url>
cd trifecta

# 2. Create your local environment
cp .env.example .env
nano .env  # Add your values

# 3. Generate configuration
./generate-config.sh

# 4. Install pre-commit hook
cp .github/pre-commit-hook.sh .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit

# 5. Start development
docker-compose up -d

# 6. Access application
# https://localhost (or your HOSTNAME)
```

## Security Principles

1. **Separation of Concerns:**
   - Templates in git
   - Secrets in environment
   - Never mix the two

2. **Environment-Specific:**
   - Each environment has its own secrets
   - Dev, staging, prod use different values
   - No "one size fits all" config

3. **Least Privilege:**
   - Developers only have dev secrets
   - Production secrets only in production
   - CI/CD only has deployment secrets

4. **Rotation Ready:**
   - Secrets can be changed without code changes
   - Update .env or Railway variables
   - Restart application
   - No git commits needed

## Troubleshooting

**"Where is my .env file?"**
- Create it: `cp .env.example .env`
- It should be in the project root, next to docker-compose.yml

**"My secrets are showing in git status"**
- Check: `git status`
- If .env appears: DON'T COMMIT IT
- Verify: `cat .gitignore | grep .env`
- Should show: `.env` is listed

**"How do I share secrets with my team?"**
- ❌ DON'T: Commit .env to git
- ❌ DON'T: Send in unencrypted email/Slack
- ✅ DO: Use password manager (1Password, LastPass)
- ✅ DO: Share encrypted file
- ✅ DO: Use secure sharing tool

**"I accidentally committed a secret!"**
- See: [SECRET_ROTATION_ACTION_PLAN.md](SECRET_ROTATION_ACTION_PLAN.md)
- Run: `./test-secret-rotation.sh`
- Clean git history if needed
- Rotate the exposed secret

## Related Documentation

- [SECRET_ROTATION_ACTION_PLAN.md](SECRET_ROTATION_ACTION_PLAN.md) - What to do if secrets were exposed
- [TEST_SECRET_ROTATION.md](TEST_SECRET_ROTATION.md) - How to test secret rotation
- [SECURITY.md](SECURITY.md) - Security best practices
- [MIGRATION.md](MIGRATION.md) - Migrating from hardcoded to environment-based config
